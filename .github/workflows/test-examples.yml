name: Test Example Scripts

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test-design-examples:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libglu1-mesa libxcursor1 libxinerama1
        
    - name: Install package with dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        
    - name: Test design examples (syntax check)
      env:
        MPLBACKEND: Agg
      run: |
        python -m pytest tests/test_examples.py::test_design_examples_syntax -v
        
    - name: Test design examples can import
      env:
        MPLBACKEND: Agg
      run: |
        python -m pytest tests/test_examples.py::test_design_examples_imports -v

  test-optimization-examples:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libglu1-mesa libxcursor1 libxinerama1
        
    - name: Install package with optimization dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[optimization]"
        
    - name: Test optimization examples (syntax check)
      env:
        MPLBACKEND: Agg
      run: |
        python -m pytest tests/test_examples.py::test_optimization_examples_syntax -v
        
    - name: Test optimization examples can import
      env:
        MPLBACKEND: Agg
      run: |
        python -m pytest tests/test_examples.py::test_optimization_examples_imports -v

  test-simulation-examples:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libglu1-mesa libxcursor1 libxinerama1
        
    - name: Set up Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.12'
        channels: conda-forge
        
    - name: Install package with simulation dependencies
      shell: bash -el {0}
      run: |
        conda install -c conda-forge fenics-dolfinx=0.9.0
        python -m pip install --upgrade pip
        pip install -e ".[simulation]"
        
    - name: Test simulation examples (syntax check)
      shell: bash -el {0}
      env:
        MPLBACKEND: Agg
      run: |
        python -m pytest tests/test_examples.py::test_simulation_examples_syntax -v
        
    - name: Test simulation examples can import
      shell: bash -el {0}
      env:
        MPLBACKEND: Agg
      run: |
        python -m pytest tests/test_examples.py::test_simulation_examples_imports -v
