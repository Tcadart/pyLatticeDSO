<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>pyLattice.cell API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pyLattice.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pyLattice</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Cell">Cell</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Cell.__init__">Cell</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.original_cell_geom">original_cell_geom</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.original_tags">original_tags</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.center_point">center_point</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.beam_material">beam_material</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.size">size</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.pos">pos</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.coordinate">coordinate</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.beams_cell">beams_cell</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.points_cell">points_cell</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.index">index</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.geom_types">geom_types</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.radii">radii</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.coupling_matrix_B">coupling_matrix_B</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.uncertainty_node">uncertainty_node</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.grad_radius">grad_radius</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.grad_mat">grad_mat</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.grad_dim">grad_dim</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.neighbour_cells">neighbour_cells</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.schur_complement">schur_complement</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.schur_complement_gradient">schur_complement_gradient</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.node_in_order_simulation">node_in_order_simulation</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.dispose">dispose</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.volume">volume</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.relative_density">relative_density</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.volume_each_geom">volume_each_geom</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.boundary_box">boundary_box</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.boundary_edges">boundary_edges</a>
                        </li>
                        <li>
                                <a class="variable" href="#Cell.corner_coordinates">corner_coordinates</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.generate_cell_properties">generate_cell_properties</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.generate_beams">generate_beams</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_beam_material">get_beam_material</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_radius">get_radius</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.def_cell_size">def_cell_size</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.def_cell_center">def_cell_center</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_point_on_surface">get_point_on_surface</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.remove_beam">remove_beam</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.remove_point">remove_point</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.add_beam">add_beam</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.add_point">add_point</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.add_cell_neighbour">add_cell_neighbour</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_all_cell_neighbours">get_all_cell_neighbours</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.refresh_from_global">refresh_from_global</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.define_node_order_to_simulate">define_node_order_to_simulate</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.set_reaction_force_on_nodes">set_reaction_force_on_nodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_displacement_at_nodes">get_displacement_at_nodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.set_displacement_at_boundary_nodes">set_displacement_at_boundary_nodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.build_coupling_operator">build_coupling_operator</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.build_local_preconditioner">build_local_preconditioner</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_number_boundary_nodes">get_number_boundary_nodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_internal_energy">get_internal_energy</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_displacement_data">get_displacement_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_number_nodes_at_boundary">get_number_nodes_at_boundary</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.change_beam_radius">change_beam_radius</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_relative_density_kriging">get_relative_density_kriging</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_relative_density_gradient">get_relative_density_gradient</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_relative_density_gradient_kriging">get_relative_density_gradient_kriging</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_relative_density_gradient_kriging_exact">get_relative_density_gradient_kriging_exact</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_RGBcolor_depending_of_radius">get_RGBcolor_depending_of_radius</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.print_data">print_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_translation_rigid_body">get_translation_rigid_body</a>
                        </li>
                        <li>
                                <a class="function" href="#Cell.get_rotation_rigid_body">get_rotation_rigid_body</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../pyLattice.html">pyLattice</a><wbr>.cell    </h1>

                
                        <input id="mod-cell-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-cell-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="c1"># CLASS: Cell</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">colorama</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Style</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.beam</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.point</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.geometries.geometries_utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_validate_inputs_cell</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">pyLatticeOpti.surrogate_model_relative_densities</span><span class="w"> </span><span class="kn">import</span> <span class="n">gp_mean_gradient_rbf_pipeline</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>    <span class="n">gp_mean_gradient_rbf_pipeline</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Cell</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">    Class representing a cell in the lattice structure.</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">geom_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>                 <span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">grad_radius</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">grad_dim</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">grad_mat</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>                 <span class="n">uncertainty_node</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>                 <span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">        Initialize a Cell with its dimensions and position</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">        Parameters:</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">        -----------</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">        pos: list</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">            Position of the cell in the lattice</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">        initial_cell_size: list</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">            Initial size of the cell</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">        coordinate: list</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">            Coordinates of the cell minimum corner in the lattice</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">        geom_types: list[str]</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">            Type of lattice geometry</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">        radii: float</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">            Base radii of the beam</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">        grad_radius: list</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">            Gradient of the radii</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">        grad_dim: list</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">            Gradient of the dimensions</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">        grad_mat: list</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">            Gradient of the material</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">        uncertainty_node: float</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">            Standard deviation for adding uncertainty to node coordinates. Defaults to 0.0.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">        _verbose: bool</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">            If True, prints additional information during initialization. Defaults to False.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">        beams_already_defined: set</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">            Set of beams already defined in the lattice to avoid duplication. Defaults to None.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">        nodes_already_defined: set</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">            Set of nodes already defined in the lattice to avoid duplication. Defaults to None.</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="n">_validate_inputs_cell</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">geom_types</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>                         <span class="n">radii</span><span class="p">,</span> <span class="n">grad_radius</span><span class="p">,</span> <span class="n">grad_dim</span><span class="p">,</span> <span class="n">grad_mat</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>                         <span class="n">uncertainty_node</span><span class="p">,</span> <span class="n">_verbose</span><span class="p">)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_cell_geom</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_point</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinate</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Set of beams in the cell</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Set of points in the cell</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">geom_types</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">radii</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># B matrix (Coupling matrix)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">uncertainty_node</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">grad_radius</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">grad_mat</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">grad_dim</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_verbose</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schur_complement_gradient</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_cell_properties</span><span class="p">(</span><span class="n">initial_size</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_density</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s2">&quot;WARNING: Approximated relative density of the cell is greater than 1. &quot;</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>                                <span class="s2">&quot;Beam radius and cell size is probably not well defined&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Cell(Coordinates:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="si">}</span><span class="s2">, Size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">, Index:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dispose&quot;</span><span class="p">):</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>            <span class="k">pass</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">        Dispose of the cell by detaching beams and points, and cleaning up references.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>            <span class="n">beams</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>            <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>            <span class="c1"># Detach the beams</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">cell_belongings</span><span class="p">:</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>                        <span class="n">b</span><span class="o">.</span><span class="n">cell_belongings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>                    <span class="c1"># If the beam no longer belongs to any cell, we prudently purge its links</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;delete_beam&quot;</span><span class="p">):</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>                            <span class="n">b</span><span class="o">.</span><span class="n">delete_beam</span><span class="p">()</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>                    <span class="k">pass</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>            <span class="c1"># Detach the points</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">cell_belongings</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>                        <span class="n">p</span><span class="o">.</span><span class="n">cell_belongings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>                    <span class="c1"># If the point no longer belongs to any cell, we prudently purge its links</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">):</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>                            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">)):</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>                                <span class="k">try</span><span class="p">:</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>                                    <span class="c1"># Remove the beam from the point&#39;s connected beams</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>                                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>                                        <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                                    <span class="k">pass</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>                    <span class="k">pass</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>            <span class="c1"># Clear the sets</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>                <span class="k">pass</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>                <span class="k">pass</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>            <span class="k">pass</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>    <span class="nd">@property</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Calculate the volume of the cell.&quot;&quot;&quot;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>    <span class="nd">@property</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relative_density</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        Calculate the relative density of the cell based on the volume of beams and the cell volume.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>        <span class="n">volumeBeams</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>                <span class="n">volumeBeams</span> <span class="o">+=</span> <span class="n">beam</span><span class="o">.</span><span class="n">volume</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>        <span class="k">return</span> <span class="n">volumeBeams</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>    <span class="nd">@property</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">volume_each_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">        Get the volume of the cell separated by geometry type_beam.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">))</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>                <span class="n">volumeBeam</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">volume</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>                <span class="n">volumes</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">]</span> <span class="o">+=</span> <span class="n">volumeBeam</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="k">return</span> <span class="n">volumes</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>    <span class="nd">@property</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        Get the boundary box of the cell</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">        Returns:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">        --------</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">        list</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">            List of the boundary box coordinates</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="n">xMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="n">xMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="n">yMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>        <span class="n">yMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="n">zMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>        <span class="n">zMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">xMin</span><span class="p">,</span> <span class="n">xMax</span><span class="p">,</span> <span class="n">yMin</span><span class="p">,</span> <span class="n">yMax</span><span class="p">,</span> <span class="n">zMin</span><span class="p">,</span> <span class="n">zMax</span><span class="p">]</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>    <span class="nd">@property</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">boundary_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">        Return the 12 edge segments of the cell&#39;s axis-aligned bounding box</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="sd">        as pairs of 3D points ((x,y,z), (x,y,z)).</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="c1"># 8 vertices</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="p">]</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="c1"># 12 edges (by vertex indices)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># bottom rectangle</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="c1"># top rectangle</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>  <span class="c1"># vertical edges</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        <span class="p">]</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="k">return</span> <span class="p">[(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>    <span class="nd">@property</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">corner_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="sd">        Get the corner coordinates of the cell.</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a><span class="sd">        Returns:</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a><span class="sd">        --------</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="sd">        list of tuples</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="sd">            List of (x, y, z) coordinates of the corner points.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="n">corners</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="p">]</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="k">return</span> <span class="n">corners</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a><span class="c1"># SECTION: Design Methods</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_cell_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_cell_size</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>                                 <span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">        Generate cell properties including beams and nodes.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">        Parameters:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">        -----------</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">        initialCellSize: list</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">            Initial size of the cell without modification</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">        beams_already_defined: set</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">            Set of beams already defined in the lattice to avoid duplication</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">        nodes_already_defined: set</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">            Set of nodes already defined in the lattice to avoid duplication</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="n">idxCell</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>            <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>                <span class="k">if</span> <span class="n">idxCell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">get_beam_material</span><span class="p">()</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>                    <span class="n">beamRadius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">def_cell_size</span><span class="p">(</span><span class="n">initial_cell_size</span><span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_beams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">beamRadius</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">def_cell_center</span><span class="p">()</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>                    <span class="n">hybridRadius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_beams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">hybridRadius</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>                <span class="n">idxCell</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latticeType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">beamRadius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">beamType</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>                       <span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>            <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">        Generate beams and nodes using a given lattice type_beam and parameters.</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="sd">        Parameters:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="sd">        -----------</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">        latticeType: str</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a><span class="sd">            Type of lattice structure (e.g., &#39;BCC&#39;, &#39;Hybrid1&#39;, etc.)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">        beamRadius: float</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="sd">            Radius of the beam</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">        beamType: int</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">            Type index of the beam</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a><span class="sd">        beams_already_defined: set</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a><span class="sd">            Set of beams already defined in the lattice to avoid duplication</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="sd">        nodes_already_defined: set</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">            Set of nodes already defined in the lattice to avoid duplication</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">wkey</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Create a unique key for a point based on its coordinates rounded to a specified number of digits.&quot;&quot;&quot;</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>        <span class="n">frac_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">get_beam_structure</span><span class="p">(</span><span class="n">latticeType</span><span class="p">):</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>            <span class="n">x1f</span><span class="p">,</span> <span class="n">y1f</span><span class="p">,</span> <span class="n">z1f</span><span class="p">,</span> <span class="n">x2f</span><span class="p">,</span> <span class="n">y2f</span><span class="p">,</span> <span class="n">z2f</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="n">x1</span> <span class="o">=</span> <span class="n">x1f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>            <span class="n">y1</span> <span class="o">=</span> <span class="n">y1f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="n">z1</span> <span class="o">=</span> <span class="n">z1f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="n">x2f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="n">y2f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="n">z2</span> <span class="o">=</span> <span class="n">z2f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>            <span class="n">k1</span> <span class="o">=</span> <span class="n">wkey</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>            <span class="n">k2</span> <span class="o">=</span> <span class="n">wkey</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>            <span class="k">if</span> <span class="n">nodes_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">nodes_already_defined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">nodes_already_defined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>            <span class="k">if</span> <span class="n">p1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">frac_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x1f</span><span class="p">,</span> <span class="n">y1f</span><span class="p">,</span> <span class="n">z1f</span><span class="p">))</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                <span class="k">if</span> <span class="n">p1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                    <span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                    <span class="n">frac_cache</span><span class="p">[(</span><span class="n">x1f</span><span class="p">,</span> <span class="n">y1f</span><span class="p">,</span> <span class="n">z1f</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p1</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>                    <span class="n">p1</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                <span class="k">if</span> <span class="n">nodes_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>                    <span class="n">nodes_already_defined</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                <span class="n">p1</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>            <span class="k">if</span> <span class="n">p2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">frac_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x2f</span><span class="p">,</span> <span class="n">y2f</span><span class="p">,</span> <span class="n">z2f</span><span class="p">))</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                <span class="k">if</span> <span class="n">p2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                    <span class="n">p2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>                    <span class="n">frac_cache</span><span class="p">[(</span><span class="n">x2f</span><span class="p">,</span> <span class="n">y2f</span><span class="p">,</span> <span class="n">z2f</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p2</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                    <span class="n">p2</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                <span class="k">if</span> <span class="n">nodes_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                    <span class="n">nodes_already_defined</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p2</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                <span class="n">p2</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>            <span class="k">if</span> <span class="n">beams_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                <span class="n">bkey</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">)))</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="n">beams_already_defined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bkey</span><span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                <span class="n">bkey</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>            <span class="k">if</span> <span class="n">beam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">beamRadius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span><span class="p">,</span> <span class="n">beamType</span><span class="p">,</span> <span class="n">cell_belongings</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                <span class="k">if</span> <span class="n">beams_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                    <span class="n">beams_already_defined</span><span class="p">[</span><span class="n">bkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># Already defined beam, just add the cell belonging</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                <span class="n">beam</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_beam_material</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        Get the material of the beam based on the material gradient.</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">        Calculate and return the beam radii</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">        Parameters:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">        -----------</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">        baseRadius: float</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">            Base radius of the beam</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">        Returns:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="sd">        ---------</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">        beamRadius : float</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">            Calculated beam radii</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>            <span class="k">return</span> <span class="n">base_radius</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>            <span class="n">beamRadius</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_radius</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>                          <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>                          <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>            <span class="k">return</span> <span class="n">beamRadius</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">def_cell_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_cell_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">        Calculate and return the cell size</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">        Parameters:</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">        -----------</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">        initial_cell_size: list</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">            Initial size of the cell</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">initial_cell_size</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">initial_size</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="ow">in</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>                         <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">initial_cell_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">))]</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">def_cell_center</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">        Calculate the center point of the cell</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_point</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_point_on_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfaceName</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">        Get the points on the surface specified in the global reference frame.</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="sd">        Parameters:</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="sd">        -----------</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">        surfaceName: str</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="sd">            Name of the surface. Choose from &#39;Xmin&#39;, &#39;Xmax&#39;, &#39;Ymin&#39;, &#39;Ymax&#39;, &#39;Zmin&#39;, &#39;Zmax&#39;, &#39;Xmid&#39;, &#39;Ymid&#39;, &#39;Zmid&#39;.</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="sd">            If &#39;Xmid&#39;, &#39;Ymid&#39;, or &#39;Zmid&#39; is specified, it returns the points at the bottom of the cell</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">        Returns:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a><span class="sd">        --------</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">        list</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">           List of points on the specified surface.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>        <span class="n">boundaryBox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="n">surface_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="s2">&quot;Xmin&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>            <span class="s2">&quot;Xmax&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="s2">&quot;Ymin&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="s2">&quot;Ymax&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="s2">&quot;Zmin&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="s2">&quot;Zmax&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="s2">&quot;Xmid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="s2">&quot;Ymid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="s2">&quot;Zmid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="p">}</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="n">coord_index</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>            <span class="s2">&quot;Xmin&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmid&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>            <span class="s2">&quot;Ymin&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymid&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>            <span class="s2">&quot;Zmin&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmax&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmid&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="p">}</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="k">if</span> <span class="n">surfaceName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">surface_map</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>                <span class="sa">f</span><span class="s2">&quot;Surface &#39;</span><span class="si">{</span><span class="n">surfaceName</span><span class="si">}</span><span class="s2">&#39; is not valid. Choose from &#39;Xmin&#39;, &#39;Xmax&#39;, &#39;Ymin&#39;, &#39;Ymax&#39;, &#39;Zmin&#39;, &#39;Zmax&#39;, &quot;</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;Xmid&#39;, &#39;Ymid&#39;, &#39;Zmid&#39;.&quot;</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="n">surface_value</span> <span class="o">=</span> <span class="n">surface_map</span><span class="p">[</span><span class="n">surfaceName</span><span class="p">]</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="n">axis</span> <span class="o">=</span> <span class="n">coord_index</span><span class="p">[</span><span class="n">surfaceName</span><span class="p">]</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">({</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="n">point</span> <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="n">surface_value</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="p">})</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="c1"># SECTION: Modification Methods</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam_to_delete</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">        Removing beam from cell</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">        Parameters:</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="sd">        -----------</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">        beam_to_delete: Beam or Iterable[Beam]</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">            Beam or list of beams to remove from the cell</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beam_to_delete</span><span class="p">,</span> <span class="n">Beam</span><span class="p">):</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">beam_to_delete</span><span class="p">)</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beam_to_delete</span><span class="p">:</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_to_delete</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a><span class="sd">        Removing point from cell</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a><span class="sd">        Parameters:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a><span class="sd">        -----------</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a><span class="sd">        point_to_delete: Point or Iterable[Point]</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="sd">            Point or list of points to remove from the cell</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_to_delete</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">point_to_delete</span><span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">point_to_delete</span><span class="p">:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam_to_add</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">        Adding beam to cell</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">        Parameters:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        -----------</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        beam_to_add: Beam or Iterable[Beam]</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">            Beam or list of beams to add to the cell</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beam_to_add</span><span class="p">,</span> <span class="n">Beam</span><span class="p">):</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam_to_add</span><span class="p">)</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beam_to_add</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_to_add</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;Point&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a><span class="sd">        Adding point to cell</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a><span class="sd">        Parameters:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a><span class="sd">        -----------</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="sd">        point_to_add: Point or Iterable[Point]</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">            Point or list of points to add to the cell</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_to_add</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">point_to_add</span><span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">point_to_add</span><span class="p">)</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_cell_neighbour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sign</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">neighbour_cell</span><span class="p">:</span> <span class="s2">&quot;Cell&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a><span class="sd">        Add a neighbour cell in a structured dict format.</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a><span class="sd">        Parameters</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="sd">        ----------</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a><span class="sd">        direction : str</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="sd">            One of &quot;x&quot;, &quot;y&quot;, &quot;z&quot;</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="sd">        sign : str</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">            Either &quot;positif&quot; or &quot;negatif&quot;</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="sd">        neighbour_cell : Cell</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">            Neighbour cell to add</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>        <span class="k">if</span> <span class="n">sign</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">]:</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">sign</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbour_cell</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_cell_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Cell&quot;</span><span class="p">]:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">        Get all neighbour cells in a flat list.</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">        Returns</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">        -------</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">        list of Cell</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">            List of all neighbour cells</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">:</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>            <span class="k">for</span> <span class="n">sign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">]:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>                <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">sign</span><span class="p">])</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>        <span class="k">return</span> <span class="n">neighbours</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_from_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_beams</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">        Rebuild self.beams_cell and self.points_cell from the current lattice state.</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">        Keeps only beams that still declare this cell as a belonging, and derives points from those beams.</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="n">live_beams</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>            <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">all_beams</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">cell_belongings</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="p">}</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span> <span class="o">=</span> <span class="n">live_beams</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">live_beams</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">)}</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="c1"># SECTION: Simulation Methods</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_node_order_to_simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_priority</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="sd">        Define a deterministic order for boundary nodes to ensure consistent simulation results.</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="sd">        Parameters:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">        -----------</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">        face_priority: Optional[List[str]]</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">            List defining the priority order of faces to assign nodes to when they lie on multiple faces.</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">            Default is [&quot;Xmin&quot;, &quot;Xmax&quot;, &quot;Ymin&quot;, &quot;Ymax&quot;, &quot;Zmin&quot;, &quot;Zmax&quot;].</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">        tol: float</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">            Tolerance for determining if a point lies on a face. Default is 1e-9.</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>        <span class="k">if</span> <span class="n">face_priority</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>            <span class="n">face_priority</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmax&quot;</span><span class="p">]</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_faces_of_point</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Point</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>            <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Xmin&quot;</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Xmax&quot;</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Ymin&quot;</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Ymax&quot;</span><span class="p">)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Zmin&quot;</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Zmax&quot;</span><span class="p">)</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>            <span class="k">return</span> <span class="n">faces</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_inplane_key</span><span class="p">(</span><span class="n">face</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">Point</span><span class="p">):</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>            <span class="c1"># Use the two in-plane coordinates as primary sort keys</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>            <span class="k">if</span> <span class="n">face</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">):</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>            <span class="k">if</span> <span class="n">face</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">):</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>            <span class="c1"># Z faces</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        <span class="c1"># Unique boundary points by boundary index to avoid duplicates</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="n">bnd_points</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Point</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">):</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                    <span class="n">bnd_points</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="c1"># Assign each point to a single face using the given priority</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>        <span class="n">face_buckets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">face_priority</span><span class="p">}</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">bnd_points</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>            <span class="n">faces</span> <span class="o">=</span> <span class="n">_faces_of_point</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>            <span class="c1"># pick the first face that appears in face_priority</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>            <span class="n">chosen</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">face_priority</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>            <span class="k">if</span> <span class="n">chosen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>                <span class="c1"># Extremely rare: numerical drift puts a node just off all faces; choose nearest</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>                <span class="n">dists</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>                    <span class="s2">&quot;Xmin&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">),</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>                    <span class="s2">&quot;Xmax&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">),</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>                    <span class="s2">&quot;Ymin&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">),</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>                    <span class="s2">&quot;Ymax&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">),</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>                    <span class="s2">&quot;Zmin&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>                    <span class="s2">&quot;Zmax&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z1</span><span class="p">),</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>                <span class="p">}</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>                <span class="n">chosen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">dists</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            <span class="n">face_buckets</span><span class="p">[</span><span class="n">chosen</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>        <span class="n">ordered</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">face_priority</span><span class="p">:</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            <span class="n">pts</span> <span class="o">=</span> <span class="n">face_buckets</span><span class="p">[</span><span class="n">face</span><span class="p">]</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>            <span class="n">pts</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">_inplane_key</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>            <span class="n">ordered</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span> <span class="o">=</span> <span class="n">ordered</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_reaction_force_on_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reactionForce</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">        Set reaction force on each boundary node in the established local order.</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        Parameters:</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">        -----------</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        reactionForce: list</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">            List of reaction force vectors corresponding to each boundary node.</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Boundary node order not defined. Call define_node_order_to_simulate() first.&quot;</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactionForce</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">):</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of reaction force entries: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">reactionForce</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs. boundary nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough reaction force entries for boundary nodes.&quot;</span><span class="p">)</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">):</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="n">node</span><span class="o">.</span><span class="n">set_reaction_force</span><span class="p">(</span><span class="n">reactionForce</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_displacement_at_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodeList</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">],</span> <span class="s2">&quot;OrderedDict[int, Point]&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">        Return displacement vectors ordered consistently with the provided local list/dict of Points.</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">        Parameters:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">        -----------</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">        nodeList: list or OrderedDict</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">            List or OrderedDict of Point objects representing the nodes.</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a><span class="sd">        Returns:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="sd">        --------</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">        list</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">            List of displacement vectors for the nodes.</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>        <span class="n">displacementList</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodeList</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodeList</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>                    <span class="n">displacementList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># OrderedDict-like</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodeList</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>                <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                    <span class="n">displacementList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="k">return</span> <span class="n">displacementList</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_displacement_at_boundary_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displacementArray</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">        Set displacement at nodes.</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">        Parameters:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">        ------------</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="sd">        displacementArray: list or array-like</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="sd">            Flattened array of displacement values.</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Non-zero displacements:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">displacementArray</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">displacementArray</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>                    <span class="k">continue</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>                    <span class="n">gi</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">global_free_DOF_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>                    <span class="k">if</span> <span class="n">gi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>                        <span class="n">point</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">displacementArray</span><span class="p">[</span><span class="n">gi</span><span class="p">]</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build_coupling_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_free_DOF</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">        Build the coupling operator B using the deterministic local boundary-node order.</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">        Parameters:</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">        -----------</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">        nb_free_DOF: int</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">            Total number of free degrees of freedom in the global system.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">:</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">define_node_order_to_simulate</span><span class="p">()</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">coo_matrix</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="n">data</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>        <span class="c1"># Map boundary index</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="k">for</span> <span class="n">local_idx</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">):</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                <span class="n">gi</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">global_free_DOF_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="k">if</span> <span class="n">gi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_idx</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="n">nbBndDOFloc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nb_free_DOF</span><span class="p">,</span> <span class="n">nbBndDOFloc</span><span class="p">))</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build_local_preconditioner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schur_mean</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a><span class="sd">        Build the local preconditioner matrix B^T * S * B</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a><span class="sd">        Parameters:</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="sd">        -----------</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">        schur_mean: array-like or None</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">            Schur complement matrix to use. If None, uses self.schur_complement.</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">coo_matrix</span><span class="p">,</span> <span class="n">csc_matrix</span><span class="p">,</span> <span class="n">isspmatrix</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coupling matrix has not been built yet. Please build it first.&quot;</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of B matrix&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of Schur matrix&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span><span class="p">))</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible dimensions between the coupling matrix and the Schur matrix.&quot;</span><span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="c1"># Ensure sparse Schur complement to avoid dense products</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>        <span class="k">if</span> <span class="n">schur_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">schur_mean</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">isspmatrix</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="n">B_csr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="n">active_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">B_csr</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="n">n_global</span> <span class="o">=</span> <span class="n">B_csr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="k">if</span> <span class="n">active_rows</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">n_global</span><span class="p">,</span> <span class="n">n_global</span><span class="p">))</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="n">subB</span> <span class="o">=</span> <span class="n">B_csr</span><span class="p">[</span><span class="n">active_rows</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (r x nb)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">S</span> <span class="o">@</span> <span class="n">subB</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>  <span class="c1"># (nb x r)</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>        <span class="n">local_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">subB</span> <span class="o">@</span> <span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>  <span class="c1"># (r x r)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        <span class="c1"># Map back to absolute global indices without creating a huge intermediate</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>        <span class="n">row_idx</span> <span class="o">=</span> <span class="n">active_rows</span><span class="p">[</span><span class="n">local_block</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="n">col_idx</span> <span class="o">=</span> <span class="n">active_rows</span><span class="p">[</span><span class="n">local_block</span><span class="o">.</span><span class="n">col</span><span class="p">]</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">local_block</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_global</span><span class="p">,</span> <span class="n">n_global</span><span class="p">))</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a><span class="c1"># SECTION: Simulation getters methods</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_boundary_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="sd">        Get the number of unique boundary nodes in the cell.</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">({</span><span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">})</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_internal_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="sd">        Get cell internal energy from all boundary points</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>        <span class="n">min_energy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e-12</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>        <span class="n">internalEnergy</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>            <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                <span class="n">pointEnergy</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">calculate_point_energy</span><span class="p">()</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                <span class="k">if</span> <span class="n">pointEnergy</span> <span class="o">&lt;</span> <span class="n">min_energy</span><span class="p">:</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Negative energy = &quot;</span><span class="p">,</span> <span class="n">pointEnergy</span><span class="p">)</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Negative energy detected at point with index &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span><span class="p">))</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>                <span class="n">internalEnergy</span> <span class="o">+=</span> <span class="n">pointEnergy</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="k">return</span> <span class="n">internalEnergy</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_displacement_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">        Build and return displacement data on cell for dataset generation</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>        <span class="n">allBoundaryDisplacementData</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                    <span class="n">allBoundaryDisplacementData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="k">return</span> <span class="n">allBoundaryDisplacementData</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_nodes_at_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">        Get the number of nodes at the boundary</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">        Returns:</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">        --------</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">        int</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">            Number of nodes at the boundary</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="n">counterNodes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>        <span class="n">nodeAlreadyCounted</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodeAlreadyCounted</span><span class="p">:</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>                    <span class="n">counterNodes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>                    <span class="n">nodeAlreadyCounted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span><span class="p">)</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="k">return</span> <span class="n">counterNodes</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="c1"># SECTION: Optimization Methods</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">change_beam_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_radius</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">        WARNING: BEAM MOD IS NOT WORKING</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">        Change beam radii in the cell</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">        Parameters:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">        -----------</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="sd">        newRadius: list</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a><span class="sd">            beam radii wanted to assign</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;WARNING: Beam modification is not implemented yet. &quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_radius</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Length of new radii vector and already cell radii vector needs &quot;</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                                                    <span class="s2">&quot;to be equal &quot;</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>        <span class="n">beamRadius</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>        <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">new_radius</span><span class="p">:</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>            <span class="n">beamRadius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>            <span class="n">beam</span><span class="o">.</span><span class="n">change_beam_radius</span><span class="p">(</span><span class="n">beamRadius</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">])</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">new_radius</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_kriging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kriging_model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a><span class="sd">        Get the relative density of the cell using kriging model</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">        Parameters:</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">        -----------</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="sd">        krigingModel: Kriging</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">            Kriging model to use for prediction</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="n">relative_density</span> <span class="o">=</span> <span class="n">kriging_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>        <span class="k">return</span> <span class="n">relative_density</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relative_density_poly_deriv</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">        Get the gradient of the relative density</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">        Parameters:</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">        -----------</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">        relative_density_poly_deriv: list</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">            List of polynomial derivative functions</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="sd">        Returns:</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="sd">        --------</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">        deriv: float</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">            Derivative of the relative density</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="n">deriv</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">polyDeriv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relative_density_poly_deriv</span><span class="p">):</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>            <span class="n">deriv</span> <span class="o">+=</span> <span class="n">polyDeriv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="k">return</span> <span class="n">deriv</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_gradient_kriging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">        Finite difference gradient of the relative density (predictive mean) w.r.t. the radii using the trained</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">        Pipeline(StandardScaler -&gt; GaussianProcessRegressor) with Constant*RBF kernel.</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">        Returns an array of size len(geometries_types) where entries for geometries not present in the cell are 0.</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-3</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">))</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geometries_types</span><span class="p">:</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;geometry types in cell&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="s2">&quot; Not in the trained kriging model&quot;</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible geometry types between the cell and the kriging model.&quot;</span><span class="p">)</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>            <span class="n">perturbed_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometries_types</span><span class="p">))</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometries_types</span><span class="p">))</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>            <span class="n">geom_index</span> <span class="o">=</span> <span class="n">geometries_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>            <span class="n">perturbed_radii</span><span class="p">[</span><span class="n">geom_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">+</span> <span class="n">epsilon</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>            <span class="n">radii</span><span class="p">[</span><span class="n">geom_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>            <span class="n">grad</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">perturbed_radii</span><span class="p">])</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">radii</span><span class="p">]))</span> <span class="o">/</span> <span class="n">epsilon</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="k">return</span> <span class="n">grad</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_gradient_kriging_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">        Exact gradient of the relative density (predictive mean) w.r.t. the radii using the trained</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">        Pipeline(StandardScaler -&gt; GaussianProcessRegressor) with Constant*RBF kernel.</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">        Returns an array of size len(geometries_types) where entries for geometries not present in the cell are 0.</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">        Parameters:</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a><span class="sd">        -----------</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">        model: Pipeline</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">            Trained kriging model</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a><span class="sd">        geometries_types: list</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="sd">            List of geometry types in the trained kriging model</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="c1"># Build full input vector (one radius per geometry in &#39;geometries_types&#39;)</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometries_types</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>            <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geometries_types</span><span class="p">:</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;geometry types in cell&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="s2">&quot; not in the trained kriging model&quot;</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible geometry types between the cell and the kriging model.&quot;</span><span class="p">)</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>            <span class="n">x</span><span class="p">[</span><span class="n">geometries_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="c1"># Exact gradient in original feature space</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="n">grad_full</span> <span class="o">=</span> <span class="n">gp_mean_gradient_rbf_pipeline</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># shape (len(geometries_types),)</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="c1"># Reorder to match the cell&#39;s local parameter order (same as self.radii / self.geom_types)</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="n">grad_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">):</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>            <span class="n">grad_local</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">grad_full</span><span class="p">[</span><span class="n">geometries_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="k">return</span> <span class="n">grad_local</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="c1"># SECTION: Utils Methods</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_RGBcolor_depending_of_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">        Get the RGB color of the cell depending on the radii.</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="mf">0.1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">        Print the data of the cell for debugging purposes.</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell position: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell coordinates: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">)</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell size: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lattice type_beam: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">)</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beam radii: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beam material: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span><span class="p">)</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;beams in cell: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell center point: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_point</span><span class="p">)</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell index: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beam material: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span><span class="p">)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coupling matrix: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="p">)</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of beams: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">))</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Volume of the cell: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Relative density: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_density</span><span class="p">)</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of nodes at boundary: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_nodes_at_boundary</span><span class="p">())</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="c1"># SECTION: Unused Methods</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_translation_rigid_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">        Get the translation of the rigid body</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="n">translation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>                    <span class="n">translation</span> <span class="o">+=</span> <span class="n">point</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="k">return</span> <span class="n">translation</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_nodes_at_boundary</span><span class="p">()</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rotation_rigid_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">        Get the rotation matrix of the rigid body using SVD.</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>        <span class="n">all_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">coordinates</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">all_points</span><span class="p">])</span>  <span class="c1"># P_i</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="n">final_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">deformed_coordinates</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">all_points</span><span class="p">])</span>  <span class="c1"># P_i&#39;</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="c1"># Soustraction du centre de gravit</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>        <span class="n">center_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        <span class="n">center_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">final_positions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="n">P</span> <span class="o">=</span> <span class="n">initial_positions</span> <span class="o">-</span> <span class="n">center_initial</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="n">P_prime</span> <span class="o">=</span> <span class="n">final_positions</span> <span class="o">-</span> <span class="n">center_final</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="c1"># Matrice de covariance</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_prime</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="c1"># Dcomposition SVD</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="n">U</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>        <span class="c1"># Correction si ncessaire (assurer que R est une rotation propre)</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>            <span class="n">Vt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="k">return</span> <span class="n">R</span>
</span></pre></div>


            </section>
                <section id="Cell">
                            <input id="Cell-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Cell</span>:

                <label class="view-source-button" for="Cell-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell-21"><a href="#Cell-21"><span class="linenos">  21</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Cell</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="Cell-22"><a href="#Cell-22"><span class="linenos">  22</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-23"><a href="#Cell-23"><span class="linenos">  23</span></a><span class="sd">    Class representing a cell in the lattice structure.</span>
</span><span id="Cell-24"><a href="#Cell-24"><span class="linenos">  24</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Cell-25"><a href="#Cell-25"><span class="linenos">  25</span></a>
</span><span id="Cell-26"><a href="#Cell-26"><span class="linenos">  26</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">geom_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="Cell-27"><a href="#Cell-27"><span class="linenos">  27</span></a>                 <span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">grad_radius</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">grad_dim</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">grad_mat</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Cell-28"><a href="#Cell-28"><span class="linenos">  28</span></a>                 <span class="n">uncertainty_node</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Cell-29"><a href="#Cell-29"><span class="linenos">  29</span></a>                 <span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-30"><a href="#Cell-30"><span class="linenos">  30</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-31"><a href="#Cell-31"><span class="linenos">  31</span></a><span class="sd">        Initialize a Cell with its dimensions and position</span>
</span><span id="Cell-32"><a href="#Cell-32"><span class="linenos">  32</span></a>
</span><span id="Cell-33"><a href="#Cell-33"><span class="linenos">  33</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-34"><a href="#Cell-34"><span class="linenos">  34</span></a><span class="sd">        -----------</span>
</span><span id="Cell-35"><a href="#Cell-35"><span class="linenos">  35</span></a><span class="sd">        pos: list</span>
</span><span id="Cell-36"><a href="#Cell-36"><span class="linenos">  36</span></a><span class="sd">            Position of the cell in the lattice</span>
</span><span id="Cell-37"><a href="#Cell-37"><span class="linenos">  37</span></a>
</span><span id="Cell-38"><a href="#Cell-38"><span class="linenos">  38</span></a><span class="sd">        initial_cell_size: list</span>
</span><span id="Cell-39"><a href="#Cell-39"><span class="linenos">  39</span></a><span class="sd">            Initial size of the cell</span>
</span><span id="Cell-40"><a href="#Cell-40"><span class="linenos">  40</span></a>
</span><span id="Cell-41"><a href="#Cell-41"><span class="linenos">  41</span></a><span class="sd">        coordinate: list</span>
</span><span id="Cell-42"><a href="#Cell-42"><span class="linenos">  42</span></a><span class="sd">            Coordinates of the cell minimum corner in the lattice</span>
</span><span id="Cell-43"><a href="#Cell-43"><span class="linenos">  43</span></a>
</span><span id="Cell-44"><a href="#Cell-44"><span class="linenos">  44</span></a><span class="sd">        geom_types: list[str]</span>
</span><span id="Cell-45"><a href="#Cell-45"><span class="linenos">  45</span></a><span class="sd">            Type of lattice geometry</span>
</span><span id="Cell-46"><a href="#Cell-46"><span class="linenos">  46</span></a>
</span><span id="Cell-47"><a href="#Cell-47"><span class="linenos">  47</span></a><span class="sd">        radii: float</span>
</span><span id="Cell-48"><a href="#Cell-48"><span class="linenos">  48</span></a><span class="sd">            Base radii of the beam</span>
</span><span id="Cell-49"><a href="#Cell-49"><span class="linenos">  49</span></a>
</span><span id="Cell-50"><a href="#Cell-50"><span class="linenos">  50</span></a><span class="sd">        grad_radius: list</span>
</span><span id="Cell-51"><a href="#Cell-51"><span class="linenos">  51</span></a><span class="sd">            Gradient of the radii</span>
</span><span id="Cell-52"><a href="#Cell-52"><span class="linenos">  52</span></a>
</span><span id="Cell-53"><a href="#Cell-53"><span class="linenos">  53</span></a><span class="sd">        grad_dim: list</span>
</span><span id="Cell-54"><a href="#Cell-54"><span class="linenos">  54</span></a><span class="sd">            Gradient of the dimensions</span>
</span><span id="Cell-55"><a href="#Cell-55"><span class="linenos">  55</span></a>
</span><span id="Cell-56"><a href="#Cell-56"><span class="linenos">  56</span></a><span class="sd">        grad_mat: list</span>
</span><span id="Cell-57"><a href="#Cell-57"><span class="linenos">  57</span></a><span class="sd">            Gradient of the material</span>
</span><span id="Cell-58"><a href="#Cell-58"><span class="linenos">  58</span></a>
</span><span id="Cell-59"><a href="#Cell-59"><span class="linenos">  59</span></a><span class="sd">        uncertainty_node: float</span>
</span><span id="Cell-60"><a href="#Cell-60"><span class="linenos">  60</span></a><span class="sd">            Standard deviation for adding uncertainty to node coordinates. Defaults to 0.0.</span>
</span><span id="Cell-61"><a href="#Cell-61"><span class="linenos">  61</span></a>
</span><span id="Cell-62"><a href="#Cell-62"><span class="linenos">  62</span></a><span class="sd">        _verbose: bool</span>
</span><span id="Cell-63"><a href="#Cell-63"><span class="linenos">  63</span></a><span class="sd">            If True, prints additional information during initialization. Defaults to False.</span>
</span><span id="Cell-64"><a href="#Cell-64"><span class="linenos">  64</span></a>
</span><span id="Cell-65"><a href="#Cell-65"><span class="linenos">  65</span></a><span class="sd">        beams_already_defined: set</span>
</span><span id="Cell-66"><a href="#Cell-66"><span class="linenos">  66</span></a><span class="sd">            Set of beams already defined in the lattice to avoid duplication. Defaults to None.</span>
</span><span id="Cell-67"><a href="#Cell-67"><span class="linenos">  67</span></a>
</span><span id="Cell-68"><a href="#Cell-68"><span class="linenos">  68</span></a><span class="sd">        nodes_already_defined: set</span>
</span><span id="Cell-69"><a href="#Cell-69"><span class="linenos">  69</span></a><span class="sd">            Set of nodes already defined in the lattice to avoid duplication. Defaults to None.</span>
</span><span id="Cell-70"><a href="#Cell-70"><span class="linenos">  70</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-71"><a href="#Cell-71"><span class="linenos">  71</span></a>
</span><span id="Cell-72"><a href="#Cell-72"><span class="linenos">  72</span></a>        <span class="n">_validate_inputs_cell</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">geom_types</span><span class="p">,</span>
</span><span id="Cell-73"><a href="#Cell-73"><span class="linenos">  73</span></a>                         <span class="n">radii</span><span class="p">,</span> <span class="n">grad_radius</span><span class="p">,</span> <span class="n">grad_dim</span><span class="p">,</span> <span class="n">grad_mat</span><span class="p">,</span>
</span><span id="Cell-74"><a href="#Cell-74"><span class="linenos">  74</span></a>                         <span class="n">uncertainty_node</span><span class="p">,</span> <span class="n">_verbose</span><span class="p">)</span>
</span><span id="Cell-75"><a href="#Cell-75"><span class="linenos">  75</span></a>
</span><span id="Cell-76"><a href="#Cell-76"><span class="linenos">  76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_cell_geom</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-77"><a href="#Cell-77"><span class="linenos">  77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-78"><a href="#Cell-78"><span class="linenos">  78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_point</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-79"><a href="#Cell-79"><span class="linenos">  79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-80"><a href="#Cell-80"><span class="linenos">  80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-81"><a href="#Cell-81"><span class="linenos">  81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="Cell-82"><a href="#Cell-82"><span class="linenos">  82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinate</span>
</span><span id="Cell-83"><a href="#Cell-83"><span class="linenos">  83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Set of beams in the cell</span>
</span><span id="Cell-84"><a href="#Cell-84"><span class="linenos">  84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Set of points in the cell</span>
</span><span id="Cell-85"><a href="#Cell-85"><span class="linenos">  85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-86"><a href="#Cell-86"><span class="linenos">  86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">geom_types</span>
</span><span id="Cell-87"><a href="#Cell-87"><span class="linenos">  87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">radii</span>
</span><span id="Cell-88"><a href="#Cell-88"><span class="linenos">  88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># B matrix (Coupling matrix)</span>
</span><span id="Cell-89"><a href="#Cell-89"><span class="linenos">  89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">uncertainty_node</span>
</span><span id="Cell-90"><a href="#Cell-90"><span class="linenos">  90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">grad_radius</span>
</span><span id="Cell-91"><a href="#Cell-91"><span class="linenos">  91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">grad_mat</span>
</span><span id="Cell-92"><a href="#Cell-92"><span class="linenos">  92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">grad_dim</span>
</span><span id="Cell-93"><a href="#Cell-93"><span class="linenos">  93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_verbose</span>
</span><span id="Cell-94"><a href="#Cell-94"><span class="linenos">  94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Cell-95"><a href="#Cell-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-96"><a href="#Cell-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schur_complement_gradient</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-97"><a href="#Cell-97"><span class="linenos">  97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-98"><a href="#Cell-98"><span class="linenos">  98</span></a>
</span><span id="Cell-99"><a href="#Cell-99"><span class="linenos">  99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_cell_properties</span><span class="p">(</span><span class="n">initial_size</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">)</span>
</span><span id="Cell-100"><a href="#Cell-100"><span class="linenos"> 100</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_density</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Cell-101"><a href="#Cell-101"><span class="linenos"> 101</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s2">&quot;WARNING: Approximated relative density of the cell is greater than 1. &quot;</span>
</span><span id="Cell-102"><a href="#Cell-102"><span class="linenos"> 102</span></a>                                <span class="s2">&quot;Beam radius and cell size is probably not well defined&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Cell-103"><a href="#Cell-103"><span class="linenos"> 103</span></a>
</span><span id="Cell-104"><a href="#Cell-104"><span class="linenos"> 104</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Cell-105"><a href="#Cell-105"><span class="linenos"> 105</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Cell(Coordinates:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="si">}</span><span class="s2">, Size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">, Index:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Cell-106"><a href="#Cell-106"><span class="linenos"> 106</span></a>
</span><span id="Cell-107"><a href="#Cell-107"><span class="linenos"> 107</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell-108"><a href="#Cell-108"><span class="linenos"> 108</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Cell-109"><a href="#Cell-109"><span class="linenos"> 109</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dispose&quot;</span><span class="p">):</span>
</span><span id="Cell-110"><a href="#Cell-110"><span class="linenos"> 110</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
</span><span id="Cell-111"><a href="#Cell-111"><span class="linenos"> 111</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell-112"><a href="#Cell-112"><span class="linenos"> 112</span></a>            <span class="k">pass</span>
</span><span id="Cell-113"><a href="#Cell-113"><span class="linenos"> 113</span></a>
</span><span id="Cell-114"><a href="#Cell-114"><span class="linenos"> 114</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-115"><a href="#Cell-115"><span class="linenos"> 115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-116"><a href="#Cell-116"><span class="linenos"> 116</span></a><span class="sd">        Dispose of the cell by detaching beams and points, and cleaning up references.</span>
</span><span id="Cell-117"><a href="#Cell-117"><span class="linenos"> 117</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-118"><a href="#Cell-118"><span class="linenos"> 118</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Cell-119"><a href="#Cell-119"><span class="linenos"> 119</span></a>            <span class="n">beams</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Cell-120"><a href="#Cell-120"><span class="linenos"> 120</span></a>            <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Cell-121"><a href="#Cell-121"><span class="linenos"> 121</span></a>
</span><span id="Cell-122"><a href="#Cell-122"><span class="linenos"> 122</span></a>            <span class="c1"># Detach the beams</span>
</span><span id="Cell-123"><a href="#Cell-123"><span class="linenos"> 123</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
</span><span id="Cell-124"><a href="#Cell-124"><span class="linenos"> 124</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Cell-125"><a href="#Cell-125"><span class="linenos"> 125</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">cell_belongings</span><span class="p">:</span>
</span><span id="Cell-126"><a href="#Cell-126"><span class="linenos"> 126</span></a>                        <span class="n">b</span><span class="o">.</span><span class="n">cell_belongings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell-127"><a href="#Cell-127"><span class="linenos"> 127</span></a>                    <span class="c1"># If the beam no longer belongs to any cell, we prudently purge its links</span>
</span><span id="Cell-128"><a href="#Cell-128"><span class="linenos"> 128</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Cell-129"><a href="#Cell-129"><span class="linenos"> 129</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;delete_beam&quot;</span><span class="p">):</span>
</span><span id="Cell-130"><a href="#Cell-130"><span class="linenos"> 130</span></a>                            <span class="n">b</span><span class="o">.</span><span class="n">delete_beam</span><span class="p">()</span>
</span><span id="Cell-131"><a href="#Cell-131"><span class="linenos"> 131</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell-132"><a href="#Cell-132"><span class="linenos"> 132</span></a>                    <span class="k">pass</span>
</span><span id="Cell-133"><a href="#Cell-133"><span class="linenos"> 133</span></a>
</span><span id="Cell-134"><a href="#Cell-134"><span class="linenos"> 134</span></a>            <span class="c1"># Detach the points</span>
</span><span id="Cell-135"><a href="#Cell-135"><span class="linenos"> 135</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
</span><span id="Cell-136"><a href="#Cell-136"><span class="linenos"> 136</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Cell-137"><a href="#Cell-137"><span class="linenos"> 137</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">cell_belongings</span><span class="p">:</span>
</span><span id="Cell-138"><a href="#Cell-138"><span class="linenos"> 138</span></a>                        <span class="n">p</span><span class="o">.</span><span class="n">cell_belongings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell-139"><a href="#Cell-139"><span class="linenos"> 139</span></a>                    <span class="c1"># If the point no longer belongs to any cell, we prudently purge its links</span>
</span><span id="Cell-140"><a href="#Cell-140"><span class="linenos"> 140</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Cell-141"><a href="#Cell-141"><span class="linenos"> 141</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">):</span>
</span><span id="Cell-142"><a href="#Cell-142"><span class="linenos"> 142</span></a>                            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">)):</span>
</span><span id="Cell-143"><a href="#Cell-143"><span class="linenos"> 143</span></a>                                <span class="k">try</span><span class="p">:</span>
</span><span id="Cell-144"><a href="#Cell-144"><span class="linenos"> 144</span></a>                                    <span class="c1"># Remove the beam from the point&#39;s connected beams</span>
</span><span id="Cell-145"><a href="#Cell-145"><span class="linenos"> 145</span></a>                                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Cell-146"><a href="#Cell-146"><span class="linenos"> 146</span></a>                                        <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="Cell-147"><a href="#Cell-147"><span class="linenos"> 147</span></a>                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell-148"><a href="#Cell-148"><span class="linenos"> 148</span></a>                                    <span class="k">pass</span>
</span><span id="Cell-149"><a href="#Cell-149"><span class="linenos"> 149</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell-150"><a href="#Cell-150"><span class="linenos"> 150</span></a>                    <span class="k">pass</span>
</span><span id="Cell-151"><a href="#Cell-151"><span class="linenos"> 151</span></a>
</span><span id="Cell-152"><a href="#Cell-152"><span class="linenos"> 152</span></a>            <span class="c1"># Clear the sets</span>
</span><span id="Cell-153"><a href="#Cell-153"><span class="linenos"> 153</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Cell-154"><a href="#Cell-154"><span class="linenos"> 154</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Cell-155"><a href="#Cell-155"><span class="linenos"> 155</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell-156"><a href="#Cell-156"><span class="linenos"> 156</span></a>                <span class="k">pass</span>
</span><span id="Cell-157"><a href="#Cell-157"><span class="linenos"> 157</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Cell-158"><a href="#Cell-158"><span class="linenos"> 158</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Cell-159"><a href="#Cell-159"><span class="linenos"> 159</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell-160"><a href="#Cell-160"><span class="linenos"> 160</span></a>                <span class="k">pass</span>
</span><span id="Cell-161"><a href="#Cell-161"><span class="linenos"> 161</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell-162"><a href="#Cell-162"><span class="linenos"> 162</span></a>            <span class="k">pass</span>
</span><span id="Cell-163"><a href="#Cell-163"><span class="linenos"> 163</span></a>
</span><span id="Cell-164"><a href="#Cell-164"><span class="linenos"> 164</span></a>    <span class="nd">@property</span>
</span><span id="Cell-165"><a href="#Cell-165"><span class="linenos"> 165</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell-166"><a href="#Cell-166"><span class="linenos"> 166</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Calculate the volume of the cell.&quot;&quot;&quot;</span>
</span><span id="Cell-167"><a href="#Cell-167"><span class="linenos"> 167</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell-168"><a href="#Cell-168"><span class="linenos"> 168</span></a>
</span><span id="Cell-169"><a href="#Cell-169"><span class="linenos"> 169</span></a>    <span class="nd">@property</span>
</span><span id="Cell-170"><a href="#Cell-170"><span class="linenos"> 170</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relative_density</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell-171"><a href="#Cell-171"><span class="linenos"> 171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-172"><a href="#Cell-172"><span class="linenos"> 172</span></a><span class="sd">        Calculate the relative density of the cell based on the volume of beams and the cell volume.</span>
</span><span id="Cell-173"><a href="#Cell-173"><span class="linenos"> 173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-174"><a href="#Cell-174"><span class="linenos"> 174</span></a>        <span class="n">volumeBeams</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell-175"><a href="#Cell-175"><span class="linenos"> 175</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell-176"><a href="#Cell-176"><span class="linenos"> 176</span></a>            <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="Cell-177"><a href="#Cell-177"><span class="linenos"> 177</span></a>                <span class="n">volumeBeams</span> <span class="o">+=</span> <span class="n">beam</span><span class="o">.</span><span class="n">volume</span>
</span><span id="Cell-178"><a href="#Cell-178"><span class="linenos"> 178</span></a>        <span class="k">return</span> <span class="n">volumeBeams</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
</span><span id="Cell-179"><a href="#Cell-179"><span class="linenos"> 179</span></a>
</span><span id="Cell-180"><a href="#Cell-180"><span class="linenos"> 180</span></a>    <span class="nd">@property</span>
</span><span id="Cell-181"><a href="#Cell-181"><span class="linenos"> 181</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">volume_each_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Cell-182"><a href="#Cell-182"><span class="linenos"> 182</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-183"><a href="#Cell-183"><span class="linenos"> 183</span></a><span class="sd">        Get the volume of the cell separated by geometry type_beam.</span>
</span><span id="Cell-184"><a href="#Cell-184"><span class="linenos"> 184</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-185"><a href="#Cell-185"><span class="linenos"> 185</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">))</span>
</span><span id="Cell-186"><a href="#Cell-186"><span class="linenos"> 186</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell-187"><a href="#Cell-187"><span class="linenos"> 187</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span><span class="p">:</span>
</span><span id="Cell-188"><a href="#Cell-188"><span class="linenos"> 188</span></a>                <span class="n">volumeBeam</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">volume</span>
</span><span id="Cell-189"><a href="#Cell-189"><span class="linenos"> 189</span></a>                <span class="n">volumes</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">]</span> <span class="o">+=</span> <span class="n">volumeBeam</span>
</span><span id="Cell-190"><a href="#Cell-190"><span class="linenos"> 190</span></a>        <span class="k">return</span> <span class="n">volumes</span>
</span><span id="Cell-191"><a href="#Cell-191"><span class="linenos"> 191</span></a>
</span><span id="Cell-192"><a href="#Cell-192"><span class="linenos"> 192</span></a>    <span class="nd">@property</span>
</span><span id="Cell-193"><a href="#Cell-193"><span class="linenos"> 193</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell-194"><a href="#Cell-194"><span class="linenos"> 194</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-195"><a href="#Cell-195"><span class="linenos"> 195</span></a><span class="sd">        Get the boundary box of the cell</span>
</span><span id="Cell-196"><a href="#Cell-196"><span class="linenos"> 196</span></a>
</span><span id="Cell-197"><a href="#Cell-197"><span class="linenos"> 197</span></a><span class="sd">        Returns:</span>
</span><span id="Cell-198"><a href="#Cell-198"><span class="linenos"> 198</span></a><span class="sd">        --------</span>
</span><span id="Cell-199"><a href="#Cell-199"><span class="linenos"> 199</span></a><span class="sd">        list</span>
</span><span id="Cell-200"><a href="#Cell-200"><span class="linenos"> 200</span></a><span class="sd">            List of the boundary box coordinates</span>
</span><span id="Cell-201"><a href="#Cell-201"><span class="linenos"> 201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-202"><a href="#Cell-202"><span class="linenos"> 202</span></a>        <span class="n">xMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell-203"><a href="#Cell-203"><span class="linenos"> 203</span></a>        <span class="n">xMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell-204"><a href="#Cell-204"><span class="linenos"> 204</span></a>        <span class="n">yMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Cell-205"><a href="#Cell-205"><span class="linenos"> 205</span></a>        <span class="n">yMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Cell-206"><a href="#Cell-206"><span class="linenos"> 206</span></a>        <span class="n">zMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell-207"><a href="#Cell-207"><span class="linenos"> 207</span></a>        <span class="n">zMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell-208"><a href="#Cell-208"><span class="linenos"> 208</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">xMin</span><span class="p">,</span> <span class="n">xMax</span><span class="p">,</span> <span class="n">yMin</span><span class="p">,</span> <span class="n">yMax</span><span class="p">,</span> <span class="n">zMin</span><span class="p">,</span> <span class="n">zMax</span><span class="p">]</span>
</span><span id="Cell-209"><a href="#Cell-209"><span class="linenos"> 209</span></a>
</span><span id="Cell-210"><a href="#Cell-210"><span class="linenos"> 210</span></a>    <span class="nd">@property</span>
</span><span id="Cell-211"><a href="#Cell-211"><span class="linenos"> 211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">boundary_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
</span><span id="Cell-212"><a href="#Cell-212"><span class="linenos"> 212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-213"><a href="#Cell-213"><span class="linenos"> 213</span></a><span class="sd">        Return the 12 edge segments of the cell&#39;s axis-aligned bounding box</span>
</span><span id="Cell-214"><a href="#Cell-214"><span class="linenos"> 214</span></a><span class="sd">        as pairs of 3D points ((x,y,z), (x,y,z)).</span>
</span><span id="Cell-215"><a href="#Cell-215"><span class="linenos"> 215</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-216"><a href="#Cell-216"><span class="linenos"> 216</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="Cell-217"><a href="#Cell-217"><span class="linenos"> 217</span></a>        <span class="c1"># 8 vertices</span>
</span><span id="Cell-218"><a href="#Cell-218"><span class="linenos"> 218</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Cell-219"><a href="#Cell-219"><span class="linenos"> 219</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell-220"><a href="#Cell-220"><span class="linenos"> 220</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span>
</span><span id="Cell-221"><a href="#Cell-221"><span class="linenos"> 221</span></a>        <span class="p">]</span>
</span><span id="Cell-222"><a href="#Cell-222"><span class="linenos"> 222</span></a>        <span class="c1"># 12 edges (by vertex indices)</span>
</span><span id="Cell-223"><a href="#Cell-223"><span class="linenos"> 223</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Cell-224"><a href="#Cell-224"><span class="linenos"> 224</span></a>            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># bottom rectangle</span>
</span><span id="Cell-225"><a href="#Cell-225"><span class="linenos"> 225</span></a>            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="c1"># top rectangle</span>
</span><span id="Cell-226"><a href="#Cell-226"><span class="linenos"> 226</span></a>            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>  <span class="c1"># vertical edges</span>
</span><span id="Cell-227"><a href="#Cell-227"><span class="linenos"> 227</span></a>        <span class="p">]</span>
</span><span id="Cell-228"><a href="#Cell-228"><span class="linenos"> 228</span></a>        <span class="k">return</span> <span class="p">[(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
</span><span id="Cell-229"><a href="#Cell-229"><span class="linenos"> 229</span></a>
</span><span id="Cell-230"><a href="#Cell-230"><span class="linenos"> 230</span></a>    <span class="nd">@property</span>
</span><span id="Cell-231"><a href="#Cell-231"><span class="linenos"> 231</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">corner_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell-232"><a href="#Cell-232"><span class="linenos"> 232</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-233"><a href="#Cell-233"><span class="linenos"> 233</span></a><span class="sd">        Get the corner coordinates of the cell.</span>
</span><span id="Cell-234"><a href="#Cell-234"><span class="linenos"> 234</span></a>
</span><span id="Cell-235"><a href="#Cell-235"><span class="linenos"> 235</span></a><span class="sd">        Returns:</span>
</span><span id="Cell-236"><a href="#Cell-236"><span class="linenos"> 236</span></a><span class="sd">        --------</span>
</span><span id="Cell-237"><a href="#Cell-237"><span class="linenos"> 237</span></a><span class="sd">        list of tuples</span>
</span><span id="Cell-238"><a href="#Cell-238"><span class="linenos"> 238</span></a><span class="sd">            List of (x, y, z) coordinates of the corner points.</span>
</span><span id="Cell-239"><a href="#Cell-239"><span class="linenos"> 239</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-240"><a href="#Cell-240"><span class="linenos"> 240</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span>
</span><span id="Cell-241"><a href="#Cell-241"><span class="linenos"> 241</span></a>        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span><span id="Cell-242"><a href="#Cell-242"><span class="linenos"> 242</span></a>
</span><span id="Cell-243"><a href="#Cell-243"><span class="linenos"> 243</span></a>        <span class="n">corners</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Cell-244"><a href="#Cell-244"><span class="linenos"> 244</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell-245"><a href="#Cell-245"><span class="linenos"> 245</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell-246"><a href="#Cell-246"><span class="linenos"> 246</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell-247"><a href="#Cell-247"><span class="linenos"> 247</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell-248"><a href="#Cell-248"><span class="linenos"> 248</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="Cell-249"><a href="#Cell-249"><span class="linenos"> 249</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="Cell-250"><a href="#Cell-250"><span class="linenos"> 250</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="Cell-251"><a href="#Cell-251"><span class="linenos"> 251</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="Cell-252"><a href="#Cell-252"><span class="linenos"> 252</span></a>        <span class="p">]</span>
</span><span id="Cell-253"><a href="#Cell-253"><span class="linenos"> 253</span></a>
</span><span id="Cell-254"><a href="#Cell-254"><span class="linenos"> 254</span></a>        <span class="k">return</span> <span class="n">corners</span>
</span><span id="Cell-255"><a href="#Cell-255"><span class="linenos"> 255</span></a>
</span><span id="Cell-256"><a href="#Cell-256"><span class="linenos"> 256</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-257"><a href="#Cell-257"><span class="linenos"> 257</span></a><span class="c1"># SECTION: Design Methods</span>
</span><span id="Cell-258"><a href="#Cell-258"><span class="linenos"> 258</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-259"><a href="#Cell-259"><span class="linenos"> 259</span></a>
</span><span id="Cell-260"><a href="#Cell-260"><span class="linenos"> 260</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell-261"><a href="#Cell-261"><span class="linenos"> 261</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-262"><a href="#Cell-262"><span class="linenos"> 262</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_cell_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_cell_size</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Cell-263"><a href="#Cell-263"><span class="linenos"> 263</span></a>                                 <span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Cell-264"><a href="#Cell-264"><span class="linenos"> 264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-265"><a href="#Cell-265"><span class="linenos"> 265</span></a><span class="sd">        Generate cell properties including beams and nodes.</span>
</span><span id="Cell-266"><a href="#Cell-266"><span class="linenos"> 266</span></a>
</span><span id="Cell-267"><a href="#Cell-267"><span class="linenos"> 267</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-268"><a href="#Cell-268"><span class="linenos"> 268</span></a><span class="sd">        -----------</span>
</span><span id="Cell-269"><a href="#Cell-269"><span class="linenos"> 269</span></a><span class="sd">        initialCellSize: list</span>
</span><span id="Cell-270"><a href="#Cell-270"><span class="linenos"> 270</span></a><span class="sd">            Initial size of the cell without modification</span>
</span><span id="Cell-271"><a href="#Cell-271"><span class="linenos"> 271</span></a>
</span><span id="Cell-272"><a href="#Cell-272"><span class="linenos"> 272</span></a><span class="sd">        beams_already_defined: set</span>
</span><span id="Cell-273"><a href="#Cell-273"><span class="linenos"> 273</span></a><span class="sd">            Set of beams already defined in the lattice to avoid duplication</span>
</span><span id="Cell-274"><a href="#Cell-274"><span class="linenos"> 274</span></a>
</span><span id="Cell-275"><a href="#Cell-275"><span class="linenos"> 275</span></a><span class="sd">        nodes_already_defined: set</span>
</span><span id="Cell-276"><a href="#Cell-276"><span class="linenos"> 276</span></a><span class="sd">            Set of nodes already defined in the lattice to avoid duplication</span>
</span><span id="Cell-277"><a href="#Cell-277"><span class="linenos"> 277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-278"><a href="#Cell-278"><span class="linenos"> 278</span></a>        <span class="n">idxCell</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell-279"><a href="#Cell-279"><span class="linenos"> 279</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Cell-280"><a href="#Cell-280"><span class="linenos"> 280</span></a>            <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Cell-281"><a href="#Cell-281"><span class="linenos"> 281</span></a>                <span class="k">if</span> <span class="n">idxCell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Cell-282"><a href="#Cell-282"><span class="linenos"> 282</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">get_beam_material</span><span class="p">()</span>
</span><span id="Cell-283"><a href="#Cell-283"><span class="linenos"> 283</span></a>                    <span class="n">beamRadius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Cell-284"><a href="#Cell-284"><span class="linenos"> 284</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">def_cell_size</span><span class="p">(</span><span class="n">initial_cell_size</span><span class="p">)</span>
</span><span id="Cell-285"><a href="#Cell-285"><span class="linenos"> 285</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_beams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">beamRadius</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">)</span>
</span><span id="Cell-286"><a href="#Cell-286"><span class="linenos"> 286</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">def_cell_center</span><span class="p">()</span>
</span><span id="Cell-287"><a href="#Cell-287"><span class="linenos"> 287</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-288"><a href="#Cell-288"><span class="linenos"> 288</span></a>                    <span class="n">hybridRadius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Cell-289"><a href="#Cell-289"><span class="linenos"> 289</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_beams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">hybridRadius</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">)</span>
</span><span id="Cell-290"><a href="#Cell-290"><span class="linenos"> 290</span></a>                <span class="n">idxCell</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Cell-291"><a href="#Cell-291"><span class="linenos"> 291</span></a>
</span><span id="Cell-292"><a href="#Cell-292"><span class="linenos"> 292</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell-293"><a href="#Cell-293"><span class="linenos"> 293</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-294"><a href="#Cell-294"><span class="linenos"> 294</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latticeType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">beamRadius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">beamType</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Cell-295"><a href="#Cell-295"><span class="linenos"> 295</span></a>                       <span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
</span><span id="Cell-296"><a href="#Cell-296"><span class="linenos"> 296</span></a>            <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-297"><a href="#Cell-297"><span class="linenos"> 297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-298"><a href="#Cell-298"><span class="linenos"> 298</span></a><span class="sd">        Generate beams and nodes using a given lattice type_beam and parameters.</span>
</span><span id="Cell-299"><a href="#Cell-299"><span class="linenos"> 299</span></a>
</span><span id="Cell-300"><a href="#Cell-300"><span class="linenos"> 300</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-301"><a href="#Cell-301"><span class="linenos"> 301</span></a><span class="sd">        -----------</span>
</span><span id="Cell-302"><a href="#Cell-302"><span class="linenos"> 302</span></a><span class="sd">        latticeType: str</span>
</span><span id="Cell-303"><a href="#Cell-303"><span class="linenos"> 303</span></a><span class="sd">            Type of lattice structure (e.g., &#39;BCC&#39;, &#39;Hybrid1&#39;, etc.)</span>
</span><span id="Cell-304"><a href="#Cell-304"><span class="linenos"> 304</span></a>
</span><span id="Cell-305"><a href="#Cell-305"><span class="linenos"> 305</span></a><span class="sd">        beamRadius: float</span>
</span><span id="Cell-306"><a href="#Cell-306"><span class="linenos"> 306</span></a><span class="sd">            Radius of the beam</span>
</span><span id="Cell-307"><a href="#Cell-307"><span class="linenos"> 307</span></a>
</span><span id="Cell-308"><a href="#Cell-308"><span class="linenos"> 308</span></a><span class="sd">        beamType: int</span>
</span><span id="Cell-309"><a href="#Cell-309"><span class="linenos"> 309</span></a><span class="sd">            Type index of the beam</span>
</span><span id="Cell-310"><a href="#Cell-310"><span class="linenos"> 310</span></a>
</span><span id="Cell-311"><a href="#Cell-311"><span class="linenos"> 311</span></a><span class="sd">        beams_already_defined: set</span>
</span><span id="Cell-312"><a href="#Cell-312"><span class="linenos"> 312</span></a><span class="sd">            Set of beams already defined in the lattice to avoid duplication</span>
</span><span id="Cell-313"><a href="#Cell-313"><span class="linenos"> 313</span></a>
</span><span id="Cell-314"><a href="#Cell-314"><span class="linenos"> 314</span></a><span class="sd">        nodes_already_defined: set</span>
</span><span id="Cell-315"><a href="#Cell-315"><span class="linenos"> 315</span></a><span class="sd">            Set of nodes already defined in the lattice to avoid duplication</span>
</span><span id="Cell-316"><a href="#Cell-316"><span class="linenos"> 316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-317"><a href="#Cell-317"><span class="linenos"> 317</span></a>
</span><span id="Cell-318"><a href="#Cell-318"><span class="linenos"> 318</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">wkey</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="Cell-319"><a href="#Cell-319"><span class="linenos"> 319</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Create a unique key for a point based on its coordinates rounded to a specified number of digits.&quot;&quot;&quot;</span>
</span><span id="Cell-320"><a href="#Cell-320"><span class="linenos"> 320</span></a>            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">)</span>
</span><span id="Cell-321"><a href="#Cell-321"><span class="linenos"> 321</span></a>
</span><span id="Cell-322"><a href="#Cell-322"><span class="linenos"> 322</span></a>        <span class="n">frac_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Cell-323"><a href="#Cell-323"><span class="linenos"> 323</span></a>
</span><span id="Cell-324"><a href="#Cell-324"><span class="linenos"> 324</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">get_beam_structure</span><span class="p">(</span><span class="n">latticeType</span><span class="p">):</span>
</span><span id="Cell-325"><a href="#Cell-325"><span class="linenos"> 325</span></a>            <span class="n">x1f</span><span class="p">,</span> <span class="n">y1f</span><span class="p">,</span> <span class="n">z1f</span><span class="p">,</span> <span class="n">x2f</span><span class="p">,</span> <span class="n">y2f</span><span class="p">,</span> <span class="n">z2f</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span><span id="Cell-326"><a href="#Cell-326"><span class="linenos"> 326</span></a>
</span><span id="Cell-327"><a href="#Cell-327"><span class="linenos"> 327</span></a>            <span class="n">x1</span> <span class="o">=</span> <span class="n">x1f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell-328"><a href="#Cell-328"><span class="linenos"> 328</span></a>            <span class="n">y1</span> <span class="o">=</span> <span class="n">y1f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Cell-329"><a href="#Cell-329"><span class="linenos"> 329</span></a>            <span class="n">z1</span> <span class="o">=</span> <span class="n">z1f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell-330"><a href="#Cell-330"><span class="linenos"> 330</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="n">x2f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell-331"><a href="#Cell-331"><span class="linenos"> 331</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="n">y2f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Cell-332"><a href="#Cell-332"><span class="linenos"> 332</span></a>            <span class="n">z2</span> <span class="o">=</span> <span class="n">z2f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell-333"><a href="#Cell-333"><span class="linenos"> 333</span></a>
</span><span id="Cell-334"><a href="#Cell-334"><span class="linenos"> 334</span></a>            <span class="n">k1</span> <span class="o">=</span> <span class="n">wkey</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">)</span>
</span><span id="Cell-335"><a href="#Cell-335"><span class="linenos"> 335</span></a>            <span class="n">k2</span> <span class="o">=</span> <span class="n">wkey</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
</span><span id="Cell-336"><a href="#Cell-336"><span class="linenos"> 336</span></a>
</span><span id="Cell-337"><a href="#Cell-337"><span class="linenos"> 337</span></a>            <span class="k">if</span> <span class="n">nodes_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-338"><a href="#Cell-338"><span class="linenos"> 338</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">nodes_already_defined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
</span><span id="Cell-339"><a href="#Cell-339"><span class="linenos"> 339</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">nodes_already_defined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
</span><span id="Cell-340"><a href="#Cell-340"><span class="linenos"> 340</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-341"><a href="#Cell-341"><span class="linenos"> 341</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-342"><a href="#Cell-342"><span class="linenos"> 342</span></a>
</span><span id="Cell-343"><a href="#Cell-343"><span class="linenos"> 343</span></a>            <span class="k">if</span> <span class="n">p1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-344"><a href="#Cell-344"><span class="linenos"> 344</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">frac_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x1f</span><span class="p">,</span> <span class="n">y1f</span><span class="p">,</span> <span class="n">z1f</span><span class="p">))</span>
</span><span id="Cell-345"><a href="#Cell-345"><span class="linenos"> 345</span></a>                <span class="k">if</span> <span class="n">p1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-346"><a href="#Cell-346"><span class="linenos"> 346</span></a>                    <span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">)</span>
</span><span id="Cell-347"><a href="#Cell-347"><span class="linenos"> 347</span></a>                    <span class="n">frac_cache</span><span class="p">[(</span><span class="n">x1f</span><span class="p">,</span> <span class="n">y1f</span><span class="p">,</span> <span class="n">z1f</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p1</span>
</span><span id="Cell-348"><a href="#Cell-348"><span class="linenos"> 348</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-349"><a href="#Cell-349"><span class="linenos"> 349</span></a>                    <span class="n">p1</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell-350"><a href="#Cell-350"><span class="linenos"> 350</span></a>                <span class="k">if</span> <span class="n">nodes_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-351"><a href="#Cell-351"><span class="linenos"> 351</span></a>                    <span class="n">nodes_already_defined</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span>
</span><span id="Cell-352"><a href="#Cell-352"><span class="linenos"> 352</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-353"><a href="#Cell-353"><span class="linenos"> 353</span></a>                <span class="n">p1</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell-354"><a href="#Cell-354"><span class="linenos"> 354</span></a>
</span><span id="Cell-355"><a href="#Cell-355"><span class="linenos"> 355</span></a>            <span class="k">if</span> <span class="n">p2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-356"><a href="#Cell-356"><span class="linenos"> 356</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">frac_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x2f</span><span class="p">,</span> <span class="n">y2f</span><span class="p">,</span> <span class="n">z2f</span><span class="p">))</span>
</span><span id="Cell-357"><a href="#Cell-357"><span class="linenos"> 357</span></a>                <span class="k">if</span> <span class="n">p2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-358"><a href="#Cell-358"><span class="linenos"> 358</span></a>                    <span class="n">p2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">)</span>
</span><span id="Cell-359"><a href="#Cell-359"><span class="linenos"> 359</span></a>                    <span class="n">frac_cache</span><span class="p">[(</span><span class="n">x2f</span><span class="p">,</span> <span class="n">y2f</span><span class="p">,</span> <span class="n">z2f</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p2</span>
</span><span id="Cell-360"><a href="#Cell-360"><span class="linenos"> 360</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-361"><a href="#Cell-361"><span class="linenos"> 361</span></a>                    <span class="n">p2</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell-362"><a href="#Cell-362"><span class="linenos"> 362</span></a>                <span class="k">if</span> <span class="n">nodes_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-363"><a href="#Cell-363"><span class="linenos"> 363</span></a>                    <span class="n">nodes_already_defined</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p2</span>
</span><span id="Cell-364"><a href="#Cell-364"><span class="linenos"> 364</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-365"><a href="#Cell-365"><span class="linenos"> 365</span></a>                <span class="n">p2</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell-366"><a href="#Cell-366"><span class="linenos"> 366</span></a>
</span><span id="Cell-367"><a href="#Cell-367"><span class="linenos"> 367</span></a>            <span class="k">if</span> <span class="n">beams_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-368"><a href="#Cell-368"><span class="linenos"> 368</span></a>                <span class="n">bkey</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">)))</span>
</span><span id="Cell-369"><a href="#Cell-369"><span class="linenos"> 369</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="n">beams_already_defined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bkey</span><span class="p">)</span>
</span><span id="Cell-370"><a href="#Cell-370"><span class="linenos"> 370</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-371"><a href="#Cell-371"><span class="linenos"> 371</span></a>                <span class="n">bkey</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-372"><a href="#Cell-372"><span class="linenos"> 372</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell-373"><a href="#Cell-373"><span class="linenos"> 373</span></a>
</span><span id="Cell-374"><a href="#Cell-374"><span class="linenos"> 374</span></a>            <span class="k">if</span> <span class="n">beam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-375"><a href="#Cell-375"><span class="linenos"> 375</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">beamRadius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span><span class="p">,</span> <span class="n">beamType</span><span class="p">,</span> <span class="n">cell_belongings</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell-376"><a href="#Cell-376"><span class="linenos"> 376</span></a>                <span class="k">if</span> <span class="n">beams_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-377"><a href="#Cell-377"><span class="linenos"> 377</span></a>                    <span class="n">beams_already_defined</span><span class="p">[</span><span class="n">bkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam</span>
</span><span id="Cell-378"><a href="#Cell-378"><span class="linenos"> 378</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># Already defined beam, just add the cell belonging</span>
</span><span id="Cell-379"><a href="#Cell-379"><span class="linenos"> 379</span></a>                <span class="n">beam</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell-380"><a href="#Cell-380"><span class="linenos"> 380</span></a>
</span><span id="Cell-381"><a href="#Cell-381"><span class="linenos"> 381</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="Cell-382"><a href="#Cell-382"><span class="linenos"> 382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
</span><span id="Cell-383"><a href="#Cell-383"><span class="linenos"> 383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
</span><span id="Cell-384"><a href="#Cell-384"><span class="linenos"> 384</span></a>
</span><span id="Cell-385"><a href="#Cell-385"><span class="linenos"> 385</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_beam_material</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-386"><a href="#Cell-386"><span class="linenos"> 386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-387"><a href="#Cell-387"><span class="linenos"> 387</span></a><span class="sd">        Get the material of the beam based on the material gradient.</span>
</span><span id="Cell-388"><a href="#Cell-388"><span class="linenos"> 388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-389"><a href="#Cell-389"><span class="linenos"> 389</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-390"><a href="#Cell-390"><span class="linenos"> 390</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell-391"><a href="#Cell-391"><span class="linenos"> 391</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-392"><a href="#Cell-392"><span class="linenos"> 392</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="Cell-393"><a href="#Cell-393"><span class="linenos"> 393</span></a>
</span><span id="Cell-394"><a href="#Cell-394"><span class="linenos"> 394</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell-395"><a href="#Cell-395"><span class="linenos"> 395</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-396"><a href="#Cell-396"><span class="linenos"> 396</span></a><span class="sd">        Calculate and return the beam radii</span>
</span><span id="Cell-397"><a href="#Cell-397"><span class="linenos"> 397</span></a>
</span><span id="Cell-398"><a href="#Cell-398"><span class="linenos"> 398</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-399"><a href="#Cell-399"><span class="linenos"> 399</span></a><span class="sd">        -----------</span>
</span><span id="Cell-400"><a href="#Cell-400"><span class="linenos"> 400</span></a><span class="sd">        baseRadius: float</span>
</span><span id="Cell-401"><a href="#Cell-401"><span class="linenos"> 401</span></a><span class="sd">            Base radius of the beam</span>
</span><span id="Cell-402"><a href="#Cell-402"><span class="linenos"> 402</span></a>
</span><span id="Cell-403"><a href="#Cell-403"><span class="linenos"> 403</span></a><span class="sd">        Returns:</span>
</span><span id="Cell-404"><a href="#Cell-404"><span class="linenos"> 404</span></a><span class="sd">        ---------</span>
</span><span id="Cell-405"><a href="#Cell-405"><span class="linenos"> 405</span></a><span class="sd">        beamRadius : float</span>
</span><span id="Cell-406"><a href="#Cell-406"><span class="linenos"> 406</span></a><span class="sd">            Calculated beam radii</span>
</span><span id="Cell-407"><a href="#Cell-407"><span class="linenos"> 407</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-408"><a href="#Cell-408"><span class="linenos"> 408</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-409"><a href="#Cell-409"><span class="linenos"> 409</span></a>            <span class="k">return</span> <span class="n">base_radius</span>
</span><span id="Cell-410"><a href="#Cell-410"><span class="linenos"> 410</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-411"><a href="#Cell-411"><span class="linenos"> 411</span></a>            <span class="n">beamRadius</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_radius</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
</span><span id="Cell-412"><a href="#Cell-412"><span class="linenos"> 412</span></a>                          <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span>
</span><span id="Cell-413"><a href="#Cell-413"><span class="linenos"> 413</span></a>                          <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">])</span>
</span><span id="Cell-414"><a href="#Cell-414"><span class="linenos"> 414</span></a>            <span class="k">return</span> <span class="n">beamRadius</span>
</span><span id="Cell-415"><a href="#Cell-415"><span class="linenos"> 415</span></a>
</span><span id="Cell-416"><a href="#Cell-416"><span class="linenos"> 416</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">def_cell_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_cell_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-417"><a href="#Cell-417"><span class="linenos"> 417</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-418"><a href="#Cell-418"><span class="linenos"> 418</span></a><span class="sd">        Calculate and return the cell size</span>
</span><span id="Cell-419"><a href="#Cell-419"><span class="linenos"> 419</span></a>
</span><span id="Cell-420"><a href="#Cell-420"><span class="linenos"> 420</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-421"><a href="#Cell-421"><span class="linenos"> 421</span></a><span class="sd">        -----------</span>
</span><span id="Cell-422"><a href="#Cell-422"><span class="linenos"> 422</span></a><span class="sd">        initial_cell_size: list</span>
</span><span id="Cell-423"><a href="#Cell-423"><span class="linenos"> 423</span></a><span class="sd">            Initial size of the cell</span>
</span><span id="Cell-424"><a href="#Cell-424"><span class="linenos"> 424</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-425"><a href="#Cell-425"><span class="linenos"> 425</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-426"><a href="#Cell-426"><span class="linenos"> 426</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">initial_cell_size</span>
</span><span id="Cell-427"><a href="#Cell-427"><span class="linenos"> 427</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-428"><a href="#Cell-428"><span class="linenos"> 428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">initial_size</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="ow">in</span>
</span><span id="Cell-429"><a href="#Cell-429"><span class="linenos"> 429</span></a>                         <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">initial_cell_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">))]</span>
</span><span id="Cell-430"><a href="#Cell-430"><span class="linenos"> 430</span></a>
</span><span id="Cell-431"><a href="#Cell-431"><span class="linenos"> 431</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">def_cell_center</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-432"><a href="#Cell-432"><span class="linenos"> 432</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-433"><a href="#Cell-433"><span class="linenos"> 433</span></a><span class="sd">        Calculate the center point of the cell</span>
</span><span id="Cell-434"><a href="#Cell-434"><span class="linenos"> 434</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-435"><a href="#Cell-435"><span class="linenos"> 435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_point</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</span><span id="Cell-436"><a href="#Cell-436"><span class="linenos"> 436</span></a>
</span><span id="Cell-437"><a href="#Cell-437"><span class="linenos"> 437</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_point_on_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfaceName</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell-438"><a href="#Cell-438"><span class="linenos"> 438</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-439"><a href="#Cell-439"><span class="linenos"> 439</span></a><span class="sd">        Get the points on the surface specified in the global reference frame.</span>
</span><span id="Cell-440"><a href="#Cell-440"><span class="linenos"> 440</span></a>
</span><span id="Cell-441"><a href="#Cell-441"><span class="linenos"> 441</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-442"><a href="#Cell-442"><span class="linenos"> 442</span></a><span class="sd">        -----------</span>
</span><span id="Cell-443"><a href="#Cell-443"><span class="linenos"> 443</span></a><span class="sd">        surfaceName: str</span>
</span><span id="Cell-444"><a href="#Cell-444"><span class="linenos"> 444</span></a><span class="sd">            Name of the surface. Choose from &#39;Xmin&#39;, &#39;Xmax&#39;, &#39;Ymin&#39;, &#39;Ymax&#39;, &#39;Zmin&#39;, &#39;Zmax&#39;, &#39;Xmid&#39;, &#39;Ymid&#39;, &#39;Zmid&#39;.</span>
</span><span id="Cell-445"><a href="#Cell-445"><span class="linenos"> 445</span></a><span class="sd">            If &#39;Xmid&#39;, &#39;Ymid&#39;, or &#39;Zmid&#39; is specified, it returns the points at the bottom of the cell</span>
</span><span id="Cell-446"><a href="#Cell-446"><span class="linenos"> 446</span></a>
</span><span id="Cell-447"><a href="#Cell-447"><span class="linenos"> 447</span></a><span class="sd">        Returns:</span>
</span><span id="Cell-448"><a href="#Cell-448"><span class="linenos"> 448</span></a><span class="sd">        --------</span>
</span><span id="Cell-449"><a href="#Cell-449"><span class="linenos"> 449</span></a><span class="sd">        list</span>
</span><span id="Cell-450"><a href="#Cell-450"><span class="linenos"> 450</span></a><span class="sd">           List of points on the specified surface.</span>
</span><span id="Cell-451"><a href="#Cell-451"><span class="linenos"> 451</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-452"><a href="#Cell-452"><span class="linenos"> 452</span></a>        <span class="n">boundaryBox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="Cell-453"><a href="#Cell-453"><span class="linenos"> 453</span></a>        <span class="n">surface_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Cell-454"><a href="#Cell-454"><span class="linenos"> 454</span></a>            <span class="s2">&quot;Xmin&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Cell-455"><a href="#Cell-455"><span class="linenos"> 455</span></a>            <span class="s2">&quot;Xmax&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Cell-456"><a href="#Cell-456"><span class="linenos"> 456</span></a>            <span class="s2">&quot;Ymin&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="Cell-457"><a href="#Cell-457"><span class="linenos"> 457</span></a>            <span class="s2">&quot;Ymax&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="Cell-458"><a href="#Cell-458"><span class="linenos"> 458</span></a>            <span class="s2">&quot;Zmin&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span><span id="Cell-459"><a href="#Cell-459"><span class="linenos"> 459</span></a>            <span class="s2">&quot;Zmax&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span id="Cell-460"><a href="#Cell-460"><span class="linenos"> 460</span></a>            <span class="s2">&quot;Xmid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Cell-461"><a href="#Cell-461"><span class="linenos"> 461</span></a>            <span class="s2">&quot;Ymid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Cell-462"><a href="#Cell-462"><span class="linenos"> 462</span></a>            <span class="s2">&quot;Zmid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell-463"><a href="#Cell-463"><span class="linenos"> 463</span></a>        <span class="p">}</span>
</span><span id="Cell-464"><a href="#Cell-464"><span class="linenos"> 464</span></a>
</span><span id="Cell-465"><a href="#Cell-465"><span class="linenos"> 465</span></a>        <span class="n">coord_index</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Cell-466"><a href="#Cell-466"><span class="linenos"> 466</span></a>            <span class="s2">&quot;Xmin&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmid&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
</span><span id="Cell-467"><a href="#Cell-467"><span class="linenos"> 467</span></a>            <span class="s2">&quot;Ymin&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymid&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
</span><span id="Cell-468"><a href="#Cell-468"><span class="linenos"> 468</span></a>            <span class="s2">&quot;Zmin&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmax&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmid&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span>
</span><span id="Cell-469"><a href="#Cell-469"><span class="linenos"> 469</span></a>        <span class="p">}</span>
</span><span id="Cell-470"><a href="#Cell-470"><span class="linenos"> 470</span></a>
</span><span id="Cell-471"><a href="#Cell-471"><span class="linenos"> 471</span></a>        <span class="k">if</span> <span class="n">surfaceName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">surface_map</span><span class="p">:</span>
</span><span id="Cell-472"><a href="#Cell-472"><span class="linenos"> 472</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Cell-473"><a href="#Cell-473"><span class="linenos"> 473</span></a>                <span class="sa">f</span><span class="s2">&quot;Surface &#39;</span><span class="si">{</span><span class="n">surfaceName</span><span class="si">}</span><span class="s2">&#39; is not valid. Choose from &#39;Xmin&#39;, &#39;Xmax&#39;, &#39;Ymin&#39;, &#39;Ymax&#39;, &#39;Zmin&#39;, &#39;Zmax&#39;, &quot;</span>
</span><span id="Cell-474"><a href="#Cell-474"><span class="linenos"> 474</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;Xmid&#39;, &#39;Ymid&#39;, &#39;Zmid&#39;.&quot;</span><span class="p">)</span>
</span><span id="Cell-475"><a href="#Cell-475"><span class="linenos"> 475</span></a>
</span><span id="Cell-476"><a href="#Cell-476"><span class="linenos"> 476</span></a>        <span class="n">surface_value</span> <span class="o">=</span> <span class="n">surface_map</span><span class="p">[</span><span class="n">surfaceName</span><span class="p">]</span>
</span><span id="Cell-477"><a href="#Cell-477"><span class="linenos"> 477</span></a>        <span class="n">axis</span> <span class="o">=</span> <span class="n">coord_index</span><span class="p">[</span><span class="n">surfaceName</span><span class="p">]</span>
</span><span id="Cell-478"><a href="#Cell-478"><span class="linenos"> 478</span></a>
</span><span id="Cell-479"><a href="#Cell-479"><span class="linenos"> 479</span></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">({</span>
</span><span id="Cell-480"><a href="#Cell-480"><span class="linenos"> 480</span></a>            <span class="n">point</span> <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span>
</span><span id="Cell-481"><a href="#Cell-481"><span class="linenos"> 481</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]</span>
</span><span id="Cell-482"><a href="#Cell-482"><span class="linenos"> 482</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="n">surface_value</span>
</span><span id="Cell-483"><a href="#Cell-483"><span class="linenos"> 483</span></a>        <span class="p">})</span>
</span><span id="Cell-484"><a href="#Cell-484"><span class="linenos"> 484</span></a>
</span><span id="Cell-485"><a href="#Cell-485"><span class="linenos"> 485</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-486"><a href="#Cell-486"><span class="linenos"> 486</span></a><span class="c1"># SECTION: Modification Methods</span>
</span><span id="Cell-487"><a href="#Cell-487"><span class="linenos"> 487</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-488"><a href="#Cell-488"><span class="linenos"> 488</span></a>
</span><span id="Cell-489"><a href="#Cell-489"><span class="linenos"> 489</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell-490"><a href="#Cell-490"><span class="linenos"> 490</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-491"><a href="#Cell-491"><span class="linenos"> 491</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam_to_delete</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-492"><a href="#Cell-492"><span class="linenos"> 492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-493"><a href="#Cell-493"><span class="linenos"> 493</span></a><span class="sd">        Removing beam from cell</span>
</span><span id="Cell-494"><a href="#Cell-494"><span class="linenos"> 494</span></a>
</span><span id="Cell-495"><a href="#Cell-495"><span class="linenos"> 495</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-496"><a href="#Cell-496"><span class="linenos"> 496</span></a><span class="sd">        -----------</span>
</span><span id="Cell-497"><a href="#Cell-497"><span class="linenos"> 497</span></a><span class="sd">        beam_to_delete: Beam or Iterable[Beam]</span>
</span><span id="Cell-498"><a href="#Cell-498"><span class="linenos"> 498</span></a><span class="sd">            Beam or list of beams to remove from the cell</span>
</span><span id="Cell-499"><a href="#Cell-499"><span class="linenos"> 499</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-500"><a href="#Cell-500"><span class="linenos"> 500</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beam_to_delete</span><span class="p">,</span> <span class="n">Beam</span><span class="p">):</span>
</span><span id="Cell-501"><a href="#Cell-501"><span class="linenos"> 501</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">beam_to_delete</span><span class="p">)</span>
</span><span id="Cell-502"><a href="#Cell-502"><span class="linenos"> 502</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-503"><a href="#Cell-503"><span class="linenos"> 503</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beam_to_delete</span><span class="p">:</span>
</span><span id="Cell-504"><a href="#Cell-504"><span class="linenos"> 504</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="Cell-505"><a href="#Cell-505"><span class="linenos"> 505</span></a>
</span><span id="Cell-506"><a href="#Cell-506"><span class="linenos"> 506</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell-507"><a href="#Cell-507"><span class="linenos"> 507</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-508"><a href="#Cell-508"><span class="linenos"> 508</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_to_delete</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-509"><a href="#Cell-509"><span class="linenos"> 509</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-510"><a href="#Cell-510"><span class="linenos"> 510</span></a><span class="sd">        Removing point from cell</span>
</span><span id="Cell-511"><a href="#Cell-511"><span class="linenos"> 511</span></a>
</span><span id="Cell-512"><a href="#Cell-512"><span class="linenos"> 512</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-513"><a href="#Cell-513"><span class="linenos"> 513</span></a><span class="sd">        -----------</span>
</span><span id="Cell-514"><a href="#Cell-514"><span class="linenos"> 514</span></a><span class="sd">        point_to_delete: Point or Iterable[Point]</span>
</span><span id="Cell-515"><a href="#Cell-515"><span class="linenos"> 515</span></a><span class="sd">            Point or list of points to remove from the cell</span>
</span><span id="Cell-516"><a href="#Cell-516"><span class="linenos"> 516</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-517"><a href="#Cell-517"><span class="linenos"> 517</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_to_delete</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span>
</span><span id="Cell-518"><a href="#Cell-518"><span class="linenos"> 518</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">point_to_delete</span><span class="p">)</span>
</span><span id="Cell-519"><a href="#Cell-519"><span class="linenos"> 519</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-520"><a href="#Cell-520"><span class="linenos"> 520</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">point_to_delete</span><span class="p">:</span>
</span><span id="Cell-521"><a href="#Cell-521"><span class="linenos"> 521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Cell-522"><a href="#Cell-522"><span class="linenos"> 522</span></a>
</span><span id="Cell-523"><a href="#Cell-523"><span class="linenos"> 523</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell-524"><a href="#Cell-524"><span class="linenos"> 524</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-525"><a href="#Cell-525"><span class="linenos"> 525</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam_to_add</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-526"><a href="#Cell-526"><span class="linenos"> 526</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-527"><a href="#Cell-527"><span class="linenos"> 527</span></a><span class="sd">        Adding beam to cell</span>
</span><span id="Cell-528"><a href="#Cell-528"><span class="linenos"> 528</span></a>
</span><span id="Cell-529"><a href="#Cell-529"><span class="linenos"> 529</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-530"><a href="#Cell-530"><span class="linenos"> 530</span></a><span class="sd">        -----------</span>
</span><span id="Cell-531"><a href="#Cell-531"><span class="linenos"> 531</span></a><span class="sd">        beam_to_add: Beam or Iterable[Beam]</span>
</span><span id="Cell-532"><a href="#Cell-532"><span class="linenos"> 532</span></a><span class="sd">            Beam or list of beams to add to the cell</span>
</span><span id="Cell-533"><a href="#Cell-533"><span class="linenos"> 533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-534"><a href="#Cell-534"><span class="linenos"> 534</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beam_to_add</span><span class="p">,</span> <span class="n">Beam</span><span class="p">):</span>
</span><span id="Cell-535"><a href="#Cell-535"><span class="linenos"> 535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam_to_add</span><span class="p">)</span>
</span><span id="Cell-536"><a href="#Cell-536"><span class="linenos"> 536</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-537"><a href="#Cell-537"><span class="linenos"> 537</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beam_to_add</span><span class="p">)</span>
</span><span id="Cell-538"><a href="#Cell-538"><span class="linenos"> 538</span></a>
</span><span id="Cell-539"><a href="#Cell-539"><span class="linenos"> 539</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell-540"><a href="#Cell-540"><span class="linenos"> 540</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-541"><a href="#Cell-541"><span class="linenos"> 541</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_to_add</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;Point&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-542"><a href="#Cell-542"><span class="linenos"> 542</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-543"><a href="#Cell-543"><span class="linenos"> 543</span></a><span class="sd">        Adding point to cell</span>
</span><span id="Cell-544"><a href="#Cell-544"><span class="linenos"> 544</span></a>
</span><span id="Cell-545"><a href="#Cell-545"><span class="linenos"> 545</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-546"><a href="#Cell-546"><span class="linenos"> 546</span></a><span class="sd">        -----------</span>
</span><span id="Cell-547"><a href="#Cell-547"><span class="linenos"> 547</span></a><span class="sd">        point_to_add: Point or Iterable[Point]</span>
</span><span id="Cell-548"><a href="#Cell-548"><span class="linenos"> 548</span></a><span class="sd">            Point or list of points to add to the cell</span>
</span><span id="Cell-549"><a href="#Cell-549"><span class="linenos"> 549</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-550"><a href="#Cell-550"><span class="linenos"> 550</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_to_add</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span>
</span><span id="Cell-551"><a href="#Cell-551"><span class="linenos"> 551</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">point_to_add</span><span class="p">)</span>
</span><span id="Cell-552"><a href="#Cell-552"><span class="linenos"> 552</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-553"><a href="#Cell-553"><span class="linenos"> 553</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">point_to_add</span><span class="p">)</span>
</span><span id="Cell-554"><a href="#Cell-554"><span class="linenos"> 554</span></a>
</span><span id="Cell-555"><a href="#Cell-555"><span class="linenos"> 555</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell-556"><a href="#Cell-556"><span class="linenos"> 556</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-557"><a href="#Cell-557"><span class="linenos"> 557</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_cell_neighbour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sign</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">neighbour_cell</span><span class="p">:</span> <span class="s2">&quot;Cell&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-558"><a href="#Cell-558"><span class="linenos"> 558</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-559"><a href="#Cell-559"><span class="linenos"> 559</span></a><span class="sd">        Add a neighbour cell in a structured dict format.</span>
</span><span id="Cell-560"><a href="#Cell-560"><span class="linenos"> 560</span></a>
</span><span id="Cell-561"><a href="#Cell-561"><span class="linenos"> 561</span></a><span class="sd">        Parameters</span>
</span><span id="Cell-562"><a href="#Cell-562"><span class="linenos"> 562</span></a><span class="sd">        ----------</span>
</span><span id="Cell-563"><a href="#Cell-563"><span class="linenos"> 563</span></a><span class="sd">        direction : str</span>
</span><span id="Cell-564"><a href="#Cell-564"><span class="linenos"> 564</span></a><span class="sd">            One of &quot;x&quot;, &quot;y&quot;, &quot;z&quot;</span>
</span><span id="Cell-565"><a href="#Cell-565"><span class="linenos"> 565</span></a><span class="sd">        sign : str</span>
</span><span id="Cell-566"><a href="#Cell-566"><span class="linenos"> 566</span></a><span class="sd">            Either &quot;positif&quot; or &quot;negatif&quot;</span>
</span><span id="Cell-567"><a href="#Cell-567"><span class="linenos"> 567</span></a><span class="sd">        neighbour_cell : Cell</span>
</span><span id="Cell-568"><a href="#Cell-568"><span class="linenos"> 568</span></a><span class="sd">            Neighbour cell to add</span>
</span><span id="Cell-569"><a href="#Cell-569"><span class="linenos"> 569</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-570"><a href="#Cell-570"><span class="linenos"> 570</span></a>        <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">:</span>
</span><span id="Cell-571"><a href="#Cell-571"><span class="linenos"> 571</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Cell-572"><a href="#Cell-572"><span class="linenos"> 572</span></a>
</span><span id="Cell-573"><a href="#Cell-573"><span class="linenos"> 573</span></a>        <span class="k">if</span> <span class="n">sign</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">]:</span>
</span><span id="Cell-574"><a href="#Cell-574"><span class="linenos"> 574</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">sign</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbour_cell</span>
</span><span id="Cell-575"><a href="#Cell-575"><span class="linenos"> 575</span></a>
</span><span id="Cell-576"><a href="#Cell-576"><span class="linenos"> 576</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell-577"><a href="#Cell-577"><span class="linenos"> 577</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-578"><a href="#Cell-578"><span class="linenos"> 578</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_cell_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Cell&quot;</span><span class="p">]:</span>
</span><span id="Cell-579"><a href="#Cell-579"><span class="linenos"> 579</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-580"><a href="#Cell-580"><span class="linenos"> 580</span></a><span class="sd">        Get all neighbour cells in a flat list.</span>
</span><span id="Cell-581"><a href="#Cell-581"><span class="linenos"> 581</span></a>
</span><span id="Cell-582"><a href="#Cell-582"><span class="linenos"> 582</span></a><span class="sd">        Returns</span>
</span><span id="Cell-583"><a href="#Cell-583"><span class="linenos"> 583</span></a><span class="sd">        -------</span>
</span><span id="Cell-584"><a href="#Cell-584"><span class="linenos"> 584</span></a><span class="sd">        list of Cell</span>
</span><span id="Cell-585"><a href="#Cell-585"><span class="linenos"> 585</span></a><span class="sd">            List of all neighbour cells</span>
</span><span id="Cell-586"><a href="#Cell-586"><span class="linenos"> 586</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-587"><a href="#Cell-587"><span class="linenos"> 587</span></a>        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell-588"><a href="#Cell-588"><span class="linenos"> 588</span></a>        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">:</span>
</span><span id="Cell-589"><a href="#Cell-589"><span class="linenos"> 589</span></a>            <span class="k">for</span> <span class="n">sign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">]:</span>
</span><span id="Cell-590"><a href="#Cell-590"><span class="linenos"> 590</span></a>                <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">sign</span><span class="p">])</span>
</span><span id="Cell-591"><a href="#Cell-591"><span class="linenos"> 591</span></a>        <span class="k">return</span> <span class="n">neighbours</span>
</span><span id="Cell-592"><a href="#Cell-592"><span class="linenos"> 592</span></a>
</span><span id="Cell-593"><a href="#Cell-593"><span class="linenos"> 593</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_from_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_beams</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-594"><a href="#Cell-594"><span class="linenos"> 594</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-595"><a href="#Cell-595"><span class="linenos"> 595</span></a><span class="sd">        Rebuild self.beams_cell and self.points_cell from the current lattice state.</span>
</span><span id="Cell-596"><a href="#Cell-596"><span class="linenos"> 596</span></a><span class="sd">        Keeps only beams that still declare this cell as a belonging, and derives points from those beams.</span>
</span><span id="Cell-597"><a href="#Cell-597"><span class="linenos"> 597</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-598"><a href="#Cell-598"><span class="linenos"> 598</span></a>        <span class="n">live_beams</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Cell-599"><a href="#Cell-599"><span class="linenos"> 599</span></a>            <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">all_beams</span>
</span><span id="Cell-600"><a href="#Cell-600"><span class="linenos"> 600</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">cell_belongings</span>
</span><span id="Cell-601"><a href="#Cell-601"><span class="linenos"> 601</span></a>        <span class="p">}</span>
</span><span id="Cell-602"><a href="#Cell-602"><span class="linenos"> 602</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span> <span class="o">=</span> <span class="n">live_beams</span>
</span><span id="Cell-603"><a href="#Cell-603"><span class="linenos"> 603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">live_beams</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">)}</span>
</span><span id="Cell-604"><a href="#Cell-604"><span class="linenos"> 604</span></a>
</span><span id="Cell-605"><a href="#Cell-605"><span class="linenos"> 605</span></a>
</span><span id="Cell-606"><a href="#Cell-606"><span class="linenos"> 606</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-607"><a href="#Cell-607"><span class="linenos"> 607</span></a><span class="c1"># SECTION: Simulation Methods</span>
</span><span id="Cell-608"><a href="#Cell-608"><span class="linenos"> 608</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-609"><a href="#Cell-609"><span class="linenos"> 609</span></a>
</span><span id="Cell-610"><a href="#Cell-610"><span class="linenos"> 610</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-611"><a href="#Cell-611"><span class="linenos"> 611</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-612"><a href="#Cell-612"><span class="linenos"> 612</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_node_order_to_simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_priority</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-613"><a href="#Cell-613"><span class="linenos"> 613</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-614"><a href="#Cell-614"><span class="linenos"> 614</span></a><span class="sd">        Define a deterministic order for boundary nodes to ensure consistent simulation results.</span>
</span><span id="Cell-615"><a href="#Cell-615"><span class="linenos"> 615</span></a>
</span><span id="Cell-616"><a href="#Cell-616"><span class="linenos"> 616</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-617"><a href="#Cell-617"><span class="linenos"> 617</span></a><span class="sd">        -----------</span>
</span><span id="Cell-618"><a href="#Cell-618"><span class="linenos"> 618</span></a><span class="sd">        face_priority: Optional[List[str]]</span>
</span><span id="Cell-619"><a href="#Cell-619"><span class="linenos"> 619</span></a><span class="sd">            List defining the priority order of faces to assign nodes to when they lie on multiple faces.</span>
</span><span id="Cell-620"><a href="#Cell-620"><span class="linenos"> 620</span></a><span class="sd">            Default is [&quot;Xmin&quot;, &quot;Xmax&quot;, &quot;Ymin&quot;, &quot;Ymax&quot;, &quot;Zmin&quot;, &quot;Zmax&quot;].</span>
</span><span id="Cell-621"><a href="#Cell-621"><span class="linenos"> 621</span></a>
</span><span id="Cell-622"><a href="#Cell-622"><span class="linenos"> 622</span></a><span class="sd">        tol: float</span>
</span><span id="Cell-623"><a href="#Cell-623"><span class="linenos"> 623</span></a><span class="sd">            Tolerance for determining if a point lies on a face. Default is 1e-9.</span>
</span><span id="Cell-624"><a href="#Cell-624"><span class="linenos"> 624</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-625"><a href="#Cell-625"><span class="linenos"> 625</span></a>        <span class="k">if</span> <span class="n">face_priority</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-626"><a href="#Cell-626"><span class="linenos"> 626</span></a>            <span class="n">face_priority</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmax&quot;</span><span class="p">]</span>
</span><span id="Cell-627"><a href="#Cell-627"><span class="linenos"> 627</span></a>
</span><span id="Cell-628"><a href="#Cell-628"><span class="linenos"> 628</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="Cell-629"><a href="#Cell-629"><span class="linenos"> 629</span></a>
</span><span id="Cell-630"><a href="#Cell-630"><span class="linenos"> 630</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_faces_of_point</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Point</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Cell-631"><a href="#Cell-631"><span class="linenos"> 631</span></a>            <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell-632"><a href="#Cell-632"><span class="linenos"> 632</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Xmin&quot;</span><span class="p">)</span>
</span><span id="Cell-633"><a href="#Cell-633"><span class="linenos"> 633</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Xmax&quot;</span><span class="p">)</span>
</span><span id="Cell-634"><a href="#Cell-634"><span class="linenos"> 634</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Ymin&quot;</span><span class="p">)</span>
</span><span id="Cell-635"><a href="#Cell-635"><span class="linenos"> 635</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Ymax&quot;</span><span class="p">)</span>
</span><span id="Cell-636"><a href="#Cell-636"><span class="linenos"> 636</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Zmin&quot;</span><span class="p">)</span>
</span><span id="Cell-637"><a href="#Cell-637"><span class="linenos"> 637</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Zmax&quot;</span><span class="p">)</span>
</span><span id="Cell-638"><a href="#Cell-638"><span class="linenos"> 638</span></a>            <span class="k">return</span> <span class="n">faces</span>
</span><span id="Cell-639"><a href="#Cell-639"><span class="linenos"> 639</span></a>
</span><span id="Cell-640"><a href="#Cell-640"><span class="linenos"> 640</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_inplane_key</span><span class="p">(</span><span class="n">face</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">Point</span><span class="p">):</span>
</span><span id="Cell-641"><a href="#Cell-641"><span class="linenos"> 641</span></a>            <span class="c1"># Use the two in-plane coordinates as primary sort keys</span>
</span><span id="Cell-642"><a href="#Cell-642"><span class="linenos"> 642</span></a>            <span class="k">if</span> <span class="n">face</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">):</span>
</span><span id="Cell-643"><a href="#Cell-643"><span class="linenos"> 643</span></a>                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span>
</span><span id="Cell-644"><a href="#Cell-644"><span class="linenos"> 644</span></a>            <span class="k">if</span> <span class="n">face</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">):</span>
</span><span id="Cell-645"><a href="#Cell-645"><span class="linenos"> 645</span></a>                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span>
</span><span id="Cell-646"><a href="#Cell-646"><span class="linenos"> 646</span></a>            <span class="c1"># Z faces</span>
</span><span id="Cell-647"><a href="#Cell-647"><span class="linenos"> 647</span></a>            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span>
</span><span id="Cell-648"><a href="#Cell-648"><span class="linenos"> 648</span></a>
</span><span id="Cell-649"><a href="#Cell-649"><span class="linenos"> 649</span></a>        <span class="c1"># Unique boundary points by boundary index to avoid duplicates</span>
</span><span id="Cell-650"><a href="#Cell-650"><span class="linenos"> 650</span></a>        <span class="n">bnd_points</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Point</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Cell-651"><a href="#Cell-651"><span class="linenos"> 651</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell-652"><a href="#Cell-652"><span class="linenos"> 652</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">):</span>
</span><span id="Cell-653"><a href="#Cell-653"><span class="linenos"> 653</span></a>                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-654"><a href="#Cell-654"><span class="linenos"> 654</span></a>                    <span class="n">bnd_points</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="Cell-655"><a href="#Cell-655"><span class="linenos"> 655</span></a>
</span><span id="Cell-656"><a href="#Cell-656"><span class="linenos"> 656</span></a>        <span class="c1"># Assign each point to a single face using the given priority</span>
</span><span id="Cell-657"><a href="#Cell-657"><span class="linenos"> 657</span></a>        <span class="n">face_buckets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">face_priority</span><span class="p">}</span>
</span><span id="Cell-658"><a href="#Cell-658"><span class="linenos"> 658</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">bnd_points</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Cell-659"><a href="#Cell-659"><span class="linenos"> 659</span></a>            <span class="n">faces</span> <span class="o">=</span> <span class="n">_faces_of_point</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Cell-660"><a href="#Cell-660"><span class="linenos"> 660</span></a>            <span class="c1"># pick the first face that appears in face_priority</span>
</span><span id="Cell-661"><a href="#Cell-661"><span class="linenos"> 661</span></a>            <span class="n">chosen</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">face_priority</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Cell-662"><a href="#Cell-662"><span class="linenos"> 662</span></a>            <span class="k">if</span> <span class="n">chosen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-663"><a href="#Cell-663"><span class="linenos"> 663</span></a>                <span class="c1"># Extremely rare: numerical drift puts a node just off all faces; choose nearest</span>
</span><span id="Cell-664"><a href="#Cell-664"><span class="linenos"> 664</span></a>                <span class="n">dists</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Cell-665"><a href="#Cell-665"><span class="linenos"> 665</span></a>                    <span class="s2">&quot;Xmin&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">),</span>
</span><span id="Cell-666"><a href="#Cell-666"><span class="linenos"> 666</span></a>                    <span class="s2">&quot;Xmax&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">),</span>
</span><span id="Cell-667"><a href="#Cell-667"><span class="linenos"> 667</span></a>                    <span class="s2">&quot;Ymin&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">),</span>
</span><span id="Cell-668"><a href="#Cell-668"><span class="linenos"> 668</span></a>                    <span class="s2">&quot;Ymax&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">),</span>
</span><span id="Cell-669"><a href="#Cell-669"><span class="linenos"> 669</span></a>                    <span class="s2">&quot;Zmin&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell-670"><a href="#Cell-670"><span class="linenos"> 670</span></a>                    <span class="s2">&quot;Zmax&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z1</span><span class="p">),</span>
</span><span id="Cell-671"><a href="#Cell-671"><span class="linenos"> 671</span></a>                <span class="p">}</span>
</span><span id="Cell-672"><a href="#Cell-672"><span class="linenos"> 672</span></a>                <span class="n">chosen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">dists</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
</span><span id="Cell-673"><a href="#Cell-673"><span class="linenos"> 673</span></a>            <span class="n">face_buckets</span><span class="p">[</span><span class="n">chosen</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Cell-674"><a href="#Cell-674"><span class="linenos"> 674</span></a>
</span><span id="Cell-675"><a href="#Cell-675"><span class="linenos"> 675</span></a>        <span class="n">ordered</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell-676"><a href="#Cell-676"><span class="linenos"> 676</span></a>        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">face_priority</span><span class="p">:</span>
</span><span id="Cell-677"><a href="#Cell-677"><span class="linenos"> 677</span></a>            <span class="n">pts</span> <span class="o">=</span> <span class="n">face_buckets</span><span class="p">[</span><span class="n">face</span><span class="p">]</span>
</span><span id="Cell-678"><a href="#Cell-678"><span class="linenos"> 678</span></a>            <span class="n">pts</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">_inplane_key</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span>
</span><span id="Cell-679"><a href="#Cell-679"><span class="linenos"> 679</span></a>            <span class="n">ordered</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
</span><span id="Cell-680"><a href="#Cell-680"><span class="linenos"> 680</span></a>
</span><span id="Cell-681"><a href="#Cell-681"><span class="linenos"> 681</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span> <span class="o">=</span> <span class="n">ordered</span>
</span><span id="Cell-682"><a href="#Cell-682"><span class="linenos"> 682</span></a>
</span><span id="Cell-683"><a href="#Cell-683"><span class="linenos"> 683</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-684"><a href="#Cell-684"><span class="linenos"> 684</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-685"><a href="#Cell-685"><span class="linenos"> 685</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_reaction_force_on_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reactionForce</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-686"><a href="#Cell-686"><span class="linenos"> 686</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-687"><a href="#Cell-687"><span class="linenos"> 687</span></a><span class="sd">        Set reaction force on each boundary node in the established local order.</span>
</span><span id="Cell-688"><a href="#Cell-688"><span class="linenos"> 688</span></a>
</span><span id="Cell-689"><a href="#Cell-689"><span class="linenos"> 689</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-690"><a href="#Cell-690"><span class="linenos"> 690</span></a><span class="sd">        -----------</span>
</span><span id="Cell-691"><a href="#Cell-691"><span class="linenos"> 691</span></a><span class="sd">        reactionForce: list</span>
</span><span id="Cell-692"><a href="#Cell-692"><span class="linenos"> 692</span></a><span class="sd">            List of reaction force vectors corresponding to each boundary node.</span>
</span><span id="Cell-693"><a href="#Cell-693"><span class="linenos"> 693</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-694"><a href="#Cell-694"><span class="linenos"> 694</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">:</span>
</span><span id="Cell-695"><a href="#Cell-695"><span class="linenos"> 695</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Boundary node order not defined. Call define_node_order_to_simulate() first.&quot;</span><span class="p">)</span>
</span><span id="Cell-696"><a href="#Cell-696"><span class="linenos"> 696</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactionForce</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">):</span>
</span><span id="Cell-697"><a href="#Cell-697"><span class="linenos"> 697</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of reaction force entries: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">reactionForce</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs. boundary nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Cell-698"><a href="#Cell-698"><span class="linenos"> 698</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough reaction force entries for boundary nodes.&quot;</span><span class="p">)</span>
</span><span id="Cell-699"><a href="#Cell-699"><span class="linenos"> 699</span></a>
</span><span id="Cell-700"><a href="#Cell-700"><span class="linenos"> 700</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">):</span>
</span><span id="Cell-701"><a href="#Cell-701"><span class="linenos"> 701</span></a>            <span class="n">node</span><span class="o">.</span><span class="n">set_reaction_force</span><span class="p">(</span><span class="n">reactionForce</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Cell-702"><a href="#Cell-702"><span class="linenos"> 702</span></a>
</span><span id="Cell-703"><a href="#Cell-703"><span class="linenos"> 703</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-704"><a href="#Cell-704"><span class="linenos"> 704</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-705"><a href="#Cell-705"><span class="linenos"> 705</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_displacement_at_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodeList</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">],</span> <span class="s2">&quot;OrderedDict[int, Point]&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell-706"><a href="#Cell-706"><span class="linenos"> 706</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-707"><a href="#Cell-707"><span class="linenos"> 707</span></a><span class="sd">        Return displacement vectors ordered consistently with the provided local list/dict of Points.</span>
</span><span id="Cell-708"><a href="#Cell-708"><span class="linenos"> 708</span></a>
</span><span id="Cell-709"><a href="#Cell-709"><span class="linenos"> 709</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-710"><a href="#Cell-710"><span class="linenos"> 710</span></a><span class="sd">        -----------</span>
</span><span id="Cell-711"><a href="#Cell-711"><span class="linenos"> 711</span></a><span class="sd">        nodeList: list or OrderedDict</span>
</span><span id="Cell-712"><a href="#Cell-712"><span class="linenos"> 712</span></a><span class="sd">            List or OrderedDict of Point objects representing the nodes.</span>
</span><span id="Cell-713"><a href="#Cell-713"><span class="linenos"> 713</span></a>
</span><span id="Cell-714"><a href="#Cell-714"><span class="linenos"> 714</span></a><span class="sd">        Returns:</span>
</span><span id="Cell-715"><a href="#Cell-715"><span class="linenos"> 715</span></a><span class="sd">        --------</span>
</span><span id="Cell-716"><a href="#Cell-716"><span class="linenos"> 716</span></a><span class="sd">        list</span>
</span><span id="Cell-717"><a href="#Cell-717"><span class="linenos"> 717</span></a><span class="sd">            List of displacement vectors for the nodes.</span>
</span><span id="Cell-718"><a href="#Cell-718"><span class="linenos"> 718</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-719"><a href="#Cell-719"><span class="linenos"> 719</span></a>        <span class="n">displacementList</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell-720"><a href="#Cell-720"><span class="linenos"> 720</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodeList</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Cell-721"><a href="#Cell-721"><span class="linenos"> 721</span></a>            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodeList</span><span class="p">:</span>
</span><span id="Cell-722"><a href="#Cell-722"><span class="linenos"> 722</span></a>                <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
</span><span id="Cell-723"><a href="#Cell-723"><span class="linenos"> 723</span></a>                    <span class="n">displacementList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">)</span>
</span><span id="Cell-724"><a href="#Cell-724"><span class="linenos"> 724</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># OrderedDict-like</span>
</span><span id="Cell-725"><a href="#Cell-725"><span class="linenos"> 725</span></a>            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodeList</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Cell-726"><a href="#Cell-726"><span class="linenos"> 726</span></a>                <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
</span><span id="Cell-727"><a href="#Cell-727"><span class="linenos"> 727</span></a>                    <span class="n">displacementList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">)</span>
</span><span id="Cell-728"><a href="#Cell-728"><span class="linenos"> 728</span></a>        <span class="k">return</span> <span class="n">displacementList</span>
</span><span id="Cell-729"><a href="#Cell-729"><span class="linenos"> 729</span></a>
</span><span id="Cell-730"><a href="#Cell-730"><span class="linenos"> 730</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-731"><a href="#Cell-731"><span class="linenos"> 731</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-732"><a href="#Cell-732"><span class="linenos"> 732</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_displacement_at_boundary_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displacementArray</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-733"><a href="#Cell-733"><span class="linenos"> 733</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-734"><a href="#Cell-734"><span class="linenos"> 734</span></a><span class="sd">        Set displacement at nodes.</span>
</span><span id="Cell-735"><a href="#Cell-735"><span class="linenos"> 735</span></a>
</span><span id="Cell-736"><a href="#Cell-736"><span class="linenos"> 736</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-737"><a href="#Cell-737"><span class="linenos"> 737</span></a><span class="sd">        ------------</span>
</span><span id="Cell-738"><a href="#Cell-738"><span class="linenos"> 738</span></a><span class="sd">        displacementArray: list or array-like</span>
</span><span id="Cell-739"><a href="#Cell-739"><span class="linenos"> 739</span></a><span class="sd">            Flattened array of displacement values.</span>
</span><span id="Cell-740"><a href="#Cell-740"><span class="linenos"> 740</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-741"><a href="#Cell-741"><span class="linenos"> 741</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Cell-742"><a href="#Cell-742"><span class="linenos"> 742</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Non-zero displacements:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">displacementArray</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">displacementArray</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="Cell-743"><a href="#Cell-743"><span class="linenos"> 743</span></a>
</span><span id="Cell-744"><a href="#Cell-744"><span class="linenos"> 744</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell-745"><a href="#Cell-745"><span class="linenos"> 745</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="Cell-746"><a href="#Cell-746"><span class="linenos"> 746</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-747"><a href="#Cell-747"><span class="linenos"> 747</span></a>                    <span class="k">continue</span>
</span><span id="Cell-748"><a href="#Cell-748"><span class="linenos"> 748</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span><span id="Cell-749"><a href="#Cell-749"><span class="linenos"> 749</span></a>                    <span class="n">gi</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">global_free_DOF_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Cell-750"><a href="#Cell-750"><span class="linenos"> 750</span></a>                    <span class="k">if</span> <span class="n">gi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-751"><a href="#Cell-751"><span class="linenos"> 751</span></a>                        <span class="n">point</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">displacementArray</span><span class="p">[</span><span class="n">gi</span><span class="p">]</span>
</span><span id="Cell-752"><a href="#Cell-752"><span class="linenos"> 752</span></a>
</span><span id="Cell-753"><a href="#Cell-753"><span class="linenos"> 753</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-754"><a href="#Cell-754"><span class="linenos"> 754</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-755"><a href="#Cell-755"><span class="linenos"> 755</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build_coupling_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_free_DOF</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-756"><a href="#Cell-756"><span class="linenos"> 756</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-757"><a href="#Cell-757"><span class="linenos"> 757</span></a><span class="sd">        Build the coupling operator B using the deterministic local boundary-node order.</span>
</span><span id="Cell-758"><a href="#Cell-758"><span class="linenos"> 758</span></a>
</span><span id="Cell-759"><a href="#Cell-759"><span class="linenos"> 759</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-760"><a href="#Cell-760"><span class="linenos"> 760</span></a><span class="sd">        -----------</span>
</span><span id="Cell-761"><a href="#Cell-761"><span class="linenos"> 761</span></a><span class="sd">        nb_free_DOF: int</span>
</span><span id="Cell-762"><a href="#Cell-762"><span class="linenos"> 762</span></a><span class="sd">            Total number of free degrees of freedom in the global system.</span>
</span><span id="Cell-763"><a href="#Cell-763"><span class="linenos"> 763</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-764"><a href="#Cell-764"><span class="linenos"> 764</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">:</span>
</span><span id="Cell-765"><a href="#Cell-765"><span class="linenos"> 765</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">define_node_order_to_simulate</span><span class="p">()</span>
</span><span id="Cell-766"><a href="#Cell-766"><span class="linenos"> 766</span></a>
</span><span id="Cell-767"><a href="#Cell-767"><span class="linenos"> 767</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">coo_matrix</span>
</span><span id="Cell-768"><a href="#Cell-768"><span class="linenos"> 768</span></a>        <span class="n">data</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Cell-769"><a href="#Cell-769"><span class="linenos"> 769</span></a>
</span><span id="Cell-770"><a href="#Cell-770"><span class="linenos"> 770</span></a>        <span class="c1"># Map boundary index</span>
</span><span id="Cell-771"><a href="#Cell-771"><span class="linenos"> 771</span></a>        <span class="k">for</span> <span class="n">local_idx</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">):</span>
</span><span id="Cell-772"><a href="#Cell-772"><span class="linenos"> 772</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span><span id="Cell-773"><a href="#Cell-773"><span class="linenos"> 773</span></a>                <span class="n">gi</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">global_free_DOF_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Cell-774"><a href="#Cell-774"><span class="linenos"> 774</span></a>                <span class="k">if</span> <span class="n">gi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-775"><a href="#Cell-775"><span class="linenos"> 775</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Cell-776"><a href="#Cell-776"><span class="linenos"> 776</span></a>                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span>
</span><span id="Cell-777"><a href="#Cell-777"><span class="linenos"> 777</span></a>                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_idx</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
</span><span id="Cell-778"><a href="#Cell-778"><span class="linenos"> 778</span></a>
</span><span id="Cell-779"><a href="#Cell-779"><span class="linenos"> 779</span></a>        <span class="n">nbBndDOFloc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span>
</span><span id="Cell-780"><a href="#Cell-780"><span class="linenos"> 780</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nb_free_DOF</span><span class="p">,</span> <span class="n">nbBndDOFloc</span><span class="p">))</span>
</span><span id="Cell-781"><a href="#Cell-781"><span class="linenos"> 781</span></a>
</span><span id="Cell-782"><a href="#Cell-782"><span class="linenos"> 782</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-783"><a href="#Cell-783"><span class="linenos"> 783</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-784"><a href="#Cell-784"><span class="linenos"> 784</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build_local_preconditioner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schur_mean</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-785"><a href="#Cell-785"><span class="linenos"> 785</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-786"><a href="#Cell-786"><span class="linenos"> 786</span></a><span class="sd">        Build the local preconditioner matrix B^T * S * B</span>
</span><span id="Cell-787"><a href="#Cell-787"><span class="linenos"> 787</span></a>
</span><span id="Cell-788"><a href="#Cell-788"><span class="linenos"> 788</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-789"><a href="#Cell-789"><span class="linenos"> 789</span></a><span class="sd">        -----------</span>
</span><span id="Cell-790"><a href="#Cell-790"><span class="linenos"> 790</span></a><span class="sd">        schur_mean: array-like or None</span>
</span><span id="Cell-791"><a href="#Cell-791"><span class="linenos"> 791</span></a><span class="sd">            Schur complement matrix to use. If None, uses self.schur_complement.</span>
</span><span id="Cell-792"><a href="#Cell-792"><span class="linenos"> 792</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-793"><a href="#Cell-793"><span class="linenos"> 793</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">coo_matrix</span><span class="p">,</span> <span class="n">csc_matrix</span><span class="p">,</span> <span class="n">isspmatrix</span>
</span><span id="Cell-794"><a href="#Cell-794"><span class="linenos"> 794</span></a>
</span><span id="Cell-795"><a href="#Cell-795"><span class="linenos"> 795</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-796"><a href="#Cell-796"><span class="linenos"> 796</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coupling matrix has not been built yet. Please build it first.&quot;</span><span class="p">)</span>
</span><span id="Cell-797"><a href="#Cell-797"><span class="linenos"> 797</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Cell-798"><a href="#Cell-798"><span class="linenos"> 798</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of B matrix&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Cell-799"><a href="#Cell-799"><span class="linenos"> 799</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of Schur matrix&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span><span class="p">))</span>
</span><span id="Cell-800"><a href="#Cell-800"><span class="linenos"> 800</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible dimensions between the coupling matrix and the Schur matrix.&quot;</span><span class="p">)</span>
</span><span id="Cell-801"><a href="#Cell-801"><span class="linenos"> 801</span></a>
</span><span id="Cell-802"><a href="#Cell-802"><span class="linenos"> 802</span></a>        <span class="c1"># Ensure sparse Schur complement to avoid dense products</span>
</span><span id="Cell-803"><a href="#Cell-803"><span class="linenos"> 803</span></a>        <span class="k">if</span> <span class="n">schur_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-804"><a href="#Cell-804"><span class="linenos"> 804</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span>
</span><span id="Cell-805"><a href="#Cell-805"><span class="linenos"> 805</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-806"><a href="#Cell-806"><span class="linenos"> 806</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">schur_mean</span>
</span><span id="Cell-807"><a href="#Cell-807"><span class="linenos"> 807</span></a>
</span><span id="Cell-808"><a href="#Cell-808"><span class="linenos"> 808</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">isspmatrix</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
</span><span id="Cell-809"><a href="#Cell-809"><span class="linenos"> 809</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="Cell-810"><a href="#Cell-810"><span class="linenos"> 810</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell-811"><a href="#Cell-811"><span class="linenos"> 811</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
</span><span id="Cell-812"><a href="#Cell-812"><span class="linenos"> 812</span></a>
</span><span id="Cell-813"><a href="#Cell-813"><span class="linenos"> 813</span></a>        <span class="n">B_csr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
</span><span id="Cell-814"><a href="#Cell-814"><span class="linenos"> 814</span></a>        <span class="n">active_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">B_csr</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Cell-815"><a href="#Cell-815"><span class="linenos"> 815</span></a>        <span class="n">n_global</span> <span class="o">=</span> <span class="n">B_csr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell-816"><a href="#Cell-816"><span class="linenos"> 816</span></a>
</span><span id="Cell-817"><a href="#Cell-817"><span class="linenos"> 817</span></a>        <span class="k">if</span> <span class="n">active_rows</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Cell-818"><a href="#Cell-818"><span class="linenos"> 818</span></a>            <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">n_global</span><span class="p">,</span> <span class="n">n_global</span><span class="p">))</span>
</span><span id="Cell-819"><a href="#Cell-819"><span class="linenos"> 819</span></a>
</span><span id="Cell-820"><a href="#Cell-820"><span class="linenos"> 820</span></a>        <span class="n">subB</span> <span class="o">=</span> <span class="n">B_csr</span><span class="p">[</span><span class="n">active_rows</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (r x nb)</span>
</span><span id="Cell-821"><a href="#Cell-821"><span class="linenos"> 821</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">S</span> <span class="o">@</span> <span class="n">subB</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>  <span class="c1"># (nb x r)</span>
</span><span id="Cell-822"><a href="#Cell-822"><span class="linenos"> 822</span></a>        <span class="n">local_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">subB</span> <span class="o">@</span> <span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>  <span class="c1"># (r x r)</span>
</span><span id="Cell-823"><a href="#Cell-823"><span class="linenos"> 823</span></a>
</span><span id="Cell-824"><a href="#Cell-824"><span class="linenos"> 824</span></a>        <span class="c1"># Map back to absolute global indices without creating a huge intermediate</span>
</span><span id="Cell-825"><a href="#Cell-825"><span class="linenos"> 825</span></a>        <span class="n">row_idx</span> <span class="o">=</span> <span class="n">active_rows</span><span class="p">[</span><span class="n">local_block</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>
</span><span id="Cell-826"><a href="#Cell-826"><span class="linenos"> 826</span></a>        <span class="n">col_idx</span> <span class="o">=</span> <span class="n">active_rows</span><span class="p">[</span><span class="n">local_block</span><span class="o">.</span><span class="n">col</span><span class="p">]</span>
</span><span id="Cell-827"><a href="#Cell-827"><span class="linenos"> 827</span></a>
</span><span id="Cell-828"><a href="#Cell-828"><span class="linenos"> 828</span></a>        <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">local_block</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_global</span><span class="p">,</span> <span class="n">n_global</span><span class="p">))</span>
</span><span id="Cell-829"><a href="#Cell-829"><span class="linenos"> 829</span></a>
</span><span id="Cell-830"><a href="#Cell-830"><span class="linenos"> 830</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-831"><a href="#Cell-831"><span class="linenos"> 831</span></a><span class="c1"># SECTION: Simulation getters methods</span>
</span><span id="Cell-832"><a href="#Cell-832"><span class="linenos"> 832</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-833"><a href="#Cell-833"><span class="linenos"> 833</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-834"><a href="#Cell-834"><span class="linenos"> 834</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-835"><a href="#Cell-835"><span class="linenos"> 835</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_boundary_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Cell-836"><a href="#Cell-836"><span class="linenos"> 836</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-837"><a href="#Cell-837"><span class="linenos"> 837</span></a><span class="sd">        Get the number of unique boundary nodes in the cell.</span>
</span><span id="Cell-838"><a href="#Cell-838"><span class="linenos"> 838</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-839"><a href="#Cell-839"><span class="linenos"> 839</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">({</span><span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">})</span>
</span><span id="Cell-840"><a href="#Cell-840"><span class="linenos"> 840</span></a>
</span><span id="Cell-841"><a href="#Cell-841"><span class="linenos"> 841</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-842"><a href="#Cell-842"><span class="linenos"> 842</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-843"><a href="#Cell-843"><span class="linenos"> 843</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_internal_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell-844"><a href="#Cell-844"><span class="linenos"> 844</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-845"><a href="#Cell-845"><span class="linenos"> 845</span></a><span class="sd">        Get cell internal energy from all boundary points</span>
</span><span id="Cell-846"><a href="#Cell-846"><span class="linenos"> 846</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-847"><a href="#Cell-847"><span class="linenos"> 847</span></a>        <span class="n">min_energy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e-12</span>
</span><span id="Cell-848"><a href="#Cell-848"><span class="linenos"> 848</span></a>        <span class="n">internalEnergy</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell-849"><a href="#Cell-849"><span class="linenos"> 849</span></a>        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span>
</span><span id="Cell-850"><a href="#Cell-850"><span class="linenos"> 850</span></a>            <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-851"><a href="#Cell-851"><span class="linenos"> 851</span></a>                <span class="n">pointEnergy</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">calculate_point_energy</span><span class="p">()</span>
</span><span id="Cell-852"><a href="#Cell-852"><span class="linenos"> 852</span></a>                <span class="k">if</span> <span class="n">pointEnergy</span> <span class="o">&lt;</span> <span class="n">min_energy</span><span class="p">:</span>
</span><span id="Cell-853"><a href="#Cell-853"><span class="linenos"> 853</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Negative energy = &quot;</span><span class="p">,</span> <span class="n">pointEnergy</span><span class="p">)</span>
</span><span id="Cell-854"><a href="#Cell-854"><span class="linenos"> 854</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Negative energy detected at point with index &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span><span class="p">))</span>
</span><span id="Cell-855"><a href="#Cell-855"><span class="linenos"> 855</span></a>                <span class="n">internalEnergy</span> <span class="o">+=</span> <span class="n">pointEnergy</span>
</span><span id="Cell-856"><a href="#Cell-856"><span class="linenos"> 856</span></a>        <span class="k">return</span> <span class="n">internalEnergy</span>
</span><span id="Cell-857"><a href="#Cell-857"><span class="linenos"> 857</span></a>
</span><span id="Cell-858"><a href="#Cell-858"><span class="linenos"> 858</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-859"><a href="#Cell-859"><span class="linenos"> 859</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-860"><a href="#Cell-860"><span class="linenos"> 860</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_displacement_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell-861"><a href="#Cell-861"><span class="linenos"> 861</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-862"><a href="#Cell-862"><span class="linenos"> 862</span></a><span class="sd">        Build and return displacement data on cell for dataset generation</span>
</span><span id="Cell-863"><a href="#Cell-863"><span class="linenos"> 863</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-864"><a href="#Cell-864"><span class="linenos"> 864</span></a>        <span class="n">allBoundaryDisplacementData</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell-865"><a href="#Cell-865"><span class="linenos"> 865</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell-866"><a href="#Cell-866"><span class="linenos"> 866</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="Cell-867"><a href="#Cell-867"><span class="linenos"> 867</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-868"><a href="#Cell-868"><span class="linenos"> 868</span></a>                    <span class="n">allBoundaryDisplacementData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">)</span>
</span><span id="Cell-869"><a href="#Cell-869"><span class="linenos"> 869</span></a>        <span class="k">return</span> <span class="n">allBoundaryDisplacementData</span>
</span><span id="Cell-870"><a href="#Cell-870"><span class="linenos"> 870</span></a>
</span><span id="Cell-871"><a href="#Cell-871"><span class="linenos"> 871</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell-872"><a href="#Cell-872"><span class="linenos"> 872</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-873"><a href="#Cell-873"><span class="linenos"> 873</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_nodes_at_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell-874"><a href="#Cell-874"><span class="linenos"> 874</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-875"><a href="#Cell-875"><span class="linenos"> 875</span></a><span class="sd">        Get the number of nodes at the boundary</span>
</span><span id="Cell-876"><a href="#Cell-876"><span class="linenos"> 876</span></a>
</span><span id="Cell-877"><a href="#Cell-877"><span class="linenos"> 877</span></a><span class="sd">        Returns:</span>
</span><span id="Cell-878"><a href="#Cell-878"><span class="linenos"> 878</span></a><span class="sd">        --------</span>
</span><span id="Cell-879"><a href="#Cell-879"><span class="linenos"> 879</span></a><span class="sd">        int</span>
</span><span id="Cell-880"><a href="#Cell-880"><span class="linenos"> 880</span></a><span class="sd">            Number of nodes at the boundary</span>
</span><span id="Cell-881"><a href="#Cell-881"><span class="linenos"> 881</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-882"><a href="#Cell-882"><span class="linenos"> 882</span></a>        <span class="n">counterNodes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell-883"><a href="#Cell-883"><span class="linenos"> 883</span></a>        <span class="n">nodeAlreadyCounted</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell-884"><a href="#Cell-884"><span class="linenos"> 884</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell-885"><a href="#Cell-885"><span class="linenos"> 885</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="Cell-886"><a href="#Cell-886"><span class="linenos"> 886</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodeAlreadyCounted</span><span class="p">:</span>
</span><span id="Cell-887"><a href="#Cell-887"><span class="linenos"> 887</span></a>                    <span class="n">counterNodes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Cell-888"><a href="#Cell-888"><span class="linenos"> 888</span></a>                    <span class="n">nodeAlreadyCounted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span><span class="p">)</span>
</span><span id="Cell-889"><a href="#Cell-889"><span class="linenos"> 889</span></a>        <span class="k">return</span> <span class="n">counterNodes</span>
</span><span id="Cell-890"><a href="#Cell-890"><span class="linenos"> 890</span></a>
</span><span id="Cell-891"><a href="#Cell-891"><span class="linenos"> 891</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-892"><a href="#Cell-892"><span class="linenos"> 892</span></a><span class="c1"># SECTION: Optimization Methods</span>
</span><span id="Cell-893"><a href="#Cell-893"><span class="linenos"> 893</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-894"><a href="#Cell-894"><span class="linenos"> 894</span></a>
</span><span id="Cell-895"><a href="#Cell-895"><span class="linenos"> 895</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell-896"><a href="#Cell-896"><span class="linenos"> 896</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-897"><a href="#Cell-897"><span class="linenos"> 897</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">change_beam_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_radius</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-898"><a href="#Cell-898"><span class="linenos"> 898</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-899"><a href="#Cell-899"><span class="linenos"> 899</span></a><span class="sd">        WARNING: BEAM MOD IS NOT WORKING</span>
</span><span id="Cell-900"><a href="#Cell-900"><span class="linenos"> 900</span></a><span class="sd">        Change beam radii in the cell</span>
</span><span id="Cell-901"><a href="#Cell-901"><span class="linenos"> 901</span></a>
</span><span id="Cell-902"><a href="#Cell-902"><span class="linenos"> 902</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-903"><a href="#Cell-903"><span class="linenos"> 903</span></a><span class="sd">        -----------</span>
</span><span id="Cell-904"><a href="#Cell-904"><span class="linenos"> 904</span></a><span class="sd">        newRadius: list</span>
</span><span id="Cell-905"><a href="#Cell-905"><span class="linenos"> 905</span></a><span class="sd">            beam radii wanted to assign</span>
</span><span id="Cell-906"><a href="#Cell-906"><span class="linenos"> 906</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-907"><a href="#Cell-907"><span class="linenos"> 907</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Cell-908"><a href="#Cell-908"><span class="linenos"> 908</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;WARNING: Beam modification is not implemented yet. &quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Cell-909"><a href="#Cell-909"><span class="linenos"> 909</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_radius</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Length of new radii vector and already cell radii vector needs &quot;</span>
</span><span id="Cell-910"><a href="#Cell-910"><span class="linenos"> 910</span></a>                                                    <span class="s2">&quot;to be equal &quot;</span><span class="p">)</span>
</span><span id="Cell-911"><a href="#Cell-911"><span class="linenos"> 911</span></a>        <span class="n">beamRadius</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell-912"><a href="#Cell-912"><span class="linenos"> 912</span></a>        <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">new_radius</span><span class="p">:</span>
</span><span id="Cell-913"><a href="#Cell-913"><span class="linenos"> 913</span></a>            <span class="n">beamRadius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span>
</span><span id="Cell-914"><a href="#Cell-914"><span class="linenos"> 914</span></a>
</span><span id="Cell-915"><a href="#Cell-915"><span class="linenos"> 915</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell-916"><a href="#Cell-916"><span class="linenos"> 916</span></a>            <span class="n">beam</span><span class="o">.</span><span class="n">change_beam_radius</span><span class="p">(</span><span class="n">beamRadius</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">])</span>
</span><span id="Cell-917"><a href="#Cell-917"><span class="linenos"> 917</span></a>
</span><span id="Cell-918"><a href="#Cell-918"><span class="linenos"> 918</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">new_radius</span>
</span><span id="Cell-919"><a href="#Cell-919"><span class="linenos"> 919</span></a>
</span><span id="Cell-920"><a href="#Cell-920"><span class="linenos"> 920</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell-921"><a href="#Cell-921"><span class="linenos"> 921</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-922"><a href="#Cell-922"><span class="linenos"> 922</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_kriging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kriging_model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell-923"><a href="#Cell-923"><span class="linenos"> 923</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-924"><a href="#Cell-924"><span class="linenos"> 924</span></a><span class="sd">        Get the relative density of the cell using kriging model</span>
</span><span id="Cell-925"><a href="#Cell-925"><span class="linenos"> 925</span></a>
</span><span id="Cell-926"><a href="#Cell-926"><span class="linenos"> 926</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-927"><a href="#Cell-927"><span class="linenos"> 927</span></a><span class="sd">        -----------</span>
</span><span id="Cell-928"><a href="#Cell-928"><span class="linenos"> 928</span></a><span class="sd">        krigingModel: Kriging</span>
</span><span id="Cell-929"><a href="#Cell-929"><span class="linenos"> 929</span></a><span class="sd">            Kriging model to use for prediction</span>
</span><span id="Cell-930"><a href="#Cell-930"><span class="linenos"> 930</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-931"><a href="#Cell-931"><span class="linenos"> 931</span></a>        <span class="n">relative_density</span> <span class="o">=</span> <span class="n">kriging_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell-932"><a href="#Cell-932"><span class="linenos"> 932</span></a>        <span class="k">return</span> <span class="n">relative_density</span>
</span><span id="Cell-933"><a href="#Cell-933"><span class="linenos"> 933</span></a>
</span><span id="Cell-934"><a href="#Cell-934"><span class="linenos"> 934</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell-935"><a href="#Cell-935"><span class="linenos"> 935</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-936"><a href="#Cell-936"><span class="linenos"> 936</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relative_density_poly_deriv</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell-937"><a href="#Cell-937"><span class="linenos"> 937</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-938"><a href="#Cell-938"><span class="linenos"> 938</span></a><span class="sd">        Get the gradient of the relative density</span>
</span><span id="Cell-939"><a href="#Cell-939"><span class="linenos"> 939</span></a>
</span><span id="Cell-940"><a href="#Cell-940"><span class="linenos"> 940</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-941"><a href="#Cell-941"><span class="linenos"> 941</span></a><span class="sd">        -----------</span>
</span><span id="Cell-942"><a href="#Cell-942"><span class="linenos"> 942</span></a><span class="sd">        relative_density_poly_deriv: list</span>
</span><span id="Cell-943"><a href="#Cell-943"><span class="linenos"> 943</span></a><span class="sd">            List of polynomial derivative functions</span>
</span><span id="Cell-944"><a href="#Cell-944"><span class="linenos"> 944</span></a>
</span><span id="Cell-945"><a href="#Cell-945"><span class="linenos"> 945</span></a><span class="sd">        Returns:</span>
</span><span id="Cell-946"><a href="#Cell-946"><span class="linenos"> 946</span></a><span class="sd">        --------</span>
</span><span id="Cell-947"><a href="#Cell-947"><span class="linenos"> 947</span></a><span class="sd">        deriv: float</span>
</span><span id="Cell-948"><a href="#Cell-948"><span class="linenos"> 948</span></a><span class="sd">            Derivative of the relative density</span>
</span><span id="Cell-949"><a href="#Cell-949"><span class="linenos"> 949</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-950"><a href="#Cell-950"><span class="linenos"> 950</span></a>        <span class="n">deriv</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell-951"><a href="#Cell-951"><span class="linenos"> 951</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">polyDeriv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relative_density_poly_deriv</span><span class="p">):</span>
</span><span id="Cell-952"><a href="#Cell-952"><span class="linenos"> 952</span></a>            <span class="n">deriv</span> <span class="o">+=</span> <span class="n">polyDeriv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Cell-953"><a href="#Cell-953"><span class="linenos"> 953</span></a>        <span class="k">return</span> <span class="n">deriv</span>
</span><span id="Cell-954"><a href="#Cell-954"><span class="linenos"> 954</span></a>
</span><span id="Cell-955"><a href="#Cell-955"><span class="linenos"> 955</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell-956"><a href="#Cell-956"><span class="linenos"> 956</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-957"><a href="#Cell-957"><span class="linenos"> 957</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_gradient_kriging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Cell-958"><a href="#Cell-958"><span class="linenos"> 958</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-959"><a href="#Cell-959"><span class="linenos"> 959</span></a><span class="sd">        Finite difference gradient of the relative density (predictive mean) w.r.t. the radii using the trained</span>
</span><span id="Cell-960"><a href="#Cell-960"><span class="linenos"> 960</span></a><span class="sd">        Pipeline(StandardScaler -&gt; GaussianProcessRegressor) with Constant*RBF kernel.</span>
</span><span id="Cell-961"><a href="#Cell-961"><span class="linenos"> 961</span></a><span class="sd">        Returns an array of size len(geometries_types) where entries for geometries not present in the cell are 0.</span>
</span><span id="Cell-962"><a href="#Cell-962"><span class="linenos"> 962</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-963"><a href="#Cell-963"><span class="linenos"> 963</span></a>        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-3</span>
</span><span id="Cell-964"><a href="#Cell-964"><span class="linenos"> 964</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">))</span>
</span><span id="Cell-965"><a href="#Cell-965"><span class="linenos"> 965</span></a>
</span><span id="Cell-966"><a href="#Cell-966"><span class="linenos"> 966</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Cell-967"><a href="#Cell-967"><span class="linenos"> 967</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geometries_types</span><span class="p">:</span>
</span><span id="Cell-968"><a href="#Cell-968"><span class="linenos"> 968</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;geometry types in cell&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="s2">&quot; Not in the trained kriging model&quot;</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span>
</span><span id="Cell-969"><a href="#Cell-969"><span class="linenos"> 969</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible geometry types between the cell and the kriging model.&quot;</span><span class="p">)</span>
</span><span id="Cell-970"><a href="#Cell-970"><span class="linenos"> 970</span></a>            <span class="n">perturbed_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometries_types</span><span class="p">))</span>
</span><span id="Cell-971"><a href="#Cell-971"><span class="linenos"> 971</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometries_types</span><span class="p">))</span>
</span><span id="Cell-972"><a href="#Cell-972"><span class="linenos"> 972</span></a>            <span class="n">geom_index</span> <span class="o">=</span> <span class="n">geometries_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Cell-973"><a href="#Cell-973"><span class="linenos"> 973</span></a>            <span class="n">perturbed_radii</span><span class="p">[</span><span class="n">geom_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">+</span> <span class="n">epsilon</span>
</span><span id="Cell-974"><a href="#Cell-974"><span class="linenos"> 974</span></a>            <span class="n">radii</span><span class="p">[</span><span class="n">geom_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span>
</span><span id="Cell-975"><a href="#Cell-975"><span class="linenos"> 975</span></a>            <span class="n">grad</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">perturbed_radii</span><span class="p">])</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">radii</span><span class="p">]))</span> <span class="o">/</span> <span class="n">epsilon</span>
</span><span id="Cell-976"><a href="#Cell-976"><span class="linenos"> 976</span></a>        <span class="k">return</span> <span class="n">grad</span>
</span><span id="Cell-977"><a href="#Cell-977"><span class="linenos"> 977</span></a>
</span><span id="Cell-978"><a href="#Cell-978"><span class="linenos"> 978</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell-979"><a href="#Cell-979"><span class="linenos"> 979</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell-980"><a href="#Cell-980"><span class="linenos"> 980</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_gradient_kriging_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Cell-981"><a href="#Cell-981"><span class="linenos"> 981</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-982"><a href="#Cell-982"><span class="linenos"> 982</span></a><span class="sd">        Exact gradient of the relative density (predictive mean) w.r.t. the radii using the trained</span>
</span><span id="Cell-983"><a href="#Cell-983"><span class="linenos"> 983</span></a><span class="sd">        Pipeline(StandardScaler -&gt; GaussianProcessRegressor) with Constant*RBF kernel.</span>
</span><span id="Cell-984"><a href="#Cell-984"><span class="linenos"> 984</span></a>
</span><span id="Cell-985"><a href="#Cell-985"><span class="linenos"> 985</span></a><span class="sd">        Returns an array of size len(geometries_types) where entries for geometries not present in the cell are 0.</span>
</span><span id="Cell-986"><a href="#Cell-986"><span class="linenos"> 986</span></a>
</span><span id="Cell-987"><a href="#Cell-987"><span class="linenos"> 987</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell-988"><a href="#Cell-988"><span class="linenos"> 988</span></a><span class="sd">        -----------</span>
</span><span id="Cell-989"><a href="#Cell-989"><span class="linenos"> 989</span></a><span class="sd">        model: Pipeline</span>
</span><span id="Cell-990"><a href="#Cell-990"><span class="linenos"> 990</span></a><span class="sd">            Trained kriging model</span>
</span><span id="Cell-991"><a href="#Cell-991"><span class="linenos"> 991</span></a>
</span><span id="Cell-992"><a href="#Cell-992"><span class="linenos"> 992</span></a><span class="sd">        geometries_types: list</span>
</span><span id="Cell-993"><a href="#Cell-993"><span class="linenos"> 993</span></a><span class="sd">            List of geometry types in the trained kriging model</span>
</span><span id="Cell-994"><a href="#Cell-994"><span class="linenos"> 994</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-995"><a href="#Cell-995"><span class="linenos"> 995</span></a>        <span class="c1"># Build full input vector (one radius per geometry in &#39;geometries_types&#39;)</span>
</span><span id="Cell-996"><a href="#Cell-996"><span class="linenos"> 996</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometries_types</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Cell-997"><a href="#Cell-997"><span class="linenos"> 997</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Cell-998"><a href="#Cell-998"><span class="linenos"> 998</span></a>            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Cell-999"><a href="#Cell-999"><span class="linenos"> 999</span></a>            <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geometries_types</span><span class="p">:</span>
</span><span id="Cell-1000"><a href="#Cell-1000"><span class="linenos">1000</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;geometry types in cell&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="s2">&quot; not in the trained kriging model&quot;</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span>
</span><span id="Cell-1001"><a href="#Cell-1001"><span class="linenos">1001</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible geometry types between the cell and the kriging model.&quot;</span><span class="p">)</span>
</span><span id="Cell-1002"><a href="#Cell-1002"><span class="linenos">1002</span></a>            <span class="n">x</span><span class="p">[</span><span class="n">geometries_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
</span><span id="Cell-1003"><a href="#Cell-1003"><span class="linenos">1003</span></a>
</span><span id="Cell-1004"><a href="#Cell-1004"><span class="linenos">1004</span></a>        <span class="c1"># Exact gradient in original feature space</span>
</span><span id="Cell-1005"><a href="#Cell-1005"><span class="linenos">1005</span></a>        <span class="n">grad_full</span> <span class="o">=</span> <span class="n">gp_mean_gradient_rbf_pipeline</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># shape (len(geometries_types),)</span>
</span><span id="Cell-1006"><a href="#Cell-1006"><span class="linenos">1006</span></a>
</span><span id="Cell-1007"><a href="#Cell-1007"><span class="linenos">1007</span></a>        <span class="c1"># Reorder to match the cell&#39;s local parameter order (same as self.radii / self.geom_types)</span>
</span><span id="Cell-1008"><a href="#Cell-1008"><span class="linenos">1008</span></a>        <span class="n">grad_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Cell-1009"><a href="#Cell-1009"><span class="linenos">1009</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">):</span>
</span><span id="Cell-1010"><a href="#Cell-1010"><span class="linenos">1010</span></a>            <span class="n">grad_local</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">grad_full</span><span class="p">[</span><span class="n">geometries_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span>
</span><span id="Cell-1011"><a href="#Cell-1011"><span class="linenos">1011</span></a>
</span><span id="Cell-1012"><a href="#Cell-1012"><span class="linenos">1012</span></a>        <span class="k">return</span> <span class="n">grad_local</span>
</span><span id="Cell-1013"><a href="#Cell-1013"><span class="linenos">1013</span></a>
</span><span id="Cell-1014"><a href="#Cell-1014"><span class="linenos">1014</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-1015"><a href="#Cell-1015"><span class="linenos">1015</span></a><span class="c1"># SECTION: Utils Methods</span>
</span><span id="Cell-1016"><a href="#Cell-1016"><span class="linenos">1016</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-1017"><a href="#Cell-1017"><span class="linenos">1017</span></a>
</span><span id="Cell-1018"><a href="#Cell-1018"><span class="linenos">1018</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_RGBcolor_depending_of_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="Cell-1019"><a href="#Cell-1019"><span class="linenos">1019</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-1020"><a href="#Cell-1020"><span class="linenos">1020</span></a><span class="sd">        Get the RGB color of the cell depending on the radii.</span>
</span><span id="Cell-1021"><a href="#Cell-1021"><span class="linenos">1021</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-1022"><a href="#Cell-1022"><span class="linenos">1022</span></a>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="mf">0.1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span>
</span><span id="Cell-1023"><a href="#Cell-1023"><span class="linenos">1023</span></a>
</span><span id="Cell-1024"><a href="#Cell-1024"><span class="linenos">1024</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell-1025"><a href="#Cell-1025"><span class="linenos">1025</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-1026"><a href="#Cell-1026"><span class="linenos">1026</span></a><span class="sd">        Print the data of the cell for debugging purposes.</span>
</span><span id="Cell-1027"><a href="#Cell-1027"><span class="linenos">1027</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-1028"><a href="#Cell-1028"><span class="linenos">1028</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell position: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</span><span id="Cell-1029"><a href="#Cell-1029"><span class="linenos">1029</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell coordinates: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">)</span>
</span><span id="Cell-1030"><a href="#Cell-1030"><span class="linenos">1030</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell size: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="Cell-1031"><a href="#Cell-1031"><span class="linenos">1031</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lattice type_beam: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">)</span>
</span><span id="Cell-1032"><a href="#Cell-1032"><span class="linenos">1032</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beam radii: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span>
</span><span id="Cell-1033"><a href="#Cell-1033"><span class="linenos">1033</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beam material: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span><span class="p">)</span>
</span><span id="Cell-1034"><a href="#Cell-1034"><span class="linenos">1034</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;beams in cell: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="Cell-1035"><a href="#Cell-1035"><span class="linenos">1035</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell center point: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_point</span><span class="p">)</span>
</span><span id="Cell-1036"><a href="#Cell-1036"><span class="linenos">1036</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell index: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="Cell-1037"><a href="#Cell-1037"><span class="linenos">1037</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beam material: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span><span class="p">)</span>
</span><span id="Cell-1038"><a href="#Cell-1038"><span class="linenos">1038</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coupling matrix: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="p">)</span>
</span><span id="Cell-1039"><a href="#Cell-1039"><span class="linenos">1039</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of beams: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">))</span>
</span><span id="Cell-1040"><a href="#Cell-1040"><span class="linenos">1040</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Volume of the cell: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
</span><span id="Cell-1041"><a href="#Cell-1041"><span class="linenos">1041</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Relative density: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_density</span><span class="p">)</span>
</span><span id="Cell-1042"><a href="#Cell-1042"><span class="linenos">1042</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of nodes at boundary: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_nodes_at_boundary</span><span class="p">())</span>
</span><span id="Cell-1043"><a href="#Cell-1043"><span class="linenos">1043</span></a>
</span><span id="Cell-1044"><a href="#Cell-1044"><span class="linenos">1044</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-1045"><a href="#Cell-1045"><span class="linenos">1045</span></a><span class="c1"># SECTION: Unused Methods</span>
</span><span id="Cell-1046"><a href="#Cell-1046"><span class="linenos">1046</span></a><span class="c1"># =============================================================================</span>
</span><span id="Cell-1047"><a href="#Cell-1047"><span class="linenos">1047</span></a>
</span><span id="Cell-1048"><a href="#Cell-1048"><span class="linenos">1048</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_translation_rigid_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell-1049"><a href="#Cell-1049"><span class="linenos">1049</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-1050"><a href="#Cell-1050"><span class="linenos">1050</span></a><span class="sd">        Get the translation of the rigid body</span>
</span><span id="Cell-1051"><a href="#Cell-1051"><span class="linenos">1051</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-1052"><a href="#Cell-1052"><span class="linenos">1052</span></a>        <span class="n">translation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Cell-1053"><a href="#Cell-1053"><span class="linenos">1053</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell-1054"><a href="#Cell-1054"><span class="linenos">1054</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="Cell-1055"><a href="#Cell-1055"><span class="linenos">1055</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell-1056"><a href="#Cell-1056"><span class="linenos">1056</span></a>                    <span class="n">translation</span> <span class="o">+=</span> <span class="n">point</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Cell-1057"><a href="#Cell-1057"><span class="linenos">1057</span></a>        <span class="k">return</span> <span class="n">translation</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_nodes_at_boundary</span><span class="p">()</span>
</span><span id="Cell-1058"><a href="#Cell-1058"><span class="linenos">1058</span></a>
</span><span id="Cell-1059"><a href="#Cell-1059"><span class="linenos">1059</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rotation_rigid_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell-1060"><a href="#Cell-1060"><span class="linenos">1060</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell-1061"><a href="#Cell-1061"><span class="linenos">1061</span></a><span class="sd">        Get the rotation matrix of the rigid body using SVD.</span>
</span><span id="Cell-1062"><a href="#Cell-1062"><span class="linenos">1062</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell-1063"><a href="#Cell-1063"><span class="linenos">1063</span></a>        <span class="n">all_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span>
</span><span id="Cell-1064"><a href="#Cell-1064"><span class="linenos">1064</span></a>        <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">coordinates</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">all_points</span><span class="p">])</span>  <span class="c1"># P_i</span>
</span><span id="Cell-1065"><a href="#Cell-1065"><span class="linenos">1065</span></a>        <span class="n">final_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">deformed_coordinates</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">all_points</span><span class="p">])</span>  <span class="c1"># P_i&#39;</span>
</span><span id="Cell-1066"><a href="#Cell-1066"><span class="linenos">1066</span></a>
</span><span id="Cell-1067"><a href="#Cell-1067"><span class="linenos">1067</span></a>        <span class="c1"># Soustraction du centre de gravit</span>
</span><span id="Cell-1068"><a href="#Cell-1068"><span class="linenos">1068</span></a>        <span class="n">center_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Cell-1069"><a href="#Cell-1069"><span class="linenos">1069</span></a>        <span class="n">center_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">final_positions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Cell-1070"><a href="#Cell-1070"><span class="linenos">1070</span></a>        <span class="n">P</span> <span class="o">=</span> <span class="n">initial_positions</span> <span class="o">-</span> <span class="n">center_initial</span>
</span><span id="Cell-1071"><a href="#Cell-1071"><span class="linenos">1071</span></a>        <span class="n">P_prime</span> <span class="o">=</span> <span class="n">final_positions</span> <span class="o">-</span> <span class="n">center_final</span>
</span><span id="Cell-1072"><a href="#Cell-1072"><span class="linenos">1072</span></a>
</span><span id="Cell-1073"><a href="#Cell-1073"><span class="linenos">1073</span></a>        <span class="c1"># Matrice de covariance</span>
</span><span id="Cell-1074"><a href="#Cell-1074"><span class="linenos">1074</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_prime</span>
</span><span id="Cell-1075"><a href="#Cell-1075"><span class="linenos">1075</span></a>
</span><span id="Cell-1076"><a href="#Cell-1076"><span class="linenos">1076</span></a>        <span class="c1"># Dcomposition SVD</span>
</span><span id="Cell-1077"><a href="#Cell-1077"><span class="linenos">1077</span></a>        <span class="n">U</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
</span><span id="Cell-1078"><a href="#Cell-1078"><span class="linenos">1078</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
</span><span id="Cell-1079"><a href="#Cell-1079"><span class="linenos">1079</span></a>
</span><span id="Cell-1080"><a href="#Cell-1080"><span class="linenos">1080</span></a>        <span class="c1"># Correction si ncessaire (assurer que R est une rotation propre)</span>
</span><span id="Cell-1081"><a href="#Cell-1081"><span class="linenos">1081</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Cell-1082"><a href="#Cell-1082"><span class="linenos">1082</span></a>            <span class="n">Vt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Cell-1083"><a href="#Cell-1083"><span class="linenos">1083</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
</span><span id="Cell-1084"><a href="#Cell-1084"><span class="linenos">1084</span></a>
</span><span id="Cell-1085"><a href="#Cell-1085"><span class="linenos">1085</span></a>        <span class="k">return</span> <span class="n">R</span>
</span></pre></div>


            <div class="docstring"><p>Class representing a cell in the lattice structure.</p>
</div>


                            <div id="Cell.__init__" class="classattr">
                                        <input id="Cell.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Cell</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">pos</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">initial_size</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">coordinate</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">geom_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>,</span><span class="param">	<span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">grad_radius</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">grad_dim</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">grad_mat</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">uncertainty_node</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Cell.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.__init__-26"><a href="#Cell.__init__-26"><span class="linenos"> 26</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">geom_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="Cell.__init__-27"><a href="#Cell.__init__-27"><span class="linenos"> 27</span></a>                 <span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">grad_radius</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">grad_dim</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">grad_mat</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Cell.__init__-28"><a href="#Cell.__init__-28"><span class="linenos"> 28</span></a>                 <span class="n">uncertainty_node</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Cell.__init__-29"><a href="#Cell.__init__-29"><span class="linenos"> 29</span></a>                 <span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.__init__-30"><a href="#Cell.__init__-30"><span class="linenos"> 30</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.__init__-31"><a href="#Cell.__init__-31"><span class="linenos"> 31</span></a><span class="sd">        Initialize a Cell with its dimensions and position</span>
</span><span id="Cell.__init__-32"><a href="#Cell.__init__-32"><span class="linenos"> 32</span></a>
</span><span id="Cell.__init__-33"><a href="#Cell.__init__-33"><span class="linenos"> 33</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.__init__-34"><a href="#Cell.__init__-34"><span class="linenos"> 34</span></a><span class="sd">        -----------</span>
</span><span id="Cell.__init__-35"><a href="#Cell.__init__-35"><span class="linenos"> 35</span></a><span class="sd">        pos: list</span>
</span><span id="Cell.__init__-36"><a href="#Cell.__init__-36"><span class="linenos"> 36</span></a><span class="sd">            Position of the cell in the lattice</span>
</span><span id="Cell.__init__-37"><a href="#Cell.__init__-37"><span class="linenos"> 37</span></a>
</span><span id="Cell.__init__-38"><a href="#Cell.__init__-38"><span class="linenos"> 38</span></a><span class="sd">        initial_cell_size: list</span>
</span><span id="Cell.__init__-39"><a href="#Cell.__init__-39"><span class="linenos"> 39</span></a><span class="sd">            Initial size of the cell</span>
</span><span id="Cell.__init__-40"><a href="#Cell.__init__-40"><span class="linenos"> 40</span></a>
</span><span id="Cell.__init__-41"><a href="#Cell.__init__-41"><span class="linenos"> 41</span></a><span class="sd">        coordinate: list</span>
</span><span id="Cell.__init__-42"><a href="#Cell.__init__-42"><span class="linenos"> 42</span></a><span class="sd">            Coordinates of the cell minimum corner in the lattice</span>
</span><span id="Cell.__init__-43"><a href="#Cell.__init__-43"><span class="linenos"> 43</span></a>
</span><span id="Cell.__init__-44"><a href="#Cell.__init__-44"><span class="linenos"> 44</span></a><span class="sd">        geom_types: list[str]</span>
</span><span id="Cell.__init__-45"><a href="#Cell.__init__-45"><span class="linenos"> 45</span></a><span class="sd">            Type of lattice geometry</span>
</span><span id="Cell.__init__-46"><a href="#Cell.__init__-46"><span class="linenos"> 46</span></a>
</span><span id="Cell.__init__-47"><a href="#Cell.__init__-47"><span class="linenos"> 47</span></a><span class="sd">        radii: float</span>
</span><span id="Cell.__init__-48"><a href="#Cell.__init__-48"><span class="linenos"> 48</span></a><span class="sd">            Base radii of the beam</span>
</span><span id="Cell.__init__-49"><a href="#Cell.__init__-49"><span class="linenos"> 49</span></a>
</span><span id="Cell.__init__-50"><a href="#Cell.__init__-50"><span class="linenos"> 50</span></a><span class="sd">        grad_radius: list</span>
</span><span id="Cell.__init__-51"><a href="#Cell.__init__-51"><span class="linenos"> 51</span></a><span class="sd">            Gradient of the radii</span>
</span><span id="Cell.__init__-52"><a href="#Cell.__init__-52"><span class="linenos"> 52</span></a>
</span><span id="Cell.__init__-53"><a href="#Cell.__init__-53"><span class="linenos"> 53</span></a><span class="sd">        grad_dim: list</span>
</span><span id="Cell.__init__-54"><a href="#Cell.__init__-54"><span class="linenos"> 54</span></a><span class="sd">            Gradient of the dimensions</span>
</span><span id="Cell.__init__-55"><a href="#Cell.__init__-55"><span class="linenos"> 55</span></a>
</span><span id="Cell.__init__-56"><a href="#Cell.__init__-56"><span class="linenos"> 56</span></a><span class="sd">        grad_mat: list</span>
</span><span id="Cell.__init__-57"><a href="#Cell.__init__-57"><span class="linenos"> 57</span></a><span class="sd">            Gradient of the material</span>
</span><span id="Cell.__init__-58"><a href="#Cell.__init__-58"><span class="linenos"> 58</span></a>
</span><span id="Cell.__init__-59"><a href="#Cell.__init__-59"><span class="linenos"> 59</span></a><span class="sd">        uncertainty_node: float</span>
</span><span id="Cell.__init__-60"><a href="#Cell.__init__-60"><span class="linenos"> 60</span></a><span class="sd">            Standard deviation for adding uncertainty to node coordinates. Defaults to 0.0.</span>
</span><span id="Cell.__init__-61"><a href="#Cell.__init__-61"><span class="linenos"> 61</span></a>
</span><span id="Cell.__init__-62"><a href="#Cell.__init__-62"><span class="linenos"> 62</span></a><span class="sd">        _verbose: bool</span>
</span><span id="Cell.__init__-63"><a href="#Cell.__init__-63"><span class="linenos"> 63</span></a><span class="sd">            If True, prints additional information during initialization. Defaults to False.</span>
</span><span id="Cell.__init__-64"><a href="#Cell.__init__-64"><span class="linenos"> 64</span></a>
</span><span id="Cell.__init__-65"><a href="#Cell.__init__-65"><span class="linenos"> 65</span></a><span class="sd">        beams_already_defined: set</span>
</span><span id="Cell.__init__-66"><a href="#Cell.__init__-66"><span class="linenos"> 66</span></a><span class="sd">            Set of beams already defined in the lattice to avoid duplication. Defaults to None.</span>
</span><span id="Cell.__init__-67"><a href="#Cell.__init__-67"><span class="linenos"> 67</span></a>
</span><span id="Cell.__init__-68"><a href="#Cell.__init__-68"><span class="linenos"> 68</span></a><span class="sd">        nodes_already_defined: set</span>
</span><span id="Cell.__init__-69"><a href="#Cell.__init__-69"><span class="linenos"> 69</span></a><span class="sd">            Set of nodes already defined in the lattice to avoid duplication. Defaults to None.</span>
</span><span id="Cell.__init__-70"><a href="#Cell.__init__-70"><span class="linenos"> 70</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.__init__-71"><a href="#Cell.__init__-71"><span class="linenos"> 71</span></a>
</span><span id="Cell.__init__-72"><a href="#Cell.__init__-72"><span class="linenos"> 72</span></a>        <span class="n">_validate_inputs_cell</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">geom_types</span><span class="p">,</span>
</span><span id="Cell.__init__-73"><a href="#Cell.__init__-73"><span class="linenos"> 73</span></a>                         <span class="n">radii</span><span class="p">,</span> <span class="n">grad_radius</span><span class="p">,</span> <span class="n">grad_dim</span><span class="p">,</span> <span class="n">grad_mat</span><span class="p">,</span>
</span><span id="Cell.__init__-74"><a href="#Cell.__init__-74"><span class="linenos"> 74</span></a>                         <span class="n">uncertainty_node</span><span class="p">,</span> <span class="n">_verbose</span><span class="p">)</span>
</span><span id="Cell.__init__-75"><a href="#Cell.__init__-75"><span class="linenos"> 75</span></a>
</span><span id="Cell.__init__-76"><a href="#Cell.__init__-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_cell_geom</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.__init__-77"><a href="#Cell.__init__-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.__init__-78"><a href="#Cell.__init__-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_point</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.__init__-79"><a href="#Cell.__init__-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.__init__-80"><a href="#Cell.__init__-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.__init__-81"><a href="#Cell.__init__-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="Cell.__init__-82"><a href="#Cell.__init__-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinate</span>
</span><span id="Cell.__init__-83"><a href="#Cell.__init__-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Set of beams in the cell</span>
</span><span id="Cell.__init__-84"><a href="#Cell.__init__-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Set of points in the cell</span>
</span><span id="Cell.__init__-85"><a href="#Cell.__init__-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.__init__-86"><a href="#Cell.__init__-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">geom_types</span>
</span><span id="Cell.__init__-87"><a href="#Cell.__init__-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">radii</span>
</span><span id="Cell.__init__-88"><a href="#Cell.__init__-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># B matrix (Coupling matrix)</span>
</span><span id="Cell.__init__-89"><a href="#Cell.__init__-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">uncertainty_node</span>
</span><span id="Cell.__init__-90"><a href="#Cell.__init__-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">grad_radius</span>
</span><span id="Cell.__init__-91"><a href="#Cell.__init__-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">grad_mat</span>
</span><span id="Cell.__init__-92"><a href="#Cell.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">grad_dim</span>
</span><span id="Cell.__init__-93"><a href="#Cell.__init__-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_verbose</span>
</span><span id="Cell.__init__-94"><a href="#Cell.__init__-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Cell.__init__-95"><a href="#Cell.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.__init__-96"><a href="#Cell.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schur_complement_gradient</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.__init__-97"><a href="#Cell.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.__init__-98"><a href="#Cell.__init__-98"><span class="linenos"> 98</span></a>
</span><span id="Cell.__init__-99"><a href="#Cell.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_cell_properties</span><span class="p">(</span><span class="n">initial_size</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">)</span>
</span><span id="Cell.__init__-100"><a href="#Cell.__init__-100"><span class="linenos">100</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_density</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Cell.__init__-101"><a href="#Cell.__init__-101"><span class="linenos">101</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s2">&quot;WARNING: Approximated relative density of the cell is greater than 1. &quot;</span>
</span><span id="Cell.__init__-102"><a href="#Cell.__init__-102"><span class="linenos">102</span></a>                                <span class="s2">&quot;Beam radius and cell size is probably not well defined&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize a Cell with its dimensions and position</p>

<h2 id="parameters">Parameters:</h2>

<p>pos: list
    Position of the cell in the lattice</p>

<p>initial_cell_size: list
    Initial size of the cell</p>

<p>coordinate: list
    Coordinates of the cell minimum corner in the lattice</p>

<p>geom_types: list[str]
    Type of lattice geometry</p>

<p>radii: float
    Base radii of the beam</p>

<p>grad_radius: list
    Gradient of the radii</p>

<p>grad_dim: list
    Gradient of the dimensions</p>

<p>grad_mat: list
    Gradient of the material</p>

<p>uncertainty_node: float
    Standard deviation for adding uncertainty to node coordinates. Defaults to 0.0.</p>

<p>_verbose: bool
    If True, prints additional information during initialization. Defaults to False.</p>

<p>beams_already_defined: set
    Set of beams already defined in the lattice to avoid duplication. Defaults to None.</p>

<p>nodes_already_defined: set
    Set of nodes already defined in the lattice to avoid duplication. Defaults to None.</p>
</div>


                            </div>
                            <div id="Cell.original_cell_geom" class="classattr">
                                <div class="attr variable">
            <span class="name">original_cell_geom</span>

        
    </div>
    <a class="headerlink" href="#Cell.original_cell_geom"></a>
    
    

                            </div>
                            <div id="Cell.original_tags" class="classattr">
                                <div class="attr variable">
            <span class="name">original_tags</span>

        
    </div>
    <a class="headerlink" href="#Cell.original_tags"></a>
    
    

                            </div>
                            <div id="Cell.center_point" class="classattr">
                                <div class="attr variable">
            <span class="name">center_point</span>

        
    </div>
    <a class="headerlink" href="#Cell.center_point"></a>
    
    

                            </div>
                            <div id="Cell.beam_material" class="classattr">
                                <div class="attr variable">
            <span class="name">beam_material</span>

        
    </div>
    <a class="headerlink" href="#Cell.beam_material"></a>
    
    

                            </div>
                            <div id="Cell.size" class="classattr">
                                <div class="attr variable">
            <span class="name">size</span>

        
    </div>
    <a class="headerlink" href="#Cell.size"></a>
    
    

                            </div>
                            <div id="Cell.pos" class="classattr">
                                <div class="attr variable">
            <span class="name">pos</span><span class="annotation">: list[int]</span>

        
    </div>
    <a class="headerlink" href="#Cell.pos"></a>
    
    

                            </div>
                            <div id="Cell.coordinate" class="classattr">
                                <div class="attr variable">
            <span class="name">coordinate</span><span class="annotation">: list[float]</span>

        
    </div>
    <a class="headerlink" href="#Cell.coordinate"></a>
    
    

                            </div>
                            <div id="Cell.beams_cell" class="classattr">
                                <div class="attr variable">
            <span class="name">beams_cell</span><span class="annotation">: Optional[set]</span>

        
    </div>
    <a class="headerlink" href="#Cell.beams_cell"></a>
    
    

                            </div>
                            <div id="Cell.points_cell" class="classattr">
                                <div class="attr variable">
            <span class="name">points_cell</span><span class="annotation">: Optional[set]</span>

        
    </div>
    <a class="headerlink" href="#Cell.points_cell"></a>
    
    

                            </div>
                            <div id="Cell.index" class="classattr">
                                <div class="attr variable">
            <span class="name">index</span><span class="annotation">: Optional[int]</span>

        
    </div>
    <a class="headerlink" href="#Cell.index"></a>
    
    

                            </div>
                            <div id="Cell.geom_types" class="classattr">
                                <div class="attr variable">
            <span class="name">geom_types</span><span class="annotation">: list[str]</span>

        
    </div>
    <a class="headerlink" href="#Cell.geom_types"></a>
    
    

                            </div>
                            <div id="Cell.radii" class="classattr">
                                <div class="attr variable">
            <span class="name">radii</span><span class="annotation">: list[float]</span>

        
    </div>
    <a class="headerlink" href="#Cell.radii"></a>
    
    

                            </div>
                            <div id="Cell.coupling_matrix_B" class="classattr">
                                <div class="attr variable">
            <span class="name">coupling_matrix_B</span><span class="annotation">: Optional</span>

        
    </div>
    <a class="headerlink" href="#Cell.coupling_matrix_B"></a>
    
    

                            </div>
                            <div id="Cell.uncertainty_node" class="classattr">
                                <div class="attr variable">
            <span class="name">uncertainty_node</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Cell.uncertainty_node"></a>
    
    

                            </div>
                            <div id="Cell.grad_radius" class="classattr">
                                <div class="attr variable">
            <span class="name">grad_radius</span><span class="annotation">: list</span>

        
    </div>
    <a class="headerlink" href="#Cell.grad_radius"></a>
    
    

                            </div>
                            <div id="Cell.grad_mat" class="classattr">
                                <div class="attr variable">
            <span class="name">grad_mat</span><span class="annotation">: list</span>

        
    </div>
    <a class="headerlink" href="#Cell.grad_mat"></a>
    
    

                            </div>
                            <div id="Cell.grad_dim" class="classattr">
                                <div class="attr variable">
            <span class="name">grad_dim</span><span class="annotation">: list</span>

        
    </div>
    <a class="headerlink" href="#Cell.grad_dim"></a>
    
    

                            </div>
                            <div id="Cell.neighbour_cells" class="classattr">
                                <div class="attr variable">
            <span class="name">neighbour_cells</span><span class="annotation">: dict</span>

        
    </div>
    <a class="headerlink" href="#Cell.neighbour_cells"></a>
    
    

                            </div>
                            <div id="Cell.schur_complement" class="classattr">
                                <div class="attr variable">
            <span class="name">schur_complement</span><span class="annotation">: list[list[float]]</span>

        
    </div>
    <a class="headerlink" href="#Cell.schur_complement"></a>
    
    

                            </div>
                            <div id="Cell.schur_complement_gradient" class="classattr">
                                <div class="attr variable">
            <span class="name">schur_complement_gradient</span><span class="annotation">: list[list[float]]</span>

        
    </div>
    <a class="headerlink" href="#Cell.schur_complement_gradient"></a>
    
    

                            </div>
                            <div id="Cell.node_in_order_simulation" class="classattr">
                                <div class="attr variable">
            <span class="name">node_in_order_simulation</span><span class="annotation">: Optional[List[<a href="point.html#Point">pyLattice.point.Point</a>]]</span>

        
    </div>
    <a class="headerlink" href="#Cell.node_in_order_simulation"></a>
    
    

                            </div>
                            <div id="Cell.dispose" class="classattr">
                                        <input id="Cell.dispose-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dispose</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.dispose-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.dispose"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.dispose-114"><a href="#Cell.dispose-114"><span class="linenos">114</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.dispose-115"><a href="#Cell.dispose-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.dispose-116"><a href="#Cell.dispose-116"><span class="linenos">116</span></a><span class="sd">        Dispose of the cell by detaching beams and points, and cleaning up references.</span>
</span><span id="Cell.dispose-117"><a href="#Cell.dispose-117"><span class="linenos">117</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.dispose-118"><a href="#Cell.dispose-118"><span class="linenos">118</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Cell.dispose-119"><a href="#Cell.dispose-119"><span class="linenos">119</span></a>            <span class="n">beams</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Cell.dispose-120"><a href="#Cell.dispose-120"><span class="linenos">120</span></a>            <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Cell.dispose-121"><a href="#Cell.dispose-121"><span class="linenos">121</span></a>
</span><span id="Cell.dispose-122"><a href="#Cell.dispose-122"><span class="linenos">122</span></a>            <span class="c1"># Detach the beams</span>
</span><span id="Cell.dispose-123"><a href="#Cell.dispose-123"><span class="linenos">123</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
</span><span id="Cell.dispose-124"><a href="#Cell.dispose-124"><span class="linenos">124</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Cell.dispose-125"><a href="#Cell.dispose-125"><span class="linenos">125</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">cell_belongings</span><span class="p">:</span>
</span><span id="Cell.dispose-126"><a href="#Cell.dispose-126"><span class="linenos">126</span></a>                        <span class="n">b</span><span class="o">.</span><span class="n">cell_belongings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell.dispose-127"><a href="#Cell.dispose-127"><span class="linenos">127</span></a>                    <span class="c1"># If the beam no longer belongs to any cell, we prudently purge its links</span>
</span><span id="Cell.dispose-128"><a href="#Cell.dispose-128"><span class="linenos">128</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Cell.dispose-129"><a href="#Cell.dispose-129"><span class="linenos">129</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;delete_beam&quot;</span><span class="p">):</span>
</span><span id="Cell.dispose-130"><a href="#Cell.dispose-130"><span class="linenos">130</span></a>                            <span class="n">b</span><span class="o">.</span><span class="n">delete_beam</span><span class="p">()</span>
</span><span id="Cell.dispose-131"><a href="#Cell.dispose-131"><span class="linenos">131</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell.dispose-132"><a href="#Cell.dispose-132"><span class="linenos">132</span></a>                    <span class="k">pass</span>
</span><span id="Cell.dispose-133"><a href="#Cell.dispose-133"><span class="linenos">133</span></a>
</span><span id="Cell.dispose-134"><a href="#Cell.dispose-134"><span class="linenos">134</span></a>            <span class="c1"># Detach the points</span>
</span><span id="Cell.dispose-135"><a href="#Cell.dispose-135"><span class="linenos">135</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
</span><span id="Cell.dispose-136"><a href="#Cell.dispose-136"><span class="linenos">136</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Cell.dispose-137"><a href="#Cell.dispose-137"><span class="linenos">137</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">cell_belongings</span><span class="p">:</span>
</span><span id="Cell.dispose-138"><a href="#Cell.dispose-138"><span class="linenos">138</span></a>                        <span class="n">p</span><span class="o">.</span><span class="n">cell_belongings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell.dispose-139"><a href="#Cell.dispose-139"><span class="linenos">139</span></a>                    <span class="c1"># If the point no longer belongs to any cell, we prudently purge its links</span>
</span><span id="Cell.dispose-140"><a href="#Cell.dispose-140"><span class="linenos">140</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Cell.dispose-141"><a href="#Cell.dispose-141"><span class="linenos">141</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">):</span>
</span><span id="Cell.dispose-142"><a href="#Cell.dispose-142"><span class="linenos">142</span></a>                            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">)):</span>
</span><span id="Cell.dispose-143"><a href="#Cell.dispose-143"><span class="linenos">143</span></a>                                <span class="k">try</span><span class="p">:</span>
</span><span id="Cell.dispose-144"><a href="#Cell.dispose-144"><span class="linenos">144</span></a>                                    <span class="c1"># Remove the beam from the point&#39;s connected beams</span>
</span><span id="Cell.dispose-145"><a href="#Cell.dispose-145"><span class="linenos">145</span></a>                                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Cell.dispose-146"><a href="#Cell.dispose-146"><span class="linenos">146</span></a>                                        <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="Cell.dispose-147"><a href="#Cell.dispose-147"><span class="linenos">147</span></a>                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell.dispose-148"><a href="#Cell.dispose-148"><span class="linenos">148</span></a>                                    <span class="k">pass</span>
</span><span id="Cell.dispose-149"><a href="#Cell.dispose-149"><span class="linenos">149</span></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell.dispose-150"><a href="#Cell.dispose-150"><span class="linenos">150</span></a>                    <span class="k">pass</span>
</span><span id="Cell.dispose-151"><a href="#Cell.dispose-151"><span class="linenos">151</span></a>
</span><span id="Cell.dispose-152"><a href="#Cell.dispose-152"><span class="linenos">152</span></a>            <span class="c1"># Clear the sets</span>
</span><span id="Cell.dispose-153"><a href="#Cell.dispose-153"><span class="linenos">153</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Cell.dispose-154"><a href="#Cell.dispose-154"><span class="linenos">154</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Cell.dispose-155"><a href="#Cell.dispose-155"><span class="linenos">155</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell.dispose-156"><a href="#Cell.dispose-156"><span class="linenos">156</span></a>                <span class="k">pass</span>
</span><span id="Cell.dispose-157"><a href="#Cell.dispose-157"><span class="linenos">157</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Cell.dispose-158"><a href="#Cell.dispose-158"><span class="linenos">158</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Cell.dispose-159"><a href="#Cell.dispose-159"><span class="linenos">159</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell.dispose-160"><a href="#Cell.dispose-160"><span class="linenos">160</span></a>                <span class="k">pass</span>
</span><span id="Cell.dispose-161"><a href="#Cell.dispose-161"><span class="linenos">161</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Cell.dispose-162"><a href="#Cell.dispose-162"><span class="linenos">162</span></a>            <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Dispose of the cell by detaching beams and points, and cleaning up references.</p>
</div>


                            </div>
                            <div id="Cell.volume" class="classattr">
                                        <input id="Cell.volume-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">volume</span>

                <label class="view-source-button" for="Cell.volume-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.volume"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.volume-164"><a href="#Cell.volume-164"><span class="linenos">164</span></a>    <span class="nd">@property</span>
</span><span id="Cell.volume-165"><a href="#Cell.volume-165"><span class="linenos">165</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell.volume-166"><a href="#Cell.volume-166"><span class="linenos">166</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Calculate the volume of the cell.&quot;&quot;&quot;</span>
</span><span id="Cell.volume-167"><a href="#Cell.volume-167"><span class="linenos">167</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the volume of the cell.</p>
</div>


                            </div>
                            <div id="Cell.relative_density" class="classattr">
                                        <input id="Cell.relative_density-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">relative_density</span><span class="annotation">: float</span>

                <label class="view-source-button" for="Cell.relative_density-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.relative_density"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.relative_density-169"><a href="#Cell.relative_density-169"><span class="linenos">169</span></a>    <span class="nd">@property</span>
</span><span id="Cell.relative_density-170"><a href="#Cell.relative_density-170"><span class="linenos">170</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relative_density</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell.relative_density-171"><a href="#Cell.relative_density-171"><span class="linenos">171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.relative_density-172"><a href="#Cell.relative_density-172"><span class="linenos">172</span></a><span class="sd">        Calculate the relative density of the cell based on the volume of beams and the cell volume.</span>
</span><span id="Cell.relative_density-173"><a href="#Cell.relative_density-173"><span class="linenos">173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.relative_density-174"><a href="#Cell.relative_density-174"><span class="linenos">174</span></a>        <span class="n">volumeBeams</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell.relative_density-175"><a href="#Cell.relative_density-175"><span class="linenos">175</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell.relative_density-176"><a href="#Cell.relative_density-176"><span class="linenos">176</span></a>            <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="Cell.relative_density-177"><a href="#Cell.relative_density-177"><span class="linenos">177</span></a>                <span class="n">volumeBeams</span> <span class="o">+=</span> <span class="n">beam</span><span class="o">.</span><span class="n">volume</span>
</span><span id="Cell.relative_density-178"><a href="#Cell.relative_density-178"><span class="linenos">178</span></a>        <span class="k">return</span> <span class="n">volumeBeams</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the relative density of the cell based on the volume of beams and the cell volume.</p>
</div>


                            </div>
                            <div id="Cell.volume_each_geom" class="classattr">
                                        <input id="Cell.volume_each_geom-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">volume_each_geom</span><span class="annotation">: numpy.ndarray</span>

                <label class="view-source-button" for="Cell.volume_each_geom-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.volume_each_geom"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.volume_each_geom-180"><a href="#Cell.volume_each_geom-180"><span class="linenos">180</span></a>    <span class="nd">@property</span>
</span><span id="Cell.volume_each_geom-181"><a href="#Cell.volume_each_geom-181"><span class="linenos">181</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">volume_each_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Cell.volume_each_geom-182"><a href="#Cell.volume_each_geom-182"><span class="linenos">182</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.volume_each_geom-183"><a href="#Cell.volume_each_geom-183"><span class="linenos">183</span></a><span class="sd">        Get the volume of the cell separated by geometry type_beam.</span>
</span><span id="Cell.volume_each_geom-184"><a href="#Cell.volume_each_geom-184"><span class="linenos">184</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.volume_each_geom-185"><a href="#Cell.volume_each_geom-185"><span class="linenos">185</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">))</span>
</span><span id="Cell.volume_each_geom-186"><a href="#Cell.volume_each_geom-186"><span class="linenos">186</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell.volume_each_geom-187"><a href="#Cell.volume_each_geom-187"><span class="linenos">187</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span><span class="p">:</span>
</span><span id="Cell.volume_each_geom-188"><a href="#Cell.volume_each_geom-188"><span class="linenos">188</span></a>                <span class="n">volumeBeam</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">volume</span>
</span><span id="Cell.volume_each_geom-189"><a href="#Cell.volume_each_geom-189"><span class="linenos">189</span></a>                <span class="n">volumes</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">]</span> <span class="o">+=</span> <span class="n">volumeBeam</span>
</span><span id="Cell.volume_each_geom-190"><a href="#Cell.volume_each_geom-190"><span class="linenos">190</span></a>        <span class="k">return</span> <span class="n">volumes</span>
</span></pre></div>


            <div class="docstring"><p>Get the volume of the cell separated by geometry type_beam.</p>
</div>


                            </div>
                            <div id="Cell.boundary_box" class="classattr">
                                        <input id="Cell.boundary_box-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">boundary_box</span><span class="annotation">: list</span>

                <label class="view-source-button" for="Cell.boundary_box-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.boundary_box"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.boundary_box-192"><a href="#Cell.boundary_box-192"><span class="linenos">192</span></a>    <span class="nd">@property</span>
</span><span id="Cell.boundary_box-193"><a href="#Cell.boundary_box-193"><span class="linenos">193</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell.boundary_box-194"><a href="#Cell.boundary_box-194"><span class="linenos">194</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.boundary_box-195"><a href="#Cell.boundary_box-195"><span class="linenos">195</span></a><span class="sd">        Get the boundary box of the cell</span>
</span><span id="Cell.boundary_box-196"><a href="#Cell.boundary_box-196"><span class="linenos">196</span></a>
</span><span id="Cell.boundary_box-197"><a href="#Cell.boundary_box-197"><span class="linenos">197</span></a><span class="sd">        Returns:</span>
</span><span id="Cell.boundary_box-198"><a href="#Cell.boundary_box-198"><span class="linenos">198</span></a><span class="sd">        --------</span>
</span><span id="Cell.boundary_box-199"><a href="#Cell.boundary_box-199"><span class="linenos">199</span></a><span class="sd">        list</span>
</span><span id="Cell.boundary_box-200"><a href="#Cell.boundary_box-200"><span class="linenos">200</span></a><span class="sd">            List of the boundary box coordinates</span>
</span><span id="Cell.boundary_box-201"><a href="#Cell.boundary_box-201"><span class="linenos">201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.boundary_box-202"><a href="#Cell.boundary_box-202"><span class="linenos">202</span></a>        <span class="n">xMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell.boundary_box-203"><a href="#Cell.boundary_box-203"><span class="linenos">203</span></a>        <span class="n">xMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell.boundary_box-204"><a href="#Cell.boundary_box-204"><span class="linenos">204</span></a>        <span class="n">yMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Cell.boundary_box-205"><a href="#Cell.boundary_box-205"><span class="linenos">205</span></a>        <span class="n">yMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Cell.boundary_box-206"><a href="#Cell.boundary_box-206"><span class="linenos">206</span></a>        <span class="n">zMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell.boundary_box-207"><a href="#Cell.boundary_box-207"><span class="linenos">207</span></a>        <span class="n">zMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell.boundary_box-208"><a href="#Cell.boundary_box-208"><span class="linenos">208</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">xMin</span><span class="p">,</span> <span class="n">xMax</span><span class="p">,</span> <span class="n">yMin</span><span class="p">,</span> <span class="n">yMax</span><span class="p">,</span> <span class="n">zMin</span><span class="p">,</span> <span class="n">zMax</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Get the boundary box of the cell</p>

<h2 id="returns">Returns:</h2>

<p>list
    List of the boundary box coordinates</p>
</div>


                            </div>
                            <div id="Cell.boundary_edges" class="classattr">
                                        <input id="Cell.boundary_edges-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">boundary_edges</span><span class="annotation">: list[tuple[tuple[float, float, float], tuple[float, float, float]]]</span>

                <label class="view-source-button" for="Cell.boundary_edges-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.boundary_edges"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.boundary_edges-210"><a href="#Cell.boundary_edges-210"><span class="linenos">210</span></a>    <span class="nd">@property</span>
</span><span id="Cell.boundary_edges-211"><a href="#Cell.boundary_edges-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">boundary_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
</span><span id="Cell.boundary_edges-212"><a href="#Cell.boundary_edges-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.boundary_edges-213"><a href="#Cell.boundary_edges-213"><span class="linenos">213</span></a><span class="sd">        Return the 12 edge segments of the cell&#39;s axis-aligned bounding box</span>
</span><span id="Cell.boundary_edges-214"><a href="#Cell.boundary_edges-214"><span class="linenos">214</span></a><span class="sd">        as pairs of 3D points ((x,y,z), (x,y,z)).</span>
</span><span id="Cell.boundary_edges-215"><a href="#Cell.boundary_edges-215"><span class="linenos">215</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.boundary_edges-216"><a href="#Cell.boundary_edges-216"><span class="linenos">216</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="Cell.boundary_edges-217"><a href="#Cell.boundary_edges-217"><span class="linenos">217</span></a>        <span class="c1"># 8 vertices</span>
</span><span id="Cell.boundary_edges-218"><a href="#Cell.boundary_edges-218"><span class="linenos">218</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Cell.boundary_edges-219"><a href="#Cell.boundary_edges-219"><span class="linenos">219</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell.boundary_edges-220"><a href="#Cell.boundary_edges-220"><span class="linenos">220</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">),</span>
</span><span id="Cell.boundary_edges-221"><a href="#Cell.boundary_edges-221"><span class="linenos">221</span></a>        <span class="p">]</span>
</span><span id="Cell.boundary_edges-222"><a href="#Cell.boundary_edges-222"><span class="linenos">222</span></a>        <span class="c1"># 12 edges (by vertex indices)</span>
</span><span id="Cell.boundary_edges-223"><a href="#Cell.boundary_edges-223"><span class="linenos">223</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Cell.boundary_edges-224"><a href="#Cell.boundary_edges-224"><span class="linenos">224</span></a>            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># bottom rectangle</span>
</span><span id="Cell.boundary_edges-225"><a href="#Cell.boundary_edges-225"><span class="linenos">225</span></a>            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="c1"># top rectangle</span>
</span><span id="Cell.boundary_edges-226"><a href="#Cell.boundary_edges-226"><span class="linenos">226</span></a>            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>  <span class="c1"># vertical edges</span>
</span><span id="Cell.boundary_edges-227"><a href="#Cell.boundary_edges-227"><span class="linenos">227</span></a>        <span class="p">]</span>
</span><span id="Cell.boundary_edges-228"><a href="#Cell.boundary_edges-228"><span class="linenos">228</span></a>        <span class="k">return</span> <span class="p">[(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Return the 12 edge segments of the cell's axis-aligned bounding box
as pairs of 3D points ((x,y,z), (x,y,z)).</p>
</div>


                            </div>
                            <div id="Cell.corner_coordinates" class="classattr">
                                        <input id="Cell.corner_coordinates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">corner_coordinates</span><span class="annotation">: list</span>

                <label class="view-source-button" for="Cell.corner_coordinates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.corner_coordinates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.corner_coordinates-230"><a href="#Cell.corner_coordinates-230"><span class="linenos">230</span></a>    <span class="nd">@property</span>
</span><span id="Cell.corner_coordinates-231"><a href="#Cell.corner_coordinates-231"><span class="linenos">231</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">corner_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell.corner_coordinates-232"><a href="#Cell.corner_coordinates-232"><span class="linenos">232</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.corner_coordinates-233"><a href="#Cell.corner_coordinates-233"><span class="linenos">233</span></a><span class="sd">        Get the corner coordinates of the cell.</span>
</span><span id="Cell.corner_coordinates-234"><a href="#Cell.corner_coordinates-234"><span class="linenos">234</span></a>
</span><span id="Cell.corner_coordinates-235"><a href="#Cell.corner_coordinates-235"><span class="linenos">235</span></a><span class="sd">        Returns:</span>
</span><span id="Cell.corner_coordinates-236"><a href="#Cell.corner_coordinates-236"><span class="linenos">236</span></a><span class="sd">        --------</span>
</span><span id="Cell.corner_coordinates-237"><a href="#Cell.corner_coordinates-237"><span class="linenos">237</span></a><span class="sd">        list of tuples</span>
</span><span id="Cell.corner_coordinates-238"><a href="#Cell.corner_coordinates-238"><span class="linenos">238</span></a><span class="sd">            List of (x, y, z) coordinates of the corner points.</span>
</span><span id="Cell.corner_coordinates-239"><a href="#Cell.corner_coordinates-239"><span class="linenos">239</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.corner_coordinates-240"><a href="#Cell.corner_coordinates-240"><span class="linenos">240</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span>
</span><span id="Cell.corner_coordinates-241"><a href="#Cell.corner_coordinates-241"><span class="linenos">241</span></a>        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span><span id="Cell.corner_coordinates-242"><a href="#Cell.corner_coordinates-242"><span class="linenos">242</span></a>
</span><span id="Cell.corner_coordinates-243"><a href="#Cell.corner_coordinates-243"><span class="linenos">243</span></a>        <span class="n">corners</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Cell.corner_coordinates-244"><a href="#Cell.corner_coordinates-244"><span class="linenos">244</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell.corner_coordinates-245"><a href="#Cell.corner_coordinates-245"><span class="linenos">245</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell.corner_coordinates-246"><a href="#Cell.corner_coordinates-246"><span class="linenos">246</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell.corner_coordinates-247"><a href="#Cell.corner_coordinates-247"><span class="linenos">247</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell.corner_coordinates-248"><a href="#Cell.corner_coordinates-248"><span class="linenos">248</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="Cell.corner_coordinates-249"><a href="#Cell.corner_coordinates-249"><span class="linenos">249</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="Cell.corner_coordinates-250"><a href="#Cell.corner_coordinates-250"><span class="linenos">250</span></a>            <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="Cell.corner_coordinates-251"><a href="#Cell.corner_coordinates-251"><span class="linenos">251</span></a>            <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span><span class="p">),</span>
</span><span id="Cell.corner_coordinates-252"><a href="#Cell.corner_coordinates-252"><span class="linenos">252</span></a>        <span class="p">]</span>
</span><span id="Cell.corner_coordinates-253"><a href="#Cell.corner_coordinates-253"><span class="linenos">253</span></a>
</span><span id="Cell.corner_coordinates-254"><a href="#Cell.corner_coordinates-254"><span class="linenos">254</span></a>        <span class="k">return</span> <span class="n">corners</span>
</span></pre></div>


            <div class="docstring"><p>Get the corner coordinates of the cell.</p>

<h2 id="returns">Returns:</h2>

<p>list of tuples
    List of (x, y, z) coordinates of the corner points.</p>
</div>


                            </div>
                            <div id="Cell.generate_cell_properties" class="classattr">
                                        <input id="Cell.generate_cell_properties-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">generate_cell_properties</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">initial_cell_size</span>,</span><span class="param">	<span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Cell.generate_cell_properties-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.generate_cell_properties"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.generate_cell_properties-260"><a href="#Cell.generate_cell_properties-260"><span class="linenos">260</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell.generate_cell_properties-261"><a href="#Cell.generate_cell_properties-261"><span class="linenos">261</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.generate_cell_properties-262"><a href="#Cell.generate_cell_properties-262"><span class="linenos">262</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_cell_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_cell_size</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Cell.generate_cell_properties-263"><a href="#Cell.generate_cell_properties-263"><span class="linenos">263</span></a>                                 <span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Cell.generate_cell_properties-264"><a href="#Cell.generate_cell_properties-264"><span class="linenos">264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.generate_cell_properties-265"><a href="#Cell.generate_cell_properties-265"><span class="linenos">265</span></a><span class="sd">        Generate cell properties including beams and nodes.</span>
</span><span id="Cell.generate_cell_properties-266"><a href="#Cell.generate_cell_properties-266"><span class="linenos">266</span></a>
</span><span id="Cell.generate_cell_properties-267"><a href="#Cell.generate_cell_properties-267"><span class="linenos">267</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.generate_cell_properties-268"><a href="#Cell.generate_cell_properties-268"><span class="linenos">268</span></a><span class="sd">        -----------</span>
</span><span id="Cell.generate_cell_properties-269"><a href="#Cell.generate_cell_properties-269"><span class="linenos">269</span></a><span class="sd">        initialCellSize: list</span>
</span><span id="Cell.generate_cell_properties-270"><a href="#Cell.generate_cell_properties-270"><span class="linenos">270</span></a><span class="sd">            Initial size of the cell without modification</span>
</span><span id="Cell.generate_cell_properties-271"><a href="#Cell.generate_cell_properties-271"><span class="linenos">271</span></a>
</span><span id="Cell.generate_cell_properties-272"><a href="#Cell.generate_cell_properties-272"><span class="linenos">272</span></a><span class="sd">        beams_already_defined: set</span>
</span><span id="Cell.generate_cell_properties-273"><a href="#Cell.generate_cell_properties-273"><span class="linenos">273</span></a><span class="sd">            Set of beams already defined in the lattice to avoid duplication</span>
</span><span id="Cell.generate_cell_properties-274"><a href="#Cell.generate_cell_properties-274"><span class="linenos">274</span></a>
</span><span id="Cell.generate_cell_properties-275"><a href="#Cell.generate_cell_properties-275"><span class="linenos">275</span></a><span class="sd">        nodes_already_defined: set</span>
</span><span id="Cell.generate_cell_properties-276"><a href="#Cell.generate_cell_properties-276"><span class="linenos">276</span></a><span class="sd">            Set of nodes already defined in the lattice to avoid duplication</span>
</span><span id="Cell.generate_cell_properties-277"><a href="#Cell.generate_cell_properties-277"><span class="linenos">277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.generate_cell_properties-278"><a href="#Cell.generate_cell_properties-278"><span class="linenos">278</span></a>        <span class="n">idxCell</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell.generate_cell_properties-279"><a href="#Cell.generate_cell_properties-279"><span class="linenos">279</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Cell.generate_cell_properties-280"><a href="#Cell.generate_cell_properties-280"><span class="linenos">280</span></a>            <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Cell.generate_cell_properties-281"><a href="#Cell.generate_cell_properties-281"><span class="linenos">281</span></a>                <span class="k">if</span> <span class="n">idxCell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Cell.generate_cell_properties-282"><a href="#Cell.generate_cell_properties-282"><span class="linenos">282</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">get_beam_material</span><span class="p">()</span>
</span><span id="Cell.generate_cell_properties-283"><a href="#Cell.generate_cell_properties-283"><span class="linenos">283</span></a>                    <span class="n">beamRadius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Cell.generate_cell_properties-284"><a href="#Cell.generate_cell_properties-284"><span class="linenos">284</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">def_cell_size</span><span class="p">(</span><span class="n">initial_cell_size</span><span class="p">)</span>
</span><span id="Cell.generate_cell_properties-285"><a href="#Cell.generate_cell_properties-285"><span class="linenos">285</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_beams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">beamRadius</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">)</span>
</span><span id="Cell.generate_cell_properties-286"><a href="#Cell.generate_cell_properties-286"><span class="linenos">286</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">def_cell_center</span><span class="p">()</span>
</span><span id="Cell.generate_cell_properties-287"><a href="#Cell.generate_cell_properties-287"><span class="linenos">287</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.generate_cell_properties-288"><a href="#Cell.generate_cell_properties-288"><span class="linenos">288</span></a>                    <span class="n">hybridRadius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Cell.generate_cell_properties-289"><a href="#Cell.generate_cell_properties-289"><span class="linenos">289</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_beams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">hybridRadius</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">beams_already_defined</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">)</span>
</span><span id="Cell.generate_cell_properties-290"><a href="#Cell.generate_cell_properties-290"><span class="linenos">290</span></a>                <span class="n">idxCell</span> <span class="o">+=</span> <span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Generate cell properties including beams and nodes.</p>

<h2 id="parameters">Parameters:</h2>

<p>initialCellSize: list
    Initial size of the cell without modification</p>

<p>beams_already_defined: set
    Set of beams already defined in the lattice to avoid duplication</p>

<p>nodes_already_defined: set
    Set of nodes already defined in the lattice to avoid duplication</p>
</div>


                            </div>
                            <div id="Cell.generate_beams" class="classattr">
                                        <input id="Cell.generate_beams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">generate_beams</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">latticeType</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">beamRadius</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">beamType</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.generate_beams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.generate_beams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.generate_beams-292"><a href="#Cell.generate_beams-292"><span class="linenos">292</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell.generate_beams-293"><a href="#Cell.generate_beams-293"><span class="linenos">293</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.generate_beams-294"><a href="#Cell.generate_beams-294"><span class="linenos">294</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latticeType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">beamRadius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">beamType</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Cell.generate_beams-295"><a href="#Cell.generate_beams-295"><span class="linenos">295</span></a>                       <span class="n">beams_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nodes_already_defined</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
</span><span id="Cell.generate_beams-296"><a href="#Cell.generate_beams-296"><span class="linenos">296</span></a>            <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-297"><a href="#Cell.generate_beams-297"><span class="linenos">297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.generate_beams-298"><a href="#Cell.generate_beams-298"><span class="linenos">298</span></a><span class="sd">        Generate beams and nodes using a given lattice type_beam and parameters.</span>
</span><span id="Cell.generate_beams-299"><a href="#Cell.generate_beams-299"><span class="linenos">299</span></a>
</span><span id="Cell.generate_beams-300"><a href="#Cell.generate_beams-300"><span class="linenos">300</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.generate_beams-301"><a href="#Cell.generate_beams-301"><span class="linenos">301</span></a><span class="sd">        -----------</span>
</span><span id="Cell.generate_beams-302"><a href="#Cell.generate_beams-302"><span class="linenos">302</span></a><span class="sd">        latticeType: str</span>
</span><span id="Cell.generate_beams-303"><a href="#Cell.generate_beams-303"><span class="linenos">303</span></a><span class="sd">            Type of lattice structure (e.g., &#39;BCC&#39;, &#39;Hybrid1&#39;, etc.)</span>
</span><span id="Cell.generate_beams-304"><a href="#Cell.generate_beams-304"><span class="linenos">304</span></a>
</span><span id="Cell.generate_beams-305"><a href="#Cell.generate_beams-305"><span class="linenos">305</span></a><span class="sd">        beamRadius: float</span>
</span><span id="Cell.generate_beams-306"><a href="#Cell.generate_beams-306"><span class="linenos">306</span></a><span class="sd">            Radius of the beam</span>
</span><span id="Cell.generate_beams-307"><a href="#Cell.generate_beams-307"><span class="linenos">307</span></a>
</span><span id="Cell.generate_beams-308"><a href="#Cell.generate_beams-308"><span class="linenos">308</span></a><span class="sd">        beamType: int</span>
</span><span id="Cell.generate_beams-309"><a href="#Cell.generate_beams-309"><span class="linenos">309</span></a><span class="sd">            Type index of the beam</span>
</span><span id="Cell.generate_beams-310"><a href="#Cell.generate_beams-310"><span class="linenos">310</span></a>
</span><span id="Cell.generate_beams-311"><a href="#Cell.generate_beams-311"><span class="linenos">311</span></a><span class="sd">        beams_already_defined: set</span>
</span><span id="Cell.generate_beams-312"><a href="#Cell.generate_beams-312"><span class="linenos">312</span></a><span class="sd">            Set of beams already defined in the lattice to avoid duplication</span>
</span><span id="Cell.generate_beams-313"><a href="#Cell.generate_beams-313"><span class="linenos">313</span></a>
</span><span id="Cell.generate_beams-314"><a href="#Cell.generate_beams-314"><span class="linenos">314</span></a><span class="sd">        nodes_already_defined: set</span>
</span><span id="Cell.generate_beams-315"><a href="#Cell.generate_beams-315"><span class="linenos">315</span></a><span class="sd">            Set of nodes already defined in the lattice to avoid duplication</span>
</span><span id="Cell.generate_beams-316"><a href="#Cell.generate_beams-316"><span class="linenos">316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.generate_beams-317"><a href="#Cell.generate_beams-317"><span class="linenos">317</span></a>
</span><span id="Cell.generate_beams-318"><a href="#Cell.generate_beams-318"><span class="linenos">318</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">wkey</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="Cell.generate_beams-319"><a href="#Cell.generate_beams-319"><span class="linenos">319</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Create a unique key for a point based on its coordinates rounded to a specified number of digits.&quot;&quot;&quot;</span>
</span><span id="Cell.generate_beams-320"><a href="#Cell.generate_beams-320"><span class="linenos">320</span></a>            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">)</span>
</span><span id="Cell.generate_beams-321"><a href="#Cell.generate_beams-321"><span class="linenos">321</span></a>
</span><span id="Cell.generate_beams-322"><a href="#Cell.generate_beams-322"><span class="linenos">322</span></a>        <span class="n">frac_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Cell.generate_beams-323"><a href="#Cell.generate_beams-323"><span class="linenos">323</span></a>
</span><span id="Cell.generate_beams-324"><a href="#Cell.generate_beams-324"><span class="linenos">324</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">get_beam_structure</span><span class="p">(</span><span class="n">latticeType</span><span class="p">):</span>
</span><span id="Cell.generate_beams-325"><a href="#Cell.generate_beams-325"><span class="linenos">325</span></a>            <span class="n">x1f</span><span class="p">,</span> <span class="n">y1f</span><span class="p">,</span> <span class="n">z1f</span><span class="p">,</span> <span class="n">x2f</span><span class="p">,</span> <span class="n">y2f</span><span class="p">,</span> <span class="n">z2f</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span><span id="Cell.generate_beams-326"><a href="#Cell.generate_beams-326"><span class="linenos">326</span></a>
</span><span id="Cell.generate_beams-327"><a href="#Cell.generate_beams-327"><span class="linenos">327</span></a>            <span class="n">x1</span> <span class="o">=</span> <span class="n">x1f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell.generate_beams-328"><a href="#Cell.generate_beams-328"><span class="linenos">328</span></a>            <span class="n">y1</span> <span class="o">=</span> <span class="n">y1f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Cell.generate_beams-329"><a href="#Cell.generate_beams-329"><span class="linenos">329</span></a>            <span class="n">z1</span> <span class="o">=</span> <span class="n">z1f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell.generate_beams-330"><a href="#Cell.generate_beams-330"><span class="linenos">330</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="n">x2f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell.generate_beams-331"><a href="#Cell.generate_beams-331"><span class="linenos">331</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="n">y2f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Cell.generate_beams-332"><a href="#Cell.generate_beams-332"><span class="linenos">332</span></a>            <span class="n">z2</span> <span class="o">=</span> <span class="n">z2f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell.generate_beams-333"><a href="#Cell.generate_beams-333"><span class="linenos">333</span></a>
</span><span id="Cell.generate_beams-334"><a href="#Cell.generate_beams-334"><span class="linenos">334</span></a>            <span class="n">k1</span> <span class="o">=</span> <span class="n">wkey</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">)</span>
</span><span id="Cell.generate_beams-335"><a href="#Cell.generate_beams-335"><span class="linenos">335</span></a>            <span class="n">k2</span> <span class="o">=</span> <span class="n">wkey</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
</span><span id="Cell.generate_beams-336"><a href="#Cell.generate_beams-336"><span class="linenos">336</span></a>
</span><span id="Cell.generate_beams-337"><a href="#Cell.generate_beams-337"><span class="linenos">337</span></a>            <span class="k">if</span> <span class="n">nodes_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-338"><a href="#Cell.generate_beams-338"><span class="linenos">338</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">nodes_already_defined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
</span><span id="Cell.generate_beams-339"><a href="#Cell.generate_beams-339"><span class="linenos">339</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">nodes_already_defined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
</span><span id="Cell.generate_beams-340"><a href="#Cell.generate_beams-340"><span class="linenos">340</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.generate_beams-341"><a href="#Cell.generate_beams-341"><span class="linenos">341</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.generate_beams-342"><a href="#Cell.generate_beams-342"><span class="linenos">342</span></a>
</span><span id="Cell.generate_beams-343"><a href="#Cell.generate_beams-343"><span class="linenos">343</span></a>            <span class="k">if</span> <span class="n">p1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-344"><a href="#Cell.generate_beams-344"><span class="linenos">344</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">frac_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x1f</span><span class="p">,</span> <span class="n">y1f</span><span class="p">,</span> <span class="n">z1f</span><span class="p">))</span>
</span><span id="Cell.generate_beams-345"><a href="#Cell.generate_beams-345"><span class="linenos">345</span></a>                <span class="k">if</span> <span class="n">p1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-346"><a href="#Cell.generate_beams-346"><span class="linenos">346</span></a>                    <span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">)</span>
</span><span id="Cell.generate_beams-347"><a href="#Cell.generate_beams-347"><span class="linenos">347</span></a>                    <span class="n">frac_cache</span><span class="p">[(</span><span class="n">x1f</span><span class="p">,</span> <span class="n">y1f</span><span class="p">,</span> <span class="n">z1f</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p1</span>
</span><span id="Cell.generate_beams-348"><a href="#Cell.generate_beams-348"><span class="linenos">348</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.generate_beams-349"><a href="#Cell.generate_beams-349"><span class="linenos">349</span></a>                    <span class="n">p1</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell.generate_beams-350"><a href="#Cell.generate_beams-350"><span class="linenos">350</span></a>                <span class="k">if</span> <span class="n">nodes_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-351"><a href="#Cell.generate_beams-351"><span class="linenos">351</span></a>                    <span class="n">nodes_already_defined</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span>
</span><span id="Cell.generate_beams-352"><a href="#Cell.generate_beams-352"><span class="linenos">352</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.generate_beams-353"><a href="#Cell.generate_beams-353"><span class="linenos">353</span></a>                <span class="n">p1</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell.generate_beams-354"><a href="#Cell.generate_beams-354"><span class="linenos">354</span></a>
</span><span id="Cell.generate_beams-355"><a href="#Cell.generate_beams-355"><span class="linenos">355</span></a>            <span class="k">if</span> <span class="n">p2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-356"><a href="#Cell.generate_beams-356"><span class="linenos">356</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">frac_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x2f</span><span class="p">,</span> <span class="n">y2f</span><span class="p">,</span> <span class="n">z2f</span><span class="p">))</span>
</span><span id="Cell.generate_beams-357"><a href="#Cell.generate_beams-357"><span class="linenos">357</span></a>                <span class="k">if</span> <span class="n">p2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-358"><a href="#Cell.generate_beams-358"><span class="linenos">358</span></a>                    <span class="n">p2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">)</span>
</span><span id="Cell.generate_beams-359"><a href="#Cell.generate_beams-359"><span class="linenos">359</span></a>                    <span class="n">frac_cache</span><span class="p">[(</span><span class="n">x2f</span><span class="p">,</span> <span class="n">y2f</span><span class="p">,</span> <span class="n">z2f</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p2</span>
</span><span id="Cell.generate_beams-360"><a href="#Cell.generate_beams-360"><span class="linenos">360</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.generate_beams-361"><a href="#Cell.generate_beams-361"><span class="linenos">361</span></a>                    <span class="n">p2</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell.generate_beams-362"><a href="#Cell.generate_beams-362"><span class="linenos">362</span></a>                <span class="k">if</span> <span class="n">nodes_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-363"><a href="#Cell.generate_beams-363"><span class="linenos">363</span></a>                    <span class="n">nodes_already_defined</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p2</span>
</span><span id="Cell.generate_beams-364"><a href="#Cell.generate_beams-364"><span class="linenos">364</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.generate_beams-365"><a href="#Cell.generate_beams-365"><span class="linenos">365</span></a>                <span class="n">p2</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell.generate_beams-366"><a href="#Cell.generate_beams-366"><span class="linenos">366</span></a>
</span><span id="Cell.generate_beams-367"><a href="#Cell.generate_beams-367"><span class="linenos">367</span></a>            <span class="k">if</span> <span class="n">beams_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-368"><a href="#Cell.generate_beams-368"><span class="linenos">368</span></a>                <span class="n">bkey</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">)))</span>
</span><span id="Cell.generate_beams-369"><a href="#Cell.generate_beams-369"><span class="linenos">369</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="n">beams_already_defined</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bkey</span><span class="p">)</span>
</span><span id="Cell.generate_beams-370"><a href="#Cell.generate_beams-370"><span class="linenos">370</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.generate_beams-371"><a href="#Cell.generate_beams-371"><span class="linenos">371</span></a>                <span class="n">bkey</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.generate_beams-372"><a href="#Cell.generate_beams-372"><span class="linenos">372</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Cell.generate_beams-373"><a href="#Cell.generate_beams-373"><span class="linenos">373</span></a>
</span><span id="Cell.generate_beams-374"><a href="#Cell.generate_beams-374"><span class="linenos">374</span></a>            <span class="k">if</span> <span class="n">beam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-375"><a href="#Cell.generate_beams-375"><span class="linenos">375</span></a>                <span class="n">beam</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">beamRadius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span><span class="p">,</span> <span class="n">beamType</span><span class="p">,</span> <span class="n">cell_belongings</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell.generate_beams-376"><a href="#Cell.generate_beams-376"><span class="linenos">376</span></a>                <span class="k">if</span> <span class="n">beams_already_defined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.generate_beams-377"><a href="#Cell.generate_beams-377"><span class="linenos">377</span></a>                    <span class="n">beams_already_defined</span><span class="p">[</span><span class="n">bkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam</span>
</span><span id="Cell.generate_beams-378"><a href="#Cell.generate_beams-378"><span class="linenos">378</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># Already defined beam, just add the cell belonging</span>
</span><span id="Cell.generate_beams-379"><a href="#Cell.generate_beams-379"><span class="linenos">379</span></a>                <span class="n">beam</span><span class="o">.</span><span class="n">add_cell_belonging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Cell.generate_beams-380"><a href="#Cell.generate_beams-380"><span class="linenos">380</span></a>
</span><span id="Cell.generate_beams-381"><a href="#Cell.generate_beams-381"><span class="linenos">381</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="Cell.generate_beams-382"><a href="#Cell.generate_beams-382"><span class="linenos">382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
</span><span id="Cell.generate_beams-383"><a href="#Cell.generate_beams-383"><span class="linenos">383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate beams and nodes using a given lattice type_beam and parameters.</p>

<h2 id="parameters">Parameters:</h2>

<p>latticeType: str
    Type of lattice structure (e.g., 'BCC', 'Hybrid1', etc.)</p>

<p>beamRadius: float
    Radius of the beam</p>

<p>beamType: int
    Type index of the beam</p>

<p>beams_already_defined: set
    Set of beams already defined in the lattice to avoid duplication</p>

<p>nodes_already_defined: set
    Set of nodes already defined in the lattice to avoid duplication</p>
</div>


                            </div>
                            <div id="Cell.get_beam_material" class="classattr">
                                        <input id="Cell.get_beam_material-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_beam_material</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.get_beam_material-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_beam_material"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_beam_material-385"><a href="#Cell.get_beam_material-385"><span class="linenos">385</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_beam_material</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.get_beam_material-386"><a href="#Cell.get_beam_material-386"><span class="linenos">386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_beam_material-387"><a href="#Cell.get_beam_material-387"><span class="linenos">387</span></a><span class="sd">        Get the material of the beam based on the material gradient.</span>
</span><span id="Cell.get_beam_material-388"><a href="#Cell.get_beam_material-388"><span class="linenos">388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_beam_material-389"><a href="#Cell.get_beam_material-389"><span class="linenos">389</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.get_beam_material-390"><a href="#Cell.get_beam_material-390"><span class="linenos">390</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell.get_beam_material-391"><a href="#Cell.get_beam_material-391"><span class="linenos">391</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.get_beam_material-392"><a href="#Cell.get_beam_material-392"><span class="linenos">392</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></pre></div>


            <div class="docstring"><p>Get the material of the beam based on the material gradient.</p>
</div>


                            </div>
                            <div id="Cell.get_radius" class="classattr">
                                        <input id="Cell.get_radius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_radius</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">base_radius</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Cell.get_radius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_radius"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_radius-394"><a href="#Cell.get_radius-394"><span class="linenos">394</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell.get_radius-395"><a href="#Cell.get_radius-395"><span class="linenos">395</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_radius-396"><a href="#Cell.get_radius-396"><span class="linenos">396</span></a><span class="sd">        Calculate and return the beam radii</span>
</span><span id="Cell.get_radius-397"><a href="#Cell.get_radius-397"><span class="linenos">397</span></a>
</span><span id="Cell.get_radius-398"><a href="#Cell.get_radius-398"><span class="linenos">398</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.get_radius-399"><a href="#Cell.get_radius-399"><span class="linenos">399</span></a><span class="sd">        -----------</span>
</span><span id="Cell.get_radius-400"><a href="#Cell.get_radius-400"><span class="linenos">400</span></a><span class="sd">        baseRadius: float</span>
</span><span id="Cell.get_radius-401"><a href="#Cell.get_radius-401"><span class="linenos">401</span></a><span class="sd">            Base radius of the beam</span>
</span><span id="Cell.get_radius-402"><a href="#Cell.get_radius-402"><span class="linenos">402</span></a>
</span><span id="Cell.get_radius-403"><a href="#Cell.get_radius-403"><span class="linenos">403</span></a><span class="sd">        Returns:</span>
</span><span id="Cell.get_radius-404"><a href="#Cell.get_radius-404"><span class="linenos">404</span></a><span class="sd">        ---------</span>
</span><span id="Cell.get_radius-405"><a href="#Cell.get_radius-405"><span class="linenos">405</span></a><span class="sd">        beamRadius : float</span>
</span><span id="Cell.get_radius-406"><a href="#Cell.get_radius-406"><span class="linenos">406</span></a><span class="sd">            Calculated beam radii</span>
</span><span id="Cell.get_radius-407"><a href="#Cell.get_radius-407"><span class="linenos">407</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_radius-408"><a href="#Cell.get_radius-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.get_radius-409"><a href="#Cell.get_radius-409"><span class="linenos">409</span></a>            <span class="k">return</span> <span class="n">base_radius</span>
</span><span id="Cell.get_radius-410"><a href="#Cell.get_radius-410"><span class="linenos">410</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.get_radius-411"><a href="#Cell.get_radius-411"><span class="linenos">411</span></a>            <span class="n">beamRadius</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_radius</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
</span><span id="Cell.get_radius-412"><a href="#Cell.get_radius-412"><span class="linenos">412</span></a>                          <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span>
</span><span id="Cell.get_radius-413"><a href="#Cell.get_radius-413"><span class="linenos">413</span></a>                          <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">])</span>
</span><span id="Cell.get_radius-414"><a href="#Cell.get_radius-414"><span class="linenos">414</span></a>            <span class="k">return</span> <span class="n">beamRadius</span>
</span></pre></div>


            <div class="docstring"><p>Calculate and return the beam radii</p>

<h2 id="parameters">Parameters:</h2>

<p>baseRadius: float
    Base radius of the beam</p>

<h2 id="returns">Returns:</h2>

<p>beamRadius : float
    Calculated beam radii</p>
</div>


                            </div>
                            <div id="Cell.def_cell_size" class="classattr">
                                        <input id="Cell.def_cell_size-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">def_cell_size</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">initial_cell_size</span><span class="p">:</span> <span class="nb">list</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.def_cell_size-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.def_cell_size"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.def_cell_size-416"><a href="#Cell.def_cell_size-416"><span class="linenos">416</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">def_cell_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_cell_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.def_cell_size-417"><a href="#Cell.def_cell_size-417"><span class="linenos">417</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.def_cell_size-418"><a href="#Cell.def_cell_size-418"><span class="linenos">418</span></a><span class="sd">        Calculate and return the cell size</span>
</span><span id="Cell.def_cell_size-419"><a href="#Cell.def_cell_size-419"><span class="linenos">419</span></a>
</span><span id="Cell.def_cell_size-420"><a href="#Cell.def_cell_size-420"><span class="linenos">420</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.def_cell_size-421"><a href="#Cell.def_cell_size-421"><span class="linenos">421</span></a><span class="sd">        -----------</span>
</span><span id="Cell.def_cell_size-422"><a href="#Cell.def_cell_size-422"><span class="linenos">422</span></a><span class="sd">        initial_cell_size: list</span>
</span><span id="Cell.def_cell_size-423"><a href="#Cell.def_cell_size-423"><span class="linenos">423</span></a><span class="sd">            Initial size of the cell</span>
</span><span id="Cell.def_cell_size-424"><a href="#Cell.def_cell_size-424"><span class="linenos">424</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.def_cell_size-425"><a href="#Cell.def_cell_size-425"><span class="linenos">425</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.def_cell_size-426"><a href="#Cell.def_cell_size-426"><span class="linenos">426</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">initial_cell_size</span>
</span><span id="Cell.def_cell_size-427"><a href="#Cell.def_cell_size-427"><span class="linenos">427</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.def_cell_size-428"><a href="#Cell.def_cell_size-428"><span class="linenos">428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">initial_size</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="ow">in</span>
</span><span id="Cell.def_cell_size-429"><a href="#Cell.def_cell_size-429"><span class="linenos">429</span></a>                         <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">initial_cell_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">))]</span>
</span></pre></div>


            <div class="docstring"><p>Calculate and return the cell size</p>

<h2 id="parameters">Parameters:</h2>

<p>initial_cell_size: list
    Initial size of the cell</p>
</div>


                            </div>
                            <div id="Cell.def_cell_center" class="classattr">
                                        <input id="Cell.def_cell_center-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">def_cell_center</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.def_cell_center-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.def_cell_center"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.def_cell_center-431"><a href="#Cell.def_cell_center-431"><span class="linenos">431</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">def_cell_center</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.def_cell_center-432"><a href="#Cell.def_cell_center-432"><span class="linenos">432</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.def_cell_center-433"><a href="#Cell.def_cell_center-433"><span class="linenos">433</span></a><span class="sd">        Calculate the center point of the cell</span>
</span><span id="Cell.def_cell_center-434"><a href="#Cell.def_cell_center-434"><span class="linenos">434</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.def_cell_center-435"><a href="#Cell.def_cell_center-435"><span class="linenos">435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_point</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the center point of the cell</p>
</div>


                            </div>
                            <div id="Cell.get_point_on_surface" class="classattr">
                                        <input id="Cell.get_point_on_surface-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_point_on_surface</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">surfaceName</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="Cell.get_point_on_surface-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_point_on_surface"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_point_on_surface-437"><a href="#Cell.get_point_on_surface-437"><span class="linenos">437</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_point_on_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfaceName</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell.get_point_on_surface-438"><a href="#Cell.get_point_on_surface-438"><span class="linenos">438</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_point_on_surface-439"><a href="#Cell.get_point_on_surface-439"><span class="linenos">439</span></a><span class="sd">        Get the points on the surface specified in the global reference frame.</span>
</span><span id="Cell.get_point_on_surface-440"><a href="#Cell.get_point_on_surface-440"><span class="linenos">440</span></a>
</span><span id="Cell.get_point_on_surface-441"><a href="#Cell.get_point_on_surface-441"><span class="linenos">441</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.get_point_on_surface-442"><a href="#Cell.get_point_on_surface-442"><span class="linenos">442</span></a><span class="sd">        -----------</span>
</span><span id="Cell.get_point_on_surface-443"><a href="#Cell.get_point_on_surface-443"><span class="linenos">443</span></a><span class="sd">        surfaceName: str</span>
</span><span id="Cell.get_point_on_surface-444"><a href="#Cell.get_point_on_surface-444"><span class="linenos">444</span></a><span class="sd">            Name of the surface. Choose from &#39;Xmin&#39;, &#39;Xmax&#39;, &#39;Ymin&#39;, &#39;Ymax&#39;, &#39;Zmin&#39;, &#39;Zmax&#39;, &#39;Xmid&#39;, &#39;Ymid&#39;, &#39;Zmid&#39;.</span>
</span><span id="Cell.get_point_on_surface-445"><a href="#Cell.get_point_on_surface-445"><span class="linenos">445</span></a><span class="sd">            If &#39;Xmid&#39;, &#39;Ymid&#39;, or &#39;Zmid&#39; is specified, it returns the points at the bottom of the cell</span>
</span><span id="Cell.get_point_on_surface-446"><a href="#Cell.get_point_on_surface-446"><span class="linenos">446</span></a>
</span><span id="Cell.get_point_on_surface-447"><a href="#Cell.get_point_on_surface-447"><span class="linenos">447</span></a><span class="sd">        Returns:</span>
</span><span id="Cell.get_point_on_surface-448"><a href="#Cell.get_point_on_surface-448"><span class="linenos">448</span></a><span class="sd">        --------</span>
</span><span id="Cell.get_point_on_surface-449"><a href="#Cell.get_point_on_surface-449"><span class="linenos">449</span></a><span class="sd">        list</span>
</span><span id="Cell.get_point_on_surface-450"><a href="#Cell.get_point_on_surface-450"><span class="linenos">450</span></a><span class="sd">           List of points on the specified surface.</span>
</span><span id="Cell.get_point_on_surface-451"><a href="#Cell.get_point_on_surface-451"><span class="linenos">451</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_point_on_surface-452"><a href="#Cell.get_point_on_surface-452"><span class="linenos">452</span></a>        <span class="n">boundaryBox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="Cell.get_point_on_surface-453"><a href="#Cell.get_point_on_surface-453"><span class="linenos">453</span></a>        <span class="n">surface_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Cell.get_point_on_surface-454"><a href="#Cell.get_point_on_surface-454"><span class="linenos">454</span></a>            <span class="s2">&quot;Xmin&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Cell.get_point_on_surface-455"><a href="#Cell.get_point_on_surface-455"><span class="linenos">455</span></a>            <span class="s2">&quot;Xmax&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Cell.get_point_on_surface-456"><a href="#Cell.get_point_on_surface-456"><span class="linenos">456</span></a>            <span class="s2">&quot;Ymin&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="Cell.get_point_on_surface-457"><a href="#Cell.get_point_on_surface-457"><span class="linenos">457</span></a>            <span class="s2">&quot;Ymax&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="Cell.get_point_on_surface-458"><a href="#Cell.get_point_on_surface-458"><span class="linenos">458</span></a>            <span class="s2">&quot;Zmin&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span><span id="Cell.get_point_on_surface-459"><a href="#Cell.get_point_on_surface-459"><span class="linenos">459</span></a>            <span class="s2">&quot;Zmax&quot;</span><span class="p">:</span> <span class="n">boundaryBox</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span id="Cell.get_point_on_surface-460"><a href="#Cell.get_point_on_surface-460"><span class="linenos">460</span></a>            <span class="s2">&quot;Xmid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Cell.get_point_on_surface-461"><a href="#Cell.get_point_on_surface-461"><span class="linenos">461</span></a>            <span class="s2">&quot;Ymid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Cell.get_point_on_surface-462"><a href="#Cell.get_point_on_surface-462"><span class="linenos">462</span></a>            <span class="s2">&quot;Zmid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Cell.get_point_on_surface-463"><a href="#Cell.get_point_on_surface-463"><span class="linenos">463</span></a>        <span class="p">}</span>
</span><span id="Cell.get_point_on_surface-464"><a href="#Cell.get_point_on_surface-464"><span class="linenos">464</span></a>
</span><span id="Cell.get_point_on_surface-465"><a href="#Cell.get_point_on_surface-465"><span class="linenos">465</span></a>        <span class="n">coord_index</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Cell.get_point_on_surface-466"><a href="#Cell.get_point_on_surface-466"><span class="linenos">466</span></a>            <span class="s2">&quot;Xmin&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmid&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
</span><span id="Cell.get_point_on_surface-467"><a href="#Cell.get_point_on_surface-467"><span class="linenos">467</span></a>            <span class="s2">&quot;Ymin&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymid&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
</span><span id="Cell.get_point_on_surface-468"><a href="#Cell.get_point_on_surface-468"><span class="linenos">468</span></a>            <span class="s2">&quot;Zmin&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmax&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmid&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span>
</span><span id="Cell.get_point_on_surface-469"><a href="#Cell.get_point_on_surface-469"><span class="linenos">469</span></a>        <span class="p">}</span>
</span><span id="Cell.get_point_on_surface-470"><a href="#Cell.get_point_on_surface-470"><span class="linenos">470</span></a>
</span><span id="Cell.get_point_on_surface-471"><a href="#Cell.get_point_on_surface-471"><span class="linenos">471</span></a>        <span class="k">if</span> <span class="n">surfaceName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">surface_map</span><span class="p">:</span>
</span><span id="Cell.get_point_on_surface-472"><a href="#Cell.get_point_on_surface-472"><span class="linenos">472</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Cell.get_point_on_surface-473"><a href="#Cell.get_point_on_surface-473"><span class="linenos">473</span></a>                <span class="sa">f</span><span class="s2">&quot;Surface &#39;</span><span class="si">{</span><span class="n">surfaceName</span><span class="si">}</span><span class="s2">&#39; is not valid. Choose from &#39;Xmin&#39;, &#39;Xmax&#39;, &#39;Ymin&#39;, &#39;Ymax&#39;, &#39;Zmin&#39;, &#39;Zmax&#39;, &quot;</span>
</span><span id="Cell.get_point_on_surface-474"><a href="#Cell.get_point_on_surface-474"><span class="linenos">474</span></a>                <span class="sa">f</span><span class="s2">&quot;&#39;Xmid&#39;, &#39;Ymid&#39;, &#39;Zmid&#39;.&quot;</span><span class="p">)</span>
</span><span id="Cell.get_point_on_surface-475"><a href="#Cell.get_point_on_surface-475"><span class="linenos">475</span></a>
</span><span id="Cell.get_point_on_surface-476"><a href="#Cell.get_point_on_surface-476"><span class="linenos">476</span></a>        <span class="n">surface_value</span> <span class="o">=</span> <span class="n">surface_map</span><span class="p">[</span><span class="n">surfaceName</span><span class="p">]</span>
</span><span id="Cell.get_point_on_surface-477"><a href="#Cell.get_point_on_surface-477"><span class="linenos">477</span></a>        <span class="n">axis</span> <span class="o">=</span> <span class="n">coord_index</span><span class="p">[</span><span class="n">surfaceName</span><span class="p">]</span>
</span><span id="Cell.get_point_on_surface-478"><a href="#Cell.get_point_on_surface-478"><span class="linenos">478</span></a>
</span><span id="Cell.get_point_on_surface-479"><a href="#Cell.get_point_on_surface-479"><span class="linenos">479</span></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">({</span>
</span><span id="Cell.get_point_on_surface-480"><a href="#Cell.get_point_on_surface-480"><span class="linenos">480</span></a>            <span class="n">point</span> <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span>
</span><span id="Cell.get_point_on_surface-481"><a href="#Cell.get_point_on_surface-481"><span class="linenos">481</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]</span>
</span><span id="Cell.get_point_on_surface-482"><a href="#Cell.get_point_on_surface-482"><span class="linenos">482</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="n">surface_value</span>
</span><span id="Cell.get_point_on_surface-483"><a href="#Cell.get_point_on_surface-483"><span class="linenos">483</span></a>        <span class="p">})</span>
</span></pre></div>


            <div class="docstring"><p>Get the points on the surface specified in the global reference frame.</p>

<h2 id="parameters">Parameters:</h2>

<p>surfaceName: str
    Name of the surface. Choose from 'Xmin', 'Xmax', 'Ymin', 'Ymax', 'Zmin', 'Zmax', 'Xmid', 'Ymid', 'Zmid'.
    If 'Xmid', 'Ymid', or 'Zmid' is specified, it returns the points at the bottom of the cell</p>

<h2 id="returns">Returns:</h2>

<p>list
   List of points on the specified surface.</p>
</div>


                            </div>
                            <div id="Cell.remove_beam" class="classattr">
                                        <input id="Cell.remove_beam-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">remove_beam</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">beam_to_delete</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="beam.html#Beam">pyLattice.beam.Beam</a></span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="beam.html#Beam">pyLattice.beam.Beam</a></span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.remove_beam-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.remove_beam"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.remove_beam-489"><a href="#Cell.remove_beam-489"><span class="linenos">489</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell.remove_beam-490"><a href="#Cell.remove_beam-490"><span class="linenos">490</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.remove_beam-491"><a href="#Cell.remove_beam-491"><span class="linenos">491</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam_to_delete</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.remove_beam-492"><a href="#Cell.remove_beam-492"><span class="linenos">492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.remove_beam-493"><a href="#Cell.remove_beam-493"><span class="linenos">493</span></a><span class="sd">        Removing beam from cell</span>
</span><span id="Cell.remove_beam-494"><a href="#Cell.remove_beam-494"><span class="linenos">494</span></a>
</span><span id="Cell.remove_beam-495"><a href="#Cell.remove_beam-495"><span class="linenos">495</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.remove_beam-496"><a href="#Cell.remove_beam-496"><span class="linenos">496</span></a><span class="sd">        -----------</span>
</span><span id="Cell.remove_beam-497"><a href="#Cell.remove_beam-497"><span class="linenos">497</span></a><span class="sd">        beam_to_delete: Beam or Iterable[Beam]</span>
</span><span id="Cell.remove_beam-498"><a href="#Cell.remove_beam-498"><span class="linenos">498</span></a><span class="sd">            Beam or list of beams to remove from the cell</span>
</span><span id="Cell.remove_beam-499"><a href="#Cell.remove_beam-499"><span class="linenos">499</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.remove_beam-500"><a href="#Cell.remove_beam-500"><span class="linenos">500</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beam_to_delete</span><span class="p">,</span> <span class="n">Beam</span><span class="p">):</span>
</span><span id="Cell.remove_beam-501"><a href="#Cell.remove_beam-501"><span class="linenos">501</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">beam_to_delete</span><span class="p">)</span>
</span><span id="Cell.remove_beam-502"><a href="#Cell.remove_beam-502"><span class="linenos">502</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.remove_beam-503"><a href="#Cell.remove_beam-503"><span class="linenos">503</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beam_to_delete</span><span class="p">:</span>
</span><span id="Cell.remove_beam-504"><a href="#Cell.remove_beam-504"><span class="linenos">504</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Removing beam from cell</p>

<h2 id="parameters">Parameters:</h2>

<p>beam_to_delete: Beam or Iterable[Beam]
    Beam or list of beams to remove from the cell</p>
</div>


                            </div>
                            <div id="Cell.remove_point" class="classattr">
                                        <input id="Cell.remove_point-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">remove_point</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">point_to_delete</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="point.html#Point">pyLattice.point.Point</a></span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="point.html#Point">pyLattice.point.Point</a></span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.remove_point-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.remove_point"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.remove_point-506"><a href="#Cell.remove_point-506"><span class="linenos">506</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell.remove_point-507"><a href="#Cell.remove_point-507"><span class="linenos">507</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.remove_point-508"><a href="#Cell.remove_point-508"><span class="linenos">508</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_to_delete</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.remove_point-509"><a href="#Cell.remove_point-509"><span class="linenos">509</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.remove_point-510"><a href="#Cell.remove_point-510"><span class="linenos">510</span></a><span class="sd">        Removing point from cell</span>
</span><span id="Cell.remove_point-511"><a href="#Cell.remove_point-511"><span class="linenos">511</span></a>
</span><span id="Cell.remove_point-512"><a href="#Cell.remove_point-512"><span class="linenos">512</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.remove_point-513"><a href="#Cell.remove_point-513"><span class="linenos">513</span></a><span class="sd">        -----------</span>
</span><span id="Cell.remove_point-514"><a href="#Cell.remove_point-514"><span class="linenos">514</span></a><span class="sd">        point_to_delete: Point or Iterable[Point]</span>
</span><span id="Cell.remove_point-515"><a href="#Cell.remove_point-515"><span class="linenos">515</span></a><span class="sd">            Point or list of points to remove from the cell</span>
</span><span id="Cell.remove_point-516"><a href="#Cell.remove_point-516"><span class="linenos">516</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.remove_point-517"><a href="#Cell.remove_point-517"><span class="linenos">517</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_to_delete</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span>
</span><span id="Cell.remove_point-518"><a href="#Cell.remove_point-518"><span class="linenos">518</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">point_to_delete</span><span class="p">)</span>
</span><span id="Cell.remove_point-519"><a href="#Cell.remove_point-519"><span class="linenos">519</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.remove_point-520"><a href="#Cell.remove_point-520"><span class="linenos">520</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">point_to_delete</span><span class="p">:</span>
</span><span id="Cell.remove_point-521"><a href="#Cell.remove_point-521"><span class="linenos">521</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Removing point from cell</p>

<h2 id="parameters">Parameters:</h2>

<p>point_to_delete: Point or Iterable[Point]
    Point or list of points to remove from the cell</p>
</div>


                            </div>
                            <div id="Cell.add_beam" class="classattr">
                                        <input id="Cell.add_beam-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">add_beam</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">beam_to_add</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="beam.html#Beam">pyLattice.beam.Beam</a></span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="beam.html#Beam">pyLattice.beam.Beam</a></span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.add_beam-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.add_beam"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.add_beam-523"><a href="#Cell.add_beam-523"><span class="linenos">523</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell.add_beam-524"><a href="#Cell.add_beam-524"><span class="linenos">524</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.add_beam-525"><a href="#Cell.add_beam-525"><span class="linenos">525</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam_to_add</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.add_beam-526"><a href="#Cell.add_beam-526"><span class="linenos">526</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.add_beam-527"><a href="#Cell.add_beam-527"><span class="linenos">527</span></a><span class="sd">        Adding beam to cell</span>
</span><span id="Cell.add_beam-528"><a href="#Cell.add_beam-528"><span class="linenos">528</span></a>
</span><span id="Cell.add_beam-529"><a href="#Cell.add_beam-529"><span class="linenos">529</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.add_beam-530"><a href="#Cell.add_beam-530"><span class="linenos">530</span></a><span class="sd">        -----------</span>
</span><span id="Cell.add_beam-531"><a href="#Cell.add_beam-531"><span class="linenos">531</span></a><span class="sd">        beam_to_add: Beam or Iterable[Beam]</span>
</span><span id="Cell.add_beam-532"><a href="#Cell.add_beam-532"><span class="linenos">532</span></a><span class="sd">            Beam or list of beams to add to the cell</span>
</span><span id="Cell.add_beam-533"><a href="#Cell.add_beam-533"><span class="linenos">533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.add_beam-534"><a href="#Cell.add_beam-534"><span class="linenos">534</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beam_to_add</span><span class="p">,</span> <span class="n">Beam</span><span class="p">):</span>
</span><span id="Cell.add_beam-535"><a href="#Cell.add_beam-535"><span class="linenos">535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam_to_add</span><span class="p">)</span>
</span><span id="Cell.add_beam-536"><a href="#Cell.add_beam-536"><span class="linenos">536</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.add_beam-537"><a href="#Cell.add_beam-537"><span class="linenos">537</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beam_to_add</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Adding beam to cell</p>

<h2 id="parameters">Parameters:</h2>

<p>beam_to_add: Beam or Iterable[Beam]
    Beam or list of beams to add to the cell</p>
</div>


                            </div>
                            <div id="Cell.add_point" class="classattr">
                                        <input id="Cell.add_point-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">add_point</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">point_to_add</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="point.html#Point">pyLattice.point.Point</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.add_point-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.add_point"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.add_point-539"><a href="#Cell.add_point-539"><span class="linenos">539</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell.add_point-540"><a href="#Cell.add_point-540"><span class="linenos">540</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.add_point-541"><a href="#Cell.add_point-541"><span class="linenos">541</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_to_add</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;Point&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.add_point-542"><a href="#Cell.add_point-542"><span class="linenos">542</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.add_point-543"><a href="#Cell.add_point-543"><span class="linenos">543</span></a><span class="sd">        Adding point to cell</span>
</span><span id="Cell.add_point-544"><a href="#Cell.add_point-544"><span class="linenos">544</span></a>
</span><span id="Cell.add_point-545"><a href="#Cell.add_point-545"><span class="linenos">545</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.add_point-546"><a href="#Cell.add_point-546"><span class="linenos">546</span></a><span class="sd">        -----------</span>
</span><span id="Cell.add_point-547"><a href="#Cell.add_point-547"><span class="linenos">547</span></a><span class="sd">        point_to_add: Point or Iterable[Point]</span>
</span><span id="Cell.add_point-548"><a href="#Cell.add_point-548"><span class="linenos">548</span></a><span class="sd">            Point or list of points to add to the cell</span>
</span><span id="Cell.add_point-549"><a href="#Cell.add_point-549"><span class="linenos">549</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.add_point-550"><a href="#Cell.add_point-550"><span class="linenos">550</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_to_add</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span>
</span><span id="Cell.add_point-551"><a href="#Cell.add_point-551"><span class="linenos">551</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">point_to_add</span><span class="p">)</span>
</span><span id="Cell.add_point-552"><a href="#Cell.add_point-552"><span class="linenos">552</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.add_point-553"><a href="#Cell.add_point-553"><span class="linenos">553</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">point_to_add</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Adding point to cell</p>

<h2 id="parameters">Parameters:</h2>

<p>point_to_add: Point or Iterable[Point]
    Point or list of points to add to the cell</p>
</div>


                            </div>
                            <div id="Cell.add_cell_neighbour" class="classattr">
                                        <input id="Cell.add_cell_neighbour-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">add_cell_neighbour</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">sign</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">neighbour_cell</span><span class="p">:</span> <span class="n"><a href="#Cell">Cell</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.add_cell_neighbour-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.add_cell_neighbour"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.add_cell_neighbour-555"><a href="#Cell.add_cell_neighbour-555"><span class="linenos">555</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell.add_cell_neighbour-556"><a href="#Cell.add_cell_neighbour-556"><span class="linenos">556</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.add_cell_neighbour-557"><a href="#Cell.add_cell_neighbour-557"><span class="linenos">557</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_cell_neighbour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sign</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">neighbour_cell</span><span class="p">:</span> <span class="s2">&quot;Cell&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.add_cell_neighbour-558"><a href="#Cell.add_cell_neighbour-558"><span class="linenos">558</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.add_cell_neighbour-559"><a href="#Cell.add_cell_neighbour-559"><span class="linenos">559</span></a><span class="sd">        Add a neighbour cell in a structured dict format.</span>
</span><span id="Cell.add_cell_neighbour-560"><a href="#Cell.add_cell_neighbour-560"><span class="linenos">560</span></a>
</span><span id="Cell.add_cell_neighbour-561"><a href="#Cell.add_cell_neighbour-561"><span class="linenos">561</span></a><span class="sd">        Parameters</span>
</span><span id="Cell.add_cell_neighbour-562"><a href="#Cell.add_cell_neighbour-562"><span class="linenos">562</span></a><span class="sd">        ----------</span>
</span><span id="Cell.add_cell_neighbour-563"><a href="#Cell.add_cell_neighbour-563"><span class="linenos">563</span></a><span class="sd">        direction : str</span>
</span><span id="Cell.add_cell_neighbour-564"><a href="#Cell.add_cell_neighbour-564"><span class="linenos">564</span></a><span class="sd">            One of &quot;x&quot;, &quot;y&quot;, &quot;z&quot;</span>
</span><span id="Cell.add_cell_neighbour-565"><a href="#Cell.add_cell_neighbour-565"><span class="linenos">565</span></a><span class="sd">        sign : str</span>
</span><span id="Cell.add_cell_neighbour-566"><a href="#Cell.add_cell_neighbour-566"><span class="linenos">566</span></a><span class="sd">            Either &quot;positif&quot; or &quot;negatif&quot;</span>
</span><span id="Cell.add_cell_neighbour-567"><a href="#Cell.add_cell_neighbour-567"><span class="linenos">567</span></a><span class="sd">        neighbour_cell : Cell</span>
</span><span id="Cell.add_cell_neighbour-568"><a href="#Cell.add_cell_neighbour-568"><span class="linenos">568</span></a><span class="sd">            Neighbour cell to add</span>
</span><span id="Cell.add_cell_neighbour-569"><a href="#Cell.add_cell_neighbour-569"><span class="linenos">569</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.add_cell_neighbour-570"><a href="#Cell.add_cell_neighbour-570"><span class="linenos">570</span></a>        <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">:</span>
</span><span id="Cell.add_cell_neighbour-571"><a href="#Cell.add_cell_neighbour-571"><span class="linenos">571</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Cell.add_cell_neighbour-572"><a href="#Cell.add_cell_neighbour-572"><span class="linenos">572</span></a>
</span><span id="Cell.add_cell_neighbour-573"><a href="#Cell.add_cell_neighbour-573"><span class="linenos">573</span></a>        <span class="k">if</span> <span class="n">sign</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">]:</span>
</span><span id="Cell.add_cell_neighbour-574"><a href="#Cell.add_cell_neighbour-574"><span class="linenos">574</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">sign</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbour_cell</span>
</span></pre></div>


            <div class="docstring"><p>Add a neighbour cell in a structured dict format.</p>

<h2 id="parameters">Parameters</h2>

<p>direction : str
    One of "x", "y", "z"
sign : str
    Either "positif" or "negatif"
neighbour_cell : Cell
    Neighbour cell to add</p>
</div>


                            </div>
                            <div id="Cell.get_all_cell_neighbours" class="classattr">
                                        <input id="Cell.get_all_cell_neighbours-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_all_cell_neighbours</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Cell">Cell</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Cell.get_all_cell_neighbours-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_all_cell_neighbours"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_all_cell_neighbours-576"><a href="#Cell.get_all_cell_neighbours-576"><span class="linenos">576</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Cell.get_all_cell_neighbours-577"><a href="#Cell.get_all_cell_neighbours-577"><span class="linenos">577</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_all_cell_neighbours-578"><a href="#Cell.get_all_cell_neighbours-578"><span class="linenos">578</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_cell_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Cell&quot;</span><span class="p">]:</span>
</span><span id="Cell.get_all_cell_neighbours-579"><a href="#Cell.get_all_cell_neighbours-579"><span class="linenos">579</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_all_cell_neighbours-580"><a href="#Cell.get_all_cell_neighbours-580"><span class="linenos">580</span></a><span class="sd">        Get all neighbour cells in a flat list.</span>
</span><span id="Cell.get_all_cell_neighbours-581"><a href="#Cell.get_all_cell_neighbours-581"><span class="linenos">581</span></a>
</span><span id="Cell.get_all_cell_neighbours-582"><a href="#Cell.get_all_cell_neighbours-582"><span class="linenos">582</span></a><span class="sd">        Returns</span>
</span><span id="Cell.get_all_cell_neighbours-583"><a href="#Cell.get_all_cell_neighbours-583"><span class="linenos">583</span></a><span class="sd">        -------</span>
</span><span id="Cell.get_all_cell_neighbours-584"><a href="#Cell.get_all_cell_neighbours-584"><span class="linenos">584</span></a><span class="sd">        list of Cell</span>
</span><span id="Cell.get_all_cell_neighbours-585"><a href="#Cell.get_all_cell_neighbours-585"><span class="linenos">585</span></a><span class="sd">            List of all neighbour cells</span>
</span><span id="Cell.get_all_cell_neighbours-586"><a href="#Cell.get_all_cell_neighbours-586"><span class="linenos">586</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_all_cell_neighbours-587"><a href="#Cell.get_all_cell_neighbours-587"><span class="linenos">587</span></a>        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell.get_all_cell_neighbours-588"><a href="#Cell.get_all_cell_neighbours-588"><span class="linenos">588</span></a>        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">:</span>
</span><span id="Cell.get_all_cell_neighbours-589"><a href="#Cell.get_all_cell_neighbours-589"><span class="linenos">589</span></a>            <span class="k">for</span> <span class="n">sign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">]:</span>
</span><span id="Cell.get_all_cell_neighbours-590"><a href="#Cell.get_all_cell_neighbours-590"><span class="linenos">590</span></a>                <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbour_cells</span><span class="p">[</span><span class="n">direction</span><span class="p">][</span><span class="n">sign</span><span class="p">])</span>
</span><span id="Cell.get_all_cell_neighbours-591"><a href="#Cell.get_all_cell_neighbours-591"><span class="linenos">591</span></a>        <span class="k">return</span> <span class="n">neighbours</span>
</span></pre></div>


            <div class="docstring"><p>Get all neighbour cells in a flat list.</p>

<h2 id="returns">Returns</h2>

<p>list of Cell
    List of all neighbour cells</p>
</div>


                            </div>
                            <div id="Cell.refresh_from_global" class="classattr">
                                        <input id="Cell.refresh_from_global-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">refresh_from_global</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">all_beams</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n"><a href="beam.html#Beam">pyLattice.beam.Beam</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.refresh_from_global-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.refresh_from_global"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.refresh_from_global-593"><a href="#Cell.refresh_from_global-593"><span class="linenos">593</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_from_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_beams</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="s2">&quot;Beam&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.refresh_from_global-594"><a href="#Cell.refresh_from_global-594"><span class="linenos">594</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.refresh_from_global-595"><a href="#Cell.refresh_from_global-595"><span class="linenos">595</span></a><span class="sd">        Rebuild self.beams_cell and self.points_cell from the current lattice state.</span>
</span><span id="Cell.refresh_from_global-596"><a href="#Cell.refresh_from_global-596"><span class="linenos">596</span></a><span class="sd">        Keeps only beams that still declare this cell as a belonging, and derives points from those beams.</span>
</span><span id="Cell.refresh_from_global-597"><a href="#Cell.refresh_from_global-597"><span class="linenos">597</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.refresh_from_global-598"><a href="#Cell.refresh_from_global-598"><span class="linenos">598</span></a>        <span class="n">live_beams</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Cell.refresh_from_global-599"><a href="#Cell.refresh_from_global-599"><span class="linenos">599</span></a>            <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">all_beams</span>
</span><span id="Cell.refresh_from_global-600"><a href="#Cell.refresh_from_global-600"><span class="linenos">600</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">cell_belongings</span>
</span><span id="Cell.refresh_from_global-601"><a href="#Cell.refresh_from_global-601"><span class="linenos">601</span></a>        <span class="p">}</span>
</span><span id="Cell.refresh_from_global-602"><a href="#Cell.refresh_from_global-602"><span class="linenos">602</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span> <span class="o">=</span> <span class="n">live_beams</span>
</span><span id="Cell.refresh_from_global-603"><a href="#Cell.refresh_from_global-603"><span class="linenos">603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">live_beams</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">)}</span>
</span></pre></div>


            <div class="docstring"><p>Rebuild self.beams_cell and self.points_cell from the current lattice state.
Keeps only beams that still declare this cell as a belonging, and derives points from those beams.</p>
</div>


                            </div>
                            <div id="Cell.define_node_order_to_simulate" class="classattr">
                                        <input id="Cell.define_node_order_to_simulate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_node_order_to_simulate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">face_priority</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-09</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.define_node_order_to_simulate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.define_node_order_to_simulate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.define_node_order_to_simulate-610"><a href="#Cell.define_node_order_to_simulate-610"><span class="linenos">610</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-611"><a href="#Cell.define_node_order_to_simulate-611"><span class="linenos">611</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.define_node_order_to_simulate-612"><a href="#Cell.define_node_order_to_simulate-612"><span class="linenos">612</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_node_order_to_simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_priority</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.define_node_order_to_simulate-613"><a href="#Cell.define_node_order_to_simulate-613"><span class="linenos">613</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.define_node_order_to_simulate-614"><a href="#Cell.define_node_order_to_simulate-614"><span class="linenos">614</span></a><span class="sd">        Define a deterministic order for boundary nodes to ensure consistent simulation results.</span>
</span><span id="Cell.define_node_order_to_simulate-615"><a href="#Cell.define_node_order_to_simulate-615"><span class="linenos">615</span></a>
</span><span id="Cell.define_node_order_to_simulate-616"><a href="#Cell.define_node_order_to_simulate-616"><span class="linenos">616</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.define_node_order_to_simulate-617"><a href="#Cell.define_node_order_to_simulate-617"><span class="linenos">617</span></a><span class="sd">        -----------</span>
</span><span id="Cell.define_node_order_to_simulate-618"><a href="#Cell.define_node_order_to_simulate-618"><span class="linenos">618</span></a><span class="sd">        face_priority: Optional[List[str]]</span>
</span><span id="Cell.define_node_order_to_simulate-619"><a href="#Cell.define_node_order_to_simulate-619"><span class="linenos">619</span></a><span class="sd">            List defining the priority order of faces to assign nodes to when they lie on multiple faces.</span>
</span><span id="Cell.define_node_order_to_simulate-620"><a href="#Cell.define_node_order_to_simulate-620"><span class="linenos">620</span></a><span class="sd">            Default is [&quot;Xmin&quot;, &quot;Xmax&quot;, &quot;Ymin&quot;, &quot;Ymax&quot;, &quot;Zmin&quot;, &quot;Zmax&quot;].</span>
</span><span id="Cell.define_node_order_to_simulate-621"><a href="#Cell.define_node_order_to_simulate-621"><span class="linenos">621</span></a>
</span><span id="Cell.define_node_order_to_simulate-622"><a href="#Cell.define_node_order_to_simulate-622"><span class="linenos">622</span></a><span class="sd">        tol: float</span>
</span><span id="Cell.define_node_order_to_simulate-623"><a href="#Cell.define_node_order_to_simulate-623"><span class="linenos">623</span></a><span class="sd">            Tolerance for determining if a point lies on a face. Default is 1e-9.</span>
</span><span id="Cell.define_node_order_to_simulate-624"><a href="#Cell.define_node_order_to_simulate-624"><span class="linenos">624</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.define_node_order_to_simulate-625"><a href="#Cell.define_node_order_to_simulate-625"><span class="linenos">625</span></a>        <span class="k">if</span> <span class="n">face_priority</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.define_node_order_to_simulate-626"><a href="#Cell.define_node_order_to_simulate-626"><span class="linenos">626</span></a>            <span class="n">face_priority</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmax&quot;</span><span class="p">]</span>
</span><span id="Cell.define_node_order_to_simulate-627"><a href="#Cell.define_node_order_to_simulate-627"><span class="linenos">627</span></a>
</span><span id="Cell.define_node_order_to_simulate-628"><a href="#Cell.define_node_order_to_simulate-628"><span class="linenos">628</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="Cell.define_node_order_to_simulate-629"><a href="#Cell.define_node_order_to_simulate-629"><span class="linenos">629</span></a>
</span><span id="Cell.define_node_order_to_simulate-630"><a href="#Cell.define_node_order_to_simulate-630"><span class="linenos">630</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_faces_of_point</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Point</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Cell.define_node_order_to_simulate-631"><a href="#Cell.define_node_order_to_simulate-631"><span class="linenos">631</span></a>            <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell.define_node_order_to_simulate-632"><a href="#Cell.define_node_order_to_simulate-632"><span class="linenos">632</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Xmin&quot;</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-633"><a href="#Cell.define_node_order_to_simulate-633"><span class="linenos">633</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Xmax&quot;</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-634"><a href="#Cell.define_node_order_to_simulate-634"><span class="linenos">634</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Ymin&quot;</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-635"><a href="#Cell.define_node_order_to_simulate-635"><span class="linenos">635</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Ymax&quot;</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-636"><a href="#Cell.define_node_order_to_simulate-636"><span class="linenos">636</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Zmin&quot;</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-637"><a href="#Cell.define_node_order_to_simulate-637"><span class="linenos">637</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span> <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Zmax&quot;</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-638"><a href="#Cell.define_node_order_to_simulate-638"><span class="linenos">638</span></a>            <span class="k">return</span> <span class="n">faces</span>
</span><span id="Cell.define_node_order_to_simulate-639"><a href="#Cell.define_node_order_to_simulate-639"><span class="linenos">639</span></a>
</span><span id="Cell.define_node_order_to_simulate-640"><a href="#Cell.define_node_order_to_simulate-640"><span class="linenos">640</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_inplane_key</span><span class="p">(</span><span class="n">face</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">Point</span><span class="p">):</span>
</span><span id="Cell.define_node_order_to_simulate-641"><a href="#Cell.define_node_order_to_simulate-641"><span class="linenos">641</span></a>            <span class="c1"># Use the two in-plane coordinates as primary sort keys</span>
</span><span id="Cell.define_node_order_to_simulate-642"><a href="#Cell.define_node_order_to_simulate-642"><span class="linenos">642</span></a>            <span class="k">if</span> <span class="n">face</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">):</span>
</span><span id="Cell.define_node_order_to_simulate-643"><a href="#Cell.define_node_order_to_simulate-643"><span class="linenos">643</span></a>                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span>
</span><span id="Cell.define_node_order_to_simulate-644"><a href="#Cell.define_node_order_to_simulate-644"><span class="linenos">644</span></a>            <span class="k">if</span> <span class="n">face</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">):</span>
</span><span id="Cell.define_node_order_to_simulate-645"><a href="#Cell.define_node_order_to_simulate-645"><span class="linenos">645</span></a>                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span>
</span><span id="Cell.define_node_order_to_simulate-646"><a href="#Cell.define_node_order_to_simulate-646"><span class="linenos">646</span></a>            <span class="c1"># Z faces</span>
</span><span id="Cell.define_node_order_to_simulate-647"><a href="#Cell.define_node_order_to_simulate-647"><span class="linenos">647</span></a>            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span>
</span><span id="Cell.define_node_order_to_simulate-648"><a href="#Cell.define_node_order_to_simulate-648"><span class="linenos">648</span></a>
</span><span id="Cell.define_node_order_to_simulate-649"><a href="#Cell.define_node_order_to_simulate-649"><span class="linenos">649</span></a>        <span class="c1"># Unique boundary points by boundary index to avoid duplicates</span>
</span><span id="Cell.define_node_order_to_simulate-650"><a href="#Cell.define_node_order_to_simulate-650"><span class="linenos">650</span></a>        <span class="n">bnd_points</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Point</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Cell.define_node_order_to_simulate-651"><a href="#Cell.define_node_order_to_simulate-651"><span class="linenos">651</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell.define_node_order_to_simulate-652"><a href="#Cell.define_node_order_to_simulate-652"><span class="linenos">652</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">):</span>
</span><span id="Cell.define_node_order_to_simulate-653"><a href="#Cell.define_node_order_to_simulate-653"><span class="linenos">653</span></a>                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.define_node_order_to_simulate-654"><a href="#Cell.define_node_order_to_simulate-654"><span class="linenos">654</span></a>                    <span class="n">bnd_points</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-655"><a href="#Cell.define_node_order_to_simulate-655"><span class="linenos">655</span></a>
</span><span id="Cell.define_node_order_to_simulate-656"><a href="#Cell.define_node_order_to_simulate-656"><span class="linenos">656</span></a>        <span class="c1"># Assign each point to a single face using the given priority</span>
</span><span id="Cell.define_node_order_to_simulate-657"><a href="#Cell.define_node_order_to_simulate-657"><span class="linenos">657</span></a>        <span class="n">face_buckets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">face_priority</span><span class="p">}</span>
</span><span id="Cell.define_node_order_to_simulate-658"><a href="#Cell.define_node_order_to_simulate-658"><span class="linenos">658</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">bnd_points</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Cell.define_node_order_to_simulate-659"><a href="#Cell.define_node_order_to_simulate-659"><span class="linenos">659</span></a>            <span class="n">faces</span> <span class="o">=</span> <span class="n">_faces_of_point</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-660"><a href="#Cell.define_node_order_to_simulate-660"><span class="linenos">660</span></a>            <span class="c1"># pick the first face that appears in face_priority</span>
</span><span id="Cell.define_node_order_to_simulate-661"><a href="#Cell.define_node_order_to_simulate-661"><span class="linenos">661</span></a>            <span class="n">chosen</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">face_priority</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-662"><a href="#Cell.define_node_order_to_simulate-662"><span class="linenos">662</span></a>            <span class="k">if</span> <span class="n">chosen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.define_node_order_to_simulate-663"><a href="#Cell.define_node_order_to_simulate-663"><span class="linenos">663</span></a>                <span class="c1"># Extremely rare: numerical drift puts a node just off all faces; choose nearest</span>
</span><span id="Cell.define_node_order_to_simulate-664"><a href="#Cell.define_node_order_to_simulate-664"><span class="linenos">664</span></a>                <span class="n">dists</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Cell.define_node_order_to_simulate-665"><a href="#Cell.define_node_order_to_simulate-665"><span class="linenos">665</span></a>                    <span class="s2">&quot;Xmin&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">),</span>
</span><span id="Cell.define_node_order_to_simulate-666"><a href="#Cell.define_node_order_to_simulate-666"><span class="linenos">666</span></a>                    <span class="s2">&quot;Xmax&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">),</span>
</span><span id="Cell.define_node_order_to_simulate-667"><a href="#Cell.define_node_order_to_simulate-667"><span class="linenos">667</span></a>                    <span class="s2">&quot;Ymin&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">),</span>
</span><span id="Cell.define_node_order_to_simulate-668"><a href="#Cell.define_node_order_to_simulate-668"><span class="linenos">668</span></a>                    <span class="s2">&quot;Ymax&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">),</span>
</span><span id="Cell.define_node_order_to_simulate-669"><a href="#Cell.define_node_order_to_simulate-669"><span class="linenos">669</span></a>                    <span class="s2">&quot;Zmin&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">),</span>
</span><span id="Cell.define_node_order_to_simulate-670"><a href="#Cell.define_node_order_to_simulate-670"><span class="linenos">670</span></a>                    <span class="s2">&quot;Zmax&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">z1</span><span class="p">),</span>
</span><span id="Cell.define_node_order_to_simulate-671"><a href="#Cell.define_node_order_to_simulate-671"><span class="linenos">671</span></a>                <span class="p">}</span>
</span><span id="Cell.define_node_order_to_simulate-672"><a href="#Cell.define_node_order_to_simulate-672"><span class="linenos">672</span></a>                <span class="n">chosen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">dists</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-673"><a href="#Cell.define_node_order_to_simulate-673"><span class="linenos">673</span></a>            <span class="n">face_buckets</span><span class="p">[</span><span class="n">chosen</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-674"><a href="#Cell.define_node_order_to_simulate-674"><span class="linenos">674</span></a>
</span><span id="Cell.define_node_order_to_simulate-675"><a href="#Cell.define_node_order_to_simulate-675"><span class="linenos">675</span></a>        <span class="n">ordered</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell.define_node_order_to_simulate-676"><a href="#Cell.define_node_order_to_simulate-676"><span class="linenos">676</span></a>        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">face_priority</span><span class="p">:</span>
</span><span id="Cell.define_node_order_to_simulate-677"><a href="#Cell.define_node_order_to_simulate-677"><span class="linenos">677</span></a>            <span class="n">pts</span> <span class="o">=</span> <span class="n">face_buckets</span><span class="p">[</span><span class="n">face</span><span class="p">]</span>
</span><span id="Cell.define_node_order_to_simulate-678"><a href="#Cell.define_node_order_to_simulate-678"><span class="linenos">678</span></a>            <span class="n">pts</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">_inplane_key</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span>
</span><span id="Cell.define_node_order_to_simulate-679"><a href="#Cell.define_node_order_to_simulate-679"><span class="linenos">679</span></a>            <span class="n">ordered</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
</span><span id="Cell.define_node_order_to_simulate-680"><a href="#Cell.define_node_order_to_simulate-680"><span class="linenos">680</span></a>
</span><span id="Cell.define_node_order_to_simulate-681"><a href="#Cell.define_node_order_to_simulate-681"><span class="linenos">681</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span> <span class="o">=</span> <span class="n">ordered</span>
</span></pre></div>


            <div class="docstring"><p>Define a deterministic order for boundary nodes to ensure consistent simulation results.</p>

<h2 id="parameters">Parameters:</h2>

<p>face_priority: Optional[List[str]]
    List defining the priority order of faces to assign nodes to when they lie on multiple faces.
    Default is ["Xmin", "Xmax", "Ymin", "Ymax", "Zmin", "Zmax"].</p>

<p>tol: float
    Tolerance for determining if a point lies on a face. Default is 1e-9.</p>
</div>


                            </div>
                            <div id="Cell.set_reaction_force_on_nodes" class="classattr">
                                        <input id="Cell.set_reaction_force_on_nodes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">set_reaction_force_on_nodes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">reactionForce</span><span class="p">:</span> <span class="nb">list</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.set_reaction_force_on_nodes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.set_reaction_force_on_nodes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.set_reaction_force_on_nodes-683"><a href="#Cell.set_reaction_force_on_nodes-683"><span class="linenos">683</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.set_reaction_force_on_nodes-684"><a href="#Cell.set_reaction_force_on_nodes-684"><span class="linenos">684</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.set_reaction_force_on_nodes-685"><a href="#Cell.set_reaction_force_on_nodes-685"><span class="linenos">685</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_reaction_force_on_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reactionForce</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.set_reaction_force_on_nodes-686"><a href="#Cell.set_reaction_force_on_nodes-686"><span class="linenos">686</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.set_reaction_force_on_nodes-687"><a href="#Cell.set_reaction_force_on_nodes-687"><span class="linenos">687</span></a><span class="sd">        Set reaction force on each boundary node in the established local order.</span>
</span><span id="Cell.set_reaction_force_on_nodes-688"><a href="#Cell.set_reaction_force_on_nodes-688"><span class="linenos">688</span></a>
</span><span id="Cell.set_reaction_force_on_nodes-689"><a href="#Cell.set_reaction_force_on_nodes-689"><span class="linenos">689</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.set_reaction_force_on_nodes-690"><a href="#Cell.set_reaction_force_on_nodes-690"><span class="linenos">690</span></a><span class="sd">        -----------</span>
</span><span id="Cell.set_reaction_force_on_nodes-691"><a href="#Cell.set_reaction_force_on_nodes-691"><span class="linenos">691</span></a><span class="sd">        reactionForce: list</span>
</span><span id="Cell.set_reaction_force_on_nodes-692"><a href="#Cell.set_reaction_force_on_nodes-692"><span class="linenos">692</span></a><span class="sd">            List of reaction force vectors corresponding to each boundary node.</span>
</span><span id="Cell.set_reaction_force_on_nodes-693"><a href="#Cell.set_reaction_force_on_nodes-693"><span class="linenos">693</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.set_reaction_force_on_nodes-694"><a href="#Cell.set_reaction_force_on_nodes-694"><span class="linenos">694</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">:</span>
</span><span id="Cell.set_reaction_force_on_nodes-695"><a href="#Cell.set_reaction_force_on_nodes-695"><span class="linenos">695</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Boundary node order not defined. Call define_node_order_to_simulate() first.&quot;</span><span class="p">)</span>
</span><span id="Cell.set_reaction_force_on_nodes-696"><a href="#Cell.set_reaction_force_on_nodes-696"><span class="linenos">696</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactionForce</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">):</span>
</span><span id="Cell.set_reaction_force_on_nodes-697"><a href="#Cell.set_reaction_force_on_nodes-697"><span class="linenos">697</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of reaction force entries: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">reactionForce</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs. boundary nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Cell.set_reaction_force_on_nodes-698"><a href="#Cell.set_reaction_force_on_nodes-698"><span class="linenos">698</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough reaction force entries for boundary nodes.&quot;</span><span class="p">)</span>
</span><span id="Cell.set_reaction_force_on_nodes-699"><a href="#Cell.set_reaction_force_on_nodes-699"><span class="linenos">699</span></a>
</span><span id="Cell.set_reaction_force_on_nodes-700"><a href="#Cell.set_reaction_force_on_nodes-700"><span class="linenos">700</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">):</span>
</span><span id="Cell.set_reaction_force_on_nodes-701"><a href="#Cell.set_reaction_force_on_nodes-701"><span class="linenos">701</span></a>            <span class="n">node</span><span class="o">.</span><span class="n">set_reaction_force</span><span class="p">(</span><span class="n">reactionForce</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Set reaction force on each boundary node in the established local order.</p>

<h2 id="parameters">Parameters:</h2>

<p>reactionForce: list
    List of reaction force vectors corresponding to each boundary node.</p>
</div>


                            </div>
                            <div id="Cell.get_displacement_at_nodes" class="classattr">
                                        <input id="Cell.get_displacement_at_nodes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_displacement_at_nodes</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">nodeList</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n"><a href="point.html#Point">pyLattice.point.Point</a></span><span class="p">],</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n"><a href="point.html#Point">pyLattice.point.Point</a></span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="Cell.get_displacement_at_nodes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_displacement_at_nodes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_displacement_at_nodes-703"><a href="#Cell.get_displacement_at_nodes-703"><span class="linenos">703</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.get_displacement_at_nodes-704"><a href="#Cell.get_displacement_at_nodes-704"><span class="linenos">704</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_displacement_at_nodes-705"><a href="#Cell.get_displacement_at_nodes-705"><span class="linenos">705</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_displacement_at_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodeList</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">],</span> <span class="s2">&quot;OrderedDict[int, Point]&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell.get_displacement_at_nodes-706"><a href="#Cell.get_displacement_at_nodes-706"><span class="linenos">706</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_displacement_at_nodes-707"><a href="#Cell.get_displacement_at_nodes-707"><span class="linenos">707</span></a><span class="sd">        Return displacement vectors ordered consistently with the provided local list/dict of Points.</span>
</span><span id="Cell.get_displacement_at_nodes-708"><a href="#Cell.get_displacement_at_nodes-708"><span class="linenos">708</span></a>
</span><span id="Cell.get_displacement_at_nodes-709"><a href="#Cell.get_displacement_at_nodes-709"><span class="linenos">709</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.get_displacement_at_nodes-710"><a href="#Cell.get_displacement_at_nodes-710"><span class="linenos">710</span></a><span class="sd">        -----------</span>
</span><span id="Cell.get_displacement_at_nodes-711"><a href="#Cell.get_displacement_at_nodes-711"><span class="linenos">711</span></a><span class="sd">        nodeList: list or OrderedDict</span>
</span><span id="Cell.get_displacement_at_nodes-712"><a href="#Cell.get_displacement_at_nodes-712"><span class="linenos">712</span></a><span class="sd">            List or OrderedDict of Point objects representing the nodes.</span>
</span><span id="Cell.get_displacement_at_nodes-713"><a href="#Cell.get_displacement_at_nodes-713"><span class="linenos">713</span></a>
</span><span id="Cell.get_displacement_at_nodes-714"><a href="#Cell.get_displacement_at_nodes-714"><span class="linenos">714</span></a><span class="sd">        Returns:</span>
</span><span id="Cell.get_displacement_at_nodes-715"><a href="#Cell.get_displacement_at_nodes-715"><span class="linenos">715</span></a><span class="sd">        --------</span>
</span><span id="Cell.get_displacement_at_nodes-716"><a href="#Cell.get_displacement_at_nodes-716"><span class="linenos">716</span></a><span class="sd">        list</span>
</span><span id="Cell.get_displacement_at_nodes-717"><a href="#Cell.get_displacement_at_nodes-717"><span class="linenos">717</span></a><span class="sd">            List of displacement vectors for the nodes.</span>
</span><span id="Cell.get_displacement_at_nodes-718"><a href="#Cell.get_displacement_at_nodes-718"><span class="linenos">718</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_displacement_at_nodes-719"><a href="#Cell.get_displacement_at_nodes-719"><span class="linenos">719</span></a>        <span class="n">displacementList</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell.get_displacement_at_nodes-720"><a href="#Cell.get_displacement_at_nodes-720"><span class="linenos">720</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodeList</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Cell.get_displacement_at_nodes-721"><a href="#Cell.get_displacement_at_nodes-721"><span class="linenos">721</span></a>            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodeList</span><span class="p">:</span>
</span><span id="Cell.get_displacement_at_nodes-722"><a href="#Cell.get_displacement_at_nodes-722"><span class="linenos">722</span></a>                <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
</span><span id="Cell.get_displacement_at_nodes-723"><a href="#Cell.get_displacement_at_nodes-723"><span class="linenos">723</span></a>                    <span class="n">displacementList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">)</span>
</span><span id="Cell.get_displacement_at_nodes-724"><a href="#Cell.get_displacement_at_nodes-724"><span class="linenos">724</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># OrderedDict-like</span>
</span><span id="Cell.get_displacement_at_nodes-725"><a href="#Cell.get_displacement_at_nodes-725"><span class="linenos">725</span></a>            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodeList</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Cell.get_displacement_at_nodes-726"><a href="#Cell.get_displacement_at_nodes-726"><span class="linenos">726</span></a>                <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
</span><span id="Cell.get_displacement_at_nodes-727"><a href="#Cell.get_displacement_at_nodes-727"><span class="linenos">727</span></a>                    <span class="n">displacementList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">)</span>
</span><span id="Cell.get_displacement_at_nodes-728"><a href="#Cell.get_displacement_at_nodes-728"><span class="linenos">728</span></a>        <span class="k">return</span> <span class="n">displacementList</span>
</span></pre></div>


            <div class="docstring"><p>Return displacement vectors ordered consistently with the provided local list/dict of Points.</p>

<h2 id="parameters">Parameters:</h2>

<p>nodeList: list or OrderedDict
    List or OrderedDict of Point objects representing the nodes.</p>

<h2 id="returns">Returns:</h2>

<p>list
    List of displacement vectors for the nodes.</p>
</div>


                            </div>
                            <div id="Cell.set_displacement_at_boundary_nodes" class="classattr">
                                        <input id="Cell.set_displacement_at_boundary_nodes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">set_displacement_at_boundary_nodes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">displacementArray</span><span class="p">:</span> <span class="nb">list</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.set_displacement_at_boundary_nodes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.set_displacement_at_boundary_nodes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.set_displacement_at_boundary_nodes-730"><a href="#Cell.set_displacement_at_boundary_nodes-730"><span class="linenos">730</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-731"><a href="#Cell.set_displacement_at_boundary_nodes-731"><span class="linenos">731</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-732"><a href="#Cell.set_displacement_at_boundary_nodes-732"><span class="linenos">732</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_displacement_at_boundary_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displacementArray</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-733"><a href="#Cell.set_displacement_at_boundary_nodes-733"><span class="linenos">733</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-734"><a href="#Cell.set_displacement_at_boundary_nodes-734"><span class="linenos">734</span></a><span class="sd">        Set displacement at nodes.</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-735"><a href="#Cell.set_displacement_at_boundary_nodes-735"><span class="linenos">735</span></a>
</span><span id="Cell.set_displacement_at_boundary_nodes-736"><a href="#Cell.set_displacement_at_boundary_nodes-736"><span class="linenos">736</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-737"><a href="#Cell.set_displacement_at_boundary_nodes-737"><span class="linenos">737</span></a><span class="sd">        ------------</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-738"><a href="#Cell.set_displacement_at_boundary_nodes-738"><span class="linenos">738</span></a><span class="sd">        displacementArray: list or array-like</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-739"><a href="#Cell.set_displacement_at_boundary_nodes-739"><span class="linenos">739</span></a><span class="sd">            Flattened array of displacement values.</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-740"><a href="#Cell.set_displacement_at_boundary_nodes-740"><span class="linenos">740</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-741"><a href="#Cell.set_displacement_at_boundary_nodes-741"><span class="linenos">741</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-742"><a href="#Cell.set_displacement_at_boundary_nodes-742"><span class="linenos">742</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Non-zero displacements:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">displacementArray</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">displacementArray</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-743"><a href="#Cell.set_displacement_at_boundary_nodes-743"><span class="linenos">743</span></a>
</span><span id="Cell.set_displacement_at_boundary_nodes-744"><a href="#Cell.set_displacement_at_boundary_nodes-744"><span class="linenos">744</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-745"><a href="#Cell.set_displacement_at_boundary_nodes-745"><span class="linenos">745</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-746"><a href="#Cell.set_displacement_at_boundary_nodes-746"><span class="linenos">746</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-747"><a href="#Cell.set_displacement_at_boundary_nodes-747"><span class="linenos">747</span></a>                    <span class="k">continue</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-748"><a href="#Cell.set_displacement_at_boundary_nodes-748"><span class="linenos">748</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-749"><a href="#Cell.set_displacement_at_boundary_nodes-749"><span class="linenos">749</span></a>                    <span class="n">gi</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">global_free_DOF_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-750"><a href="#Cell.set_displacement_at_boundary_nodes-750"><span class="linenos">750</span></a>                    <span class="k">if</span> <span class="n">gi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.set_displacement_at_boundary_nodes-751"><a href="#Cell.set_displacement_at_boundary_nodes-751"><span class="linenos">751</span></a>                        <span class="n">point</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">displacementArray</span><span class="p">[</span><span class="n">gi</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Set displacement at nodes.</p>

<h2 id="parameters">Parameters:</h2>

<p>displacementArray: list or array-like
    Flattened array of displacement values.</p>
</div>


                            </div>
                            <div id="Cell.build_coupling_operator" class="classattr">
                                        <input id="Cell.build_coupling_operator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">build_coupling_operator</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">nb_free_DOF</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.build_coupling_operator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.build_coupling_operator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.build_coupling_operator-753"><a href="#Cell.build_coupling_operator-753"><span class="linenos">753</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.build_coupling_operator-754"><a href="#Cell.build_coupling_operator-754"><span class="linenos">754</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.build_coupling_operator-755"><a href="#Cell.build_coupling_operator-755"><span class="linenos">755</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build_coupling_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_free_DOF</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.build_coupling_operator-756"><a href="#Cell.build_coupling_operator-756"><span class="linenos">756</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.build_coupling_operator-757"><a href="#Cell.build_coupling_operator-757"><span class="linenos">757</span></a><span class="sd">        Build the coupling operator B using the deterministic local boundary-node order.</span>
</span><span id="Cell.build_coupling_operator-758"><a href="#Cell.build_coupling_operator-758"><span class="linenos">758</span></a>
</span><span id="Cell.build_coupling_operator-759"><a href="#Cell.build_coupling_operator-759"><span class="linenos">759</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.build_coupling_operator-760"><a href="#Cell.build_coupling_operator-760"><span class="linenos">760</span></a><span class="sd">        -----------</span>
</span><span id="Cell.build_coupling_operator-761"><a href="#Cell.build_coupling_operator-761"><span class="linenos">761</span></a><span class="sd">        nb_free_DOF: int</span>
</span><span id="Cell.build_coupling_operator-762"><a href="#Cell.build_coupling_operator-762"><span class="linenos">762</span></a><span class="sd">            Total number of free degrees of freedom in the global system.</span>
</span><span id="Cell.build_coupling_operator-763"><a href="#Cell.build_coupling_operator-763"><span class="linenos">763</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.build_coupling_operator-764"><a href="#Cell.build_coupling_operator-764"><span class="linenos">764</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">:</span>
</span><span id="Cell.build_coupling_operator-765"><a href="#Cell.build_coupling_operator-765"><span class="linenos">765</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">define_node_order_to_simulate</span><span class="p">()</span>
</span><span id="Cell.build_coupling_operator-766"><a href="#Cell.build_coupling_operator-766"><span class="linenos">766</span></a>
</span><span id="Cell.build_coupling_operator-767"><a href="#Cell.build_coupling_operator-767"><span class="linenos">767</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">coo_matrix</span>
</span><span id="Cell.build_coupling_operator-768"><a href="#Cell.build_coupling_operator-768"><span class="linenos">768</span></a>        <span class="n">data</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Cell.build_coupling_operator-769"><a href="#Cell.build_coupling_operator-769"><span class="linenos">769</span></a>
</span><span id="Cell.build_coupling_operator-770"><a href="#Cell.build_coupling_operator-770"><span class="linenos">770</span></a>        <span class="c1"># Map boundary index</span>
</span><span id="Cell.build_coupling_operator-771"><a href="#Cell.build_coupling_operator-771"><span class="linenos">771</span></a>        <span class="k">for</span> <span class="n">local_idx</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">):</span>
</span><span id="Cell.build_coupling_operator-772"><a href="#Cell.build_coupling_operator-772"><span class="linenos">772</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span><span id="Cell.build_coupling_operator-773"><a href="#Cell.build_coupling_operator-773"><span class="linenos">773</span></a>                <span class="n">gi</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">global_free_DOF_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Cell.build_coupling_operator-774"><a href="#Cell.build_coupling_operator-774"><span class="linenos">774</span></a>                <span class="k">if</span> <span class="n">gi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.build_coupling_operator-775"><a href="#Cell.build_coupling_operator-775"><span class="linenos">775</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Cell.build_coupling_operator-776"><a href="#Cell.build_coupling_operator-776"><span class="linenos">776</span></a>                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span>
</span><span id="Cell.build_coupling_operator-777"><a href="#Cell.build_coupling_operator-777"><span class="linenos">777</span></a>                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_idx</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
</span><span id="Cell.build_coupling_operator-778"><a href="#Cell.build_coupling_operator-778"><span class="linenos">778</span></a>
</span><span id="Cell.build_coupling_operator-779"><a href="#Cell.build_coupling_operator-779"><span class="linenos">779</span></a>        <span class="n">nbBndDOFloc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_order_simulation</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span>
</span><span id="Cell.build_coupling_operator-780"><a href="#Cell.build_coupling_operator-780"><span class="linenos">780</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nb_free_DOF</span><span class="p">,</span> <span class="n">nbBndDOFloc</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Build the coupling operator B using the deterministic local boundary-node order.</p>

<h2 id="parameters">Parameters:</h2>

<p>nb_free_DOF: int
    Total number of free degrees of freedom in the global system.</p>
</div>


                            </div>
                            <div id="Cell.build_local_preconditioner" class="classattr">
                                        <input id="Cell.build_local_preconditioner-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">build_local_preconditioner</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">schur_mean</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.build_local_preconditioner-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.build_local_preconditioner"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.build_local_preconditioner-782"><a href="#Cell.build_local_preconditioner-782"><span class="linenos">782</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.build_local_preconditioner-783"><a href="#Cell.build_local_preconditioner-783"><span class="linenos">783</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.build_local_preconditioner-784"><a href="#Cell.build_local_preconditioner-784"><span class="linenos">784</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build_local_preconditioner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schur_mean</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.build_local_preconditioner-785"><a href="#Cell.build_local_preconditioner-785"><span class="linenos">785</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.build_local_preconditioner-786"><a href="#Cell.build_local_preconditioner-786"><span class="linenos">786</span></a><span class="sd">        Build the local preconditioner matrix B^T * S * B</span>
</span><span id="Cell.build_local_preconditioner-787"><a href="#Cell.build_local_preconditioner-787"><span class="linenos">787</span></a>
</span><span id="Cell.build_local_preconditioner-788"><a href="#Cell.build_local_preconditioner-788"><span class="linenos">788</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.build_local_preconditioner-789"><a href="#Cell.build_local_preconditioner-789"><span class="linenos">789</span></a><span class="sd">        -----------</span>
</span><span id="Cell.build_local_preconditioner-790"><a href="#Cell.build_local_preconditioner-790"><span class="linenos">790</span></a><span class="sd">        schur_mean: array-like or None</span>
</span><span id="Cell.build_local_preconditioner-791"><a href="#Cell.build_local_preconditioner-791"><span class="linenos">791</span></a><span class="sd">            Schur complement matrix to use. If None, uses self.schur_complement.</span>
</span><span id="Cell.build_local_preconditioner-792"><a href="#Cell.build_local_preconditioner-792"><span class="linenos">792</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.build_local_preconditioner-793"><a href="#Cell.build_local_preconditioner-793"><span class="linenos">793</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">coo_matrix</span><span class="p">,</span> <span class="n">csc_matrix</span><span class="p">,</span> <span class="n">isspmatrix</span>
</span><span id="Cell.build_local_preconditioner-794"><a href="#Cell.build_local_preconditioner-794"><span class="linenos">794</span></a>
</span><span id="Cell.build_local_preconditioner-795"><a href="#Cell.build_local_preconditioner-795"><span class="linenos">795</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.build_local_preconditioner-796"><a href="#Cell.build_local_preconditioner-796"><span class="linenos">796</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coupling matrix has not been built yet. Please build it first.&quot;</span><span class="p">)</span>
</span><span id="Cell.build_local_preconditioner-797"><a href="#Cell.build_local_preconditioner-797"><span class="linenos">797</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Cell.build_local_preconditioner-798"><a href="#Cell.build_local_preconditioner-798"><span class="linenos">798</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of B matrix&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Cell.build_local_preconditioner-799"><a href="#Cell.build_local_preconditioner-799"><span class="linenos">799</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of Schur matrix&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span><span class="p">))</span>
</span><span id="Cell.build_local_preconditioner-800"><a href="#Cell.build_local_preconditioner-800"><span class="linenos">800</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible dimensions between the coupling matrix and the Schur matrix.&quot;</span><span class="p">)</span>
</span><span id="Cell.build_local_preconditioner-801"><a href="#Cell.build_local_preconditioner-801"><span class="linenos">801</span></a>
</span><span id="Cell.build_local_preconditioner-802"><a href="#Cell.build_local_preconditioner-802"><span class="linenos">802</span></a>        <span class="c1"># Ensure sparse Schur complement to avoid dense products</span>
</span><span id="Cell.build_local_preconditioner-803"><a href="#Cell.build_local_preconditioner-803"><span class="linenos">803</span></a>        <span class="k">if</span> <span class="n">schur_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.build_local_preconditioner-804"><a href="#Cell.build_local_preconditioner-804"><span class="linenos">804</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schur_complement</span>
</span><span id="Cell.build_local_preconditioner-805"><a href="#Cell.build_local_preconditioner-805"><span class="linenos">805</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.build_local_preconditioner-806"><a href="#Cell.build_local_preconditioner-806"><span class="linenos">806</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">schur_mean</span>
</span><span id="Cell.build_local_preconditioner-807"><a href="#Cell.build_local_preconditioner-807"><span class="linenos">807</span></a>
</span><span id="Cell.build_local_preconditioner-808"><a href="#Cell.build_local_preconditioner-808"><span class="linenos">808</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">isspmatrix</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
</span><span id="Cell.build_local_preconditioner-809"><a href="#Cell.build_local_preconditioner-809"><span class="linenos">809</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="Cell.build_local_preconditioner-810"><a href="#Cell.build_local_preconditioner-810"><span class="linenos">810</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Cell.build_local_preconditioner-811"><a href="#Cell.build_local_preconditioner-811"><span class="linenos">811</span></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
</span><span id="Cell.build_local_preconditioner-812"><a href="#Cell.build_local_preconditioner-812"><span class="linenos">812</span></a>
</span><span id="Cell.build_local_preconditioner-813"><a href="#Cell.build_local_preconditioner-813"><span class="linenos">813</span></a>        <span class="n">B_csr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
</span><span id="Cell.build_local_preconditioner-814"><a href="#Cell.build_local_preconditioner-814"><span class="linenos">814</span></a>        <span class="n">active_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">B_csr</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Cell.build_local_preconditioner-815"><a href="#Cell.build_local_preconditioner-815"><span class="linenos">815</span></a>        <span class="n">n_global</span> <span class="o">=</span> <span class="n">B_csr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell.build_local_preconditioner-816"><a href="#Cell.build_local_preconditioner-816"><span class="linenos">816</span></a>
</span><span id="Cell.build_local_preconditioner-817"><a href="#Cell.build_local_preconditioner-817"><span class="linenos">817</span></a>        <span class="k">if</span> <span class="n">active_rows</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Cell.build_local_preconditioner-818"><a href="#Cell.build_local_preconditioner-818"><span class="linenos">818</span></a>            <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">n_global</span><span class="p">,</span> <span class="n">n_global</span><span class="p">))</span>
</span><span id="Cell.build_local_preconditioner-819"><a href="#Cell.build_local_preconditioner-819"><span class="linenos">819</span></a>
</span><span id="Cell.build_local_preconditioner-820"><a href="#Cell.build_local_preconditioner-820"><span class="linenos">820</span></a>        <span class="n">subB</span> <span class="o">=</span> <span class="n">B_csr</span><span class="p">[</span><span class="n">active_rows</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (r x nb)</span>
</span><span id="Cell.build_local_preconditioner-821"><a href="#Cell.build_local_preconditioner-821"><span class="linenos">821</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">S</span> <span class="o">@</span> <span class="n">subB</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>  <span class="c1"># (nb x r)</span>
</span><span id="Cell.build_local_preconditioner-822"><a href="#Cell.build_local_preconditioner-822"><span class="linenos">822</span></a>        <span class="n">local_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">subB</span> <span class="o">@</span> <span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>  <span class="c1"># (r x r)</span>
</span><span id="Cell.build_local_preconditioner-823"><a href="#Cell.build_local_preconditioner-823"><span class="linenos">823</span></a>
</span><span id="Cell.build_local_preconditioner-824"><a href="#Cell.build_local_preconditioner-824"><span class="linenos">824</span></a>        <span class="c1"># Map back to absolute global indices without creating a huge intermediate</span>
</span><span id="Cell.build_local_preconditioner-825"><a href="#Cell.build_local_preconditioner-825"><span class="linenos">825</span></a>        <span class="n">row_idx</span> <span class="o">=</span> <span class="n">active_rows</span><span class="p">[</span><span class="n">local_block</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>
</span><span id="Cell.build_local_preconditioner-826"><a href="#Cell.build_local_preconditioner-826"><span class="linenos">826</span></a>        <span class="n">col_idx</span> <span class="o">=</span> <span class="n">active_rows</span><span class="p">[</span><span class="n">local_block</span><span class="o">.</span><span class="n">col</span><span class="p">]</span>
</span><span id="Cell.build_local_preconditioner-827"><a href="#Cell.build_local_preconditioner-827"><span class="linenos">827</span></a>
</span><span id="Cell.build_local_preconditioner-828"><a href="#Cell.build_local_preconditioner-828"><span class="linenos">828</span></a>        <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">local_block</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_global</span><span class="p">,</span> <span class="n">n_global</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Build the local preconditioner matrix B^T * S * B</p>

<h2 id="parameters">Parameters:</h2>

<p>schur_mean: array-like or None
    Schur complement matrix to use. If None, uses self.schur_complement.</p>
</div>


                            </div>
                            <div id="Cell.get_number_boundary_nodes" class="classattr">
                                        <input id="Cell.get_number_boundary_nodes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_number_boundary_nodes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="Cell.get_number_boundary_nodes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_number_boundary_nodes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_number_boundary_nodes-833"><a href="#Cell.get_number_boundary_nodes-833"><span class="linenos">833</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.get_number_boundary_nodes-834"><a href="#Cell.get_number_boundary_nodes-834"><span class="linenos">834</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_number_boundary_nodes-835"><a href="#Cell.get_number_boundary_nodes-835"><span class="linenos">835</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_boundary_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Cell.get_number_boundary_nodes-836"><a href="#Cell.get_number_boundary_nodes-836"><span class="linenos">836</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_number_boundary_nodes-837"><a href="#Cell.get_number_boundary_nodes-837"><span class="linenos">837</span></a><span class="sd">        Get the number of unique boundary nodes in the cell.</span>
</span><span id="Cell.get_number_boundary_nodes-838"><a href="#Cell.get_number_boundary_nodes-838"><span class="linenos">838</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_number_boundary_nodes-839"><a href="#Cell.get_number_boundary_nodes-839"><span class="linenos">839</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">({</span><span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">})</span>
</span></pre></div>


            <div class="docstring"><p>Get the number of unique boundary nodes in the cell.</p>
</div>


                            </div>
                            <div id="Cell.get_internal_energy" class="classattr">
                                        <input id="Cell.get_internal_energy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_internal_energy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Cell.get_internal_energy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_internal_energy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_internal_energy-841"><a href="#Cell.get_internal_energy-841"><span class="linenos">841</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.get_internal_energy-842"><a href="#Cell.get_internal_energy-842"><span class="linenos">842</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_internal_energy-843"><a href="#Cell.get_internal_energy-843"><span class="linenos">843</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_internal_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell.get_internal_energy-844"><a href="#Cell.get_internal_energy-844"><span class="linenos">844</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_internal_energy-845"><a href="#Cell.get_internal_energy-845"><span class="linenos">845</span></a><span class="sd">        Get cell internal energy from all boundary points</span>
</span><span id="Cell.get_internal_energy-846"><a href="#Cell.get_internal_energy-846"><span class="linenos">846</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_internal_energy-847"><a href="#Cell.get_internal_energy-847"><span class="linenos">847</span></a>        <span class="n">min_energy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e-12</span>
</span><span id="Cell.get_internal_energy-848"><a href="#Cell.get_internal_energy-848"><span class="linenos">848</span></a>        <span class="n">internalEnergy</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell.get_internal_energy-849"><a href="#Cell.get_internal_energy-849"><span class="linenos">849</span></a>        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span>
</span><span id="Cell.get_internal_energy-850"><a href="#Cell.get_internal_energy-850"><span class="linenos">850</span></a>            <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.get_internal_energy-851"><a href="#Cell.get_internal_energy-851"><span class="linenos">851</span></a>                <span class="n">pointEnergy</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">calculate_point_energy</span><span class="p">()</span>
</span><span id="Cell.get_internal_energy-852"><a href="#Cell.get_internal_energy-852"><span class="linenos">852</span></a>                <span class="k">if</span> <span class="n">pointEnergy</span> <span class="o">&lt;</span> <span class="n">min_energy</span><span class="p">:</span>
</span><span id="Cell.get_internal_energy-853"><a href="#Cell.get_internal_energy-853"><span class="linenos">853</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Negative energy = &quot;</span><span class="p">,</span> <span class="n">pointEnergy</span><span class="p">)</span>
</span><span id="Cell.get_internal_energy-854"><a href="#Cell.get_internal_energy-854"><span class="linenos">854</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Negative energy detected at point with index &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span><span class="p">))</span>
</span><span id="Cell.get_internal_energy-855"><a href="#Cell.get_internal_energy-855"><span class="linenos">855</span></a>                <span class="n">internalEnergy</span> <span class="o">+=</span> <span class="n">pointEnergy</span>
</span><span id="Cell.get_internal_energy-856"><a href="#Cell.get_internal_energy-856"><span class="linenos">856</span></a>        <span class="k">return</span> <span class="n">internalEnergy</span>
</span></pre></div>


            <div class="docstring"><p>Get cell internal energy from all boundary points</p>
</div>


                            </div>
                            <div id="Cell.get_displacement_data" class="classattr">
                                        <input id="Cell.get_displacement_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_displacement_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="Cell.get_displacement_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_displacement_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_displacement_data-858"><a href="#Cell.get_displacement_data-858"><span class="linenos">858</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.get_displacement_data-859"><a href="#Cell.get_displacement_data-859"><span class="linenos">859</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_displacement_data-860"><a href="#Cell.get_displacement_data-860"><span class="linenos">860</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_displacement_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Cell.get_displacement_data-861"><a href="#Cell.get_displacement_data-861"><span class="linenos">861</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_displacement_data-862"><a href="#Cell.get_displacement_data-862"><span class="linenos">862</span></a><span class="sd">        Build and return displacement data on cell for dataset generation</span>
</span><span id="Cell.get_displacement_data-863"><a href="#Cell.get_displacement_data-863"><span class="linenos">863</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_displacement_data-864"><a href="#Cell.get_displacement_data-864"><span class="linenos">864</span></a>        <span class="n">allBoundaryDisplacementData</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell.get_displacement_data-865"><a href="#Cell.get_displacement_data-865"><span class="linenos">865</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell.get_displacement_data-866"><a href="#Cell.get_displacement_data-866"><span class="linenos">866</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="Cell.get_displacement_data-867"><a href="#Cell.get_displacement_data-867"><span class="linenos">867</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.get_displacement_data-868"><a href="#Cell.get_displacement_data-868"><span class="linenos">868</span></a>                    <span class="n">allBoundaryDisplacementData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">)</span>
</span><span id="Cell.get_displacement_data-869"><a href="#Cell.get_displacement_data-869"><span class="linenos">869</span></a>        <span class="k">return</span> <span class="n">allBoundaryDisplacementData</span>
</span></pre></div>


            <div class="docstring"><p>Build and return displacement data on cell for dataset generation</p>
</div>


                            </div>
                            <div id="Cell.get_number_nodes_at_boundary" class="classattr">
                                        <input id="Cell.get_number_nodes_at_boundary-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;simulation&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_number_nodes_at_boundary</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Cell.get_number_nodes_at_boundary-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_number_nodes_at_boundary"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_number_nodes_at_boundary-871"><a href="#Cell.get_number_nodes_at_boundary-871"><span class="linenos">871</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;simulation&quot;</span><span class="p">)</span>
</span><span id="Cell.get_number_nodes_at_boundary-872"><a href="#Cell.get_number_nodes_at_boundary-872"><span class="linenos">872</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_number_nodes_at_boundary-873"><a href="#Cell.get_number_nodes_at_boundary-873"><span class="linenos">873</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_nodes_at_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell.get_number_nodes_at_boundary-874"><a href="#Cell.get_number_nodes_at_boundary-874"><span class="linenos">874</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_number_nodes_at_boundary-875"><a href="#Cell.get_number_nodes_at_boundary-875"><span class="linenos">875</span></a><span class="sd">        Get the number of nodes at the boundary</span>
</span><span id="Cell.get_number_nodes_at_boundary-876"><a href="#Cell.get_number_nodes_at_boundary-876"><span class="linenos">876</span></a>
</span><span id="Cell.get_number_nodes_at_boundary-877"><a href="#Cell.get_number_nodes_at_boundary-877"><span class="linenos">877</span></a><span class="sd">        Returns:</span>
</span><span id="Cell.get_number_nodes_at_boundary-878"><a href="#Cell.get_number_nodes_at_boundary-878"><span class="linenos">878</span></a><span class="sd">        --------</span>
</span><span id="Cell.get_number_nodes_at_boundary-879"><a href="#Cell.get_number_nodes_at_boundary-879"><span class="linenos">879</span></a><span class="sd">        int</span>
</span><span id="Cell.get_number_nodes_at_boundary-880"><a href="#Cell.get_number_nodes_at_boundary-880"><span class="linenos">880</span></a><span class="sd">            Number of nodes at the boundary</span>
</span><span id="Cell.get_number_nodes_at_boundary-881"><a href="#Cell.get_number_nodes_at_boundary-881"><span class="linenos">881</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_number_nodes_at_boundary-882"><a href="#Cell.get_number_nodes_at_boundary-882"><span class="linenos">882</span></a>        <span class="n">counterNodes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell.get_number_nodes_at_boundary-883"><a href="#Cell.get_number_nodes_at_boundary-883"><span class="linenos">883</span></a>        <span class="n">nodeAlreadyCounted</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell.get_number_nodes_at_boundary-884"><a href="#Cell.get_number_nodes_at_boundary-884"><span class="linenos">884</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell.get_number_nodes_at_boundary-885"><a href="#Cell.get_number_nodes_at_boundary-885"><span class="linenos">885</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="Cell.get_number_nodes_at_boundary-886"><a href="#Cell.get_number_nodes_at_boundary-886"><span class="linenos">886</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodeAlreadyCounted</span><span class="p">:</span>
</span><span id="Cell.get_number_nodes_at_boundary-887"><a href="#Cell.get_number_nodes_at_boundary-887"><span class="linenos">887</span></a>                    <span class="n">counterNodes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Cell.get_number_nodes_at_boundary-888"><a href="#Cell.get_number_nodes_at_boundary-888"><span class="linenos">888</span></a>                    <span class="n">nodeAlreadyCounted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span><span class="p">)</span>
</span><span id="Cell.get_number_nodes_at_boundary-889"><a href="#Cell.get_number_nodes_at_boundary-889"><span class="linenos">889</span></a>        <span class="k">return</span> <span class="n">counterNodes</span>
</span></pre></div>


            <div class="docstring"><p>Get the number of nodes at the boundary</p>

<h2 id="returns">Returns:</h2>

<p>int
    Number of nodes at the boundary</p>
</div>


                            </div>
                            <div id="Cell.change_beam_radius" class="classattr">
                                        <input id="Cell.change_beam_radius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;optimization&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">change_beam_radius</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">new_radius</span><span class="p">:</span> <span class="nb">list</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Cell.change_beam_radius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.change_beam_radius"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.change_beam_radius-895"><a href="#Cell.change_beam_radius-895"><span class="linenos">895</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell.change_beam_radius-896"><a href="#Cell.change_beam_radius-896"><span class="linenos">896</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.change_beam_radius-897"><a href="#Cell.change_beam_radius-897"><span class="linenos">897</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">change_beam_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_radius</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.change_beam_radius-898"><a href="#Cell.change_beam_radius-898"><span class="linenos">898</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.change_beam_radius-899"><a href="#Cell.change_beam_radius-899"><span class="linenos">899</span></a><span class="sd">        WARNING: BEAM MOD IS NOT WORKING</span>
</span><span id="Cell.change_beam_radius-900"><a href="#Cell.change_beam_radius-900"><span class="linenos">900</span></a><span class="sd">        Change beam radii in the cell</span>
</span><span id="Cell.change_beam_radius-901"><a href="#Cell.change_beam_radius-901"><span class="linenos">901</span></a>
</span><span id="Cell.change_beam_radius-902"><a href="#Cell.change_beam_radius-902"><span class="linenos">902</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.change_beam_radius-903"><a href="#Cell.change_beam_radius-903"><span class="linenos">903</span></a><span class="sd">        -----------</span>
</span><span id="Cell.change_beam_radius-904"><a href="#Cell.change_beam_radius-904"><span class="linenos">904</span></a><span class="sd">        newRadius: list</span>
</span><span id="Cell.change_beam_radius-905"><a href="#Cell.change_beam_radius-905"><span class="linenos">905</span></a><span class="sd">            beam radii wanted to assign</span>
</span><span id="Cell.change_beam_radius-906"><a href="#Cell.change_beam_radius-906"><span class="linenos">906</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.change_beam_radius-907"><a href="#Cell.change_beam_radius-907"><span class="linenos">907</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Cell.change_beam_radius-908"><a href="#Cell.change_beam_radius-908"><span class="linenos">908</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;WARNING: Beam modification is not implemented yet. &quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Cell.change_beam_radius-909"><a href="#Cell.change_beam_radius-909"><span class="linenos">909</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_radius</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Length of new radii vector and already cell radii vector needs &quot;</span>
</span><span id="Cell.change_beam_radius-910"><a href="#Cell.change_beam_radius-910"><span class="linenos">910</span></a>                                                    <span class="s2">&quot;to be equal &quot;</span><span class="p">)</span>
</span><span id="Cell.change_beam_radius-911"><a href="#Cell.change_beam_radius-911"><span class="linenos">911</span></a>        <span class="n">beamRadius</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Cell.change_beam_radius-912"><a href="#Cell.change_beam_radius-912"><span class="linenos">912</span></a>        <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">new_radius</span><span class="p">:</span>
</span><span id="Cell.change_beam_radius-913"><a href="#Cell.change_beam_radius-913"><span class="linenos">913</span></a>            <span class="n">beamRadius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span>
</span><span id="Cell.change_beam_radius-914"><a href="#Cell.change_beam_radius-914"><span class="linenos">914</span></a>
</span><span id="Cell.change_beam_radius-915"><a href="#Cell.change_beam_radius-915"><span class="linenos">915</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell.change_beam_radius-916"><a href="#Cell.change_beam_radius-916"><span class="linenos">916</span></a>            <span class="n">beam</span><span class="o">.</span><span class="n">change_beam_radius</span><span class="p">(</span><span class="n">beamRadius</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">])</span>
</span><span id="Cell.change_beam_radius-917"><a href="#Cell.change_beam_radius-917"><span class="linenos">917</span></a>
</span><span id="Cell.change_beam_radius-918"><a href="#Cell.change_beam_radius-918"><span class="linenos">918</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">new_radius</span>
</span></pre></div>


            <div class="docstring"><p>WARNING: BEAM MOD IS NOT WORKING
Change beam radii in the cell</p>

<h2 id="parameters">Parameters:</h2>

<p>newRadius: list
    beam radii wanted to assign</p>
</div>


                            </div>
                            <div id="Cell.get_relative_density_kriging" class="classattr">
                                        <input id="Cell.get_relative_density_kriging-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;optimization&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_relative_density_kriging</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">kriging_model</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Cell.get_relative_density_kriging-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_relative_density_kriging"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_relative_density_kriging-920"><a href="#Cell.get_relative_density_kriging-920"><span class="linenos">920</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_kriging-921"><a href="#Cell.get_relative_density_kriging-921"><span class="linenos">921</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_relative_density_kriging-922"><a href="#Cell.get_relative_density_kriging-922"><span class="linenos">922</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_kriging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kriging_model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell.get_relative_density_kriging-923"><a href="#Cell.get_relative_density_kriging-923"><span class="linenos">923</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_relative_density_kriging-924"><a href="#Cell.get_relative_density_kriging-924"><span class="linenos">924</span></a><span class="sd">        Get the relative density of the cell using kriging model</span>
</span><span id="Cell.get_relative_density_kriging-925"><a href="#Cell.get_relative_density_kriging-925"><span class="linenos">925</span></a>
</span><span id="Cell.get_relative_density_kriging-926"><a href="#Cell.get_relative_density_kriging-926"><span class="linenos">926</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.get_relative_density_kriging-927"><a href="#Cell.get_relative_density_kriging-927"><span class="linenos">927</span></a><span class="sd">        -----------</span>
</span><span id="Cell.get_relative_density_kriging-928"><a href="#Cell.get_relative_density_kriging-928"><span class="linenos">928</span></a><span class="sd">        krigingModel: Kriging</span>
</span><span id="Cell.get_relative_density_kriging-929"><a href="#Cell.get_relative_density_kriging-929"><span class="linenos">929</span></a><span class="sd">            Kriging model to use for prediction</span>
</span><span id="Cell.get_relative_density_kriging-930"><a href="#Cell.get_relative_density_kriging-930"><span class="linenos">930</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_relative_density_kriging-931"><a href="#Cell.get_relative_density_kriging-931"><span class="linenos">931</span></a>        <span class="n">relative_density</span> <span class="o">=</span> <span class="n">kriging_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Cell.get_relative_density_kriging-932"><a href="#Cell.get_relative_density_kriging-932"><span class="linenos">932</span></a>        <span class="k">return</span> <span class="n">relative_density</span>
</span></pre></div>


            <div class="docstring"><p>Get the relative density of the cell using kriging model</p>

<h2 id="parameters">Parameters:</h2>

<p>krigingModel: Kriging
    Kriging model to use for prediction</p>
</div>


                            </div>
                            <div id="Cell.get_relative_density_gradient" class="classattr">
                                        <input id="Cell.get_relative_density_gradient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;optimization&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_relative_density_gradient</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">relative_density_poly_deriv</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Cell.get_relative_density_gradient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_relative_density_gradient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_relative_density_gradient-934"><a href="#Cell.get_relative_density_gradient-934"><span class="linenos">934</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient-935"><a href="#Cell.get_relative_density_gradient-935"><span class="linenos">935</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_relative_density_gradient-936"><a href="#Cell.get_relative_density_gradient-936"><span class="linenos">936</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relative_density_poly_deriv</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Cell.get_relative_density_gradient-937"><a href="#Cell.get_relative_density_gradient-937"><span class="linenos">937</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_relative_density_gradient-938"><a href="#Cell.get_relative_density_gradient-938"><span class="linenos">938</span></a><span class="sd">        Get the gradient of the relative density</span>
</span><span id="Cell.get_relative_density_gradient-939"><a href="#Cell.get_relative_density_gradient-939"><span class="linenos">939</span></a>
</span><span id="Cell.get_relative_density_gradient-940"><a href="#Cell.get_relative_density_gradient-940"><span class="linenos">940</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.get_relative_density_gradient-941"><a href="#Cell.get_relative_density_gradient-941"><span class="linenos">941</span></a><span class="sd">        -----------</span>
</span><span id="Cell.get_relative_density_gradient-942"><a href="#Cell.get_relative_density_gradient-942"><span class="linenos">942</span></a><span class="sd">        relative_density_poly_deriv: list</span>
</span><span id="Cell.get_relative_density_gradient-943"><a href="#Cell.get_relative_density_gradient-943"><span class="linenos">943</span></a><span class="sd">            List of polynomial derivative functions</span>
</span><span id="Cell.get_relative_density_gradient-944"><a href="#Cell.get_relative_density_gradient-944"><span class="linenos">944</span></a>
</span><span id="Cell.get_relative_density_gradient-945"><a href="#Cell.get_relative_density_gradient-945"><span class="linenos">945</span></a><span class="sd">        Returns:</span>
</span><span id="Cell.get_relative_density_gradient-946"><a href="#Cell.get_relative_density_gradient-946"><span class="linenos">946</span></a><span class="sd">        --------</span>
</span><span id="Cell.get_relative_density_gradient-947"><a href="#Cell.get_relative_density_gradient-947"><span class="linenos">947</span></a><span class="sd">        deriv: float</span>
</span><span id="Cell.get_relative_density_gradient-948"><a href="#Cell.get_relative_density_gradient-948"><span class="linenos">948</span></a><span class="sd">            Derivative of the relative density</span>
</span><span id="Cell.get_relative_density_gradient-949"><a href="#Cell.get_relative_density_gradient-949"><span class="linenos">949</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_relative_density_gradient-950"><a href="#Cell.get_relative_density_gradient-950"><span class="linenos">950</span></a>        <span class="n">deriv</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Cell.get_relative_density_gradient-951"><a href="#Cell.get_relative_density_gradient-951"><span class="linenos">951</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">polyDeriv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relative_density_poly_deriv</span><span class="p">):</span>
</span><span id="Cell.get_relative_density_gradient-952"><a href="#Cell.get_relative_density_gradient-952"><span class="linenos">952</span></a>            <span class="n">deriv</span> <span class="o">+=</span> <span class="n">polyDeriv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Cell.get_relative_density_gradient-953"><a href="#Cell.get_relative_density_gradient-953"><span class="linenos">953</span></a>        <span class="k">return</span> <span class="n">deriv</span>
</span></pre></div>


            <div class="docstring"><p>Get the gradient of the relative density</p>

<h2 id="parameters">Parameters:</h2>

<p>relative_density_poly_deriv: list
    List of polynomial derivative functions</p>

<h2 id="returns">Returns:</h2>

<p>deriv: float
    Derivative of the relative density</p>
</div>


                            </div>
                            <div id="Cell.get_relative_density_gradient_kriging" class="classattr">
                                        <input id="Cell.get_relative_density_gradient_kriging-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;optimization&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_relative_density_gradient_kriging</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">model</span>, </span><span class="param"><span class="n">geometries_types</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="Cell.get_relative_density_gradient_kriging-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_relative_density_gradient_kriging"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_relative_density_gradient_kriging-955"><a href="#Cell.get_relative_density_gradient_kriging-955"><span class="linenos">955</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient_kriging-956"><a href="#Cell.get_relative_density_gradient_kriging-956"><span class="linenos">956</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_relative_density_gradient_kriging-957"><a href="#Cell.get_relative_density_gradient_kriging-957"><span class="linenos">957</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_gradient_kriging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Cell.get_relative_density_gradient_kriging-958"><a href="#Cell.get_relative_density_gradient_kriging-958"><span class="linenos">958</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_relative_density_gradient_kriging-959"><a href="#Cell.get_relative_density_gradient_kriging-959"><span class="linenos">959</span></a><span class="sd">        Finite difference gradient of the relative density (predictive mean) w.r.t. the radii using the trained</span>
</span><span id="Cell.get_relative_density_gradient_kriging-960"><a href="#Cell.get_relative_density_gradient_kriging-960"><span class="linenos">960</span></a><span class="sd">        Pipeline(StandardScaler -&gt; GaussianProcessRegressor) with Constant*RBF kernel.</span>
</span><span id="Cell.get_relative_density_gradient_kriging-961"><a href="#Cell.get_relative_density_gradient_kriging-961"><span class="linenos">961</span></a><span class="sd">        Returns an array of size len(geometries_types) where entries for geometries not present in the cell are 0.</span>
</span><span id="Cell.get_relative_density_gradient_kriging-962"><a href="#Cell.get_relative_density_gradient_kriging-962"><span class="linenos">962</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_relative_density_gradient_kriging-963"><a href="#Cell.get_relative_density_gradient_kriging-963"><span class="linenos">963</span></a>        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-3</span>
</span><span id="Cell.get_relative_density_gradient_kriging-964"><a href="#Cell.get_relative_density_gradient_kriging-964"><span class="linenos">964</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">))</span>
</span><span id="Cell.get_relative_density_gradient_kriging-965"><a href="#Cell.get_relative_density_gradient_kriging-965"><span class="linenos">965</span></a>
</span><span id="Cell.get_relative_density_gradient_kriging-966"><a href="#Cell.get_relative_density_gradient_kriging-966"><span class="linenos">966</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Cell.get_relative_density_gradient_kriging-967"><a href="#Cell.get_relative_density_gradient_kriging-967"><span class="linenos">967</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geometries_types</span><span class="p">:</span>
</span><span id="Cell.get_relative_density_gradient_kriging-968"><a href="#Cell.get_relative_density_gradient_kriging-968"><span class="linenos">968</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;geometry types in cell&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="s2">&quot; Not in the trained kriging model&quot;</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient_kriging-969"><a href="#Cell.get_relative_density_gradient_kriging-969"><span class="linenos">969</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible geometry types between the cell and the kriging model.&quot;</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient_kriging-970"><a href="#Cell.get_relative_density_gradient_kriging-970"><span class="linenos">970</span></a>            <span class="n">perturbed_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometries_types</span><span class="p">))</span>
</span><span id="Cell.get_relative_density_gradient_kriging-971"><a href="#Cell.get_relative_density_gradient_kriging-971"><span class="linenos">971</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometries_types</span><span class="p">))</span>
</span><span id="Cell.get_relative_density_gradient_kriging-972"><a href="#Cell.get_relative_density_gradient_kriging-972"><span class="linenos">972</span></a>            <span class="n">geom_index</span> <span class="o">=</span> <span class="n">geometries_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Cell.get_relative_density_gradient_kriging-973"><a href="#Cell.get_relative_density_gradient_kriging-973"><span class="linenos">973</span></a>            <span class="n">perturbed_radii</span><span class="p">[</span><span class="n">geom_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">+</span> <span class="n">epsilon</span>
</span><span id="Cell.get_relative_density_gradient_kriging-974"><a href="#Cell.get_relative_density_gradient_kriging-974"><span class="linenos">974</span></a>            <span class="n">radii</span><span class="p">[</span><span class="n">geom_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rad</span>
</span><span id="Cell.get_relative_density_gradient_kriging-975"><a href="#Cell.get_relative_density_gradient_kriging-975"><span class="linenos">975</span></a>            <span class="n">grad</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">perturbed_radii</span><span class="p">])</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">radii</span><span class="p">]))</span> <span class="o">/</span> <span class="n">epsilon</span>
</span><span id="Cell.get_relative_density_gradient_kriging-976"><a href="#Cell.get_relative_density_gradient_kriging-976"><span class="linenos">976</span></a>        <span class="k">return</span> <span class="n">grad</span>
</span></pre></div>


            <div class="docstring"><p>Finite difference gradient of the relative density (predictive mean) w.r.t. the radii using the trained
Pipeline(StandardScaler -> GaussianProcessRegressor) with Constant*RBF kernel.
Returns an array of size len(geometries_types) where entries for geometries not present in the cell are 0.</p>
</div>


                            </div>
                            <div id="Cell.get_relative_density_gradient_kriging_exact" class="classattr">
                                        <input id="Cell.get_relative_density_gradient_kriging_exact-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;optimization&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_relative_density_gradient_kriging_exact</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">model</span>, </span><span class="param"><span class="n">geometries_types</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="Cell.get_relative_density_gradient_kriging_exact-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_relative_density_gradient_kriging_exact"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_relative_density_gradient_kriging_exact-978"><a href="#Cell.get_relative_density_gradient_kriging_exact-978"><span class="linenos"> 978</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-979"><a href="#Cell.get_relative_density_gradient_kriging_exact-979"><span class="linenos"> 979</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-980"><a href="#Cell.get_relative_density_gradient_kriging_exact-980"><span class="linenos"> 980</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_gradient_kriging_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-981"><a href="#Cell.get_relative_density_gradient_kriging_exact-981"><span class="linenos"> 981</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-982"><a href="#Cell.get_relative_density_gradient_kriging_exact-982"><span class="linenos"> 982</span></a><span class="sd">        Exact gradient of the relative density (predictive mean) w.r.t. the radii using the trained</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-983"><a href="#Cell.get_relative_density_gradient_kriging_exact-983"><span class="linenos"> 983</span></a><span class="sd">        Pipeline(StandardScaler -&gt; GaussianProcessRegressor) with Constant*RBF kernel.</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-984"><a href="#Cell.get_relative_density_gradient_kriging_exact-984"><span class="linenos"> 984</span></a>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-985"><a href="#Cell.get_relative_density_gradient_kriging_exact-985"><span class="linenos"> 985</span></a><span class="sd">        Returns an array of size len(geometries_types) where entries for geometries not present in the cell are 0.</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-986"><a href="#Cell.get_relative_density_gradient_kriging_exact-986"><span class="linenos"> 986</span></a>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-987"><a href="#Cell.get_relative_density_gradient_kriging_exact-987"><span class="linenos"> 987</span></a><span class="sd">        Parameters:</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-988"><a href="#Cell.get_relative_density_gradient_kriging_exact-988"><span class="linenos"> 988</span></a><span class="sd">        -----------</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-989"><a href="#Cell.get_relative_density_gradient_kriging_exact-989"><span class="linenos"> 989</span></a><span class="sd">        model: Pipeline</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-990"><a href="#Cell.get_relative_density_gradient_kriging_exact-990"><span class="linenos"> 990</span></a><span class="sd">            Trained kriging model</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-991"><a href="#Cell.get_relative_density_gradient_kriging_exact-991"><span class="linenos"> 991</span></a>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-992"><a href="#Cell.get_relative_density_gradient_kriging_exact-992"><span class="linenos"> 992</span></a><span class="sd">        geometries_types: list</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-993"><a href="#Cell.get_relative_density_gradient_kriging_exact-993"><span class="linenos"> 993</span></a><span class="sd">            List of geometry types in the trained kriging model</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-994"><a href="#Cell.get_relative_density_gradient_kriging_exact-994"><span class="linenos"> 994</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-995"><a href="#Cell.get_relative_density_gradient_kriging_exact-995"><span class="linenos"> 995</span></a>        <span class="c1"># Build full input vector (one radius per geometry in &#39;geometries_types&#39;)</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-996"><a href="#Cell.get_relative_density_gradient_kriging_exact-996"><span class="linenos"> 996</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometries_types</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-997"><a href="#Cell.get_relative_density_gradient_kriging_exact-997"><span class="linenos"> 997</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-998"><a href="#Cell.get_relative_density_gradient_kriging_exact-998"><span class="linenos"> 998</span></a>            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-999"><a href="#Cell.get_relative_density_gradient_kriging_exact-999"><span class="linenos"> 999</span></a>            <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geometries_types</span><span class="p">:</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1000"><a href="#Cell.get_relative_density_gradient_kriging_exact-1000"><span class="linenos">1000</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;geometry types in cell&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="s2">&quot; not in the trained kriging model&quot;</span><span class="p">,</span> <span class="n">geometries_types</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1001"><a href="#Cell.get_relative_density_gradient_kriging_exact-1001"><span class="linenos">1001</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible geometry types between the cell and the kriging model.&quot;</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1002"><a href="#Cell.get_relative_density_gradient_kriging_exact-1002"><span class="linenos">1002</span></a>            <span class="n">x</span><span class="p">[</span><span class="n">geometries_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1003"><a href="#Cell.get_relative_density_gradient_kriging_exact-1003"><span class="linenos">1003</span></a>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1004"><a href="#Cell.get_relative_density_gradient_kriging_exact-1004"><span class="linenos">1004</span></a>        <span class="c1"># Exact gradient in original feature space</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1005"><a href="#Cell.get_relative_density_gradient_kriging_exact-1005"><span class="linenos">1005</span></a>        <span class="n">grad_full</span> <span class="o">=</span> <span class="n">gp_mean_gradient_rbf_pipeline</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># shape (len(geometries_types),)</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1006"><a href="#Cell.get_relative_density_gradient_kriging_exact-1006"><span class="linenos">1006</span></a>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1007"><a href="#Cell.get_relative_density_gradient_kriging_exact-1007"><span class="linenos">1007</span></a>        <span class="c1"># Reorder to match the cell&#39;s local parameter order (same as self.radii / self.geom_types)</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1008"><a href="#Cell.get_relative_density_gradient_kriging_exact-1008"><span class="linenos">1008</span></a>        <span class="n">grad_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1009"><a href="#Cell.get_relative_density_gradient_kriging_exact-1009"><span class="linenos">1009</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">):</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1010"><a href="#Cell.get_relative_density_gradient_kriging_exact-1010"><span class="linenos">1010</span></a>            <span class="n">grad_local</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">grad_full</span><span class="p">[</span><span class="n">geometries_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1011"><a href="#Cell.get_relative_density_gradient_kriging_exact-1011"><span class="linenos">1011</span></a>
</span><span id="Cell.get_relative_density_gradient_kriging_exact-1012"><a href="#Cell.get_relative_density_gradient_kriging_exact-1012"><span class="linenos">1012</span></a>        <span class="k">return</span> <span class="n">grad_local</span>
</span></pre></div>


            <div class="docstring"><p>Exact gradient of the relative density (predictive mean) w.r.t. the radii using the trained
Pipeline(StandardScaler -> GaussianProcessRegressor) with Constant*RBF kernel.</p>

<p>Returns an array of size len(geometries_types) where entries for geometries not present in the cell are 0.</p>

<h2 id="parameters">Parameters:</h2>

<p>model: Pipeline
    Trained kriging model</p>

<p>geometries_types: list
    List of geometry types in the trained kriging model</p>
</div>


                            </div>
                            <div id="Cell.get_RGBcolor_depending_of_radius" class="classattr">
                                        <input id="Cell.get_RGBcolor_depending_of_radius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_RGBcolor_depending_of_radius</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span>:</span></span>

                <label class="view-source-button" for="Cell.get_RGBcolor_depending_of_radius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_RGBcolor_depending_of_radius"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_RGBcolor_depending_of_radius-1018"><a href="#Cell.get_RGBcolor_depending_of_radius-1018"><span class="linenos">1018</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_RGBcolor_depending_of_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="Cell.get_RGBcolor_depending_of_radius-1019"><a href="#Cell.get_RGBcolor_depending_of_radius-1019"><span class="linenos">1019</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_RGBcolor_depending_of_radius-1020"><a href="#Cell.get_RGBcolor_depending_of_radius-1020"><span class="linenos">1020</span></a><span class="sd">        Get the RGB color of the cell depending on the radii.</span>
</span><span id="Cell.get_RGBcolor_depending_of_radius-1021"><a href="#Cell.get_RGBcolor_depending_of_radius-1021"><span class="linenos">1021</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_RGBcolor_depending_of_radius-1022"><a href="#Cell.get_RGBcolor_depending_of_radius-1022"><span class="linenos">1022</span></a>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="mf">0.1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get the RGB color of the cell depending on the radii.</p>
</div>


                            </div>
                            <div id="Cell.print_data" class="classattr">
                                        <input id="Cell.print_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Cell.print_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.print_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.print_data-1024"><a href="#Cell.print_data-1024"><span class="linenos">1024</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell.print_data-1025"><a href="#Cell.print_data-1025"><span class="linenos">1025</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.print_data-1026"><a href="#Cell.print_data-1026"><span class="linenos">1026</span></a><span class="sd">        Print the data of the cell for debugging purposes.</span>
</span><span id="Cell.print_data-1027"><a href="#Cell.print_data-1027"><span class="linenos">1027</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.print_data-1028"><a href="#Cell.print_data-1028"><span class="linenos">1028</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell position: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</span><span id="Cell.print_data-1029"><a href="#Cell.print_data-1029"><span class="linenos">1029</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell coordinates: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">)</span>
</span><span id="Cell.print_data-1030"><a href="#Cell.print_data-1030"><span class="linenos">1030</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell size: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="Cell.print_data-1031"><a href="#Cell.print_data-1031"><span class="linenos">1031</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lattice type_beam: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">)</span>
</span><span id="Cell.print_data-1032"><a href="#Cell.print_data-1032"><span class="linenos">1032</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beam radii: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span>
</span><span id="Cell.print_data-1033"><a href="#Cell.print_data-1033"><span class="linenos">1033</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beam material: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span><span class="p">)</span>
</span><span id="Cell.print_data-1034"><a href="#Cell.print_data-1034"><span class="linenos">1034</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;beams in cell: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="Cell.print_data-1035"><a href="#Cell.print_data-1035"><span class="linenos">1035</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell center point: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_point</span><span class="p">)</span>
</span><span id="Cell.print_data-1036"><a href="#Cell.print_data-1036"><span class="linenos">1036</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell index: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="Cell.print_data-1037"><a href="#Cell.print_data-1037"><span class="linenos">1037</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beam material: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_material</span><span class="p">)</span>
</span><span id="Cell.print_data-1038"><a href="#Cell.print_data-1038"><span class="linenos">1038</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coupling matrix: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_matrix_B</span><span class="p">)</span>
</span><span id="Cell.print_data-1039"><a href="#Cell.print_data-1039"><span class="linenos">1039</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of beams: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">))</span>
</span><span id="Cell.print_data-1040"><a href="#Cell.print_data-1040"><span class="linenos">1040</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Volume of the cell: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
</span><span id="Cell.print_data-1041"><a href="#Cell.print_data-1041"><span class="linenos">1041</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Relative density: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_density</span><span class="p">)</span>
</span><span id="Cell.print_data-1042"><a href="#Cell.print_data-1042"><span class="linenos">1042</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of nodes at boundary: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_nodes_at_boundary</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Print the data of the cell for debugging purposes.</p>
</div>


                            </div>
                            <div id="Cell.get_translation_rigid_body" class="classattr">
                                        <input id="Cell.get_translation_rigid_body-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_translation_rigid_body</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Cell.get_translation_rigid_body-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_translation_rigid_body"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_translation_rigid_body-1048"><a href="#Cell.get_translation_rigid_body-1048"><span class="linenos">1048</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_translation_rigid_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell.get_translation_rigid_body-1049"><a href="#Cell.get_translation_rigid_body-1049"><span class="linenos">1049</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_translation_rigid_body-1050"><a href="#Cell.get_translation_rigid_body-1050"><span class="linenos">1050</span></a><span class="sd">        Get the translation of the rigid body</span>
</span><span id="Cell.get_translation_rigid_body-1051"><a href="#Cell.get_translation_rigid_body-1051"><span class="linenos">1051</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_translation_rigid_body-1052"><a href="#Cell.get_translation_rigid_body-1052"><span class="linenos">1052</span></a>        <span class="n">translation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Cell.get_translation_rigid_body-1053"><a href="#Cell.get_translation_rigid_body-1053"><span class="linenos">1053</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Cell.get_translation_rigid_body-1054"><a href="#Cell.get_translation_rigid_body-1054"><span class="linenos">1054</span></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="p">]:</span>
</span><span id="Cell.get_translation_rigid_body-1055"><a href="#Cell.get_translation_rigid_body-1055"><span class="linenos">1055</span></a>                <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">index_boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Cell.get_translation_rigid_body-1056"><a href="#Cell.get_translation_rigid_body-1056"><span class="linenos">1056</span></a>                    <span class="n">translation</span> <span class="o">+=</span> <span class="n">point</span><span class="o">.</span><span class="n">displacement_vector</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Cell.get_translation_rigid_body-1057"><a href="#Cell.get_translation_rigid_body-1057"><span class="linenos">1057</span></a>        <span class="k">return</span> <span class="n">translation</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_nodes_at_boundary</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Get the translation of the rigid body</p>
</div>


                            </div>
                            <div id="Cell.get_rotation_rigid_body" class="classattr">
                                        <input id="Cell.get_rotation_rigid_body-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_rotation_rigid_body</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Cell.get_rotation_rigid_body-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Cell.get_rotation_rigid_body"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Cell.get_rotation_rigid_body-1059"><a href="#Cell.get_rotation_rigid_body-1059"><span class="linenos">1059</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rotation_rigid_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Cell.get_rotation_rigid_body-1060"><a href="#Cell.get_rotation_rigid_body-1060"><span class="linenos">1060</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Cell.get_rotation_rigid_body-1061"><a href="#Cell.get_rotation_rigid_body-1061"><span class="linenos">1061</span></a><span class="sd">        Get the rotation matrix of the rigid body using SVD.</span>
</span><span id="Cell.get_rotation_rigid_body-1062"><a href="#Cell.get_rotation_rigid_body-1062"><span class="linenos">1062</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Cell.get_rotation_rigid_body-1063"><a href="#Cell.get_rotation_rigid_body-1063"><span class="linenos">1063</span></a>        <span class="n">all_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_cell</span>
</span><span id="Cell.get_rotation_rigid_body-1064"><a href="#Cell.get_rotation_rigid_body-1064"><span class="linenos">1064</span></a>        <span class="n">initial_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">coordinates</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">all_points</span><span class="p">])</span>  <span class="c1"># P_i</span>
</span><span id="Cell.get_rotation_rigid_body-1065"><a href="#Cell.get_rotation_rigid_body-1065"><span class="linenos">1065</span></a>        <span class="n">final_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">deformed_coordinates</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">all_points</span><span class="p">])</span>  <span class="c1"># P_i&#39;</span>
</span><span id="Cell.get_rotation_rigid_body-1066"><a href="#Cell.get_rotation_rigid_body-1066"><span class="linenos">1066</span></a>
</span><span id="Cell.get_rotation_rigid_body-1067"><a href="#Cell.get_rotation_rigid_body-1067"><span class="linenos">1067</span></a>        <span class="c1"># Soustraction du centre de gravit</span>
</span><span id="Cell.get_rotation_rigid_body-1068"><a href="#Cell.get_rotation_rigid_body-1068"><span class="linenos">1068</span></a>        <span class="n">center_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Cell.get_rotation_rigid_body-1069"><a href="#Cell.get_rotation_rigid_body-1069"><span class="linenos">1069</span></a>        <span class="n">center_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">final_positions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Cell.get_rotation_rigid_body-1070"><a href="#Cell.get_rotation_rigid_body-1070"><span class="linenos">1070</span></a>        <span class="n">P</span> <span class="o">=</span> <span class="n">initial_positions</span> <span class="o">-</span> <span class="n">center_initial</span>
</span><span id="Cell.get_rotation_rigid_body-1071"><a href="#Cell.get_rotation_rigid_body-1071"><span class="linenos">1071</span></a>        <span class="n">P_prime</span> <span class="o">=</span> <span class="n">final_positions</span> <span class="o">-</span> <span class="n">center_final</span>
</span><span id="Cell.get_rotation_rigid_body-1072"><a href="#Cell.get_rotation_rigid_body-1072"><span class="linenos">1072</span></a>
</span><span id="Cell.get_rotation_rigid_body-1073"><a href="#Cell.get_rotation_rigid_body-1073"><span class="linenos">1073</span></a>        <span class="c1"># Matrice de covariance</span>
</span><span id="Cell.get_rotation_rigid_body-1074"><a href="#Cell.get_rotation_rigid_body-1074"><span class="linenos">1074</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_prime</span>
</span><span id="Cell.get_rotation_rigid_body-1075"><a href="#Cell.get_rotation_rigid_body-1075"><span class="linenos">1075</span></a>
</span><span id="Cell.get_rotation_rigid_body-1076"><a href="#Cell.get_rotation_rigid_body-1076"><span class="linenos">1076</span></a>        <span class="c1"># Dcomposition SVD</span>
</span><span id="Cell.get_rotation_rigid_body-1077"><a href="#Cell.get_rotation_rigid_body-1077"><span class="linenos">1077</span></a>        <span class="n">U</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
</span><span id="Cell.get_rotation_rigid_body-1078"><a href="#Cell.get_rotation_rigid_body-1078"><span class="linenos">1078</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
</span><span id="Cell.get_rotation_rigid_body-1079"><a href="#Cell.get_rotation_rigid_body-1079"><span class="linenos">1079</span></a>
</span><span id="Cell.get_rotation_rigid_body-1080"><a href="#Cell.get_rotation_rigid_body-1080"><span class="linenos">1080</span></a>        <span class="c1"># Correction si ncessaire (assurer que R est une rotation propre)</span>
</span><span id="Cell.get_rotation_rigid_body-1081"><a href="#Cell.get_rotation_rigid_body-1081"><span class="linenos">1081</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Cell.get_rotation_rigid_body-1082"><a href="#Cell.get_rotation_rigid_body-1082"><span class="linenos">1082</span></a>            <span class="n">Vt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Cell.get_rotation_rigid_body-1083"><a href="#Cell.get_rotation_rigid_body-1083"><span class="linenos">1083</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">Vt</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
</span><span id="Cell.get_rotation_rigid_body-1084"><a href="#Cell.get_rotation_rigid_body-1084"><span class="linenos">1084</span></a>
</span><span id="Cell.get_rotation_rigid_body-1085"><a href="#Cell.get_rotation_rigid_body-1085"><span class="linenos">1085</span></a>        <span class="k">return</span> <span class="n">R</span>
</span></pre></div>


            <div class="docstring"><p>Get the rotation matrix of the rigid body using SVD.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>