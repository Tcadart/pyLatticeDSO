<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>pyLattice.lattice API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pyLattice.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pyLattice</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Lattice">Lattice</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Lattice.__init__">Lattice</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.mesh_trimmer">mesh_trimmer</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.timing">timing</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.name_lattice">name_lattice</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.radii">radii</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.geom_types">geom_types</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.enable_randomness">enable_randomness</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.randomness_hybrid">randomness_hybrid</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.range_radius">range_radius</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.symmetry_lattice">symmetry_lattice</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.uncertainty_node">uncertainty_node</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.eraser_blocks">eraser_blocks</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.enable_periodicity">enable_periodicity</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.enable_simulation_properties">enable_simulation_properties</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.cells">cells</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.beams">beams</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.nodes">nodes</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.edge_tags">edge_tags</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.face_tags">face_tags</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.corner_tags">corner_tags</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.lattice_dimension_dict">lattice_dimension_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.occupancy_matrix">occupancy_matrix</a>
                        </li>
                        <li>
                                <a class="variable" href="#Lattice.mesh_lattice">mesh_lattice</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.open_pickle_lattice">open_pickle_lattice</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_number_cells">get_number_cells</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_number_beams">get_number_beams</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_number_nodes">get_number_nodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.extract_parameters_from_json">extract_parameters_from_json</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_lattice_boundary_box">get_lattice_boundary_box</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.define_lattice_dimensions">define_lattice_dimensions</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_relative_density">get_relative_density</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_beam_radius_min_max">get_beam_radius_min_max</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.define_gradient">define_gradient</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.generate_lattice">generate_lattice</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.cut_beam_with_mesh_trimmer">cut_beam_with_mesh_trimmer</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.apply_symmetry">apply_symmetry</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.delete_beams_under_radius_threshold">delete_beams_under_radius_threshold</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.set_tag_classification">set_tag_classification</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.define_size_lattice">define_size_lattice</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.is_not_in_erased_region">is_not_in_erased_region</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.define_beam_node_index">define_beam_node_index</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.define_cell_index">define_cell_index</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.define_node_local_tags">define_node_local_tags</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.define_cell_neighbours">define_cell_neighbours</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.define_connected_beams_for_all_nodes">define_connected_beams_for_all_nodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.define_angles_between_beams">define_angles_between_beams</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.refresh_cells_memberships">refresh_cells_memberships</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.remove_cell">remove_cell</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.find_minimum_beam_length">find_minimum_beam_length</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_tag_list">get_tag_list</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_tag_list_boundary">get_tag_list_boundary</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.apply_tag_all_point">apply_tag_all_point</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_cell_occupancy_matrix">get_cell_occupancy_matrix</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_cells_at_index">get_cells_at_index</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_relative_boundary_box">get_relative_boundary_box</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_name_lattice">get_name_lattice</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.check_hybrid_collision">check_hybrid_collision</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.are_cells_identical">are_cells_identical</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.change_beam_radius">change_beam_radius</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.change_beam_radius_depending_type">change_beam_radius_depending_type</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.find_point_on_lattice_surface">find_point_on_lattice_surface</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_cells_on_surfaces">get_cells_on_surfaces</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.print_statistics_lattice">print_statistics_lattice</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.delete_orphan_points">delete_orphan_points</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.merge_degree2_nodes">merge_degree2_nodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.delete_unconnected_beams">delete_unconnected_beams</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.generate_mesh_lattice_Gmsh">generate_mesh_lattice_Gmsh</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_volume_mesh">get_volume_mesh</a>
                        </li>
                        <li>
                                <a class="function" href="#Lattice.get_relative_density_mesh">get_relative_density_mesh</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../pyLattice.html">pyLattice</a><wbr>.lattice    </h1>

                
                        <input id="mod-lattice-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-lattice-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="c1"># CLASS: Lattice</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="c1">#</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="c1"># Generate lattice structures with various parameters and properties.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="c1">#</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="c1"># This module provides the Lattice class, which allows for the creation and manipulation of lattice structures,</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="c1"># including the definition of cell dimensions, material properties, and gradient settings.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="c1"># It also supports simulation methods and uncertainty handling.</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="c1">#</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="c1"># Created in 2023 by Cadart Thomas, University of technology Belfort Montb√©liard.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">statistics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">gmsh</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.cell</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_validate_inputs_lattice</span><span class="p">,</span> <span class="n">open_lattice_parameters</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.gradient_properties</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_grad_settings</span><span class="p">,</span> <span class="n">grad_material_setting</span><span class="p">,</span> <span class="n">grad_settings_constant</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.timing</span><span class="w"> </span><span class="kn">import</span> <span class="n">timing</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">data.inputs.mesh_file.mesh_trimmer</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeshTrimmer</span>  <span class="c1"># type: ignore</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># falls back during docs/CI when &#39;data&#39; isn&#39;t available</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span> <span class="k">as</span> <span class="n">MeshTrimmer</span>  <span class="c1"># type: ignore</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">    Class to generate lattice structures with various parameters and properties.</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mesh_trimmer</span><span class="p">:</span> <span class="s2">&quot;MeshTrimmer&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">        Constructor from a JSON file to create a lattice object.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">        Parameters:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">        -----------</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">        name_file: str</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">            Name of the JSON file containing lattice parameters.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">        mesh_trimmer: MeshTrimmer, optional</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">            MeshTrimmer object to trim the lattice.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">        _verbose: int, optional</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">            Verbosity level for logging.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span> <span class="o">=</span> <span class="n">mesh_trimmer</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timing</span> <span class="o">=</span> <span class="n">timing</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Lattice&quot;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_randomness</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">randomness_hybrid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Warning not working for graded structures</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_simulation_properties</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="c1"># Containers</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edge_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">face_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corner_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lattice_dimension_dict</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_lattice</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="c1"># Generate global structure</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">extract_parameters_from_json</span><span class="p">(</span><span class="n">name_file</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_lattice</span><span class="p">()</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">apply_symmetry</span><span class="p">()</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_size_lattice</span><span class="p">()</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="c1"># Generate important data for the lattice structure</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_tag_classification</span><span class="p">()</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_lattice_dimensions</span><span class="p">()</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_cell_index</span><span class="p">()</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_cell_neighbours</span><span class="p">()</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">apply_tag_all_point</span><span class="p">()</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_flag</span><span class="p">:</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">are_cells_identical</span><span class="p">()</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">print_statistics_lattice</span><span class="p">()</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">open_pickle_lattice</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;LatticeObject&quot;</span><span class="p">,</span> <span class="n">sim_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Lattice&quot;</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        Load a lattice pickle and (optionally) upcast it to the caller&#39;s class (e.g., LatticeSim).</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">        If the target class defines `_post_load_init`, it will be invoked after loading.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;outputs&quot;</span> <span class="o">/</span> <span class="s2">&quot;saved_lattice_file&quot;</span> <span class="o">/</span> <span class="n">file_name</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>                <span class="n">lattice</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load lattice from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>        <span class="c1"># Normalize containers</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>            <span class="n">lattice</span><span class="o">.</span><span class="n">beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>            <span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>                <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;points_cell&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>                <span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="n">lattice</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>        <span class="c1"># --- upcast to the caller class if needed (e.g., LatticeSim) ---</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Lattice</span><span class="p">):</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>            <span class="n">upgraded</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>            <span class="n">upgraded</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="n">lattice</span> <span class="o">=</span> <span class="n">upgraded</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="n">post</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;_post_load_init&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">post</span><span class="p">):</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>                <span class="n">post</span><span class="p">(</span><span class="n">sim_config</span><span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lattice loaded successfully from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="k">return</span> <span class="n">lattice</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Lattice name_lattice: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Dimensions: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size_z</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Number of cells: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Cell size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;radii: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="k">return</span> <span class="n">string</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        Compare two Lattice objects based on the radii of each cell.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        Returns True if they have the same number of cells and identical radii values.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Lattice</span><span class="p">):</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>        <span class="c1"># Different number of cells ‚Üí not equal</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="c1"># Compare per-cell radii (using cell index or position)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="c1"># Check if both have radii and same length</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="s2">&quot;radii&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="s2">&quot;radii&quot;</span><span class="p">):</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c2</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>            <span class="c1"># Compare numerical values (with small tolerance)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>            <span class="k">for</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">:</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of cells in the lattice&quot;&quot;&quot;</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of beams in the lattice&quot;&quot;&quot;</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of nodes in the lattice&quot;&quot;&quot;</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;initialization&quot;</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">extract_parameters_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">        Extract lattice parameters from a JSON file and set the corresponding attributes.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="sd">        Parameters:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="sd">        -----------</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">        name_file: str</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">            Name of the JSON file containing lattice parameters.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        <span class="n">lattice_parameters</span> <span class="o">=</span> <span class="n">open_lattice_parameters</span><span class="p">(</span><span class="n">name_file</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="c1"># Geometry</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="n">geometry</span> <span class="o">=</span> <span class="n">lattice_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>        <span class="n">cell_size</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_size&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>        <span class="n">number_of_cells</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number_of_cells&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span> <span class="o">=</span> <span class="n">cell_size</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span> <span class="o">=</span> <span class="n">cell_size</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span> <span class="o">=</span> <span class="n">cell_size</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span> <span class="o">=</span> <span class="n">number_of_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span> <span class="o">=</span> <span class="n">number_of_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span> <span class="o">=</span> <span class="n">number_of_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;radii&quot;</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geom_types&quot;</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_randomness</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_randomness&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;range_radius&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">randomness_hybrid</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;randomness_hybrid&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="p">,</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">]:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing geometry parameters in JSON file.&quot;</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="c1"># Gradient</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="n">gradient</span> <span class="o">=</span> <span class="n">lattice_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gradient&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="n">radius_grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;radii&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="n">dim_grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_dimension&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="n">mat_grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="n">grad_radius_property</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">,</span> <span class="s2">&quot;constant&quot;</span><span class="p">),</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>            <span class="p">[</span><span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_x&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_y&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_z&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>            <span class="p">[</span><span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="p">]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>        <span class="n">grad_dim_property</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">,</span> <span class="s2">&quot;constant&quot;</span><span class="p">),</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>            <span class="p">[</span><span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_x&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_y&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_z&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>            <span class="p">[</span><span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="p">]</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="n">grad_mat_property</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>            <span class="n">mat_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type_beam&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>            <span class="n">mat_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="p">]</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="c1"># Supplementary</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>        <span class="n">supplementary</span> <span class="o">=</span> <span class="n">lattice_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;supplementary&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span> <span class="o">=</span> <span class="n">supplementary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_uncertainty&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="c1"># Erased blocks</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="n">erased_blocks_json</span> <span class="o">=</span> <span class="n">supplementary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;erased_blocks&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">erased_blocks_json</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_point&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>            <span class="n">dim</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimensions_block&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>                <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>                <span class="n">dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>            <span class="p">])</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="c1"># Symmetry</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>        <span class="n">symmetries</span> <span class="o">=</span> <span class="n">supplementary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;symmetries&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="k">if</span> <span class="n">symmetries</span><span class="p">:</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>            <span class="n">sym_plane</span> <span class="o">=</span> <span class="n">symmetries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plane&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>            <span class="n">sym_point</span> <span class="o">=</span> <span class="n">symmetries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reference_point&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                <span class="s2">&quot;sym_plane&quot;</span><span class="p">:</span> <span class="n">sym_plane</span><span class="p">,</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                <span class="s2">&quot;sym_point&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">sym_point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>                              <span class="n">sym_point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>                              <span class="n">sym_point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            <span class="p">}</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="n">_validate_inputs_lattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                                 <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>                                 <span class="n">grad_radius_property</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">,</span> <span class="n">grad_mat_property</span><span class="p">,</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>                                 <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_gradient</span><span class="p">(</span><span class="n">grad_radius_property</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">,</span> <span class="n">grad_mat_property</span><span class="p">)</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_lattice_boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">        Get the boundary box of the lattice</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span><span class="p">]</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_lattice_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">        Computes extremum values of coordinates in the lattice.</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">        Return:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="sd">        --------</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">        lattice_dimension_dict: dict</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="sd">            Dictionary containing min and max values for x, y, z coordinates.</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No nodes in the lattice.&quot;</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="n">zs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lattice_dimension_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>            <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>            <span class="s2">&quot;z_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="s2">&quot;z_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span><span class="p">,</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        <span class="p">}</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_dimension_dict</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">        Get mean relative density of all cells in lattice</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">        Simple average of cell relative densities</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="sd">        Returns:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        --------</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a><span class="sd">        meanRelDens: float</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a><span class="sd">            Mean relative density of the lattice</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="n">cellRelDens</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            <span class="n">cellRelDens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">relative_density</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="n">meanRelDens</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">cellRelDens</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>        <span class="k">return</span> <span class="n">meanRelDens</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_beam_radius_min_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">        Get the maximum and minimum radii of the lattice</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a><span class="sd">        Returns:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a><span class="sd">        --------</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a><span class="sd">        radMax: float</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="sd">            Maximum radii of the lattice</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">        radMin: float</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">            Minimum radii of the lattice</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>        <span class="n">radMin</span> <span class="o">=</span> <span class="mi">1000000</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="n">radMax</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>                    <span class="n">radMin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radMin</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                    <span class="n">radMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radMax</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>        <span class="k">return</span> <span class="n">radMax</span><span class="p">,</span> <span class="n">radMin</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="c1"># SECTION: Design Methods</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;initialization&quot;</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad_radius_property</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">,</span> <span class="n">grad_mat_property</span><span class="p">):</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">        Define gradient settings for radii, dimensions, and materials based on provided properties.</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">        Parameters:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">        -----------</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">        grad_radius_property: list</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">            Properties defining the gradient for radii.</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">        grad_dim_property: list</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">            Properties defining the gradient for cell dimensions.</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">        grad_mat_property: list</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">            Properties defining the gradient for material settings.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>        <span class="k">if</span> <span class="n">grad_radius_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span> <span class="o">=</span> <span class="n">get_grad_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>                                                 <span class="n">grad_radius_property</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span> <span class="o">=</span> <span class="n">grad_settings_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="k">if</span> <span class="n">grad_dim_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span> <span class="o">=</span> <span class="n">get_grad_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span> <span class="o">=</span> <span class="n">grad_settings_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="k">if</span> <span class="n">grad_mat_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="o">=</span> <span class="n">grad_material_setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>                                                  <span class="n">grad_mat_property</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="o">=</span> <span class="n">grad_settings_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">        Generate cells in the lattice structure based on cell size, number of cells, geometry types, and radii.</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">        Gradient information and erased regions are also considered during cell generation.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span> <span class="c1"># For reproducibility of randomness</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="n">csx</span><span class="p">,</span> <span class="n">csy</span><span class="p">,</span> <span class="n">csz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="n">initial_cell_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">csx</span><span class="p">,</span> <span class="n">csy</span><span class="p">,</span> <span class="n">csz</span><span class="p">]</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>        <span class="n">added_nodes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="n">added_beams</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="c1"># Precompute cumulative start positions along each axis</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="n">x_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nx</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="n">y_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ny</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="n">z_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nz</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">x_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">csx</span> <span class="o">*</span> <span class="n">grad</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>            <span class="n">y_starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_starts</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">csy</span> <span class="o">*</span> <span class="n">grad</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">):</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="n">z_starts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_starts</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">csz</span> <span class="o">*</span> <span class="n">grad</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>        <span class="n">append_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>        <span class="n">mesh_trimmer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">x_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>                <span class="n">yj</span> <span class="o">=</span> <span class="n">y_starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>                    <span class="n">zk</span> <span class="o">=</span> <span class="n">z_starts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>                    <span class="n">start_cell_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yj</span><span class="p">,</span> <span class="n">zk</span><span class="p">]</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_not_in_erased_region</span><span class="p">(</span><span class="n">start_cell_pos</span><span class="p">):</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>                        <span class="k">continue</span>  <span class="c1"># skip erased regions</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>                    <span class="n">pos_cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_randomness</span><span class="p">:</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomness_hybrid</span><span class="p">:</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>                            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">]</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>                            <span class="n">random_radius</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>                            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_radius</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">]</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>                        <span class="n">radii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>                    <span class="n">new_cell</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>                        <span class="n">pos_cell</span><span class="p">,</span> <span class="n">initial_cell_size</span><span class="p">,</span> <span class="n">start_cell_pos</span><span class="p">,</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">,</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">,</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>                        <span class="n">beams_already_defined</span> <span class="o">=</span> <span class="n">added_beams</span><span class="p">,</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>                        <span class="n">nodes_already_defined</span> <span class="o">=</span> <span class="n">added_nodes</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>                    <span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>                    <span class="k">if</span> <span class="n">mesh_trimmer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mesh_trimmer</span><span class="o">.</span><span class="n">is_cell_in_mesh</span><span class="p">(</span><span class="n">new_cell</span><span class="p">):</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>                        <span class="k">continue</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>                    <span class="n">append_cell</span><span class="p">(</span><span class="n">new_cell</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">check_hybrid_collision</span><span class="p">()</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cut_beam_with_mesh_trimmer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        Cut beams in the lattice using the mesh trimmer.</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A mesh object must be assigned to the lattice before cutting beams.&quot;</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span><span class="o">.</span><span class="n">cut_beams_at_mesh_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetry_plane</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reference_point</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">        Apply symmetry to the lattice by mirroring cells across a specified plane.</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">        Parameters:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="sd">        -----------</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">        symmetry_plane: str, optional</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">            Plane of symmetry (&#39;XY&#39;, &#39;XZ&#39;, &#39;YZ&#39;, &#39;X&#39;, &#39;Y&#39;,</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">            or &#39;Z&#39;). If None, uses self.symmetry_lattice[&#39;sym_plane&#39;].</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">        reference_point: tuple of float, optional</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">            Reference point for the symmetry operation (x_ref, y_ref, z_ref).</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a><span class="sd">            If None, uses self.symmetry_lattice[&#39;sym_point&#39;].</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reference_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>            <span class="n">symmetry_plane</span><span class="p">,</span> <span class="n">reference_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span><span class="p">[</span><span class="s2">&quot;sym_plane&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span><span class="p">[</span><span class="s2">&quot;sym_point&quot;</span><span class="p">]</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reference_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Both symmetry_plane and reference_point must be provided.&quot;</span><span class="p">)</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>        <span class="n">symmetry_plane</span> <span class="o">=</span> <span class="n">symmetry_plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;XY&quot;</span><span class="p">,</span> <span class="s2">&quot;XZ&quot;</span><span class="p">,</span> <span class="s2">&quot;YZ&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">}:</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid symmetry plane. Choose from &#39;XY&#39;, &#39;XZ&#39;, &#39;YZ&#39;, &#39;X&#39;, &#39;Y&#39;, or &#39;Z&#39;.&quot;</span><span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="n">x_ref</span><span class="p">,</span> <span class="n">y_ref</span><span class="p">,</span> <span class="n">z_ref</span> <span class="o">=</span> <span class="n">reference_point</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="n">new_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Cell</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="n">new_global_beams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="n">new_global_nodes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>            <span class="c1"># Mirror the cell origin/coordinate; size and pos are kept identical</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>            <span class="c1"># Mirror min-corner of the box correctly: x&#39;min = 2*x_ref - (x_min + dx), etc.</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;YZ&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">}:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>                <span class="n">mcx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">cx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>                <span class="n">mcx</span> <span class="o">=</span> <span class="n">cx</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>            <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;XZ&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">}:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>                <span class="n">mcy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y_ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">cy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                <span class="n">mcy</span> <span class="o">=</span> <span class="n">cy</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;XY&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">}:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                <span class="n">mcz</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z_ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">cz</span> <span class="o">+</span> <span class="n">dz</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>                <span class="n">mcz</span> <span class="o">=</span> <span class="n">cz</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>            <span class="n">new_coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcx</span><span class="p">,</span> <span class="n">mcy</span><span class="p">,</span> <span class="n">mcz</span><span class="p">]</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="c1"># Build the mirrored cell</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>            <span class="n">new_cell</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                <span class="n">pos</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>                <span class="n">initial_size</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                <span class="n">coordinate</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">new_coord</span><span class="p">),</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>                <span class="n">geom_types</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">geom_types</span><span class="p">),</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="n">radii</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">radii</span><span class="p">),</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                <span class="n">grad_radius</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">,</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                <span class="n">grad_dim</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">,</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                <span class="n">grad_mat</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">,</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                <span class="n">uncertainty_node</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;uncertainty_node&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                <span class="n">_verbose</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_verbose&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            <span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>            <span class="n">new_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_cell</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>        <span class="c1"># Append mirrored structures to lattice</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_cells</span><span class="p">)</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;beams&quot;</span><span class="p">):</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_global_beams</span><span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_global_beams</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="p">):</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_global_nodes</span><span class="p">)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_global_nodes</span><span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="c1"># Recompute lattice dimensions/bounding box</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_lattice_dimensions</span><span class="p">()</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_beams_under_radius_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">        Delete beams with radii under a certain threshold</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">        Parameters:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">        -----------</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">        threshold: float</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">            Threshold value for beam radii</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>        <span class="n">beam_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>            <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>                <span class="n">beam_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beam_to_remove</span><span class="p">:</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>            <span class="n">beam</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delete_orphan_points</span><span class="p">()</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="c1"># SECTION: Helpers Methods</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_tag_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">        Define tag list classification.</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edge_tags</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">111</span><span class="p">],</span> <span class="p">[</span><span class="mi">101</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">110</span><span class="p">]]</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">face_tags</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]]</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corner_tags</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">1002</span><span class="p">,</span> <span class="mi">1003</span><span class="p">,</span> <span class="mi">1004</span><span class="p">,</span> <span class="mi">1005</span><span class="p">,</span> <span class="mi">1006</span><span class="p">,</span> <span class="mi">1007</span><span class="p">]]</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_size_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">        Computes the size of the lattice along each direction.</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="n">size_lattice</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>            <span class="n">total_length</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="n">cell_size</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>            <span class="n">gradient_factors</span> <span class="o">=</span> <span class="p">[</span><span class="n">grad</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="k">for</span> <span class="n">grad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">[:</span><span class="n">num_cells</span><span class="p">]]</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>            <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">gradient_factors</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                <span class="n">total_length</span> <span class="o">+=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">cell_size</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>            <span class="n">size_lattice</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_length</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_z</span> <span class="o">=</span> <span class="n">size_lattice</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_not_in_erased_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_cell_pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a><span class="sd">        Check if the cell is not in the erased region or inside the mesh.</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a><span class="sd">        Parameters:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a><span class="sd">        -----------</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a><span class="sd">        startCellPos: list of float</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="sd">            (xStart, yStart, zStart) position of the cell to check.</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="sd">        Returns:</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">        --------</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">        bool:</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">            True if the cell should be removed.</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>            <span class="k">for</span> <span class="n">delPart</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="p">:</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>                <span class="n">inside_erased</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>                    <span class="n">delPart</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">start_cell_pos</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">delPart</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">+</span> <span class="n">delPart</span><span class="p">[</span><span class="n">direction</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                    <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>                <span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>                <span class="k">if</span> <span class="n">inside_erased</span><span class="p">:</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># cell removed</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_beam_node_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">        Define index at each beam and node</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="c1"># Beams</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="n">existing_beam_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>        <span class="n">next_beam_idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">existing_beam_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">existing_beam_idx</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">beam_key</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Key for sorting beams by their endpoints and radius. &quot;&quot;&quot;</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            <span class="k">return</span> <span class="p">(</span><span class="nb">min</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">)),</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                    <span class="nb">max</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">)),</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                    <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">beam_key</span><span class="p">):</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                <span class="n">b</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">next_beam_idx</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>                <span class="n">next_beam_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>        <span class="c1"># Nodes</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>        <span class="n">existing_node_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>        <span class="n">next_node_idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">existing_node_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">existing_node_idx</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">node_key</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Key for sorting nodes by their coordinates. &quot;&quot;&quot;</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>            <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">z</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">node_key</span><span class="p">):</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">next_node_idx</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>                <span class="n">next_node_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_cell_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">        Define index at each cell</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>        <span class="n">cellIndexed</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="n">nextCellIndex</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>                <span class="n">cellIndexed</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextCellIndex</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>                <span class="n">nextCellIndex</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>                <span class="k">if</span> <span class="n">cell</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cellIndexed</span><span class="p">:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>                    <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">nextCellIndex</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                    <span class="n">cellIndexed</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextCellIndex</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                    <span class="n">nextCellIndex</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_node_local_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">        Define inside cell boundary tag for all boundary nodes</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                <span class="n">local_tag</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tag_point</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">boundary_box</span><span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                <span class="k">if</span> <span class="n">local_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>                    <span class="n">node</span><span class="o">.</span><span class="n">set_local_tag</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">local_tag</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_cell_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">        Neighbour assignment using integer grid indices + optional periodic wrap.</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        <span class="c1"># Build integer grid indices from positions</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>        <span class="n">inv_dx</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="n">inv_dy</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="n">inv_dz</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">to_idx</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">            Convert position to integer grid index.</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>            <span class="c1"># round to be robust to tiny float noise</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_dx</span><span class="p">)),</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_dy</span><span class="p">)),</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_dz</span><span class="p">)),</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>            <span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="n">idx_to_cell</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>            <span class="n">idx_to_cell</span><span class="p">[</span><span class="n">to_idx</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>        <span class="c1"># Grid extents for wrapping / bounds</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_to_cell</span><span class="p">})</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">j</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_to_cell</span><span class="p">})</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="n">zs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_to_cell</span><span class="p">})</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>        <span class="n">ix0</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="n">iy0</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>        <span class="n">iz0</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="c1"># Offsets and their (axis, sign) labels</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="n">neighbor_steps</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;negatif&quot;</span><span class="p">)),</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="p">((</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;positif&quot;</span><span class="p">)),</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;negatif&quot;</span><span class="p">)),</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;positif&quot;</span><span class="p">)),</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;negatif&quot;</span><span class="p">)),</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;positif&quot;</span><span class="p">)),</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="p">]</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>        <span class="c1"># Assign neighbours</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="c1"># reset dict container</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>            <span class="n">c</span><span class="o">.</span><span class="n">neighbour_cells</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span> <span class="o">=</span> <span class="n">to_idx</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>            <span class="k">for</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">),</span> <span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">sign</span><span class="p">)</span> <span class="ow">in</span> <span class="n">neighbor_steps</span><span class="p">:</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">niz</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">iz</span> <span class="o">+</span> <span class="n">dz</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span><span class="p">:</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                    <span class="c1"># periodic wrap (relative to min index of each axis)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                    <span class="k">if</span> <span class="n">nx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                        <span class="n">nix</span> <span class="o">=</span> <span class="n">ix0</span> <span class="o">+</span> <span class="p">((</span><span class="n">nix</span> <span class="o">-</span> <span class="n">ix0</span><span class="p">)</span> <span class="o">%</span> <span class="n">nx</span><span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                    <span class="k">if</span> <span class="n">ny</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                        <span class="n">niy</span> <span class="o">=</span> <span class="n">iy0</span> <span class="o">+</span> <span class="p">((</span><span class="n">niy</span> <span class="o">-</span> <span class="n">iy0</span><span class="p">)</span> <span class="o">%</span> <span class="n">ny</span><span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>                    <span class="k">if</span> <span class="n">nz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                        <span class="n">niz</span> <span class="o">=</span> <span class="n">iz0</span> <span class="o">+</span> <span class="p">((</span><span class="n">niz</span> <span class="o">-</span> <span class="n">iz0</span><span class="p">)</span> <span class="o">%</span> <span class="n">nz</span><span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                    <span class="c1"># hard bounds (skip if outside)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ix0</span> <span class="o">&lt;=</span> <span class="n">nix</span> <span class="o">&lt;</span> <span class="n">ix0</span> <span class="o">+</span> <span class="n">nx</span> <span class="ow">and</span> <span class="n">iy0</span> <span class="o">&lt;=</span> <span class="n">niy</span> <span class="o">&lt;</span> <span class="n">iy0</span> <span class="o">+</span> <span class="n">ny</span> <span class="ow">and</span> <span class="n">iz0</span> <span class="o">&lt;=</span> <span class="n">niz</span> <span class="o">&lt;</span> <span class="n">iz0</span> <span class="o">+</span> <span class="n">nz</span><span class="p">):</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>                        <span class="k">continue</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                <span class="n">neigh</span> <span class="o">=</span> <span class="n">idx_to_cell</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">niz</span><span class="p">))</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                <span class="k">if</span> <span class="n">neigh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                    <span class="n">c</span><span class="o">.</span><span class="n">add_cell_neighbour</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">sign</span><span class="p">,</span> <span class="n">neigh</span><span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_connected_beams_for_all_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merge_tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">        Populate `Point.connected_beams` for all nodes.</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">        Optionally merges connectivity for coincident/periodic nodes via a spatial hash.</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a><span class="sd">        Parameters</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="sd">        ----------</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="sd">        merge_tol : float</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">            Quantization used to bucket nearly-identical coordinates (and periodic wraps).</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="c1"># Reset connected_beams</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="c1"># Single pass: attach each beam to its two endpoints</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="n">a</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>            <span class="n">a</span><span class="o">.</span><span class="n">connected_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>            <span class="n">c</span><span class="o">.</span><span class="n">connected_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        <span class="c1">#  Optional stitching of coincident &amp; periodic nodes via spatial hashing</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>        <span class="c1"># Build spatial buckets</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">qkey</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Quantized key for spatial hashing.&quot;&quot;&quot;</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">merge_tol</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">merge_tol</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="n">merge_tol</span><span class="p">)</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="n">buckets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># geometric buckets (exact/coincident)</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="n">periodic_buckets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># buckets after wrapping (only if periodicity enabled)</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">add_to_bucket</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Add point to geometric bucket.&quot;&quot;&quot;</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="n">k</span> <span class="o">=</span> <span class="n">qkey</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>            <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">add_to_periodic_bucket</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Add point to periodic bucket (wrap max-face to min-face).&quot;&quot;&quot;</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>            <span class="n">wx</span> <span class="o">=</span> <span class="n">xmin</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">merge_tol</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>            <span class="n">wy</span> <span class="o">=</span> <span class="n">ymin</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">merge_tol</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>            <span class="n">wz</span> <span class="o">=</span> <span class="n">zmin</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">zmax</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">merge_tol</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>            <span class="n">k</span> <span class="o">=</span> <span class="n">qkey</span><span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>            <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>        <span class="c1"># Fill buckets</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>            <span class="n">add_to_bucket</span><span class="p">(</span><span class="n">buckets</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;enable_periodicity&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                <span class="n">add_to_periodic_bucket</span><span class="p">(</span><span class="n">periodic_buckets</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">merge_bucket_connectivity</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>            <span class="k">for</span> <span class="n">pts</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>                    <span class="k">continue</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>                <span class="n">merged</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>                    <span class="n">merged</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>                    <span class="n">pt</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>        <span class="n">merge_bucket_connectivity</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;enable_periodicity&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="n">merge_bucket_connectivity</span><span class="p">(</span><span class="n">periodic_buckets</span><span class="p">)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_angles_between_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">        Compute, for each beam, the penalization-optimal angle at its two endpoints</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">        using node-level connectivity (Point.connected_beams). Assumes</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">        `define_connected_beams_for_all_nodes()` has been called.</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_best_by_penalization</span><span class="p">(</span><span class="n">angles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Return (angle, radius) that maximizes L = function_penalization_Lzone((radius, angle)).&quot;&quot;&quot;</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">angles</span><span class="p">:</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>                <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>            <span class="n">Lmax</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">angles</span><span class="p">):</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">function_penalization_Lzone</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="o">&gt;</span> <span class="n">Lmax</span><span class="p">:</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>                    <span class="n">Lmax</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="n">L</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>            <span class="k">return</span> <span class="n">best</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="c1"># Compute angles using local node neighborhoods only</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">):</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                <span class="n">a1_list</span><span class="p">,</span> <span class="n">r1_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">:</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>                    <span class="k">if</span> <span class="n">nb</span> <span class="ow">is</span> <span class="n">b</span><span class="p">:</span> <span class="k">continue</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                        <span class="n">ang</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_angle_between_beams</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span><span class="p">)</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>                        <span class="k">continue</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>                    <span class="k">if</span> <span class="n">ang</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>                        <span class="n">a1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ang</span><span class="p">);</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>                        <span class="n">r1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                <span class="n">ang1</span><span class="p">,</span> <span class="n">rad1</span> <span class="o">=</span> <span class="n">_best_by_penalization</span><span class="p">(</span><span class="n">a1_list</span><span class="p">,</span> <span class="n">r1_list</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                <span class="n">b</span><span class="o">.</span><span class="n">set_angle</span><span class="p">(</span><span class="n">rad1</span><span class="p">,</span> <span class="n">ang1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="c1"># SECTION: Utils Methods</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_refresh_nodes_and_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">        Refresh the sets of nodes and beams in the lattice.</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        This is useful after adding or removing cells to ensure</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        that the lattice&#39;s nodes and beams accurately reflect its current state.</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_cells_memberships</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">        Public helper to refresh all cells&#39; beams/points from the current global state.</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;refresh_from_global&quot;</span><span class="p">):</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">refresh_from_global</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">        Removes a cell from the lattice</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">        Parameters:</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="sd">        ------------</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">        index: int</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">            index of the cell to remove</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Invalid cell index.&quot;</span><span class="p">)</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_minimum_beam_length</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">        Find minimum beam length</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">        Returns:</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">        --------</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">        minLength: float</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">            Length of the smallest beam in the lattice</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="n">minLength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>                <span class="k">if</span> <span class="n">minLength</span> <span class="o">&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mf">0.0001</span> <span class="ow">and</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>                    <span class="n">minLength</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">length</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        <span class="k">return</span> <span class="n">minLength</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tag_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the tag for all unique points in the lattice.&quot;&quot;&quot;</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tag_list_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the tag for boundary points in the lattice.&quot;&quot;&quot;</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_on_boundary</span><span class="p">(</span><span class="n">bbox</span><span class="p">)]</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_tag_all_point</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">        Assign a tag to all nodes in the lattice structure.</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">        Tags are assigned relative to either the global bounding box</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">        or a local (cell-relative) bounding box if erased parts are used.</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>        <span class="n">use_local_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_local_box</span><span class="p">:</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>            <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tag_point</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="k">return</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_occupancy_matrix</span><span class="p">()</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>            <span class="n">local_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relative_boundary_box</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tag_point</span><span class="p">(</span><span class="n">local_box</span><span class="p">)</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cell_occupancy_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">        Build a 3D matrix storing Cell objects (or None) at each (i, j, k).</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">        Returns</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">        -------</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">        occupancy_matrix : np.ndarray, shape (num_cells_x, num_cells_y, num_cells_z), dtype=object</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">            occupancy_matrix[i, j, k] is the Cell at that grid position, or None if empty.</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">pos</span>  <span class="c1"># integer grid indices</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cells_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">        Get all cells at a specific index along a specified axis.</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">        -----------</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">        axis: str</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">            Axis to query (&#39;x&#39;, &#39;y&#39;, or &#39;z&#39;).</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">        index: int</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">            Index along the specified axis.</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be &#39;x&#39;, &#39;y&#39;, or &#39;z&#39;&quot;</span><span class="p">)</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">        Get the relative boundary box of a cell in the lattice.</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">        It corresponds to the minimum and maximum dimension of the lattice for each axis with cell continuity.</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">        Useful for structures with erased parts or periodic boundaries.</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">        -----------</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">        cell: Cell object</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">            The cell for which the boundary box is computed.</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">pos</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="n">bbox</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>                <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">],</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>                <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>        <span class="p">):</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>            <span class="n">arrayCell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cells_at_index</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>            <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>            <span class="k">for</span> <span class="n">cellIn</span> <span class="ow">in</span> <span class="n">arrayCell</span><span class="p">:</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>                <span class="n">cellInBoundaryBox</span> <span class="o">=</span> <span class="n">cellIn</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>                <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cellInBoundaryBox</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>                <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cellInBoundaryBox</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>                <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cellInBoundaryBox</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be &#39;x&#39;, &#39;y&#39;, or &#39;z&#39;&quot;</span><span class="p">)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>                <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_val</span><span class="p">:</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>                    <span class="n">min_val</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>                <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_val</span><span class="p">:</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>                    <span class="n">max_val</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>            <span class="n">bbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_val</span><span class="p">)</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>            <span class="n">bbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_val</span><span class="p">)</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="k">return</span> <span class="n">bbox</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_name_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">        Determine the name_lattice of the lattice</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a><span class="sd">        WARNING: not updated</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="sd">        Returns:</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">        ---------</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="sd">        name_lattice: string</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">=</span> <span class="s2">&quot;Hybrid_&quot;</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">geom_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">):</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">+=</span> <span class="n">geom_type</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_simulation_properties</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">+=</span> <span class="s2">&quot;_Mod&quot;</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_hybrid_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a><span class="sd">        Check if beam in hybrid configuration is cut by a point in the geometry</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="sd">        Change the beam configuration of collisionned beams</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>            <span class="k">return</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>        <span class="n">beams_to_remove_global</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>        <span class="n">beams_to_add_global</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>        <span class="c1"># Per‚Äìcell containers for in-place updates</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>        <span class="n">per_cell_rem</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>        <span class="n">per_cell_add</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>        <span class="n">per_cell_pts</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>        <span class="c1"># Helper: quick AABB inclusion (with small tolerance)</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_in_aabb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aabb</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">aabb</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">tol</span> <span class="ow">and</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>                    <span class="n">ymin</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">tol</span> <span class="ow">and</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>                    <span class="n">zmin</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">zmax</span> <span class="o">+</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>        <span class="c1"># Build a lightweight per-cell point list (deterministic order)</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_sorted_pts</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">,</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>                          <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">nd</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">nd</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">nd</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>            <span class="c1"># Candidates are only points from this cell</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>            <span class="n">cell_points</span> <span class="o">=</span> <span class="n">_sorted_pts</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_points</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>                <span class="k">continue</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>            <span class="c1"># Process each beam of the cell, but only if this cell is the primary owner</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">):</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>                <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>                <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>                <span class="n">L2</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">*</span> <span class="n">vx</span> <span class="o">+</span> <span class="n">vy</span> <span class="o">*</span> <span class="n">vy</span> <span class="o">+</span> <span class="n">vz</span> <span class="o">*</span> <span class="n">vz</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>                <span class="k">if</span> <span class="n">L2</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>                    <span class="k">continue</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>                <span class="c1"># Tight AABB to skip most points quickly</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>                <span class="n">aabb</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>                        <span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>                        <span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>                <span class="n">internal</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cell_points</span><span class="p">:</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>                    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">p1</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">p2</span><span class="p">:</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>                        <span class="k">continue</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_in_aabb</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">aabb</span><span class="p">):</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>                        <span class="k">continue</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>                    <span class="c1"># exact geometric test</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>                    <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">is_point_on_beam</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="p">((</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">vx</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">vy</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">vz</span><span class="p">)</span> <span class="o">/</span> <span class="n">L2</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>                        <span class="k">if</span> <span class="mf">1e-12</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-12</span><span class="p">:</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>                            <span class="n">internal</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">internal</span><span class="p">:</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>                    <span class="k">continue</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>                <span class="n">internal</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tn</span><span class="p">:</span> <span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>                <span class="n">chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">internal</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">p2</span><span class="p">]</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>                <span class="c1"># Create split segments; keep all owners if provided, else just this cell</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>                <span class="n">seg_owners</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>                <span class="n">new_segments</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chain</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">chain</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>                    <span class="n">nb</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">,</span> <span class="n">seg_owners</span><span class="p">)</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>                    <span class="n">new_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>                <span class="c1"># Mark removals/additions per owner cell</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>                <span class="n">beams_to_remove_global</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>                <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">seg_owners</span><span class="p">:</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>                    <span class="n">per_cell_rem</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>                    <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">new_segments</span><span class="p">:</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>                        <span class="n">per_cell_add</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>                        <span class="n">per_cell_pts</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">point1</span><span class="p">)</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>                        <span class="n">per_cell_pts</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">point2</span><span class="p">)</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>                <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">new_segments</span><span class="p">:</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>                    <span class="n">beams_to_add_global</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="c1"># Apply per-cell edits</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>            <span class="n">rem</span> <span class="o">=</span> <span class="n">per_cell_rem</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>            <span class="n">add</span> <span class="o">=</span> <span class="n">per_cell_add</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>            <span class="n">pts</span> <span class="o">=</span> <span class="n">per_cell_pts</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>            <span class="k">if</span> <span class="n">rem</span><span class="p">:</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">remove_beam</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>            <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">add_beam</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>            <span class="k">if</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">add_point</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pts</span><span class="p">))</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="c1"># Update global sets</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="k">if</span> <span class="n">beams_to_remove_global</span><span class="p">:</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">beams_to_remove_global</span><span class="p">)</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>        <span class="k">if</span> <span class="n">beams_to_add_global</span><span class="p">:</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beams_to_add_global</span><span class="p">)</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="c1"># Refresh indices/connectivity once</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">are_cells_identical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a><span class="sd">        Check if all cells in the lattice are identical.</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s2">&quot;Only one or no cell: considered identical.&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>                <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>        <span class="n">attrs_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;geom_types&quot;</span><span class="p">,</span> <span class="s2">&quot;radii&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;grad_radius&quot;</span><span class="p">,</span> <span class="s2">&quot;grad_dim&quot;</span><span class="p">]</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_check</span><span class="p">:</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>                <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">_allclose</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>                        <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Difference found in attribute &#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&#39; between cell 0 and cell </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_pt_local_key</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>            <span class="k">return</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nd</span><span class="p">),</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>                    <span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nd</span><span class="p">),</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>                    <span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nd</span><span class="p">))</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_beam_key</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ndp</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ndr</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>            <span class="n">e1</span> <span class="o">=</span> <span class="n">_pt_local_key</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="n">ndp</span><span class="p">)</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>            <span class="n">e2</span> <span class="o">=</span> <span class="n">_pt_local_key</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="n">ndp</span><span class="p">)</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>            <span class="n">ends</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)))</span>  <span class="c1"># order-independent</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>            <span class="k">return</span> <span class="n">ends</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">radius</span><span class="p">),</span> <span class="n">ndr</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">material</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">type_beam</span><span class="p">)</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_beam_multiset</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>            <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span><span class="n">_beam_key</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>        <span class="n">ref_ms</span> <span class="o">=</span> <span class="n">_beam_multiset</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>            <span class="k">if</span> <span class="n">ref_ms</span> <span class="o">!=</span> <span class="n">_beam_multiset</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Beam topology/parameters differ between cell 0 and cell </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s2">&quot;All cells are identical.&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a><span class="c1"># SECTION: Optimization Methods</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">change_beam_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">        Change beam radius for all beams in the lattice</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a><span class="sd">        radius_list must have the same length as the number of different beam types in cells</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">        Take care if penalization is activated, the radius of penalized beams will be modified with the</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a><span class="sd">        penalization coefficient but the length of the modified beam will not be changed</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="sd">        (Use reset_cell_with_new_radii instead if you want to have clean cells for simulation)</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="sd">        ------------</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="sd">        radius_list: list of float</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="sd">            List of new radii for each beam type</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid hybrid radii data.&quot;</span><span class="p">)</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>            <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span><span class="p">:</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>                <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius_list</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">]</span> <span class="o">*</span> <span class="n">beam</span><span class="o">.</span><span class="n">penalization_coefficient</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>                <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius_list</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">]</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">change_beam_radius_depending_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeToChange</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">newRadius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="sd">        Change radii of beam for specific type_beam</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a><span class="sd">        -----------</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a><span class="sd">        typeToChange: int</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a><span class="sd">            Type of beam to change</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a><span class="sd">        newRadius: float</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a><span class="sd">            New radii of beam</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>                <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="n">typeToChange</span><span class="p">:</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>                    <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">newRadius</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="c1"># SECTION: Utils Methods</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_point_on_lattice_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfaceNames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">surface_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">]:</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a><span class="sd">        Find points on the surface of the lattice</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a><span class="sd">        -----------</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a><span class="sd">        surfaceNames: list[str]</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a><span class="sd">            List of surfaces to find points on (e.g., [&quot;Xmin&quot;, &quot;Xmax&quot;, &quot;Ymin&quot;])</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a><span class="sd">        surface_cells: list[str], optional</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a><span class="sd">            List of surfaces to find points on cells (e.g., [&quot;Xmin&quot;, &quot;Xmax&quot;, &quot;Ymin&quot;]). If None, use surfaceNames.</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a><span class="sd">        Returns:</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="sd">        --------</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="sd">        pointSet: set of point objects</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="sd">            Set of points found on the specified surfaces</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>        <span class="n">valid_surfaces</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmid&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymid&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmid&quot;</span><span class="p">}</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">surface</span> <span class="ow">in</span> <span class="n">valid_surfaces</span> <span class="k">for</span> <span class="n">surface</span> <span class="ow">in</span> <span class="n">surfaceNames</span><span class="p">):</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid surface name_lattice(s).&quot;</span><span class="p">)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>        <span class="n">cell_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cells_on_surfaces</span><span class="p">(</span><span class="n">surfaceNames</span><span class="p">)</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>        <span class="n">cell_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cell_list</span><span class="p">}</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">cell_indices</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid cell index, some cells do not exist.&quot;</span><span class="p">)</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>        <span class="n">surface_on_cells</span> <span class="o">=</span> <span class="n">surface_cells</span> <span class="k">if</span> <span class="n">surface_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">surfaceNames</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>        <span class="n">pointSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">cell_indices</span><span class="p">:</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>                <span class="n">cellPointSets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get_point_on_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">))</span> <span class="k">for</span> <span class="n">surface</span> <span class="ow">in</span> <span class="n">surface_on_cells</span><span class="p">]</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>                <span class="k">if</span> <span class="n">cellPointSets</span><span class="p">:</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>                    <span class="n">pointSet</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">cellPointSets</span><span class="p">))</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>        <span class="k">if</span> <span class="n">pointSet</span> <span class="o">==</span> <span class="nb">set</span><span class="p">():</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No points found on the specified surfaces.&quot;</span><span class="p">)</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>        <span class="k">return</span> <span class="n">pointSet</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cells_on_surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a><span class="sd">        Return the list of Cell objects matching ordered extrema constraints like [&quot;Xmin&quot;], [&quot;Xmin&quot;,&quot;Zmax&quot;], etc.</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a><span class="sd">        Filtering is iterative: e.g., first keep all cells at X minimum, then among those keep Z maximum.</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a><span class="sd">        Parameters</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a><span class="sd">        ----------</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a><span class="sd">        surfaces : list[str]</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a><span class="sd">            Each item is one of {&quot;Xmin&quot;,&quot;Xmax&quot;,&quot;Ymin&quot;,&quot;Ymax&quot;,&quot;Zmin&quot;,&quot;Zmax&quot;} (case-insensitive).</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a><span class="sd">        Returns</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a><span class="sd">        -------</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a><span class="sd">        list</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a><span class="sd">            List of Cell objects (possibly multiple if several share the same extreme index).</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>        <span class="c1"># Ensure occupancy matrix is available</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;occupancy_matrix&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_occupancy_matrix</span><span class="p">()</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>        <span class="c1"># Start from all occupied positions (use existing cells to avoid None handling)</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">]</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>        <span class="n">axis_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="p">:</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>                <span class="k">continue</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>            <span class="n">ax_char</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>            <span class="k">if</span> <span class="n">ax_char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis_map</span><span class="p">:</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid axis in constraint &#39;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&#39;, expected X/Y/Z with min/max.&quot;</span><span class="p">)</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis_map</span><span class="p">[</span><span class="n">ax_char</span><span class="p">]</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="k">if</span> <span class="s2">&quot;min&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>                <span class="n">extreme</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">)</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>            <span class="k">elif</span> <span class="s2">&quot;max&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>                <span class="n">extreme</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">)</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid extrema in constraint &#39;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&#39;, expected &#39;min&#39; or &#39;max&#39;.&quot;</span><span class="p">)</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="o">==</span> <span class="n">extreme</span><span class="p">]</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>                <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>        <span class="c1"># Map positions back to Cell objects via the occupancy matrix (ignore any None just in case)</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>        <span class="n">occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">occ</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="n">occ</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_statistics_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">        Print statistics about the lattice</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lattice name: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_name_lattice</span><span class="p">())</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of cells: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">))</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of beams: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_beams</span><span class="p">())</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of nodes: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_nodes</span><span class="p">())</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>        <span class="n">radMax</span><span class="p">,</span> <span class="n">radMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_beam_radius_min_max</span><span class="p">()</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radii max: &quot;</span><span class="p">,</span> <span class="n">radMax</span><span class="p">)</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radii min: &quot;</span><span class="p">,</span> <span class="n">radMin</span><span class="p">)</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lattice dimensions: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_z</span><span class="p">)</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_orphan_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a><span class="sd">        Delete points that are not connected to any beam in the lattice.</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>        <span class="n">live_points</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>            <span class="n">live_points</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">)</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>            <span class="n">live_points</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">)</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="n">all_points</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>            <span class="n">all_points</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="n">orphan_points</span> <span class="o">=</span> <span class="n">all_points</span> <span class="o">-</span> <span class="n">live_points</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">orphan_points</span><span class="p">:</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge_degree2_nodes</span><span class="p">(</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>            <span class="n">colinear_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>            <span class="n">radius_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">,</span>  <span class="c1"># &quot;inherit&quot; | &quot;max&quot; | &quot;min&quot; | &quot;avg&quot;</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>            <span class="n">type_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">,</span>  <span class="c1"># &quot;inherit&quot; -&gt; si diff√©rents, on prend b1</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>            <span class="n">material_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">,</span>  <span class="c1"># idem</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>            <span class="n">iterative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>            <span class="n">max_passes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">        Fusion of nodes with exactly 2 connected beams.</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a><span class="sd">        The two beams must be colinear (if colinear_only=True) and the node must be between the two beam endpoints.</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a><span class="sd">        The two beams are replaced by a single beam connecting the two distant endpoints.</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a><span class="sd">        -----------</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a><span class="sd">        colinear_only : bool</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">            If True, only merge if the two beams are colinear.</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a><span class="sd">        radius_strategy : str</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a><span class="sd">            Strategy for determining the radius of the new beam:</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a><span class="sd">            &quot;inherit&quot; (default) - if both beams have the same radius, use it; otherwise use b1&#39;s radius.</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a><span class="sd">            &quot;max&quot; - use the maximum radius of the two beams.</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a><span class="sd">            &quot;min&quot; - use the minimum radius of the two beams.</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a><span class="sd">            &quot;avg&quot; - use the average radius of the two beams.</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a><span class="sd">        type_strategy : str</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a><span class="sd">            Strategy for determining the type of the new beam:</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a><span class="sd">            &quot;inherit&quot; (default) - if both beams have the same type, use it; otherwise use b1&#39;s type.</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a><span class="sd">            &quot;max&quot; - use the maximum type of the two beams.</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a><span class="sd">            &quot;min&quot; - use the minimum type of the two beams.</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a><span class="sd">            &quot;avg&quot; - use the average type of the two beams (rounded).</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a><span class="sd">        material_strategy : str</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a><span class="sd">            Strategy for determining the material of the new beam:</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a><span class="sd">            &quot;inherit&quot; (default) - if both beams have the same material, use it; otherwise use b1&#39;s material.</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a><span class="sd">            &quot;max&quot; - use the maximum material of the two beams.</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a><span class="sd">            &quot;min&quot; - use the minimum material of the two beams.</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a><span class="sd">            &quot;avg&quot; - use the average material of the two beams (rounded).</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a><span class="sd">        iterative : bool</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a><span class="sd">            If True, repeat the merging process until no more merges are possible or max_passes is reached.</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a><span class="sd">        max_passes : int</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a><span class="sd">            Maximum number of passes if iterative is True.</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a><span class="sd">        Returns:</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a><span class="sd">        --------</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a><span class="sd">        total_merged : int</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a><span class="sd">            Total number of nodes merged.</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_has_beam_between</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>            <span class="c1"># Check if a beam already exists between points a and c</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span> <span class="ow">is</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span> <span class="ow">is</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">a</span><span class="p">):</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_choose</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">avg_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span><span class="p">:</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>                <span class="k">return</span> <span class="n">val1</span> <span class="k">if</span> <span class="n">val1</span> <span class="o">==</span> <span class="n">val2</span> <span class="ow">or</span> <span class="n">val2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val1</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">val1</span> <span class="o">+</span> <span class="n">val2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">avg_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">avg_fn</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>            <span class="k">return</span> <span class="n">val1</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>        <span class="n">total_merged</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>        <span class="n">passes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>            <span class="n">passes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>            <span class="c1"># Redefine connectivity</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>                <span class="k">break</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>            <span class="n">used_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>            <span class="n">merges</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>                <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>                <span class="k">if</span> <span class="n">b1</span> <span class="ow">in</span> <span class="n">used_beams</span> <span class="ow">or</span> <span class="n">b2</span> <span class="ow">in</span> <span class="n">used_beams</span><span class="p">:</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>                    <span class="k">continue</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>                <span class="n">a</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">point1</span> <span class="k">if</span> <span class="n">b1</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">p</span> <span class="k">else</span> <span class="n">b1</span><span class="o">.</span><span class="n">point2</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>                <span class="n">c</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">point1</span> <span class="k">if</span> <span class="n">b2</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">p</span> <span class="k">else</span> <span class="n">b2</span><span class="o">.</span><span class="n">point2</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">c</span><span class="p">:</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>                    <span class="k">continue</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>                <span class="k">if</span> <span class="n">colinear_only</span><span class="p">:</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>                    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>                    <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                    <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>                    <span class="k">if</span> <span class="n">n1</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">n2</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>                        <span class="k">continue</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>                    <span class="n">cross_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>                    <span class="k">if</span> <span class="n">cross_norm</span> <span class="o">&gt;</span> <span class="n">angle_tol</span> <span class="o">*</span> <span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="p">):</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>                        <span class="k">continue</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>                        <span class="k">continue</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>                <span class="k">if</span> <span class="n">_has_beam_between</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>                    <span class="k">continue</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>                <span class="n">merges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>                <span class="n">used_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>                <span class="n">used_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">merges</span><span class="p">:</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>                <span class="k">break</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>            <span class="n">beams_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>            <span class="n">beams_to_add</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>            <span class="n">points_to_destroy</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>            <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">:</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>                <span class="n">radius</span> <span class="o">=</span> <span class="n">_choose</span><span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius_strategy</span><span class="p">)</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>                <span class="n">typ</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">type_beam</span> <span class="k">if</span> <span class="p">(</span><span class="n">type_strategy</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span> <span class="ow">or</span> <span class="n">b1</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="n">b2</span><span class="o">.</span><span class="n">type_beam</span><span class="p">)</span> <span class="k">else</span> <span class="n">b1</span><span class="o">.</span><span class="n">type_beam</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>                <span class="n">mat</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">material</span> <span class="k">if</span> <span class="p">(</span><span class="n">material_strategy</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span> <span class="ow">or</span> <span class="n">b1</span><span class="o">.</span><span class="n">material</span> <span class="o">==</span> <span class="n">b2</span><span class="o">.</span><span class="n">material</span><span class="p">)</span> <span class="k">else</span> <span class="n">b1</span><span class="o">.</span><span class="n">material</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>                <span class="n">cells_union</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>                <span class="k">for</span> <span class="n">bm</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">):</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>                    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bm</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>                        <span class="n">cells_union</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>                <span class="n">new_beam</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">cells_union</span><span class="p">))</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>                <span class="k">for</span> <span class="n">bm</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">):</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>                    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">bm</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]))):</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>                        <span class="n">cell</span><span class="o">.</span><span class="n">remove_beam</span><span class="p">(</span><span class="n">bm</span><span class="p">)</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells_union</span><span class="p">:</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>                    <span class="n">cell</span><span class="o">.</span><span class="n">add_beam</span><span class="p">([</span><span class="n">new_beam</span><span class="p">])</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>                <span class="n">beams_to_remove</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">])</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>                <span class="n">beams_to_add</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_beam</span><span class="p">)</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>                <span class="n">points_to_destroy</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">beams_to_remove</span><span class="p">)</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beams_to_add</span><span class="p">)</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points_to_destroy</span><span class="p">:</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>                <span class="n">p</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>            <span class="n">merged_this_pass</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merges</span><span class="p">)</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>            <span class="n">total_merged</span> <span class="o">+=</span> <span class="n">merged_this_pass</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">iterative</span> <span class="ow">or</span> <span class="n">passes</span> <span class="o">&gt;=</span> <span class="n">max_passes</span><span class="p">:</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>                <span class="k">break</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delete_orphan_points</span><span class="p">()</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>        <span class="k">return</span> <span class="n">total_merged</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_unconnected_beams</span><span class="p">(</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>            <span class="n">protect_fixed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>            <span class="n">protect_loaded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>            <span class="n">also_delete_orphan_nodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a><span class="sd">        Delete beams that are &quot;leaf&quot; beams, i.e. connected to at least one node of degree 1 or 0.</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a><span class="sd">        -----------</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a><span class="sd">        protect_fixed: bool</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a><span class="sd">            If True, do not delete beams connected to fixed nodes.</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a><span class="sd">        protect_loaded: bool</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a><span class="sd">            If True, do not delete beams connected to loaded nodes.</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a><span class="sd">        also_delete_orphan_nodes: bool</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a><span class="sd">            If True, delete nodes that become orphaned after beam removal.</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a><span class="sd">        Returns:</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a><span class="sd">        --------</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a><span class="sd">        tuple[int, int]</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a><span class="sd">            Number of beams removed and number of nodes removed.</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>        <span class="c1"># Deactivate periodicity to ensure correct connectivity checks</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>        <span class="c1"># Identify beams to remove</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>        <span class="n">to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">):</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>            <span class="n">deg1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>            <span class="n">deg2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>            <span class="n">is_leaf_bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">deg1</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">deg2</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_leaf_bar</span><span class="p">:</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>                <span class="k">continue</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>            <span class="n">p1_fixed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">fixed_DOF</span><span class="p">)</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>            <span class="n">p2_fixed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">fixed_DOF</span><span class="p">)</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>            <span class="n">p1_load</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">applied_force</span><span class="p">)</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>            <span class="n">p2_load</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">applied_force</span><span class="p">)</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>            <span class="c1"># Protect beams connected to fixed or loaded nodes if specified</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>            <span class="k">if</span> <span class="n">protect_fixed</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p1_fixed</span> <span class="ow">or</span> <span class="n">p2_fixed</span><span class="p">):</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>                <span class="k">continue</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>            <span class="k">if</span> <span class="n">protect_loaded</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p1_load</span> <span class="ow">or</span> <span class="n">p2_load</span><span class="p">):</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>                <span class="k">continue</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>            <span class="n">to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_remove</span><span class="p">:</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>        <span class="c1"># Remove identified beams from cells</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>            <span class="n">b</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>        <span class="c1"># Delete orphan nodes if specified</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>        <span class="n">removed_pts</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>        <span class="k">if</span> <span class="n">also_delete_orphan_nodes</span><span class="p">:</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delete_orphan_points</span><span class="p">()</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_remove</span><span class="p">),</span> <span class="n">removed_pts</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a><span class="c1"># SECTION: Other Methods</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a><span class="c1"># =============================================================================</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;meshing&quot;</span><span class="p">)</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_mesh_lattice_Gmsh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut_mesh_at_boundary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mesh_refinement</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>                                   <span class="n">name_mesh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Lattice&quot;</span><span class="p">,</span><span class="n">save_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save_STL</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>                                   <span class="n">volume_computation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">only_volume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>                                   <span class="n">only_relative_density</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cell_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a><span class="sd">        Generate a 2D mesh representation of the lattice structure using GMSH.</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a><span class="sd">        Generating 3D mesh for simulation is not currently supported, but will be in the future.</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="sd">        -----------</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="sd">        cut_mesh_at_boundary: bool</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a><span class="sd">            If True, the mesh will be cut at the boundary of the lattice.</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a><span class="sd">        mesh_refinement: float</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a><span class="sd">            Refinement factor for the mesh (higher values lead to finer meshes).</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a><span class="sd">        name_mesh: str</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a><span class="sd">            Name of the mesh to be generated.</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a><span class="sd">        save_mesh: bool</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a><span class="sd">            If True, the mesh will be saved to a file.</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a><span class="sd">        save_STL: bool</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a><span class="sd">            If True, the mesh will be saved in STL format.</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a><span class="sd">        volume_computation: bool</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a><span class="sd">            If True, the volume of the mesh will be computed and printed.</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a><span class="sd">        only_volume: bool</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a><span class="sd">            If True, only the volume of the mesh will be computed and returned.</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a><span class="sd">        only_relative_density: bool</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a><span class="sd">            If True, only the relative density of the mesh will be computed and returned.</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a><span class="sd">        cell_index: int | None</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a><span class="sd">            If provided, only the specified cell will be meshed.</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;General.Verbosity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name_mesh</span><span class="p">)</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Geometry.OCCFixDegenerated&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Geometry.OCCFixSmallEdges&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Geometry.OCCFixSmallFaces&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.CharacteristicLengthFromCurvature&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MinimumCircleNodes&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>  <span class="c1"># help meshing thin cylinders</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>        <span class="n">N_CIRC_TARGET</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">mesh_refinement</span>  <span class="c1"># ~elements around the circumference (same for all radii)</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>        <span class="n">N_AXIAL_TARGET</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">mesh_refinement</span>  <span class="c1"># ~elements along each beam axis (same for all beam lengths)</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>        <span class="n">mesh_size_max</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MinimumCircleNodes&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">N_CIRC_TARGET</span><span class="p">))</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Dimension of the mesh</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>        <span class="c1"># Find beams to mesh</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>        <span class="k">if</span> <span class="n">cell_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>            <span class="k">if</span> <span class="n">cell_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cell_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid cell index.&quot;</span><span class="p">)</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>            <span class="n">beams_to_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span><span class="o">.</span><span class="n">beams_cell</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>            <span class="n">beams_to_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>        <span class="n">all_tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams_to_mesh</span><span class="p">:</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>            <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>            <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>            <span class="n">direction</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>            <span class="c1"># Use initial radius if defined</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>            <span class="n">radius</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">initial_radius</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="s2">&quot;initial_radius&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>            <span class="n">min_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">mesh_size_max</span><span class="p">)</span>  <span class="c1"># avoid too-short beams wrt mesh size</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_len</span> <span class="ow">or</span> <span class="n">radius</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>                <span class="k">continue</span>  <span class="c1"># skip near-zero length or non-positive radius</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>            <span class="n">tag</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCylinder</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>            <span class="n">all_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">p2</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">L</span><span class="p">))</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>        <span class="c1"># Merge all beams into a single entity</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>        <span class="n">beam_entities</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">]</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>            <span class="n">lattice</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">fragment</span><span class="p">(</span><span class="n">beam_entities</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fragmentation failed:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>        <span class="k">if</span> <span class="n">cut_mesh_at_boundary</span><span class="p">:</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>            <span class="c1"># Bounding box definition</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">-</span> <span class="n">z0</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>            <span class="n">box</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addBox</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">lattice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[(</span><span class="n">dim</span><span class="p">,</span> <span class="n">box</span><span class="p">)],</span> <span class="n">removeObject</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">removeTool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intersection failed:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>        <span class="k">if</span> <span class="n">only_relative_density</span><span class="p">:</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>            <span class="n">relative_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relative_density_mesh</span><span class="p">()</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>            <span class="k">return</span> <span class="n">relative_density</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>        <span class="n">total_volume</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>        <span class="k">if</span> <span class="n">volume_computation</span> <span class="ow">or</span> <span class="n">only_volume</span><span class="p">:</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>            <span class="n">total_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume_mesh</span><span class="p">(</span><span class="n">synchronize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>            <span class="k">if</span> <span class="n">only_volume</span><span class="p">:</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>                <span class="k">return</span> <span class="n">total_volume</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>        <span class="c1"># Define mesh size</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>        <span class="n">pts</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_proj_param_and_dist</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>            <span class="n">AB</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">A</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>            <span class="n">denom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">AB</span><span class="p">))</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>            <span class="k">if</span> <span class="n">denom</span> <span class="o">&lt;=</span> <span class="mf">1e-30</span><span class="p">:</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>                <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">A</span><span class="p">))</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">A</span><span class="p">,</span> <span class="n">AB</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>            <span class="n">Q</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">AB</span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Q</span><span class="p">))</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getCenterOfMass</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>            <span class="c1"># find nearest beam (by radial distance to axis)</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>            <span class="n">dmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>            <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (r, L)</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>            <span class="k">for</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">_proj_param_and_dist</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">dmin</span><span class="p">:</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a>                    <span class="n">dmin</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>                    <span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>            <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt</span><span class="p">)],</span> <span class="nb">float</span><span class="p">(</span><span class="n">mesh_size_max</span><span class="p">))</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>                <span class="k">continue</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>            <span class="n">rnear</span><span class="p">,</span> <span class="n">Lbeam</span> <span class="o">=</span> <span class="n">best</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>            <span class="c1"># target sizes for constant element counts:</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>            <span class="c1"># - around circumference: h_circ ‚âà 2œÄr / N_CIRC_TARGET</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>            <span class="c1"># - along axis:          h_ax   ‚âà L / N_AXIAL_TARGET</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>            <span class="n">h_circ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rnear</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_CIRC_TARGET</span><span class="p">))</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>            <span class="n">h_ax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Lbeam</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_AXIAL_TARGET</span><span class="p">))</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>            <span class="n">h_base</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">h_circ</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">))</span>  <span class="c1"># respect both targets, avoid zero</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>            <span class="c1"># allow growth away from the beam (outside ~3r ‚Üí up to mesh_size)</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>            <span class="k">if</span> <span class="n">dmin</span> <span class="o">&lt;=</span> <span class="n">rnear</span><span class="p">:</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="n">h_base</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>            <span class="k">elif</span> <span class="n">dmin</span> <span class="o">&gt;=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">rnear</span><span class="p">:</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mesh_size_max</span><span class="p">)</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>                <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmin</span> <span class="o">-</span> <span class="n">rnear</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">rnear</span><span class="p">)</span>  <span class="c1"># linear ramp between r and 3r</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="n">h_base</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mesh_size_max</span><span class="p">)</span> <span class="o">-</span> <span class="n">h_base</span><span class="p">)</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt</span><span class="p">)],</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;outputs&quot;</span> <span class="o">/</span> <span class="s2">&quot;mesh_file&quot;</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>        <span class="k">if</span> <span class="n">save_mesh</span><span class="p">:</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_mesh</span><span class="si">}</span><span class="s2">.msh&quot;</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mesh_file saved at &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>        <span class="k">if</span> <span class="n">save_STL</span><span class="p">:</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_mesh</span><span class="si">}</span><span class="s2">.stl&quot;</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mesh_file saved at &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>        <span class="k">if</span> <span class="n">volume_computation</span><span class="p">:</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>            <span class="k">return</span> <span class="n">total_volume</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;meshing&quot;</span><span class="p">)</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_volume_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entities_3d</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">synchronize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>                        <span class="n">return_details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a><span class="sd">        Compute the exact CAD volume (OCC &#39;mass&#39; with unit density) of the current model</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a><span class="sd">        without requiring any meshing.</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a><span class="sd">        Parameters</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a><span class="sd">        ----------</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a><span class="sd">        entities_3d : list[(int,int)] | None</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a><span class="sd">            Optional list of 3D OCC entities (pairs (dim=3, tag)). If None, all 3D</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a><span class="sd">            entities in the current model are used.</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a><span class="sd">        synchronize : bool</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a><span class="sd">            If True, call gmsh.model.occ.synchronize() before querying mass properties.</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a><span class="sd">            Set to False only if you&#39;ve already synchronized after your boolean ops.</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a><span class="sd">        return_details : bool</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a><span class="sd">            If True, return a dict with &#39;total&#39; and &#39;per_entity&#39; (list of (tag, volume)).</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a><span class="sd">        Returns</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a><span class="sd">        -------</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a><span class="sd">        float | dict</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a><span class="sd">            Total volume if return_details is False, else a dict:</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a><span class="sd">            {&#39;total&#39;: float, &#39;per_entity&#39;: [(tag:int, volume:float), ...]}</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>        <span class="k">if</span> <span class="n">synchronize</span><span class="p">:</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>        <span class="c1"># Default: all 3D solids present in the model</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>        <span class="k">if</span> <span class="n">entities_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>            <span class="n">entities_3d</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>        <span class="c1"># Guard against empty list</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">entities_3d</span><span class="p">:</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_volume_mesh: no 3D entities found; volume = 0.0&quot;</span><span class="p">)</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;per_entity&#39;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">if</span> <span class="n">return_details</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>        <span class="c1"># Sum exact OCC &#39;mass&#39; (density=1 =&gt; mass == volume)</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">entities_3d</span><span class="p">:</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a>            <span class="c1"># Defensive: ensure correct dimension</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a>            <span class="k">if</span> <span class="n">dim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>                <span class="k">continue</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getMass</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>            <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>            <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tag</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total volume: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span> <span class="s1">&#39;per_entity&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">}</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>        <span class="k">return</span> <span class="n">total</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;meshing&quot;</span><span class="p">)</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solids_3d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">domain_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a><span class="sd">        Compute relative density = V_solid / V_domain using exact CAD volumes.</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a><span class="sd">        If domain_volume is None, the domain is taken as the axis-aligned box</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a><span class="sd">        defined by (x_min..x_max) √ó (y_min..y_max) √ó (z_min..z_max).</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>        <span class="n">V_solid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume_mesh</span><span class="p">(</span><span class="n">entities_3d</span><span class="o">=</span><span class="n">solids_3d</span><span class="p">,</span> <span class="n">synchronize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>        <span class="k">if</span> <span class="n">domain_volume</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>            <span class="n">Lx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a>            <span class="n">Ly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a>            <span class="n">Lz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>            <span class="n">V_domain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Lx</span> <span class="o">*</span> <span class="n">Ly</span> <span class="o">*</span> <span class="n">Lz</span><span class="p">)</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>            <span class="n">V_domain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">domain_volume</span><span class="p">)</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>        <span class="k">if</span> <span class="n">V_domain</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;get_relative_density: domain volume must be positive.&quot;</span><span class="p">)</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>        <span class="k">return</span> <span class="n">V_solid</span> <span class="o">/</span> <span class="n">V_domain</span>
</span></pre></div>


            </section>
                <section id="Lattice">
                            <input id="Lattice-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Lattice</span>:

                <label class="view-source-button" for="Lattice-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice-30"><a href="#Lattice-30"><span class="linenos">  30</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="Lattice-31"><a href="#Lattice-31"><span class="linenos">  31</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-32"><a href="#Lattice-32"><span class="linenos">  32</span></a><span class="sd">    Class to generate lattice structures with various parameters and properties.</span>
</span><span id="Lattice-33"><a href="#Lattice-33"><span class="linenos">  33</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Lattice-34"><a href="#Lattice-34"><span class="linenos">  34</span></a>
</span><span id="Lattice-35"><a href="#Lattice-35"><span class="linenos">  35</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mesh_trimmer</span><span class="p">:</span> <span class="s2">&quot;MeshTrimmer&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="Lattice-36"><a href="#Lattice-36"><span class="linenos">  36</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-37"><a href="#Lattice-37"><span class="linenos">  37</span></a><span class="sd">        Constructor from a JSON file to create a lattice object.</span>
</span><span id="Lattice-38"><a href="#Lattice-38"><span class="linenos">  38</span></a>
</span><span id="Lattice-39"><a href="#Lattice-39"><span class="linenos">  39</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-40"><a href="#Lattice-40"><span class="linenos">  40</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-41"><a href="#Lattice-41"><span class="linenos">  41</span></a><span class="sd">        name_file: str</span>
</span><span id="Lattice-42"><a href="#Lattice-42"><span class="linenos">  42</span></a><span class="sd">            Name of the JSON file containing lattice parameters.</span>
</span><span id="Lattice-43"><a href="#Lattice-43"><span class="linenos">  43</span></a>
</span><span id="Lattice-44"><a href="#Lattice-44"><span class="linenos">  44</span></a><span class="sd">        mesh_trimmer: MeshTrimmer, optional</span>
</span><span id="Lattice-45"><a href="#Lattice-45"><span class="linenos">  45</span></a><span class="sd">            MeshTrimmer object to trim the lattice.</span>
</span><span id="Lattice-46"><a href="#Lattice-46"><span class="linenos">  46</span></a>
</span><span id="Lattice-47"><a href="#Lattice-47"><span class="linenos">  47</span></a><span class="sd">        _verbose: int, optional</span>
</span><span id="Lattice-48"><a href="#Lattice-48"><span class="linenos">  48</span></a><span class="sd">            Verbosity level for logging.</span>
</span><span id="Lattice-49"><a href="#Lattice-49"><span class="linenos">  49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-50"><a href="#Lattice-50"><span class="linenos">  50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span> <span class="o">=</span> <span class="n">mesh_trimmer</span>
</span><span id="Lattice-51"><a href="#Lattice-51"><span class="linenos">  51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="Lattice-52"><a href="#Lattice-52"><span class="linenos">  52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timing</span> <span class="o">=</span> <span class="n">timing</span>
</span><span id="Lattice-53"><a href="#Lattice-53"><span class="linenos">  53</span></a>
</span><span id="Lattice-54"><a href="#Lattice-54"><span class="linenos">  54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Lattice&quot;</span>
</span><span id="Lattice-55"><a href="#Lattice-55"><span class="linenos">  55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Lattice-56"><a href="#Lattice-56"><span class="linenos">  56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Lattice-57"><a href="#Lattice-57"><span class="linenos">  57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Lattice-58"><a href="#Lattice-58"><span class="linenos">  58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Lattice-59"><a href="#Lattice-59"><span class="linenos">  59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Lattice-60"><a href="#Lattice-60"><span class="linenos">  60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-61"><a href="#Lattice-61"><span class="linenos">  61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-62"><a href="#Lattice-62"><span class="linenos">  62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_randomness</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice-63"><a href="#Lattice-63"><span class="linenos">  63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">randomness_hybrid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-64"><a href="#Lattice-64"><span class="linenos">  64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-65"><a href="#Lattice-65"><span class="linenos">  65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Lattice-66"><a href="#Lattice-66"><span class="linenos">  66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-67"><a href="#Lattice-67"><span class="linenos">  67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-68"><a href="#Lattice-68"><span class="linenos">  68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-69"><a href="#Lattice-69"><span class="linenos">  69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Warning not working for graded structures</span>
</span><span id="Lattice-70"><a href="#Lattice-70"><span class="linenos">  70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_simulation_properties</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice-71"><a href="#Lattice-71"><span class="linenos">  71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice-72"><a href="#Lattice-72"><span class="linenos">  72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice-73"><a href="#Lattice-73"><span class="linenos">  73</span></a>
</span><span id="Lattice-74"><a href="#Lattice-74"><span class="linenos">  74</span></a>        <span class="c1"># Containers</span>
</span><span id="Lattice-75"><a href="#Lattice-75"><span class="linenos">  75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-76"><a href="#Lattice-76"><span class="linenos">  76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-77"><a href="#Lattice-77"><span class="linenos">  77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-78"><a href="#Lattice-78"><span class="linenos">  78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edge_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-79"><a href="#Lattice-79"><span class="linenos">  79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">face_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-80"><a href="#Lattice-80"><span class="linenos">  80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corner_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-81"><a href="#Lattice-81"><span class="linenos">  81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lattice_dimension_dict</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-82"><a href="#Lattice-82"><span class="linenos">  82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-83"><a href="#Lattice-83"><span class="linenos">  83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_lattice</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-84"><a href="#Lattice-84"><span class="linenos">  84</span></a>
</span><span id="Lattice-85"><a href="#Lattice-85"><span class="linenos">  85</span></a>        <span class="c1"># Generate global structure</span>
</span><span id="Lattice-86"><a href="#Lattice-86"><span class="linenos">  86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">extract_parameters_from_json</span><span class="p">(</span><span class="n">name_file</span><span class="p">)</span>
</span><span id="Lattice-87"><a href="#Lattice-87"><span class="linenos">  87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_lattice</span><span class="p">()</span>
</span><span id="Lattice-88"><a href="#Lattice-88"><span class="linenos">  88</span></a>
</span><span id="Lattice-89"><a href="#Lattice-89"><span class="linenos">  89</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-90"><a href="#Lattice-90"><span class="linenos">  90</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">apply_symmetry</span><span class="p">()</span>
</span><span id="Lattice-91"><a href="#Lattice-91"><span class="linenos">  91</span></a>
</span><span id="Lattice-92"><a href="#Lattice-92"><span class="linenos">  92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_size_lattice</span><span class="p">()</span>
</span><span id="Lattice-93"><a href="#Lattice-93"><span class="linenos">  93</span></a>
</span><span id="Lattice-94"><a href="#Lattice-94"><span class="linenos">  94</span></a>        <span class="c1"># Generate important data for the lattice structure</span>
</span><span id="Lattice-95"><a href="#Lattice-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_tag_classification</span><span class="p">()</span>
</span><span id="Lattice-96"><a href="#Lattice-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_lattice_dimensions</span><span class="p">()</span>
</span><span id="Lattice-97"><a href="#Lattice-97"><span class="linenos">  97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice-98"><a href="#Lattice-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_cell_index</span><span class="p">()</span>
</span><span id="Lattice-99"><a href="#Lattice-99"><span class="linenos">  99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_cell_neighbours</span><span class="p">()</span>
</span><span id="Lattice-100"><a href="#Lattice-100"><span class="linenos"> 100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="Lattice-101"><a href="#Lattice-101"><span class="linenos"> 101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">apply_tag_all_point</span><span class="p">()</span>
</span><span id="Lattice-102"><a href="#Lattice-102"><span class="linenos"> 102</span></a>
</span><span id="Lattice-103"><a href="#Lattice-103"><span class="linenos"> 103</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_flag</span><span class="p">:</span>
</span><span id="Lattice-104"><a href="#Lattice-104"><span class="linenos"> 104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">are_cells_identical</span><span class="p">()</span>
</span><span id="Lattice-105"><a href="#Lattice-105"><span class="linenos"> 105</span></a>
</span><span id="Lattice-106"><a href="#Lattice-106"><span class="linenos"> 106</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-107"><a href="#Lattice-107"><span class="linenos"> 107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">print_statistics_lattice</span><span class="p">()</span>
</span><span id="Lattice-108"><a href="#Lattice-108"><span class="linenos"> 108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span><span id="Lattice-109"><a href="#Lattice-109"><span class="linenos"> 109</span></a>
</span><span id="Lattice-110"><a href="#Lattice-110"><span class="linenos"> 110</span></a>    <span class="nd">@classmethod</span>
</span><span id="Lattice-111"><a href="#Lattice-111"><span class="linenos"> 111</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">open_pickle_lattice</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;LatticeObject&quot;</span><span class="p">,</span> <span class="n">sim_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Lattice&quot;</span><span class="p">:</span>
</span><span id="Lattice-112"><a href="#Lattice-112"><span class="linenos"> 112</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-113"><a href="#Lattice-113"><span class="linenos"> 113</span></a><span class="sd">        Load a lattice pickle and (optionally) upcast it to the caller&#39;s class (e.g., LatticeSim).</span>
</span><span id="Lattice-114"><a href="#Lattice-114"><span class="linenos"> 114</span></a><span class="sd">        If the target class defines `_post_load_init`, it will be invoked after loading.</span>
</span><span id="Lattice-115"><a href="#Lattice-115"><span class="linenos"> 115</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-116"><a href="#Lattice-116"><span class="linenos"> 116</span></a>        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Lattice-117"><a href="#Lattice-117"><span class="linenos"> 117</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;outputs&quot;</span> <span class="o">/</span> <span class="s2">&quot;saved_lattice_file&quot;</span> <span class="o">/</span> <span class="n">file_name</span>
</span><span id="Lattice-118"><a href="#Lattice-118"><span class="linenos"> 118</span></a>        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">:</span>
</span><span id="Lattice-119"><a href="#Lattice-119"><span class="linenos"> 119</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
</span><span id="Lattice-120"><a href="#Lattice-120"><span class="linenos"> 120</span></a>
</span><span id="Lattice-121"><a href="#Lattice-121"><span class="linenos"> 121</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="Lattice-122"><a href="#Lattice-122"><span class="linenos"> 122</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
</span><span id="Lattice-123"><a href="#Lattice-123"><span class="linenos"> 123</span></a>
</span><span id="Lattice-124"><a href="#Lattice-124"><span class="linenos"> 124</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice-125"><a href="#Lattice-125"><span class="linenos"> 125</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Lattice-126"><a href="#Lattice-126"><span class="linenos"> 126</span></a>                <span class="n">lattice</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="Lattice-127"><a href="#Lattice-127"><span class="linenos"> 127</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Lattice-128"><a href="#Lattice-128"><span class="linenos"> 128</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load lattice from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Lattice-129"><a href="#Lattice-129"><span class="linenos"> 129</span></a>
</span><span id="Lattice-130"><a href="#Lattice-130"><span class="linenos"> 130</span></a>        <span class="c1"># Normalize containers</span>
</span><span id="Lattice-131"><a href="#Lattice-131"><span class="linenos"> 131</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice-132"><a href="#Lattice-132"><span class="linenos"> 132</span></a>            <span class="n">lattice</span><span class="o">.</span><span class="n">beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
</span><span id="Lattice-133"><a href="#Lattice-133"><span class="linenos"> 133</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice-134"><a href="#Lattice-134"><span class="linenos"> 134</span></a>            <span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="Lattice-135"><a href="#Lattice-135"><span class="linenos"> 135</span></a>
</span><span id="Lattice-136"><a href="#Lattice-136"><span class="linenos"> 136</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-137"><a href="#Lattice-137"><span class="linenos"> 137</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice-138"><a href="#Lattice-138"><span class="linenos"> 138</span></a>                <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="Lattice-139"><a href="#Lattice-139"><span class="linenos"> 139</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;points_cell&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice-140"><a href="#Lattice-140"><span class="linenos"> 140</span></a>                <span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="Lattice-141"><a href="#Lattice-141"><span class="linenos"> 141</span></a>
</span><span id="Lattice-142"><a href="#Lattice-142"><span class="linenos"> 142</span></a>        <span class="n">lattice</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice-143"><a href="#Lattice-143"><span class="linenos"> 143</span></a>
</span><span id="Lattice-144"><a href="#Lattice-144"><span class="linenos"> 144</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice-145"><a href="#Lattice-145"><span class="linenos"> 145</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-146"><a href="#Lattice-146"><span class="linenos"> 146</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-147"><a href="#Lattice-147"><span class="linenos"> 147</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice-148"><a href="#Lattice-148"><span class="linenos"> 148</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="Lattice-149"><a href="#Lattice-149"><span class="linenos"> 149</span></a>
</span><span id="Lattice-150"><a href="#Lattice-150"><span class="linenos"> 150</span></a>        <span class="c1"># --- upcast to the caller class if needed (e.g., LatticeSim) ---</span>
</span><span id="Lattice-151"><a href="#Lattice-151"><span class="linenos"> 151</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Lattice</span><span class="p">):</span>
</span><span id="Lattice-152"><a href="#Lattice-152"><span class="linenos"> 152</span></a>            <span class="n">upgraded</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span id="Lattice-153"><a href="#Lattice-153"><span class="linenos"> 153</span></a>            <span class="n">upgraded</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="Lattice-154"><a href="#Lattice-154"><span class="linenos"> 154</span></a>            <span class="n">lattice</span> <span class="o">=</span> <span class="n">upgraded</span>
</span><span id="Lattice-155"><a href="#Lattice-155"><span class="linenos"> 155</span></a>            <span class="n">post</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;_post_load_init&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Lattice-156"><a href="#Lattice-156"><span class="linenos"> 156</span></a>            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">post</span><span class="p">):</span>
</span><span id="Lattice-157"><a href="#Lattice-157"><span class="linenos"> 157</span></a>                <span class="n">post</span><span class="p">(</span><span class="n">sim_config</span><span class="p">)</span>
</span><span id="Lattice-158"><a href="#Lattice-158"><span class="linenos"> 158</span></a>
</span><span id="Lattice-159"><a href="#Lattice-159"><span class="linenos"> 159</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lattice loaded successfully from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Lattice-160"><a href="#Lattice-160"><span class="linenos"> 160</span></a>        <span class="k">return</span> <span class="n">lattice</span>
</span><span id="Lattice-161"><a href="#Lattice-161"><span class="linenos"> 161</span></a>
</span><span id="Lattice-162"><a href="#Lattice-162"><span class="linenos"> 162</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Lattice-163"><a href="#Lattice-163"><span class="linenos"> 163</span></a>        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Lattice name_lattice: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Lattice-164"><a href="#Lattice-164"><span class="linenos"> 164</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Dimensions: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size_z</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Lattice-165"><a href="#Lattice-165"><span class="linenos"> 165</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Number of cells: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Lattice-166"><a href="#Lattice-166"><span class="linenos"> 166</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Cell size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Lattice-167"><a href="#Lattice-167"><span class="linenos"> 167</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;radii: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Lattice-168"><a href="#Lattice-168"><span class="linenos"> 168</span></a>        <span class="k">return</span> <span class="n">string</span>
</span><span id="Lattice-169"><a href="#Lattice-169"><span class="linenos"> 169</span></a>
</span><span id="Lattice-170"><a href="#Lattice-170"><span class="linenos"> 170</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Lattice-171"><a href="#Lattice-171"><span class="linenos"> 171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-172"><a href="#Lattice-172"><span class="linenos"> 172</span></a><span class="sd">        Compare two Lattice objects based on the radii of each cell.</span>
</span><span id="Lattice-173"><a href="#Lattice-173"><span class="linenos"> 173</span></a><span class="sd">        Returns True if they have the same number of cells and identical radii values.</span>
</span><span id="Lattice-174"><a href="#Lattice-174"><span class="linenos"> 174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-175"><a href="#Lattice-175"><span class="linenos"> 175</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Lattice</span><span class="p">):</span>
</span><span id="Lattice-176"><a href="#Lattice-176"><span class="linenos"> 176</span></a>            <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="Lattice-177"><a href="#Lattice-177"><span class="linenos"> 177</span></a>
</span><span id="Lattice-178"><a href="#Lattice-178"><span class="linenos"> 178</span></a>        <span class="c1"># Different number of cells ‚Üí not equal</span>
</span><span id="Lattice-179"><a href="#Lattice-179"><span class="linenos"> 179</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="Lattice-180"><a href="#Lattice-180"><span class="linenos"> 180</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice-181"><a href="#Lattice-181"><span class="linenos"> 181</span></a>
</span><span id="Lattice-182"><a href="#Lattice-182"><span class="linenos"> 182</span></a>        <span class="c1"># Compare per-cell radii (using cell index or position)</span>
</span><span id="Lattice-183"><a href="#Lattice-183"><span class="linenos"> 183</span></a>        <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="Lattice-184"><a href="#Lattice-184"><span class="linenos"> 184</span></a>            <span class="c1"># Check if both have radii and same length</span>
</span><span id="Lattice-185"><a href="#Lattice-185"><span class="linenos"> 185</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="s2">&quot;radii&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="s2">&quot;radii&quot;</span><span class="p">):</span>
</span><span id="Lattice-186"><a href="#Lattice-186"><span class="linenos"> 186</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice-187"><a href="#Lattice-187"><span class="linenos"> 187</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c2</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Lattice-188"><a href="#Lattice-188"><span class="linenos"> 188</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice-189"><a href="#Lattice-189"><span class="linenos"> 189</span></a>
</span><span id="Lattice-190"><a href="#Lattice-190"><span class="linenos"> 190</span></a>            <span class="c1"># Compare numerical values (with small tolerance)</span>
</span><span id="Lattice-191"><a href="#Lattice-191"><span class="linenos"> 191</span></a>            <span class="k">for</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Lattice-192"><a href="#Lattice-192"><span class="linenos"> 192</span></a>                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">:</span>
</span><span id="Lattice-193"><a href="#Lattice-193"><span class="linenos"> 193</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice-194"><a href="#Lattice-194"><span class="linenos"> 194</span></a>
</span><span id="Lattice-195"><a href="#Lattice-195"><span class="linenos"> 195</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="Lattice-196"><a href="#Lattice-196"><span class="linenos"> 196</span></a>
</span><span id="Lattice-197"><a href="#Lattice-197"><span class="linenos"> 197</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Lattice-198"><a href="#Lattice-198"><span class="linenos"> 198</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of cells in the lattice&quot;&quot;&quot;</span>
</span><span id="Lattice-199"><a href="#Lattice-199"><span class="linenos"> 199</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
</span><span id="Lattice-200"><a href="#Lattice-200"><span class="linenos"> 200</span></a>
</span><span id="Lattice-201"><a href="#Lattice-201"><span class="linenos"> 201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Lattice-202"><a href="#Lattice-202"><span class="linenos"> 202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of beams in the lattice&quot;&quot;&quot;</span>
</span><span id="Lattice-203"><a href="#Lattice-203"><span class="linenos"> 203</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
</span><span id="Lattice-204"><a href="#Lattice-204"><span class="linenos"> 204</span></a>
</span><span id="Lattice-205"><a href="#Lattice-205"><span class="linenos"> 205</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Lattice-206"><a href="#Lattice-206"><span class="linenos"> 206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of nodes in the lattice&quot;&quot;&quot;</span>
</span><span id="Lattice-207"><a href="#Lattice-207"><span class="linenos"> 207</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="Lattice-208"><a href="#Lattice-208"><span class="linenos"> 208</span></a>
</span><span id="Lattice-209"><a href="#Lattice-209"><span class="linenos"> 209</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;initialization&quot;</span><span class="p">)</span>
</span><span id="Lattice-210"><a href="#Lattice-210"><span class="linenos"> 210</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-211"><a href="#Lattice-211"><span class="linenos"> 211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">extract_parameters_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Lattice-212"><a href="#Lattice-212"><span class="linenos"> 212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-213"><a href="#Lattice-213"><span class="linenos"> 213</span></a><span class="sd">        Extract lattice parameters from a JSON file and set the corresponding attributes.</span>
</span><span id="Lattice-214"><a href="#Lattice-214"><span class="linenos"> 214</span></a>
</span><span id="Lattice-215"><a href="#Lattice-215"><span class="linenos"> 215</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-216"><a href="#Lattice-216"><span class="linenos"> 216</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-217"><a href="#Lattice-217"><span class="linenos"> 217</span></a><span class="sd">        name_file: str</span>
</span><span id="Lattice-218"><a href="#Lattice-218"><span class="linenos"> 218</span></a><span class="sd">            Name of the JSON file containing lattice parameters.</span>
</span><span id="Lattice-219"><a href="#Lattice-219"><span class="linenos"> 219</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-220"><a href="#Lattice-220"><span class="linenos"> 220</span></a>        <span class="n">lattice_parameters</span> <span class="o">=</span> <span class="n">open_lattice_parameters</span><span class="p">(</span><span class="n">name_file</span><span class="p">)</span>
</span><span id="Lattice-221"><a href="#Lattice-221"><span class="linenos"> 221</span></a>
</span><span id="Lattice-222"><a href="#Lattice-222"><span class="linenos"> 222</span></a>        <span class="c1"># Geometry</span>
</span><span id="Lattice-223"><a href="#Lattice-223"><span class="linenos"> 223</span></a>        <span class="n">geometry</span> <span class="o">=</span> <span class="n">lattice_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-224"><a href="#Lattice-224"><span class="linenos"> 224</span></a>        <span class="n">cell_size</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_size&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-225"><a href="#Lattice-225"><span class="linenos"> 225</span></a>        <span class="n">number_of_cells</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number_of_cells&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-226"><a href="#Lattice-226"><span class="linenos"> 226</span></a>
</span><span id="Lattice-227"><a href="#Lattice-227"><span class="linenos"> 227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span> <span class="o">=</span> <span class="n">cell_size</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="Lattice-228"><a href="#Lattice-228"><span class="linenos"> 228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span> <span class="o">=</span> <span class="n">cell_size</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
</span><span id="Lattice-229"><a href="#Lattice-229"><span class="linenos"> 229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span> <span class="o">=</span> <span class="n">cell_size</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
</span><span id="Lattice-230"><a href="#Lattice-230"><span class="linenos"> 230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span> <span class="o">=</span> <span class="n">number_of_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="Lattice-231"><a href="#Lattice-231"><span class="linenos"> 231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span> <span class="o">=</span> <span class="n">number_of_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
</span><span id="Lattice-232"><a href="#Lattice-232"><span class="linenos"> 232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span> <span class="o">=</span> <span class="n">number_of_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
</span><span id="Lattice-233"><a href="#Lattice-233"><span class="linenos"> 233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;radii&quot;</span><span class="p">)</span>
</span><span id="Lattice-234"><a href="#Lattice-234"><span class="linenos"> 234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geom_types&quot;</span><span class="p">)</span>
</span><span id="Lattice-235"><a href="#Lattice-235"><span class="linenos"> 235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_randomness</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_randomness&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Lattice-236"><a href="#Lattice-236"><span class="linenos"> 236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;range_radius&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
</span><span id="Lattice-237"><a href="#Lattice-237"><span class="linenos"> 237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">randomness_hybrid</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;randomness_hybrid&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Lattice-238"><a href="#Lattice-238"><span class="linenos"> 238</span></a>
</span><span id="Lattice-239"><a href="#Lattice-239"><span class="linenos"> 239</span></a>        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="p">,</span>
</span><span id="Lattice-240"><a href="#Lattice-240"><span class="linenos"> 240</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span>
</span><span id="Lattice-241"><a href="#Lattice-241"><span class="linenos"> 241</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">]:</span>
</span><span id="Lattice-242"><a href="#Lattice-242"><span class="linenos"> 242</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing geometry parameters in JSON file.&quot;</span><span class="p">)</span>
</span><span id="Lattice-243"><a href="#Lattice-243"><span class="linenos"> 243</span></a>
</span><span id="Lattice-244"><a href="#Lattice-244"><span class="linenos"> 244</span></a>        <span class="c1"># Gradient</span>
</span><span id="Lattice-245"><a href="#Lattice-245"><span class="linenos"> 245</span></a>        <span class="n">gradient</span> <span class="o">=</span> <span class="n">lattice_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gradient&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-246"><a href="#Lattice-246"><span class="linenos"> 246</span></a>        <span class="n">radius_grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;radii&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-247"><a href="#Lattice-247"><span class="linenos"> 247</span></a>        <span class="n">dim_grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_dimension&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-248"><a href="#Lattice-248"><span class="linenos"> 248</span></a>        <span class="n">mat_grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-249"><a href="#Lattice-249"><span class="linenos"> 249</span></a>
</span><span id="Lattice-250"><a href="#Lattice-250"><span class="linenos"> 250</span></a>        <span class="n">grad_radius_property</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Lattice-251"><a href="#Lattice-251"><span class="linenos"> 251</span></a>            <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">,</span> <span class="s2">&quot;constant&quot;</span><span class="p">),</span>
</span><span id="Lattice-252"><a href="#Lattice-252"><span class="linenos"> 252</span></a>            <span class="p">[</span><span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_x&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="Lattice-253"><a href="#Lattice-253"><span class="linenos"> 253</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_y&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="Lattice-254"><a href="#Lattice-254"><span class="linenos"> 254</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_z&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
</span><span id="Lattice-255"><a href="#Lattice-255"><span class="linenos"> 255</span></a>            <span class="p">[</span><span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice-256"><a href="#Lattice-256"><span class="linenos"> 256</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice-257"><a href="#Lattice-257"><span class="linenos"> 257</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
</span><span id="Lattice-258"><a href="#Lattice-258"><span class="linenos"> 258</span></a>        <span class="p">]</span>
</span><span id="Lattice-259"><a href="#Lattice-259"><span class="linenos"> 259</span></a>
</span><span id="Lattice-260"><a href="#Lattice-260"><span class="linenos"> 260</span></a>        <span class="n">grad_dim_property</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Lattice-261"><a href="#Lattice-261"><span class="linenos"> 261</span></a>            <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">,</span> <span class="s2">&quot;constant&quot;</span><span class="p">),</span>
</span><span id="Lattice-262"><a href="#Lattice-262"><span class="linenos"> 262</span></a>            <span class="p">[</span><span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_x&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="Lattice-263"><a href="#Lattice-263"><span class="linenos"> 263</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_y&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="Lattice-264"><a href="#Lattice-264"><span class="linenos"> 264</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_z&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
</span><span id="Lattice-265"><a href="#Lattice-265"><span class="linenos"> 265</span></a>            <span class="p">[</span><span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice-266"><a href="#Lattice-266"><span class="linenos"> 266</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice-267"><a href="#Lattice-267"><span class="linenos"> 267</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
</span><span id="Lattice-268"><a href="#Lattice-268"><span class="linenos"> 268</span></a>        <span class="p">]</span>
</span><span id="Lattice-269"><a href="#Lattice-269"><span class="linenos"> 269</span></a>
</span><span id="Lattice-270"><a href="#Lattice-270"><span class="linenos"> 270</span></a>        <span class="n">grad_mat_property</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Lattice-271"><a href="#Lattice-271"><span class="linenos"> 271</span></a>            <span class="n">mat_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type_beam&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="Lattice-272"><a href="#Lattice-272"><span class="linenos"> 272</span></a>            <span class="n">mat_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Lattice-273"><a href="#Lattice-273"><span class="linenos"> 273</span></a>        <span class="p">]</span>
</span><span id="Lattice-274"><a href="#Lattice-274"><span class="linenos"> 274</span></a>
</span><span id="Lattice-275"><a href="#Lattice-275"><span class="linenos"> 275</span></a>        <span class="c1"># Supplementary</span>
</span><span id="Lattice-276"><a href="#Lattice-276"><span class="linenos"> 276</span></a>        <span class="n">supplementary</span> <span class="o">=</span> <span class="n">lattice_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;supplementary&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-277"><a href="#Lattice-277"><span class="linenos"> 277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span> <span class="o">=</span> <span class="n">supplementary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_uncertainty&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="Lattice-278"><a href="#Lattice-278"><span class="linenos"> 278</span></a>
</span><span id="Lattice-279"><a href="#Lattice-279"><span class="linenos"> 279</span></a>        <span class="c1"># Erased blocks</span>
</span><span id="Lattice-280"><a href="#Lattice-280"><span class="linenos"> 280</span></a>        <span class="n">erased_blocks_json</span> <span class="o">=</span> <span class="n">supplementary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;erased_blocks&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-281"><a href="#Lattice-281"><span class="linenos"> 281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-282"><a href="#Lattice-282"><span class="linenos"> 282</span></a>        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">erased_blocks_json</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Lattice-283"><a href="#Lattice-283"><span class="linenos"> 283</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_point&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-284"><a href="#Lattice-284"><span class="linenos"> 284</span></a>            <span class="n">dim</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimensions_block&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-285"><a href="#Lattice-285"><span class="linenos"> 285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
</span><span id="Lattice-286"><a href="#Lattice-286"><span class="linenos"> 286</span></a>                <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice-287"><a href="#Lattice-287"><span class="linenos"> 287</span></a>                <span class="n">dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="Lattice-288"><a href="#Lattice-288"><span class="linenos"> 288</span></a>            <span class="p">])</span>
</span><span id="Lattice-289"><a href="#Lattice-289"><span class="linenos"> 289</span></a>
</span><span id="Lattice-290"><a href="#Lattice-290"><span class="linenos"> 290</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-291"><a href="#Lattice-291"><span class="linenos"> 291</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-292"><a href="#Lattice-292"><span class="linenos"> 292</span></a>
</span><span id="Lattice-293"><a href="#Lattice-293"><span class="linenos"> 293</span></a>        <span class="c1"># Symmetry</span>
</span><span id="Lattice-294"><a href="#Lattice-294"><span class="linenos"> 294</span></a>        <span class="n">symmetries</span> <span class="o">=</span> <span class="n">supplementary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;symmetries&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-295"><a href="#Lattice-295"><span class="linenos"> 295</span></a>        <span class="k">if</span> <span class="n">symmetries</span><span class="p">:</span>
</span><span id="Lattice-296"><a href="#Lattice-296"><span class="linenos"> 296</span></a>            <span class="n">sym_plane</span> <span class="o">=</span> <span class="n">symmetries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plane&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Lattice-297"><a href="#Lattice-297"><span class="linenos"> 297</span></a>            <span class="n">sym_point</span> <span class="o">=</span> <span class="n">symmetries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reference_point&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice-298"><a href="#Lattice-298"><span class="linenos"> 298</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Lattice-299"><a href="#Lattice-299"><span class="linenos"> 299</span></a>                <span class="s2">&quot;sym_plane&quot;</span><span class="p">:</span> <span class="n">sym_plane</span><span class="p">,</span>
</span><span id="Lattice-300"><a href="#Lattice-300"><span class="linenos"> 300</span></a>                <span class="s2">&quot;sym_point&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">sym_point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice-301"><a href="#Lattice-301"><span class="linenos"> 301</span></a>                              <span class="n">sym_point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice-302"><a href="#Lattice-302"><span class="linenos"> 302</span></a>                              <span class="n">sym_point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span id="Lattice-303"><a href="#Lattice-303"><span class="linenos"> 303</span></a>            <span class="p">}</span>
</span><span id="Lattice-304"><a href="#Lattice-304"><span class="linenos"> 304</span></a>
</span><span id="Lattice-305"><a href="#Lattice-305"><span class="linenos"> 305</span></a>        <span class="n">_validate_inputs_lattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span>
</span><span id="Lattice-306"><a href="#Lattice-306"><span class="linenos"> 306</span></a>                                 <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span>
</span><span id="Lattice-307"><a href="#Lattice-307"><span class="linenos"> 307</span></a>                                 <span class="n">grad_radius_property</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">,</span> <span class="n">grad_mat_property</span><span class="p">,</span>
</span><span id="Lattice-308"><a href="#Lattice-308"><span class="linenos"> 308</span></a>                                 <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="p">)</span>
</span><span id="Lattice-309"><a href="#Lattice-309"><span class="linenos"> 309</span></a>
</span><span id="Lattice-310"><a href="#Lattice-310"><span class="linenos"> 310</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_gradient</span><span class="p">(</span><span class="n">grad_radius_property</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">,</span> <span class="n">grad_mat_property</span><span class="p">)</span>
</span><span id="Lattice-311"><a href="#Lattice-311"><span class="linenos"> 311</span></a>
</span><span id="Lattice-312"><a href="#Lattice-312"><span class="linenos"> 312</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-313"><a href="#Lattice-313"><span class="linenos"> 313</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_lattice_boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
</span><span id="Lattice-314"><a href="#Lattice-314"><span class="linenos"> 314</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-315"><a href="#Lattice-315"><span class="linenos"> 315</span></a><span class="sd">        Get the boundary box of the lattice</span>
</span><span id="Lattice-316"><a href="#Lattice-316"><span class="linenos"> 316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-317"><a href="#Lattice-317"><span class="linenos"> 317</span></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span><span class="p">]</span>
</span><span id="Lattice-318"><a href="#Lattice-318"><span class="linenos"> 318</span></a>
</span><span id="Lattice-319"><a href="#Lattice-319"><span class="linenos"> 319</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-320"><a href="#Lattice-320"><span class="linenos"> 320</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-321"><a href="#Lattice-321"><span class="linenos"> 321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_lattice_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Lattice-322"><a href="#Lattice-322"><span class="linenos"> 322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-323"><a href="#Lattice-323"><span class="linenos"> 323</span></a><span class="sd">        Computes extremum values of coordinates in the lattice.</span>
</span><span id="Lattice-324"><a href="#Lattice-324"><span class="linenos"> 324</span></a>
</span><span id="Lattice-325"><a href="#Lattice-325"><span class="linenos"> 325</span></a><span class="sd">        Return:</span>
</span><span id="Lattice-326"><a href="#Lattice-326"><span class="linenos"> 326</span></a><span class="sd">        --------</span>
</span><span id="Lattice-327"><a href="#Lattice-327"><span class="linenos"> 327</span></a><span class="sd">        lattice_dimension_dict: dict</span>
</span><span id="Lattice-328"><a href="#Lattice-328"><span class="linenos"> 328</span></a><span class="sd">            Dictionary containing min and max values for x, y, z coordinates.</span>
</span><span id="Lattice-329"><a href="#Lattice-329"><span class="linenos"> 329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-330"><a href="#Lattice-330"><span class="linenos"> 330</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice-331"><a href="#Lattice-331"><span class="linenos"> 331</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No nodes in the lattice.&quot;</span><span class="p">)</span>
</span><span id="Lattice-332"><a href="#Lattice-332"><span class="linenos"> 332</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="Lattice-333"><a href="#Lattice-333"><span class="linenos"> 333</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="Lattice-334"><a href="#Lattice-334"><span class="linenos"> 334</span></a>        <span class="n">zs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="Lattice-335"><a href="#Lattice-335"><span class="linenos"> 335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="Lattice-336"><a href="#Lattice-336"><span class="linenos"> 336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span><span id="Lattice-337"><a href="#Lattice-337"><span class="linenos"> 337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
</span><span id="Lattice-338"><a href="#Lattice-338"><span class="linenos"> 338</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lattice_dimension_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Lattice-339"><a href="#Lattice-339"><span class="linenos"> 339</span></a>            <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
</span><span id="Lattice-340"><a href="#Lattice-340"><span class="linenos"> 340</span></a>            <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
</span><span id="Lattice-341"><a href="#Lattice-341"><span class="linenos"> 341</span></a>            <span class="s2">&quot;z_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="s2">&quot;z_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span><span class="p">,</span>
</span><span id="Lattice-342"><a href="#Lattice-342"><span class="linenos"> 342</span></a>        <span class="p">}</span>
</span><span id="Lattice-343"><a href="#Lattice-343"><span class="linenos"> 343</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_dimension_dict</span>
</span><span id="Lattice-344"><a href="#Lattice-344"><span class="linenos"> 344</span></a>
</span><span id="Lattice-345"><a href="#Lattice-345"><span class="linenos"> 345</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Lattice-346"><a href="#Lattice-346"><span class="linenos"> 346</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-347"><a href="#Lattice-347"><span class="linenos"> 347</span></a><span class="sd">        Get mean relative density of all cells in lattice</span>
</span><span id="Lattice-348"><a href="#Lattice-348"><span class="linenos"> 348</span></a><span class="sd">        Simple average of cell relative densities</span>
</span><span id="Lattice-349"><a href="#Lattice-349"><span class="linenos"> 349</span></a>
</span><span id="Lattice-350"><a href="#Lattice-350"><span class="linenos"> 350</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice-351"><a href="#Lattice-351"><span class="linenos"> 351</span></a><span class="sd">        --------</span>
</span><span id="Lattice-352"><a href="#Lattice-352"><span class="linenos"> 352</span></a><span class="sd">        meanRelDens: float</span>
</span><span id="Lattice-353"><a href="#Lattice-353"><span class="linenos"> 353</span></a><span class="sd">            Mean relative density of the lattice</span>
</span><span id="Lattice-354"><a href="#Lattice-354"><span class="linenos"> 354</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-355"><a href="#Lattice-355"><span class="linenos"> 355</span></a>        <span class="n">cellRelDens</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-356"><a href="#Lattice-356"><span class="linenos"> 356</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-357"><a href="#Lattice-357"><span class="linenos"> 357</span></a>            <span class="n">cellRelDens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">relative_density</span><span class="p">)</span>
</span><span id="Lattice-358"><a href="#Lattice-358"><span class="linenos"> 358</span></a>        <span class="n">meanRelDens</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">cellRelDens</span><span class="p">)</span>
</span><span id="Lattice-359"><a href="#Lattice-359"><span class="linenos"> 359</span></a>        <span class="k">return</span> <span class="n">meanRelDens</span>
</span><span id="Lattice-360"><a href="#Lattice-360"><span class="linenos"> 360</span></a>
</span><span id="Lattice-361"><a href="#Lattice-361"><span class="linenos"> 361</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_beam_radius_min_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice-362"><a href="#Lattice-362"><span class="linenos"> 362</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-363"><a href="#Lattice-363"><span class="linenos"> 363</span></a><span class="sd">        Get the maximum and minimum radii of the lattice</span>
</span><span id="Lattice-364"><a href="#Lattice-364"><span class="linenos"> 364</span></a>
</span><span id="Lattice-365"><a href="#Lattice-365"><span class="linenos"> 365</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice-366"><a href="#Lattice-366"><span class="linenos"> 366</span></a><span class="sd">        --------</span>
</span><span id="Lattice-367"><a href="#Lattice-367"><span class="linenos"> 367</span></a><span class="sd">        radMax: float</span>
</span><span id="Lattice-368"><a href="#Lattice-368"><span class="linenos"> 368</span></a><span class="sd">            Maximum radii of the lattice</span>
</span><span id="Lattice-369"><a href="#Lattice-369"><span class="linenos"> 369</span></a>
</span><span id="Lattice-370"><a href="#Lattice-370"><span class="linenos"> 370</span></a><span class="sd">        radMin: float</span>
</span><span id="Lattice-371"><a href="#Lattice-371"><span class="linenos"> 371</span></a><span class="sd">            Minimum radii of the lattice</span>
</span><span id="Lattice-372"><a href="#Lattice-372"><span class="linenos"> 372</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-373"><a href="#Lattice-373"><span class="linenos"> 373</span></a>        <span class="n">radMin</span> <span class="o">=</span> <span class="mi">1000000</span>
</span><span id="Lattice-374"><a href="#Lattice-374"><span class="linenos"> 374</span></a>        <span class="n">radMax</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice-375"><a href="#Lattice-375"><span class="linenos"> 375</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-376"><a href="#Lattice-376"><span class="linenos"> 376</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Lattice-377"><a href="#Lattice-377"><span class="linenos"> 377</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span><span class="p">:</span>
</span><span id="Lattice-378"><a href="#Lattice-378"><span class="linenos"> 378</span></a>                    <span class="n">radMin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radMin</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Lattice-379"><a href="#Lattice-379"><span class="linenos"> 379</span></a>                    <span class="n">radMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radMax</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Lattice-380"><a href="#Lattice-380"><span class="linenos"> 380</span></a>        <span class="k">return</span> <span class="n">radMax</span><span class="p">,</span> <span class="n">radMin</span>
</span><span id="Lattice-381"><a href="#Lattice-381"><span class="linenos"> 381</span></a>
</span><span id="Lattice-382"><a href="#Lattice-382"><span class="linenos"> 382</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-383"><a href="#Lattice-383"><span class="linenos"> 383</span></a><span class="c1"># SECTION: Design Methods</span>
</span><span id="Lattice-384"><a href="#Lattice-384"><span class="linenos"> 384</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-385"><a href="#Lattice-385"><span class="linenos"> 385</span></a>
</span><span id="Lattice-386"><a href="#Lattice-386"><span class="linenos"> 386</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;initialization&quot;</span><span class="p">)</span>
</span><span id="Lattice-387"><a href="#Lattice-387"><span class="linenos"> 387</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-388"><a href="#Lattice-388"><span class="linenos"> 388</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad_radius_property</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">,</span> <span class="n">grad_mat_property</span><span class="p">):</span>
</span><span id="Lattice-389"><a href="#Lattice-389"><span class="linenos"> 389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-390"><a href="#Lattice-390"><span class="linenos"> 390</span></a><span class="sd">        Define gradient settings for radii, dimensions, and materials based on provided properties.</span>
</span><span id="Lattice-391"><a href="#Lattice-391"><span class="linenos"> 391</span></a>
</span><span id="Lattice-392"><a href="#Lattice-392"><span class="linenos"> 392</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-393"><a href="#Lattice-393"><span class="linenos"> 393</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-394"><a href="#Lattice-394"><span class="linenos"> 394</span></a><span class="sd">        grad_radius_property: list</span>
</span><span id="Lattice-395"><a href="#Lattice-395"><span class="linenos"> 395</span></a><span class="sd">            Properties defining the gradient for radii.</span>
</span><span id="Lattice-396"><a href="#Lattice-396"><span class="linenos"> 396</span></a>
</span><span id="Lattice-397"><a href="#Lattice-397"><span class="linenos"> 397</span></a><span class="sd">        grad_dim_property: list</span>
</span><span id="Lattice-398"><a href="#Lattice-398"><span class="linenos"> 398</span></a><span class="sd">            Properties defining the gradient for cell dimensions.</span>
</span><span id="Lattice-399"><a href="#Lattice-399"><span class="linenos"> 399</span></a>
</span><span id="Lattice-400"><a href="#Lattice-400"><span class="linenos"> 400</span></a><span class="sd">        grad_mat_property: list</span>
</span><span id="Lattice-401"><a href="#Lattice-401"><span class="linenos"> 401</span></a><span class="sd">            Properties defining the gradient for material settings.</span>
</span><span id="Lattice-402"><a href="#Lattice-402"><span class="linenos"> 402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-403"><a href="#Lattice-403"><span class="linenos"> 403</span></a>        <span class="k">if</span> <span class="n">grad_radius_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-404"><a href="#Lattice-404"><span class="linenos"> 404</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span> <span class="o">=</span> <span class="n">get_grad_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span>
</span><span id="Lattice-405"><a href="#Lattice-405"><span class="linenos"> 405</span></a>                                                 <span class="n">grad_radius_property</span><span class="p">)</span>
</span><span id="Lattice-406"><a href="#Lattice-406"><span class="linenos"> 406</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-407"><a href="#Lattice-407"><span class="linenos"> 407</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span> <span class="o">=</span> <span class="n">grad_settings_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">)</span>
</span><span id="Lattice-408"><a href="#Lattice-408"><span class="linenos"> 408</span></a>        <span class="k">if</span> <span class="n">grad_dim_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-409"><a href="#Lattice-409"><span class="linenos"> 409</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span> <span class="o">=</span> <span class="n">get_grad_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">)</span>
</span><span id="Lattice-410"><a href="#Lattice-410"><span class="linenos"> 410</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-411"><a href="#Lattice-411"><span class="linenos"> 411</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span> <span class="o">=</span> <span class="n">grad_settings_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">)</span>
</span><span id="Lattice-412"><a href="#Lattice-412"><span class="linenos"> 412</span></a>        <span class="k">if</span> <span class="n">grad_mat_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-413"><a href="#Lattice-413"><span class="linenos"> 413</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="o">=</span> <span class="n">grad_material_setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span>
</span><span id="Lattice-414"><a href="#Lattice-414"><span class="linenos"> 414</span></a>                                                  <span class="n">grad_mat_property</span><span class="p">)</span>
</span><span id="Lattice-415"><a href="#Lattice-415"><span class="linenos"> 415</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-416"><a href="#Lattice-416"><span class="linenos"> 416</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="o">=</span> <span class="n">grad_settings_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Lattice-417"><a href="#Lattice-417"><span class="linenos"> 417</span></a>
</span><span id="Lattice-418"><a href="#Lattice-418"><span class="linenos"> 418</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-419"><a href="#Lattice-419"><span class="linenos"> 419</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-420"><a href="#Lattice-420"><span class="linenos"> 420</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice-421"><a href="#Lattice-421"><span class="linenos"> 421</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-422"><a href="#Lattice-422"><span class="linenos"> 422</span></a><span class="sd">        Generate cells in the lattice structure based on cell size, number of cells, geometry types, and radii.</span>
</span><span id="Lattice-423"><a href="#Lattice-423"><span class="linenos"> 423</span></a><span class="sd">        Gradient information and erased regions are also considered during cell generation.</span>
</span><span id="Lattice-424"><a href="#Lattice-424"><span class="linenos"> 424</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-425"><a href="#Lattice-425"><span class="linenos"> 425</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span> <span class="c1"># For reproducibility of randomness</span>
</span><span id="Lattice-426"><a href="#Lattice-426"><span class="linenos"> 426</span></a>        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span>
</span><span id="Lattice-427"><a href="#Lattice-427"><span class="linenos"> 427</span></a>        <span class="n">csx</span><span class="p">,</span> <span class="n">csy</span><span class="p">,</span> <span class="n">csz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span>
</span><span id="Lattice-428"><a href="#Lattice-428"><span class="linenos"> 428</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span>
</span><span id="Lattice-429"><a href="#Lattice-429"><span class="linenos"> 429</span></a>        <span class="n">initial_cell_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">csx</span><span class="p">,</span> <span class="n">csy</span><span class="p">,</span> <span class="n">csz</span><span class="p">]</span>
</span><span id="Lattice-430"><a href="#Lattice-430"><span class="linenos"> 430</span></a>        <span class="n">added_nodes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice-431"><a href="#Lattice-431"><span class="linenos"> 431</span></a>        <span class="n">added_beams</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice-432"><a href="#Lattice-432"><span class="linenos"> 432</span></a>
</span><span id="Lattice-433"><a href="#Lattice-433"><span class="linenos"> 433</span></a>        <span class="c1"># Precompute cumulative start positions along each axis</span>
</span><span id="Lattice-434"><a href="#Lattice-434"><span class="linenos"> 434</span></a>        <span class="n">x_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nx</span>
</span><span id="Lattice-435"><a href="#Lattice-435"><span class="linenos"> 435</span></a>        <span class="n">y_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ny</span>
</span><span id="Lattice-436"><a href="#Lattice-436"><span class="linenos"> 436</span></a>        <span class="n">z_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nz</span>
</span><span id="Lattice-437"><a href="#Lattice-437"><span class="linenos"> 437</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>
</span><span id="Lattice-438"><a href="#Lattice-438"><span class="linenos"> 438</span></a>            <span class="n">x_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">csx</span> <span class="o">*</span> <span class="n">grad</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Lattice-439"><a href="#Lattice-439"><span class="linenos"> 439</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
</span><span id="Lattice-440"><a href="#Lattice-440"><span class="linenos"> 440</span></a>            <span class="n">y_starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_starts</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">csy</span> <span class="o">*</span> <span class="n">grad</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Lattice-441"><a href="#Lattice-441"><span class="linenos"> 441</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">):</span>
</span><span id="Lattice-442"><a href="#Lattice-442"><span class="linenos"> 442</span></a>            <span class="n">z_starts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_starts</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">csz</span> <span class="o">*</span> <span class="n">grad</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Lattice-443"><a href="#Lattice-443"><span class="linenos"> 443</span></a>
</span><span id="Lattice-444"><a href="#Lattice-444"><span class="linenos"> 444</span></a>        <span class="n">append_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span>
</span><span id="Lattice-445"><a href="#Lattice-445"><span class="linenos"> 445</span></a>        <span class="n">mesh_trimmer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span>
</span><span id="Lattice-446"><a href="#Lattice-446"><span class="linenos"> 446</span></a>
</span><span id="Lattice-447"><a href="#Lattice-447"><span class="linenos"> 447</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
</span><span id="Lattice-448"><a href="#Lattice-448"><span class="linenos"> 448</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">x_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Lattice-449"><a href="#Lattice-449"><span class="linenos"> 449</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
</span><span id="Lattice-450"><a href="#Lattice-450"><span class="linenos"> 450</span></a>                <span class="n">yj</span> <span class="o">=</span> <span class="n">y_starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Lattice-451"><a href="#Lattice-451"><span class="linenos"> 451</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
</span><span id="Lattice-452"><a href="#Lattice-452"><span class="linenos"> 452</span></a>                    <span class="n">zk</span> <span class="o">=</span> <span class="n">z_starts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="Lattice-453"><a href="#Lattice-453"><span class="linenos"> 453</span></a>                    <span class="n">start_cell_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yj</span><span class="p">,</span> <span class="n">zk</span><span class="p">]</span>
</span><span id="Lattice-454"><a href="#Lattice-454"><span class="linenos"> 454</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_not_in_erased_region</span><span class="p">(</span><span class="n">start_cell_pos</span><span class="p">):</span>
</span><span id="Lattice-455"><a href="#Lattice-455"><span class="linenos"> 455</span></a>                        <span class="k">continue</span>  <span class="c1"># skip erased regions</span>
</span><span id="Lattice-456"><a href="#Lattice-456"><span class="linenos"> 456</span></a>
</span><span id="Lattice-457"><a href="#Lattice-457"><span class="linenos"> 457</span></a>                    <span class="n">pos_cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
</span><span id="Lattice-458"><a href="#Lattice-458"><span class="linenos"> 458</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_randomness</span><span class="p">:</span>
</span><span id="Lattice-459"><a href="#Lattice-459"><span class="linenos"> 459</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomness_hybrid</span><span class="p">:</span>
</span><span id="Lattice-460"><a href="#Lattice-460"><span class="linenos"> 460</span></a>                            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">]</span>
</span><span id="Lattice-461"><a href="#Lattice-461"><span class="linenos"> 461</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-462"><a href="#Lattice-462"><span class="linenos"> 462</span></a>                            <span class="n">random_radius</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Lattice-463"><a href="#Lattice-463"><span class="linenos"> 463</span></a>                            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_radius</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">]</span>
</span><span id="Lattice-464"><a href="#Lattice-464"><span class="linenos"> 464</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-465"><a href="#Lattice-465"><span class="linenos"> 465</span></a>                        <span class="n">radii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span>
</span><span id="Lattice-466"><a href="#Lattice-466"><span class="linenos"> 466</span></a>                    <span class="n">new_cell</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span>
</span><span id="Lattice-467"><a href="#Lattice-467"><span class="linenos"> 467</span></a>                        <span class="n">pos_cell</span><span class="p">,</span> <span class="n">initial_cell_size</span><span class="p">,</span> <span class="n">start_cell_pos</span><span class="p">,</span>
</span><span id="Lattice-468"><a href="#Lattice-468"><span class="linenos"> 468</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span>
</span><span id="Lattice-469"><a href="#Lattice-469"><span class="linenos"> 469</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">,</span>
</span><span id="Lattice-470"><a href="#Lattice-470"><span class="linenos"> 470</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">,</span>
</span><span id="Lattice-471"><a href="#Lattice-471"><span class="linenos"> 471</span></a>                        <span class="n">beams_already_defined</span> <span class="o">=</span> <span class="n">added_beams</span><span class="p">,</span>
</span><span id="Lattice-472"><a href="#Lattice-472"><span class="linenos"> 472</span></a>                        <span class="n">nodes_already_defined</span> <span class="o">=</span> <span class="n">added_nodes</span>
</span><span id="Lattice-473"><a href="#Lattice-473"><span class="linenos"> 473</span></a>                    <span class="p">)</span>
</span><span id="Lattice-474"><a href="#Lattice-474"><span class="linenos"> 474</span></a>
</span><span id="Lattice-475"><a href="#Lattice-475"><span class="linenos"> 475</span></a>                    <span class="k">if</span> <span class="n">mesh_trimmer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mesh_trimmer</span><span class="o">.</span><span class="n">is_cell_in_mesh</span><span class="p">(</span><span class="n">new_cell</span><span class="p">):</span>
</span><span id="Lattice-476"><a href="#Lattice-476"><span class="linenos"> 476</span></a>                        <span class="k">continue</span>
</span><span id="Lattice-477"><a href="#Lattice-477"><span class="linenos"> 477</span></a>                    <span class="n">append_cell</span><span class="p">(</span><span class="n">new_cell</span><span class="p">)</span>
</span><span id="Lattice-478"><a href="#Lattice-478"><span class="linenos"> 478</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="Lattice-479"><a href="#Lattice-479"><span class="linenos"> 479</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="Lattice-480"><a href="#Lattice-480"><span class="linenos"> 480</span></a>
</span><span id="Lattice-481"><a href="#Lattice-481"><span class="linenos"> 481</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Lattice-482"><a href="#Lattice-482"><span class="linenos"> 482</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">check_hybrid_collision</span><span class="p">()</span>
</span><span id="Lattice-483"><a href="#Lattice-483"><span class="linenos"> 483</span></a>
</span><span id="Lattice-484"><a href="#Lattice-484"><span class="linenos"> 484</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-485"><a href="#Lattice-485"><span class="linenos"> 485</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-486"><a href="#Lattice-486"><span class="linenos"> 486</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cut_beam_with_mesh_trimmer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice-487"><a href="#Lattice-487"><span class="linenos"> 487</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-488"><a href="#Lattice-488"><span class="linenos"> 488</span></a><span class="sd">        Cut beams in the lattice using the mesh trimmer.</span>
</span><span id="Lattice-489"><a href="#Lattice-489"><span class="linenos"> 489</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-490"><a href="#Lattice-490"><span class="linenos"> 490</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-491"><a href="#Lattice-491"><span class="linenos"> 491</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A mesh object must be assigned to the lattice before cutting beams.&quot;</span><span class="p">)</span>
</span><span id="Lattice-492"><a href="#Lattice-492"><span class="linenos"> 492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span><span class="o">.</span><span class="n">cut_beams_at_mesh_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
</span><span id="Lattice-493"><a href="#Lattice-493"><span class="linenos"> 493</span></a>
</span><span id="Lattice-494"><a href="#Lattice-494"><span class="linenos"> 494</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-495"><a href="#Lattice-495"><span class="linenos"> 495</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-496"><a href="#Lattice-496"><span class="linenos"> 496</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetry_plane</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reference_point</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-497"><a href="#Lattice-497"><span class="linenos"> 497</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-498"><a href="#Lattice-498"><span class="linenos"> 498</span></a><span class="sd">        Apply symmetry to the lattice by mirroring cells across a specified plane.</span>
</span><span id="Lattice-499"><a href="#Lattice-499"><span class="linenos"> 499</span></a>
</span><span id="Lattice-500"><a href="#Lattice-500"><span class="linenos"> 500</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-501"><a href="#Lattice-501"><span class="linenos"> 501</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-502"><a href="#Lattice-502"><span class="linenos"> 502</span></a><span class="sd">        symmetry_plane: str, optional</span>
</span><span id="Lattice-503"><a href="#Lattice-503"><span class="linenos"> 503</span></a><span class="sd">            Plane of symmetry (&#39;XY&#39;, &#39;XZ&#39;, &#39;YZ&#39;, &#39;X&#39;, &#39;Y&#39;,</span>
</span><span id="Lattice-504"><a href="#Lattice-504"><span class="linenos"> 504</span></a><span class="sd">            or &#39;Z&#39;). If None, uses self.symmetry_lattice[&#39;sym_plane&#39;].</span>
</span><span id="Lattice-505"><a href="#Lattice-505"><span class="linenos"> 505</span></a>
</span><span id="Lattice-506"><a href="#Lattice-506"><span class="linenos"> 506</span></a><span class="sd">        reference_point: tuple of float, optional</span>
</span><span id="Lattice-507"><a href="#Lattice-507"><span class="linenos"> 507</span></a><span class="sd">            Reference point for the symmetry operation (x_ref, y_ref, z_ref).</span>
</span><span id="Lattice-508"><a href="#Lattice-508"><span class="linenos"> 508</span></a><span class="sd">            If None, uses self.symmetry_lattice[&#39;sym_point&#39;].</span>
</span><span id="Lattice-509"><a href="#Lattice-509"><span class="linenos"> 509</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-510"><a href="#Lattice-510"><span class="linenos"> 510</span></a>        <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reference_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-511"><a href="#Lattice-511"><span class="linenos"> 511</span></a>            <span class="n">symmetry_plane</span><span class="p">,</span> <span class="n">reference_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span><span class="p">[</span><span class="s2">&quot;sym_plane&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span><span class="p">[</span><span class="s2">&quot;sym_point&quot;</span><span class="p">]</span>
</span><span id="Lattice-512"><a href="#Lattice-512"><span class="linenos"> 512</span></a>        <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reference_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-513"><a href="#Lattice-513"><span class="linenos"> 513</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Both symmetry_plane and reference_point must be provided.&quot;</span><span class="p">)</span>
</span><span id="Lattice-514"><a href="#Lattice-514"><span class="linenos"> 514</span></a>        <span class="n">symmetry_plane</span> <span class="o">=</span> <span class="n">symmetry_plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Lattice-515"><a href="#Lattice-515"><span class="linenos"> 515</span></a>        <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;XY&quot;</span><span class="p">,</span> <span class="s2">&quot;XZ&quot;</span><span class="p">,</span> <span class="s2">&quot;YZ&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">}:</span>
</span><span id="Lattice-516"><a href="#Lattice-516"><span class="linenos"> 516</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid symmetry plane. Choose from &#39;XY&#39;, &#39;XZ&#39;, &#39;YZ&#39;, &#39;X&#39;, &#39;Y&#39;, or &#39;Z&#39;.&quot;</span><span class="p">)</span>
</span><span id="Lattice-517"><a href="#Lattice-517"><span class="linenos"> 517</span></a>
</span><span id="Lattice-518"><a href="#Lattice-518"><span class="linenos"> 518</span></a>        <span class="n">x_ref</span><span class="p">,</span> <span class="n">y_ref</span><span class="p">,</span> <span class="n">z_ref</span> <span class="o">=</span> <span class="n">reference_point</span>
</span><span id="Lattice-519"><a href="#Lattice-519"><span class="linenos"> 519</span></a>
</span><span id="Lattice-520"><a href="#Lattice-520"><span class="linenos"> 520</span></a>        <span class="n">new_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Cell</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-521"><a href="#Lattice-521"><span class="linenos"> 521</span></a>        <span class="n">new_global_beams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-522"><a href="#Lattice-522"><span class="linenos"> 522</span></a>        <span class="n">new_global_nodes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-523"><a href="#Lattice-523"><span class="linenos"> 523</span></a>
</span><span id="Lattice-524"><a href="#Lattice-524"><span class="linenos"> 524</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-525"><a href="#Lattice-525"><span class="linenos"> 525</span></a>            <span class="c1"># Mirror the cell origin/coordinate; size and pos are kept identical</span>
</span><span id="Lattice-526"><a href="#Lattice-526"><span class="linenos"> 526</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span>
</span><span id="Lattice-527"><a href="#Lattice-527"><span class="linenos"> 527</span></a>            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">size</span>
</span><span id="Lattice-528"><a href="#Lattice-528"><span class="linenos"> 528</span></a>
</span><span id="Lattice-529"><a href="#Lattice-529"><span class="linenos"> 529</span></a>            <span class="c1"># Mirror min-corner of the box correctly: x&#39;min = 2*x_ref - (x_min + dx), etc.</span>
</span><span id="Lattice-530"><a href="#Lattice-530"><span class="linenos"> 530</span></a>            <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;YZ&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">}:</span>
</span><span id="Lattice-531"><a href="#Lattice-531"><span class="linenos"> 531</span></a>                <span class="n">mcx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">cx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span>
</span><span id="Lattice-532"><a href="#Lattice-532"><span class="linenos"> 532</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-533"><a href="#Lattice-533"><span class="linenos"> 533</span></a>                <span class="n">mcx</span> <span class="o">=</span> <span class="n">cx</span>
</span><span id="Lattice-534"><a href="#Lattice-534"><span class="linenos"> 534</span></a>
</span><span id="Lattice-535"><a href="#Lattice-535"><span class="linenos"> 535</span></a>            <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;XZ&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">}:</span>
</span><span id="Lattice-536"><a href="#Lattice-536"><span class="linenos"> 536</span></a>                <span class="n">mcy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y_ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">cy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span>
</span><span id="Lattice-537"><a href="#Lattice-537"><span class="linenos"> 537</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-538"><a href="#Lattice-538"><span class="linenos"> 538</span></a>                <span class="n">mcy</span> <span class="o">=</span> <span class="n">cy</span>
</span><span id="Lattice-539"><a href="#Lattice-539"><span class="linenos"> 539</span></a>
</span><span id="Lattice-540"><a href="#Lattice-540"><span class="linenos"> 540</span></a>            <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;XY&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">}:</span>
</span><span id="Lattice-541"><a href="#Lattice-541"><span class="linenos"> 541</span></a>                <span class="n">mcz</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z_ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">cz</span> <span class="o">+</span> <span class="n">dz</span><span class="p">)</span>
</span><span id="Lattice-542"><a href="#Lattice-542"><span class="linenos"> 542</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-543"><a href="#Lattice-543"><span class="linenos"> 543</span></a>                <span class="n">mcz</span> <span class="o">=</span> <span class="n">cz</span>
</span><span id="Lattice-544"><a href="#Lattice-544"><span class="linenos"> 544</span></a>
</span><span id="Lattice-545"><a href="#Lattice-545"><span class="linenos"> 545</span></a>            <span class="n">new_coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcx</span><span class="p">,</span> <span class="n">mcy</span><span class="p">,</span> <span class="n">mcz</span><span class="p">]</span>
</span><span id="Lattice-546"><a href="#Lattice-546"><span class="linenos"> 546</span></a>
</span><span id="Lattice-547"><a href="#Lattice-547"><span class="linenos"> 547</span></a>            <span class="c1"># Build the mirrored cell</span>
</span><span id="Lattice-548"><a href="#Lattice-548"><span class="linenos"> 548</span></a>            <span class="n">new_cell</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span>
</span><span id="Lattice-549"><a href="#Lattice-549"><span class="linenos"> 549</span></a>                <span class="n">pos</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span>
</span><span id="Lattice-550"><a href="#Lattice-550"><span class="linenos"> 550</span></a>                <span class="n">initial_size</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
</span><span id="Lattice-551"><a href="#Lattice-551"><span class="linenos"> 551</span></a>                <span class="n">coordinate</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">new_coord</span><span class="p">),</span>
</span><span id="Lattice-552"><a href="#Lattice-552"><span class="linenos"> 552</span></a>                <span class="n">geom_types</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">geom_types</span><span class="p">),</span>
</span><span id="Lattice-553"><a href="#Lattice-553"><span class="linenos"> 553</span></a>                <span class="n">radii</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">radii</span><span class="p">),</span>
</span><span id="Lattice-554"><a href="#Lattice-554"><span class="linenos"> 554</span></a>                <span class="n">grad_radius</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">,</span>
</span><span id="Lattice-555"><a href="#Lattice-555"><span class="linenos"> 555</span></a>                <span class="n">grad_dim</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">,</span>
</span><span id="Lattice-556"><a href="#Lattice-556"><span class="linenos"> 556</span></a>                <span class="n">grad_mat</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">,</span>
</span><span id="Lattice-557"><a href="#Lattice-557"><span class="linenos"> 557</span></a>                <span class="n">uncertainty_node</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;uncertainty_node&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice-558"><a href="#Lattice-558"><span class="linenos"> 558</span></a>                <span class="n">_verbose</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_verbose&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="Lattice-559"><a href="#Lattice-559"><span class="linenos"> 559</span></a>            <span class="p">)</span>
</span><span id="Lattice-560"><a href="#Lattice-560"><span class="linenos"> 560</span></a>
</span><span id="Lattice-561"><a href="#Lattice-561"><span class="linenos"> 561</span></a>            <span class="n">new_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_cell</span><span class="p">)</span>
</span><span id="Lattice-562"><a href="#Lattice-562"><span class="linenos"> 562</span></a>
</span><span id="Lattice-563"><a href="#Lattice-563"><span class="linenos"> 563</span></a>        <span class="c1"># Append mirrored structures to lattice</span>
</span><span id="Lattice-564"><a href="#Lattice-564"><span class="linenos"> 564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_cells</span><span class="p">)</span>
</span><span id="Lattice-565"><a href="#Lattice-565"><span class="linenos"> 565</span></a>
</span><span id="Lattice-566"><a href="#Lattice-566"><span class="linenos"> 566</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;beams&quot;</span><span class="p">):</span>
</span><span id="Lattice-567"><a href="#Lattice-567"><span class="linenos"> 567</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
</span><span id="Lattice-568"><a href="#Lattice-568"><span class="linenos"> 568</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_global_beams</span><span class="p">)</span>
</span><span id="Lattice-569"><a href="#Lattice-569"><span class="linenos"> 569</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice-570"><a href="#Lattice-570"><span class="linenos"> 570</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_global_beams</span><span class="p">)</span>
</span><span id="Lattice-571"><a href="#Lattice-571"><span class="linenos"> 571</span></a>
</span><span id="Lattice-572"><a href="#Lattice-572"><span class="linenos"> 572</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="p">):</span>
</span><span id="Lattice-573"><a href="#Lattice-573"><span class="linenos"> 573</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
</span><span id="Lattice-574"><a href="#Lattice-574"><span class="linenos"> 574</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_global_nodes</span><span class="p">)</span>
</span><span id="Lattice-575"><a href="#Lattice-575"><span class="linenos"> 575</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice-576"><a href="#Lattice-576"><span class="linenos"> 576</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_global_nodes</span><span class="p">)</span>
</span><span id="Lattice-577"><a href="#Lattice-577"><span class="linenos"> 577</span></a>
</span><span id="Lattice-578"><a href="#Lattice-578"><span class="linenos"> 578</span></a>        <span class="c1"># Recompute lattice dimensions/bounding box</span>
</span><span id="Lattice-579"><a href="#Lattice-579"><span class="linenos"> 579</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_lattice_dimensions</span><span class="p">()</span>
</span><span id="Lattice-580"><a href="#Lattice-580"><span class="linenos"> 580</span></a>
</span><span id="Lattice-581"><a href="#Lattice-581"><span class="linenos"> 581</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-582"><a href="#Lattice-582"><span class="linenos"> 582</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-583"><a href="#Lattice-583"><span class="linenos"> 583</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_beams_under_radius_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-584"><a href="#Lattice-584"><span class="linenos"> 584</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-585"><a href="#Lattice-585"><span class="linenos"> 585</span></a><span class="sd">        Delete beams with radii under a certain threshold</span>
</span><span id="Lattice-586"><a href="#Lattice-586"><span class="linenos"> 586</span></a>
</span><span id="Lattice-587"><a href="#Lattice-587"><span class="linenos"> 587</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-588"><a href="#Lattice-588"><span class="linenos"> 588</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-589"><a href="#Lattice-589"><span class="linenos"> 589</span></a><span class="sd">        threshold: float</span>
</span><span id="Lattice-590"><a href="#Lattice-590"><span class="linenos"> 590</span></a><span class="sd">            Threshold value for beam radii</span>
</span><span id="Lattice-591"><a href="#Lattice-591"><span class="linenos"> 591</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-592"><a href="#Lattice-592"><span class="linenos"> 592</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice-593"><a href="#Lattice-593"><span class="linenos"> 593</span></a>        <span class="n">beam_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-594"><a href="#Lattice-594"><span class="linenos"> 594</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice-595"><a href="#Lattice-595"><span class="linenos"> 595</span></a>            <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="Lattice-596"><a href="#Lattice-596"><span class="linenos"> 596</span></a>                <span class="n">beam_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="Lattice-597"><a href="#Lattice-597"><span class="linenos"> 597</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beam_to_remove</span><span class="p">:</span>
</span><span id="Lattice-598"><a href="#Lattice-598"><span class="linenos"> 598</span></a>            <span class="n">beam</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Lattice-599"><a href="#Lattice-599"><span class="linenos"> 599</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice-600"><a href="#Lattice-600"><span class="linenos"> 600</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice-601"><a href="#Lattice-601"><span class="linenos"> 601</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delete_orphan_points</span><span class="p">()</span>
</span><span id="Lattice-602"><a href="#Lattice-602"><span class="linenos"> 602</span></a>
</span><span id="Lattice-603"><a href="#Lattice-603"><span class="linenos"> 603</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-604"><a href="#Lattice-604"><span class="linenos"> 604</span></a><span class="c1"># SECTION: Helpers Methods</span>
</span><span id="Lattice-605"><a href="#Lattice-605"><span class="linenos"> 605</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-606"><a href="#Lattice-606"><span class="linenos"> 606</span></a>
</span><span id="Lattice-607"><a href="#Lattice-607"><span class="linenos"> 607</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_tag_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-608"><a href="#Lattice-608"><span class="linenos"> 608</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-609"><a href="#Lattice-609"><span class="linenos"> 609</span></a><span class="sd">        Define tag list classification.</span>
</span><span id="Lattice-610"><a href="#Lattice-610"><span class="linenos"> 610</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-611"><a href="#Lattice-611"><span class="linenos"> 611</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edge_tags</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">111</span><span class="p">],</span> <span class="p">[</span><span class="mi">101</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">110</span><span class="p">]]</span>
</span><span id="Lattice-612"><a href="#Lattice-612"><span class="linenos"> 612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">face_tags</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]]</span>
</span><span id="Lattice-613"><a href="#Lattice-613"><span class="linenos"> 613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corner_tags</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">1002</span><span class="p">,</span> <span class="mi">1003</span><span class="p">,</span> <span class="mi">1004</span><span class="p">,</span> <span class="mi">1005</span><span class="p">,</span> <span class="mi">1006</span><span class="p">,</span> <span class="mi">1007</span><span class="p">]]</span>
</span><span id="Lattice-614"><a href="#Lattice-614"><span class="linenos"> 614</span></a>
</span><span id="Lattice-615"><a href="#Lattice-615"><span class="linenos"> 615</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-616"><a href="#Lattice-616"><span class="linenos"> 616</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-617"><a href="#Lattice-617"><span class="linenos"> 617</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_size_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice-618"><a href="#Lattice-618"><span class="linenos"> 618</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-619"><a href="#Lattice-619"><span class="linenos"> 619</span></a><span class="sd">        Computes the size of the lattice along each direction.</span>
</span><span id="Lattice-620"><a href="#Lattice-620"><span class="linenos"> 620</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-621"><a href="#Lattice-621"><span class="linenos"> 621</span></a>        <span class="n">size_lattice</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
</span><span id="Lattice-622"><a href="#Lattice-622"><span class="linenos"> 622</span></a>        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="Lattice-623"><a href="#Lattice-623"><span class="linenos"> 623</span></a>            <span class="n">total_length</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Lattice-624"><a href="#Lattice-624"><span class="linenos"> 624</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span>
</span><span id="Lattice-625"><a href="#Lattice-625"><span class="linenos"> 625</span></a>            <span class="n">cell_size</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span>
</span><span id="Lattice-626"><a href="#Lattice-626"><span class="linenos"> 626</span></a>            <span class="n">gradient_factors</span> <span class="o">=</span> <span class="p">[</span><span class="n">grad</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="k">for</span> <span class="n">grad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">[:</span><span class="n">num_cells</span><span class="p">]]</span>
</span><span id="Lattice-627"><a href="#Lattice-627"><span class="linenos"> 627</span></a>
</span><span id="Lattice-628"><a href="#Lattice-628"><span class="linenos"> 628</span></a>            <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">gradient_factors</span><span class="p">:</span>
</span><span id="Lattice-629"><a href="#Lattice-629"><span class="linenos"> 629</span></a>                <span class="n">total_length</span> <span class="o">+=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">cell_size</span>
</span><span id="Lattice-630"><a href="#Lattice-630"><span class="linenos"> 630</span></a>            <span class="n">size_lattice</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_length</span>
</span><span id="Lattice-631"><a href="#Lattice-631"><span class="linenos"> 631</span></a>
</span><span id="Lattice-632"><a href="#Lattice-632"><span class="linenos"> 632</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_z</span> <span class="o">=</span> <span class="n">size_lattice</span>
</span><span id="Lattice-633"><a href="#Lattice-633"><span class="linenos"> 633</span></a>
</span><span id="Lattice-634"><a href="#Lattice-634"><span class="linenos"> 634</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-635"><a href="#Lattice-635"><span class="linenos"> 635</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-636"><a href="#Lattice-636"><span class="linenos"> 636</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_not_in_erased_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_cell_pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Lattice-637"><a href="#Lattice-637"><span class="linenos"> 637</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-638"><a href="#Lattice-638"><span class="linenos"> 638</span></a><span class="sd">        Check if the cell is not in the erased region or inside the mesh.</span>
</span><span id="Lattice-639"><a href="#Lattice-639"><span class="linenos"> 639</span></a>
</span><span id="Lattice-640"><a href="#Lattice-640"><span class="linenos"> 640</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-641"><a href="#Lattice-641"><span class="linenos"> 641</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-642"><a href="#Lattice-642"><span class="linenos"> 642</span></a><span class="sd">        startCellPos: list of float</span>
</span><span id="Lattice-643"><a href="#Lattice-643"><span class="linenos"> 643</span></a><span class="sd">            (xStart, yStart, zStart) position of the cell to check.</span>
</span><span id="Lattice-644"><a href="#Lattice-644"><span class="linenos"> 644</span></a>
</span><span id="Lattice-645"><a href="#Lattice-645"><span class="linenos"> 645</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice-646"><a href="#Lattice-646"><span class="linenos"> 646</span></a><span class="sd">        --------</span>
</span><span id="Lattice-647"><a href="#Lattice-647"><span class="linenos"> 647</span></a><span class="sd">        bool:</span>
</span><span id="Lattice-648"><a href="#Lattice-648"><span class="linenos"> 648</span></a><span class="sd">            True if the cell should be removed.</span>
</span><span id="Lattice-649"><a href="#Lattice-649"><span class="linenos"> 649</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-650"><a href="#Lattice-650"><span class="linenos"> 650</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-651"><a href="#Lattice-651"><span class="linenos"> 651</span></a>            <span class="k">for</span> <span class="n">delPart</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="p">:</span>
</span><span id="Lattice-652"><a href="#Lattice-652"><span class="linenos"> 652</span></a>                <span class="n">inside_erased</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="Lattice-653"><a href="#Lattice-653"><span class="linenos"> 653</span></a>                    <span class="n">delPart</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">start_cell_pos</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">delPart</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">+</span> <span class="n">delPart</span><span class="p">[</span><span class="n">direction</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="Lattice-654"><a href="#Lattice-654"><span class="linenos"> 654</span></a>                    <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Lattice-655"><a href="#Lattice-655"><span class="linenos"> 655</span></a>                <span class="p">)</span>
</span><span id="Lattice-656"><a href="#Lattice-656"><span class="linenos"> 656</span></a>
</span><span id="Lattice-657"><a href="#Lattice-657"><span class="linenos"> 657</span></a>                <span class="k">if</span> <span class="n">inside_erased</span><span class="p">:</span>
</span><span id="Lattice-658"><a href="#Lattice-658"><span class="linenos"> 658</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="Lattice-659"><a href="#Lattice-659"><span class="linenos"> 659</span></a>
</span><span id="Lattice-660"><a href="#Lattice-660"><span class="linenos"> 660</span></a>        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># cell removed</span>
</span><span id="Lattice-661"><a href="#Lattice-661"><span class="linenos"> 661</span></a>
</span><span id="Lattice-662"><a href="#Lattice-662"><span class="linenos"> 662</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-663"><a href="#Lattice-663"><span class="linenos"> 663</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-664"><a href="#Lattice-664"><span class="linenos"> 664</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_beam_node_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-665"><a href="#Lattice-665"><span class="linenos"> 665</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-666"><a href="#Lattice-666"><span class="linenos"> 666</span></a><span class="sd">        Define index at each beam and node</span>
</span><span id="Lattice-667"><a href="#Lattice-667"><span class="linenos"> 667</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-668"><a href="#Lattice-668"><span class="linenos"> 668</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice-669"><a href="#Lattice-669"><span class="linenos"> 669</span></a>
</span><span id="Lattice-670"><a href="#Lattice-670"><span class="linenos"> 670</span></a>        <span class="c1"># Beams</span>
</span><span id="Lattice-671"><a href="#Lattice-671"><span class="linenos"> 671</span></a>        <span class="n">existing_beam_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice-672"><a href="#Lattice-672"><span class="linenos"> 672</span></a>        <span class="n">next_beam_idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">existing_beam_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">existing_beam_idx</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="Lattice-673"><a href="#Lattice-673"><span class="linenos"> 673</span></a>
</span><span id="Lattice-674"><a href="#Lattice-674"><span class="linenos"> 674</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">beam_key</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
</span><span id="Lattice-675"><a href="#Lattice-675"><span class="linenos"> 675</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Key for sorting beams by their endpoints and radius. &quot;&quot;&quot;</span>
</span><span id="Lattice-676"><a href="#Lattice-676"><span class="linenos"> 676</span></a>            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice-677"><a href="#Lattice-677"><span class="linenos"> 677</span></a>            <span class="k">return</span> <span class="p">(</span><span class="nb">min</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">)),</span>
</span><span id="Lattice-678"><a href="#Lattice-678"><span class="linenos"> 678</span></a>                    <span class="nb">max</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">)),</span>
</span><span id="Lattice-679"><a href="#Lattice-679"><span class="linenos"> 679</span></a>                    <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span id="Lattice-680"><a href="#Lattice-680"><span class="linenos"> 680</span></a>
</span><span id="Lattice-681"><a href="#Lattice-681"><span class="linenos"> 681</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">beam_key</span><span class="p">):</span>
</span><span id="Lattice-682"><a href="#Lattice-682"><span class="linenos"> 682</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-683"><a href="#Lattice-683"><span class="linenos"> 683</span></a>                <span class="n">b</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">next_beam_idx</span>
</span><span id="Lattice-684"><a href="#Lattice-684"><span class="linenos"> 684</span></a>                <span class="n">next_beam_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Lattice-685"><a href="#Lattice-685"><span class="linenos"> 685</span></a>
</span><span id="Lattice-686"><a href="#Lattice-686"><span class="linenos"> 686</span></a>        <span class="c1"># Nodes</span>
</span><span id="Lattice-687"><a href="#Lattice-687"><span class="linenos"> 687</span></a>        <span class="n">existing_node_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice-688"><a href="#Lattice-688"><span class="linenos"> 688</span></a>        <span class="n">next_node_idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">existing_node_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">existing_node_idx</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="Lattice-689"><a href="#Lattice-689"><span class="linenos"> 689</span></a>
</span><span id="Lattice-690"><a href="#Lattice-690"><span class="linenos"> 690</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">node_key</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Lattice-691"><a href="#Lattice-691"><span class="linenos"> 691</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Key for sorting nodes by their coordinates. &quot;&quot;&quot;</span>
</span><span id="Lattice-692"><a href="#Lattice-692"><span class="linenos"> 692</span></a>            <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">z</span>
</span><span id="Lattice-693"><a href="#Lattice-693"><span class="linenos"> 693</span></a>
</span><span id="Lattice-694"><a href="#Lattice-694"><span class="linenos"> 694</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">node_key</span><span class="p">):</span>
</span><span id="Lattice-695"><a href="#Lattice-695"><span class="linenos"> 695</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-696"><a href="#Lattice-696"><span class="linenos"> 696</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">next_node_idx</span>
</span><span id="Lattice-697"><a href="#Lattice-697"><span class="linenos"> 697</span></a>                <span class="n">next_node_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Lattice-698"><a href="#Lattice-698"><span class="linenos"> 698</span></a>
</span><span id="Lattice-699"><a href="#Lattice-699"><span class="linenos"> 699</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-700"><a href="#Lattice-700"><span class="linenos"> 700</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-701"><a href="#Lattice-701"><span class="linenos"> 701</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_cell_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-702"><a href="#Lattice-702"><span class="linenos"> 702</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-703"><a href="#Lattice-703"><span class="linenos"> 703</span></a><span class="sd">        Define index at each cell</span>
</span><span id="Lattice-704"><a href="#Lattice-704"><span class="linenos"> 704</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-705"><a href="#Lattice-705"><span class="linenos"> 705</span></a>        <span class="n">cellIndexed</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice-706"><a href="#Lattice-706"><span class="linenos"> 706</span></a>        <span class="n">nextCellIndex</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice-707"><a href="#Lattice-707"><span class="linenos"> 707</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-708"><a href="#Lattice-708"><span class="linenos"> 708</span></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-709"><a href="#Lattice-709"><span class="linenos"> 709</span></a>                <span class="n">cellIndexed</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextCellIndex</span>
</span><span id="Lattice-710"><a href="#Lattice-710"><span class="linenos"> 710</span></a>                <span class="n">nextCellIndex</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Lattice-711"><a href="#Lattice-711"><span class="linenos"> 711</span></a>
</span><span id="Lattice-712"><a href="#Lattice-712"><span class="linenos"> 712</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-713"><a href="#Lattice-713"><span class="linenos"> 713</span></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-714"><a href="#Lattice-714"><span class="linenos"> 714</span></a>                <span class="k">if</span> <span class="n">cell</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cellIndexed</span><span class="p">:</span>
</span><span id="Lattice-715"><a href="#Lattice-715"><span class="linenos"> 715</span></a>                    <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">nextCellIndex</span>
</span><span id="Lattice-716"><a href="#Lattice-716"><span class="linenos"> 716</span></a>                    <span class="n">cellIndexed</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextCellIndex</span>
</span><span id="Lattice-717"><a href="#Lattice-717"><span class="linenos"> 717</span></a>                    <span class="n">nextCellIndex</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Lattice-718"><a href="#Lattice-718"><span class="linenos"> 718</span></a>
</span><span id="Lattice-719"><a href="#Lattice-719"><span class="linenos"> 719</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-720"><a href="#Lattice-720"><span class="linenos"> 720</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-721"><a href="#Lattice-721"><span class="linenos"> 721</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_node_local_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-722"><a href="#Lattice-722"><span class="linenos"> 722</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-723"><a href="#Lattice-723"><span class="linenos"> 723</span></a><span class="sd">        Define inside cell boundary tag for all boundary nodes</span>
</span><span id="Lattice-724"><a href="#Lattice-724"><span class="linenos"> 724</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-725"><a href="#Lattice-725"><span class="linenos"> 725</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-726"><a href="#Lattice-726"><span class="linenos"> 726</span></a>            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span>
</span><span id="Lattice-727"><a href="#Lattice-727"><span class="linenos"> 727</span></a>                <span class="n">local_tag</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tag_point</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">boundary_box</span><span class="p">)</span>
</span><span id="Lattice-728"><a href="#Lattice-728"><span class="linenos"> 728</span></a>                <span class="k">if</span> <span class="n">local_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-729"><a href="#Lattice-729"><span class="linenos"> 729</span></a>                    <span class="n">node</span><span class="o">.</span><span class="n">set_local_tag</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">local_tag</span><span class="p">)</span>
</span><span id="Lattice-730"><a href="#Lattice-730"><span class="linenos"> 730</span></a>
</span><span id="Lattice-731"><a href="#Lattice-731"><span class="linenos"> 731</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-732"><a href="#Lattice-732"><span class="linenos"> 732</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-733"><a href="#Lattice-733"><span class="linenos"> 733</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_cell_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-734"><a href="#Lattice-734"><span class="linenos"> 734</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-735"><a href="#Lattice-735"><span class="linenos"> 735</span></a><span class="sd">        Neighbour assignment using integer grid indices + optional periodic wrap.</span>
</span><span id="Lattice-736"><a href="#Lattice-736"><span class="linenos"> 736</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-737"><a href="#Lattice-737"><span class="linenos"> 737</span></a>        <span class="c1"># Build integer grid indices from positions</span>
</span><span id="Lattice-738"><a href="#Lattice-738"><span class="linenos"> 738</span></a>        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="Lattice-739"><a href="#Lattice-739"><span class="linenos"> 739</span></a>        <span class="n">inv_dx</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span>
</span><span id="Lattice-740"><a href="#Lattice-740"><span class="linenos"> 740</span></a>        <span class="n">inv_dy</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span>
</span><span id="Lattice-741"><a href="#Lattice-741"><span class="linenos"> 741</span></a>        <span class="n">inv_dz</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span>
</span><span id="Lattice-742"><a href="#Lattice-742"><span class="linenos"> 742</span></a>
</span><span id="Lattice-743"><a href="#Lattice-743"><span class="linenos"> 743</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">to_idx</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="Lattice-744"><a href="#Lattice-744"><span class="linenos"> 744</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-745"><a href="#Lattice-745"><span class="linenos"> 745</span></a><span class="sd">            Convert position to integer grid index.</span>
</span><span id="Lattice-746"><a href="#Lattice-746"><span class="linenos"> 746</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Lattice-747"><a href="#Lattice-747"><span class="linenos"> 747</span></a>            <span class="c1"># round to be robust to tiny float noise</span>
</span><span id="Lattice-748"><a href="#Lattice-748"><span class="linenos"> 748</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="Lattice-749"><a href="#Lattice-749"><span class="linenos"> 749</span></a>                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_dx</span><span class="p">)),</span>
</span><span id="Lattice-750"><a href="#Lattice-750"><span class="linenos"> 750</span></a>                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_dy</span><span class="p">)),</span>
</span><span id="Lattice-751"><a href="#Lattice-751"><span class="linenos"> 751</span></a>                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_dz</span><span class="p">)),</span>
</span><span id="Lattice-752"><a href="#Lattice-752"><span class="linenos"> 752</span></a>            <span class="p">)</span>
</span><span id="Lattice-753"><a href="#Lattice-753"><span class="linenos"> 753</span></a>
</span><span id="Lattice-754"><a href="#Lattice-754"><span class="linenos"> 754</span></a>        <span class="n">idx_to_cell</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice-755"><a href="#Lattice-755"><span class="linenos"> 755</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-756"><a href="#Lattice-756"><span class="linenos"> 756</span></a>            <span class="n">idx_to_cell</span><span class="p">[</span><span class="n">to_idx</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="Lattice-757"><a href="#Lattice-757"><span class="linenos"> 757</span></a>
</span><span id="Lattice-758"><a href="#Lattice-758"><span class="linenos"> 758</span></a>        <span class="c1"># Grid extents for wrapping / bounds</span>
</span><span id="Lattice-759"><a href="#Lattice-759"><span class="linenos"> 759</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_to_cell</span><span class="p">})</span>
</span><span id="Lattice-760"><a href="#Lattice-760"><span class="linenos"> 760</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">j</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_to_cell</span><span class="p">})</span>
</span><span id="Lattice-761"><a href="#Lattice-761"><span class="linenos"> 761</span></a>        <span class="n">zs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_to_cell</span><span class="p">})</span>
</span><span id="Lattice-762"><a href="#Lattice-762"><span class="linenos"> 762</span></a>        <span class="n">ix0</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="Lattice-763"><a href="#Lattice-763"><span class="linenos"> 763</span></a>        <span class="n">iy0</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span><span id="Lattice-764"><a href="#Lattice-764"><span class="linenos"> 764</span></a>        <span class="n">iz0</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
</span><span id="Lattice-765"><a href="#Lattice-765"><span class="linenos"> 765</span></a>
</span><span id="Lattice-766"><a href="#Lattice-766"><span class="linenos"> 766</span></a>        <span class="c1"># Offsets and their (axis, sign) labels</span>
</span><span id="Lattice-767"><a href="#Lattice-767"><span class="linenos"> 767</span></a>        <span class="n">neighbor_steps</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Lattice-768"><a href="#Lattice-768"><span class="linenos"> 768</span></a>            <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;negatif&quot;</span><span class="p">)),</span>
</span><span id="Lattice-769"><a href="#Lattice-769"><span class="linenos"> 769</span></a>            <span class="p">((</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;positif&quot;</span><span class="p">)),</span>
</span><span id="Lattice-770"><a href="#Lattice-770"><span class="linenos"> 770</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;negatif&quot;</span><span class="p">)),</span>
</span><span id="Lattice-771"><a href="#Lattice-771"><span class="linenos"> 771</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;positif&quot;</span><span class="p">)),</span>
</span><span id="Lattice-772"><a href="#Lattice-772"><span class="linenos"> 772</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;negatif&quot;</span><span class="p">)),</span>
</span><span id="Lattice-773"><a href="#Lattice-773"><span class="linenos"> 773</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;positif&quot;</span><span class="p">)),</span>
</span><span id="Lattice-774"><a href="#Lattice-774"><span class="linenos"> 774</span></a>        <span class="p">]</span>
</span><span id="Lattice-775"><a href="#Lattice-775"><span class="linenos"> 775</span></a>
</span><span id="Lattice-776"><a href="#Lattice-776"><span class="linenos"> 776</span></a>        <span class="c1"># Assign neighbours</span>
</span><span id="Lattice-777"><a href="#Lattice-777"><span class="linenos"> 777</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-778"><a href="#Lattice-778"><span class="linenos"> 778</span></a>            <span class="c1"># reset dict container</span>
</span><span id="Lattice-779"><a href="#Lattice-779"><span class="linenos"> 779</span></a>            <span class="n">c</span><span class="o">.</span><span class="n">neighbour_cells</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice-780"><a href="#Lattice-780"><span class="linenos"> 780</span></a>
</span><span id="Lattice-781"><a href="#Lattice-781"><span class="linenos"> 781</span></a>            <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span> <span class="o">=</span> <span class="n">to_idx</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</span><span id="Lattice-782"><a href="#Lattice-782"><span class="linenos"> 782</span></a>            <span class="k">for</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">),</span> <span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">sign</span><span class="p">)</span> <span class="ow">in</span> <span class="n">neighbor_steps</span><span class="p">:</span>
</span><span id="Lattice-783"><a href="#Lattice-783"><span class="linenos"> 783</span></a>                <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">niz</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">iz</span> <span class="o">+</span> <span class="n">dz</span>
</span><span id="Lattice-784"><a href="#Lattice-784"><span class="linenos"> 784</span></a>
</span><span id="Lattice-785"><a href="#Lattice-785"><span class="linenos"> 785</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span><span class="p">:</span>
</span><span id="Lattice-786"><a href="#Lattice-786"><span class="linenos"> 786</span></a>                    <span class="c1"># periodic wrap (relative to min index of each axis)</span>
</span><span id="Lattice-787"><a href="#Lattice-787"><span class="linenos"> 787</span></a>                    <span class="k">if</span> <span class="n">nx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-788"><a href="#Lattice-788"><span class="linenos"> 788</span></a>                        <span class="n">nix</span> <span class="o">=</span> <span class="n">ix0</span> <span class="o">+</span> <span class="p">((</span><span class="n">nix</span> <span class="o">-</span> <span class="n">ix0</span><span class="p">)</span> <span class="o">%</span> <span class="n">nx</span><span class="p">)</span>
</span><span id="Lattice-789"><a href="#Lattice-789"><span class="linenos"> 789</span></a>                    <span class="k">if</span> <span class="n">ny</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-790"><a href="#Lattice-790"><span class="linenos"> 790</span></a>                        <span class="n">niy</span> <span class="o">=</span> <span class="n">iy0</span> <span class="o">+</span> <span class="p">((</span><span class="n">niy</span> <span class="o">-</span> <span class="n">iy0</span><span class="p">)</span> <span class="o">%</span> <span class="n">ny</span><span class="p">)</span>
</span><span id="Lattice-791"><a href="#Lattice-791"><span class="linenos"> 791</span></a>                    <span class="k">if</span> <span class="n">nz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-792"><a href="#Lattice-792"><span class="linenos"> 792</span></a>                        <span class="n">niz</span> <span class="o">=</span> <span class="n">iz0</span> <span class="o">+</span> <span class="p">((</span><span class="n">niz</span> <span class="o">-</span> <span class="n">iz0</span><span class="p">)</span> <span class="o">%</span> <span class="n">nz</span><span class="p">)</span>
</span><span id="Lattice-793"><a href="#Lattice-793"><span class="linenos"> 793</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-794"><a href="#Lattice-794"><span class="linenos"> 794</span></a>                    <span class="c1"># hard bounds (skip if outside)</span>
</span><span id="Lattice-795"><a href="#Lattice-795"><span class="linenos"> 795</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ix0</span> <span class="o">&lt;=</span> <span class="n">nix</span> <span class="o">&lt;</span> <span class="n">ix0</span> <span class="o">+</span> <span class="n">nx</span> <span class="ow">and</span> <span class="n">iy0</span> <span class="o">&lt;=</span> <span class="n">niy</span> <span class="o">&lt;</span> <span class="n">iy0</span> <span class="o">+</span> <span class="n">ny</span> <span class="ow">and</span> <span class="n">iz0</span> <span class="o">&lt;=</span> <span class="n">niz</span> <span class="o">&lt;</span> <span class="n">iz0</span> <span class="o">+</span> <span class="n">nz</span><span class="p">):</span>
</span><span id="Lattice-796"><a href="#Lattice-796"><span class="linenos"> 796</span></a>                        <span class="k">continue</span>
</span><span id="Lattice-797"><a href="#Lattice-797"><span class="linenos"> 797</span></a>
</span><span id="Lattice-798"><a href="#Lattice-798"><span class="linenos"> 798</span></a>                <span class="n">neigh</span> <span class="o">=</span> <span class="n">idx_to_cell</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">niz</span><span class="p">))</span>
</span><span id="Lattice-799"><a href="#Lattice-799"><span class="linenos"> 799</span></a>                <span class="k">if</span> <span class="n">neigh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-800"><a href="#Lattice-800"><span class="linenos"> 800</span></a>                    <span class="n">c</span><span class="o">.</span><span class="n">add_cell_neighbour</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">sign</span><span class="p">,</span> <span class="n">neigh</span><span class="p">)</span>
</span><span id="Lattice-801"><a href="#Lattice-801"><span class="linenos"> 801</span></a>
</span><span id="Lattice-802"><a href="#Lattice-802"><span class="linenos"> 802</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-803"><a href="#Lattice-803"><span class="linenos"> 803</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-804"><a href="#Lattice-804"><span class="linenos"> 804</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_connected_beams_for_all_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merge_tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-805"><a href="#Lattice-805"><span class="linenos"> 805</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-806"><a href="#Lattice-806"><span class="linenos"> 806</span></a><span class="sd">        Populate `Point.connected_beams` for all nodes.</span>
</span><span id="Lattice-807"><a href="#Lattice-807"><span class="linenos"> 807</span></a><span class="sd">        Optionally merges connectivity for coincident/periodic nodes via a spatial hash.</span>
</span><span id="Lattice-808"><a href="#Lattice-808"><span class="linenos"> 808</span></a>
</span><span id="Lattice-809"><a href="#Lattice-809"><span class="linenos"> 809</span></a><span class="sd">        Parameters</span>
</span><span id="Lattice-810"><a href="#Lattice-810"><span class="linenos"> 810</span></a><span class="sd">        ----------</span>
</span><span id="Lattice-811"><a href="#Lattice-811"><span class="linenos"> 811</span></a><span class="sd">        merge_tol : float</span>
</span><span id="Lattice-812"><a href="#Lattice-812"><span class="linenos"> 812</span></a><span class="sd">            Quantization used to bucket nearly-identical coordinates (and periodic wraps).</span>
</span><span id="Lattice-813"><a href="#Lattice-813"><span class="linenos"> 813</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-814"><a href="#Lattice-814"><span class="linenos"> 814</span></a>        <span class="c1"># Reset connected_beams</span>
</span><span id="Lattice-815"><a href="#Lattice-815"><span class="linenos"> 815</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice-816"><a href="#Lattice-816"><span class="linenos"> 816</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-817"><a href="#Lattice-817"><span class="linenos"> 817</span></a>
</span><span id="Lattice-818"><a href="#Lattice-818"><span class="linenos"> 818</span></a>        <span class="c1"># Single pass: attach each beam to its two endpoints</span>
</span><span id="Lattice-819"><a href="#Lattice-819"><span class="linenos"> 819</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice-820"><a href="#Lattice-820"><span class="linenos"> 820</span></a>            <span class="n">a</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice-821"><a href="#Lattice-821"><span class="linenos"> 821</span></a>            <span class="n">a</span><span class="o">.</span><span class="n">connected_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="Lattice-822"><a href="#Lattice-822"><span class="linenos"> 822</span></a>            <span class="n">c</span><span class="o">.</span><span class="n">connected_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="Lattice-823"><a href="#Lattice-823"><span class="linenos"> 823</span></a>
</span><span id="Lattice-824"><a href="#Lattice-824"><span class="linenos"> 824</span></a>        <span class="c1">#  Optional stitching of coincident &amp; periodic nodes via spatial hashing</span>
</span><span id="Lattice-825"><a href="#Lattice-825"><span class="linenos"> 825</span></a>        <span class="c1"># Build spatial buckets</span>
</span><span id="Lattice-826"><a href="#Lattice-826"><span class="linenos"> 826</span></a>        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="Lattice-827"><a href="#Lattice-827"><span class="linenos"> 827</span></a>
</span><span id="Lattice-828"><a href="#Lattice-828"><span class="linenos"> 828</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">qkey</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="Lattice-829"><a href="#Lattice-829"><span class="linenos"> 829</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Quantized key for spatial hashing.&quot;&quot;&quot;</span>
</span><span id="Lattice-830"><a href="#Lattice-830"><span class="linenos"> 830</span></a>            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">merge_tol</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">merge_tol</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="n">merge_tol</span><span class="p">)</span>
</span><span id="Lattice-831"><a href="#Lattice-831"><span class="linenos"> 831</span></a>
</span><span id="Lattice-832"><a href="#Lattice-832"><span class="linenos"> 832</span></a>        <span class="n">buckets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># geometric buckets (exact/coincident)</span>
</span><span id="Lattice-833"><a href="#Lattice-833"><span class="linenos"> 833</span></a>        <span class="n">periodic_buckets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># buckets after wrapping (only if periodicity enabled)</span>
</span><span id="Lattice-834"><a href="#Lattice-834"><span class="linenos"> 834</span></a>
</span><span id="Lattice-835"><a href="#Lattice-835"><span class="linenos"> 835</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">add_to_bucket</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span><span id="Lattice-836"><a href="#Lattice-836"><span class="linenos"> 836</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Add point to geometric bucket.&quot;&quot;&quot;</span>
</span><span id="Lattice-837"><a href="#Lattice-837"><span class="linenos"> 837</span></a>            <span class="n">k</span> <span class="o">=</span> <span class="n">qkey</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
</span><span id="Lattice-838"><a href="#Lattice-838"><span class="linenos"> 838</span></a>            <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Lattice-839"><a href="#Lattice-839"><span class="linenos"> 839</span></a>
</span><span id="Lattice-840"><a href="#Lattice-840"><span class="linenos"> 840</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">add_to_periodic_bucket</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span><span id="Lattice-841"><a href="#Lattice-841"><span class="linenos"> 841</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Add point to periodic bucket (wrap max-face to min-face).&quot;&quot;&quot;</span>
</span><span id="Lattice-842"><a href="#Lattice-842"><span class="linenos"> 842</span></a>            <span class="n">wx</span> <span class="o">=</span> <span class="n">xmin</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">merge_tol</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span>
</span><span id="Lattice-843"><a href="#Lattice-843"><span class="linenos"> 843</span></a>            <span class="n">wy</span> <span class="o">=</span> <span class="n">ymin</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">merge_tol</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span>
</span><span id="Lattice-844"><a href="#Lattice-844"><span class="linenos"> 844</span></a>            <span class="n">wz</span> <span class="o">=</span> <span class="n">zmin</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">zmax</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">merge_tol</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span>
</span><span id="Lattice-845"><a href="#Lattice-845"><span class="linenos"> 845</span></a>            <span class="n">k</span> <span class="o">=</span> <span class="n">qkey</span><span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span>
</span><span id="Lattice-846"><a href="#Lattice-846"><span class="linenos"> 846</span></a>            <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Lattice-847"><a href="#Lattice-847"><span class="linenos"> 847</span></a>
</span><span id="Lattice-848"><a href="#Lattice-848"><span class="linenos"> 848</span></a>        <span class="c1"># Fill buckets</span>
</span><span id="Lattice-849"><a href="#Lattice-849"><span class="linenos"> 849</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice-850"><a href="#Lattice-850"><span class="linenos"> 850</span></a>            <span class="n">add_to_bucket</span><span class="p">(</span><span class="n">buckets</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="Lattice-851"><a href="#Lattice-851"><span class="linenos"> 851</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;enable_periodicity&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="Lattice-852"><a href="#Lattice-852"><span class="linenos"> 852</span></a>                <span class="n">add_to_periodic_bucket</span><span class="p">(</span><span class="n">periodic_buckets</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="Lattice-853"><a href="#Lattice-853"><span class="linenos"> 853</span></a>
</span><span id="Lattice-854"><a href="#Lattice-854"><span class="linenos"> 854</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">merge_bucket_connectivity</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
</span><span id="Lattice-855"><a href="#Lattice-855"><span class="linenos"> 855</span></a>            <span class="k">for</span> <span class="n">pts</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Lattice-856"><a href="#Lattice-856"><span class="linenos"> 856</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Lattice-857"><a href="#Lattice-857"><span class="linenos"> 857</span></a>                    <span class="k">continue</span>
</span><span id="Lattice-858"><a href="#Lattice-858"><span class="linenos"> 858</span></a>                <span class="n">merged</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-859"><a href="#Lattice-859"><span class="linenos"> 859</span></a>                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="Lattice-860"><a href="#Lattice-860"><span class="linenos"> 860</span></a>                    <span class="n">merged</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="Lattice-861"><a href="#Lattice-861"><span class="linenos"> 861</span></a>                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="Lattice-862"><a href="#Lattice-862"><span class="linenos"> 862</span></a>                    <span class="n">pt</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span id="Lattice-863"><a href="#Lattice-863"><span class="linenos"> 863</span></a>
</span><span id="Lattice-864"><a href="#Lattice-864"><span class="linenos"> 864</span></a>        <span class="n">merge_bucket_connectivity</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>
</span><span id="Lattice-865"><a href="#Lattice-865"><span class="linenos"> 865</span></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;enable_periodicity&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="Lattice-866"><a href="#Lattice-866"><span class="linenos"> 866</span></a>            <span class="n">merge_bucket_connectivity</span><span class="p">(</span><span class="n">periodic_buckets</span><span class="p">)</span>
</span><span id="Lattice-867"><a href="#Lattice-867"><span class="linenos"> 867</span></a>
</span><span id="Lattice-868"><a href="#Lattice-868"><span class="linenos"> 868</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice-869"><a href="#Lattice-869"><span class="linenos"> 869</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-870"><a href="#Lattice-870"><span class="linenos"> 870</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_angles_between_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-871"><a href="#Lattice-871"><span class="linenos"> 871</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-872"><a href="#Lattice-872"><span class="linenos"> 872</span></a><span class="sd">        Compute, for each beam, the penalization-optimal angle at its two endpoints</span>
</span><span id="Lattice-873"><a href="#Lattice-873"><span class="linenos"> 873</span></a><span class="sd">        using node-level connectivity (Point.connected_beams). Assumes</span>
</span><span id="Lattice-874"><a href="#Lattice-874"><span class="linenos"> 874</span></a><span class="sd">        `define_connected_beams_for_all_nodes()` has been called.</span>
</span><span id="Lattice-875"><a href="#Lattice-875"><span class="linenos"> 875</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-876"><a href="#Lattice-876"><span class="linenos"> 876</span></a>        <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-877"><a href="#Lattice-877"><span class="linenos"> 877</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_best_by_penalization</span><span class="p">(</span><span class="n">angles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Lattice-878"><a href="#Lattice-878"><span class="linenos"> 878</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Return (angle, radius) that maximizes L = function_penalization_Lzone((radius, angle)).&quot;&quot;&quot;</span>
</span><span id="Lattice-879"><a href="#Lattice-879"><span class="linenos"> 879</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">angles</span><span class="p">:</span>
</span><span id="Lattice-880"><a href="#Lattice-880"><span class="linenos"> 880</span></a>                <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
</span><span id="Lattice-881"><a href="#Lattice-881"><span class="linenos"> 881</span></a>            <span class="n">Lmax</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="Lattice-882"><a href="#Lattice-882"><span class="linenos"> 882</span></a>            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">angles</span><span class="p">):</span>
</span><span id="Lattice-883"><a href="#Lattice-883"><span class="linenos"> 883</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">function_penalization_Lzone</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span id="Lattice-884"><a href="#Lattice-884"><span class="linenos"> 884</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="o">&gt;</span> <span class="n">Lmax</span><span class="p">:</span>
</span><span id="Lattice-885"><a href="#Lattice-885"><span class="linenos"> 885</span></a>                    <span class="n">Lmax</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="n">L</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="Lattice-886"><a href="#Lattice-886"><span class="linenos"> 886</span></a>            <span class="k">return</span> <span class="n">best</span>
</span><span id="Lattice-887"><a href="#Lattice-887"><span class="linenos"> 887</span></a>
</span><span id="Lattice-888"><a href="#Lattice-888"><span class="linenos"> 888</span></a>        <span class="c1"># Compute angles using local node neighborhoods only</span>
</span><span id="Lattice-889"><a href="#Lattice-889"><span class="linenos"> 889</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice-890"><a href="#Lattice-890"><span class="linenos"> 890</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">):</span>
</span><span id="Lattice-891"><a href="#Lattice-891"><span class="linenos"> 891</span></a>                <span class="n">a1_list</span><span class="p">,</span> <span class="n">r1_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Lattice-892"><a href="#Lattice-892"><span class="linenos"> 892</span></a>                <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">:</span>
</span><span id="Lattice-893"><a href="#Lattice-893"><span class="linenos"> 893</span></a>                    <span class="k">if</span> <span class="n">nb</span> <span class="ow">is</span> <span class="n">b</span><span class="p">:</span> <span class="k">continue</span>
</span><span id="Lattice-894"><a href="#Lattice-894"><span class="linenos"> 894</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice-895"><a href="#Lattice-895"><span class="linenos"> 895</span></a>                        <span class="n">ang</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_angle_between_beams</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span><span class="p">)</span>
</span><span id="Lattice-896"><a href="#Lattice-896"><span class="linenos"> 896</span></a>                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="Lattice-897"><a href="#Lattice-897"><span class="linenos"> 897</span></a>                        <span class="k">continue</span>
</span><span id="Lattice-898"><a href="#Lattice-898"><span class="linenos"> 898</span></a>                    <span class="k">if</span> <span class="n">ang</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">:</span>
</span><span id="Lattice-899"><a href="#Lattice-899"><span class="linenos"> 899</span></a>                        <span class="n">a1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ang</span><span class="p">);</span>
</span><span id="Lattice-900"><a href="#Lattice-900"><span class="linenos"> 900</span></a>                        <span class="n">r1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Lattice-901"><a href="#Lattice-901"><span class="linenos"> 901</span></a>                <span class="n">ang1</span><span class="p">,</span> <span class="n">rad1</span> <span class="o">=</span> <span class="n">_best_by_penalization</span><span class="p">(</span><span class="n">a1_list</span><span class="p">,</span> <span class="n">r1_list</span><span class="p">)</span>
</span><span id="Lattice-902"><a href="#Lattice-902"><span class="linenos"> 902</span></a>                <span class="n">b</span><span class="o">.</span><span class="n">set_angle</span><span class="p">(</span><span class="n">rad1</span><span class="p">,</span> <span class="n">ang1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="Lattice-903"><a href="#Lattice-903"><span class="linenos"> 903</span></a>
</span><span id="Lattice-904"><a href="#Lattice-904"><span class="linenos"> 904</span></a>
</span><span id="Lattice-905"><a href="#Lattice-905"><span class="linenos"> 905</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-906"><a href="#Lattice-906"><span class="linenos"> 906</span></a><span class="c1"># SECTION: Utils Methods</span>
</span><span id="Lattice-907"><a href="#Lattice-907"><span class="linenos"> 907</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-908"><a href="#Lattice-908"><span class="linenos"> 908</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-909"><a href="#Lattice-909"><span class="linenos"> 909</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-910"><a href="#Lattice-910"><span class="linenos"> 910</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_refresh_nodes_and_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-911"><a href="#Lattice-911"><span class="linenos"> 911</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-912"><a href="#Lattice-912"><span class="linenos"> 912</span></a><span class="sd">        Refresh the sets of nodes and beams in the lattice.</span>
</span><span id="Lattice-913"><a href="#Lattice-913"><span class="linenos"> 913</span></a><span class="sd">        This is useful after adding or removing cells to ensure</span>
</span><span id="Lattice-914"><a href="#Lattice-914"><span class="linenos"> 914</span></a><span class="sd">        that the lattice&#39;s nodes and beams accurately reflect its current state.</span>
</span><span id="Lattice-915"><a href="#Lattice-915"><span class="linenos"> 915</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-916"><a href="#Lattice-916"><span class="linenos"> 916</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-917"><a href="#Lattice-917"><span class="linenos"> 917</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-918"><a href="#Lattice-918"><span class="linenos"> 918</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-919"><a href="#Lattice-919"><span class="linenos"> 919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="Lattice-920"><a href="#Lattice-920"><span class="linenos"> 920</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="Lattice-921"><a href="#Lattice-921"><span class="linenos"> 921</span></a>
</span><span id="Lattice-922"><a href="#Lattice-922"><span class="linenos"> 922</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-923"><a href="#Lattice-923"><span class="linenos"> 923</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-924"><a href="#Lattice-924"><span class="linenos"> 924</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_cells_memberships</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-925"><a href="#Lattice-925"><span class="linenos"> 925</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-926"><a href="#Lattice-926"><span class="linenos"> 926</span></a><span class="sd">        Public helper to refresh all cells&#39; beams/points from the current global state.</span>
</span><span id="Lattice-927"><a href="#Lattice-927"><span class="linenos"> 927</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-928"><a href="#Lattice-928"><span class="linenos"> 928</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-929"><a href="#Lattice-929"><span class="linenos"> 929</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;refresh_from_global&quot;</span><span class="p">):</span>
</span><span id="Lattice-930"><a href="#Lattice-930"><span class="linenos"> 930</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">refresh_from_global</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
</span><span id="Lattice-931"><a href="#Lattice-931"><span class="linenos"> 931</span></a>
</span><span id="Lattice-932"><a href="#Lattice-932"><span class="linenos"> 932</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-933"><a href="#Lattice-933"><span class="linenos"> 933</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-934"><a href="#Lattice-934"><span class="linenos"> 934</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-935"><a href="#Lattice-935"><span class="linenos"> 935</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-936"><a href="#Lattice-936"><span class="linenos"> 936</span></a><span class="sd">        Removes a cell from the lattice</span>
</span><span id="Lattice-937"><a href="#Lattice-937"><span class="linenos"> 937</span></a>
</span><span id="Lattice-938"><a href="#Lattice-938"><span class="linenos"> 938</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-939"><a href="#Lattice-939"><span class="linenos"> 939</span></a><span class="sd">        ------------</span>
</span><span id="Lattice-940"><a href="#Lattice-940"><span class="linenos"> 940</span></a><span class="sd">        index: int</span>
</span><span id="Lattice-941"><a href="#Lattice-941"><span class="linenos"> 941</span></a><span class="sd">            index of the cell to remove</span>
</span><span id="Lattice-942"><a href="#Lattice-942"><span class="linenos"> 942</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-943"><a href="#Lattice-943"><span class="linenos"> 943</span></a>        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="Lattice-944"><a href="#Lattice-944"><span class="linenos"> 944</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="Lattice-945"><a href="#Lattice-945"><span class="linenos"> 945</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-946"><a href="#Lattice-946"><span class="linenos"> 946</span></a>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Invalid cell index.&quot;</span><span class="p">)</span>
</span><span id="Lattice-947"><a href="#Lattice-947"><span class="linenos"> 947</span></a>
</span><span id="Lattice-948"><a href="#Lattice-948"><span class="linenos"> 948</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-949"><a href="#Lattice-949"><span class="linenos"> 949</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-950"><a href="#Lattice-950"><span class="linenos"> 950</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_minimum_beam_length</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Lattice-951"><a href="#Lattice-951"><span class="linenos"> 951</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-952"><a href="#Lattice-952"><span class="linenos"> 952</span></a><span class="sd">        Find minimum beam length</span>
</span><span id="Lattice-953"><a href="#Lattice-953"><span class="linenos"> 953</span></a>
</span><span id="Lattice-954"><a href="#Lattice-954"><span class="linenos"> 954</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice-955"><a href="#Lattice-955"><span class="linenos"> 955</span></a><span class="sd">        --------</span>
</span><span id="Lattice-956"><a href="#Lattice-956"><span class="linenos"> 956</span></a><span class="sd">        minLength: float</span>
</span><span id="Lattice-957"><a href="#Lattice-957"><span class="linenos"> 957</span></a><span class="sd">            Length of the smallest beam in the lattice</span>
</span><span id="Lattice-958"><a href="#Lattice-958"><span class="linenos"> 958</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-959"><a href="#Lattice-959"><span class="linenos"> 959</span></a>        <span class="n">minLength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="Lattice-960"><a href="#Lattice-960"><span class="linenos"> 960</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-961"><a href="#Lattice-961"><span class="linenos"> 961</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Lattice-962"><a href="#Lattice-962"><span class="linenos"> 962</span></a>                <span class="k">if</span> <span class="n">minLength</span> <span class="o">&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mf">0.0001</span> <span class="ow">and</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="Lattice-963"><a href="#Lattice-963"><span class="linenos"> 963</span></a>                    <span class="n">minLength</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">length</span>
</span><span id="Lattice-964"><a href="#Lattice-964"><span class="linenos"> 964</span></a>        <span class="k">return</span> <span class="n">minLength</span>
</span><span id="Lattice-965"><a href="#Lattice-965"><span class="linenos"> 965</span></a>
</span><span id="Lattice-966"><a href="#Lattice-966"><span class="linenos"> 966</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-967"><a href="#Lattice-967"><span class="linenos"> 967</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-968"><a href="#Lattice-968"><span class="linenos"> 968</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tag_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Lattice-969"><a href="#Lattice-969"><span class="linenos"> 969</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the tag for all unique points in the lattice.&quot;&quot;&quot;</span>
</span><span id="Lattice-970"><a href="#Lattice-970"><span class="linenos"> 970</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="Lattice-971"><a href="#Lattice-971"><span class="linenos"> 971</span></a>
</span><span id="Lattice-972"><a href="#Lattice-972"><span class="linenos"> 972</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-973"><a href="#Lattice-973"><span class="linenos"> 973</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-974"><a href="#Lattice-974"><span class="linenos"> 974</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tag_list_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Lattice-975"><a href="#Lattice-975"><span class="linenos"> 975</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the tag for boundary points in the lattice.&quot;&quot;&quot;</span>
</span><span id="Lattice-976"><a href="#Lattice-976"><span class="linenos"> 976</span></a>        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="Lattice-977"><a href="#Lattice-977"><span class="linenos"> 977</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_on_boundary</span><span class="p">(</span><span class="n">bbox</span><span class="p">)]</span>
</span><span id="Lattice-978"><a href="#Lattice-978"><span class="linenos"> 978</span></a>
</span><span id="Lattice-979"><a href="#Lattice-979"><span class="linenos"> 979</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-980"><a href="#Lattice-980"><span class="linenos"> 980</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-981"><a href="#Lattice-981"><span class="linenos"> 981</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_tag_all_point</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-982"><a href="#Lattice-982"><span class="linenos"> 982</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-983"><a href="#Lattice-983"><span class="linenos"> 983</span></a><span class="sd">        Assign a tag to all nodes in the lattice structure.</span>
</span><span id="Lattice-984"><a href="#Lattice-984"><span class="linenos"> 984</span></a><span class="sd">        Tags are assigned relative to either the global bounding box</span>
</span><span id="Lattice-985"><a href="#Lattice-985"><span class="linenos"> 985</span></a><span class="sd">        or a local (cell-relative) bounding box if erased parts are used.</span>
</span><span id="Lattice-986"><a href="#Lattice-986"><span class="linenos"> 986</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-987"><a href="#Lattice-987"><span class="linenos"> 987</span></a>        <span class="n">use_local_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="Lattice-988"><a href="#Lattice-988"><span class="linenos"> 988</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_local_box</span><span class="p">:</span>
</span><span id="Lattice-989"><a href="#Lattice-989"><span class="linenos"> 989</span></a>            <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="Lattice-990"><a href="#Lattice-990"><span class="linenos"> 990</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice-991"><a href="#Lattice-991"><span class="linenos"> 991</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tag_point</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
</span><span id="Lattice-992"><a href="#Lattice-992"><span class="linenos"> 992</span></a>            <span class="k">return</span>
</span><span id="Lattice-993"><a href="#Lattice-993"><span class="linenos"> 993</span></a>
</span><span id="Lattice-994"><a href="#Lattice-994"><span class="linenos"> 994</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-995"><a href="#Lattice-995"><span class="linenos"> 995</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_occupancy_matrix</span><span class="p">()</span>
</span><span id="Lattice-996"><a href="#Lattice-996"><span class="linenos"> 996</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-997"><a href="#Lattice-997"><span class="linenos"> 997</span></a>            <span class="n">local_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relative_boundary_box</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="Lattice-998"><a href="#Lattice-998"><span class="linenos"> 998</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span>
</span><span id="Lattice-999"><a href="#Lattice-999"><span class="linenos"> 999</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tag_point</span><span class="p">(</span><span class="n">local_box</span><span class="p">)</span>
</span><span id="Lattice-1000"><a href="#Lattice-1000"><span class="linenos">1000</span></a>
</span><span id="Lattice-1001"><a href="#Lattice-1001"><span class="linenos">1001</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1002"><a href="#Lattice-1002"><span class="linenos">1002</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1003"><a href="#Lattice-1003"><span class="linenos">1003</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cell_occupancy_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice-1004"><a href="#Lattice-1004"><span class="linenos">1004</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1005"><a href="#Lattice-1005"><span class="linenos">1005</span></a><span class="sd">        Build a 3D matrix storing Cell objects (or None) at each (i, j, k).</span>
</span><span id="Lattice-1006"><a href="#Lattice-1006"><span class="linenos">1006</span></a>
</span><span id="Lattice-1007"><a href="#Lattice-1007"><span class="linenos">1007</span></a><span class="sd">        Returns</span>
</span><span id="Lattice-1008"><a href="#Lattice-1008"><span class="linenos">1008</span></a><span class="sd">        -------</span>
</span><span id="Lattice-1009"><a href="#Lattice-1009"><span class="linenos">1009</span></a><span class="sd">        occupancy_matrix : np.ndarray, shape (num_cells_x, num_cells_y, num_cells_z), dtype=object</span>
</span><span id="Lattice-1010"><a href="#Lattice-1010"><span class="linenos">1010</span></a><span class="sd">            occupancy_matrix[i, j, k] is the Cell at that grid position, or None if empty.</span>
</span><span id="Lattice-1011"><a href="#Lattice-1011"><span class="linenos">1011</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1012"><a href="#Lattice-1012"><span class="linenos">1012</span></a>        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span>
</span><span id="Lattice-1013"><a href="#Lattice-1013"><span class="linenos">1013</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="Lattice-1014"><a href="#Lattice-1014"><span class="linenos">1014</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-1015"><a href="#Lattice-1015"><span class="linenos">1015</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-1016"><a href="#Lattice-1016"><span class="linenos">1016</span></a>            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">pos</span>  <span class="c1"># integer grid indices</span>
</span><span id="Lattice-1017"><a href="#Lattice-1017"><span class="linenos">1017</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>
</span><span id="Lattice-1018"><a href="#Lattice-1018"><span class="linenos">1018</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span>
</span><span id="Lattice-1019"><a href="#Lattice-1019"><span class="linenos">1019</span></a>
</span><span id="Lattice-1020"><a href="#Lattice-1020"><span class="linenos">1020</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1021"><a href="#Lattice-1021"><span class="linenos">1021</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1022"><a href="#Lattice-1022"><span class="linenos">1022</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cells_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Lattice-1023"><a href="#Lattice-1023"><span class="linenos">1023</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1024"><a href="#Lattice-1024"><span class="linenos">1024</span></a><span class="sd">        Get all cells at a specific index along a specified axis.</span>
</span><span id="Lattice-1025"><a href="#Lattice-1025"><span class="linenos">1025</span></a>
</span><span id="Lattice-1026"><a href="#Lattice-1026"><span class="linenos">1026</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-1027"><a href="#Lattice-1027"><span class="linenos">1027</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-1028"><a href="#Lattice-1028"><span class="linenos">1028</span></a><span class="sd">        axis: str</span>
</span><span id="Lattice-1029"><a href="#Lattice-1029"><span class="linenos">1029</span></a><span class="sd">            Axis to query (&#39;x&#39;, &#39;y&#39;, or &#39;z&#39;).</span>
</span><span id="Lattice-1030"><a href="#Lattice-1030"><span class="linenos">1030</span></a>
</span><span id="Lattice-1031"><a href="#Lattice-1031"><span class="linenos">1031</span></a><span class="sd">        index: int</span>
</span><span id="Lattice-1032"><a href="#Lattice-1032"><span class="linenos">1032</span></a><span class="sd">            Index along the specified axis.</span>
</span><span id="Lattice-1033"><a href="#Lattice-1033"><span class="linenos">1033</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1034"><a href="#Lattice-1034"><span class="linenos">1034</span></a>        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
</span><span id="Lattice-1035"><a href="#Lattice-1035"><span class="linenos">1035</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice-1036"><a href="#Lattice-1036"><span class="linenos">1036</span></a>        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
</span><span id="Lattice-1037"><a href="#Lattice-1037"><span class="linenos">1037</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice-1038"><a href="#Lattice-1038"><span class="linenos">1038</span></a>        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
</span><span id="Lattice-1039"><a href="#Lattice-1039"><span class="linenos">1039</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice-1040"><a href="#Lattice-1040"><span class="linenos">1040</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-1041"><a href="#Lattice-1041"><span class="linenos">1041</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be &#39;x&#39;, &#39;y&#39;, or &#39;z&#39;&quot;</span><span class="p">)</span>
</span><span id="Lattice-1042"><a href="#Lattice-1042"><span class="linenos">1042</span></a>
</span><span id="Lattice-1043"><a href="#Lattice-1043"><span class="linenos">1043</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1044"><a href="#Lattice-1044"><span class="linenos">1044</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1045"><a href="#Lattice-1045"><span class="linenos">1045</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
</span><span id="Lattice-1046"><a href="#Lattice-1046"><span class="linenos">1046</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1047"><a href="#Lattice-1047"><span class="linenos">1047</span></a><span class="sd">        Get the relative boundary box of a cell in the lattice.</span>
</span><span id="Lattice-1048"><a href="#Lattice-1048"><span class="linenos">1048</span></a><span class="sd">        It corresponds to the minimum and maximum dimension of the lattice for each axis with cell continuity.</span>
</span><span id="Lattice-1049"><a href="#Lattice-1049"><span class="linenos">1049</span></a><span class="sd">        Useful for structures with erased parts or periodic boundaries.</span>
</span><span id="Lattice-1050"><a href="#Lattice-1050"><span class="linenos">1050</span></a>
</span><span id="Lattice-1051"><a href="#Lattice-1051"><span class="linenos">1051</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-1052"><a href="#Lattice-1052"><span class="linenos">1052</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-1053"><a href="#Lattice-1053"><span class="linenos">1053</span></a><span class="sd">        cell: Cell object</span>
</span><span id="Lattice-1054"><a href="#Lattice-1054"><span class="linenos">1054</span></a><span class="sd">            The cell for which the boundary box is computed.</span>
</span><span id="Lattice-1055"><a href="#Lattice-1055"><span class="linenos">1055</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1056"><a href="#Lattice-1056"><span class="linenos">1056</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">pos</span>
</span><span id="Lattice-1057"><a href="#Lattice-1057"><span class="linenos">1057</span></a>        <span class="n">bbox</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-1058"><a href="#Lattice-1058"><span class="linenos">1058</span></a>
</span><span id="Lattice-1059"><a href="#Lattice-1059"><span class="linenos">1059</span></a>        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="Lattice-1060"><a href="#Lattice-1060"><span class="linenos">1060</span></a>                <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">],</span>
</span><span id="Lattice-1061"><a href="#Lattice-1061"><span class="linenos">1061</span></a>                <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span>
</span><span id="Lattice-1062"><a href="#Lattice-1062"><span class="linenos">1062</span></a>        <span class="p">):</span>
</span><span id="Lattice-1063"><a href="#Lattice-1063"><span class="linenos">1063</span></a>            <span class="n">arrayCell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cells_at_index</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</span><span id="Lattice-1064"><a href="#Lattice-1064"><span class="linenos">1064</span></a>            <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="Lattice-1065"><a href="#Lattice-1065"><span class="linenos">1065</span></a>
</span><span id="Lattice-1066"><a href="#Lattice-1066"><span class="linenos">1066</span></a>            <span class="k">for</span> <span class="n">cellIn</span> <span class="ow">in</span> <span class="n">arrayCell</span><span class="p">:</span>
</span><span id="Lattice-1067"><a href="#Lattice-1067"><span class="linenos">1067</span></a>                <span class="n">cellInBoundaryBox</span> <span class="o">=</span> <span class="n">cellIn</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="Lattice-1068"><a href="#Lattice-1068"><span class="linenos">1068</span></a>                <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
</span><span id="Lattice-1069"><a href="#Lattice-1069"><span class="linenos">1069</span></a>                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cellInBoundaryBox</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Lattice-1070"><a href="#Lattice-1070"><span class="linenos">1070</span></a>                <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
</span><span id="Lattice-1071"><a href="#Lattice-1071"><span class="linenos">1071</span></a>                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cellInBoundaryBox</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
</span><span id="Lattice-1072"><a href="#Lattice-1072"><span class="linenos">1072</span></a>                <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
</span><span id="Lattice-1073"><a href="#Lattice-1073"><span class="linenos">1073</span></a>                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cellInBoundaryBox</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
</span><span id="Lattice-1074"><a href="#Lattice-1074"><span class="linenos">1074</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-1075"><a href="#Lattice-1075"><span class="linenos">1075</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be &#39;x&#39;, &#39;y&#39;, or &#39;z&#39;&quot;</span><span class="p">)</span>
</span><span id="Lattice-1076"><a href="#Lattice-1076"><span class="linenos">1076</span></a>
</span><span id="Lattice-1077"><a href="#Lattice-1077"><span class="linenos">1077</span></a>                <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_val</span><span class="p">:</span>
</span><span id="Lattice-1078"><a href="#Lattice-1078"><span class="linenos">1078</span></a>                    <span class="n">min_val</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Lattice-1079"><a href="#Lattice-1079"><span class="linenos">1079</span></a>                <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_val</span><span class="p">:</span>
</span><span id="Lattice-1080"><a href="#Lattice-1080"><span class="linenos">1080</span></a>                    <span class="n">max_val</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Lattice-1081"><a href="#Lattice-1081"><span class="linenos">1081</span></a>
</span><span id="Lattice-1082"><a href="#Lattice-1082"><span class="linenos">1082</span></a>            <span class="n">bbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_val</span><span class="p">)</span>
</span><span id="Lattice-1083"><a href="#Lattice-1083"><span class="linenos">1083</span></a>            <span class="n">bbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_val</span><span class="p">)</span>
</span><span id="Lattice-1084"><a href="#Lattice-1084"><span class="linenos">1084</span></a>
</span><span id="Lattice-1085"><a href="#Lattice-1085"><span class="linenos">1085</span></a>        <span class="k">return</span> <span class="n">bbox</span>
</span><span id="Lattice-1086"><a href="#Lattice-1086"><span class="linenos">1086</span></a>
</span><span id="Lattice-1087"><a href="#Lattice-1087"><span class="linenos">1087</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1088"><a href="#Lattice-1088"><span class="linenos">1088</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1089"><a href="#Lattice-1089"><span class="linenos">1089</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_name_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Lattice-1090"><a href="#Lattice-1090"><span class="linenos">1090</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1091"><a href="#Lattice-1091"><span class="linenos">1091</span></a><span class="sd">        Determine the name_lattice of the lattice</span>
</span><span id="Lattice-1092"><a href="#Lattice-1092"><span class="linenos">1092</span></a><span class="sd">        WARNING: not updated</span>
</span><span id="Lattice-1093"><a href="#Lattice-1093"><span class="linenos">1093</span></a>
</span><span id="Lattice-1094"><a href="#Lattice-1094"><span class="linenos">1094</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice-1095"><a href="#Lattice-1095"><span class="linenos">1095</span></a><span class="sd">        ---------</span>
</span><span id="Lattice-1096"><a href="#Lattice-1096"><span class="linenos">1096</span></a><span class="sd">        name_lattice: string</span>
</span><span id="Lattice-1097"><a href="#Lattice-1097"><span class="linenos">1097</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1098"><a href="#Lattice-1098"><span class="linenos">1098</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Lattice-1099"><a href="#Lattice-1099"><span class="linenos">1099</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Lattice-1100"><a href="#Lattice-1100"><span class="linenos">1100</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-1101"><a href="#Lattice-1101"><span class="linenos">1101</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">=</span> <span class="s2">&quot;Hybrid_&quot;</span>
</span><span id="Lattice-1102"><a href="#Lattice-1102"><span class="linenos">1102</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">geom_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">):</span>
</span><span id="Lattice-1103"><a href="#Lattice-1103"><span class="linenos">1103</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">+=</span> <span class="n">geom_type</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="Lattice-1104"><a href="#Lattice-1104"><span class="linenos">1104</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_simulation_properties</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Lattice-1105"><a href="#Lattice-1105"><span class="linenos">1105</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">+=</span> <span class="s2">&quot;_Mod&quot;</span>
</span><span id="Lattice-1106"><a href="#Lattice-1106"><span class="linenos">1106</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span>
</span><span id="Lattice-1107"><a href="#Lattice-1107"><span class="linenos">1107</span></a>
</span><span id="Lattice-1108"><a href="#Lattice-1108"><span class="linenos">1108</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1109"><a href="#Lattice-1109"><span class="linenos">1109</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1110"><a href="#Lattice-1110"><span class="linenos">1110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_hybrid_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-1111"><a href="#Lattice-1111"><span class="linenos">1111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1112"><a href="#Lattice-1112"><span class="linenos">1112</span></a><span class="sd">        Check if beam in hybrid configuration is cut by a point in the geometry</span>
</span><span id="Lattice-1113"><a href="#Lattice-1113"><span class="linenos">1113</span></a><span class="sd">        Change the beam configuration of collisionned beams</span>
</span><span id="Lattice-1114"><a href="#Lattice-1114"><span class="linenos">1114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1115"><a href="#Lattice-1115"><span class="linenos">1115</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-1116"><a href="#Lattice-1116"><span class="linenos">1116</span></a>            <span class="k">return</span>
</span><span id="Lattice-1117"><a href="#Lattice-1117"><span class="linenos">1117</span></a>
</span><span id="Lattice-1118"><a href="#Lattice-1118"><span class="linenos">1118</span></a>        <span class="n">beams_to_remove_global</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1119"><a href="#Lattice-1119"><span class="linenos">1119</span></a>        <span class="n">beams_to_add_global</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1120"><a href="#Lattice-1120"><span class="linenos">1120</span></a>
</span><span id="Lattice-1121"><a href="#Lattice-1121"><span class="linenos">1121</span></a>        <span class="c1"># Per‚Äìcell containers for in-place updates</span>
</span><span id="Lattice-1122"><a href="#Lattice-1122"><span class="linenos">1122</span></a>        <span class="n">per_cell_rem</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
</span><span id="Lattice-1123"><a href="#Lattice-1123"><span class="linenos">1123</span></a>        <span class="n">per_cell_add</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
</span><span id="Lattice-1124"><a href="#Lattice-1124"><span class="linenos">1124</span></a>        <span class="n">per_cell_pts</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
</span><span id="Lattice-1125"><a href="#Lattice-1125"><span class="linenos">1125</span></a>
</span><span id="Lattice-1126"><a href="#Lattice-1126"><span class="linenos">1126</span></a>        <span class="c1"># Helper: quick AABB inclusion (with small tolerance)</span>
</span><span id="Lattice-1127"><a href="#Lattice-1127"><span class="linenos">1127</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_in_aabb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aabb</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
</span><span id="Lattice-1128"><a href="#Lattice-1128"><span class="linenos">1128</span></a>            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">aabb</span>
</span><span id="Lattice-1129"><a href="#Lattice-1129"><span class="linenos">1129</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">tol</span> <span class="ow">and</span>
</span><span id="Lattice-1130"><a href="#Lattice-1130"><span class="linenos">1130</span></a>                    <span class="n">ymin</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">tol</span> <span class="ow">and</span>
</span><span id="Lattice-1131"><a href="#Lattice-1131"><span class="linenos">1131</span></a>                    <span class="n">zmin</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">zmax</span> <span class="o">+</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="Lattice-1132"><a href="#Lattice-1132"><span class="linenos">1132</span></a>
</span><span id="Lattice-1133"><a href="#Lattice-1133"><span class="linenos">1133</span></a>        <span class="c1"># Build a lightweight per-cell point list (deterministic order)</span>
</span><span id="Lattice-1134"><a href="#Lattice-1134"><span class="linenos">1134</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_sorted_pts</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="Lattice-1135"><a href="#Lattice-1135"><span class="linenos">1135</span></a>            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">,</span>
</span><span id="Lattice-1136"><a href="#Lattice-1136"><span class="linenos">1136</span></a>                          <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">nd</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">nd</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">nd</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</span><span id="Lattice-1137"><a href="#Lattice-1137"><span class="linenos">1137</span></a>
</span><span id="Lattice-1138"><a href="#Lattice-1138"><span class="linenos">1138</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-1139"><a href="#Lattice-1139"><span class="linenos">1139</span></a>            <span class="c1"># Candidates are only points from this cell</span>
</span><span id="Lattice-1140"><a href="#Lattice-1140"><span class="linenos">1140</span></a>            <span class="n">cell_points</span> <span class="o">=</span> <span class="n">_sorted_pts</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="Lattice-1141"><a href="#Lattice-1141"><span class="linenos">1141</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_points</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Lattice-1142"><a href="#Lattice-1142"><span class="linenos">1142</span></a>                <span class="k">continue</span>
</span><span id="Lattice-1143"><a href="#Lattice-1143"><span class="linenos">1143</span></a>
</span><span id="Lattice-1144"><a href="#Lattice-1144"><span class="linenos">1144</span></a>            <span class="c1"># Process each beam of the cell, but only if this cell is the primary owner</span>
</span><span id="Lattice-1145"><a href="#Lattice-1145"><span class="linenos">1145</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">):</span>
</span><span id="Lattice-1146"><a href="#Lattice-1146"><span class="linenos">1146</span></a>                <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice-1147"><a href="#Lattice-1147"><span class="linenos">1147</span></a>                <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
</span><span id="Lattice-1148"><a href="#Lattice-1148"><span class="linenos">1148</span></a>                <span class="n">L2</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">*</span> <span class="n">vx</span> <span class="o">+</span> <span class="n">vy</span> <span class="o">*</span> <span class="n">vy</span> <span class="o">+</span> <span class="n">vz</span> <span class="o">*</span> <span class="n">vz</span>
</span><span id="Lattice-1149"><a href="#Lattice-1149"><span class="linenos">1149</span></a>                <span class="k">if</span> <span class="n">L2</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice-1150"><a href="#Lattice-1150"><span class="linenos">1150</span></a>                    <span class="k">continue</span>
</span><span id="Lattice-1151"><a href="#Lattice-1151"><span class="linenos">1151</span></a>
</span><span id="Lattice-1152"><a href="#Lattice-1152"><span class="linenos">1152</span></a>                <span class="c1"># Tight AABB to skip most points quickly</span>
</span><span id="Lattice-1153"><a href="#Lattice-1153"><span class="linenos">1153</span></a>                <span class="n">aabb</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
</span><span id="Lattice-1154"><a href="#Lattice-1154"><span class="linenos">1154</span></a>                        <span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
</span><span id="Lattice-1155"><a href="#Lattice-1155"><span class="linenos">1155</span></a>                        <span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
</span><span id="Lattice-1156"><a href="#Lattice-1156"><span class="linenos">1156</span></a>
</span><span id="Lattice-1157"><a href="#Lattice-1157"><span class="linenos">1157</span></a>                <span class="n">internal</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-1158"><a href="#Lattice-1158"><span class="linenos">1158</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cell_points</span><span class="p">:</span>
</span><span id="Lattice-1159"><a href="#Lattice-1159"><span class="linenos">1159</span></a>                    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">p1</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">p2</span><span class="p">:</span>
</span><span id="Lattice-1160"><a href="#Lattice-1160"><span class="linenos">1160</span></a>                        <span class="k">continue</span>
</span><span id="Lattice-1161"><a href="#Lattice-1161"><span class="linenos">1161</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_in_aabb</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">aabb</span><span class="p">):</span>
</span><span id="Lattice-1162"><a href="#Lattice-1162"><span class="linenos">1162</span></a>                        <span class="k">continue</span>
</span><span id="Lattice-1163"><a href="#Lattice-1163"><span class="linenos">1163</span></a>                    <span class="c1"># exact geometric test</span>
</span><span id="Lattice-1164"><a href="#Lattice-1164"><span class="linenos">1164</span></a>                    <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">is_point_on_beam</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Lattice-1165"><a href="#Lattice-1165"><span class="linenos">1165</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="p">((</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">vx</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">vy</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">vz</span><span class="p">)</span> <span class="o">/</span> <span class="n">L2</span>
</span><span id="Lattice-1166"><a href="#Lattice-1166"><span class="linenos">1166</span></a>                        <span class="k">if</span> <span class="mf">1e-12</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-12</span><span class="p">:</span>
</span><span id="Lattice-1167"><a href="#Lattice-1167"><span class="linenos">1167</span></a>                            <span class="n">internal</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="Lattice-1168"><a href="#Lattice-1168"><span class="linenos">1168</span></a>
</span><span id="Lattice-1169"><a href="#Lattice-1169"><span class="linenos">1169</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">internal</span><span class="p">:</span>
</span><span id="Lattice-1170"><a href="#Lattice-1170"><span class="linenos">1170</span></a>                    <span class="k">continue</span>
</span><span id="Lattice-1171"><a href="#Lattice-1171"><span class="linenos">1171</span></a>
</span><span id="Lattice-1172"><a href="#Lattice-1172"><span class="linenos">1172</span></a>                <span class="n">internal</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tn</span><span class="p">:</span> <span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Lattice-1173"><a href="#Lattice-1173"><span class="linenos">1173</span></a>                <span class="n">chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">internal</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">p2</span><span class="p">]</span>
</span><span id="Lattice-1174"><a href="#Lattice-1174"><span class="linenos">1174</span></a>
</span><span id="Lattice-1175"><a href="#Lattice-1175"><span class="linenos">1175</span></a>                <span class="c1"># Create split segments; keep all owners if provided, else just this cell</span>
</span><span id="Lattice-1176"><a href="#Lattice-1176"><span class="linenos">1176</span></a>                <span class="n">seg_owners</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Lattice-1177"><a href="#Lattice-1177"><span class="linenos">1177</span></a>                <span class="n">new_segments</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-1178"><a href="#Lattice-1178"><span class="linenos">1178</span></a>                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chain</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">chain</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="Lattice-1179"><a href="#Lattice-1179"><span class="linenos">1179</span></a>                    <span class="n">nb</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">,</span> <span class="n">seg_owners</span><span class="p">)</span>
</span><span id="Lattice-1180"><a href="#Lattice-1180"><span class="linenos">1180</span></a>                    <span class="n">new_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="Lattice-1181"><a href="#Lattice-1181"><span class="linenos">1181</span></a>
</span><span id="Lattice-1182"><a href="#Lattice-1182"><span class="linenos">1182</span></a>                <span class="c1"># Mark removals/additions per owner cell</span>
</span><span id="Lattice-1183"><a href="#Lattice-1183"><span class="linenos">1183</span></a>                <span class="n">beams_to_remove_global</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="Lattice-1184"><a href="#Lattice-1184"><span class="linenos">1184</span></a>                <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">seg_owners</span><span class="p">:</span>
</span><span id="Lattice-1185"><a href="#Lattice-1185"><span class="linenos">1185</span></a>                    <span class="n">per_cell_rem</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="Lattice-1186"><a href="#Lattice-1186"><span class="linenos">1186</span></a>                    <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">new_segments</span><span class="p">:</span>
</span><span id="Lattice-1187"><a href="#Lattice-1187"><span class="linenos">1187</span></a>                        <span class="n">per_cell_add</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="Lattice-1188"><a href="#Lattice-1188"><span class="linenos">1188</span></a>                        <span class="n">per_cell_pts</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">point1</span><span class="p">)</span>
</span><span id="Lattice-1189"><a href="#Lattice-1189"><span class="linenos">1189</span></a>                        <span class="n">per_cell_pts</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">point2</span><span class="p">)</span>
</span><span id="Lattice-1190"><a href="#Lattice-1190"><span class="linenos">1190</span></a>                <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">new_segments</span><span class="p">:</span>
</span><span id="Lattice-1191"><a href="#Lattice-1191"><span class="linenos">1191</span></a>                    <span class="n">beams_to_add_global</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="Lattice-1192"><a href="#Lattice-1192"><span class="linenos">1192</span></a>
</span><span id="Lattice-1193"><a href="#Lattice-1193"><span class="linenos">1193</span></a>        <span class="c1"># Apply per-cell edits</span>
</span><span id="Lattice-1194"><a href="#Lattice-1194"><span class="linenos">1194</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-1195"><a href="#Lattice-1195"><span class="linenos">1195</span></a>            <span class="n">rem</span> <span class="o">=</span> <span class="n">per_cell_rem</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="Lattice-1196"><a href="#Lattice-1196"><span class="linenos">1196</span></a>            <span class="n">add</span> <span class="o">=</span> <span class="n">per_cell_add</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="Lattice-1197"><a href="#Lattice-1197"><span class="linenos">1197</span></a>            <span class="n">pts</span> <span class="o">=</span> <span class="n">per_cell_pts</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="Lattice-1198"><a href="#Lattice-1198"><span class="linenos">1198</span></a>            <span class="k">if</span> <span class="n">rem</span><span class="p">:</span>
</span><span id="Lattice-1199"><a href="#Lattice-1199"><span class="linenos">1199</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">remove_beam</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
</span><span id="Lattice-1200"><a href="#Lattice-1200"><span class="linenos">1200</span></a>            <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
</span><span id="Lattice-1201"><a href="#Lattice-1201"><span class="linenos">1201</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">add_beam</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
</span><span id="Lattice-1202"><a href="#Lattice-1202"><span class="linenos">1202</span></a>            <span class="k">if</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="Lattice-1203"><a href="#Lattice-1203"><span class="linenos">1203</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">add_point</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pts</span><span class="p">))</span>
</span><span id="Lattice-1204"><a href="#Lattice-1204"><span class="linenos">1204</span></a>
</span><span id="Lattice-1205"><a href="#Lattice-1205"><span class="linenos">1205</span></a>        <span class="c1"># Update global sets</span>
</span><span id="Lattice-1206"><a href="#Lattice-1206"><span class="linenos">1206</span></a>        <span class="k">if</span> <span class="n">beams_to_remove_global</span><span class="p">:</span>
</span><span id="Lattice-1207"><a href="#Lattice-1207"><span class="linenos">1207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">beams_to_remove_global</span><span class="p">)</span>
</span><span id="Lattice-1208"><a href="#Lattice-1208"><span class="linenos">1208</span></a>        <span class="k">if</span> <span class="n">beams_to_add_global</span><span class="p">:</span>
</span><span id="Lattice-1209"><a href="#Lattice-1209"><span class="linenos">1209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beams_to_add_global</span><span class="p">)</span>
</span><span id="Lattice-1210"><a href="#Lattice-1210"><span class="linenos">1210</span></a>
</span><span id="Lattice-1211"><a href="#Lattice-1211"><span class="linenos">1211</span></a>        <span class="c1"># Refresh indices/connectivity once</span>
</span><span id="Lattice-1212"><a href="#Lattice-1212"><span class="linenos">1212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice-1213"><a href="#Lattice-1213"><span class="linenos">1213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice-1214"><a href="#Lattice-1214"><span class="linenos">1214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="Lattice-1215"><a href="#Lattice-1215"><span class="linenos">1215</span></a>
</span><span id="Lattice-1216"><a href="#Lattice-1216"><span class="linenos">1216</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1217"><a href="#Lattice-1217"><span class="linenos">1217</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1218"><a href="#Lattice-1218"><span class="linenos">1218</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">are_cells_identical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Lattice-1219"><a href="#Lattice-1219"><span class="linenos">1219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1220"><a href="#Lattice-1220"><span class="linenos">1220</span></a><span class="sd">        Check if all cells in the lattice are identical.</span>
</span><span id="Lattice-1221"><a href="#Lattice-1221"><span class="linenos">1221</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1222"><a href="#Lattice-1222"><span class="linenos">1222</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-1223"><a href="#Lattice-1223"><span class="linenos">1223</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s2">&quot;Only one or no cell: considered identical.&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Lattice-1224"><a href="#Lattice-1224"><span class="linenos">1224</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Lattice-1225"><a href="#Lattice-1225"><span class="linenos">1225</span></a>
</span><span id="Lattice-1226"><a href="#Lattice-1226"><span class="linenos">1226</span></a>        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Lattice-1227"><a href="#Lattice-1227"><span class="linenos">1227</span></a>
</span><span id="Lattice-1228"><a href="#Lattice-1228"><span class="linenos">1228</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span id="Lattice-1229"><a href="#Lattice-1229"><span class="linenos">1229</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice-1230"><a href="#Lattice-1230"><span class="linenos">1230</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Lattice-1231"><a href="#Lattice-1231"><span class="linenos">1231</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Lattice-1232"><a href="#Lattice-1232"><span class="linenos">1232</span></a>                <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>
</span><span id="Lattice-1233"><a href="#Lattice-1233"><span class="linenos">1233</span></a>
</span><span id="Lattice-1234"><a href="#Lattice-1234"><span class="linenos">1234</span></a>        <span class="n">attrs_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;geom_types&quot;</span><span class="p">,</span> <span class="s2">&quot;radii&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;grad_radius&quot;</span><span class="p">,</span> <span class="s2">&quot;grad_dim&quot;</span><span class="p">]</span>
</span><span id="Lattice-1235"><a href="#Lattice-1235"><span class="linenos">1235</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Lattice-1236"><a href="#Lattice-1236"><span class="linenos">1236</span></a>            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_check</span><span class="p">:</span>
</span><span id="Lattice-1237"><a href="#Lattice-1237"><span class="linenos">1237</span></a>                <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span id="Lattice-1238"><a href="#Lattice-1238"><span class="linenos">1238</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">_allclose</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
</span><span id="Lattice-1239"><a href="#Lattice-1239"><span class="linenos">1239</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="Lattice-1240"><a href="#Lattice-1240"><span class="linenos">1240</span></a>                        <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Difference found in attribute &#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&#39; between cell 0 and cell </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Lattice-1241"><a href="#Lattice-1241"><span class="linenos">1241</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice-1242"><a href="#Lattice-1242"><span class="linenos">1242</span></a>
</span><span id="Lattice-1243"><a href="#Lattice-1243"><span class="linenos">1243</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_pt_local_key</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="Lattice-1244"><a href="#Lattice-1244"><span class="linenos">1244</span></a>            <span class="k">return</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nd</span><span class="p">),</span>
</span><span id="Lattice-1245"><a href="#Lattice-1245"><span class="linenos">1245</span></a>                    <span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nd</span><span class="p">),</span>
</span><span id="Lattice-1246"><a href="#Lattice-1246"><span class="linenos">1246</span></a>                    <span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nd</span><span class="p">))</span>
</span><span id="Lattice-1247"><a href="#Lattice-1247"><span class="linenos">1247</span></a>
</span><span id="Lattice-1248"><a href="#Lattice-1248"><span class="linenos">1248</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_beam_key</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ndp</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ndr</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="Lattice-1249"><a href="#Lattice-1249"><span class="linenos">1249</span></a>            <span class="n">e1</span> <span class="o">=</span> <span class="n">_pt_local_key</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="n">ndp</span><span class="p">)</span>
</span><span id="Lattice-1250"><a href="#Lattice-1250"><span class="linenos">1250</span></a>            <span class="n">e2</span> <span class="o">=</span> <span class="n">_pt_local_key</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="n">ndp</span><span class="p">)</span>
</span><span id="Lattice-1251"><a href="#Lattice-1251"><span class="linenos">1251</span></a>            <span class="n">ends</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)))</span>  <span class="c1"># order-independent</span>
</span><span id="Lattice-1252"><a href="#Lattice-1252"><span class="linenos">1252</span></a>            <span class="k">return</span> <span class="n">ends</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">radius</span><span class="p">),</span> <span class="n">ndr</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">material</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">type_beam</span><span class="p">)</span>
</span><span id="Lattice-1253"><a href="#Lattice-1253"><span class="linenos">1253</span></a>
</span><span id="Lattice-1254"><a href="#Lattice-1254"><span class="linenos">1254</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_beam_multiset</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
</span><span id="Lattice-1255"><a href="#Lattice-1255"><span class="linenos">1255</span></a>            <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span><span class="n">_beam_key</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="Lattice-1256"><a href="#Lattice-1256"><span class="linenos">1256</span></a>
</span><span id="Lattice-1257"><a href="#Lattice-1257"><span class="linenos">1257</span></a>        <span class="n">ref_ms</span> <span class="o">=</span> <span class="n">_beam_multiset</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
</span><span id="Lattice-1258"><a href="#Lattice-1258"><span class="linenos">1258</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Lattice-1259"><a href="#Lattice-1259"><span class="linenos">1259</span></a>            <span class="k">if</span> <span class="n">ref_ms</span> <span class="o">!=</span> <span class="n">_beam_multiset</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span id="Lattice-1260"><a href="#Lattice-1260"><span class="linenos">1260</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Beam topology/parameters differ between cell 0 and cell </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Lattice-1261"><a href="#Lattice-1261"><span class="linenos">1261</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice-1262"><a href="#Lattice-1262"><span class="linenos">1262</span></a>
</span><span id="Lattice-1263"><a href="#Lattice-1263"><span class="linenos">1263</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-1264"><a href="#Lattice-1264"><span class="linenos">1264</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s2">&quot;All cells are identical.&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Lattice-1265"><a href="#Lattice-1265"><span class="linenos">1265</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="Lattice-1266"><a href="#Lattice-1266"><span class="linenos">1266</span></a>
</span><span id="Lattice-1267"><a href="#Lattice-1267"><span class="linenos">1267</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-1268"><a href="#Lattice-1268"><span class="linenos">1268</span></a><span class="c1"># SECTION: Optimization Methods</span>
</span><span id="Lattice-1269"><a href="#Lattice-1269"><span class="linenos">1269</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-1270"><a href="#Lattice-1270"><span class="linenos">1270</span></a>
</span><span id="Lattice-1271"><a href="#Lattice-1271"><span class="linenos">1271</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Lattice-1272"><a href="#Lattice-1272"><span class="linenos">1272</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1273"><a href="#Lattice-1273"><span class="linenos">1273</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">change_beam_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-1274"><a href="#Lattice-1274"><span class="linenos">1274</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1275"><a href="#Lattice-1275"><span class="linenos">1275</span></a><span class="sd">        Change beam radius for all beams in the lattice</span>
</span><span id="Lattice-1276"><a href="#Lattice-1276"><span class="linenos">1276</span></a><span class="sd">        radius_list must have the same length as the number of different beam types in cells</span>
</span><span id="Lattice-1277"><a href="#Lattice-1277"><span class="linenos">1277</span></a>
</span><span id="Lattice-1278"><a href="#Lattice-1278"><span class="linenos">1278</span></a><span class="sd">        Take care if penalization is activated, the radius of penalized beams will be modified with the</span>
</span><span id="Lattice-1279"><a href="#Lattice-1279"><span class="linenos">1279</span></a><span class="sd">        penalization coefficient but the length of the modified beam will not be changed</span>
</span><span id="Lattice-1280"><a href="#Lattice-1280"><span class="linenos">1280</span></a><span class="sd">        (Use reset_cell_with_new_radii instead if you want to have clean cells for simulation)</span>
</span><span id="Lattice-1281"><a href="#Lattice-1281"><span class="linenos">1281</span></a>
</span><span id="Lattice-1282"><a href="#Lattice-1282"><span class="linenos">1282</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-1283"><a href="#Lattice-1283"><span class="linenos">1283</span></a><span class="sd">        ------------</span>
</span><span id="Lattice-1284"><a href="#Lattice-1284"><span class="linenos">1284</span></a><span class="sd">        radius_list: list of float</span>
</span><span id="Lattice-1285"><a href="#Lattice-1285"><span class="linenos">1285</span></a><span class="sd">            List of new radii for each beam type</span>
</span><span id="Lattice-1286"><a href="#Lattice-1286"><span class="linenos">1286</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1287"><a href="#Lattice-1287"><span class="linenos">1287</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Lattice-1288"><a href="#Lattice-1288"><span class="linenos">1288</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid hybrid radii data.&quot;</span><span class="p">)</span>
</span><span id="Lattice-1289"><a href="#Lattice-1289"><span class="linenos">1289</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice-1290"><a href="#Lattice-1290"><span class="linenos">1290</span></a>            <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span><span class="p">:</span>
</span><span id="Lattice-1291"><a href="#Lattice-1291"><span class="linenos">1291</span></a>                <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius_list</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">]</span> <span class="o">*</span> <span class="n">beam</span><span class="o">.</span><span class="n">penalization_coefficient</span>
</span><span id="Lattice-1292"><a href="#Lattice-1292"><span class="linenos">1292</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-1293"><a href="#Lattice-1293"><span class="linenos">1293</span></a>                <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius_list</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">]</span>
</span><span id="Lattice-1294"><a href="#Lattice-1294"><span class="linenos">1294</span></a>
</span><span id="Lattice-1295"><a href="#Lattice-1295"><span class="linenos">1295</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Lattice-1296"><a href="#Lattice-1296"><span class="linenos">1296</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1297"><a href="#Lattice-1297"><span class="linenos">1297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">change_beam_radius_depending_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeToChange</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">newRadius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-1298"><a href="#Lattice-1298"><span class="linenos">1298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1299"><a href="#Lattice-1299"><span class="linenos">1299</span></a><span class="sd">        Change radii of beam for specific type_beam</span>
</span><span id="Lattice-1300"><a href="#Lattice-1300"><span class="linenos">1300</span></a>
</span><span id="Lattice-1301"><a href="#Lattice-1301"><span class="linenos">1301</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-1302"><a href="#Lattice-1302"><span class="linenos">1302</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-1303"><a href="#Lattice-1303"><span class="linenos">1303</span></a><span class="sd">        typeToChange: int</span>
</span><span id="Lattice-1304"><a href="#Lattice-1304"><span class="linenos">1304</span></a><span class="sd">            Type of beam to change</span>
</span><span id="Lattice-1305"><a href="#Lattice-1305"><span class="linenos">1305</span></a><span class="sd">        newRadius: float</span>
</span><span id="Lattice-1306"><a href="#Lattice-1306"><span class="linenos">1306</span></a><span class="sd">            New radii of beam</span>
</span><span id="Lattice-1307"><a href="#Lattice-1307"><span class="linenos">1307</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1308"><a href="#Lattice-1308"><span class="linenos">1308</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-1309"><a href="#Lattice-1309"><span class="linenos">1309</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Lattice-1310"><a href="#Lattice-1310"><span class="linenos">1310</span></a>                <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="n">typeToChange</span><span class="p">:</span>
</span><span id="Lattice-1311"><a href="#Lattice-1311"><span class="linenos">1311</span></a>                    <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">newRadius</span>
</span><span id="Lattice-1312"><a href="#Lattice-1312"><span class="linenos">1312</span></a>
</span><span id="Lattice-1313"><a href="#Lattice-1313"><span class="linenos">1313</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-1314"><a href="#Lattice-1314"><span class="linenos">1314</span></a><span class="c1"># SECTION: Utils Methods</span>
</span><span id="Lattice-1315"><a href="#Lattice-1315"><span class="linenos">1315</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-1316"><a href="#Lattice-1316"><span class="linenos">1316</span></a>
</span><span id="Lattice-1317"><a href="#Lattice-1317"><span class="linenos">1317</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1318"><a href="#Lattice-1318"><span class="linenos">1318</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1319"><a href="#Lattice-1319"><span class="linenos">1319</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_point_on_lattice_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfaceNames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">surface_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">]:</span>
</span><span id="Lattice-1320"><a href="#Lattice-1320"><span class="linenos">1320</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1321"><a href="#Lattice-1321"><span class="linenos">1321</span></a><span class="sd">        Find points on the surface of the lattice</span>
</span><span id="Lattice-1322"><a href="#Lattice-1322"><span class="linenos">1322</span></a>
</span><span id="Lattice-1323"><a href="#Lattice-1323"><span class="linenos">1323</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-1324"><a href="#Lattice-1324"><span class="linenos">1324</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-1325"><a href="#Lattice-1325"><span class="linenos">1325</span></a><span class="sd">        surfaceNames: list[str]</span>
</span><span id="Lattice-1326"><a href="#Lattice-1326"><span class="linenos">1326</span></a><span class="sd">            List of surfaces to find points on (e.g., [&quot;Xmin&quot;, &quot;Xmax&quot;, &quot;Ymin&quot;])</span>
</span><span id="Lattice-1327"><a href="#Lattice-1327"><span class="linenos">1327</span></a>
</span><span id="Lattice-1328"><a href="#Lattice-1328"><span class="linenos">1328</span></a><span class="sd">        surface_cells: list[str], optional</span>
</span><span id="Lattice-1329"><a href="#Lattice-1329"><span class="linenos">1329</span></a><span class="sd">            List of surfaces to find points on cells (e.g., [&quot;Xmin&quot;, &quot;Xmax&quot;, &quot;Ymin&quot;]). If None, use surfaceNames.</span>
</span><span id="Lattice-1330"><a href="#Lattice-1330"><span class="linenos">1330</span></a>
</span><span id="Lattice-1331"><a href="#Lattice-1331"><span class="linenos">1331</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice-1332"><a href="#Lattice-1332"><span class="linenos">1332</span></a><span class="sd">        --------</span>
</span><span id="Lattice-1333"><a href="#Lattice-1333"><span class="linenos">1333</span></a><span class="sd">        pointSet: set of point objects</span>
</span><span id="Lattice-1334"><a href="#Lattice-1334"><span class="linenos">1334</span></a><span class="sd">            Set of points found on the specified surfaces</span>
</span><span id="Lattice-1335"><a href="#Lattice-1335"><span class="linenos">1335</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1336"><a href="#Lattice-1336"><span class="linenos">1336</span></a>        <span class="n">valid_surfaces</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmid&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymid&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmid&quot;</span><span class="p">}</span>
</span><span id="Lattice-1337"><a href="#Lattice-1337"><span class="linenos">1337</span></a>
</span><span id="Lattice-1338"><a href="#Lattice-1338"><span class="linenos">1338</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">surface</span> <span class="ow">in</span> <span class="n">valid_surfaces</span> <span class="k">for</span> <span class="n">surface</span> <span class="ow">in</span> <span class="n">surfaceNames</span><span class="p">):</span>
</span><span id="Lattice-1339"><a href="#Lattice-1339"><span class="linenos">1339</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid surface name_lattice(s).&quot;</span><span class="p">)</span>
</span><span id="Lattice-1340"><a href="#Lattice-1340"><span class="linenos">1340</span></a>
</span><span id="Lattice-1341"><a href="#Lattice-1341"><span class="linenos">1341</span></a>        <span class="n">cell_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cells_on_surfaces</span><span class="p">(</span><span class="n">surfaceNames</span><span class="p">)</span>
</span><span id="Lattice-1342"><a href="#Lattice-1342"><span class="linenos">1342</span></a>        <span class="n">cell_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cell_list</span><span class="p">}</span>
</span><span id="Lattice-1343"><a href="#Lattice-1343"><span class="linenos">1343</span></a>
</span><span id="Lattice-1344"><a href="#Lattice-1344"><span class="linenos">1344</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">cell_indices</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Lattice-1345"><a href="#Lattice-1345"><span class="linenos">1345</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid cell index, some cells do not exist.&quot;</span><span class="p">)</span>
</span><span id="Lattice-1346"><a href="#Lattice-1346"><span class="linenos">1346</span></a>
</span><span id="Lattice-1347"><a href="#Lattice-1347"><span class="linenos">1347</span></a>        <span class="n">surface_on_cells</span> <span class="o">=</span> <span class="n">surface_cells</span> <span class="k">if</span> <span class="n">surface_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">surfaceNames</span>
</span><span id="Lattice-1348"><a href="#Lattice-1348"><span class="linenos">1348</span></a>        <span class="n">pointSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1349"><a href="#Lattice-1349"><span class="linenos">1349</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-1350"><a href="#Lattice-1350"><span class="linenos">1350</span></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">cell_indices</span><span class="p">:</span>
</span><span id="Lattice-1351"><a href="#Lattice-1351"><span class="linenos">1351</span></a>                <span class="n">cellPointSets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get_point_on_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">))</span> <span class="k">for</span> <span class="n">surface</span> <span class="ow">in</span> <span class="n">surface_on_cells</span><span class="p">]</span>
</span><span id="Lattice-1352"><a href="#Lattice-1352"><span class="linenos">1352</span></a>                <span class="k">if</span> <span class="n">cellPointSets</span><span class="p">:</span>
</span><span id="Lattice-1353"><a href="#Lattice-1353"><span class="linenos">1353</span></a>                    <span class="n">pointSet</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">cellPointSets</span><span class="p">))</span>
</span><span id="Lattice-1354"><a href="#Lattice-1354"><span class="linenos">1354</span></a>
</span><span id="Lattice-1355"><a href="#Lattice-1355"><span class="linenos">1355</span></a>        <span class="k">if</span> <span class="n">pointSet</span> <span class="o">==</span> <span class="nb">set</span><span class="p">():</span>
</span><span id="Lattice-1356"><a href="#Lattice-1356"><span class="linenos">1356</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No points found on the specified surfaces.&quot;</span><span class="p">)</span>
</span><span id="Lattice-1357"><a href="#Lattice-1357"><span class="linenos">1357</span></a>
</span><span id="Lattice-1358"><a href="#Lattice-1358"><span class="linenos">1358</span></a>        <span class="k">return</span> <span class="n">pointSet</span>
</span><span id="Lattice-1359"><a href="#Lattice-1359"><span class="linenos">1359</span></a>
</span><span id="Lattice-1360"><a href="#Lattice-1360"><span class="linenos">1360</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1361"><a href="#Lattice-1361"><span class="linenos">1361</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1362"><a href="#Lattice-1362"><span class="linenos">1362</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cells_on_surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Lattice-1363"><a href="#Lattice-1363"><span class="linenos">1363</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1364"><a href="#Lattice-1364"><span class="linenos">1364</span></a><span class="sd">        Return the list of Cell objects matching ordered extrema constraints like [&quot;Xmin&quot;], [&quot;Xmin&quot;,&quot;Zmax&quot;], etc.</span>
</span><span id="Lattice-1365"><a href="#Lattice-1365"><span class="linenos">1365</span></a><span class="sd">        Filtering is iterative: e.g., first keep all cells at X minimum, then among those keep Z maximum.</span>
</span><span id="Lattice-1366"><a href="#Lattice-1366"><span class="linenos">1366</span></a>
</span><span id="Lattice-1367"><a href="#Lattice-1367"><span class="linenos">1367</span></a><span class="sd">        Parameters</span>
</span><span id="Lattice-1368"><a href="#Lattice-1368"><span class="linenos">1368</span></a><span class="sd">        ----------</span>
</span><span id="Lattice-1369"><a href="#Lattice-1369"><span class="linenos">1369</span></a><span class="sd">        surfaces : list[str]</span>
</span><span id="Lattice-1370"><a href="#Lattice-1370"><span class="linenos">1370</span></a><span class="sd">            Each item is one of {&quot;Xmin&quot;,&quot;Xmax&quot;,&quot;Ymin&quot;,&quot;Ymax&quot;,&quot;Zmin&quot;,&quot;Zmax&quot;} (case-insensitive).</span>
</span><span id="Lattice-1371"><a href="#Lattice-1371"><span class="linenos">1371</span></a>
</span><span id="Lattice-1372"><a href="#Lattice-1372"><span class="linenos">1372</span></a><span class="sd">        Returns</span>
</span><span id="Lattice-1373"><a href="#Lattice-1373"><span class="linenos">1373</span></a><span class="sd">        -------</span>
</span><span id="Lattice-1374"><a href="#Lattice-1374"><span class="linenos">1374</span></a><span class="sd">        list</span>
</span><span id="Lattice-1375"><a href="#Lattice-1375"><span class="linenos">1375</span></a><span class="sd">            List of Cell objects (possibly multiple if several share the same extreme index).</span>
</span><span id="Lattice-1376"><a href="#Lattice-1376"><span class="linenos">1376</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1377"><a href="#Lattice-1377"><span class="linenos">1377</span></a>        <span class="c1"># Ensure occupancy matrix is available</span>
</span><span id="Lattice-1378"><a href="#Lattice-1378"><span class="linenos">1378</span></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;occupancy_matrix&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-1379"><a href="#Lattice-1379"><span class="linenos">1379</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_occupancy_matrix</span><span class="p">()</span>
</span><span id="Lattice-1380"><a href="#Lattice-1380"><span class="linenos">1380</span></a>
</span><span id="Lattice-1381"><a href="#Lattice-1381"><span class="linenos">1381</span></a>        <span class="c1"># Start from all occupied positions (use existing cells to avoid None handling)</span>
</span><span id="Lattice-1382"><a href="#Lattice-1382"><span class="linenos">1382</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">]</span>
</span><span id="Lattice-1383"><a href="#Lattice-1383"><span class="linenos">1383</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="Lattice-1384"><a href="#Lattice-1384"><span class="linenos">1384</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="Lattice-1385"><a href="#Lattice-1385"><span class="linenos">1385</span></a>
</span><span id="Lattice-1386"><a href="#Lattice-1386"><span class="linenos">1386</span></a>        <span class="n">axis_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span id="Lattice-1387"><a href="#Lattice-1387"><span class="linenos">1387</span></a>
</span><span id="Lattice-1388"><a href="#Lattice-1388"><span class="linenos">1388</span></a>        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="p">:</span>
</span><span id="Lattice-1389"><a href="#Lattice-1389"><span class="linenos">1389</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Lattice-1390"><a href="#Lattice-1390"><span class="linenos">1390</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
</span><span id="Lattice-1391"><a href="#Lattice-1391"><span class="linenos">1391</span></a>                <span class="k">continue</span>
</span><span id="Lattice-1392"><a href="#Lattice-1392"><span class="linenos">1392</span></a>            <span class="n">ax_char</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Lattice-1393"><a href="#Lattice-1393"><span class="linenos">1393</span></a>            <span class="k">if</span> <span class="n">ax_char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis_map</span><span class="p">:</span>
</span><span id="Lattice-1394"><a href="#Lattice-1394"><span class="linenos">1394</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid axis in constraint &#39;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&#39;, expected X/Y/Z with min/max.&quot;</span><span class="p">)</span>
</span><span id="Lattice-1395"><a href="#Lattice-1395"><span class="linenos">1395</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis_map</span><span class="p">[</span><span class="n">ax_char</span><span class="p">]</span>
</span><span id="Lattice-1396"><a href="#Lattice-1396"><span class="linenos">1396</span></a>
</span><span id="Lattice-1397"><a href="#Lattice-1397"><span class="linenos">1397</span></a>            <span class="k">if</span> <span class="s2">&quot;min&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
</span><span id="Lattice-1398"><a href="#Lattice-1398"><span class="linenos">1398</span></a>                <span class="n">extreme</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">)</span>
</span><span id="Lattice-1399"><a href="#Lattice-1399"><span class="linenos">1399</span></a>            <span class="k">elif</span> <span class="s2">&quot;max&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
</span><span id="Lattice-1400"><a href="#Lattice-1400"><span class="linenos">1400</span></a>                <span class="n">extreme</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">)</span>
</span><span id="Lattice-1401"><a href="#Lattice-1401"><span class="linenos">1401</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-1402"><a href="#Lattice-1402"><span class="linenos">1402</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid extrema in constraint &#39;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&#39;, expected &#39;min&#39; or &#39;max&#39;.&quot;</span><span class="p">)</span>
</span><span id="Lattice-1403"><a href="#Lattice-1403"><span class="linenos">1403</span></a>
</span><span id="Lattice-1404"><a href="#Lattice-1404"><span class="linenos">1404</span></a>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="o">==</span> <span class="n">extreme</span><span class="p">]</span>
</span><span id="Lattice-1405"><a href="#Lattice-1405"><span class="linenos">1405</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="Lattice-1406"><a href="#Lattice-1406"><span class="linenos">1406</span></a>                <span class="k">return</span> <span class="p">[]</span>
</span><span id="Lattice-1407"><a href="#Lattice-1407"><span class="linenos">1407</span></a>
</span><span id="Lattice-1408"><a href="#Lattice-1408"><span class="linenos">1408</span></a>        <span class="c1"># Map positions back to Cell objects via the occupancy matrix (ignore any None just in case)</span>
</span><span id="Lattice-1409"><a href="#Lattice-1409"><span class="linenos">1409</span></a>        <span class="n">occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span>
</span><span id="Lattice-1410"><a href="#Lattice-1410"><span class="linenos">1410</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">occ</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="n">occ</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice-1411"><a href="#Lattice-1411"><span class="linenos">1411</span></a>
</span><span id="Lattice-1412"><a href="#Lattice-1412"><span class="linenos">1412</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_statistics_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice-1413"><a href="#Lattice-1413"><span class="linenos">1413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1414"><a href="#Lattice-1414"><span class="linenos">1414</span></a><span class="sd">        Print statistics about the lattice</span>
</span><span id="Lattice-1415"><a href="#Lattice-1415"><span class="linenos">1415</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1416"><a href="#Lattice-1416"><span class="linenos">1416</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lattice name: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_name_lattice</span><span class="p">())</span>
</span><span id="Lattice-1417"><a href="#Lattice-1417"><span class="linenos">1417</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of cells: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">))</span>
</span><span id="Lattice-1418"><a href="#Lattice-1418"><span class="linenos">1418</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of beams: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_beams</span><span class="p">())</span>
</span><span id="Lattice-1419"><a href="#Lattice-1419"><span class="linenos">1419</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of nodes: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_nodes</span><span class="p">())</span>
</span><span id="Lattice-1420"><a href="#Lattice-1420"><span class="linenos">1420</span></a>        <span class="n">radMax</span><span class="p">,</span> <span class="n">radMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_beam_radius_min_max</span><span class="p">()</span>
</span><span id="Lattice-1421"><a href="#Lattice-1421"><span class="linenos">1421</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radii max: &quot;</span><span class="p">,</span> <span class="n">radMax</span><span class="p">)</span>
</span><span id="Lattice-1422"><a href="#Lattice-1422"><span class="linenos">1422</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radii min: &quot;</span><span class="p">,</span> <span class="n">radMin</span><span class="p">)</span>
</span><span id="Lattice-1423"><a href="#Lattice-1423"><span class="linenos">1423</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lattice dimensions: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_z</span><span class="p">)</span>
</span><span id="Lattice-1424"><a href="#Lattice-1424"><span class="linenos">1424</span></a>
</span><span id="Lattice-1425"><a href="#Lattice-1425"><span class="linenos">1425</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1426"><a href="#Lattice-1426"><span class="linenos">1426</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1427"><a href="#Lattice-1427"><span class="linenos">1427</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_orphan_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice-1428"><a href="#Lattice-1428"><span class="linenos">1428</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1429"><a href="#Lattice-1429"><span class="linenos">1429</span></a><span class="sd">        Delete points that are not connected to any beam in the lattice.</span>
</span><span id="Lattice-1430"><a href="#Lattice-1430"><span class="linenos">1430</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1431"><a href="#Lattice-1431"><span class="linenos">1431</span></a>        <span class="n">live_points</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1432"><a href="#Lattice-1432"><span class="linenos">1432</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice-1433"><a href="#Lattice-1433"><span class="linenos">1433</span></a>            <span class="n">live_points</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">)</span>
</span><span id="Lattice-1434"><a href="#Lattice-1434"><span class="linenos">1434</span></a>            <span class="n">live_points</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">)</span>
</span><span id="Lattice-1435"><a href="#Lattice-1435"><span class="linenos">1435</span></a>
</span><span id="Lattice-1436"><a href="#Lattice-1436"><span class="linenos">1436</span></a>        <span class="n">all_points</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1437"><a href="#Lattice-1437"><span class="linenos">1437</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice-1438"><a href="#Lattice-1438"><span class="linenos">1438</span></a>            <span class="n">all_points</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="Lattice-1439"><a href="#Lattice-1439"><span class="linenos">1439</span></a>
</span><span id="Lattice-1440"><a href="#Lattice-1440"><span class="linenos">1440</span></a>        <span class="n">orphan_points</span> <span class="o">=</span> <span class="n">all_points</span> <span class="o">-</span> <span class="n">live_points</span>
</span><span id="Lattice-1441"><a href="#Lattice-1441"><span class="linenos">1441</span></a>
</span><span id="Lattice-1442"><a href="#Lattice-1442"><span class="linenos">1442</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">orphan_points</span><span class="p">:</span>
</span><span id="Lattice-1443"><a href="#Lattice-1443"><span class="linenos">1443</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Lattice-1444"><a href="#Lattice-1444"><span class="linenos">1444</span></a>
</span><span id="Lattice-1445"><a href="#Lattice-1445"><span class="linenos">1445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice-1446"><a href="#Lattice-1446"><span class="linenos">1446</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice-1447"><a href="#Lattice-1447"><span class="linenos">1447</span></a>
</span><span id="Lattice-1448"><a href="#Lattice-1448"><span class="linenos">1448</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1449"><a href="#Lattice-1449"><span class="linenos">1449</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1450"><a href="#Lattice-1450"><span class="linenos">1450</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge_degree2_nodes</span><span class="p">(</span>
</span><span id="Lattice-1451"><a href="#Lattice-1451"><span class="linenos">1451</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Lattice-1452"><a href="#Lattice-1452"><span class="linenos">1452</span></a>            <span class="n">colinear_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice-1453"><a href="#Lattice-1453"><span class="linenos">1453</span></a>            <span class="n">radius_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">,</span>  <span class="c1"># &quot;inherit&quot; | &quot;max&quot; | &quot;min&quot; | &quot;avg&quot;</span>
</span><span id="Lattice-1454"><a href="#Lattice-1454"><span class="linenos">1454</span></a>            <span class="n">type_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">,</span>  <span class="c1"># &quot;inherit&quot; -&gt; si diff√©rents, on prend b1</span>
</span><span id="Lattice-1455"><a href="#Lattice-1455"><span class="linenos">1455</span></a>            <span class="n">material_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">,</span>  <span class="c1"># idem</span>
</span><span id="Lattice-1456"><a href="#Lattice-1456"><span class="linenos">1456</span></a>            <span class="n">iterative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice-1457"><a href="#Lattice-1457"><span class="linenos">1457</span></a>            <span class="n">max_passes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Lattice-1458"><a href="#Lattice-1458"><span class="linenos">1458</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Lattice-1459"><a href="#Lattice-1459"><span class="linenos">1459</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1460"><a href="#Lattice-1460"><span class="linenos">1460</span></a><span class="sd">        Fusion of nodes with exactly 2 connected beams.</span>
</span><span id="Lattice-1461"><a href="#Lattice-1461"><span class="linenos">1461</span></a><span class="sd">        The two beams must be colinear (if colinear_only=True) and the node must be between the two beam endpoints.</span>
</span><span id="Lattice-1462"><a href="#Lattice-1462"><span class="linenos">1462</span></a><span class="sd">        The two beams are replaced by a single beam connecting the two distant endpoints.</span>
</span><span id="Lattice-1463"><a href="#Lattice-1463"><span class="linenos">1463</span></a>
</span><span id="Lattice-1464"><a href="#Lattice-1464"><span class="linenos">1464</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-1465"><a href="#Lattice-1465"><span class="linenos">1465</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-1466"><a href="#Lattice-1466"><span class="linenos">1466</span></a><span class="sd">        colinear_only : bool</span>
</span><span id="Lattice-1467"><a href="#Lattice-1467"><span class="linenos">1467</span></a><span class="sd">            If True, only merge if the two beams are colinear.</span>
</span><span id="Lattice-1468"><a href="#Lattice-1468"><span class="linenos">1468</span></a>
</span><span id="Lattice-1469"><a href="#Lattice-1469"><span class="linenos">1469</span></a><span class="sd">        radius_strategy : str</span>
</span><span id="Lattice-1470"><a href="#Lattice-1470"><span class="linenos">1470</span></a><span class="sd">            Strategy for determining the radius of the new beam:</span>
</span><span id="Lattice-1471"><a href="#Lattice-1471"><span class="linenos">1471</span></a><span class="sd">            &quot;inherit&quot; (default) - if both beams have the same radius, use it; otherwise use b1&#39;s radius.</span>
</span><span id="Lattice-1472"><a href="#Lattice-1472"><span class="linenos">1472</span></a><span class="sd">            &quot;max&quot; - use the maximum radius of the two beams.</span>
</span><span id="Lattice-1473"><a href="#Lattice-1473"><span class="linenos">1473</span></a><span class="sd">            &quot;min&quot; - use the minimum radius of the two beams.</span>
</span><span id="Lattice-1474"><a href="#Lattice-1474"><span class="linenos">1474</span></a><span class="sd">            &quot;avg&quot; - use the average radius of the two beams.</span>
</span><span id="Lattice-1475"><a href="#Lattice-1475"><span class="linenos">1475</span></a>
</span><span id="Lattice-1476"><a href="#Lattice-1476"><span class="linenos">1476</span></a><span class="sd">        type_strategy : str</span>
</span><span id="Lattice-1477"><a href="#Lattice-1477"><span class="linenos">1477</span></a><span class="sd">            Strategy for determining the type of the new beam:</span>
</span><span id="Lattice-1478"><a href="#Lattice-1478"><span class="linenos">1478</span></a><span class="sd">            &quot;inherit&quot; (default) - if both beams have the same type, use it; otherwise use b1&#39;s type.</span>
</span><span id="Lattice-1479"><a href="#Lattice-1479"><span class="linenos">1479</span></a><span class="sd">            &quot;max&quot; - use the maximum type of the two beams.</span>
</span><span id="Lattice-1480"><a href="#Lattice-1480"><span class="linenos">1480</span></a><span class="sd">            &quot;min&quot; - use the minimum type of the two beams.</span>
</span><span id="Lattice-1481"><a href="#Lattice-1481"><span class="linenos">1481</span></a><span class="sd">            &quot;avg&quot; - use the average type of the two beams (rounded).</span>
</span><span id="Lattice-1482"><a href="#Lattice-1482"><span class="linenos">1482</span></a>
</span><span id="Lattice-1483"><a href="#Lattice-1483"><span class="linenos">1483</span></a><span class="sd">        material_strategy : str</span>
</span><span id="Lattice-1484"><a href="#Lattice-1484"><span class="linenos">1484</span></a><span class="sd">            Strategy for determining the material of the new beam:</span>
</span><span id="Lattice-1485"><a href="#Lattice-1485"><span class="linenos">1485</span></a><span class="sd">            &quot;inherit&quot; (default) - if both beams have the same material, use it; otherwise use b1&#39;s material.</span>
</span><span id="Lattice-1486"><a href="#Lattice-1486"><span class="linenos">1486</span></a><span class="sd">            &quot;max&quot; - use the maximum material of the two beams.</span>
</span><span id="Lattice-1487"><a href="#Lattice-1487"><span class="linenos">1487</span></a><span class="sd">            &quot;min&quot; - use the minimum material of the two beams.</span>
</span><span id="Lattice-1488"><a href="#Lattice-1488"><span class="linenos">1488</span></a><span class="sd">            &quot;avg&quot; - use the average material of the two beams (rounded).</span>
</span><span id="Lattice-1489"><a href="#Lattice-1489"><span class="linenos">1489</span></a>
</span><span id="Lattice-1490"><a href="#Lattice-1490"><span class="linenos">1490</span></a><span class="sd">        iterative : bool</span>
</span><span id="Lattice-1491"><a href="#Lattice-1491"><span class="linenos">1491</span></a><span class="sd">            If True, repeat the merging process until no more merges are possible or max_passes is reached.</span>
</span><span id="Lattice-1492"><a href="#Lattice-1492"><span class="linenos">1492</span></a>
</span><span id="Lattice-1493"><a href="#Lattice-1493"><span class="linenos">1493</span></a><span class="sd">        max_passes : int</span>
</span><span id="Lattice-1494"><a href="#Lattice-1494"><span class="linenos">1494</span></a><span class="sd">            Maximum number of passes if iterative is True.</span>
</span><span id="Lattice-1495"><a href="#Lattice-1495"><span class="linenos">1495</span></a>
</span><span id="Lattice-1496"><a href="#Lattice-1496"><span class="linenos">1496</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice-1497"><a href="#Lattice-1497"><span class="linenos">1497</span></a><span class="sd">        --------</span>
</span><span id="Lattice-1498"><a href="#Lattice-1498"><span class="linenos">1498</span></a><span class="sd">        total_merged : int</span>
</span><span id="Lattice-1499"><a href="#Lattice-1499"><span class="linenos">1499</span></a><span class="sd">            Total number of nodes merged.</span>
</span><span id="Lattice-1500"><a href="#Lattice-1500"><span class="linenos">1500</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1501"><a href="#Lattice-1501"><span class="linenos">1501</span></a>
</span><span id="Lattice-1502"><a href="#Lattice-1502"><span class="linenos">1502</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_has_beam_between</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="Lattice-1503"><a href="#Lattice-1503"><span class="linenos">1503</span></a>            <span class="c1"># Check if a beam already exists between points a and c</span>
</span><span id="Lattice-1504"><a href="#Lattice-1504"><span class="linenos">1504</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice-1505"><a href="#Lattice-1505"><span class="linenos">1505</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span> <span class="ow">is</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span> <span class="ow">is</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">a</span><span class="p">):</span>
</span><span id="Lattice-1506"><a href="#Lattice-1506"><span class="linenos">1506</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="Lattice-1507"><a href="#Lattice-1507"><span class="linenos">1507</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice-1508"><a href="#Lattice-1508"><span class="linenos">1508</span></a>
</span><span id="Lattice-1509"><a href="#Lattice-1509"><span class="linenos">1509</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_choose</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">avg_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Lattice-1510"><a href="#Lattice-1510"><span class="linenos">1510</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span><span class="p">:</span>
</span><span id="Lattice-1511"><a href="#Lattice-1511"><span class="linenos">1511</span></a>                <span class="k">return</span> <span class="n">val1</span> <span class="k">if</span> <span class="n">val1</span> <span class="o">==</span> <span class="n">val2</span> <span class="ow">or</span> <span class="n">val2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val1</span>
</span><span id="Lattice-1512"><a href="#Lattice-1512"><span class="linenos">1512</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
</span><span id="Lattice-1513"><a href="#Lattice-1513"><span class="linenos">1513</span></a>                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
</span><span id="Lattice-1514"><a href="#Lattice-1514"><span class="linenos">1514</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
</span><span id="Lattice-1515"><a href="#Lattice-1515"><span class="linenos">1515</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
</span><span id="Lattice-1516"><a href="#Lattice-1516"><span class="linenos">1516</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
</span><span id="Lattice-1517"><a href="#Lattice-1517"><span class="linenos">1517</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">val1</span> <span class="o">+</span> <span class="n">val2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">avg_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">avg_fn</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
</span><span id="Lattice-1518"><a href="#Lattice-1518"><span class="linenos">1518</span></a>            <span class="k">return</span> <span class="n">val1</span>
</span><span id="Lattice-1519"><a href="#Lattice-1519"><span class="linenos">1519</span></a>
</span><span id="Lattice-1520"><a href="#Lattice-1520"><span class="linenos">1520</span></a>        <span class="n">total_merged</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice-1521"><a href="#Lattice-1521"><span class="linenos">1521</span></a>        <span class="n">passes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice-1522"><a href="#Lattice-1522"><span class="linenos">1522</span></a>
</span><span id="Lattice-1523"><a href="#Lattice-1523"><span class="linenos">1523</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Lattice-1524"><a href="#Lattice-1524"><span class="linenos">1524</span></a>            <span class="n">passes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Lattice-1525"><a href="#Lattice-1525"><span class="linenos">1525</span></a>            <span class="c1"># Redefine connectivity</span>
</span><span id="Lattice-1526"><a href="#Lattice-1526"><span class="linenos">1526</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="Lattice-1527"><a href="#Lattice-1527"><span class="linenos">1527</span></a>
</span><span id="Lattice-1528"><a href="#Lattice-1528"><span class="linenos">1528</span></a>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="Lattice-1529"><a href="#Lattice-1529"><span class="linenos">1529</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="Lattice-1530"><a href="#Lattice-1530"><span class="linenos">1530</span></a>                <span class="k">break</span>
</span><span id="Lattice-1531"><a href="#Lattice-1531"><span class="linenos">1531</span></a>
</span><span id="Lattice-1532"><a href="#Lattice-1532"><span class="linenos">1532</span></a>            <span class="n">used_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1533"><a href="#Lattice-1533"><span class="linenos">1533</span></a>            <span class="n">merges</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-1534"><a href="#Lattice-1534"><span class="linenos">1534</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="Lattice-1535"><a href="#Lattice-1535"><span class="linenos">1535</span></a>                <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span>
</span><span id="Lattice-1536"><a href="#Lattice-1536"><span class="linenos">1536</span></a>                <span class="k">if</span> <span class="n">b1</span> <span class="ow">in</span> <span class="n">used_beams</span> <span class="ow">or</span> <span class="n">b2</span> <span class="ow">in</span> <span class="n">used_beams</span><span class="p">:</span>
</span><span id="Lattice-1537"><a href="#Lattice-1537"><span class="linenos">1537</span></a>                    <span class="k">continue</span>
</span><span id="Lattice-1538"><a href="#Lattice-1538"><span class="linenos">1538</span></a>
</span><span id="Lattice-1539"><a href="#Lattice-1539"><span class="linenos">1539</span></a>                <span class="n">a</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">point1</span> <span class="k">if</span> <span class="n">b1</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">p</span> <span class="k">else</span> <span class="n">b1</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice-1540"><a href="#Lattice-1540"><span class="linenos">1540</span></a>                <span class="n">c</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">point1</span> <span class="k">if</span> <span class="n">b2</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">p</span> <span class="k">else</span> <span class="n">b2</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice-1541"><a href="#Lattice-1541"><span class="linenos">1541</span></a>                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">c</span><span class="p">:</span>
</span><span id="Lattice-1542"><a href="#Lattice-1542"><span class="linenos">1542</span></a>                    <span class="k">continue</span>
</span><span id="Lattice-1543"><a href="#Lattice-1543"><span class="linenos">1543</span></a>
</span><span id="Lattice-1544"><a href="#Lattice-1544"><span class="linenos">1544</span></a>                <span class="k">if</span> <span class="n">colinear_only</span><span class="p">:</span>
</span><span id="Lattice-1545"><a href="#Lattice-1545"><span class="linenos">1545</span></a>                    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Lattice-1546"><a href="#Lattice-1546"><span class="linenos">1546</span></a>                    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Lattice-1547"><a href="#Lattice-1547"><span class="linenos">1547</span></a>                    <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
</span><span id="Lattice-1548"><a href="#Lattice-1548"><span class="linenos">1548</span></a>                    <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
</span><span id="Lattice-1549"><a href="#Lattice-1549"><span class="linenos">1549</span></a>                    <span class="k">if</span> <span class="n">n1</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">n2</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice-1550"><a href="#Lattice-1550"><span class="linenos">1550</span></a>                        <span class="k">continue</span>
</span><span id="Lattice-1551"><a href="#Lattice-1551"><span class="linenos">1551</span></a>
</span><span id="Lattice-1552"><a href="#Lattice-1552"><span class="linenos">1552</span></a>                    <span class="n">cross_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>
</span><span id="Lattice-1553"><a href="#Lattice-1553"><span class="linenos">1553</span></a>                    <span class="k">if</span> <span class="n">cross_norm</span> <span class="o">&gt;</span> <span class="n">angle_tol</span> <span class="o">*</span> <span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="p">):</span>
</span><span id="Lattice-1554"><a href="#Lattice-1554"><span class="linenos">1554</span></a>                        <span class="k">continue</span>
</span><span id="Lattice-1555"><a href="#Lattice-1555"><span class="linenos">1555</span></a>                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice-1556"><a href="#Lattice-1556"><span class="linenos">1556</span></a>                        <span class="k">continue</span>
</span><span id="Lattice-1557"><a href="#Lattice-1557"><span class="linenos">1557</span></a>
</span><span id="Lattice-1558"><a href="#Lattice-1558"><span class="linenos">1558</span></a>                <span class="k">if</span> <span class="n">_has_beam_between</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="Lattice-1559"><a href="#Lattice-1559"><span class="linenos">1559</span></a>                    <span class="k">continue</span>
</span><span id="Lattice-1560"><a href="#Lattice-1560"><span class="linenos">1560</span></a>
</span><span id="Lattice-1561"><a href="#Lattice-1561"><span class="linenos">1561</span></a>                <span class="n">merges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
</span><span id="Lattice-1562"><a href="#Lattice-1562"><span class="linenos">1562</span></a>                <span class="n">used_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
</span><span id="Lattice-1563"><a href="#Lattice-1563"><span class="linenos">1563</span></a>                <span class="n">used_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>
</span><span id="Lattice-1564"><a href="#Lattice-1564"><span class="linenos">1564</span></a>
</span><span id="Lattice-1565"><a href="#Lattice-1565"><span class="linenos">1565</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">merges</span><span class="p">:</span>
</span><span id="Lattice-1566"><a href="#Lattice-1566"><span class="linenos">1566</span></a>                <span class="k">break</span>
</span><span id="Lattice-1567"><a href="#Lattice-1567"><span class="linenos">1567</span></a>
</span><span id="Lattice-1568"><a href="#Lattice-1568"><span class="linenos">1568</span></a>            <span class="n">beams_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1569"><a href="#Lattice-1569"><span class="linenos">1569</span></a>            <span class="n">beams_to_add</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1570"><a href="#Lattice-1570"><span class="linenos">1570</span></a>            <span class="n">points_to_destroy</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1571"><a href="#Lattice-1571"><span class="linenos">1571</span></a>
</span><span id="Lattice-1572"><a href="#Lattice-1572"><span class="linenos">1572</span></a>            <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">:</span>
</span><span id="Lattice-1573"><a href="#Lattice-1573"><span class="linenos">1573</span></a>                <span class="n">radius</span> <span class="o">=</span> <span class="n">_choose</span><span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius_strategy</span><span class="p">)</span>
</span><span id="Lattice-1574"><a href="#Lattice-1574"><span class="linenos">1574</span></a>                <span class="n">typ</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">type_beam</span> <span class="k">if</span> <span class="p">(</span><span class="n">type_strategy</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span> <span class="ow">or</span> <span class="n">b1</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="n">b2</span><span class="o">.</span><span class="n">type_beam</span><span class="p">)</span> <span class="k">else</span> <span class="n">b1</span><span class="o">.</span><span class="n">type_beam</span>
</span><span id="Lattice-1575"><a href="#Lattice-1575"><span class="linenos">1575</span></a>                <span class="n">mat</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">material</span> <span class="k">if</span> <span class="p">(</span><span class="n">material_strategy</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span> <span class="ow">or</span> <span class="n">b1</span><span class="o">.</span><span class="n">material</span> <span class="o">==</span> <span class="n">b2</span><span class="o">.</span><span class="n">material</span><span class="p">)</span> <span class="k">else</span> <span class="n">b1</span><span class="o">.</span><span class="n">material</span>
</span><span id="Lattice-1576"><a href="#Lattice-1576"><span class="linenos">1576</span></a>
</span><span id="Lattice-1577"><a href="#Lattice-1577"><span class="linenos">1577</span></a>                <span class="n">cells_union</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1578"><a href="#Lattice-1578"><span class="linenos">1578</span></a>                <span class="k">for</span> <span class="n">bm</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">):</span>
</span><span id="Lattice-1579"><a href="#Lattice-1579"><span class="linenos">1579</span></a>                    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bm</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Lattice-1580"><a href="#Lattice-1580"><span class="linenos">1580</span></a>                        <span class="n">cells_union</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="Lattice-1581"><a href="#Lattice-1581"><span class="linenos">1581</span></a>
</span><span id="Lattice-1582"><a href="#Lattice-1582"><span class="linenos">1582</span></a>                <span class="n">new_beam</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">cells_union</span><span class="p">))</span>
</span><span id="Lattice-1583"><a href="#Lattice-1583"><span class="linenos">1583</span></a>
</span><span id="Lattice-1584"><a href="#Lattice-1584"><span class="linenos">1584</span></a>                <span class="k">for</span> <span class="n">bm</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">):</span>
</span><span id="Lattice-1585"><a href="#Lattice-1585"><span class="linenos">1585</span></a>                    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">bm</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]))):</span>
</span><span id="Lattice-1586"><a href="#Lattice-1586"><span class="linenos">1586</span></a>                        <span class="n">cell</span><span class="o">.</span><span class="n">remove_beam</span><span class="p">(</span><span class="n">bm</span><span class="p">)</span>
</span><span id="Lattice-1587"><a href="#Lattice-1587"><span class="linenos">1587</span></a>
</span><span id="Lattice-1588"><a href="#Lattice-1588"><span class="linenos">1588</span></a>                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells_union</span><span class="p">:</span>
</span><span id="Lattice-1589"><a href="#Lattice-1589"><span class="linenos">1589</span></a>                    <span class="n">cell</span><span class="o">.</span><span class="n">add_beam</span><span class="p">([</span><span class="n">new_beam</span><span class="p">])</span>
</span><span id="Lattice-1590"><a href="#Lattice-1590"><span class="linenos">1590</span></a>
</span><span id="Lattice-1591"><a href="#Lattice-1591"><span class="linenos">1591</span></a>                <span class="n">beams_to_remove</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">])</span>
</span><span id="Lattice-1592"><a href="#Lattice-1592"><span class="linenos">1592</span></a>                <span class="n">beams_to_add</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_beam</span><span class="p">)</span>
</span><span id="Lattice-1593"><a href="#Lattice-1593"><span class="linenos">1593</span></a>                <span class="n">points_to_destroy</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Lattice-1594"><a href="#Lattice-1594"><span class="linenos">1594</span></a>
</span><span id="Lattice-1595"><a href="#Lattice-1595"><span class="linenos">1595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">beams_to_remove</span><span class="p">)</span>
</span><span id="Lattice-1596"><a href="#Lattice-1596"><span class="linenos">1596</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beams_to_add</span><span class="p">)</span>
</span><span id="Lattice-1597"><a href="#Lattice-1597"><span class="linenos">1597</span></a>
</span><span id="Lattice-1598"><a href="#Lattice-1598"><span class="linenos">1598</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points_to_destroy</span><span class="p">:</span>
</span><span id="Lattice-1599"><a href="#Lattice-1599"><span class="linenos">1599</span></a>                <span class="n">p</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Lattice-1600"><a href="#Lattice-1600"><span class="linenos">1600</span></a>
</span><span id="Lattice-1601"><a href="#Lattice-1601"><span class="linenos">1601</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice-1602"><a href="#Lattice-1602"><span class="linenos">1602</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice-1603"><a href="#Lattice-1603"><span class="linenos">1603</span></a>
</span><span id="Lattice-1604"><a href="#Lattice-1604"><span class="linenos">1604</span></a>            <span class="n">merged_this_pass</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merges</span><span class="p">)</span>
</span><span id="Lattice-1605"><a href="#Lattice-1605"><span class="linenos">1605</span></a>            <span class="n">total_merged</span> <span class="o">+=</span> <span class="n">merged_this_pass</span>
</span><span id="Lattice-1606"><a href="#Lattice-1606"><span class="linenos">1606</span></a>
</span><span id="Lattice-1607"><a href="#Lattice-1607"><span class="linenos">1607</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">iterative</span> <span class="ow">or</span> <span class="n">passes</span> <span class="o">&gt;=</span> <span class="n">max_passes</span><span class="p">:</span>
</span><span id="Lattice-1608"><a href="#Lattice-1608"><span class="linenos">1608</span></a>                <span class="k">break</span>
</span><span id="Lattice-1609"><a href="#Lattice-1609"><span class="linenos">1609</span></a>
</span><span id="Lattice-1610"><a href="#Lattice-1610"><span class="linenos">1610</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delete_orphan_points</span><span class="p">()</span>
</span><span id="Lattice-1611"><a href="#Lattice-1611"><span class="linenos">1611</span></a>
</span><span id="Lattice-1612"><a href="#Lattice-1612"><span class="linenos">1612</span></a>        <span class="k">return</span> <span class="n">total_merged</span>
</span><span id="Lattice-1613"><a href="#Lattice-1613"><span class="linenos">1613</span></a>
</span><span id="Lattice-1614"><a href="#Lattice-1614"><span class="linenos">1614</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice-1615"><a href="#Lattice-1615"><span class="linenos">1615</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1616"><a href="#Lattice-1616"><span class="linenos">1616</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_unconnected_beams</span><span class="p">(</span>
</span><span id="Lattice-1617"><a href="#Lattice-1617"><span class="linenos">1617</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Lattice-1618"><a href="#Lattice-1618"><span class="linenos">1618</span></a>            <span class="n">protect_fixed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice-1619"><a href="#Lattice-1619"><span class="linenos">1619</span></a>            <span class="n">protect_loaded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice-1620"><a href="#Lattice-1620"><span class="linenos">1620</span></a>            <span class="n">also_delete_orphan_nodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Lattice-1621"><a href="#Lattice-1621"><span class="linenos">1621</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="Lattice-1622"><a href="#Lattice-1622"><span class="linenos">1622</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1623"><a href="#Lattice-1623"><span class="linenos">1623</span></a><span class="sd">        Delete beams that are &quot;leaf&quot; beams, i.e. connected to at least one node of degree 1 or 0.</span>
</span><span id="Lattice-1624"><a href="#Lattice-1624"><span class="linenos">1624</span></a>
</span><span id="Lattice-1625"><a href="#Lattice-1625"><span class="linenos">1625</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-1626"><a href="#Lattice-1626"><span class="linenos">1626</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-1627"><a href="#Lattice-1627"><span class="linenos">1627</span></a><span class="sd">        protect_fixed: bool</span>
</span><span id="Lattice-1628"><a href="#Lattice-1628"><span class="linenos">1628</span></a><span class="sd">            If True, do not delete beams connected to fixed nodes.</span>
</span><span id="Lattice-1629"><a href="#Lattice-1629"><span class="linenos">1629</span></a>
</span><span id="Lattice-1630"><a href="#Lattice-1630"><span class="linenos">1630</span></a><span class="sd">        protect_loaded: bool</span>
</span><span id="Lattice-1631"><a href="#Lattice-1631"><span class="linenos">1631</span></a><span class="sd">            If True, do not delete beams connected to loaded nodes.</span>
</span><span id="Lattice-1632"><a href="#Lattice-1632"><span class="linenos">1632</span></a>
</span><span id="Lattice-1633"><a href="#Lattice-1633"><span class="linenos">1633</span></a><span class="sd">        also_delete_orphan_nodes: bool</span>
</span><span id="Lattice-1634"><a href="#Lattice-1634"><span class="linenos">1634</span></a><span class="sd">            If True, delete nodes that become orphaned after beam removal.</span>
</span><span id="Lattice-1635"><a href="#Lattice-1635"><span class="linenos">1635</span></a>
</span><span id="Lattice-1636"><a href="#Lattice-1636"><span class="linenos">1636</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice-1637"><a href="#Lattice-1637"><span class="linenos">1637</span></a><span class="sd">        --------</span>
</span><span id="Lattice-1638"><a href="#Lattice-1638"><span class="linenos">1638</span></a><span class="sd">        tuple[int, int]</span>
</span><span id="Lattice-1639"><a href="#Lattice-1639"><span class="linenos">1639</span></a><span class="sd">            Number of beams removed and number of nodes removed.</span>
</span><span id="Lattice-1640"><a href="#Lattice-1640"><span class="linenos">1640</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1641"><a href="#Lattice-1641"><span class="linenos">1641</span></a>        <span class="c1"># Deactivate periodicity to ensure correct connectivity checks</span>
</span><span id="Lattice-1642"><a href="#Lattice-1642"><span class="linenos">1642</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice-1643"><a href="#Lattice-1643"><span class="linenos">1643</span></a>        <span class="c1"># Identify beams to remove</span>
</span><span id="Lattice-1644"><a href="#Lattice-1644"><span class="linenos">1644</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="Lattice-1645"><a href="#Lattice-1645"><span class="linenos">1645</span></a>
</span><span id="Lattice-1646"><a href="#Lattice-1646"><span class="linenos">1646</span></a>        <span class="n">to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice-1647"><a href="#Lattice-1647"><span class="linenos">1647</span></a>
</span><span id="Lattice-1648"><a href="#Lattice-1648"><span class="linenos">1648</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">):</span>
</span><span id="Lattice-1649"><a href="#Lattice-1649"><span class="linenos">1649</span></a>            <span class="n">deg1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="Lattice-1650"><a href="#Lattice-1650"><span class="linenos">1650</span></a>            <span class="n">deg2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="Lattice-1651"><a href="#Lattice-1651"><span class="linenos">1651</span></a>            <span class="n">is_leaf_bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">deg1</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">deg2</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice-1652"><a href="#Lattice-1652"><span class="linenos">1652</span></a>
</span><span id="Lattice-1653"><a href="#Lattice-1653"><span class="linenos">1653</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_leaf_bar</span><span class="p">:</span>
</span><span id="Lattice-1654"><a href="#Lattice-1654"><span class="linenos">1654</span></a>                <span class="k">continue</span>
</span><span id="Lattice-1655"><a href="#Lattice-1655"><span class="linenos">1655</span></a>
</span><span id="Lattice-1656"><a href="#Lattice-1656"><span class="linenos">1656</span></a>
</span><span id="Lattice-1657"><a href="#Lattice-1657"><span class="linenos">1657</span></a>            <span class="n">p1_fixed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">fixed_DOF</span><span class="p">)</span>
</span><span id="Lattice-1658"><a href="#Lattice-1658"><span class="linenos">1658</span></a>            <span class="n">p2_fixed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">fixed_DOF</span><span class="p">)</span>
</span><span id="Lattice-1659"><a href="#Lattice-1659"><span class="linenos">1659</span></a>            <span class="n">p1_load</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">applied_force</span><span class="p">)</span>
</span><span id="Lattice-1660"><a href="#Lattice-1660"><span class="linenos">1660</span></a>            <span class="n">p2_load</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">applied_force</span><span class="p">)</span>
</span><span id="Lattice-1661"><a href="#Lattice-1661"><span class="linenos">1661</span></a>
</span><span id="Lattice-1662"><a href="#Lattice-1662"><span class="linenos">1662</span></a>            <span class="c1"># Protect beams connected to fixed or loaded nodes if specified</span>
</span><span id="Lattice-1663"><a href="#Lattice-1663"><span class="linenos">1663</span></a>            <span class="k">if</span> <span class="n">protect_fixed</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p1_fixed</span> <span class="ow">or</span> <span class="n">p2_fixed</span><span class="p">):</span>
</span><span id="Lattice-1664"><a href="#Lattice-1664"><span class="linenos">1664</span></a>                <span class="k">continue</span>
</span><span id="Lattice-1665"><a href="#Lattice-1665"><span class="linenos">1665</span></a>            <span class="k">if</span> <span class="n">protect_loaded</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p1_load</span> <span class="ow">or</span> <span class="n">p2_load</span><span class="p">):</span>
</span><span id="Lattice-1666"><a href="#Lattice-1666"><span class="linenos">1666</span></a>                <span class="k">continue</span>
</span><span id="Lattice-1667"><a href="#Lattice-1667"><span class="linenos">1667</span></a>
</span><span id="Lattice-1668"><a href="#Lattice-1668"><span class="linenos">1668</span></a>            <span class="n">to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="Lattice-1669"><a href="#Lattice-1669"><span class="linenos">1669</span></a>
</span><span id="Lattice-1670"><a href="#Lattice-1670"><span class="linenos">1670</span></a>
</span><span id="Lattice-1671"><a href="#Lattice-1671"><span class="linenos">1671</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_remove</span><span class="p">:</span>
</span><span id="Lattice-1672"><a href="#Lattice-1672"><span class="linenos">1672</span></a>            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Lattice-1673"><a href="#Lattice-1673"><span class="linenos">1673</span></a>
</span><span id="Lattice-1674"><a href="#Lattice-1674"><span class="linenos">1674</span></a>        <span class="c1"># Remove identified beams from cells</span>
</span><span id="Lattice-1675"><a href="#Lattice-1675"><span class="linenos">1675</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
</span><span id="Lattice-1676"><a href="#Lattice-1676"><span class="linenos">1676</span></a>            <span class="n">b</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Lattice-1677"><a href="#Lattice-1677"><span class="linenos">1677</span></a>
</span><span id="Lattice-1678"><a href="#Lattice-1678"><span class="linenos">1678</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice-1679"><a href="#Lattice-1679"><span class="linenos">1679</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice-1680"><a href="#Lattice-1680"><span class="linenos">1680</span></a>
</span><span id="Lattice-1681"><a href="#Lattice-1681"><span class="linenos">1681</span></a>        <span class="c1"># Delete orphan nodes if specified</span>
</span><span id="Lattice-1682"><a href="#Lattice-1682"><span class="linenos">1682</span></a>        <span class="n">removed_pts</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice-1683"><a href="#Lattice-1683"><span class="linenos">1683</span></a>        <span class="k">if</span> <span class="n">also_delete_orphan_nodes</span><span class="p">:</span>
</span><span id="Lattice-1684"><a href="#Lattice-1684"><span class="linenos">1684</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delete_orphan_points</span><span class="p">()</span>
</span><span id="Lattice-1685"><a href="#Lattice-1685"><span class="linenos">1685</span></a>
</span><span id="Lattice-1686"><a href="#Lattice-1686"><span class="linenos">1686</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_remove</span><span class="p">),</span> <span class="n">removed_pts</span>
</span><span id="Lattice-1687"><a href="#Lattice-1687"><span class="linenos">1687</span></a>
</span><span id="Lattice-1688"><a href="#Lattice-1688"><span class="linenos">1688</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-1689"><a href="#Lattice-1689"><span class="linenos">1689</span></a><span class="c1"># SECTION: Other Methods</span>
</span><span id="Lattice-1690"><a href="#Lattice-1690"><span class="linenos">1690</span></a><span class="c1"># =============================================================================</span>
</span><span id="Lattice-1691"><a href="#Lattice-1691"><span class="linenos">1691</span></a>
</span><span id="Lattice-1692"><a href="#Lattice-1692"><span class="linenos">1692</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;meshing&quot;</span><span class="p">)</span>
</span><span id="Lattice-1693"><a href="#Lattice-1693"><span class="linenos">1693</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1694"><a href="#Lattice-1694"><span class="linenos">1694</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_mesh_lattice_Gmsh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut_mesh_at_boundary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mesh_refinement</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Lattice-1695"><a href="#Lattice-1695"><span class="linenos">1695</span></a>                                   <span class="n">name_mesh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Lattice&quot;</span><span class="p">,</span><span class="n">save_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save_STL</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice-1696"><a href="#Lattice-1696"><span class="linenos">1696</span></a>                                   <span class="n">volume_computation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">only_volume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Lattice-1697"><a href="#Lattice-1697"><span class="linenos">1697</span></a>                                   <span class="n">only_relative_density</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cell_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-1698"><a href="#Lattice-1698"><span class="linenos">1698</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1699"><a href="#Lattice-1699"><span class="linenos">1699</span></a><span class="sd">        Generate a 2D mesh representation of the lattice structure using GMSH.</span>
</span><span id="Lattice-1700"><a href="#Lattice-1700"><span class="linenos">1700</span></a><span class="sd">        Generating 3D mesh for simulation is not currently supported, but will be in the future.</span>
</span><span id="Lattice-1701"><a href="#Lattice-1701"><span class="linenos">1701</span></a>
</span><span id="Lattice-1702"><a href="#Lattice-1702"><span class="linenos">1702</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice-1703"><a href="#Lattice-1703"><span class="linenos">1703</span></a><span class="sd">        -----------</span>
</span><span id="Lattice-1704"><a href="#Lattice-1704"><span class="linenos">1704</span></a><span class="sd">        cut_mesh_at_boundary: bool</span>
</span><span id="Lattice-1705"><a href="#Lattice-1705"><span class="linenos">1705</span></a><span class="sd">            If True, the mesh will be cut at the boundary of the lattice.</span>
</span><span id="Lattice-1706"><a href="#Lattice-1706"><span class="linenos">1706</span></a>
</span><span id="Lattice-1707"><a href="#Lattice-1707"><span class="linenos">1707</span></a><span class="sd">        mesh_refinement: float</span>
</span><span id="Lattice-1708"><a href="#Lattice-1708"><span class="linenos">1708</span></a><span class="sd">            Refinement factor for the mesh (higher values lead to finer meshes).</span>
</span><span id="Lattice-1709"><a href="#Lattice-1709"><span class="linenos">1709</span></a>
</span><span id="Lattice-1710"><a href="#Lattice-1710"><span class="linenos">1710</span></a><span class="sd">        name_mesh: str</span>
</span><span id="Lattice-1711"><a href="#Lattice-1711"><span class="linenos">1711</span></a><span class="sd">            Name of the mesh to be generated.</span>
</span><span id="Lattice-1712"><a href="#Lattice-1712"><span class="linenos">1712</span></a>
</span><span id="Lattice-1713"><a href="#Lattice-1713"><span class="linenos">1713</span></a><span class="sd">        save_mesh: bool</span>
</span><span id="Lattice-1714"><a href="#Lattice-1714"><span class="linenos">1714</span></a><span class="sd">            If True, the mesh will be saved to a file.</span>
</span><span id="Lattice-1715"><a href="#Lattice-1715"><span class="linenos">1715</span></a>
</span><span id="Lattice-1716"><a href="#Lattice-1716"><span class="linenos">1716</span></a><span class="sd">        save_STL: bool</span>
</span><span id="Lattice-1717"><a href="#Lattice-1717"><span class="linenos">1717</span></a><span class="sd">            If True, the mesh will be saved in STL format.</span>
</span><span id="Lattice-1718"><a href="#Lattice-1718"><span class="linenos">1718</span></a>
</span><span id="Lattice-1719"><a href="#Lattice-1719"><span class="linenos">1719</span></a><span class="sd">        volume_computation: bool</span>
</span><span id="Lattice-1720"><a href="#Lattice-1720"><span class="linenos">1720</span></a><span class="sd">            If True, the volume of the mesh will be computed and printed.</span>
</span><span id="Lattice-1721"><a href="#Lattice-1721"><span class="linenos">1721</span></a>
</span><span id="Lattice-1722"><a href="#Lattice-1722"><span class="linenos">1722</span></a><span class="sd">        only_volume: bool</span>
</span><span id="Lattice-1723"><a href="#Lattice-1723"><span class="linenos">1723</span></a><span class="sd">            If True, only the volume of the mesh will be computed and returned.</span>
</span><span id="Lattice-1724"><a href="#Lattice-1724"><span class="linenos">1724</span></a>
</span><span id="Lattice-1725"><a href="#Lattice-1725"><span class="linenos">1725</span></a><span class="sd">        only_relative_density: bool</span>
</span><span id="Lattice-1726"><a href="#Lattice-1726"><span class="linenos">1726</span></a><span class="sd">            If True, only the relative density of the mesh will be computed and returned.</span>
</span><span id="Lattice-1727"><a href="#Lattice-1727"><span class="linenos">1727</span></a>
</span><span id="Lattice-1728"><a href="#Lattice-1728"><span class="linenos">1728</span></a><span class="sd">        cell_index: int | None</span>
</span><span id="Lattice-1729"><a href="#Lattice-1729"><span class="linenos">1729</span></a><span class="sd">            If provided, only the specified cell will be meshed.</span>
</span><span id="Lattice-1730"><a href="#Lattice-1730"><span class="linenos">1730</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1731"><a href="#Lattice-1731"><span class="linenos">1731</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</span><span id="Lattice-1732"><a href="#Lattice-1732"><span class="linenos">1732</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;General.Verbosity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice-1733"><a href="#Lattice-1733"><span class="linenos">1733</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name_mesh</span><span class="p">)</span>
</span><span id="Lattice-1734"><a href="#Lattice-1734"><span class="linenos">1734</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Geometry.OCCFixDegenerated&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice-1735"><a href="#Lattice-1735"><span class="linenos">1735</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Geometry.OCCFixSmallEdges&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice-1736"><a href="#Lattice-1736"><span class="linenos">1736</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Geometry.OCCFixSmallFaces&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice-1737"><a href="#Lattice-1737"><span class="linenos">1737</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.CharacteristicLengthFromCurvature&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice-1738"><a href="#Lattice-1738"><span class="linenos">1738</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MinimumCircleNodes&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>  <span class="c1"># help meshing thin cylinders</span>
</span><span id="Lattice-1739"><a href="#Lattice-1739"><span class="linenos">1739</span></a>        <span class="n">N_CIRC_TARGET</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">mesh_refinement</span>  <span class="c1"># ~elements around the circumference (same for all radii)</span>
</span><span id="Lattice-1740"><a href="#Lattice-1740"><span class="linenos">1740</span></a>        <span class="n">N_AXIAL_TARGET</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">mesh_refinement</span>  <span class="c1"># ~elements along each beam axis (same for all beam lengths)</span>
</span><span id="Lattice-1741"><a href="#Lattice-1741"><span class="linenos">1741</span></a>        <span class="n">mesh_size_max</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="Lattice-1742"><a href="#Lattice-1742"><span class="linenos">1742</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MinimumCircleNodes&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">N_CIRC_TARGET</span><span class="p">))</span>
</span><span id="Lattice-1743"><a href="#Lattice-1743"><span class="linenos">1743</span></a>
</span><span id="Lattice-1744"><a href="#Lattice-1744"><span class="linenos">1744</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Dimension of the mesh</span>
</span><span id="Lattice-1745"><a href="#Lattice-1745"><span class="linenos">1745</span></a>
</span><span id="Lattice-1746"><a href="#Lattice-1746"><span class="linenos">1746</span></a>        <span class="c1"># Find beams to mesh</span>
</span><span id="Lattice-1747"><a href="#Lattice-1747"><span class="linenos">1747</span></a>        <span class="k">if</span> <span class="n">cell_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-1748"><a href="#Lattice-1748"><span class="linenos">1748</span></a>            <span class="k">if</span> <span class="n">cell_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cell_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="Lattice-1749"><a href="#Lattice-1749"><span class="linenos">1749</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid cell index.&quot;</span><span class="p">)</span>
</span><span id="Lattice-1750"><a href="#Lattice-1750"><span class="linenos">1750</span></a>            <span class="n">beams_to_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span><span class="o">.</span><span class="n">beams_cell</span>
</span><span id="Lattice-1751"><a href="#Lattice-1751"><span class="linenos">1751</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-1752"><a href="#Lattice-1752"><span class="linenos">1752</span></a>            <span class="n">beams_to_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span>
</span><span id="Lattice-1753"><a href="#Lattice-1753"><span class="linenos">1753</span></a>
</span><span id="Lattice-1754"><a href="#Lattice-1754"><span class="linenos">1754</span></a>        <span class="n">all_tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-1755"><a href="#Lattice-1755"><span class="linenos">1755</span></a>        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-1756"><a href="#Lattice-1756"><span class="linenos">1756</span></a>        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-1757"><a href="#Lattice-1757"><span class="linenos">1757</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams_to_mesh</span><span class="p">:</span>
</span><span id="Lattice-1758"><a href="#Lattice-1758"><span class="linenos">1758</span></a>            <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="Lattice-1759"><a href="#Lattice-1759"><span class="linenos">1759</span></a>            <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="Lattice-1760"><a href="#Lattice-1760"><span class="linenos">1760</span></a>            <span class="n">direction</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
</span><span id="Lattice-1761"><a href="#Lattice-1761"><span class="linenos">1761</span></a>            <span class="c1"># Use initial radius if defined</span>
</span><span id="Lattice-1762"><a href="#Lattice-1762"><span class="linenos">1762</span></a>            <span class="n">radius</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">initial_radius</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="s2">&quot;initial_radius&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span>
</span><span id="Lattice-1763"><a href="#Lattice-1763"><span class="linenos">1763</span></a>
</span><span id="Lattice-1764"><a href="#Lattice-1764"><span class="linenos">1764</span></a>            <span class="n">min_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">mesh_size_max</span><span class="p">)</span>  <span class="c1"># avoid too-short beams wrt mesh size</span>
</span><span id="Lattice-1765"><a href="#Lattice-1765"><span class="linenos">1765</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_len</span> <span class="ow">or</span> <span class="n">radius</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice-1766"><a href="#Lattice-1766"><span class="linenos">1766</span></a>                <span class="k">continue</span>  <span class="c1"># skip near-zero length or non-positive radius</span>
</span><span id="Lattice-1767"><a href="#Lattice-1767"><span class="linenos">1767</span></a>
</span><span id="Lattice-1768"><a href="#Lattice-1768"><span class="linenos">1768</span></a>            <span class="n">tag</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCylinder</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
</span><span id="Lattice-1769"><a href="#Lattice-1769"><span class="linenos">1769</span></a>            <span class="n">all_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span id="Lattice-1770"><a href="#Lattice-1770"><span class="linenos">1770</span></a>            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
</span><span id="Lattice-1771"><a href="#Lattice-1771"><span class="linenos">1771</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
</span><span id="Lattice-1772"><a href="#Lattice-1772"><span class="linenos">1772</span></a>            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">p2</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">L</span><span class="p">))</span>
</span><span id="Lattice-1773"><a href="#Lattice-1773"><span class="linenos">1773</span></a>
</span><span id="Lattice-1774"><a href="#Lattice-1774"><span class="linenos">1774</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="Lattice-1775"><a href="#Lattice-1775"><span class="linenos">1775</span></a>
</span><span id="Lattice-1776"><a href="#Lattice-1776"><span class="linenos">1776</span></a>        <span class="c1"># Merge all beams into a single entity</span>
</span><span id="Lattice-1777"><a href="#Lattice-1777"><span class="linenos">1777</span></a>        <span class="n">beam_entities</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">]</span>
</span><span id="Lattice-1778"><a href="#Lattice-1778"><span class="linenos">1778</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice-1779"><a href="#Lattice-1779"><span class="linenos">1779</span></a>            <span class="n">lattice</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">fragment</span><span class="p">(</span><span class="n">beam_entities</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Lattice-1780"><a href="#Lattice-1780"><span class="linenos">1780</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Lattice-1781"><a href="#Lattice-1781"><span class="linenos">1781</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fragmentation failed:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="Lattice-1782"><a href="#Lattice-1782"><span class="linenos">1782</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Lattice-1783"><a href="#Lattice-1783"><span class="linenos">1783</span></a>
</span><span id="Lattice-1784"><a href="#Lattice-1784"><span class="linenos">1784</span></a>        <span class="k">if</span> <span class="n">cut_mesh_at_boundary</span><span class="p">:</span>
</span><span id="Lattice-1785"><a href="#Lattice-1785"><span class="linenos">1785</span></a>            <span class="c1"># Bounding box definition</span>
</span><span id="Lattice-1786"><a href="#Lattice-1786"><span class="linenos">1786</span></a>            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span>
</span><span id="Lattice-1787"><a href="#Lattice-1787"><span class="linenos">1787</span></a>            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">-</span> <span class="n">z0</span>
</span><span id="Lattice-1788"><a href="#Lattice-1788"><span class="linenos">1788</span></a>            <span class="n">box</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addBox</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>
</span><span id="Lattice-1789"><a href="#Lattice-1789"><span class="linenos">1789</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice-1790"><a href="#Lattice-1790"><span class="linenos">1790</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">lattice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[(</span><span class="n">dim</span><span class="p">,</span> <span class="n">box</span><span class="p">)],</span> <span class="n">removeObject</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">removeTool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Lattice-1791"><a href="#Lattice-1791"><span class="linenos">1791</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Lattice-1792"><a href="#Lattice-1792"><span class="linenos">1792</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intersection failed:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="Lattice-1793"><a href="#Lattice-1793"><span class="linenos">1793</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="Lattice-1794"><a href="#Lattice-1794"><span class="linenos">1794</span></a>
</span><span id="Lattice-1795"><a href="#Lattice-1795"><span class="linenos">1795</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="Lattice-1796"><a href="#Lattice-1796"><span class="linenos">1796</span></a>
</span><span id="Lattice-1797"><a href="#Lattice-1797"><span class="linenos">1797</span></a>        <span class="k">if</span> <span class="n">only_relative_density</span><span class="p">:</span>
</span><span id="Lattice-1798"><a href="#Lattice-1798"><span class="linenos">1798</span></a>            <span class="n">relative_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relative_density_mesh</span><span class="p">()</span>
</span><span id="Lattice-1799"><a href="#Lattice-1799"><span class="linenos">1799</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Lattice-1800"><a href="#Lattice-1800"><span class="linenos">1800</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span id="Lattice-1801"><a href="#Lattice-1801"><span class="linenos">1801</span></a>            <span class="k">return</span> <span class="n">relative_density</span>
</span><span id="Lattice-1802"><a href="#Lattice-1802"><span class="linenos">1802</span></a>
</span><span id="Lattice-1803"><a href="#Lattice-1803"><span class="linenos">1803</span></a>        <span class="n">total_volume</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice-1804"><a href="#Lattice-1804"><span class="linenos">1804</span></a>        <span class="k">if</span> <span class="n">volume_computation</span> <span class="ow">or</span> <span class="n">only_volume</span><span class="p">:</span>
</span><span id="Lattice-1805"><a href="#Lattice-1805"><span class="linenos">1805</span></a>            <span class="n">total_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume_mesh</span><span class="p">(</span><span class="n">synchronize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Lattice-1806"><a href="#Lattice-1806"><span class="linenos">1806</span></a>            <span class="k">if</span> <span class="n">only_volume</span><span class="p">:</span>
</span><span id="Lattice-1807"><a href="#Lattice-1807"><span class="linenos">1807</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Lattice-1808"><a href="#Lattice-1808"><span class="linenos">1808</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span id="Lattice-1809"><a href="#Lattice-1809"><span class="linenos">1809</span></a>                <span class="k">return</span> <span class="n">total_volume</span>
</span><span id="Lattice-1810"><a href="#Lattice-1810"><span class="linenos">1810</span></a>
</span><span id="Lattice-1811"><a href="#Lattice-1811"><span class="linenos">1811</span></a>
</span><span id="Lattice-1812"><a href="#Lattice-1812"><span class="linenos">1812</span></a>        <span class="c1"># Define mesh size</span>
</span><span id="Lattice-1813"><a href="#Lattice-1813"><span class="linenos">1813</span></a>        <span class="n">pts</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Lattice-1814"><a href="#Lattice-1814"><span class="linenos">1814</span></a>
</span><span id="Lattice-1815"><a href="#Lattice-1815"><span class="linenos">1815</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_proj_param_and_dist</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
</span><span id="Lattice-1816"><a href="#Lattice-1816"><span class="linenos">1816</span></a>            <span class="n">AB</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">A</span>
</span><span id="Lattice-1817"><a href="#Lattice-1817"><span class="linenos">1817</span></a>            <span class="n">denom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">AB</span><span class="p">))</span>
</span><span id="Lattice-1818"><a href="#Lattice-1818"><span class="linenos">1818</span></a>            <span class="k">if</span> <span class="n">denom</span> <span class="o">&lt;=</span> <span class="mf">1e-30</span><span class="p">:</span>
</span><span id="Lattice-1819"><a href="#Lattice-1819"><span class="linenos">1819</span></a>                <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">A</span><span class="p">))</span>
</span><span id="Lattice-1820"><a href="#Lattice-1820"><span class="linenos">1820</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">A</span><span class="p">,</span> <span class="n">AB</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span>
</span><span id="Lattice-1821"><a href="#Lattice-1821"><span class="linenos">1821</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">t</span><span class="p">)</span>
</span><span id="Lattice-1822"><a href="#Lattice-1822"><span class="linenos">1822</span></a>            <span class="n">Q</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">AB</span>
</span><span id="Lattice-1823"><a href="#Lattice-1823"><span class="linenos">1823</span></a>            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Q</span><span class="p">))</span>
</span><span id="Lattice-1824"><a href="#Lattice-1824"><span class="linenos">1824</span></a>
</span><span id="Lattice-1825"><a href="#Lattice-1825"><span class="linenos">1825</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="Lattice-1826"><a href="#Lattice-1826"><span class="linenos">1826</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getCenterOfMass</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>
</span><span id="Lattice-1827"><a href="#Lattice-1827"><span class="linenos">1827</span></a>            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Lattice-1828"><a href="#Lattice-1828"><span class="linenos">1828</span></a>
</span><span id="Lattice-1829"><a href="#Lattice-1829"><span class="linenos">1829</span></a>            <span class="c1"># find nearest beam (by radial distance to axis)</span>
</span><span id="Lattice-1830"><a href="#Lattice-1830"><span class="linenos">1830</span></a>            <span class="n">dmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
</span><span id="Lattice-1831"><a href="#Lattice-1831"><span class="linenos">1831</span></a>            <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (r, L)</span>
</span><span id="Lattice-1832"><a href="#Lattice-1832"><span class="linenos">1832</span></a>            <span class="k">for</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
</span><span id="Lattice-1833"><a href="#Lattice-1833"><span class="linenos">1833</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">_proj_param_and_dist</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
</span><span id="Lattice-1834"><a href="#Lattice-1834"><span class="linenos">1834</span></a>                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">dmin</span><span class="p">:</span>
</span><span id="Lattice-1835"><a href="#Lattice-1835"><span class="linenos">1835</span></a>                    <span class="n">dmin</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="Lattice-1836"><a href="#Lattice-1836"><span class="linenos">1836</span></a>                    <span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
</span><span id="Lattice-1837"><a href="#Lattice-1837"><span class="linenos">1837</span></a>
</span><span id="Lattice-1838"><a href="#Lattice-1838"><span class="linenos">1838</span></a>            <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-1839"><a href="#Lattice-1839"><span class="linenos">1839</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt</span><span class="p">)],</span> <span class="nb">float</span><span class="p">(</span><span class="n">mesh_size_max</span><span class="p">))</span>
</span><span id="Lattice-1840"><a href="#Lattice-1840"><span class="linenos">1840</span></a>                <span class="k">continue</span>
</span><span id="Lattice-1841"><a href="#Lattice-1841"><span class="linenos">1841</span></a>
</span><span id="Lattice-1842"><a href="#Lattice-1842"><span class="linenos">1842</span></a>            <span class="n">rnear</span><span class="p">,</span> <span class="n">Lbeam</span> <span class="o">=</span> <span class="n">best</span>
</span><span id="Lattice-1843"><a href="#Lattice-1843"><span class="linenos">1843</span></a>
</span><span id="Lattice-1844"><a href="#Lattice-1844"><span class="linenos">1844</span></a>            <span class="c1"># target sizes for constant element counts:</span>
</span><span id="Lattice-1845"><a href="#Lattice-1845"><span class="linenos">1845</span></a>            <span class="c1"># - around circumference: h_circ ‚âà 2œÄr / N_CIRC_TARGET</span>
</span><span id="Lattice-1846"><a href="#Lattice-1846"><span class="linenos">1846</span></a>            <span class="c1"># - along axis:          h_ax   ‚âà L / N_AXIAL_TARGET</span>
</span><span id="Lattice-1847"><a href="#Lattice-1847"><span class="linenos">1847</span></a>            <span class="n">h_circ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rnear</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_CIRC_TARGET</span><span class="p">))</span>
</span><span id="Lattice-1848"><a href="#Lattice-1848"><span class="linenos">1848</span></a>            <span class="n">h_ax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Lbeam</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_AXIAL_TARGET</span><span class="p">))</span>
</span><span id="Lattice-1849"><a href="#Lattice-1849"><span class="linenos">1849</span></a>            <span class="n">h_base</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">h_circ</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">))</span>  <span class="c1"># respect both targets, avoid zero</span>
</span><span id="Lattice-1850"><a href="#Lattice-1850"><span class="linenos">1850</span></a>
</span><span id="Lattice-1851"><a href="#Lattice-1851"><span class="linenos">1851</span></a>            <span class="c1"># allow growth away from the beam (outside ~3r ‚Üí up to mesh_size)</span>
</span><span id="Lattice-1852"><a href="#Lattice-1852"><span class="linenos">1852</span></a>            <span class="k">if</span> <span class="n">dmin</span> <span class="o">&lt;=</span> <span class="n">rnear</span><span class="p">:</span>
</span><span id="Lattice-1853"><a href="#Lattice-1853"><span class="linenos">1853</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="n">h_base</span>
</span><span id="Lattice-1854"><a href="#Lattice-1854"><span class="linenos">1854</span></a>            <span class="k">elif</span> <span class="n">dmin</span> <span class="o">&gt;=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">rnear</span><span class="p">:</span>
</span><span id="Lattice-1855"><a href="#Lattice-1855"><span class="linenos">1855</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mesh_size_max</span><span class="p">)</span>
</span><span id="Lattice-1856"><a href="#Lattice-1856"><span class="linenos">1856</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-1857"><a href="#Lattice-1857"><span class="linenos">1857</span></a>                <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmin</span> <span class="o">-</span> <span class="n">rnear</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">rnear</span><span class="p">)</span>  <span class="c1"># linear ramp between r and 3r</span>
</span><span id="Lattice-1858"><a href="#Lattice-1858"><span class="linenos">1858</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="n">h_base</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mesh_size_max</span><span class="p">)</span> <span class="o">-</span> <span class="n">h_base</span><span class="p">)</span>
</span><span id="Lattice-1859"><a href="#Lattice-1859"><span class="linenos">1859</span></a>
</span><span id="Lattice-1860"><a href="#Lattice-1860"><span class="linenos">1860</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt</span><span class="p">)],</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
</span><span id="Lattice-1861"><a href="#Lattice-1861"><span class="linenos">1861</span></a>
</span><span id="Lattice-1862"><a href="#Lattice-1862"><span class="linenos">1862</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="Lattice-1863"><a href="#Lattice-1863"><span class="linenos">1863</span></a>
</span><span id="Lattice-1864"><a href="#Lattice-1864"><span class="linenos">1864</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="Lattice-1865"><a href="#Lattice-1865"><span class="linenos">1865</span></a>
</span><span id="Lattice-1866"><a href="#Lattice-1866"><span class="linenos">1866</span></a>        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;outputs&quot;</span> <span class="o">/</span> <span class="s2">&quot;mesh_file&quot;</span>
</span><span id="Lattice-1867"><a href="#Lattice-1867"><span class="linenos">1867</span></a>        <span class="k">if</span> <span class="n">save_mesh</span><span class="p">:</span>
</span><span id="Lattice-1868"><a href="#Lattice-1868"><span class="linenos">1868</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_mesh</span><span class="si">}</span><span class="s2">.msh&quot;</span>
</span><span id="Lattice-1869"><a href="#Lattice-1869"><span class="linenos">1869</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="Lattice-1870"><a href="#Lattice-1870"><span class="linenos">1870</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mesh_file saved at &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="Lattice-1871"><a href="#Lattice-1871"><span class="linenos">1871</span></a>
</span><span id="Lattice-1872"><a href="#Lattice-1872"><span class="linenos">1872</span></a>        <span class="k">if</span> <span class="n">save_STL</span><span class="p">:</span>
</span><span id="Lattice-1873"><a href="#Lattice-1873"><span class="linenos">1873</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_mesh</span><span class="si">}</span><span class="s2">.stl&quot;</span>
</span><span id="Lattice-1874"><a href="#Lattice-1874"><span class="linenos">1874</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="Lattice-1875"><a href="#Lattice-1875"><span class="linenos">1875</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mesh_file saved at &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="Lattice-1876"><a href="#Lattice-1876"><span class="linenos">1876</span></a>
</span><span id="Lattice-1877"><a href="#Lattice-1877"><span class="linenos">1877</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span id="Lattice-1878"><a href="#Lattice-1878"><span class="linenos">1878</span></a>        <span class="k">if</span> <span class="n">volume_computation</span><span class="p">:</span>
</span><span id="Lattice-1879"><a href="#Lattice-1879"><span class="linenos">1879</span></a>            <span class="k">return</span> <span class="n">total_volume</span>
</span><span id="Lattice-1880"><a href="#Lattice-1880"><span class="linenos">1880</span></a>
</span><span id="Lattice-1881"><a href="#Lattice-1881"><span class="linenos">1881</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;meshing&quot;</span><span class="p">)</span>
</span><span id="Lattice-1882"><a href="#Lattice-1882"><span class="linenos">1882</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1883"><a href="#Lattice-1883"><span class="linenos">1883</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_volume_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entities_3d</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">synchronize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice-1884"><a href="#Lattice-1884"><span class="linenos">1884</span></a>                        <span class="n">return_details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Lattice-1885"><a href="#Lattice-1885"><span class="linenos">1885</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1886"><a href="#Lattice-1886"><span class="linenos">1886</span></a><span class="sd">        Compute the exact CAD volume (OCC &#39;mass&#39; with unit density) of the current model</span>
</span><span id="Lattice-1887"><a href="#Lattice-1887"><span class="linenos">1887</span></a><span class="sd">        without requiring any meshing.</span>
</span><span id="Lattice-1888"><a href="#Lattice-1888"><span class="linenos">1888</span></a>
</span><span id="Lattice-1889"><a href="#Lattice-1889"><span class="linenos">1889</span></a><span class="sd">        Parameters</span>
</span><span id="Lattice-1890"><a href="#Lattice-1890"><span class="linenos">1890</span></a><span class="sd">        ----------</span>
</span><span id="Lattice-1891"><a href="#Lattice-1891"><span class="linenos">1891</span></a><span class="sd">        entities_3d : list[(int,int)] | None</span>
</span><span id="Lattice-1892"><a href="#Lattice-1892"><span class="linenos">1892</span></a><span class="sd">            Optional list of 3D OCC entities (pairs (dim=3, tag)). If None, all 3D</span>
</span><span id="Lattice-1893"><a href="#Lattice-1893"><span class="linenos">1893</span></a><span class="sd">            entities in the current model are used.</span>
</span><span id="Lattice-1894"><a href="#Lattice-1894"><span class="linenos">1894</span></a>
</span><span id="Lattice-1895"><a href="#Lattice-1895"><span class="linenos">1895</span></a><span class="sd">        synchronize : bool</span>
</span><span id="Lattice-1896"><a href="#Lattice-1896"><span class="linenos">1896</span></a><span class="sd">            If True, call gmsh.model.occ.synchronize() before querying mass properties.</span>
</span><span id="Lattice-1897"><a href="#Lattice-1897"><span class="linenos">1897</span></a><span class="sd">            Set to False only if you&#39;ve already synchronized after your boolean ops.</span>
</span><span id="Lattice-1898"><a href="#Lattice-1898"><span class="linenos">1898</span></a>
</span><span id="Lattice-1899"><a href="#Lattice-1899"><span class="linenos">1899</span></a><span class="sd">        return_details : bool</span>
</span><span id="Lattice-1900"><a href="#Lattice-1900"><span class="linenos">1900</span></a><span class="sd">            If True, return a dict with &#39;total&#39; and &#39;per_entity&#39; (list of (tag, volume)).</span>
</span><span id="Lattice-1901"><a href="#Lattice-1901"><span class="linenos">1901</span></a>
</span><span id="Lattice-1902"><a href="#Lattice-1902"><span class="linenos">1902</span></a><span class="sd">        Returns</span>
</span><span id="Lattice-1903"><a href="#Lattice-1903"><span class="linenos">1903</span></a><span class="sd">        -------</span>
</span><span id="Lattice-1904"><a href="#Lattice-1904"><span class="linenos">1904</span></a><span class="sd">        float | dict</span>
</span><span id="Lattice-1905"><a href="#Lattice-1905"><span class="linenos">1905</span></a><span class="sd">            Total volume if return_details is False, else a dict:</span>
</span><span id="Lattice-1906"><a href="#Lattice-1906"><span class="linenos">1906</span></a><span class="sd">            {&#39;total&#39;: float, &#39;per_entity&#39;: [(tag:int, volume:float), ...]}</span>
</span><span id="Lattice-1907"><a href="#Lattice-1907"><span class="linenos">1907</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1908"><a href="#Lattice-1908"><span class="linenos">1908</span></a>        <span class="k">if</span> <span class="n">synchronize</span><span class="p">:</span>
</span><span id="Lattice-1909"><a href="#Lattice-1909"><span class="linenos">1909</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="Lattice-1910"><a href="#Lattice-1910"><span class="linenos">1910</span></a>
</span><span id="Lattice-1911"><a href="#Lattice-1911"><span class="linenos">1911</span></a>        <span class="c1"># Default: all 3D solids present in the model</span>
</span><span id="Lattice-1912"><a href="#Lattice-1912"><span class="linenos">1912</span></a>        <span class="k">if</span> <span class="n">entities_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-1913"><a href="#Lattice-1913"><span class="linenos">1913</span></a>            <span class="n">entities_3d</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Lattice-1914"><a href="#Lattice-1914"><span class="linenos">1914</span></a>
</span><span id="Lattice-1915"><a href="#Lattice-1915"><span class="linenos">1915</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Lattice-1916"><a href="#Lattice-1916"><span class="linenos">1916</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice-1917"><a href="#Lattice-1917"><span class="linenos">1917</span></a>
</span><span id="Lattice-1918"><a href="#Lattice-1918"><span class="linenos">1918</span></a>        <span class="c1"># Guard against empty list</span>
</span><span id="Lattice-1919"><a href="#Lattice-1919"><span class="linenos">1919</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">entities_3d</span><span class="p">:</span>
</span><span id="Lattice-1920"><a href="#Lattice-1920"><span class="linenos">1920</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-1921"><a href="#Lattice-1921"><span class="linenos">1921</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_volume_mesh: no 3D entities found; volume = 0.0&quot;</span><span class="p">)</span>
</span><span id="Lattice-1922"><a href="#Lattice-1922"><span class="linenos">1922</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;per_entity&#39;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">if</span> <span class="n">return_details</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="Lattice-1923"><a href="#Lattice-1923"><span class="linenos">1923</span></a>
</span><span id="Lattice-1924"><a href="#Lattice-1924"><span class="linenos">1924</span></a>        <span class="c1"># Sum exact OCC &#39;mass&#39; (density=1 =&gt; mass == volume)</span>
</span><span id="Lattice-1925"><a href="#Lattice-1925"><span class="linenos">1925</span></a>        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">entities_3d</span><span class="p">:</span>
</span><span id="Lattice-1926"><a href="#Lattice-1926"><span class="linenos">1926</span></a>            <span class="c1"># Defensive: ensure correct dimension</span>
</span><span id="Lattice-1927"><a href="#Lattice-1927"><span class="linenos">1927</span></a>            <span class="k">if</span> <span class="n">dim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Lattice-1928"><a href="#Lattice-1928"><span class="linenos">1928</span></a>                <span class="k">continue</span>
</span><span id="Lattice-1929"><a href="#Lattice-1929"><span class="linenos">1929</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getMass</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
</span><span id="Lattice-1930"><a href="#Lattice-1930"><span class="linenos">1930</span></a>            <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
</span><span id="Lattice-1931"><a href="#Lattice-1931"><span class="linenos">1931</span></a>            <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
</span><span id="Lattice-1932"><a href="#Lattice-1932"><span class="linenos">1932</span></a>                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tag</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</span><span id="Lattice-1933"><a href="#Lattice-1933"><span class="linenos">1933</span></a>
</span><span id="Lattice-1934"><a href="#Lattice-1934"><span class="linenos">1934</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice-1935"><a href="#Lattice-1935"><span class="linenos">1935</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total volume: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Lattice-1936"><a href="#Lattice-1936"><span class="linenos">1936</span></a>
</span><span id="Lattice-1937"><a href="#Lattice-1937"><span class="linenos">1937</span></a>        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
</span><span id="Lattice-1938"><a href="#Lattice-1938"><span class="linenos">1938</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span> <span class="s1">&#39;per_entity&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">}</span>
</span><span id="Lattice-1939"><a href="#Lattice-1939"><span class="linenos">1939</span></a>        <span class="k">return</span> <span class="n">total</span>
</span><span id="Lattice-1940"><a href="#Lattice-1940"><span class="linenos">1940</span></a>
</span><span id="Lattice-1941"><a href="#Lattice-1941"><span class="linenos">1941</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;meshing&quot;</span><span class="p">)</span>
</span><span id="Lattice-1942"><a href="#Lattice-1942"><span class="linenos">1942</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice-1943"><a href="#Lattice-1943"><span class="linenos">1943</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solids_3d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">domain_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Lattice-1944"><a href="#Lattice-1944"><span class="linenos">1944</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice-1945"><a href="#Lattice-1945"><span class="linenos">1945</span></a><span class="sd">        Compute relative density = V_solid / V_domain using exact CAD volumes.</span>
</span><span id="Lattice-1946"><a href="#Lattice-1946"><span class="linenos">1946</span></a>
</span><span id="Lattice-1947"><a href="#Lattice-1947"><span class="linenos">1947</span></a><span class="sd">        If domain_volume is None, the domain is taken as the axis-aligned box</span>
</span><span id="Lattice-1948"><a href="#Lattice-1948"><span class="linenos">1948</span></a><span class="sd">        defined by (x_min..x_max) √ó (y_min..y_max) √ó (z_min..z_max).</span>
</span><span id="Lattice-1949"><a href="#Lattice-1949"><span class="linenos">1949</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice-1950"><a href="#Lattice-1950"><span class="linenos">1950</span></a>        <span class="n">V_solid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume_mesh</span><span class="p">(</span><span class="n">entities_3d</span><span class="o">=</span><span class="n">solids_3d</span><span class="p">,</span> <span class="n">synchronize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Lattice-1951"><a href="#Lattice-1951"><span class="linenos">1951</span></a>
</span><span id="Lattice-1952"><a href="#Lattice-1952"><span class="linenos">1952</span></a>        <span class="k">if</span> <span class="n">domain_volume</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice-1953"><a href="#Lattice-1953"><span class="linenos">1953</span></a>            <span class="n">Lx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span>
</span><span id="Lattice-1954"><a href="#Lattice-1954"><span class="linenos">1954</span></a>            <span class="n">Ly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span>
</span><span id="Lattice-1955"><a href="#Lattice-1955"><span class="linenos">1955</span></a>            <span class="n">Lz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span>
</span><span id="Lattice-1956"><a href="#Lattice-1956"><span class="linenos">1956</span></a>            <span class="n">V_domain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Lx</span> <span class="o">*</span> <span class="n">Ly</span> <span class="o">*</span> <span class="n">Lz</span><span class="p">)</span>
</span><span id="Lattice-1957"><a href="#Lattice-1957"><span class="linenos">1957</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice-1958"><a href="#Lattice-1958"><span class="linenos">1958</span></a>            <span class="n">V_domain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">domain_volume</span><span class="p">)</span>
</span><span id="Lattice-1959"><a href="#Lattice-1959"><span class="linenos">1959</span></a>
</span><span id="Lattice-1960"><a href="#Lattice-1960"><span class="linenos">1960</span></a>        <span class="k">if</span> <span class="n">V_domain</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice-1961"><a href="#Lattice-1961"><span class="linenos">1961</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;get_relative_density: domain volume must be positive.&quot;</span><span class="p">)</span>
</span><span id="Lattice-1962"><a href="#Lattice-1962"><span class="linenos">1962</span></a>        <span class="k">return</span> <span class="n">V_solid</span> <span class="o">/</span> <span class="n">V_domain</span>
</span></pre></div>


            <div class="docstring"><p>Class to generate lattice structures with various parameters and properties.</p>
</div>


                            <div id="Lattice.__init__" class="classattr">
                                        <input id="Lattice.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Lattice</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">name_file</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">mesh_trimmer</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span>)</span>

                <label class="view-source-button" for="Lattice.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.__init__-35"><a href="#Lattice.__init__-35"><span class="linenos"> 35</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mesh_trimmer</span><span class="p">:</span> <span class="s2">&quot;MeshTrimmer&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="Lattice.__init__-36"><a href="#Lattice.__init__-36"><span class="linenos"> 36</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.__init__-37"><a href="#Lattice.__init__-37"><span class="linenos"> 37</span></a><span class="sd">        Constructor from a JSON file to create a lattice object.</span>
</span><span id="Lattice.__init__-38"><a href="#Lattice.__init__-38"><span class="linenos"> 38</span></a>
</span><span id="Lattice.__init__-39"><a href="#Lattice.__init__-39"><span class="linenos"> 39</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.__init__-40"><a href="#Lattice.__init__-40"><span class="linenos"> 40</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.__init__-41"><a href="#Lattice.__init__-41"><span class="linenos"> 41</span></a><span class="sd">        name_file: str</span>
</span><span id="Lattice.__init__-42"><a href="#Lattice.__init__-42"><span class="linenos"> 42</span></a><span class="sd">            Name of the JSON file containing lattice parameters.</span>
</span><span id="Lattice.__init__-43"><a href="#Lattice.__init__-43"><span class="linenos"> 43</span></a>
</span><span id="Lattice.__init__-44"><a href="#Lattice.__init__-44"><span class="linenos"> 44</span></a><span class="sd">        mesh_trimmer: MeshTrimmer, optional</span>
</span><span id="Lattice.__init__-45"><a href="#Lattice.__init__-45"><span class="linenos"> 45</span></a><span class="sd">            MeshTrimmer object to trim the lattice.</span>
</span><span id="Lattice.__init__-46"><a href="#Lattice.__init__-46"><span class="linenos"> 46</span></a>
</span><span id="Lattice.__init__-47"><a href="#Lattice.__init__-47"><span class="linenos"> 47</span></a><span class="sd">        _verbose: int, optional</span>
</span><span id="Lattice.__init__-48"><a href="#Lattice.__init__-48"><span class="linenos"> 48</span></a><span class="sd">            Verbosity level for logging.</span>
</span><span id="Lattice.__init__-49"><a href="#Lattice.__init__-49"><span class="linenos"> 49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.__init__-50"><a href="#Lattice.__init__-50"><span class="linenos"> 50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span> <span class="o">=</span> <span class="n">mesh_trimmer</span>
</span><span id="Lattice.__init__-51"><a href="#Lattice.__init__-51"><span class="linenos"> 51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="Lattice.__init__-52"><a href="#Lattice.__init__-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timing</span> <span class="o">=</span> <span class="n">timing</span>
</span><span id="Lattice.__init__-53"><a href="#Lattice.__init__-53"><span class="linenos"> 53</span></a>
</span><span id="Lattice.__init__-54"><a href="#Lattice.__init__-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Lattice&quot;</span>
</span><span id="Lattice.__init__-55"><a href="#Lattice.__init__-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-56"><a href="#Lattice.__init__-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-57"><a href="#Lattice.__init__-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Lattice.__init__-58"><a href="#Lattice.__init__-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Lattice.__init__-59"><a href="#Lattice.__init__-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Lattice.__init__-60"><a href="#Lattice.__init__-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-61"><a href="#Lattice.__init__-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-62"><a href="#Lattice.__init__-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_randomness</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice.__init__-63"><a href="#Lattice.__init__-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">randomness_hybrid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-64"><a href="#Lattice.__init__-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-65"><a href="#Lattice.__init__-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-66"><a href="#Lattice.__init__-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-67"><a href="#Lattice.__init__-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-68"><a href="#Lattice.__init__-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-69"><a href="#Lattice.__init__-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Warning not working for graded structures</span>
</span><span id="Lattice.__init__-70"><a href="#Lattice.__init__-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_simulation_properties</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice.__init__-71"><a href="#Lattice.__init__-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice.__init__-72"><a href="#Lattice.__init__-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice.__init__-73"><a href="#Lattice.__init__-73"><span class="linenos"> 73</span></a>
</span><span id="Lattice.__init__-74"><a href="#Lattice.__init__-74"><span class="linenos"> 74</span></a>        <span class="c1"># Containers</span>
</span><span id="Lattice.__init__-75"><a href="#Lattice.__init__-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.__init__-76"><a href="#Lattice.__init__-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.__init__-77"><a href="#Lattice.__init__-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.__init__-78"><a href="#Lattice.__init__-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edge_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-79"><a href="#Lattice.__init__-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">face_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-80"><a href="#Lattice.__init__-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corner_tags</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-81"><a href="#Lattice.__init__-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lattice_dimension_dict</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-82"><a href="#Lattice.__init__-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-83"><a href="#Lattice.__init__-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_lattice</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.__init__-84"><a href="#Lattice.__init__-84"><span class="linenos"> 84</span></a>
</span><span id="Lattice.__init__-85"><a href="#Lattice.__init__-85"><span class="linenos"> 85</span></a>        <span class="c1"># Generate global structure</span>
</span><span id="Lattice.__init__-86"><a href="#Lattice.__init__-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">extract_parameters_from_json</span><span class="p">(</span><span class="n">name_file</span><span class="p">)</span>
</span><span id="Lattice.__init__-87"><a href="#Lattice.__init__-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_lattice</span><span class="p">()</span>
</span><span id="Lattice.__init__-88"><a href="#Lattice.__init__-88"><span class="linenos"> 88</span></a>
</span><span id="Lattice.__init__-89"><a href="#Lattice.__init__-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.__init__-90"><a href="#Lattice.__init__-90"><span class="linenos"> 90</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">apply_symmetry</span><span class="p">()</span>
</span><span id="Lattice.__init__-91"><a href="#Lattice.__init__-91"><span class="linenos"> 91</span></a>
</span><span id="Lattice.__init__-92"><a href="#Lattice.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_size_lattice</span><span class="p">()</span>
</span><span id="Lattice.__init__-93"><a href="#Lattice.__init__-93"><span class="linenos"> 93</span></a>
</span><span id="Lattice.__init__-94"><a href="#Lattice.__init__-94"><span class="linenos"> 94</span></a>        <span class="c1"># Generate important data for the lattice structure</span>
</span><span id="Lattice.__init__-95"><a href="#Lattice.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_tag_classification</span><span class="p">()</span>
</span><span id="Lattice.__init__-96"><a href="#Lattice.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_lattice_dimensions</span><span class="p">()</span>
</span><span id="Lattice.__init__-97"><a href="#Lattice.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice.__init__-98"><a href="#Lattice.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_cell_index</span><span class="p">()</span>
</span><span id="Lattice.__init__-99"><a href="#Lattice.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_cell_neighbours</span><span class="p">()</span>
</span><span id="Lattice.__init__-100"><a href="#Lattice.__init__-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="Lattice.__init__-101"><a href="#Lattice.__init__-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">apply_tag_all_point</span><span class="p">()</span>
</span><span id="Lattice.__init__-102"><a href="#Lattice.__init__-102"><span class="linenos">102</span></a>
</span><span id="Lattice.__init__-103"><a href="#Lattice.__init__-103"><span class="linenos">103</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_flag</span><span class="p">:</span>
</span><span id="Lattice.__init__-104"><a href="#Lattice.__init__-104"><span class="linenos">104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">are_cells_identical</span><span class="p">()</span>
</span><span id="Lattice.__init__-105"><a href="#Lattice.__init__-105"><span class="linenos">105</span></a>
</span><span id="Lattice.__init__-106"><a href="#Lattice.__init__-106"><span class="linenos">106</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.__init__-107"><a href="#Lattice.__init__-107"><span class="linenos">107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">print_statistics_lattice</span><span class="p">()</span>
</span><span id="Lattice.__init__-108"><a href="#Lattice.__init__-108"><span class="linenos">108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Constructor from a JSON file to create a lattice object.</p>

<h2 id="parameters">Parameters:</h2>

<p>name_file: str
    Name of the JSON file containing lattice parameters.</p>

<p>mesh_trimmer: MeshTrimmer, optional
    MeshTrimmer object to trim the lattice.</p>

<p>_verbose: int, optional
    Verbosity level for logging.</p>
</div>


                            </div>
                            <div id="Lattice.mesh_trimmer" class="classattr">
                                <div class="attr variable">
            <span class="name">mesh_trimmer</span>

        
    </div>
    <a class="headerlink" href="#Lattice.mesh_trimmer"></a>
    
    

                            </div>
                            <div id="Lattice.timing" class="classattr">
                                <div class="attr variable">
            <span class="name">timing</span>

        
    </div>
    <a class="headerlink" href="#Lattice.timing"></a>
    
    

                            </div>
                            <div id="Lattice.name_lattice" class="classattr">
                                <div class="attr variable">
            <span class="name">name_lattice</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#Lattice.name_lattice"></a>
    
    

                            </div>
                            <div id="Lattice.radii" class="classattr">
                                <div class="attr variable">
            <span class="name">radii</span>

        
    </div>
    <a class="headerlink" href="#Lattice.radii"></a>
    
    

                            </div>
                            <div id="Lattice.geom_types" class="classattr">
                                <div class="attr variable">
            <span class="name">geom_types</span>

        
    </div>
    <a class="headerlink" href="#Lattice.geom_types"></a>
    
    

                            </div>
                            <div id="Lattice.enable_randomness" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_randomness</span>

        
    </div>
    <a class="headerlink" href="#Lattice.enable_randomness"></a>
    
    

                            </div>
                            <div id="Lattice.randomness_hybrid" class="classattr">
                                <div class="attr variable">
            <span class="name">randomness_hybrid</span>

        
    </div>
    <a class="headerlink" href="#Lattice.randomness_hybrid"></a>
    
    

                            </div>
                            <div id="Lattice.range_radius" class="classattr">
                                <div class="attr variable">
            <span class="name">range_radius</span>

        
    </div>
    <a class="headerlink" href="#Lattice.range_radius"></a>
    
    

                            </div>
                            <div id="Lattice.symmetry_lattice" class="classattr">
                                <div class="attr variable">
            <span class="name">symmetry_lattice</span>

        
    </div>
    <a class="headerlink" href="#Lattice.symmetry_lattice"></a>
    
    

                            </div>
                            <div id="Lattice.uncertainty_node" class="classattr">
                                <div class="attr variable">
            <span class="name">uncertainty_node</span>

        
    </div>
    <a class="headerlink" href="#Lattice.uncertainty_node"></a>
    
    

                            </div>
                            <div id="Lattice.eraser_blocks" class="classattr">
                                <div class="attr variable">
            <span class="name">eraser_blocks</span>

        
    </div>
    <a class="headerlink" href="#Lattice.eraser_blocks"></a>
    
    

                            </div>
                            <div id="Lattice.enable_periodicity" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_periodicity</span>

        
    </div>
    <a class="headerlink" href="#Lattice.enable_periodicity"></a>
    
    

                            </div>
                            <div id="Lattice.enable_simulation_properties" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_simulation_properties</span>

        
    </div>
    <a class="headerlink" href="#Lattice.enable_simulation_properties"></a>
    
    

                            </div>
                            <div id="Lattice.cells" class="classattr">
                                <div class="attr variable">
            <span class="name">cells</span>

        
    </div>
    <a class="headerlink" href="#Lattice.cells"></a>
    
    

                            </div>
                            <div id="Lattice.beams" class="classattr">
                                <div class="attr variable">
            <span class="name">beams</span>

        
    </div>
    <a class="headerlink" href="#Lattice.beams"></a>
    
    

                            </div>
                            <div id="Lattice.nodes" class="classattr">
                                <div class="attr variable">
            <span class="name">nodes</span>

        
    </div>
    <a class="headerlink" href="#Lattice.nodes"></a>
    
    

                            </div>
                            <div id="Lattice.edge_tags" class="classattr">
                                <div class="attr variable">
            <span class="name">edge_tags</span>

        
    </div>
    <a class="headerlink" href="#Lattice.edge_tags"></a>
    
    

                            </div>
                            <div id="Lattice.face_tags" class="classattr">
                                <div class="attr variable">
            <span class="name">face_tags</span>

        
    </div>
    <a class="headerlink" href="#Lattice.face_tags"></a>
    
    

                            </div>
                            <div id="Lattice.corner_tags" class="classattr">
                                <div class="attr variable">
            <span class="name">corner_tags</span>

        
    </div>
    <a class="headerlink" href="#Lattice.corner_tags"></a>
    
    

                            </div>
                            <div id="Lattice.lattice_dimension_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">lattice_dimension_dict</span>

        
    </div>
    <a class="headerlink" href="#Lattice.lattice_dimension_dict"></a>
    
    

                            </div>
                            <div id="Lattice.occupancy_matrix" class="classattr">
                                <div class="attr variable">
            <span class="name">occupancy_matrix</span>

        
    </div>
    <a class="headerlink" href="#Lattice.occupancy_matrix"></a>
    
    

                            </div>
                            <div id="Lattice.mesh_lattice" class="classattr">
                                <div class="attr variable">
            <span class="name">mesh_lattice</span>

        
    </div>
    <a class="headerlink" href="#Lattice.mesh_lattice"></a>
    
    

                            </div>
                            <div id="Lattice.open_pickle_lattice" class="classattr">
                                        <input id="Lattice.open_pickle_lattice-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">open_pickle_lattice</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;LatticeObject&#39;</span>,</span><span class="param">	<span class="n">sim_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#Lattice">Lattice</a></span>:</span></span>

                <label class="view-source-button" for="Lattice.open_pickle_lattice-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.open_pickle_lattice"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.open_pickle_lattice-110"><a href="#Lattice.open_pickle_lattice-110"><span class="linenos">110</span></a>    <span class="nd">@classmethod</span>
</span><span id="Lattice.open_pickle_lattice-111"><a href="#Lattice.open_pickle_lattice-111"><span class="linenos">111</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">open_pickle_lattice</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;LatticeObject&quot;</span><span class="p">,</span> <span class="n">sim_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Lattice&quot;</span><span class="p">:</span>
</span><span id="Lattice.open_pickle_lattice-112"><a href="#Lattice.open_pickle_lattice-112"><span class="linenos">112</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.open_pickle_lattice-113"><a href="#Lattice.open_pickle_lattice-113"><span class="linenos">113</span></a><span class="sd">        Load a lattice pickle and (optionally) upcast it to the caller&#39;s class (e.g., LatticeSim).</span>
</span><span id="Lattice.open_pickle_lattice-114"><a href="#Lattice.open_pickle_lattice-114"><span class="linenos">114</span></a><span class="sd">        If the target class defines `_post_load_init`, it will be invoked after loading.</span>
</span><span id="Lattice.open_pickle_lattice-115"><a href="#Lattice.open_pickle_lattice-115"><span class="linenos">115</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.open_pickle_lattice-116"><a href="#Lattice.open_pickle_lattice-116"><span class="linenos">116</span></a>        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Lattice.open_pickle_lattice-117"><a href="#Lattice.open_pickle_lattice-117"><span class="linenos">117</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;outputs&quot;</span> <span class="o">/</span> <span class="s2">&quot;saved_lattice_file&quot;</span> <span class="o">/</span> <span class="n">file_name</span>
</span><span id="Lattice.open_pickle_lattice-118"><a href="#Lattice.open_pickle_lattice-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">:</span>
</span><span id="Lattice.open_pickle_lattice-119"><a href="#Lattice.open_pickle_lattice-119"><span class="linenos">119</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-120"><a href="#Lattice.open_pickle_lattice-120"><span class="linenos">120</span></a>
</span><span id="Lattice.open_pickle_lattice-121"><a href="#Lattice.open_pickle_lattice-121"><span class="linenos">121</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="Lattice.open_pickle_lattice-122"><a href="#Lattice.open_pickle_lattice-122"><span class="linenos">122</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-123"><a href="#Lattice.open_pickle_lattice-123"><span class="linenos">123</span></a>
</span><span id="Lattice.open_pickle_lattice-124"><a href="#Lattice.open_pickle_lattice-124"><span class="linenos">124</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice.open_pickle_lattice-125"><a href="#Lattice.open_pickle_lattice-125"><span class="linenos">125</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Lattice.open_pickle_lattice-126"><a href="#Lattice.open_pickle_lattice-126"><span class="linenos">126</span></a>                <span class="n">lattice</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-127"><a href="#Lattice.open_pickle_lattice-127"><span class="linenos">127</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Lattice.open_pickle_lattice-128"><a href="#Lattice.open_pickle_lattice-128"><span class="linenos">128</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load lattice from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-129"><a href="#Lattice.open_pickle_lattice-129"><span class="linenos">129</span></a>
</span><span id="Lattice.open_pickle_lattice-130"><a href="#Lattice.open_pickle_lattice-130"><span class="linenos">130</span></a>        <span class="c1"># Normalize containers</span>
</span><span id="Lattice.open_pickle_lattice-131"><a href="#Lattice.open_pickle_lattice-131"><span class="linenos">131</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice.open_pickle_lattice-132"><a href="#Lattice.open_pickle_lattice-132"><span class="linenos">132</span></a>            <span class="n">lattice</span><span class="o">.</span><span class="n">beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-133"><a href="#Lattice.open_pickle_lattice-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice.open_pickle_lattice-134"><a href="#Lattice.open_pickle_lattice-134"><span class="linenos">134</span></a>            <span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-135"><a href="#Lattice.open_pickle_lattice-135"><span class="linenos">135</span></a>
</span><span id="Lattice.open_pickle_lattice-136"><a href="#Lattice.open_pickle_lattice-136"><span class="linenos">136</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.open_pickle_lattice-137"><a href="#Lattice.open_pickle_lattice-137"><span class="linenos">137</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice.open_pickle_lattice-138"><a href="#Lattice.open_pickle_lattice-138"><span class="linenos">138</span></a>                <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-139"><a href="#Lattice.open_pickle_lattice-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;points_cell&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice.open_pickle_lattice-140"><a href="#Lattice.open_pickle_lattice-140"><span class="linenos">140</span></a>                <span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-141"><a href="#Lattice.open_pickle_lattice-141"><span class="linenos">141</span></a>
</span><span id="Lattice.open_pickle_lattice-142"><a href="#Lattice.open_pickle_lattice-142"><span class="linenos">142</span></a>        <span class="n">lattice</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice.open_pickle_lattice-143"><a href="#Lattice.open_pickle_lattice-143"><span class="linenos">143</span></a>
</span><span id="Lattice.open_pickle_lattice-144"><a href="#Lattice.open_pickle_lattice-144"><span class="linenos">144</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lattice</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice.open_pickle_lattice-145"><a href="#Lattice.open_pickle_lattice-145"><span class="linenos">145</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.open_pickle_lattice-146"><a href="#Lattice.open_pickle_lattice-146"><span class="linenos">146</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.open_pickle_lattice-147"><a href="#Lattice.open_pickle_lattice-147"><span class="linenos">147</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice.open_pickle_lattice-148"><a href="#Lattice.open_pickle_lattice-148"><span class="linenos">148</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-149"><a href="#Lattice.open_pickle_lattice-149"><span class="linenos">149</span></a>
</span><span id="Lattice.open_pickle_lattice-150"><a href="#Lattice.open_pickle_lattice-150"><span class="linenos">150</span></a>        <span class="c1"># --- upcast to the caller class if needed (e.g., LatticeSim) ---</span>
</span><span id="Lattice.open_pickle_lattice-151"><a href="#Lattice.open_pickle_lattice-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Lattice</span><span class="p">):</span>
</span><span id="Lattice.open_pickle_lattice-152"><a href="#Lattice.open_pickle_lattice-152"><span class="linenos">152</span></a>            <span class="n">upgraded</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span id="Lattice.open_pickle_lattice-153"><a href="#Lattice.open_pickle_lattice-153"><span class="linenos">153</span></a>            <span class="n">upgraded</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-154"><a href="#Lattice.open_pickle_lattice-154"><span class="linenos">154</span></a>            <span class="n">lattice</span> <span class="o">=</span> <span class="n">upgraded</span>
</span><span id="Lattice.open_pickle_lattice-155"><a href="#Lattice.open_pickle_lattice-155"><span class="linenos">155</span></a>            <span class="n">post</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;_post_load_init&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-156"><a href="#Lattice.open_pickle_lattice-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">post</span><span class="p">):</span>
</span><span id="Lattice.open_pickle_lattice-157"><a href="#Lattice.open_pickle_lattice-157"><span class="linenos">157</span></a>                <span class="n">post</span><span class="p">(</span><span class="n">sim_config</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-158"><a href="#Lattice.open_pickle_lattice-158"><span class="linenos">158</span></a>
</span><span id="Lattice.open_pickle_lattice-159"><a href="#Lattice.open_pickle_lattice-159"><span class="linenos">159</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lattice loaded successfully from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Lattice.open_pickle_lattice-160"><a href="#Lattice.open_pickle_lattice-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="n">lattice</span>
</span></pre></div>


            <div class="docstring"><p>Load a lattice pickle and (optionally) upcast it to the caller's class (e.g., LatticeSim).
If the target class defines <code>_post_load_init</code>, it will be invoked after loading.</p>
</div>


                            </div>
                            <div id="Lattice.get_number_cells" class="classattr">
                                        <input id="Lattice.get_number_cells-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_number_cells</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_number_cells-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_number_cells"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_number_cells-197"><a href="#Lattice.get_number_cells-197"><span class="linenos">197</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Lattice.get_number_cells-198"><a href="#Lattice.get_number_cells-198"><span class="linenos">198</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of cells in the lattice&quot;&quot;&quot;</span>
</span><span id="Lattice.get_number_cells-199"><a href="#Lattice.get_number_cells-199"><span class="linenos">199</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get number of cells in the lattice</p>
</div>


                            </div>
                            <div id="Lattice.get_number_beams" class="classattr">
                                        <input id="Lattice.get_number_beams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_number_beams</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_number_beams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_number_beams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_number_beams-201"><a href="#Lattice.get_number_beams-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Lattice.get_number_beams-202"><a href="#Lattice.get_number_beams-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of beams in the lattice&quot;&quot;&quot;</span>
</span><span id="Lattice.get_number_beams-203"><a href="#Lattice.get_number_beams-203"><span class="linenos">203</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get number of beams in the lattice</p>
</div>


                            </div>
                            <div id="Lattice.get_number_nodes" class="classattr">
                                        <input id="Lattice.get_number_nodes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_number_nodes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_number_nodes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_number_nodes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_number_nodes-205"><a href="#Lattice.get_number_nodes-205"><span class="linenos">205</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Lattice.get_number_nodes-206"><a href="#Lattice.get_number_nodes-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of nodes in the lattice&quot;&quot;&quot;</span>
</span><span id="Lattice.get_number_nodes-207"><a href="#Lattice.get_number_nodes-207"><span class="linenos">207</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get number of nodes in the lattice</p>
</div>


                            </div>
                            <div id="Lattice.extract_parameters_from_json" class="classattr">
                                        <input id="Lattice.extract_parameters_from_json-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;initialization&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">extract_parameters_from_json</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name_file</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Lattice.extract_parameters_from_json-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.extract_parameters_from_json"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.extract_parameters_from_json-209"><a href="#Lattice.extract_parameters_from_json-209"><span class="linenos">209</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;initialization&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-210"><a href="#Lattice.extract_parameters_from_json-210"><span class="linenos">210</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.extract_parameters_from_json-211"><a href="#Lattice.extract_parameters_from_json-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">extract_parameters_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Lattice.extract_parameters_from_json-212"><a href="#Lattice.extract_parameters_from_json-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.extract_parameters_from_json-213"><a href="#Lattice.extract_parameters_from_json-213"><span class="linenos">213</span></a><span class="sd">        Extract lattice parameters from a JSON file and set the corresponding attributes.</span>
</span><span id="Lattice.extract_parameters_from_json-214"><a href="#Lattice.extract_parameters_from_json-214"><span class="linenos">214</span></a>
</span><span id="Lattice.extract_parameters_from_json-215"><a href="#Lattice.extract_parameters_from_json-215"><span class="linenos">215</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.extract_parameters_from_json-216"><a href="#Lattice.extract_parameters_from_json-216"><span class="linenos">216</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.extract_parameters_from_json-217"><a href="#Lattice.extract_parameters_from_json-217"><span class="linenos">217</span></a><span class="sd">        name_file: str</span>
</span><span id="Lattice.extract_parameters_from_json-218"><a href="#Lattice.extract_parameters_from_json-218"><span class="linenos">218</span></a><span class="sd">            Name of the JSON file containing lattice parameters.</span>
</span><span id="Lattice.extract_parameters_from_json-219"><a href="#Lattice.extract_parameters_from_json-219"><span class="linenos">219</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.extract_parameters_from_json-220"><a href="#Lattice.extract_parameters_from_json-220"><span class="linenos">220</span></a>        <span class="n">lattice_parameters</span> <span class="o">=</span> <span class="n">open_lattice_parameters</span><span class="p">(</span><span class="n">name_file</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-221"><a href="#Lattice.extract_parameters_from_json-221"><span class="linenos">221</span></a>
</span><span id="Lattice.extract_parameters_from_json-222"><a href="#Lattice.extract_parameters_from_json-222"><span class="linenos">222</span></a>        <span class="c1"># Geometry</span>
</span><span id="Lattice.extract_parameters_from_json-223"><a href="#Lattice.extract_parameters_from_json-223"><span class="linenos">223</span></a>        <span class="n">geometry</span> <span class="o">=</span> <span class="n">lattice_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-224"><a href="#Lattice.extract_parameters_from_json-224"><span class="linenos">224</span></a>        <span class="n">cell_size</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_size&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-225"><a href="#Lattice.extract_parameters_from_json-225"><span class="linenos">225</span></a>        <span class="n">number_of_cells</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number_of_cells&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-226"><a href="#Lattice.extract_parameters_from_json-226"><span class="linenos">226</span></a>
</span><span id="Lattice.extract_parameters_from_json-227"><a href="#Lattice.extract_parameters_from_json-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span> <span class="o">=</span> <span class="n">cell_size</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-228"><a href="#Lattice.extract_parameters_from_json-228"><span class="linenos">228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span> <span class="o">=</span> <span class="n">cell_size</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-229"><a href="#Lattice.extract_parameters_from_json-229"><span class="linenos">229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span> <span class="o">=</span> <span class="n">cell_size</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-230"><a href="#Lattice.extract_parameters_from_json-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span> <span class="o">=</span> <span class="n">number_of_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-231"><a href="#Lattice.extract_parameters_from_json-231"><span class="linenos">231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span> <span class="o">=</span> <span class="n">number_of_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-232"><a href="#Lattice.extract_parameters_from_json-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span> <span class="o">=</span> <span class="n">number_of_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-233"><a href="#Lattice.extract_parameters_from_json-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;radii&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-234"><a href="#Lattice.extract_parameters_from_json-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geom_types&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-235"><a href="#Lattice.extract_parameters_from_json-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_randomness</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_randomness&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-236"><a href="#Lattice.extract_parameters_from_json-236"><span class="linenos">236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;range_radius&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
</span><span id="Lattice.extract_parameters_from_json-237"><a href="#Lattice.extract_parameters_from_json-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">randomness_hybrid</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;randomness_hybrid&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-238"><a href="#Lattice.extract_parameters_from_json-238"><span class="linenos">238</span></a>
</span><span id="Lattice.extract_parameters_from_json-239"><a href="#Lattice.extract_parameters_from_json-239"><span class="linenos">239</span></a>        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="p">,</span>
</span><span id="Lattice.extract_parameters_from_json-240"><a href="#Lattice.extract_parameters_from_json-240"><span class="linenos">240</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span>
</span><span id="Lattice.extract_parameters_from_json-241"><a href="#Lattice.extract_parameters_from_json-241"><span class="linenos">241</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">]:</span>
</span><span id="Lattice.extract_parameters_from_json-242"><a href="#Lattice.extract_parameters_from_json-242"><span class="linenos">242</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing geometry parameters in JSON file.&quot;</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-243"><a href="#Lattice.extract_parameters_from_json-243"><span class="linenos">243</span></a>
</span><span id="Lattice.extract_parameters_from_json-244"><a href="#Lattice.extract_parameters_from_json-244"><span class="linenos">244</span></a>        <span class="c1"># Gradient</span>
</span><span id="Lattice.extract_parameters_from_json-245"><a href="#Lattice.extract_parameters_from_json-245"><span class="linenos">245</span></a>        <span class="n">gradient</span> <span class="o">=</span> <span class="n">lattice_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gradient&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-246"><a href="#Lattice.extract_parameters_from_json-246"><span class="linenos">246</span></a>        <span class="n">radius_grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;radii&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-247"><a href="#Lattice.extract_parameters_from_json-247"><span class="linenos">247</span></a>        <span class="n">dim_grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_dimension&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-248"><a href="#Lattice.extract_parameters_from_json-248"><span class="linenos">248</span></a>        <span class="n">mat_grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-249"><a href="#Lattice.extract_parameters_from_json-249"><span class="linenos">249</span></a>
</span><span id="Lattice.extract_parameters_from_json-250"><a href="#Lattice.extract_parameters_from_json-250"><span class="linenos">250</span></a>        <span class="n">grad_radius_property</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Lattice.extract_parameters_from_json-251"><a href="#Lattice.extract_parameters_from_json-251"><span class="linenos">251</span></a>            <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">,</span> <span class="s2">&quot;constant&quot;</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-252"><a href="#Lattice.extract_parameters_from_json-252"><span class="linenos">252</span></a>            <span class="p">[</span><span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_x&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-253"><a href="#Lattice.extract_parameters_from_json-253"><span class="linenos">253</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_y&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-254"><a href="#Lattice.extract_parameters_from_json-254"><span class="linenos">254</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_z&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
</span><span id="Lattice.extract_parameters_from_json-255"><a href="#Lattice.extract_parameters_from_json-255"><span class="linenos">255</span></a>            <span class="p">[</span><span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-256"><a href="#Lattice.extract_parameters_from_json-256"><span class="linenos">256</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-257"><a href="#Lattice.extract_parameters_from_json-257"><span class="linenos">257</span></a>             <span class="n">radius_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
</span><span id="Lattice.extract_parameters_from_json-258"><a href="#Lattice.extract_parameters_from_json-258"><span class="linenos">258</span></a>        <span class="p">]</span>
</span><span id="Lattice.extract_parameters_from_json-259"><a href="#Lattice.extract_parameters_from_json-259"><span class="linenos">259</span></a>
</span><span id="Lattice.extract_parameters_from_json-260"><a href="#Lattice.extract_parameters_from_json-260"><span class="linenos">260</span></a>        <span class="n">grad_dim_property</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Lattice.extract_parameters_from_json-261"><a href="#Lattice.extract_parameters_from_json-261"><span class="linenos">261</span></a>            <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">,</span> <span class="s2">&quot;constant&quot;</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-262"><a href="#Lattice.extract_parameters_from_json-262"><span class="linenos">262</span></a>            <span class="p">[</span><span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_x&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-263"><a href="#Lattice.extract_parameters_from_json-263"><span class="linenos">263</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_y&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-264"><a href="#Lattice.extract_parameters_from_json-264"><span class="linenos">264</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction_z&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
</span><span id="Lattice.extract_parameters_from_json-265"><a href="#Lattice.extract_parameters_from_json-265"><span class="linenos">265</span></a>            <span class="p">[</span><span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-266"><a href="#Lattice.extract_parameters_from_json-266"><span class="linenos">266</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-267"><a href="#Lattice.extract_parameters_from_json-267"><span class="linenos">267</span></a>             <span class="n">dim_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter_z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
</span><span id="Lattice.extract_parameters_from_json-268"><a href="#Lattice.extract_parameters_from_json-268"><span class="linenos">268</span></a>        <span class="p">]</span>
</span><span id="Lattice.extract_parameters_from_json-269"><a href="#Lattice.extract_parameters_from_json-269"><span class="linenos">269</span></a>
</span><span id="Lattice.extract_parameters_from_json-270"><a href="#Lattice.extract_parameters_from_json-270"><span class="linenos">270</span></a>        <span class="n">grad_mat_property</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Lattice.extract_parameters_from_json-271"><a href="#Lattice.extract_parameters_from_json-271"><span class="linenos">271</span></a>            <span class="n">mat_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type_beam&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-272"><a href="#Lattice.extract_parameters_from_json-272"><span class="linenos">272</span></a>            <span class="n">mat_grad</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-273"><a href="#Lattice.extract_parameters_from_json-273"><span class="linenos">273</span></a>        <span class="p">]</span>
</span><span id="Lattice.extract_parameters_from_json-274"><a href="#Lattice.extract_parameters_from_json-274"><span class="linenos">274</span></a>
</span><span id="Lattice.extract_parameters_from_json-275"><a href="#Lattice.extract_parameters_from_json-275"><span class="linenos">275</span></a>        <span class="c1"># Supplementary</span>
</span><span id="Lattice.extract_parameters_from_json-276"><a href="#Lattice.extract_parameters_from_json-276"><span class="linenos">276</span></a>        <span class="n">supplementary</span> <span class="o">=</span> <span class="n">lattice_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;supplementary&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-277"><a href="#Lattice.extract_parameters_from_json-277"><span class="linenos">277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span> <span class="o">=</span> <span class="n">supplementary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_uncertainty&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-278"><a href="#Lattice.extract_parameters_from_json-278"><span class="linenos">278</span></a>
</span><span id="Lattice.extract_parameters_from_json-279"><a href="#Lattice.extract_parameters_from_json-279"><span class="linenos">279</span></a>        <span class="c1"># Erased blocks</span>
</span><span id="Lattice.extract_parameters_from_json-280"><a href="#Lattice.extract_parameters_from_json-280"><span class="linenos">280</span></a>        <span class="n">erased_blocks_json</span> <span class="o">=</span> <span class="n">supplementary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;erased_blocks&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-281"><a href="#Lattice.extract_parameters_from_json-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.extract_parameters_from_json-282"><a href="#Lattice.extract_parameters_from_json-282"><span class="linenos">282</span></a>        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">erased_blocks_json</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Lattice.extract_parameters_from_json-283"><a href="#Lattice.extract_parameters_from_json-283"><span class="linenos">283</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_point&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-284"><a href="#Lattice.extract_parameters_from_json-284"><span class="linenos">284</span></a>            <span class="n">dim</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimensions_block&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-285"><a href="#Lattice.extract_parameters_from_json-285"><span class="linenos">285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
</span><span id="Lattice.extract_parameters_from_json-286"><a href="#Lattice.extract_parameters_from_json-286"><span class="linenos">286</span></a>                <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-287"><a href="#Lattice.extract_parameters_from_json-287"><span class="linenos">287</span></a>                <span class="n">dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-288"><a href="#Lattice.extract_parameters_from_json-288"><span class="linenos">288</span></a>            <span class="p">])</span>
</span><span id="Lattice.extract_parameters_from_json-289"><a href="#Lattice.extract_parameters_from_json-289"><span class="linenos">289</span></a>
</span><span id="Lattice.extract_parameters_from_json-290"><a href="#Lattice.extract_parameters_from_json-290"><span class="linenos">290</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.extract_parameters_from_json-291"><a href="#Lattice.extract_parameters_from_json-291"><span class="linenos">291</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.extract_parameters_from_json-292"><a href="#Lattice.extract_parameters_from_json-292"><span class="linenos">292</span></a>
</span><span id="Lattice.extract_parameters_from_json-293"><a href="#Lattice.extract_parameters_from_json-293"><span class="linenos">293</span></a>        <span class="c1"># Symmetry</span>
</span><span id="Lattice.extract_parameters_from_json-294"><a href="#Lattice.extract_parameters_from_json-294"><span class="linenos">294</span></a>        <span class="n">symmetries</span> <span class="o">=</span> <span class="n">supplementary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;symmetries&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-295"><a href="#Lattice.extract_parameters_from_json-295"><span class="linenos">295</span></a>        <span class="k">if</span> <span class="n">symmetries</span><span class="p">:</span>
</span><span id="Lattice.extract_parameters_from_json-296"><a href="#Lattice.extract_parameters_from_json-296"><span class="linenos">296</span></a>            <span class="n">sym_plane</span> <span class="o">=</span> <span class="n">symmetries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plane&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-297"><a href="#Lattice.extract_parameters_from_json-297"><span class="linenos">297</span></a>            <span class="n">sym_point</span> <span class="o">=</span> <span class="n">symmetries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reference_point&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Lattice.extract_parameters_from_json-298"><a href="#Lattice.extract_parameters_from_json-298"><span class="linenos">298</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Lattice.extract_parameters_from_json-299"><a href="#Lattice.extract_parameters_from_json-299"><span class="linenos">299</span></a>                <span class="s2">&quot;sym_plane&quot;</span><span class="p">:</span> <span class="n">sym_plane</span><span class="p">,</span>
</span><span id="Lattice.extract_parameters_from_json-300"><a href="#Lattice.extract_parameters_from_json-300"><span class="linenos">300</span></a>                <span class="s2">&quot;sym_point&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">sym_point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-301"><a href="#Lattice.extract_parameters_from_json-301"><span class="linenos">301</span></a>                              <span class="n">sym_point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice.extract_parameters_from_json-302"><a href="#Lattice.extract_parameters_from_json-302"><span class="linenos">302</span></a>                              <span class="n">sym_point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span id="Lattice.extract_parameters_from_json-303"><a href="#Lattice.extract_parameters_from_json-303"><span class="linenos">303</span></a>            <span class="p">}</span>
</span><span id="Lattice.extract_parameters_from_json-304"><a href="#Lattice.extract_parameters_from_json-304"><span class="linenos">304</span></a>
</span><span id="Lattice.extract_parameters_from_json-305"><a href="#Lattice.extract_parameters_from_json-305"><span class="linenos">305</span></a>        <span class="n">_validate_inputs_lattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span>
</span><span id="Lattice.extract_parameters_from_json-306"><a href="#Lattice.extract_parameters_from_json-306"><span class="linenos">306</span></a>                                 <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span>
</span><span id="Lattice.extract_parameters_from_json-307"><a href="#Lattice.extract_parameters_from_json-307"><span class="linenos">307</span></a>                                 <span class="n">grad_radius_property</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">,</span> <span class="n">grad_mat_property</span><span class="p">,</span>
</span><span id="Lattice.extract_parameters_from_json-308"><a href="#Lattice.extract_parameters_from_json-308"><span class="linenos">308</span></a>                                 <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="p">)</span>
</span><span id="Lattice.extract_parameters_from_json-309"><a href="#Lattice.extract_parameters_from_json-309"><span class="linenos">309</span></a>
</span><span id="Lattice.extract_parameters_from_json-310"><a href="#Lattice.extract_parameters_from_json-310"><span class="linenos">310</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_gradient</span><span class="p">(</span><span class="n">grad_radius_property</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">,</span> <span class="n">grad_mat_property</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Extract lattice parameters from a JSON file and set the corresponding attributes.</p>

<h2 id="parameters">Parameters:</h2>

<p>name_file: str
    Name of the JSON file containing lattice parameters.</p>
</div>


                            </div>
                            <div id="Lattice.get_lattice_boundary_box" class="classattr">
                                        <input id="Lattice.get_lattice_boundary_box-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_lattice_boundary_box</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_lattice_boundary_box-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_lattice_boundary_box"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_lattice_boundary_box-312"><a href="#Lattice.get_lattice_boundary_box-312"><span class="linenos">312</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_lattice_boundary_box-313"><a href="#Lattice.get_lattice_boundary_box-313"><span class="linenos">313</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_lattice_boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
</span><span id="Lattice.get_lattice_boundary_box-314"><a href="#Lattice.get_lattice_boundary_box-314"><span class="linenos">314</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_lattice_boundary_box-315"><a href="#Lattice.get_lattice_boundary_box-315"><span class="linenos">315</span></a><span class="sd">        Get the boundary box of the lattice</span>
</span><span id="Lattice.get_lattice_boundary_box-316"><a href="#Lattice.get_lattice_boundary_box-316"><span class="linenos">316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_lattice_boundary_box-317"><a href="#Lattice.get_lattice_boundary_box-317"><span class="linenos">317</span></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Get the boundary box of the lattice</p>
</div>


                            </div>
                            <div id="Lattice.define_lattice_dimensions" class="classattr">
                                        <input id="Lattice.define_lattice_dimensions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_lattice_dimensions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="Lattice.define_lattice_dimensions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.define_lattice_dimensions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.define_lattice_dimensions-319"><a href="#Lattice.define_lattice_dimensions-319"><span class="linenos">319</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_lattice_dimensions-320"><a href="#Lattice.define_lattice_dimensions-320"><span class="linenos">320</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_lattice_dimensions-321"><a href="#Lattice.define_lattice_dimensions-321"><span class="linenos">321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_lattice_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Lattice.define_lattice_dimensions-322"><a href="#Lattice.define_lattice_dimensions-322"><span class="linenos">322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_lattice_dimensions-323"><a href="#Lattice.define_lattice_dimensions-323"><span class="linenos">323</span></a><span class="sd">        Computes extremum values of coordinates in the lattice.</span>
</span><span id="Lattice.define_lattice_dimensions-324"><a href="#Lattice.define_lattice_dimensions-324"><span class="linenos">324</span></a>
</span><span id="Lattice.define_lattice_dimensions-325"><a href="#Lattice.define_lattice_dimensions-325"><span class="linenos">325</span></a><span class="sd">        Return:</span>
</span><span id="Lattice.define_lattice_dimensions-326"><a href="#Lattice.define_lattice_dimensions-326"><span class="linenos">326</span></a><span class="sd">        --------</span>
</span><span id="Lattice.define_lattice_dimensions-327"><a href="#Lattice.define_lattice_dimensions-327"><span class="linenos">327</span></a><span class="sd">        lattice_dimension_dict: dict</span>
</span><span id="Lattice.define_lattice_dimensions-328"><a href="#Lattice.define_lattice_dimensions-328"><span class="linenos">328</span></a><span class="sd">            Dictionary containing min and max values for x, y, z coordinates.</span>
</span><span id="Lattice.define_lattice_dimensions-329"><a href="#Lattice.define_lattice_dimensions-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.define_lattice_dimensions-330"><a href="#Lattice.define_lattice_dimensions-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice.define_lattice_dimensions-331"><a href="#Lattice.define_lattice_dimensions-331"><span class="linenos">331</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No nodes in the lattice.&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_lattice_dimensions-332"><a href="#Lattice.define_lattice_dimensions-332"><span class="linenos">332</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="Lattice.define_lattice_dimensions-333"><a href="#Lattice.define_lattice_dimensions-333"><span class="linenos">333</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="Lattice.define_lattice_dimensions-334"><a href="#Lattice.define_lattice_dimensions-334"><span class="linenos">334</span></a>        <span class="n">zs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span><span id="Lattice.define_lattice_dimensions-335"><a href="#Lattice.define_lattice_dimensions-335"><span class="linenos">335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="Lattice.define_lattice_dimensions-336"><a href="#Lattice.define_lattice_dimensions-336"><span class="linenos">336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span><span id="Lattice.define_lattice_dimensions-337"><a href="#Lattice.define_lattice_dimensions-337"><span class="linenos">337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
</span><span id="Lattice.define_lattice_dimensions-338"><a href="#Lattice.define_lattice_dimensions-338"><span class="linenos">338</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lattice_dimension_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Lattice.define_lattice_dimensions-339"><a href="#Lattice.define_lattice_dimensions-339"><span class="linenos">339</span></a>            <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
</span><span id="Lattice.define_lattice_dimensions-340"><a href="#Lattice.define_lattice_dimensions-340"><span class="linenos">340</span></a>            <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
</span><span id="Lattice.define_lattice_dimensions-341"><a href="#Lattice.define_lattice_dimensions-341"><span class="linenos">341</span></a>            <span class="s2">&quot;z_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span><span class="p">,</span> <span class="s2">&quot;z_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span><span class="p">,</span>
</span><span id="Lattice.define_lattice_dimensions-342"><a href="#Lattice.define_lattice_dimensions-342"><span class="linenos">342</span></a>        <span class="p">}</span>
</span><span id="Lattice.define_lattice_dimensions-343"><a href="#Lattice.define_lattice_dimensions-343"><span class="linenos">343</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice_dimension_dict</span>
</span></pre></div>


            <div class="docstring"><p>Computes extremum values of coordinates in the lattice.</p>

<h2 id="return">Return:</h2>

<p>lattice_dimension_dict: dict
    Dictionary containing min and max values for x, y, z coordinates.</p>
</div>


                            </div>
                            <div id="Lattice.get_relative_density" class="classattr">
                                        <input id="Lattice.get_relative_density-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_relative_density</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_relative_density-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_relative_density"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_relative_density-345"><a href="#Lattice.get_relative_density-345"><span class="linenos">345</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Lattice.get_relative_density-346"><a href="#Lattice.get_relative_density-346"><span class="linenos">346</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_relative_density-347"><a href="#Lattice.get_relative_density-347"><span class="linenos">347</span></a><span class="sd">        Get mean relative density of all cells in lattice</span>
</span><span id="Lattice.get_relative_density-348"><a href="#Lattice.get_relative_density-348"><span class="linenos">348</span></a><span class="sd">        Simple average of cell relative densities</span>
</span><span id="Lattice.get_relative_density-349"><a href="#Lattice.get_relative_density-349"><span class="linenos">349</span></a>
</span><span id="Lattice.get_relative_density-350"><a href="#Lattice.get_relative_density-350"><span class="linenos">350</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice.get_relative_density-351"><a href="#Lattice.get_relative_density-351"><span class="linenos">351</span></a><span class="sd">        --------</span>
</span><span id="Lattice.get_relative_density-352"><a href="#Lattice.get_relative_density-352"><span class="linenos">352</span></a><span class="sd">        meanRelDens: float</span>
</span><span id="Lattice.get_relative_density-353"><a href="#Lattice.get_relative_density-353"><span class="linenos">353</span></a><span class="sd">            Mean relative density of the lattice</span>
</span><span id="Lattice.get_relative_density-354"><a href="#Lattice.get_relative_density-354"><span class="linenos">354</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_relative_density-355"><a href="#Lattice.get_relative_density-355"><span class="linenos">355</span></a>        <span class="n">cellRelDens</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.get_relative_density-356"><a href="#Lattice.get_relative_density-356"><span class="linenos">356</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.get_relative_density-357"><a href="#Lattice.get_relative_density-357"><span class="linenos">357</span></a>            <span class="n">cellRelDens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">relative_density</span><span class="p">)</span>
</span><span id="Lattice.get_relative_density-358"><a href="#Lattice.get_relative_density-358"><span class="linenos">358</span></a>        <span class="n">meanRelDens</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">cellRelDens</span><span class="p">)</span>
</span><span id="Lattice.get_relative_density-359"><a href="#Lattice.get_relative_density-359"><span class="linenos">359</span></a>        <span class="k">return</span> <span class="n">meanRelDens</span>
</span></pre></div>


            <div class="docstring"><p>Get mean relative density of all cells in lattice
Simple average of cell relative densities</p>

<h2 id="returns">Returns:</h2>

<p>meanRelDens: float
    Mean relative density of the lattice</p>
</div>


                            </div>
                            <div id="Lattice.get_beam_radius_min_max" class="classattr">
                                        <input id="Lattice.get_beam_radius_min_max-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_beam_radius_min_max</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Lattice.get_beam_radius_min_max-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_beam_radius_min_max"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_beam_radius_min_max-361"><a href="#Lattice.get_beam_radius_min_max-361"><span class="linenos">361</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_beam_radius_min_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice.get_beam_radius_min_max-362"><a href="#Lattice.get_beam_radius_min_max-362"><span class="linenos">362</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_beam_radius_min_max-363"><a href="#Lattice.get_beam_radius_min_max-363"><span class="linenos">363</span></a><span class="sd">        Get the maximum and minimum radii of the lattice</span>
</span><span id="Lattice.get_beam_radius_min_max-364"><a href="#Lattice.get_beam_radius_min_max-364"><span class="linenos">364</span></a>
</span><span id="Lattice.get_beam_radius_min_max-365"><a href="#Lattice.get_beam_radius_min_max-365"><span class="linenos">365</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice.get_beam_radius_min_max-366"><a href="#Lattice.get_beam_radius_min_max-366"><span class="linenos">366</span></a><span class="sd">        --------</span>
</span><span id="Lattice.get_beam_radius_min_max-367"><a href="#Lattice.get_beam_radius_min_max-367"><span class="linenos">367</span></a><span class="sd">        radMax: float</span>
</span><span id="Lattice.get_beam_radius_min_max-368"><a href="#Lattice.get_beam_radius_min_max-368"><span class="linenos">368</span></a><span class="sd">            Maximum radii of the lattice</span>
</span><span id="Lattice.get_beam_radius_min_max-369"><a href="#Lattice.get_beam_radius_min_max-369"><span class="linenos">369</span></a>
</span><span id="Lattice.get_beam_radius_min_max-370"><a href="#Lattice.get_beam_radius_min_max-370"><span class="linenos">370</span></a><span class="sd">        radMin: float</span>
</span><span id="Lattice.get_beam_radius_min_max-371"><a href="#Lattice.get_beam_radius_min_max-371"><span class="linenos">371</span></a><span class="sd">            Minimum radii of the lattice</span>
</span><span id="Lattice.get_beam_radius_min_max-372"><a href="#Lattice.get_beam_radius_min_max-372"><span class="linenos">372</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_beam_radius_min_max-373"><a href="#Lattice.get_beam_radius_min_max-373"><span class="linenos">373</span></a>        <span class="n">radMin</span> <span class="o">=</span> <span class="mi">1000000</span>
</span><span id="Lattice.get_beam_radius_min_max-374"><a href="#Lattice.get_beam_radius_min_max-374"><span class="linenos">374</span></a>        <span class="n">radMax</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice.get_beam_radius_min_max-375"><a href="#Lattice.get_beam_radius_min_max-375"><span class="linenos">375</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.get_beam_radius_min_max-376"><a href="#Lattice.get_beam_radius_min_max-376"><span class="linenos">376</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Lattice.get_beam_radius_min_max-377"><a href="#Lattice.get_beam_radius_min_max-377"><span class="linenos">377</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span><span class="p">:</span>
</span><span id="Lattice.get_beam_radius_min_max-378"><a href="#Lattice.get_beam_radius_min_max-378"><span class="linenos">378</span></a>                    <span class="n">radMin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radMin</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Lattice.get_beam_radius_min_max-379"><a href="#Lattice.get_beam_radius_min_max-379"><span class="linenos">379</span></a>                    <span class="n">radMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radMax</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Lattice.get_beam_radius_min_max-380"><a href="#Lattice.get_beam_radius_min_max-380"><span class="linenos">380</span></a>        <span class="k">return</span> <span class="n">radMax</span><span class="p">,</span> <span class="n">radMin</span>
</span></pre></div>


            <div class="docstring"><p>Get the maximum and minimum radii of the lattice</p>

<h2 id="returns">Returns:</h2>

<p>radMax: float
    Maximum radii of the lattice</p>

<p>radMin: float
    Minimum radii of the lattice</p>
</div>


                            </div>
                            <div id="Lattice.define_gradient" class="classattr">
                                        <input id="Lattice.define_gradient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;initialization&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_gradient</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">grad_radius_property</span>, </span><span class="param"><span class="n">grad_dim_property</span>, </span><span class="param"><span class="n">grad_mat_property</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Lattice.define_gradient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.define_gradient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.define_gradient-386"><a href="#Lattice.define_gradient-386"><span class="linenos">386</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;initialization&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_gradient-387"><a href="#Lattice.define_gradient-387"><span class="linenos">387</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_gradient-388"><a href="#Lattice.define_gradient-388"><span class="linenos">388</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad_radius_property</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">,</span> <span class="n">grad_mat_property</span><span class="p">):</span>
</span><span id="Lattice.define_gradient-389"><a href="#Lattice.define_gradient-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_gradient-390"><a href="#Lattice.define_gradient-390"><span class="linenos">390</span></a><span class="sd">        Define gradient settings for radii, dimensions, and materials based on provided properties.</span>
</span><span id="Lattice.define_gradient-391"><a href="#Lattice.define_gradient-391"><span class="linenos">391</span></a>
</span><span id="Lattice.define_gradient-392"><a href="#Lattice.define_gradient-392"><span class="linenos">392</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.define_gradient-393"><a href="#Lattice.define_gradient-393"><span class="linenos">393</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.define_gradient-394"><a href="#Lattice.define_gradient-394"><span class="linenos">394</span></a><span class="sd">        grad_radius_property: list</span>
</span><span id="Lattice.define_gradient-395"><a href="#Lattice.define_gradient-395"><span class="linenos">395</span></a><span class="sd">            Properties defining the gradient for radii.</span>
</span><span id="Lattice.define_gradient-396"><a href="#Lattice.define_gradient-396"><span class="linenos">396</span></a>
</span><span id="Lattice.define_gradient-397"><a href="#Lattice.define_gradient-397"><span class="linenos">397</span></a><span class="sd">        grad_dim_property: list</span>
</span><span id="Lattice.define_gradient-398"><a href="#Lattice.define_gradient-398"><span class="linenos">398</span></a><span class="sd">            Properties defining the gradient for cell dimensions.</span>
</span><span id="Lattice.define_gradient-399"><a href="#Lattice.define_gradient-399"><span class="linenos">399</span></a>
</span><span id="Lattice.define_gradient-400"><a href="#Lattice.define_gradient-400"><span class="linenos">400</span></a><span class="sd">        grad_mat_property: list</span>
</span><span id="Lattice.define_gradient-401"><a href="#Lattice.define_gradient-401"><span class="linenos">401</span></a><span class="sd">            Properties defining the gradient for material settings.</span>
</span><span id="Lattice.define_gradient-402"><a href="#Lattice.define_gradient-402"><span class="linenos">402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.define_gradient-403"><a href="#Lattice.define_gradient-403"><span class="linenos">403</span></a>        <span class="k">if</span> <span class="n">grad_radius_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_gradient-404"><a href="#Lattice.define_gradient-404"><span class="linenos">404</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span> <span class="o">=</span> <span class="n">get_grad_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span>
</span><span id="Lattice.define_gradient-405"><a href="#Lattice.define_gradient-405"><span class="linenos">405</span></a>                                                 <span class="n">grad_radius_property</span><span class="p">)</span>
</span><span id="Lattice.define_gradient-406"><a href="#Lattice.define_gradient-406"><span class="linenos">406</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.define_gradient-407"><a href="#Lattice.define_gradient-407"><span class="linenos">407</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span> <span class="o">=</span> <span class="n">grad_settings_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">)</span>
</span><span id="Lattice.define_gradient-408"><a href="#Lattice.define_gradient-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="n">grad_dim_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_gradient-409"><a href="#Lattice.define_gradient-409"><span class="linenos">409</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span> <span class="o">=</span> <span class="n">get_grad_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span> <span class="n">grad_dim_property</span><span class="p">)</span>
</span><span id="Lattice.define_gradient-410"><a href="#Lattice.define_gradient-410"><span class="linenos">410</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.define_gradient-411"><a href="#Lattice.define_gradient-411"><span class="linenos">411</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span> <span class="o">=</span> <span class="n">grad_settings_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">)</span>
</span><span id="Lattice.define_gradient-412"><a href="#Lattice.define_gradient-412"><span class="linenos">412</span></a>        <span class="k">if</span> <span class="n">grad_mat_property</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_gradient-413"><a href="#Lattice.define_gradient-413"><span class="linenos">413</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="o">=</span> <span class="n">grad_material_setting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span>
</span><span id="Lattice.define_gradient-414"><a href="#Lattice.define_gradient-414"><span class="linenos">414</span></a>                                                  <span class="n">grad_mat_property</span><span class="p">)</span>
</span><span id="Lattice.define_gradient-415"><a href="#Lattice.define_gradient-415"><span class="linenos">415</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.define_gradient-416"><a href="#Lattice.define_gradient-416"><span class="linenos">416</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span> <span class="o">=</span> <span class="n">grad_settings_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Define gradient settings for radii, dimensions, and materials based on provided properties.</p>

<h2 id="parameters">Parameters:</h2>

<p>grad_radius_property: list
    Properties defining the gradient for radii.</p>

<p>grad_dim_property: list
    Properties defining the gradient for cell dimensions.</p>

<p>grad_mat_property: list
    Properties defining the gradient for material settings.</p>
</div>


                            </div>
                            <div id="Lattice.generate_lattice" class="classattr">
                                        <input id="Lattice.generate_lattice-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">generate_lattice</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Lattice.generate_lattice-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.generate_lattice"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.generate_lattice-418"><a href="#Lattice.generate_lattice-418"><span class="linenos">418</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.generate_lattice-419"><a href="#Lattice.generate_lattice-419"><span class="linenos">419</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.generate_lattice-420"><a href="#Lattice.generate_lattice-420"><span class="linenos">420</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice.generate_lattice-421"><a href="#Lattice.generate_lattice-421"><span class="linenos">421</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.generate_lattice-422"><a href="#Lattice.generate_lattice-422"><span class="linenos">422</span></a><span class="sd">        Generate cells in the lattice structure based on cell size, number of cells, geometry types, and radii.</span>
</span><span id="Lattice.generate_lattice-423"><a href="#Lattice.generate_lattice-423"><span class="linenos">423</span></a><span class="sd">        Gradient information and erased regions are also considered during cell generation.</span>
</span><span id="Lattice.generate_lattice-424"><a href="#Lattice.generate_lattice-424"><span class="linenos">424</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.generate_lattice-425"><a href="#Lattice.generate_lattice-425"><span class="linenos">425</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span> <span class="c1"># For reproducibility of randomness</span>
</span><span id="Lattice.generate_lattice-426"><a href="#Lattice.generate_lattice-426"><span class="linenos">426</span></a>        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span>
</span><span id="Lattice.generate_lattice-427"><a href="#Lattice.generate_lattice-427"><span class="linenos">427</span></a>        <span class="n">csx</span><span class="p">,</span> <span class="n">csy</span><span class="p">,</span> <span class="n">csz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span>
</span><span id="Lattice.generate_lattice-428"><a href="#Lattice.generate_lattice-428"><span class="linenos">428</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span>
</span><span id="Lattice.generate_lattice-429"><a href="#Lattice.generate_lattice-429"><span class="linenos">429</span></a>        <span class="n">initial_cell_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">csx</span><span class="p">,</span> <span class="n">csy</span><span class="p">,</span> <span class="n">csz</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-430"><a href="#Lattice.generate_lattice-430"><span class="linenos">430</span></a>        <span class="n">added_nodes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice.generate_lattice-431"><a href="#Lattice.generate_lattice-431"><span class="linenos">431</span></a>        <span class="n">added_beams</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice.generate_lattice-432"><a href="#Lattice.generate_lattice-432"><span class="linenos">432</span></a>
</span><span id="Lattice.generate_lattice-433"><a href="#Lattice.generate_lattice-433"><span class="linenos">433</span></a>        <span class="c1"># Precompute cumulative start positions along each axis</span>
</span><span id="Lattice.generate_lattice-434"><a href="#Lattice.generate_lattice-434"><span class="linenos">434</span></a>        <span class="n">x_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nx</span>
</span><span id="Lattice.generate_lattice-435"><a href="#Lattice.generate_lattice-435"><span class="linenos">435</span></a>        <span class="n">y_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ny</span>
</span><span id="Lattice.generate_lattice-436"><a href="#Lattice.generate_lattice-436"><span class="linenos">436</span></a>        <span class="n">z_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nz</span>
</span><span id="Lattice.generate_lattice-437"><a href="#Lattice.generate_lattice-437"><span class="linenos">437</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>
</span><span id="Lattice.generate_lattice-438"><a href="#Lattice.generate_lattice-438"><span class="linenos">438</span></a>            <span class="n">x_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">csx</span> <span class="o">*</span> <span class="n">grad</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-439"><a href="#Lattice.generate_lattice-439"><span class="linenos">439</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
</span><span id="Lattice.generate_lattice-440"><a href="#Lattice.generate_lattice-440"><span class="linenos">440</span></a>            <span class="n">y_starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_starts</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">csy</span> <span class="o">*</span> <span class="n">grad</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-441"><a href="#Lattice.generate_lattice-441"><span class="linenos">441</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">):</span>
</span><span id="Lattice.generate_lattice-442"><a href="#Lattice.generate_lattice-442"><span class="linenos">442</span></a>            <span class="n">z_starts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_starts</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">csz</span> <span class="o">*</span> <span class="n">grad</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-443"><a href="#Lattice.generate_lattice-443"><span class="linenos">443</span></a>
</span><span id="Lattice.generate_lattice-444"><a href="#Lattice.generate_lattice-444"><span class="linenos">444</span></a>        <span class="n">append_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span>
</span><span id="Lattice.generate_lattice-445"><a href="#Lattice.generate_lattice-445"><span class="linenos">445</span></a>        <span class="n">mesh_trimmer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span>
</span><span id="Lattice.generate_lattice-446"><a href="#Lattice.generate_lattice-446"><span class="linenos">446</span></a>
</span><span id="Lattice.generate_lattice-447"><a href="#Lattice.generate_lattice-447"><span class="linenos">447</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
</span><span id="Lattice.generate_lattice-448"><a href="#Lattice.generate_lattice-448"><span class="linenos">448</span></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">x_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-449"><a href="#Lattice.generate_lattice-449"><span class="linenos">449</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
</span><span id="Lattice.generate_lattice-450"><a href="#Lattice.generate_lattice-450"><span class="linenos">450</span></a>                <span class="n">yj</span> <span class="o">=</span> <span class="n">y_starts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-451"><a href="#Lattice.generate_lattice-451"><span class="linenos">451</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
</span><span id="Lattice.generate_lattice-452"><a href="#Lattice.generate_lattice-452"><span class="linenos">452</span></a>                    <span class="n">zk</span> <span class="o">=</span> <span class="n">z_starts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-453"><a href="#Lattice.generate_lattice-453"><span class="linenos">453</span></a>                    <span class="n">start_cell_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yj</span><span class="p">,</span> <span class="n">zk</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-454"><a href="#Lattice.generate_lattice-454"><span class="linenos">454</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_not_in_erased_region</span><span class="p">(</span><span class="n">start_cell_pos</span><span class="p">):</span>
</span><span id="Lattice.generate_lattice-455"><a href="#Lattice.generate_lattice-455"><span class="linenos">455</span></a>                        <span class="k">continue</span>  <span class="c1"># skip erased regions</span>
</span><span id="Lattice.generate_lattice-456"><a href="#Lattice.generate_lattice-456"><span class="linenos">456</span></a>
</span><span id="Lattice.generate_lattice-457"><a href="#Lattice.generate_lattice-457"><span class="linenos">457</span></a>                    <span class="n">pos_cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-458"><a href="#Lattice.generate_lattice-458"><span class="linenos">458</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_randomness</span><span class="p">:</span>
</span><span id="Lattice.generate_lattice-459"><a href="#Lattice.generate_lattice-459"><span class="linenos">459</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomness_hybrid</span><span class="p">:</span>
</span><span id="Lattice.generate_lattice-460"><a href="#Lattice.generate_lattice-460"><span class="linenos">460</span></a>                            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-461"><a href="#Lattice.generate_lattice-461"><span class="linenos">461</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.generate_lattice-462"><a href="#Lattice.generate_lattice-462"><span class="linenos">462</span></a>                            <span class="n">random_radius</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_radius</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Lattice.generate_lattice-463"><a href="#Lattice.generate_lattice-463"><span class="linenos">463</span></a>                            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_radius</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">]</span>
</span><span id="Lattice.generate_lattice-464"><a href="#Lattice.generate_lattice-464"><span class="linenos">464</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.generate_lattice-465"><a href="#Lattice.generate_lattice-465"><span class="linenos">465</span></a>                        <span class="n">radii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span>
</span><span id="Lattice.generate_lattice-466"><a href="#Lattice.generate_lattice-466"><span class="linenos">466</span></a>                    <span class="n">new_cell</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span>
</span><span id="Lattice.generate_lattice-467"><a href="#Lattice.generate_lattice-467"><span class="linenos">467</span></a>                        <span class="n">pos_cell</span><span class="p">,</span> <span class="n">initial_cell_size</span><span class="p">,</span> <span class="n">start_cell_pos</span><span class="p">,</span>
</span><span id="Lattice.generate_lattice-468"><a href="#Lattice.generate_lattice-468"><span class="linenos">468</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span>
</span><span id="Lattice.generate_lattice-469"><a href="#Lattice.generate_lattice-469"><span class="linenos">469</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">,</span>
</span><span id="Lattice.generate_lattice-470"><a href="#Lattice.generate_lattice-470"><span class="linenos">470</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">,</span>
</span><span id="Lattice.generate_lattice-471"><a href="#Lattice.generate_lattice-471"><span class="linenos">471</span></a>                        <span class="n">beams_already_defined</span> <span class="o">=</span> <span class="n">added_beams</span><span class="p">,</span>
</span><span id="Lattice.generate_lattice-472"><a href="#Lattice.generate_lattice-472"><span class="linenos">472</span></a>                        <span class="n">nodes_already_defined</span> <span class="o">=</span> <span class="n">added_nodes</span>
</span><span id="Lattice.generate_lattice-473"><a href="#Lattice.generate_lattice-473"><span class="linenos">473</span></a>                    <span class="p">)</span>
</span><span id="Lattice.generate_lattice-474"><a href="#Lattice.generate_lattice-474"><span class="linenos">474</span></a>
</span><span id="Lattice.generate_lattice-475"><a href="#Lattice.generate_lattice-475"><span class="linenos">475</span></a>                    <span class="k">if</span> <span class="n">mesh_trimmer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mesh_trimmer</span><span class="o">.</span><span class="n">is_cell_in_mesh</span><span class="p">(</span><span class="n">new_cell</span><span class="p">):</span>
</span><span id="Lattice.generate_lattice-476"><a href="#Lattice.generate_lattice-476"><span class="linenos">476</span></a>                        <span class="k">continue</span>
</span><span id="Lattice.generate_lattice-477"><a href="#Lattice.generate_lattice-477"><span class="linenos">477</span></a>                    <span class="n">append_cell</span><span class="p">(</span><span class="n">new_cell</span><span class="p">)</span>
</span><span id="Lattice.generate_lattice-478"><a href="#Lattice.generate_lattice-478"><span class="linenos">478</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">)</span>
</span><span id="Lattice.generate_lattice-479"><a href="#Lattice.generate_lattice-479"><span class="linenos">479</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="Lattice.generate_lattice-480"><a href="#Lattice.generate_lattice-480"><span class="linenos">480</span></a>
</span><span id="Lattice.generate_lattice-481"><a href="#Lattice.generate_lattice-481"><span class="linenos">481</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Lattice.generate_lattice-482"><a href="#Lattice.generate_lattice-482"><span class="linenos">482</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">check_hybrid_collision</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Generate cells in the lattice structure based on cell size, number of cells, geometry types, and radii.
Gradient information and erased regions are also considered during cell generation.</p>
</div>


                            </div>
                            <div id="Lattice.cut_beam_with_mesh_trimmer" class="classattr">
                                        <input id="Lattice.cut_beam_with_mesh_trimmer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">cut_beam_with_mesh_trimmer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Lattice.cut_beam_with_mesh_trimmer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.cut_beam_with_mesh_trimmer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.cut_beam_with_mesh_trimmer-484"><a href="#Lattice.cut_beam_with_mesh_trimmer-484"><span class="linenos">484</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.cut_beam_with_mesh_trimmer-485"><a href="#Lattice.cut_beam_with_mesh_trimmer-485"><span class="linenos">485</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.cut_beam_with_mesh_trimmer-486"><a href="#Lattice.cut_beam_with_mesh_trimmer-486"><span class="linenos">486</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cut_beam_with_mesh_trimmer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice.cut_beam_with_mesh_trimmer-487"><a href="#Lattice.cut_beam_with_mesh_trimmer-487"><span class="linenos">487</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.cut_beam_with_mesh_trimmer-488"><a href="#Lattice.cut_beam_with_mesh_trimmer-488"><span class="linenos">488</span></a><span class="sd">        Cut beams in the lattice using the mesh trimmer.</span>
</span><span id="Lattice.cut_beam_with_mesh_trimmer-489"><a href="#Lattice.cut_beam_with_mesh_trimmer-489"><span class="linenos">489</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.cut_beam_with_mesh_trimmer-490"><a href="#Lattice.cut_beam_with_mesh_trimmer-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.cut_beam_with_mesh_trimmer-491"><a href="#Lattice.cut_beam_with_mesh_trimmer-491"><span class="linenos">491</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A mesh object must be assigned to the lattice before cutting beams.&quot;</span><span class="p">)</span>
</span><span id="Lattice.cut_beam_with_mesh_trimmer-492"><a href="#Lattice.cut_beam_with_mesh_trimmer-492"><span class="linenos">492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_trimmer</span><span class="o">.</span><span class="n">cut_beams_at_mesh_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Cut beams in the lattice using the mesh trimmer.</p>
</div>


                            </div>
                            <div id="Lattice.apply_symmetry" class="classattr">
                                        <input id="Lattice.apply_symmetry-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">apply_symmetry</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">symmetry_plane</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">reference_point</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.apply_symmetry-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.apply_symmetry"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.apply_symmetry-494"><a href="#Lattice.apply_symmetry-494"><span class="linenos">494</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-495"><a href="#Lattice.apply_symmetry-495"><span class="linenos">495</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.apply_symmetry-496"><a href="#Lattice.apply_symmetry-496"><span class="linenos">496</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetry_plane</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reference_point</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.apply_symmetry-497"><a href="#Lattice.apply_symmetry-497"><span class="linenos">497</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.apply_symmetry-498"><a href="#Lattice.apply_symmetry-498"><span class="linenos">498</span></a><span class="sd">        Apply symmetry to the lattice by mirroring cells across a specified plane.</span>
</span><span id="Lattice.apply_symmetry-499"><a href="#Lattice.apply_symmetry-499"><span class="linenos">499</span></a>
</span><span id="Lattice.apply_symmetry-500"><a href="#Lattice.apply_symmetry-500"><span class="linenos">500</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.apply_symmetry-501"><a href="#Lattice.apply_symmetry-501"><span class="linenos">501</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.apply_symmetry-502"><a href="#Lattice.apply_symmetry-502"><span class="linenos">502</span></a><span class="sd">        symmetry_plane: str, optional</span>
</span><span id="Lattice.apply_symmetry-503"><a href="#Lattice.apply_symmetry-503"><span class="linenos">503</span></a><span class="sd">            Plane of symmetry (&#39;XY&#39;, &#39;XZ&#39;, &#39;YZ&#39;, &#39;X&#39;, &#39;Y&#39;,</span>
</span><span id="Lattice.apply_symmetry-504"><a href="#Lattice.apply_symmetry-504"><span class="linenos">504</span></a><span class="sd">            or &#39;Z&#39;). If None, uses self.symmetry_lattice[&#39;sym_plane&#39;].</span>
</span><span id="Lattice.apply_symmetry-505"><a href="#Lattice.apply_symmetry-505"><span class="linenos">505</span></a>
</span><span id="Lattice.apply_symmetry-506"><a href="#Lattice.apply_symmetry-506"><span class="linenos">506</span></a><span class="sd">        reference_point: tuple of float, optional</span>
</span><span id="Lattice.apply_symmetry-507"><a href="#Lattice.apply_symmetry-507"><span class="linenos">507</span></a><span class="sd">            Reference point for the symmetry operation (x_ref, y_ref, z_ref).</span>
</span><span id="Lattice.apply_symmetry-508"><a href="#Lattice.apply_symmetry-508"><span class="linenos">508</span></a><span class="sd">            If None, uses self.symmetry_lattice[&#39;sym_point&#39;].</span>
</span><span id="Lattice.apply_symmetry-509"><a href="#Lattice.apply_symmetry-509"><span class="linenos">509</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.apply_symmetry-510"><a href="#Lattice.apply_symmetry-510"><span class="linenos">510</span></a>        <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reference_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.apply_symmetry-511"><a href="#Lattice.apply_symmetry-511"><span class="linenos">511</span></a>            <span class="n">symmetry_plane</span><span class="p">,</span> <span class="n">reference_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span><span class="p">[</span><span class="s2">&quot;sym_plane&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_lattice</span><span class="p">[</span><span class="s2">&quot;sym_point&quot;</span><span class="p">]</span>
</span><span id="Lattice.apply_symmetry-512"><a href="#Lattice.apply_symmetry-512"><span class="linenos">512</span></a>        <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reference_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.apply_symmetry-513"><a href="#Lattice.apply_symmetry-513"><span class="linenos">513</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Both symmetry_plane and reference_point must be provided.&quot;</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-514"><a href="#Lattice.apply_symmetry-514"><span class="linenos">514</span></a>        <span class="n">symmetry_plane</span> <span class="o">=</span> <span class="n">symmetry_plane</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Lattice.apply_symmetry-515"><a href="#Lattice.apply_symmetry-515"><span class="linenos">515</span></a>        <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;XY&quot;</span><span class="p">,</span> <span class="s2">&quot;XZ&quot;</span><span class="p">,</span> <span class="s2">&quot;YZ&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">}:</span>
</span><span id="Lattice.apply_symmetry-516"><a href="#Lattice.apply_symmetry-516"><span class="linenos">516</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid symmetry plane. Choose from &#39;XY&#39;, &#39;XZ&#39;, &#39;YZ&#39;, &#39;X&#39;, &#39;Y&#39;, or &#39;Z&#39;.&quot;</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-517"><a href="#Lattice.apply_symmetry-517"><span class="linenos">517</span></a>
</span><span id="Lattice.apply_symmetry-518"><a href="#Lattice.apply_symmetry-518"><span class="linenos">518</span></a>        <span class="n">x_ref</span><span class="p">,</span> <span class="n">y_ref</span><span class="p">,</span> <span class="n">z_ref</span> <span class="o">=</span> <span class="n">reference_point</span>
</span><span id="Lattice.apply_symmetry-519"><a href="#Lattice.apply_symmetry-519"><span class="linenos">519</span></a>
</span><span id="Lattice.apply_symmetry-520"><a href="#Lattice.apply_symmetry-520"><span class="linenos">520</span></a>        <span class="n">new_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Cell</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.apply_symmetry-521"><a href="#Lattice.apply_symmetry-521"><span class="linenos">521</span></a>        <span class="n">new_global_beams</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.apply_symmetry-522"><a href="#Lattice.apply_symmetry-522"><span class="linenos">522</span></a>        <span class="n">new_global_nodes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.apply_symmetry-523"><a href="#Lattice.apply_symmetry-523"><span class="linenos">523</span></a>
</span><span id="Lattice.apply_symmetry-524"><a href="#Lattice.apply_symmetry-524"><span class="linenos">524</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.apply_symmetry-525"><a href="#Lattice.apply_symmetry-525"><span class="linenos">525</span></a>            <span class="c1"># Mirror the cell origin/coordinate; size and pos are kept identical</span>
</span><span id="Lattice.apply_symmetry-526"><a href="#Lattice.apply_symmetry-526"><span class="linenos">526</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span>
</span><span id="Lattice.apply_symmetry-527"><a href="#Lattice.apply_symmetry-527"><span class="linenos">527</span></a>            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">size</span>
</span><span id="Lattice.apply_symmetry-528"><a href="#Lattice.apply_symmetry-528"><span class="linenos">528</span></a>
</span><span id="Lattice.apply_symmetry-529"><a href="#Lattice.apply_symmetry-529"><span class="linenos">529</span></a>            <span class="c1"># Mirror min-corner of the box correctly: x&#39;min = 2*x_ref - (x_min + dx), etc.</span>
</span><span id="Lattice.apply_symmetry-530"><a href="#Lattice.apply_symmetry-530"><span class="linenos">530</span></a>            <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;YZ&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">}:</span>
</span><span id="Lattice.apply_symmetry-531"><a href="#Lattice.apply_symmetry-531"><span class="linenos">531</span></a>                <span class="n">mcx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">cx</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-532"><a href="#Lattice.apply_symmetry-532"><span class="linenos">532</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.apply_symmetry-533"><a href="#Lattice.apply_symmetry-533"><span class="linenos">533</span></a>                <span class="n">mcx</span> <span class="o">=</span> <span class="n">cx</span>
</span><span id="Lattice.apply_symmetry-534"><a href="#Lattice.apply_symmetry-534"><span class="linenos">534</span></a>
</span><span id="Lattice.apply_symmetry-535"><a href="#Lattice.apply_symmetry-535"><span class="linenos">535</span></a>            <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;XZ&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">}:</span>
</span><span id="Lattice.apply_symmetry-536"><a href="#Lattice.apply_symmetry-536"><span class="linenos">536</span></a>                <span class="n">mcy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y_ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">cy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-537"><a href="#Lattice.apply_symmetry-537"><span class="linenos">537</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.apply_symmetry-538"><a href="#Lattice.apply_symmetry-538"><span class="linenos">538</span></a>                <span class="n">mcy</span> <span class="o">=</span> <span class="n">cy</span>
</span><span id="Lattice.apply_symmetry-539"><a href="#Lattice.apply_symmetry-539"><span class="linenos">539</span></a>
</span><span id="Lattice.apply_symmetry-540"><a href="#Lattice.apply_symmetry-540"><span class="linenos">540</span></a>            <span class="k">if</span> <span class="n">symmetry_plane</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;XY&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">}:</span>
</span><span id="Lattice.apply_symmetry-541"><a href="#Lattice.apply_symmetry-541"><span class="linenos">541</span></a>                <span class="n">mcz</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z_ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">cz</span> <span class="o">+</span> <span class="n">dz</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-542"><a href="#Lattice.apply_symmetry-542"><span class="linenos">542</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.apply_symmetry-543"><a href="#Lattice.apply_symmetry-543"><span class="linenos">543</span></a>                <span class="n">mcz</span> <span class="o">=</span> <span class="n">cz</span>
</span><span id="Lattice.apply_symmetry-544"><a href="#Lattice.apply_symmetry-544"><span class="linenos">544</span></a>
</span><span id="Lattice.apply_symmetry-545"><a href="#Lattice.apply_symmetry-545"><span class="linenos">545</span></a>            <span class="n">new_coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcx</span><span class="p">,</span> <span class="n">mcy</span><span class="p">,</span> <span class="n">mcz</span><span class="p">]</span>
</span><span id="Lattice.apply_symmetry-546"><a href="#Lattice.apply_symmetry-546"><span class="linenos">546</span></a>
</span><span id="Lattice.apply_symmetry-547"><a href="#Lattice.apply_symmetry-547"><span class="linenos">547</span></a>            <span class="c1"># Build the mirrored cell</span>
</span><span id="Lattice.apply_symmetry-548"><a href="#Lattice.apply_symmetry-548"><span class="linenos">548</span></a>            <span class="n">new_cell</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">(</span>
</span><span id="Lattice.apply_symmetry-549"><a href="#Lattice.apply_symmetry-549"><span class="linenos">549</span></a>                <span class="n">pos</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">pos</span><span class="p">),</span>
</span><span id="Lattice.apply_symmetry-550"><a href="#Lattice.apply_symmetry-550"><span class="linenos">550</span></a>                <span class="n">initial_size</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
</span><span id="Lattice.apply_symmetry-551"><a href="#Lattice.apply_symmetry-551"><span class="linenos">551</span></a>                <span class="n">coordinate</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">new_coord</span><span class="p">),</span>
</span><span id="Lattice.apply_symmetry-552"><a href="#Lattice.apply_symmetry-552"><span class="linenos">552</span></a>                <span class="n">geom_types</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">geom_types</span><span class="p">),</span>
</span><span id="Lattice.apply_symmetry-553"><a href="#Lattice.apply_symmetry-553"><span class="linenos">553</span></a>                <span class="n">radii</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">radii</span><span class="p">),</span>
</span><span id="Lattice.apply_symmetry-554"><a href="#Lattice.apply_symmetry-554"><span class="linenos">554</span></a>                <span class="n">grad_radius</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">grad_radius</span><span class="p">,</span>
</span><span id="Lattice.apply_symmetry-555"><a href="#Lattice.apply_symmetry-555"><span class="linenos">555</span></a>                <span class="n">grad_dim</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">,</span>
</span><span id="Lattice.apply_symmetry-556"><a href="#Lattice.apply_symmetry-556"><span class="linenos">556</span></a>                <span class="n">grad_mat</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">grad_mat</span><span class="p">,</span>
</span><span id="Lattice.apply_symmetry-557"><a href="#Lattice.apply_symmetry-557"><span class="linenos">557</span></a>                <span class="n">uncertainty_node</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;uncertainty_node&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="Lattice.apply_symmetry-558"><a href="#Lattice.apply_symmetry-558"><span class="linenos">558</span></a>                <span class="n">_verbose</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_verbose&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="Lattice.apply_symmetry-559"><a href="#Lattice.apply_symmetry-559"><span class="linenos">559</span></a>            <span class="p">)</span>
</span><span id="Lattice.apply_symmetry-560"><a href="#Lattice.apply_symmetry-560"><span class="linenos">560</span></a>
</span><span id="Lattice.apply_symmetry-561"><a href="#Lattice.apply_symmetry-561"><span class="linenos">561</span></a>            <span class="n">new_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_cell</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-562"><a href="#Lattice.apply_symmetry-562"><span class="linenos">562</span></a>
</span><span id="Lattice.apply_symmetry-563"><a href="#Lattice.apply_symmetry-563"><span class="linenos">563</span></a>        <span class="c1"># Append mirrored structures to lattice</span>
</span><span id="Lattice.apply_symmetry-564"><a href="#Lattice.apply_symmetry-564"><span class="linenos">564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_cells</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-565"><a href="#Lattice.apply_symmetry-565"><span class="linenos">565</span></a>
</span><span id="Lattice.apply_symmetry-566"><a href="#Lattice.apply_symmetry-566"><span class="linenos">566</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;beams&quot;</span><span class="p">):</span>
</span><span id="Lattice.apply_symmetry-567"><a href="#Lattice.apply_symmetry-567"><span class="linenos">567</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
</span><span id="Lattice.apply_symmetry-568"><a href="#Lattice.apply_symmetry-568"><span class="linenos">568</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_global_beams</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-569"><a href="#Lattice.apply_symmetry-569"><span class="linenos">569</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice.apply_symmetry-570"><a href="#Lattice.apply_symmetry-570"><span class="linenos">570</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_global_beams</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-571"><a href="#Lattice.apply_symmetry-571"><span class="linenos">571</span></a>
</span><span id="Lattice.apply_symmetry-572"><a href="#Lattice.apply_symmetry-572"><span class="linenos">572</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="p">):</span>
</span><span id="Lattice.apply_symmetry-573"><a href="#Lattice.apply_symmetry-573"><span class="linenos">573</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
</span><span id="Lattice.apply_symmetry-574"><a href="#Lattice.apply_symmetry-574"><span class="linenos">574</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_global_nodes</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-575"><a href="#Lattice.apply_symmetry-575"><span class="linenos">575</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Lattice.apply_symmetry-576"><a href="#Lattice.apply_symmetry-576"><span class="linenos">576</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_global_nodes</span><span class="p">)</span>
</span><span id="Lattice.apply_symmetry-577"><a href="#Lattice.apply_symmetry-577"><span class="linenos">577</span></a>
</span><span id="Lattice.apply_symmetry-578"><a href="#Lattice.apply_symmetry-578"><span class="linenos">578</span></a>        <span class="c1"># Recompute lattice dimensions/bounding box</span>
</span><span id="Lattice.apply_symmetry-579"><a href="#Lattice.apply_symmetry-579"><span class="linenos">579</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_lattice_dimensions</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Apply symmetry to the lattice by mirroring cells across a specified plane.</p>

<h2 id="parameters">Parameters:</h2>

<p>symmetry_plane: str, optional
    Plane of symmetry ('XY', 'XZ', 'YZ', 'X', 'Y',
    or 'Z'). If None, uses self.symmetry_lattice['sym_plane'].</p>

<p>reference_point: tuple of float, optional
    Reference point for the symmetry operation (x_ref, y_ref, z_ref).
    If None, uses self.symmetry_lattice['sym_point'].</p>
</div>


                            </div>
                            <div id="Lattice.delete_beams_under_radius_threshold" class="classattr">
                                        <input id="Lattice.delete_beams_under_radius_threshold-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">delete_beams_under_radius_threshold</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.delete_beams_under_radius_threshold-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.delete_beams_under_radius_threshold"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.delete_beams_under_radius_threshold-581"><a href="#Lattice.delete_beams_under_radius_threshold-581"><span class="linenos">581</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-582"><a href="#Lattice.delete_beams_under_radius_threshold-582"><span class="linenos">582</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-583"><a href="#Lattice.delete_beams_under_radius_threshold-583"><span class="linenos">583</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_beams_under_radius_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-584"><a href="#Lattice.delete_beams_under_radius_threshold-584"><span class="linenos">584</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-585"><a href="#Lattice.delete_beams_under_radius_threshold-585"><span class="linenos">585</span></a><span class="sd">        Delete beams with radii under a certain threshold</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-586"><a href="#Lattice.delete_beams_under_radius_threshold-586"><span class="linenos">586</span></a>
</span><span id="Lattice.delete_beams_under_radius_threshold-587"><a href="#Lattice.delete_beams_under_radius_threshold-587"><span class="linenos">587</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-588"><a href="#Lattice.delete_beams_under_radius_threshold-588"><span class="linenos">588</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-589"><a href="#Lattice.delete_beams_under_radius_threshold-589"><span class="linenos">589</span></a><span class="sd">        threshold: float</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-590"><a href="#Lattice.delete_beams_under_radius_threshold-590"><span class="linenos">590</span></a><span class="sd">            Threshold value for beam radii</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-591"><a href="#Lattice.delete_beams_under_radius_threshold-591"><span class="linenos">591</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-592"><a href="#Lattice.delete_beams_under_radius_threshold-592"><span class="linenos">592</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-593"><a href="#Lattice.delete_beams_under_radius_threshold-593"><span class="linenos">593</span></a>        <span class="n">beam_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-594"><a href="#Lattice.delete_beams_under_radius_threshold-594"><span class="linenos">594</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-595"><a href="#Lattice.delete_beams_under_radius_threshold-595"><span class="linenos">595</span></a>            <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-596"><a href="#Lattice.delete_beams_under_radius_threshold-596"><span class="linenos">596</span></a>                <span class="n">beam_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-597"><a href="#Lattice.delete_beams_under_radius_threshold-597"><span class="linenos">597</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beam_to_remove</span><span class="p">:</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-598"><a href="#Lattice.delete_beams_under_radius_threshold-598"><span class="linenos">598</span></a>            <span class="n">beam</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-599"><a href="#Lattice.delete_beams_under_radius_threshold-599"><span class="linenos">599</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-600"><a href="#Lattice.delete_beams_under_radius_threshold-600"><span class="linenos">600</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice.delete_beams_under_radius_threshold-601"><a href="#Lattice.delete_beams_under_radius_threshold-601"><span class="linenos">601</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delete_orphan_points</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Delete beams with radii under a certain threshold</p>

<h2 id="parameters">Parameters:</h2>

<p>threshold: float
    Threshold value for beam radii</p>
</div>


                            </div>
                            <div id="Lattice.set_tag_classification" class="classattr">
                                        <input id="Lattice.set_tag_classification-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_tag_classification</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.set_tag_classification-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.set_tag_classification"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.set_tag_classification-607"><a href="#Lattice.set_tag_classification-607"><span class="linenos">607</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_tag_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.set_tag_classification-608"><a href="#Lattice.set_tag_classification-608"><span class="linenos">608</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.set_tag_classification-609"><a href="#Lattice.set_tag_classification-609"><span class="linenos">609</span></a><span class="sd">        Define tag list classification.</span>
</span><span id="Lattice.set_tag_classification-610"><a href="#Lattice.set_tag_classification-610"><span class="linenos">610</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.set_tag_classification-611"><a href="#Lattice.set_tag_classification-611"><span class="linenos">611</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edge_tags</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">111</span><span class="p">],</span> <span class="p">[</span><span class="mi">101</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">110</span><span class="p">]]</span>
</span><span id="Lattice.set_tag_classification-612"><a href="#Lattice.set_tag_classification-612"><span class="linenos">612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">face_tags</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]]</span>
</span><span id="Lattice.set_tag_classification-613"><a href="#Lattice.set_tag_classification-613"><span class="linenos">613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corner_tags</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">1002</span><span class="p">,</span> <span class="mi">1003</span><span class="p">,</span> <span class="mi">1004</span><span class="p">,</span> <span class="mi">1005</span><span class="p">,</span> <span class="mi">1006</span><span class="p">,</span> <span class="mi">1007</span><span class="p">]]</span>
</span></pre></div>


            <div class="docstring"><p>Define tag list classification.</p>
</div>


                            </div>
                            <div id="Lattice.define_size_lattice" class="classattr">
                                        <input id="Lattice.define_size_lattice-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_size_lattice</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Lattice.define_size_lattice-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.define_size_lattice"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.define_size_lattice-615"><a href="#Lattice.define_size_lattice-615"><span class="linenos">615</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_size_lattice-616"><a href="#Lattice.define_size_lattice-616"><span class="linenos">616</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_size_lattice-617"><a href="#Lattice.define_size_lattice-617"><span class="linenos">617</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_size_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice.define_size_lattice-618"><a href="#Lattice.define_size_lattice-618"><span class="linenos">618</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_size_lattice-619"><a href="#Lattice.define_size_lattice-619"><span class="linenos">619</span></a><span class="sd">        Computes the size of the lattice along each direction.</span>
</span><span id="Lattice.define_size_lattice-620"><a href="#Lattice.define_size_lattice-620"><span class="linenos">620</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.define_size_lattice-621"><a href="#Lattice.define_size_lattice-621"><span class="linenos">621</span></a>        <span class="n">size_lattice</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
</span><span id="Lattice.define_size_lattice-622"><a href="#Lattice.define_size_lattice-622"><span class="linenos">622</span></a>        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="Lattice.define_size_lattice-623"><a href="#Lattice.define_size_lattice-623"><span class="linenos">623</span></a>            <span class="n">total_length</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Lattice.define_size_lattice-624"><a href="#Lattice.define_size_lattice-624"><span class="linenos">624</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span>
</span><span id="Lattice.define_size_lattice-625"><a href="#Lattice.define_size_lattice-625"><span class="linenos">625</span></a>            <span class="n">cell_size</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span>
</span><span id="Lattice.define_size_lattice-626"><a href="#Lattice.define_size_lattice-626"><span class="linenos">626</span></a>            <span class="n">gradient_factors</span> <span class="o">=</span> <span class="p">[</span><span class="n">grad</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="k">for</span> <span class="n">grad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_dim</span><span class="p">[:</span><span class="n">num_cells</span><span class="p">]]</span>
</span><span id="Lattice.define_size_lattice-627"><a href="#Lattice.define_size_lattice-627"><span class="linenos">627</span></a>
</span><span id="Lattice.define_size_lattice-628"><a href="#Lattice.define_size_lattice-628"><span class="linenos">628</span></a>            <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">gradient_factors</span><span class="p">:</span>
</span><span id="Lattice.define_size_lattice-629"><a href="#Lattice.define_size_lattice-629"><span class="linenos">629</span></a>                <span class="n">total_length</span> <span class="o">+=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">cell_size</span>
</span><span id="Lattice.define_size_lattice-630"><a href="#Lattice.define_size_lattice-630"><span class="linenos">630</span></a>            <span class="n">size_lattice</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_length</span>
</span><span id="Lattice.define_size_lattice-631"><a href="#Lattice.define_size_lattice-631"><span class="linenos">631</span></a>
</span><span id="Lattice.define_size_lattice-632"><a href="#Lattice.define_size_lattice-632"><span class="linenos">632</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_z</span> <span class="o">=</span> <span class="n">size_lattice</span>
</span></pre></div>


            <div class="docstring"><p>Computes the size of the lattice along each direction.</p>
</div>


                            </div>
                            <div id="Lattice.is_not_in_erased_region" class="classattr">
                                        <input id="Lattice.is_not_in_erased_region-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">is_not_in_erased_region</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_cell_pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Lattice.is_not_in_erased_region-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.is_not_in_erased_region"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.is_not_in_erased_region-634"><a href="#Lattice.is_not_in_erased_region-634"><span class="linenos">634</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.is_not_in_erased_region-635"><a href="#Lattice.is_not_in_erased_region-635"><span class="linenos">635</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.is_not_in_erased_region-636"><a href="#Lattice.is_not_in_erased_region-636"><span class="linenos">636</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_not_in_erased_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_cell_pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Lattice.is_not_in_erased_region-637"><a href="#Lattice.is_not_in_erased_region-637"><span class="linenos">637</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.is_not_in_erased_region-638"><a href="#Lattice.is_not_in_erased_region-638"><span class="linenos">638</span></a><span class="sd">        Check if the cell is not in the erased region or inside the mesh.</span>
</span><span id="Lattice.is_not_in_erased_region-639"><a href="#Lattice.is_not_in_erased_region-639"><span class="linenos">639</span></a>
</span><span id="Lattice.is_not_in_erased_region-640"><a href="#Lattice.is_not_in_erased_region-640"><span class="linenos">640</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.is_not_in_erased_region-641"><a href="#Lattice.is_not_in_erased_region-641"><span class="linenos">641</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.is_not_in_erased_region-642"><a href="#Lattice.is_not_in_erased_region-642"><span class="linenos">642</span></a><span class="sd">        startCellPos: list of float</span>
</span><span id="Lattice.is_not_in_erased_region-643"><a href="#Lattice.is_not_in_erased_region-643"><span class="linenos">643</span></a><span class="sd">            (xStart, yStart, zStart) position of the cell to check.</span>
</span><span id="Lattice.is_not_in_erased_region-644"><a href="#Lattice.is_not_in_erased_region-644"><span class="linenos">644</span></a>
</span><span id="Lattice.is_not_in_erased_region-645"><a href="#Lattice.is_not_in_erased_region-645"><span class="linenos">645</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice.is_not_in_erased_region-646"><a href="#Lattice.is_not_in_erased_region-646"><span class="linenos">646</span></a><span class="sd">        --------</span>
</span><span id="Lattice.is_not_in_erased_region-647"><a href="#Lattice.is_not_in_erased_region-647"><span class="linenos">647</span></a><span class="sd">        bool:</span>
</span><span id="Lattice.is_not_in_erased_region-648"><a href="#Lattice.is_not_in_erased_region-648"><span class="linenos">648</span></a><span class="sd">            True if the cell should be removed.</span>
</span><span id="Lattice.is_not_in_erased_region-649"><a href="#Lattice.is_not_in_erased_region-649"><span class="linenos">649</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.is_not_in_erased_region-650"><a href="#Lattice.is_not_in_erased_region-650"><span class="linenos">650</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.is_not_in_erased_region-651"><a href="#Lattice.is_not_in_erased_region-651"><span class="linenos">651</span></a>            <span class="k">for</span> <span class="n">delPart</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span><span class="p">:</span>
</span><span id="Lattice.is_not_in_erased_region-652"><a href="#Lattice.is_not_in_erased_region-652"><span class="linenos">652</span></a>                <span class="n">inside_erased</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="Lattice.is_not_in_erased_region-653"><a href="#Lattice.is_not_in_erased_region-653"><span class="linenos">653</span></a>                    <span class="n">delPart</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">start_cell_pos</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">delPart</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">+</span> <span class="n">delPart</span><span class="p">[</span><span class="n">direction</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="Lattice.is_not_in_erased_region-654"><a href="#Lattice.is_not_in_erased_region-654"><span class="linenos">654</span></a>                    <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Lattice.is_not_in_erased_region-655"><a href="#Lattice.is_not_in_erased_region-655"><span class="linenos">655</span></a>                <span class="p">)</span>
</span><span id="Lattice.is_not_in_erased_region-656"><a href="#Lattice.is_not_in_erased_region-656"><span class="linenos">656</span></a>
</span><span id="Lattice.is_not_in_erased_region-657"><a href="#Lattice.is_not_in_erased_region-657"><span class="linenos">657</span></a>                <span class="k">if</span> <span class="n">inside_erased</span><span class="p">:</span>
</span><span id="Lattice.is_not_in_erased_region-658"><a href="#Lattice.is_not_in_erased_region-658"><span class="linenos">658</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="Lattice.is_not_in_erased_region-659"><a href="#Lattice.is_not_in_erased_region-659"><span class="linenos">659</span></a>
</span><span id="Lattice.is_not_in_erased_region-660"><a href="#Lattice.is_not_in_erased_region-660"><span class="linenos">660</span></a>        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># cell removed</span>
</span></pre></div>


            <div class="docstring"><p>Check if the cell is not in the erased region or inside the mesh.</p>

<h2 id="parameters">Parameters:</h2>

<p>startCellPos: list of float
    (xStart, yStart, zStart) position of the cell to check.</p>

<h2 id="returns">Returns:</h2>

<p>bool:
    True if the cell should be removed.</p>
</div>


                            </div>
                            <div id="Lattice.define_beam_node_index" class="classattr">
                                        <input id="Lattice.define_beam_node_index-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_beam_node_index</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.define_beam_node_index-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.define_beam_node_index"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.define_beam_node_index-662"><a href="#Lattice.define_beam_node_index-662"><span class="linenos">662</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_beam_node_index-663"><a href="#Lattice.define_beam_node_index-663"><span class="linenos">663</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_beam_node_index-664"><a href="#Lattice.define_beam_node_index-664"><span class="linenos">664</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_beam_node_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_beam_node_index-665"><a href="#Lattice.define_beam_node_index-665"><span class="linenos">665</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_beam_node_index-666"><a href="#Lattice.define_beam_node_index-666"><span class="linenos">666</span></a><span class="sd">        Define index at each beam and node</span>
</span><span id="Lattice.define_beam_node_index-667"><a href="#Lattice.define_beam_node_index-667"><span class="linenos">667</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.define_beam_node_index-668"><a href="#Lattice.define_beam_node_index-668"><span class="linenos">668</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice.define_beam_node_index-669"><a href="#Lattice.define_beam_node_index-669"><span class="linenos">669</span></a>
</span><span id="Lattice.define_beam_node_index-670"><a href="#Lattice.define_beam_node_index-670"><span class="linenos">670</span></a>        <span class="c1"># Beams</span>
</span><span id="Lattice.define_beam_node_index-671"><a href="#Lattice.define_beam_node_index-671"><span class="linenos">671</span></a>        <span class="n">existing_beam_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice.define_beam_node_index-672"><a href="#Lattice.define_beam_node_index-672"><span class="linenos">672</span></a>        <span class="n">next_beam_idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">existing_beam_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">existing_beam_idx</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="Lattice.define_beam_node_index-673"><a href="#Lattice.define_beam_node_index-673"><span class="linenos">673</span></a>
</span><span id="Lattice.define_beam_node_index-674"><a href="#Lattice.define_beam_node_index-674"><span class="linenos">674</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">beam_key</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
</span><span id="Lattice.define_beam_node_index-675"><a href="#Lattice.define_beam_node_index-675"><span class="linenos">675</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Key for sorting beams by their endpoints and radius. &quot;&quot;&quot;</span>
</span><span id="Lattice.define_beam_node_index-676"><a href="#Lattice.define_beam_node_index-676"><span class="linenos">676</span></a>            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice.define_beam_node_index-677"><a href="#Lattice.define_beam_node_index-677"><span class="linenos">677</span></a>            <span class="k">return</span> <span class="p">(</span><span class="nb">min</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">)),</span>
</span><span id="Lattice.define_beam_node_index-678"><a href="#Lattice.define_beam_node_index-678"><span class="linenos">678</span></a>                    <span class="nb">max</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">)),</span>
</span><span id="Lattice.define_beam_node_index-679"><a href="#Lattice.define_beam_node_index-679"><span class="linenos">679</span></a>                    <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span id="Lattice.define_beam_node_index-680"><a href="#Lattice.define_beam_node_index-680"><span class="linenos">680</span></a>
</span><span id="Lattice.define_beam_node_index-681"><a href="#Lattice.define_beam_node_index-681"><span class="linenos">681</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">beam_key</span><span class="p">):</span>
</span><span id="Lattice.define_beam_node_index-682"><a href="#Lattice.define_beam_node_index-682"><span class="linenos">682</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_beam_node_index-683"><a href="#Lattice.define_beam_node_index-683"><span class="linenos">683</span></a>                <span class="n">b</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">next_beam_idx</span>
</span><span id="Lattice.define_beam_node_index-684"><a href="#Lattice.define_beam_node_index-684"><span class="linenos">684</span></a>                <span class="n">next_beam_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Lattice.define_beam_node_index-685"><a href="#Lattice.define_beam_node_index-685"><span class="linenos">685</span></a>
</span><span id="Lattice.define_beam_node_index-686"><a href="#Lattice.define_beam_node_index-686"><span class="linenos">686</span></a>        <span class="c1"># Nodes</span>
</span><span id="Lattice.define_beam_node_index-687"><a href="#Lattice.define_beam_node_index-687"><span class="linenos">687</span></a>        <span class="n">existing_node_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice.define_beam_node_index-688"><a href="#Lattice.define_beam_node_index-688"><span class="linenos">688</span></a>        <span class="n">next_node_idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">existing_node_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">existing_node_idx</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="Lattice.define_beam_node_index-689"><a href="#Lattice.define_beam_node_index-689"><span class="linenos">689</span></a>
</span><span id="Lattice.define_beam_node_index-690"><a href="#Lattice.define_beam_node_index-690"><span class="linenos">690</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">node_key</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Lattice.define_beam_node_index-691"><a href="#Lattice.define_beam_node_index-691"><span class="linenos">691</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Key for sorting nodes by their coordinates. &quot;&quot;&quot;</span>
</span><span id="Lattice.define_beam_node_index-692"><a href="#Lattice.define_beam_node_index-692"><span class="linenos">692</span></a>            <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">z</span>
</span><span id="Lattice.define_beam_node_index-693"><a href="#Lattice.define_beam_node_index-693"><span class="linenos">693</span></a>
</span><span id="Lattice.define_beam_node_index-694"><a href="#Lattice.define_beam_node_index-694"><span class="linenos">694</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">node_key</span><span class="p">):</span>
</span><span id="Lattice.define_beam_node_index-695"><a href="#Lattice.define_beam_node_index-695"><span class="linenos">695</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_beam_node_index-696"><a href="#Lattice.define_beam_node_index-696"><span class="linenos">696</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">next_node_idx</span>
</span><span id="Lattice.define_beam_node_index-697"><a href="#Lattice.define_beam_node_index-697"><span class="linenos">697</span></a>                <span class="n">next_node_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Define index at each beam and node</p>
</div>


                            </div>
                            <div id="Lattice.define_cell_index" class="classattr">
                                        <input id="Lattice.define_cell_index-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_cell_index</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.define_cell_index-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.define_cell_index"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.define_cell_index-699"><a href="#Lattice.define_cell_index-699"><span class="linenos">699</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_cell_index-700"><a href="#Lattice.define_cell_index-700"><span class="linenos">700</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_cell_index-701"><a href="#Lattice.define_cell_index-701"><span class="linenos">701</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_cell_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_cell_index-702"><a href="#Lattice.define_cell_index-702"><span class="linenos">702</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_cell_index-703"><a href="#Lattice.define_cell_index-703"><span class="linenos">703</span></a><span class="sd">        Define index at each cell</span>
</span><span id="Lattice.define_cell_index-704"><a href="#Lattice.define_cell_index-704"><span class="linenos">704</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.define_cell_index-705"><a href="#Lattice.define_cell_index-705"><span class="linenos">705</span></a>        <span class="n">cellIndexed</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice.define_cell_index-706"><a href="#Lattice.define_cell_index-706"><span class="linenos">706</span></a>        <span class="n">nextCellIndex</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice.define_cell_index-707"><a href="#Lattice.define_cell_index-707"><span class="linenos">707</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.define_cell_index-708"><a href="#Lattice.define_cell_index-708"><span class="linenos">708</span></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_cell_index-709"><a href="#Lattice.define_cell_index-709"><span class="linenos">709</span></a>                <span class="n">cellIndexed</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextCellIndex</span>
</span><span id="Lattice.define_cell_index-710"><a href="#Lattice.define_cell_index-710"><span class="linenos">710</span></a>                <span class="n">nextCellIndex</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Lattice.define_cell_index-711"><a href="#Lattice.define_cell_index-711"><span class="linenos">711</span></a>
</span><span id="Lattice.define_cell_index-712"><a href="#Lattice.define_cell_index-712"><span class="linenos">712</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.define_cell_index-713"><a href="#Lattice.define_cell_index-713"><span class="linenos">713</span></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_cell_index-714"><a href="#Lattice.define_cell_index-714"><span class="linenos">714</span></a>                <span class="k">if</span> <span class="n">cell</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cellIndexed</span><span class="p">:</span>
</span><span id="Lattice.define_cell_index-715"><a href="#Lattice.define_cell_index-715"><span class="linenos">715</span></a>                    <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">nextCellIndex</span>
</span><span id="Lattice.define_cell_index-716"><a href="#Lattice.define_cell_index-716"><span class="linenos">716</span></a>                    <span class="n">cellIndexed</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextCellIndex</span>
</span><span id="Lattice.define_cell_index-717"><a href="#Lattice.define_cell_index-717"><span class="linenos">717</span></a>                    <span class="n">nextCellIndex</span> <span class="o">+=</span> <span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Define index at each cell</p>
</div>


                            </div>
                            <div id="Lattice.define_node_local_tags" class="classattr">
                                        <input id="Lattice.define_node_local_tags-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_node_local_tags</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.define_node_local_tags-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.define_node_local_tags"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.define_node_local_tags-719"><a href="#Lattice.define_node_local_tags-719"><span class="linenos">719</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_node_local_tags-720"><a href="#Lattice.define_node_local_tags-720"><span class="linenos">720</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_node_local_tags-721"><a href="#Lattice.define_node_local_tags-721"><span class="linenos">721</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_node_local_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_node_local_tags-722"><a href="#Lattice.define_node_local_tags-722"><span class="linenos">722</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_node_local_tags-723"><a href="#Lattice.define_node_local_tags-723"><span class="linenos">723</span></a><span class="sd">        Define inside cell boundary tag for all boundary nodes</span>
</span><span id="Lattice.define_node_local_tags-724"><a href="#Lattice.define_node_local_tags-724"><span class="linenos">724</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.define_node_local_tags-725"><a href="#Lattice.define_node_local_tags-725"><span class="linenos">725</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.define_node_local_tags-726"><a href="#Lattice.define_node_local_tags-726"><span class="linenos">726</span></a>            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span>
</span><span id="Lattice.define_node_local_tags-727"><a href="#Lattice.define_node_local_tags-727"><span class="linenos">727</span></a>                <span class="n">local_tag</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tag_point</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">boundary_box</span><span class="p">)</span>
</span><span id="Lattice.define_node_local_tags-728"><a href="#Lattice.define_node_local_tags-728"><span class="linenos">728</span></a>                <span class="k">if</span> <span class="n">local_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_node_local_tags-729"><a href="#Lattice.define_node_local_tags-729"><span class="linenos">729</span></a>                    <span class="n">node</span><span class="o">.</span><span class="n">set_local_tag</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">local_tag</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Define inside cell boundary tag for all boundary nodes</p>
</div>


                            </div>
                            <div id="Lattice.define_cell_neighbours" class="classattr">
                                        <input id="Lattice.define_cell_neighbours-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_cell_neighbours</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.define_cell_neighbours-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.define_cell_neighbours"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.define_cell_neighbours-731"><a href="#Lattice.define_cell_neighbours-731"><span class="linenos">731</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_cell_neighbours-732"><a href="#Lattice.define_cell_neighbours-732"><span class="linenos">732</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_cell_neighbours-733"><a href="#Lattice.define_cell_neighbours-733"><span class="linenos">733</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_cell_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-734"><a href="#Lattice.define_cell_neighbours-734"><span class="linenos">734</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_cell_neighbours-735"><a href="#Lattice.define_cell_neighbours-735"><span class="linenos">735</span></a><span class="sd">        Neighbour assignment using integer grid indices + optional periodic wrap.</span>
</span><span id="Lattice.define_cell_neighbours-736"><a href="#Lattice.define_cell_neighbours-736"><span class="linenos">736</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.define_cell_neighbours-737"><a href="#Lattice.define_cell_neighbours-737"><span class="linenos">737</span></a>        <span class="c1"># Build integer grid indices from positions</span>
</span><span id="Lattice.define_cell_neighbours-738"><a href="#Lattice.define_cell_neighbours-738"><span class="linenos">738</span></a>        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="Lattice.define_cell_neighbours-739"><a href="#Lattice.define_cell_neighbours-739"><span class="linenos">739</span></a>        <span class="n">inv_dx</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_x</span>
</span><span id="Lattice.define_cell_neighbours-740"><a href="#Lattice.define_cell_neighbours-740"><span class="linenos">740</span></a>        <span class="n">inv_dy</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_y</span>
</span><span id="Lattice.define_cell_neighbours-741"><a href="#Lattice.define_cell_neighbours-741"><span class="linenos">741</span></a>        <span class="n">inv_dz</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_size_z</span>
</span><span id="Lattice.define_cell_neighbours-742"><a href="#Lattice.define_cell_neighbours-742"><span class="linenos">742</span></a>
</span><span id="Lattice.define_cell_neighbours-743"><a href="#Lattice.define_cell_neighbours-743"><span class="linenos">743</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">to_idx</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span id="Lattice.define_cell_neighbours-744"><a href="#Lattice.define_cell_neighbours-744"><span class="linenos">744</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_cell_neighbours-745"><a href="#Lattice.define_cell_neighbours-745"><span class="linenos">745</span></a><span class="sd">            Convert position to integer grid index.</span>
</span><span id="Lattice.define_cell_neighbours-746"><a href="#Lattice.define_cell_neighbours-746"><span class="linenos">746</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Lattice.define_cell_neighbours-747"><a href="#Lattice.define_cell_neighbours-747"><span class="linenos">747</span></a>            <span class="c1"># round to be robust to tiny float noise</span>
</span><span id="Lattice.define_cell_neighbours-748"><a href="#Lattice.define_cell_neighbours-748"><span class="linenos">748</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="Lattice.define_cell_neighbours-749"><a href="#Lattice.define_cell_neighbours-749"><span class="linenos">749</span></a>                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_dx</span><span class="p">)),</span>
</span><span id="Lattice.define_cell_neighbours-750"><a href="#Lattice.define_cell_neighbours-750"><span class="linenos">750</span></a>                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_dy</span><span class="p">)),</span>
</span><span id="Lattice.define_cell_neighbours-751"><a href="#Lattice.define_cell_neighbours-751"><span class="linenos">751</span></a>                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv_dz</span><span class="p">)),</span>
</span><span id="Lattice.define_cell_neighbours-752"><a href="#Lattice.define_cell_neighbours-752"><span class="linenos">752</span></a>            <span class="p">)</span>
</span><span id="Lattice.define_cell_neighbours-753"><a href="#Lattice.define_cell_neighbours-753"><span class="linenos">753</span></a>
</span><span id="Lattice.define_cell_neighbours-754"><a href="#Lattice.define_cell_neighbours-754"><span class="linenos">754</span></a>        <span class="n">idx_to_cell</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice.define_cell_neighbours-755"><a href="#Lattice.define_cell_neighbours-755"><span class="linenos">755</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-756"><a href="#Lattice.define_cell_neighbours-756"><span class="linenos">756</span></a>            <span class="n">idx_to_cell</span><span class="p">[</span><span class="n">to_idx</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="Lattice.define_cell_neighbours-757"><a href="#Lattice.define_cell_neighbours-757"><span class="linenos">757</span></a>
</span><span id="Lattice.define_cell_neighbours-758"><a href="#Lattice.define_cell_neighbours-758"><span class="linenos">758</span></a>        <span class="c1"># Grid extents for wrapping / bounds</span>
</span><span id="Lattice.define_cell_neighbours-759"><a href="#Lattice.define_cell_neighbours-759"><span class="linenos">759</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_to_cell</span><span class="p">})</span>
</span><span id="Lattice.define_cell_neighbours-760"><a href="#Lattice.define_cell_neighbours-760"><span class="linenos">760</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">j</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_to_cell</span><span class="p">})</span>
</span><span id="Lattice.define_cell_neighbours-761"><a href="#Lattice.define_cell_neighbours-761"><span class="linenos">761</span></a>        <span class="n">zs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_to_cell</span><span class="p">})</span>
</span><span id="Lattice.define_cell_neighbours-762"><a href="#Lattice.define_cell_neighbours-762"><span class="linenos">762</span></a>        <span class="n">ix0</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="Lattice.define_cell_neighbours-763"><a href="#Lattice.define_cell_neighbours-763"><span class="linenos">763</span></a>        <span class="n">iy0</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span><span id="Lattice.define_cell_neighbours-764"><a href="#Lattice.define_cell_neighbours-764"><span class="linenos">764</span></a>        <span class="n">iz0</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
</span><span id="Lattice.define_cell_neighbours-765"><a href="#Lattice.define_cell_neighbours-765"><span class="linenos">765</span></a>
</span><span id="Lattice.define_cell_neighbours-766"><a href="#Lattice.define_cell_neighbours-766"><span class="linenos">766</span></a>        <span class="c1"># Offsets and their (axis, sign) labels</span>
</span><span id="Lattice.define_cell_neighbours-767"><a href="#Lattice.define_cell_neighbours-767"><span class="linenos">767</span></a>        <span class="n">neighbor_steps</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Lattice.define_cell_neighbours-768"><a href="#Lattice.define_cell_neighbours-768"><span class="linenos">768</span></a>            <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;negatif&quot;</span><span class="p">)),</span>
</span><span id="Lattice.define_cell_neighbours-769"><a href="#Lattice.define_cell_neighbours-769"><span class="linenos">769</span></a>            <span class="p">((</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;positif&quot;</span><span class="p">)),</span>
</span><span id="Lattice.define_cell_neighbours-770"><a href="#Lattice.define_cell_neighbours-770"><span class="linenos">770</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;negatif&quot;</span><span class="p">)),</span>
</span><span id="Lattice.define_cell_neighbours-771"><a href="#Lattice.define_cell_neighbours-771"><span class="linenos">771</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;positif&quot;</span><span class="p">)),</span>
</span><span id="Lattice.define_cell_neighbours-772"><a href="#Lattice.define_cell_neighbours-772"><span class="linenos">772</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;negatif&quot;</span><span class="p">)),</span>
</span><span id="Lattice.define_cell_neighbours-773"><a href="#Lattice.define_cell_neighbours-773"><span class="linenos">773</span></a>            <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;positif&quot;</span><span class="p">)),</span>
</span><span id="Lattice.define_cell_neighbours-774"><a href="#Lattice.define_cell_neighbours-774"><span class="linenos">774</span></a>        <span class="p">]</span>
</span><span id="Lattice.define_cell_neighbours-775"><a href="#Lattice.define_cell_neighbours-775"><span class="linenos">775</span></a>
</span><span id="Lattice.define_cell_neighbours-776"><a href="#Lattice.define_cell_neighbours-776"><span class="linenos">776</span></a>        <span class="c1"># Assign neighbours</span>
</span><span id="Lattice.define_cell_neighbours-777"><a href="#Lattice.define_cell_neighbours-777"><span class="linenos">777</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-778"><a href="#Lattice.define_cell_neighbours-778"><span class="linenos">778</span></a>            <span class="c1"># reset dict container</span>
</span><span id="Lattice.define_cell_neighbours-779"><a href="#Lattice.define_cell_neighbours-779"><span class="linenos">779</span></a>            <span class="n">c</span><span class="o">.</span><span class="n">neighbour_cells</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Lattice.define_cell_neighbours-780"><a href="#Lattice.define_cell_neighbours-780"><span class="linenos">780</span></a>
</span><span id="Lattice.define_cell_neighbours-781"><a href="#Lattice.define_cell_neighbours-781"><span class="linenos">781</span></a>            <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span> <span class="o">=</span> <span class="n">to_idx</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
</span><span id="Lattice.define_cell_neighbours-782"><a href="#Lattice.define_cell_neighbours-782"><span class="linenos">782</span></a>            <span class="k">for</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">),</span> <span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">sign</span><span class="p">)</span> <span class="ow">in</span> <span class="n">neighbor_steps</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-783"><a href="#Lattice.define_cell_neighbours-783"><span class="linenos">783</span></a>                <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">niz</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">iz</span> <span class="o">+</span> <span class="n">dz</span>
</span><span id="Lattice.define_cell_neighbours-784"><a href="#Lattice.define_cell_neighbours-784"><span class="linenos">784</span></a>
</span><span id="Lattice.define_cell_neighbours-785"><a href="#Lattice.define_cell_neighbours-785"><span class="linenos">785</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-786"><a href="#Lattice.define_cell_neighbours-786"><span class="linenos">786</span></a>                    <span class="c1"># periodic wrap (relative to min index of each axis)</span>
</span><span id="Lattice.define_cell_neighbours-787"><a href="#Lattice.define_cell_neighbours-787"><span class="linenos">787</span></a>                    <span class="k">if</span> <span class="n">nx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-788"><a href="#Lattice.define_cell_neighbours-788"><span class="linenos">788</span></a>                        <span class="n">nix</span> <span class="o">=</span> <span class="n">ix0</span> <span class="o">+</span> <span class="p">((</span><span class="n">nix</span> <span class="o">-</span> <span class="n">ix0</span><span class="p">)</span> <span class="o">%</span> <span class="n">nx</span><span class="p">)</span>
</span><span id="Lattice.define_cell_neighbours-789"><a href="#Lattice.define_cell_neighbours-789"><span class="linenos">789</span></a>                    <span class="k">if</span> <span class="n">ny</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-790"><a href="#Lattice.define_cell_neighbours-790"><span class="linenos">790</span></a>                        <span class="n">niy</span> <span class="o">=</span> <span class="n">iy0</span> <span class="o">+</span> <span class="p">((</span><span class="n">niy</span> <span class="o">-</span> <span class="n">iy0</span><span class="p">)</span> <span class="o">%</span> <span class="n">ny</span><span class="p">)</span>
</span><span id="Lattice.define_cell_neighbours-791"><a href="#Lattice.define_cell_neighbours-791"><span class="linenos">791</span></a>                    <span class="k">if</span> <span class="n">nz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-792"><a href="#Lattice.define_cell_neighbours-792"><span class="linenos">792</span></a>                        <span class="n">niz</span> <span class="o">=</span> <span class="n">iz0</span> <span class="o">+</span> <span class="p">((</span><span class="n">niz</span> <span class="o">-</span> <span class="n">iz0</span><span class="p">)</span> <span class="o">%</span> <span class="n">nz</span><span class="p">)</span>
</span><span id="Lattice.define_cell_neighbours-793"><a href="#Lattice.define_cell_neighbours-793"><span class="linenos">793</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-794"><a href="#Lattice.define_cell_neighbours-794"><span class="linenos">794</span></a>                    <span class="c1"># hard bounds (skip if outside)</span>
</span><span id="Lattice.define_cell_neighbours-795"><a href="#Lattice.define_cell_neighbours-795"><span class="linenos">795</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ix0</span> <span class="o">&lt;=</span> <span class="n">nix</span> <span class="o">&lt;</span> <span class="n">ix0</span> <span class="o">+</span> <span class="n">nx</span> <span class="ow">and</span> <span class="n">iy0</span> <span class="o">&lt;=</span> <span class="n">niy</span> <span class="o">&lt;</span> <span class="n">iy0</span> <span class="o">+</span> <span class="n">ny</span> <span class="ow">and</span> <span class="n">iz0</span> <span class="o">&lt;=</span> <span class="n">niz</span> <span class="o">&lt;</span> <span class="n">iz0</span> <span class="o">+</span> <span class="n">nz</span><span class="p">):</span>
</span><span id="Lattice.define_cell_neighbours-796"><a href="#Lattice.define_cell_neighbours-796"><span class="linenos">796</span></a>                        <span class="k">continue</span>
</span><span id="Lattice.define_cell_neighbours-797"><a href="#Lattice.define_cell_neighbours-797"><span class="linenos">797</span></a>
</span><span id="Lattice.define_cell_neighbours-798"><a href="#Lattice.define_cell_neighbours-798"><span class="linenos">798</span></a>                <span class="n">neigh</span> <span class="o">=</span> <span class="n">idx_to_cell</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">niz</span><span class="p">))</span>
</span><span id="Lattice.define_cell_neighbours-799"><a href="#Lattice.define_cell_neighbours-799"><span class="linenos">799</span></a>                <span class="k">if</span> <span class="n">neigh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_cell_neighbours-800"><a href="#Lattice.define_cell_neighbours-800"><span class="linenos">800</span></a>                    <span class="n">c</span><span class="o">.</span><span class="n">add_cell_neighbour</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">sign</span><span class="p">,</span> <span class="n">neigh</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Neighbour assignment using integer grid indices + optional periodic wrap.</p>
</div>


                            </div>
                            <div id="Lattice.define_connected_beams_for_all_nodes" class="classattr">
                                        <input id="Lattice.define_connected_beams_for_all_nodes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_connected_beams_for_all_nodes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">merge_tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-09</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.define_connected_beams_for_all_nodes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.define_connected_beams_for_all_nodes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.define_connected_beams_for_all_nodes-802"><a href="#Lattice.define_connected_beams_for_all_nodes-802"><span class="linenos">802</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-803"><a href="#Lattice.define_connected_beams_for_all_nodes-803"><span class="linenos">803</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-804"><a href="#Lattice.define_connected_beams_for_all_nodes-804"><span class="linenos">804</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_connected_beams_for_all_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merge_tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-805"><a href="#Lattice.define_connected_beams_for_all_nodes-805"><span class="linenos">805</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-806"><a href="#Lattice.define_connected_beams_for_all_nodes-806"><span class="linenos">806</span></a><span class="sd">        Populate `Point.connected_beams` for all nodes.</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-807"><a href="#Lattice.define_connected_beams_for_all_nodes-807"><span class="linenos">807</span></a><span class="sd">        Optionally merges connectivity for coincident/periodic nodes via a spatial hash.</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-808"><a href="#Lattice.define_connected_beams_for_all_nodes-808"><span class="linenos">808</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-809"><a href="#Lattice.define_connected_beams_for_all_nodes-809"><span class="linenos">809</span></a><span class="sd">        Parameters</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-810"><a href="#Lattice.define_connected_beams_for_all_nodes-810"><span class="linenos">810</span></a><span class="sd">        ----------</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-811"><a href="#Lattice.define_connected_beams_for_all_nodes-811"><span class="linenos">811</span></a><span class="sd">        merge_tol : float</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-812"><a href="#Lattice.define_connected_beams_for_all_nodes-812"><span class="linenos">812</span></a><span class="sd">            Quantization used to bucket nearly-identical coordinates (and periodic wraps).</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-813"><a href="#Lattice.define_connected_beams_for_all_nodes-813"><span class="linenos">813</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-814"><a href="#Lattice.define_connected_beams_for_all_nodes-814"><span class="linenos">814</span></a>        <span class="c1"># Reset connected_beams</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-815"><a href="#Lattice.define_connected_beams_for_all_nodes-815"><span class="linenos">815</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-816"><a href="#Lattice.define_connected_beams_for_all_nodes-816"><span class="linenos">816</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-817"><a href="#Lattice.define_connected_beams_for_all_nodes-817"><span class="linenos">817</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-818"><a href="#Lattice.define_connected_beams_for_all_nodes-818"><span class="linenos">818</span></a>        <span class="c1"># Single pass: attach each beam to its two endpoints</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-819"><a href="#Lattice.define_connected_beams_for_all_nodes-819"><span class="linenos">819</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-820"><a href="#Lattice.define_connected_beams_for_all_nodes-820"><span class="linenos">820</span></a>            <span class="n">a</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-821"><a href="#Lattice.define_connected_beams_for_all_nodes-821"><span class="linenos">821</span></a>            <span class="n">a</span><span class="o">.</span><span class="n">connected_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-822"><a href="#Lattice.define_connected_beams_for_all_nodes-822"><span class="linenos">822</span></a>            <span class="n">c</span><span class="o">.</span><span class="n">connected_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-823"><a href="#Lattice.define_connected_beams_for_all_nodes-823"><span class="linenos">823</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-824"><a href="#Lattice.define_connected_beams_for_all_nodes-824"><span class="linenos">824</span></a>        <span class="c1">#  Optional stitching of coincident &amp; periodic nodes via spatial hashing</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-825"><a href="#Lattice.define_connected_beams_for_all_nodes-825"><span class="linenos">825</span></a>        <span class="c1"># Build spatial buckets</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-826"><a href="#Lattice.define_connected_beams_for_all_nodes-826"><span class="linenos">826</span></a>        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-827"><a href="#Lattice.define_connected_beams_for_all_nodes-827"><span class="linenos">827</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-828"><a href="#Lattice.define_connected_beams_for_all_nodes-828"><span class="linenos">828</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">qkey</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-829"><a href="#Lattice.define_connected_beams_for_all_nodes-829"><span class="linenos">829</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Quantized key for spatial hashing.&quot;&quot;&quot;</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-830"><a href="#Lattice.define_connected_beams_for_all_nodes-830"><span class="linenos">830</span></a>            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">merge_tol</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">merge_tol</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="n">merge_tol</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-831"><a href="#Lattice.define_connected_beams_for_all_nodes-831"><span class="linenos">831</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-832"><a href="#Lattice.define_connected_beams_for_all_nodes-832"><span class="linenos">832</span></a>        <span class="n">buckets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># geometric buckets (exact/coincident)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-833"><a href="#Lattice.define_connected_beams_for_all_nodes-833"><span class="linenos">833</span></a>        <span class="n">periodic_buckets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># buckets after wrapping (only if periodicity enabled)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-834"><a href="#Lattice.define_connected_beams_for_all_nodes-834"><span class="linenos">834</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-835"><a href="#Lattice.define_connected_beams_for_all_nodes-835"><span class="linenos">835</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">add_to_bucket</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-836"><a href="#Lattice.define_connected_beams_for_all_nodes-836"><span class="linenos">836</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Add point to geometric bucket.&quot;&quot;&quot;</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-837"><a href="#Lattice.define_connected_beams_for_all_nodes-837"><span class="linenos">837</span></a>            <span class="n">k</span> <span class="o">=</span> <span class="n">qkey</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-838"><a href="#Lattice.define_connected_beams_for_all_nodes-838"><span class="linenos">838</span></a>            <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-839"><a href="#Lattice.define_connected_beams_for_all_nodes-839"><span class="linenos">839</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-840"><a href="#Lattice.define_connected_beams_for_all_nodes-840"><span class="linenos">840</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">add_to_periodic_bucket</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-841"><a href="#Lattice.define_connected_beams_for_all_nodes-841"><span class="linenos">841</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Add point to periodic bucket (wrap max-face to min-face).&quot;&quot;&quot;</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-842"><a href="#Lattice.define_connected_beams_for_all_nodes-842"><span class="linenos">842</span></a>            <span class="n">wx</span> <span class="o">=</span> <span class="n">xmin</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">merge_tol</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-843"><a href="#Lattice.define_connected_beams_for_all_nodes-843"><span class="linenos">843</span></a>            <span class="n">wy</span> <span class="o">=</span> <span class="n">ymin</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">merge_tol</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-844"><a href="#Lattice.define_connected_beams_for_all_nodes-844"><span class="linenos">844</span></a>            <span class="n">wz</span> <span class="o">=</span> <span class="n">zmin</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">zmax</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">merge_tol</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-845"><a href="#Lattice.define_connected_beams_for_all_nodes-845"><span class="linenos">845</span></a>            <span class="n">k</span> <span class="o">=</span> <span class="n">qkey</span><span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-846"><a href="#Lattice.define_connected_beams_for_all_nodes-846"><span class="linenos">846</span></a>            <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-847"><a href="#Lattice.define_connected_beams_for_all_nodes-847"><span class="linenos">847</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-848"><a href="#Lattice.define_connected_beams_for_all_nodes-848"><span class="linenos">848</span></a>        <span class="c1"># Fill buckets</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-849"><a href="#Lattice.define_connected_beams_for_all_nodes-849"><span class="linenos">849</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-850"><a href="#Lattice.define_connected_beams_for_all_nodes-850"><span class="linenos">850</span></a>            <span class="n">add_to_bucket</span><span class="p">(</span><span class="n">buckets</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-851"><a href="#Lattice.define_connected_beams_for_all_nodes-851"><span class="linenos">851</span></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;enable_periodicity&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-852"><a href="#Lattice.define_connected_beams_for_all_nodes-852"><span class="linenos">852</span></a>                <span class="n">add_to_periodic_bucket</span><span class="p">(</span><span class="n">periodic_buckets</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-853"><a href="#Lattice.define_connected_beams_for_all_nodes-853"><span class="linenos">853</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-854"><a href="#Lattice.define_connected_beams_for_all_nodes-854"><span class="linenos">854</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">merge_bucket_connectivity</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-855"><a href="#Lattice.define_connected_beams_for_all_nodes-855"><span class="linenos">855</span></a>            <span class="k">for</span> <span class="n">pts</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-856"><a href="#Lattice.define_connected_beams_for_all_nodes-856"><span class="linenos">856</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-857"><a href="#Lattice.define_connected_beams_for_all_nodes-857"><span class="linenos">857</span></a>                    <span class="k">continue</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-858"><a href="#Lattice.define_connected_beams_for_all_nodes-858"><span class="linenos">858</span></a>                <span class="n">merged</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-859"><a href="#Lattice.define_connected_beams_for_all_nodes-859"><span class="linenos">859</span></a>                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-860"><a href="#Lattice.define_connected_beams_for_all_nodes-860"><span class="linenos">860</span></a>                    <span class="n">merged</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-861"><a href="#Lattice.define_connected_beams_for_all_nodes-861"><span class="linenos">861</span></a>                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-862"><a href="#Lattice.define_connected_beams_for_all_nodes-862"><span class="linenos">862</span></a>                    <span class="n">pt</span><span class="o">.</span><span class="n">connected_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-863"><a href="#Lattice.define_connected_beams_for_all_nodes-863"><span class="linenos">863</span></a>
</span><span id="Lattice.define_connected_beams_for_all_nodes-864"><a href="#Lattice.define_connected_beams_for_all_nodes-864"><span class="linenos">864</span></a>        <span class="n">merge_bucket_connectivity</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-865"><a href="#Lattice.define_connected_beams_for_all_nodes-865"><span class="linenos">865</span></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;enable_periodicity&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="Lattice.define_connected_beams_for_all_nodes-866"><a href="#Lattice.define_connected_beams_for_all_nodes-866"><span class="linenos">866</span></a>            <span class="n">merge_bucket_connectivity</span><span class="p">(</span><span class="n">periodic_buckets</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Populate <code>Point.connected_beams</code> for all nodes.
Optionally merges connectivity for coincident/periodic nodes via a spatial hash.</p>

<h2 id="parameters">Parameters</h2>

<p>merge_tol : float
    Quantization used to bucket nearly-identical coordinates (and periodic wraps).</p>
</div>


                            </div>
                            <div id="Lattice.define_angles_between_beams" class="classattr">
                                        <input id="Lattice.define_angles_between_beams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;design&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">define_angles_between_beams</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.define_angles_between_beams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.define_angles_between_beams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.define_angles_between_beams-868"><a href="#Lattice.define_angles_between_beams-868"><span class="linenos">868</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;design&quot;</span><span class="p">)</span>
</span><span id="Lattice.define_angles_between_beams-869"><a href="#Lattice.define_angles_between_beams-869"><span class="linenos">869</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_angles_between_beams-870"><a href="#Lattice.define_angles_between_beams-870"><span class="linenos">870</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_angles_between_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.define_angles_between_beams-871"><a href="#Lattice.define_angles_between_beams-871"><span class="linenos">871</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.define_angles_between_beams-872"><a href="#Lattice.define_angles_between_beams-872"><span class="linenos">872</span></a><span class="sd">        Compute, for each beam, the penalization-optimal angle at its two endpoints</span>
</span><span id="Lattice.define_angles_between_beams-873"><a href="#Lattice.define_angles_between_beams-873"><span class="linenos">873</span></a><span class="sd">        using node-level connectivity (Point.connected_beams). Assumes</span>
</span><span id="Lattice.define_angles_between_beams-874"><a href="#Lattice.define_angles_between_beams-874"><span class="linenos">874</span></a><span class="sd">        `define_connected_beams_for_all_nodes()` has been called.</span>
</span><span id="Lattice.define_angles_between_beams-875"><a href="#Lattice.define_angles_between_beams-875"><span class="linenos">875</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.define_angles_between_beams-876"><a href="#Lattice.define_angles_between_beams-876"><span class="linenos">876</span></a>        <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.define_angles_between_beams-877"><a href="#Lattice.define_angles_between_beams-877"><span class="linenos">877</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_best_by_penalization</span><span class="p">(</span><span class="n">angles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">radii</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Lattice.define_angles_between_beams-878"><a href="#Lattice.define_angles_between_beams-878"><span class="linenos">878</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Return (angle, radius) that maximizes L = function_penalization_Lzone((radius, angle)).&quot;&quot;&quot;</span>
</span><span id="Lattice.define_angles_between_beams-879"><a href="#Lattice.define_angles_between_beams-879"><span class="linenos">879</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">angles</span><span class="p">:</span>
</span><span id="Lattice.define_angles_between_beams-880"><a href="#Lattice.define_angles_between_beams-880"><span class="linenos">880</span></a>                <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
</span><span id="Lattice.define_angles_between_beams-881"><a href="#Lattice.define_angles_between_beams-881"><span class="linenos">881</span></a>            <span class="n">Lmax</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="Lattice.define_angles_between_beams-882"><a href="#Lattice.define_angles_between_beams-882"><span class="linenos">882</span></a>            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">angles</span><span class="p">):</span>
</span><span id="Lattice.define_angles_between_beams-883"><a href="#Lattice.define_angles_between_beams-883"><span class="linenos">883</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">function_penalization_Lzone</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span id="Lattice.define_angles_between_beams-884"><a href="#Lattice.define_angles_between_beams-884"><span class="linenos">884</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="o">&gt;</span> <span class="n">Lmax</span><span class="p">:</span>
</span><span id="Lattice.define_angles_between_beams-885"><a href="#Lattice.define_angles_between_beams-885"><span class="linenos">885</span></a>                    <span class="n">Lmax</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="n">L</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="Lattice.define_angles_between_beams-886"><a href="#Lattice.define_angles_between_beams-886"><span class="linenos">886</span></a>            <span class="k">return</span> <span class="n">best</span>
</span><span id="Lattice.define_angles_between_beams-887"><a href="#Lattice.define_angles_between_beams-887"><span class="linenos">887</span></a>
</span><span id="Lattice.define_angles_between_beams-888"><a href="#Lattice.define_angles_between_beams-888"><span class="linenos">888</span></a>        <span class="c1"># Compute angles using local node neighborhoods only</span>
</span><span id="Lattice.define_angles_between_beams-889"><a href="#Lattice.define_angles_between_beams-889"><span class="linenos">889</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice.define_angles_between_beams-890"><a href="#Lattice.define_angles_between_beams-890"><span class="linenos">890</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">):</span>
</span><span id="Lattice.define_angles_between_beams-891"><a href="#Lattice.define_angles_between_beams-891"><span class="linenos">891</span></a>                <span class="n">a1_list</span><span class="p">,</span> <span class="n">r1_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Lattice.define_angles_between_beams-892"><a href="#Lattice.define_angles_between_beams-892"><span class="linenos">892</span></a>                <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">:</span>
</span><span id="Lattice.define_angles_between_beams-893"><a href="#Lattice.define_angles_between_beams-893"><span class="linenos">893</span></a>                    <span class="k">if</span> <span class="n">nb</span> <span class="ow">is</span> <span class="n">b</span><span class="p">:</span> <span class="k">continue</span>
</span><span id="Lattice.define_angles_between_beams-894"><a href="#Lattice.define_angles_between_beams-894"><span class="linenos">894</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice.define_angles_between_beams-895"><a href="#Lattice.define_angles_between_beams-895"><span class="linenos">895</span></a>                        <span class="n">ang</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_angle_between_beams</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span><span class="p">)</span>
</span><span id="Lattice.define_angles_between_beams-896"><a href="#Lattice.define_angles_between_beams-896"><span class="linenos">896</span></a>                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="Lattice.define_angles_between_beams-897"><a href="#Lattice.define_angles_between_beams-897"><span class="linenos">897</span></a>                        <span class="k">continue</span>
</span><span id="Lattice.define_angles_between_beams-898"><a href="#Lattice.define_angles_between_beams-898"><span class="linenos">898</span></a>                    <span class="k">if</span> <span class="n">ang</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">:</span>
</span><span id="Lattice.define_angles_between_beams-899"><a href="#Lattice.define_angles_between_beams-899"><span class="linenos">899</span></a>                        <span class="n">a1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ang</span><span class="p">);</span>
</span><span id="Lattice.define_angles_between_beams-900"><a href="#Lattice.define_angles_between_beams-900"><span class="linenos">900</span></a>                        <span class="n">r1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</span><span id="Lattice.define_angles_between_beams-901"><a href="#Lattice.define_angles_between_beams-901"><span class="linenos">901</span></a>                <span class="n">ang1</span><span class="p">,</span> <span class="n">rad1</span> <span class="o">=</span> <span class="n">_best_by_penalization</span><span class="p">(</span><span class="n">a1_list</span><span class="p">,</span> <span class="n">r1_list</span><span class="p">)</span>
</span><span id="Lattice.define_angles_between_beams-902"><a href="#Lattice.define_angles_between_beams-902"><span class="linenos">902</span></a>                <span class="n">b</span><span class="o">.</span><span class="n">set_angle</span><span class="p">(</span><span class="n">rad1</span><span class="p">,</span> <span class="n">ang1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute, for each beam, the penalization-optimal angle at its two endpoints
using node-level connectivity (Point.connected_beams). Assumes
<code><a href="#Lattice.define_connected_beams_for_all_nodes">define_connected_beams_for_all_nodes()</a></code> has been called.</p>
</div>


                            </div>
                            <div id="Lattice.refresh_cells_memberships" class="classattr">
                                        <input id="Lattice.refresh_cells_memberships-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">refresh_cells_memberships</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.refresh_cells_memberships-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.refresh_cells_memberships"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.refresh_cells_memberships-922"><a href="#Lattice.refresh_cells_memberships-922"><span class="linenos">922</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.refresh_cells_memberships-923"><a href="#Lattice.refresh_cells_memberships-923"><span class="linenos">923</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.refresh_cells_memberships-924"><a href="#Lattice.refresh_cells_memberships-924"><span class="linenos">924</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_cells_memberships</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.refresh_cells_memberships-925"><a href="#Lattice.refresh_cells_memberships-925"><span class="linenos">925</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.refresh_cells_memberships-926"><a href="#Lattice.refresh_cells_memberships-926"><span class="linenos">926</span></a><span class="sd">        Public helper to refresh all cells&#39; beams/points from the current global state.</span>
</span><span id="Lattice.refresh_cells_memberships-927"><a href="#Lattice.refresh_cells_memberships-927"><span class="linenos">927</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.refresh_cells_memberships-928"><a href="#Lattice.refresh_cells_memberships-928"><span class="linenos">928</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.refresh_cells_memberships-929"><a href="#Lattice.refresh_cells_memberships-929"><span class="linenos">929</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;refresh_from_global&quot;</span><span class="p">):</span>
</span><span id="Lattice.refresh_cells_memberships-930"><a href="#Lattice.refresh_cells_memberships-930"><span class="linenos">930</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">refresh_from_global</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Public helper to refresh all cells' beams/points from the current global state.</p>
</div>


                            </div>
                            <div id="Lattice.remove_cell" class="classattr">
                                        <input id="Lattice.remove_cell-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">remove_cell</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">index</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.remove_cell-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.remove_cell"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.remove_cell-932"><a href="#Lattice.remove_cell-932"><span class="linenos">932</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.remove_cell-933"><a href="#Lattice.remove_cell-933"><span class="linenos">933</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.remove_cell-934"><a href="#Lattice.remove_cell-934"><span class="linenos">934</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.remove_cell-935"><a href="#Lattice.remove_cell-935"><span class="linenos">935</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.remove_cell-936"><a href="#Lattice.remove_cell-936"><span class="linenos">936</span></a><span class="sd">        Removes a cell from the lattice</span>
</span><span id="Lattice.remove_cell-937"><a href="#Lattice.remove_cell-937"><span class="linenos">937</span></a>
</span><span id="Lattice.remove_cell-938"><a href="#Lattice.remove_cell-938"><span class="linenos">938</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.remove_cell-939"><a href="#Lattice.remove_cell-939"><span class="linenos">939</span></a><span class="sd">        ------------</span>
</span><span id="Lattice.remove_cell-940"><a href="#Lattice.remove_cell-940"><span class="linenos">940</span></a><span class="sd">        index: int</span>
</span><span id="Lattice.remove_cell-941"><a href="#Lattice.remove_cell-941"><span class="linenos">941</span></a><span class="sd">            index of the cell to remove</span>
</span><span id="Lattice.remove_cell-942"><a href="#Lattice.remove_cell-942"><span class="linenos">942</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.remove_cell-943"><a href="#Lattice.remove_cell-943"><span class="linenos">943</span></a>        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="Lattice.remove_cell-944"><a href="#Lattice.remove_cell-944"><span class="linenos">944</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="Lattice.remove_cell-945"><a href="#Lattice.remove_cell-945"><span class="linenos">945</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.remove_cell-946"><a href="#Lattice.remove_cell-946"><span class="linenos">946</span></a>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Invalid cell index.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Removes a cell from the lattice</p>

<h2 id="parameters">Parameters:</h2>

<p>index: int
    index of the cell to remove</p>
</div>


                            </div>
                            <div id="Lattice.find_minimum_beam_length" class="classattr">
                                        <input id="Lattice.find_minimum_beam_length-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">find_minimum_beam_length</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Lattice.find_minimum_beam_length-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.find_minimum_beam_length"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.find_minimum_beam_length-948"><a href="#Lattice.find_minimum_beam_length-948"><span class="linenos">948</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.find_minimum_beam_length-949"><a href="#Lattice.find_minimum_beam_length-949"><span class="linenos">949</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.find_minimum_beam_length-950"><a href="#Lattice.find_minimum_beam_length-950"><span class="linenos">950</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_minimum_beam_length</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Lattice.find_minimum_beam_length-951"><a href="#Lattice.find_minimum_beam_length-951"><span class="linenos">951</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.find_minimum_beam_length-952"><a href="#Lattice.find_minimum_beam_length-952"><span class="linenos">952</span></a><span class="sd">        Find minimum beam length</span>
</span><span id="Lattice.find_minimum_beam_length-953"><a href="#Lattice.find_minimum_beam_length-953"><span class="linenos">953</span></a>
</span><span id="Lattice.find_minimum_beam_length-954"><a href="#Lattice.find_minimum_beam_length-954"><span class="linenos">954</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice.find_minimum_beam_length-955"><a href="#Lattice.find_minimum_beam_length-955"><span class="linenos">955</span></a><span class="sd">        --------</span>
</span><span id="Lattice.find_minimum_beam_length-956"><a href="#Lattice.find_minimum_beam_length-956"><span class="linenos">956</span></a><span class="sd">        minLength: float</span>
</span><span id="Lattice.find_minimum_beam_length-957"><a href="#Lattice.find_minimum_beam_length-957"><span class="linenos">957</span></a><span class="sd">            Length of the smallest beam in the lattice</span>
</span><span id="Lattice.find_minimum_beam_length-958"><a href="#Lattice.find_minimum_beam_length-958"><span class="linenos">958</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.find_minimum_beam_length-959"><a href="#Lattice.find_minimum_beam_length-959"><span class="linenos">959</span></a>        <span class="n">minLength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="Lattice.find_minimum_beam_length-960"><a href="#Lattice.find_minimum_beam_length-960"><span class="linenos">960</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.find_minimum_beam_length-961"><a href="#Lattice.find_minimum_beam_length-961"><span class="linenos">961</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Lattice.find_minimum_beam_length-962"><a href="#Lattice.find_minimum_beam_length-962"><span class="linenos">962</span></a>                <span class="k">if</span> <span class="n">minLength</span> <span class="o">&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mf">0.0001</span> <span class="ow">and</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="Lattice.find_minimum_beam_length-963"><a href="#Lattice.find_minimum_beam_length-963"><span class="linenos">963</span></a>                    <span class="n">minLength</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">length</span>
</span><span id="Lattice.find_minimum_beam_length-964"><a href="#Lattice.find_minimum_beam_length-964"><span class="linenos">964</span></a>        <span class="k">return</span> <span class="n">minLength</span>
</span></pre></div>


            <div class="docstring"><p>Find minimum beam length</p>

<h2 id="returns">Returns:</h2>

<p>minLength: float
    Length of the smallest beam in the lattice</p>
</div>


                            </div>
                            <div id="Lattice.get_tag_list" class="classattr">
                                        <input id="Lattice.get_tag_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_tag_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_tag_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_tag_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_tag_list-966"><a href="#Lattice.get_tag_list-966"><span class="linenos">966</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_tag_list-967"><a href="#Lattice.get_tag_list-967"><span class="linenos">967</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_tag_list-968"><a href="#Lattice.get_tag_list-968"><span class="linenos">968</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tag_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Lattice.get_tag_list-969"><a href="#Lattice.get_tag_list-969"><span class="linenos">969</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the tag for all unique points in the lattice.&quot;&quot;&quot;</span>
</span><span id="Lattice.get_tag_list-970"><a href="#Lattice.get_tag_list-970"><span class="linenos">970</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Get the tag for all unique points in the lattice.</p>
</div>


                            </div>
                            <div id="Lattice.get_tag_list_boundary" class="classattr">
                                        <input id="Lattice.get_tag_list_boundary-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_tag_list_boundary</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_tag_list_boundary-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_tag_list_boundary"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_tag_list_boundary-972"><a href="#Lattice.get_tag_list_boundary-972"><span class="linenos">972</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_tag_list_boundary-973"><a href="#Lattice.get_tag_list_boundary-973"><span class="linenos">973</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_tag_list_boundary-974"><a href="#Lattice.get_tag_list_boundary-974"><span class="linenos">974</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tag_list_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Lattice.get_tag_list_boundary-975"><a href="#Lattice.get_tag_list_boundary-975"><span class="linenos">975</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the tag for boundary points in the lattice.&quot;&quot;&quot;</span>
</span><span id="Lattice.get_tag_list_boundary-976"><a href="#Lattice.get_tag_list_boundary-976"><span class="linenos">976</span></a>        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="Lattice.get_tag_list_boundary-977"><a href="#Lattice.get_tag_list_boundary-977"><span class="linenos">977</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_on_boundary</span><span class="p">(</span><span class="n">bbox</span><span class="p">)]</span>
</span></pre></div>


            <div class="docstring"><p>Get the tag for boundary points in the lattice.</p>
</div>


                            </div>
                            <div id="Lattice.apply_tag_all_point" class="classattr">
                                        <input id="Lattice.apply_tag_all_point-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">apply_tag_all_point</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.apply_tag_all_point-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.apply_tag_all_point"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.apply_tag_all_point-979"><a href="#Lattice.apply_tag_all_point-979"><span class="linenos">979</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.apply_tag_all_point-980"><a href="#Lattice.apply_tag_all_point-980"><span class="linenos">980</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.apply_tag_all_point-981"><a href="#Lattice.apply_tag_all_point-981"><span class="linenos">981</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_tag_all_point</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.apply_tag_all_point-982"><a href="#Lattice.apply_tag_all_point-982"><span class="linenos">982</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.apply_tag_all_point-983"><a href="#Lattice.apply_tag_all_point-983"><span class="linenos">983</span></a><span class="sd">        Assign a tag to all nodes in the lattice structure.</span>
</span><span id="Lattice.apply_tag_all_point-984"><a href="#Lattice.apply_tag_all_point-984"><span class="linenos">984</span></a><span class="sd">        Tags are assigned relative to either the global bounding box</span>
</span><span id="Lattice.apply_tag_all_point-985"><a href="#Lattice.apply_tag_all_point-985"><span class="linenos">985</span></a><span class="sd">        or a local (cell-relative) bounding box if erased parts are used.</span>
</span><span id="Lattice.apply_tag_all_point-986"><a href="#Lattice.apply_tag_all_point-986"><span class="linenos">986</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.apply_tag_all_point-987"><a href="#Lattice.apply_tag_all_point-987"><span class="linenos">987</span></a>        <span class="n">use_local_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eraser_blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="Lattice.apply_tag_all_point-988"><a href="#Lattice.apply_tag_all_point-988"><span class="linenos">988</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_local_box</span><span class="p">:</span>
</span><span id="Lattice.apply_tag_all_point-989"><a href="#Lattice.apply_tag_all_point-989"><span class="linenos">989</span></a>            <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lattice_boundary_box</span><span class="p">()</span>
</span><span id="Lattice.apply_tag_all_point-990"><a href="#Lattice.apply_tag_all_point-990"><span class="linenos">990</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="Lattice.apply_tag_all_point-991"><a href="#Lattice.apply_tag_all_point-991"><span class="linenos">991</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tag_point</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
</span><span id="Lattice.apply_tag_all_point-992"><a href="#Lattice.apply_tag_all_point-992"><span class="linenos">992</span></a>            <span class="k">return</span>
</span><span id="Lattice.apply_tag_all_point-993"><a href="#Lattice.apply_tag_all_point-993"><span class="linenos">993</span></a>
</span><span id="Lattice.apply_tag_all_point-994"><a href="#Lattice.apply_tag_all_point-994"><span class="linenos">994</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.apply_tag_all_point-995"><a href="#Lattice.apply_tag_all_point-995"><span class="linenos">995</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_occupancy_matrix</span><span class="p">()</span>
</span><span id="Lattice.apply_tag_all_point-996"><a href="#Lattice.apply_tag_all_point-996"><span class="linenos">996</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.apply_tag_all_point-997"><a href="#Lattice.apply_tag_all_point-997"><span class="linenos">997</span></a>            <span class="n">local_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relative_boundary_box</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="Lattice.apply_tag_all_point-998"><a href="#Lattice.apply_tag_all_point-998"><span class="linenos">998</span></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">:</span>
</span><span id="Lattice.apply_tag_all_point-999"><a href="#Lattice.apply_tag_all_point-999"><span class="linenos">999</span></a>                <span class="n">n</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tag_point</span><span class="p">(</span><span class="n">local_box</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Assign a tag to all nodes in the lattice structure.
Tags are assigned relative to either the global bounding box
or a local (cell-relative) bounding box if erased parts are used.</p>
</div>


                            </div>
                            <div id="Lattice.get_cell_occupancy_matrix" class="classattr">
                                        <input id="Lattice.get_cell_occupancy_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_cell_occupancy_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Lattice.get_cell_occupancy_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_cell_occupancy_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_cell_occupancy_matrix-1001"><a href="#Lattice.get_cell_occupancy_matrix-1001"><span class="linenos">1001</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1002"><a href="#Lattice.get_cell_occupancy_matrix-1002"><span class="linenos">1002</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1003"><a href="#Lattice.get_cell_occupancy_matrix-1003"><span class="linenos">1003</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cell_occupancy_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1004"><a href="#Lattice.get_cell_occupancy_matrix-1004"><span class="linenos">1004</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1005"><a href="#Lattice.get_cell_occupancy_matrix-1005"><span class="linenos">1005</span></a><span class="sd">        Build a 3D matrix storing Cell objects (or None) at each (i, j, k).</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1006"><a href="#Lattice.get_cell_occupancy_matrix-1006"><span class="linenos">1006</span></a>
</span><span id="Lattice.get_cell_occupancy_matrix-1007"><a href="#Lattice.get_cell_occupancy_matrix-1007"><span class="linenos">1007</span></a><span class="sd">        Returns</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1008"><a href="#Lattice.get_cell_occupancy_matrix-1008"><span class="linenos">1008</span></a><span class="sd">        -------</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1009"><a href="#Lattice.get_cell_occupancy_matrix-1009"><span class="linenos">1009</span></a><span class="sd">        occupancy_matrix : np.ndarray, shape (num_cells_x, num_cells_y, num_cells_z), dtype=object</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1010"><a href="#Lattice.get_cell_occupancy_matrix-1010"><span class="linenos">1010</span></a><span class="sd">            occupancy_matrix[i, j, k] is the Cell at that grid position, or None if empty.</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1011"><a href="#Lattice.get_cell_occupancy_matrix-1011"><span class="linenos">1011</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1012"><a href="#Lattice.get_cell_occupancy_matrix-1012"><span class="linenos">1012</span></a>        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells_z</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1013"><a href="#Lattice.get_cell_occupancy_matrix-1013"><span class="linenos">1013</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1014"><a href="#Lattice.get_cell_occupancy_matrix-1014"><span class="linenos">1014</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1015"><a href="#Lattice.get_cell_occupancy_matrix-1015"><span class="linenos">1015</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1016"><a href="#Lattice.get_cell_occupancy_matrix-1016"><span class="linenos">1016</span></a>            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">pos</span>  <span class="c1"># integer grid indices</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1017"><a href="#Lattice.get_cell_occupancy_matrix-1017"><span class="linenos">1017</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>
</span><span id="Lattice.get_cell_occupancy_matrix-1018"><a href="#Lattice.get_cell_occupancy_matrix-1018"><span class="linenos">1018</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span>
</span></pre></div>


            <div class="docstring"><p>Build a 3D matrix storing Cell objects (or None) at each (i, j, k).</p>

<h2 id="returns">Returns</h2>

<p>occupancy_matrix : np.ndarray, shape (num_cells_x, num_cells_y, num_cells_z), dtype=object
    occupancy_matrix[i, j, k] is the Cell at that grid position, or None if empty.</p>
</div>


                            </div>
                            <div id="Lattice.get_cells_at_index" class="classattr">
                                        <input id="Lattice.get_cells_at_index-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_cells_at_index</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">axis</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">index</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_cells_at_index-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_cells_at_index"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_cells_at_index-1020"><a href="#Lattice.get_cells_at_index-1020"><span class="linenos">1020</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_cells_at_index-1021"><a href="#Lattice.get_cells_at_index-1021"><span class="linenos">1021</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_cells_at_index-1022"><a href="#Lattice.get_cells_at_index-1022"><span class="linenos">1022</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cells_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Lattice.get_cells_at_index-1023"><a href="#Lattice.get_cells_at_index-1023"><span class="linenos">1023</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_cells_at_index-1024"><a href="#Lattice.get_cells_at_index-1024"><span class="linenos">1024</span></a><span class="sd">        Get all cells at a specific index along a specified axis.</span>
</span><span id="Lattice.get_cells_at_index-1025"><a href="#Lattice.get_cells_at_index-1025"><span class="linenos">1025</span></a>
</span><span id="Lattice.get_cells_at_index-1026"><a href="#Lattice.get_cells_at_index-1026"><span class="linenos">1026</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.get_cells_at_index-1027"><a href="#Lattice.get_cells_at_index-1027"><span class="linenos">1027</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.get_cells_at_index-1028"><a href="#Lattice.get_cells_at_index-1028"><span class="linenos">1028</span></a><span class="sd">        axis: str</span>
</span><span id="Lattice.get_cells_at_index-1029"><a href="#Lattice.get_cells_at_index-1029"><span class="linenos">1029</span></a><span class="sd">            Axis to query (&#39;x&#39;, &#39;y&#39;, or &#39;z&#39;).</span>
</span><span id="Lattice.get_cells_at_index-1030"><a href="#Lattice.get_cells_at_index-1030"><span class="linenos">1030</span></a>
</span><span id="Lattice.get_cells_at_index-1031"><a href="#Lattice.get_cells_at_index-1031"><span class="linenos">1031</span></a><span class="sd">        index: int</span>
</span><span id="Lattice.get_cells_at_index-1032"><a href="#Lattice.get_cells_at_index-1032"><span class="linenos">1032</span></a><span class="sd">            Index along the specified axis.</span>
</span><span id="Lattice.get_cells_at_index-1033"><a href="#Lattice.get_cells_at_index-1033"><span class="linenos">1033</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_cells_at_index-1034"><a href="#Lattice.get_cells_at_index-1034"><span class="linenos">1034</span></a>        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
</span><span id="Lattice.get_cells_at_index-1035"><a href="#Lattice.get_cells_at_index-1035"><span class="linenos">1035</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice.get_cells_at_index-1036"><a href="#Lattice.get_cells_at_index-1036"><span class="linenos">1036</span></a>        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
</span><span id="Lattice.get_cells_at_index-1037"><a href="#Lattice.get_cells_at_index-1037"><span class="linenos">1037</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice.get_cells_at_index-1038"><a href="#Lattice.get_cells_at_index-1038"><span class="linenos">1038</span></a>        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
</span><span id="Lattice.get_cells_at_index-1039"><a href="#Lattice.get_cells_at_index-1039"><span class="linenos">1039</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Lattice.get_cells_at_index-1040"><a href="#Lattice.get_cells_at_index-1040"><span class="linenos">1040</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.get_cells_at_index-1041"><a href="#Lattice.get_cells_at_index-1041"><span class="linenos">1041</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be &#39;x&#39;, &#39;y&#39;, or &#39;z&#39;&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get all cells at a specific index along a specified axis.</p>

<h2 id="parameters">Parameters:</h2>

<p>axis: str
    Axis to query ('x', 'y', or 'z').</p>

<p>index: int
    Index along the specified axis.</p>
</div>


                            </div>
                            <div id="Lattice.get_relative_boundary_box" class="classattr">
                                        <input id="Lattice.get_relative_boundary_box-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_relative_boundary_box</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">cell</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_relative_boundary_box-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_relative_boundary_box"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_relative_boundary_box-1043"><a href="#Lattice.get_relative_boundary_box-1043"><span class="linenos">1043</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_relative_boundary_box-1044"><a href="#Lattice.get_relative_boundary_box-1044"><span class="linenos">1044</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_relative_boundary_box-1045"><a href="#Lattice.get_relative_boundary_box-1045"><span class="linenos">1045</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
</span><span id="Lattice.get_relative_boundary_box-1046"><a href="#Lattice.get_relative_boundary_box-1046"><span class="linenos">1046</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_relative_boundary_box-1047"><a href="#Lattice.get_relative_boundary_box-1047"><span class="linenos">1047</span></a><span class="sd">        Get the relative boundary box of a cell in the lattice.</span>
</span><span id="Lattice.get_relative_boundary_box-1048"><a href="#Lattice.get_relative_boundary_box-1048"><span class="linenos">1048</span></a><span class="sd">        It corresponds to the minimum and maximum dimension of the lattice for each axis with cell continuity.</span>
</span><span id="Lattice.get_relative_boundary_box-1049"><a href="#Lattice.get_relative_boundary_box-1049"><span class="linenos">1049</span></a><span class="sd">        Useful for structures with erased parts or periodic boundaries.</span>
</span><span id="Lattice.get_relative_boundary_box-1050"><a href="#Lattice.get_relative_boundary_box-1050"><span class="linenos">1050</span></a>
</span><span id="Lattice.get_relative_boundary_box-1051"><a href="#Lattice.get_relative_boundary_box-1051"><span class="linenos">1051</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.get_relative_boundary_box-1052"><a href="#Lattice.get_relative_boundary_box-1052"><span class="linenos">1052</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.get_relative_boundary_box-1053"><a href="#Lattice.get_relative_boundary_box-1053"><span class="linenos">1053</span></a><span class="sd">        cell: Cell object</span>
</span><span id="Lattice.get_relative_boundary_box-1054"><a href="#Lattice.get_relative_boundary_box-1054"><span class="linenos">1054</span></a><span class="sd">            The cell for which the boundary box is computed.</span>
</span><span id="Lattice.get_relative_boundary_box-1055"><a href="#Lattice.get_relative_boundary_box-1055"><span class="linenos">1055</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_relative_boundary_box-1056"><a href="#Lattice.get_relative_boundary_box-1056"><span class="linenos">1056</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">pos</span>
</span><span id="Lattice.get_relative_boundary_box-1057"><a href="#Lattice.get_relative_boundary_box-1057"><span class="linenos">1057</span></a>        <span class="n">bbox</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.get_relative_boundary_box-1058"><a href="#Lattice.get_relative_boundary_box-1058"><span class="linenos">1058</span></a>
</span><span id="Lattice.get_relative_boundary_box-1059"><a href="#Lattice.get_relative_boundary_box-1059"><span class="linenos">1059</span></a>        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="Lattice.get_relative_boundary_box-1060"><a href="#Lattice.get_relative_boundary_box-1060"><span class="linenos">1060</span></a>                <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">],</span>
</span><span id="Lattice.get_relative_boundary_box-1061"><a href="#Lattice.get_relative_boundary_box-1061"><span class="linenos">1061</span></a>                <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span>
</span><span id="Lattice.get_relative_boundary_box-1062"><a href="#Lattice.get_relative_boundary_box-1062"><span class="linenos">1062</span></a>        <span class="p">):</span>
</span><span id="Lattice.get_relative_boundary_box-1063"><a href="#Lattice.get_relative_boundary_box-1063"><span class="linenos">1063</span></a>            <span class="n">arrayCell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cells_at_index</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</span><span id="Lattice.get_relative_boundary_box-1064"><a href="#Lattice.get_relative_boundary_box-1064"><span class="linenos">1064</span></a>            <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="Lattice.get_relative_boundary_box-1065"><a href="#Lattice.get_relative_boundary_box-1065"><span class="linenos">1065</span></a>
</span><span id="Lattice.get_relative_boundary_box-1066"><a href="#Lattice.get_relative_boundary_box-1066"><span class="linenos">1066</span></a>            <span class="k">for</span> <span class="n">cellIn</span> <span class="ow">in</span> <span class="n">arrayCell</span><span class="p">:</span>
</span><span id="Lattice.get_relative_boundary_box-1067"><a href="#Lattice.get_relative_boundary_box-1067"><span class="linenos">1067</span></a>                <span class="n">cellInBoundaryBox</span> <span class="o">=</span> <span class="n">cellIn</span><span class="o">.</span><span class="n">boundary_box</span>
</span><span id="Lattice.get_relative_boundary_box-1068"><a href="#Lattice.get_relative_boundary_box-1068"><span class="linenos">1068</span></a>                <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
</span><span id="Lattice.get_relative_boundary_box-1069"><a href="#Lattice.get_relative_boundary_box-1069"><span class="linenos">1069</span></a>                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cellInBoundaryBox</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Lattice.get_relative_boundary_box-1070"><a href="#Lattice.get_relative_boundary_box-1070"><span class="linenos">1070</span></a>                <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
</span><span id="Lattice.get_relative_boundary_box-1071"><a href="#Lattice.get_relative_boundary_box-1071"><span class="linenos">1071</span></a>                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cellInBoundaryBox</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
</span><span id="Lattice.get_relative_boundary_box-1072"><a href="#Lattice.get_relative_boundary_box-1072"><span class="linenos">1072</span></a>                <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
</span><span id="Lattice.get_relative_boundary_box-1073"><a href="#Lattice.get_relative_boundary_box-1073"><span class="linenos">1073</span></a>                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cellInBoundaryBox</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
</span><span id="Lattice.get_relative_boundary_box-1074"><a href="#Lattice.get_relative_boundary_box-1074"><span class="linenos">1074</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.get_relative_boundary_box-1075"><a href="#Lattice.get_relative_boundary_box-1075"><span class="linenos">1075</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be &#39;x&#39;, &#39;y&#39;, or &#39;z&#39;&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_relative_boundary_box-1076"><a href="#Lattice.get_relative_boundary_box-1076"><span class="linenos">1076</span></a>
</span><span id="Lattice.get_relative_boundary_box-1077"><a href="#Lattice.get_relative_boundary_box-1077"><span class="linenos">1077</span></a>                <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_val</span><span class="p">:</span>
</span><span id="Lattice.get_relative_boundary_box-1078"><a href="#Lattice.get_relative_boundary_box-1078"><span class="linenos">1078</span></a>                    <span class="n">min_val</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Lattice.get_relative_boundary_box-1079"><a href="#Lattice.get_relative_boundary_box-1079"><span class="linenos">1079</span></a>                <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_val</span><span class="p">:</span>
</span><span id="Lattice.get_relative_boundary_box-1080"><a href="#Lattice.get_relative_boundary_box-1080"><span class="linenos">1080</span></a>                    <span class="n">max_val</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Lattice.get_relative_boundary_box-1081"><a href="#Lattice.get_relative_boundary_box-1081"><span class="linenos">1081</span></a>
</span><span id="Lattice.get_relative_boundary_box-1082"><a href="#Lattice.get_relative_boundary_box-1082"><span class="linenos">1082</span></a>            <span class="n">bbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_val</span><span class="p">)</span>
</span><span id="Lattice.get_relative_boundary_box-1083"><a href="#Lattice.get_relative_boundary_box-1083"><span class="linenos">1083</span></a>            <span class="n">bbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_val</span><span class="p">)</span>
</span><span id="Lattice.get_relative_boundary_box-1084"><a href="#Lattice.get_relative_boundary_box-1084"><span class="linenos">1084</span></a>
</span><span id="Lattice.get_relative_boundary_box-1085"><a href="#Lattice.get_relative_boundary_box-1085"><span class="linenos">1085</span></a>        <span class="k">return</span> <span class="n">bbox</span>
</span></pre></div>


            <div class="docstring"><p>Get the relative boundary box of a cell in the lattice.
It corresponds to the minimum and maximum dimension of the lattice for each axis with cell continuity.
Useful for structures with erased parts or periodic boundaries.</p>

<h2 id="parameters">Parameters:</h2>

<p>cell: Cell object
    The cell for which the boundary box is computed.</p>
</div>


                            </div>
                            <div id="Lattice.get_name_lattice" class="classattr">
                                        <input id="Lattice.get_name_lattice-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_name_lattice</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_name_lattice-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_name_lattice"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_name_lattice-1087"><a href="#Lattice.get_name_lattice-1087"><span class="linenos">1087</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_name_lattice-1088"><a href="#Lattice.get_name_lattice-1088"><span class="linenos">1088</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_name_lattice-1089"><a href="#Lattice.get_name_lattice-1089"><span class="linenos">1089</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_name_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Lattice.get_name_lattice-1090"><a href="#Lattice.get_name_lattice-1090"><span class="linenos">1090</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_name_lattice-1091"><a href="#Lattice.get_name_lattice-1091"><span class="linenos">1091</span></a><span class="sd">        Determine the name_lattice of the lattice</span>
</span><span id="Lattice.get_name_lattice-1092"><a href="#Lattice.get_name_lattice-1092"><span class="linenos">1092</span></a><span class="sd">        WARNING: not updated</span>
</span><span id="Lattice.get_name_lattice-1093"><a href="#Lattice.get_name_lattice-1093"><span class="linenos">1093</span></a>
</span><span id="Lattice.get_name_lattice-1094"><a href="#Lattice.get_name_lattice-1094"><span class="linenos">1094</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice.get_name_lattice-1095"><a href="#Lattice.get_name_lattice-1095"><span class="linenos">1095</span></a><span class="sd">        ---------</span>
</span><span id="Lattice.get_name_lattice-1096"><a href="#Lattice.get_name_lattice-1096"><span class="linenos">1096</span></a><span class="sd">        name_lattice: string</span>
</span><span id="Lattice.get_name_lattice-1097"><a href="#Lattice.get_name_lattice-1097"><span class="linenos">1097</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_name_lattice-1098"><a href="#Lattice.get_name_lattice-1098"><span class="linenos">1098</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Lattice.get_name_lattice-1099"><a href="#Lattice.get_name_lattice-1099"><span class="linenos">1099</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Lattice.get_name_lattice-1100"><a href="#Lattice.get_name_lattice-1100"><span class="linenos">1100</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.get_name_lattice-1101"><a href="#Lattice.get_name_lattice-1101"><span class="linenos">1101</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">=</span> <span class="s2">&quot;Hybrid_&quot;</span>
</span><span id="Lattice.get_name_lattice-1102"><a href="#Lattice.get_name_lattice-1102"><span class="linenos">1102</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">geom_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_types</span><span class="p">):</span>
</span><span id="Lattice.get_name_lattice-1103"><a href="#Lattice.get_name_lattice-1103"><span class="linenos">1103</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">+=</span> <span class="n">geom_type</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
</span><span id="Lattice.get_name_lattice-1104"><a href="#Lattice.get_name_lattice-1104"><span class="linenos">1104</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_simulation_properties</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Lattice.get_name_lattice-1105"><a href="#Lattice.get_name_lattice-1105"><span class="linenos">1105</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span> <span class="o">+=</span> <span class="s2">&quot;_Mod&quot;</span>
</span><span id="Lattice.get_name_lattice-1106"><a href="#Lattice.get_name_lattice-1106"><span class="linenos">1106</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_lattice</span>
</span></pre></div>


            <div class="docstring"><p>Determine the name_lattice of the lattice
WARNING: not updated</p>

<h2 id="returns">Returns:</h2>

<p>name_lattice: string</p>
</div>


                            </div>
                            <div id="Lattice.check_hybrid_collision" class="classattr">
                                        <input id="Lattice.check_hybrid_collision-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">check_hybrid_collision</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.check_hybrid_collision-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.check_hybrid_collision"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.check_hybrid_collision-1108"><a href="#Lattice.check_hybrid_collision-1108"><span class="linenos">1108</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1109"><a href="#Lattice.check_hybrid_collision-1109"><span class="linenos">1109</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.check_hybrid_collision-1110"><a href="#Lattice.check_hybrid_collision-1110"><span class="linenos">1110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_hybrid_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1111"><a href="#Lattice.check_hybrid_collision-1111"><span class="linenos">1111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.check_hybrid_collision-1112"><a href="#Lattice.check_hybrid_collision-1112"><span class="linenos">1112</span></a><span class="sd">        Check if beam in hybrid configuration is cut by a point in the geometry</span>
</span><span id="Lattice.check_hybrid_collision-1113"><a href="#Lattice.check_hybrid_collision-1113"><span class="linenos">1113</span></a><span class="sd">        Change the beam configuration of collisionned beams</span>
</span><span id="Lattice.check_hybrid_collision-1114"><a href="#Lattice.check_hybrid_collision-1114"><span class="linenos">1114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.check_hybrid_collision-1115"><a href="#Lattice.check_hybrid_collision-1115"><span class="linenos">1115</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1116"><a href="#Lattice.check_hybrid_collision-1116"><span class="linenos">1116</span></a>            <span class="k">return</span>
</span><span id="Lattice.check_hybrid_collision-1117"><a href="#Lattice.check_hybrid_collision-1117"><span class="linenos">1117</span></a>
</span><span id="Lattice.check_hybrid_collision-1118"><a href="#Lattice.check_hybrid_collision-1118"><span class="linenos">1118</span></a>        <span class="n">beams_to_remove_global</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.check_hybrid_collision-1119"><a href="#Lattice.check_hybrid_collision-1119"><span class="linenos">1119</span></a>        <span class="n">beams_to_add_global</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.check_hybrid_collision-1120"><a href="#Lattice.check_hybrid_collision-1120"><span class="linenos">1120</span></a>
</span><span id="Lattice.check_hybrid_collision-1121"><a href="#Lattice.check_hybrid_collision-1121"><span class="linenos">1121</span></a>        <span class="c1"># Per‚Äìcell containers for in-place updates</span>
</span><span id="Lattice.check_hybrid_collision-1122"><a href="#Lattice.check_hybrid_collision-1122"><span class="linenos">1122</span></a>        <span class="n">per_cell_rem</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
</span><span id="Lattice.check_hybrid_collision-1123"><a href="#Lattice.check_hybrid_collision-1123"><span class="linenos">1123</span></a>        <span class="n">per_cell_add</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
</span><span id="Lattice.check_hybrid_collision-1124"><a href="#Lattice.check_hybrid_collision-1124"><span class="linenos">1124</span></a>        <span class="n">per_cell_pts</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
</span><span id="Lattice.check_hybrid_collision-1125"><a href="#Lattice.check_hybrid_collision-1125"><span class="linenos">1125</span></a>
</span><span id="Lattice.check_hybrid_collision-1126"><a href="#Lattice.check_hybrid_collision-1126"><span class="linenos">1126</span></a>        <span class="c1"># Helper: quick AABB inclusion (with small tolerance)</span>
</span><span id="Lattice.check_hybrid_collision-1127"><a href="#Lattice.check_hybrid_collision-1127"><span class="linenos">1127</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_in_aabb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aabb</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
</span><span id="Lattice.check_hybrid_collision-1128"><a href="#Lattice.check_hybrid_collision-1128"><span class="linenos">1128</span></a>            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">aabb</span>
</span><span id="Lattice.check_hybrid_collision-1129"><a href="#Lattice.check_hybrid_collision-1129"><span class="linenos">1129</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">tol</span> <span class="ow">and</span>
</span><span id="Lattice.check_hybrid_collision-1130"><a href="#Lattice.check_hybrid_collision-1130"><span class="linenos">1130</span></a>                    <span class="n">ymin</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">tol</span> <span class="ow">and</span>
</span><span id="Lattice.check_hybrid_collision-1131"><a href="#Lattice.check_hybrid_collision-1131"><span class="linenos">1131</span></a>                    <span class="n">zmin</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">zmax</span> <span class="o">+</span> <span class="n">tol</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1132"><a href="#Lattice.check_hybrid_collision-1132"><span class="linenos">1132</span></a>
</span><span id="Lattice.check_hybrid_collision-1133"><a href="#Lattice.check_hybrid_collision-1133"><span class="linenos">1133</span></a>        <span class="c1"># Build a lightweight per-cell point list (deterministic order)</span>
</span><span id="Lattice.check_hybrid_collision-1134"><a href="#Lattice.check_hybrid_collision-1134"><span class="linenos">1134</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_sorted_pts</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="Lattice.check_hybrid_collision-1135"><a href="#Lattice.check_hybrid_collision-1135"><span class="linenos">1135</span></a>            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">points_cell</span><span class="p">,</span>
</span><span id="Lattice.check_hybrid_collision-1136"><a href="#Lattice.check_hybrid_collision-1136"><span class="linenos">1136</span></a>                          <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">nd</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">nd</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">nd</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</span><span id="Lattice.check_hybrid_collision-1137"><a href="#Lattice.check_hybrid_collision-1137"><span class="linenos">1137</span></a>
</span><span id="Lattice.check_hybrid_collision-1138"><a href="#Lattice.check_hybrid_collision-1138"><span class="linenos">1138</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1139"><a href="#Lattice.check_hybrid_collision-1139"><span class="linenos">1139</span></a>            <span class="c1"># Candidates are only points from this cell</span>
</span><span id="Lattice.check_hybrid_collision-1140"><a href="#Lattice.check_hybrid_collision-1140"><span class="linenos">1140</span></a>            <span class="n">cell_points</span> <span class="o">=</span> <span class="n">_sorted_pts</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1141"><a href="#Lattice.check_hybrid_collision-1141"><span class="linenos">1141</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_points</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1142"><a href="#Lattice.check_hybrid_collision-1142"><span class="linenos">1142</span></a>                <span class="k">continue</span>
</span><span id="Lattice.check_hybrid_collision-1143"><a href="#Lattice.check_hybrid_collision-1143"><span class="linenos">1143</span></a>
</span><span id="Lattice.check_hybrid_collision-1144"><a href="#Lattice.check_hybrid_collision-1144"><span class="linenos">1144</span></a>            <span class="c1"># Process each beam of the cell, but only if this cell is the primary owner</span>
</span><span id="Lattice.check_hybrid_collision-1145"><a href="#Lattice.check_hybrid_collision-1145"><span class="linenos">1145</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">):</span>
</span><span id="Lattice.check_hybrid_collision-1146"><a href="#Lattice.check_hybrid_collision-1146"><span class="linenos">1146</span></a>                <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice.check_hybrid_collision-1147"><a href="#Lattice.check_hybrid_collision-1147"><span class="linenos">1147</span></a>                <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1148"><a href="#Lattice.check_hybrid_collision-1148"><span class="linenos">1148</span></a>                <span class="n">L2</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">*</span> <span class="n">vx</span> <span class="o">+</span> <span class="n">vy</span> <span class="o">*</span> <span class="n">vy</span> <span class="o">+</span> <span class="n">vz</span> <span class="o">*</span> <span class="n">vz</span>
</span><span id="Lattice.check_hybrid_collision-1149"><a href="#Lattice.check_hybrid_collision-1149"><span class="linenos">1149</span></a>                <span class="k">if</span> <span class="n">L2</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1150"><a href="#Lattice.check_hybrid_collision-1150"><span class="linenos">1150</span></a>                    <span class="k">continue</span>
</span><span id="Lattice.check_hybrid_collision-1151"><a href="#Lattice.check_hybrid_collision-1151"><span class="linenos">1151</span></a>
</span><span id="Lattice.check_hybrid_collision-1152"><a href="#Lattice.check_hybrid_collision-1152"><span class="linenos">1152</span></a>                <span class="c1"># Tight AABB to skip most points quickly</span>
</span><span id="Lattice.check_hybrid_collision-1153"><a href="#Lattice.check_hybrid_collision-1153"><span class="linenos">1153</span></a>                <span class="n">aabb</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
</span><span id="Lattice.check_hybrid_collision-1154"><a href="#Lattice.check_hybrid_collision-1154"><span class="linenos">1154</span></a>                        <span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
</span><span id="Lattice.check_hybrid_collision-1155"><a href="#Lattice.check_hybrid_collision-1155"><span class="linenos">1155</span></a>                        <span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
</span><span id="Lattice.check_hybrid_collision-1156"><a href="#Lattice.check_hybrid_collision-1156"><span class="linenos">1156</span></a>
</span><span id="Lattice.check_hybrid_collision-1157"><a href="#Lattice.check_hybrid_collision-1157"><span class="linenos">1157</span></a>                <span class="n">internal</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.check_hybrid_collision-1158"><a href="#Lattice.check_hybrid_collision-1158"><span class="linenos">1158</span></a>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cell_points</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1159"><a href="#Lattice.check_hybrid_collision-1159"><span class="linenos">1159</span></a>                    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">p1</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">p2</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1160"><a href="#Lattice.check_hybrid_collision-1160"><span class="linenos">1160</span></a>                        <span class="k">continue</span>
</span><span id="Lattice.check_hybrid_collision-1161"><a href="#Lattice.check_hybrid_collision-1161"><span class="linenos">1161</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_in_aabb</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">aabb</span><span class="p">):</span>
</span><span id="Lattice.check_hybrid_collision-1162"><a href="#Lattice.check_hybrid_collision-1162"><span class="linenos">1162</span></a>                        <span class="k">continue</span>
</span><span id="Lattice.check_hybrid_collision-1163"><a href="#Lattice.check_hybrid_collision-1163"><span class="linenos">1163</span></a>                    <span class="c1"># exact geometric test</span>
</span><span id="Lattice.check_hybrid_collision-1164"><a href="#Lattice.check_hybrid_collision-1164"><span class="linenos">1164</span></a>                    <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">is_point_on_beam</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Lattice.check_hybrid_collision-1165"><a href="#Lattice.check_hybrid_collision-1165"><span class="linenos">1165</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="p">((</span><span class="n">n</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">vx</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">vy</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p1</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">vz</span><span class="p">)</span> <span class="o">/</span> <span class="n">L2</span>
</span><span id="Lattice.check_hybrid_collision-1166"><a href="#Lattice.check_hybrid_collision-1166"><span class="linenos">1166</span></a>                        <span class="k">if</span> <span class="mf">1e-12</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-12</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1167"><a href="#Lattice.check_hybrid_collision-1167"><span class="linenos">1167</span></a>                            <span class="n">internal</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="Lattice.check_hybrid_collision-1168"><a href="#Lattice.check_hybrid_collision-1168"><span class="linenos">1168</span></a>
</span><span id="Lattice.check_hybrid_collision-1169"><a href="#Lattice.check_hybrid_collision-1169"><span class="linenos">1169</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">internal</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1170"><a href="#Lattice.check_hybrid_collision-1170"><span class="linenos">1170</span></a>                    <span class="k">continue</span>
</span><span id="Lattice.check_hybrid_collision-1171"><a href="#Lattice.check_hybrid_collision-1171"><span class="linenos">1171</span></a>
</span><span id="Lattice.check_hybrid_collision-1172"><a href="#Lattice.check_hybrid_collision-1172"><span class="linenos">1172</span></a>                <span class="n">internal</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tn</span><span class="p">:</span> <span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Lattice.check_hybrid_collision-1173"><a href="#Lattice.check_hybrid_collision-1173"><span class="linenos">1173</span></a>                <span class="n">chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">internal</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">p2</span><span class="p">]</span>
</span><span id="Lattice.check_hybrid_collision-1174"><a href="#Lattice.check_hybrid_collision-1174"><span class="linenos">1174</span></a>
</span><span id="Lattice.check_hybrid_collision-1175"><a href="#Lattice.check_hybrid_collision-1175"><span class="linenos">1175</span></a>                <span class="c1"># Create split segments; keep all owners if provided, else just this cell</span>
</span><span id="Lattice.check_hybrid_collision-1176"><a href="#Lattice.check_hybrid_collision-1176"><span class="linenos">1176</span></a>                <span class="n">seg_owners</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Lattice.check_hybrid_collision-1177"><a href="#Lattice.check_hybrid_collision-1177"><span class="linenos">1177</span></a>                <span class="n">new_segments</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.check_hybrid_collision-1178"><a href="#Lattice.check_hybrid_collision-1178"><span class="linenos">1178</span></a>                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chain</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">chain</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="Lattice.check_hybrid_collision-1179"><a href="#Lattice.check_hybrid_collision-1179"><span class="linenos">1179</span></a>                    <span class="n">nb</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">,</span> <span class="n">seg_owners</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1180"><a href="#Lattice.check_hybrid_collision-1180"><span class="linenos">1180</span></a>                    <span class="n">new_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1181"><a href="#Lattice.check_hybrid_collision-1181"><span class="linenos">1181</span></a>
</span><span id="Lattice.check_hybrid_collision-1182"><a href="#Lattice.check_hybrid_collision-1182"><span class="linenos">1182</span></a>                <span class="c1"># Mark removals/additions per owner cell</span>
</span><span id="Lattice.check_hybrid_collision-1183"><a href="#Lattice.check_hybrid_collision-1183"><span class="linenos">1183</span></a>                <span class="n">beams_to_remove_global</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1184"><a href="#Lattice.check_hybrid_collision-1184"><span class="linenos">1184</span></a>                <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">seg_owners</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1185"><a href="#Lattice.check_hybrid_collision-1185"><span class="linenos">1185</span></a>                    <span class="n">per_cell_rem</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1186"><a href="#Lattice.check_hybrid_collision-1186"><span class="linenos">1186</span></a>                    <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">new_segments</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1187"><a href="#Lattice.check_hybrid_collision-1187"><span class="linenos">1187</span></a>                        <span class="n">per_cell_add</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1188"><a href="#Lattice.check_hybrid_collision-1188"><span class="linenos">1188</span></a>                        <span class="n">per_cell_pts</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">point1</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1189"><a href="#Lattice.check_hybrid_collision-1189"><span class="linenos">1189</span></a>                        <span class="n">per_cell_pts</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">point2</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1190"><a href="#Lattice.check_hybrid_collision-1190"><span class="linenos">1190</span></a>                <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">new_segments</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1191"><a href="#Lattice.check_hybrid_collision-1191"><span class="linenos">1191</span></a>                    <span class="n">beams_to_add_global</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1192"><a href="#Lattice.check_hybrid_collision-1192"><span class="linenos">1192</span></a>
</span><span id="Lattice.check_hybrid_collision-1193"><a href="#Lattice.check_hybrid_collision-1193"><span class="linenos">1193</span></a>        <span class="c1"># Apply per-cell edits</span>
</span><span id="Lattice.check_hybrid_collision-1194"><a href="#Lattice.check_hybrid_collision-1194"><span class="linenos">1194</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1195"><a href="#Lattice.check_hybrid_collision-1195"><span class="linenos">1195</span></a>            <span class="n">rem</span> <span class="o">=</span> <span class="n">per_cell_rem</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="Lattice.check_hybrid_collision-1196"><a href="#Lattice.check_hybrid_collision-1196"><span class="linenos">1196</span></a>            <span class="n">add</span> <span class="o">=</span> <span class="n">per_cell_add</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="Lattice.check_hybrid_collision-1197"><a href="#Lattice.check_hybrid_collision-1197"><span class="linenos">1197</span></a>            <span class="n">pts</span> <span class="o">=</span> <span class="n">per_cell_pts</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span><span id="Lattice.check_hybrid_collision-1198"><a href="#Lattice.check_hybrid_collision-1198"><span class="linenos">1198</span></a>            <span class="k">if</span> <span class="n">rem</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1199"><a href="#Lattice.check_hybrid_collision-1199"><span class="linenos">1199</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">remove_beam</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1200"><a href="#Lattice.check_hybrid_collision-1200"><span class="linenos">1200</span></a>            <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1201"><a href="#Lattice.check_hybrid_collision-1201"><span class="linenos">1201</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">add_beam</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1202"><a href="#Lattice.check_hybrid_collision-1202"><span class="linenos">1202</span></a>            <span class="k">if</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1203"><a href="#Lattice.check_hybrid_collision-1203"><span class="linenos">1203</span></a>                <span class="n">c</span><span class="o">.</span><span class="n">add_point</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pts</span><span class="p">))</span>
</span><span id="Lattice.check_hybrid_collision-1204"><a href="#Lattice.check_hybrid_collision-1204"><span class="linenos">1204</span></a>
</span><span id="Lattice.check_hybrid_collision-1205"><a href="#Lattice.check_hybrid_collision-1205"><span class="linenos">1205</span></a>        <span class="c1"># Update global sets</span>
</span><span id="Lattice.check_hybrid_collision-1206"><a href="#Lattice.check_hybrid_collision-1206"><span class="linenos">1206</span></a>        <span class="k">if</span> <span class="n">beams_to_remove_global</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1207"><a href="#Lattice.check_hybrid_collision-1207"><span class="linenos">1207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">beams_to_remove_global</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1208"><a href="#Lattice.check_hybrid_collision-1208"><span class="linenos">1208</span></a>        <span class="k">if</span> <span class="n">beams_to_add_global</span><span class="p">:</span>
</span><span id="Lattice.check_hybrid_collision-1209"><a href="#Lattice.check_hybrid_collision-1209"><span class="linenos">1209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beams_to_add_global</span><span class="p">)</span>
</span><span id="Lattice.check_hybrid_collision-1210"><a href="#Lattice.check_hybrid_collision-1210"><span class="linenos">1210</span></a>
</span><span id="Lattice.check_hybrid_collision-1211"><a href="#Lattice.check_hybrid_collision-1211"><span class="linenos">1211</span></a>        <span class="c1"># Refresh indices/connectivity once</span>
</span><span id="Lattice.check_hybrid_collision-1212"><a href="#Lattice.check_hybrid_collision-1212"><span class="linenos">1212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice.check_hybrid_collision-1213"><a href="#Lattice.check_hybrid_collision-1213"><span class="linenos">1213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice.check_hybrid_collision-1214"><a href="#Lattice.check_hybrid_collision-1214"><span class="linenos">1214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Check if beam in hybrid configuration is cut by a point in the geometry
Change the beam configuration of collisionned beams</p>
</div>


                            </div>
                            <div id="Lattice.are_cells_identical" class="classattr">
                                        <input id="Lattice.are_cells_identical-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">are_cells_identical</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Lattice.are_cells_identical-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.are_cells_identical"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.are_cells_identical-1216"><a href="#Lattice.are_cells_identical-1216"><span class="linenos">1216</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1217"><a href="#Lattice.are_cells_identical-1217"><span class="linenos">1217</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.are_cells_identical-1218"><a href="#Lattice.are_cells_identical-1218"><span class="linenos">1218</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">are_cells_identical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Lattice.are_cells_identical-1219"><a href="#Lattice.are_cells_identical-1219"><span class="linenos">1219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.are_cells_identical-1220"><a href="#Lattice.are_cells_identical-1220"><span class="linenos">1220</span></a><span class="sd">        Check if all cells in the lattice are identical.</span>
</span><span id="Lattice.are_cells_identical-1221"><a href="#Lattice.are_cells_identical-1221"><span class="linenos">1221</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.are_cells_identical-1222"><a href="#Lattice.are_cells_identical-1222"><span class="linenos">1222</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.are_cells_identical-1223"><a href="#Lattice.are_cells_identical-1223"><span class="linenos">1223</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s2">&quot;Only one or no cell: considered identical.&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1224"><a href="#Lattice.are_cells_identical-1224"><span class="linenos">1224</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Lattice.are_cells_identical-1225"><a href="#Lattice.are_cells_identical-1225"><span class="linenos">1225</span></a>
</span><span id="Lattice.are_cells_identical-1226"><a href="#Lattice.are_cells_identical-1226"><span class="linenos">1226</span></a>        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Lattice.are_cells_identical-1227"><a href="#Lattice.are_cells_identical-1227"><span class="linenos">1227</span></a>
</span><span id="Lattice.are_cells_identical-1228"><a href="#Lattice.are_cells_identical-1228"><span class="linenos">1228</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span id="Lattice.are_cells_identical-1229"><a href="#Lattice.are_cells_identical-1229"><span class="linenos">1229</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice.are_cells_identical-1230"><a href="#Lattice.are_cells_identical-1230"><span class="linenos">1230</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1231"><a href="#Lattice.are_cells_identical-1231"><span class="linenos">1231</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Lattice.are_cells_identical-1232"><a href="#Lattice.are_cells_identical-1232"><span class="linenos">1232</span></a>                <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>
</span><span id="Lattice.are_cells_identical-1233"><a href="#Lattice.are_cells_identical-1233"><span class="linenos">1233</span></a>
</span><span id="Lattice.are_cells_identical-1234"><a href="#Lattice.are_cells_identical-1234"><span class="linenos">1234</span></a>        <span class="n">attrs_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;geom_types&quot;</span><span class="p">,</span> <span class="s2">&quot;radii&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;grad_radius&quot;</span><span class="p">,</span> <span class="s2">&quot;grad_dim&quot;</span><span class="p">]</span>
</span><span id="Lattice.are_cells_identical-1235"><a href="#Lattice.are_cells_identical-1235"><span class="linenos">1235</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Lattice.are_cells_identical-1236"><a href="#Lattice.are_cells_identical-1236"><span class="linenos">1236</span></a>            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_check</span><span class="p">:</span>
</span><span id="Lattice.are_cells_identical-1237"><a href="#Lattice.are_cells_identical-1237"><span class="linenos">1237</span></a>                <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1238"><a href="#Lattice.are_cells_identical-1238"><span class="linenos">1238</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">_allclose</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
</span><span id="Lattice.are_cells_identical-1239"><a href="#Lattice.are_cells_identical-1239"><span class="linenos">1239</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="Lattice.are_cells_identical-1240"><a href="#Lattice.are_cells_identical-1240"><span class="linenos">1240</span></a>                        <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Difference found in attribute &#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&#39; between cell 0 and cell </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1241"><a href="#Lattice.are_cells_identical-1241"><span class="linenos">1241</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice.are_cells_identical-1242"><a href="#Lattice.are_cells_identical-1242"><span class="linenos">1242</span></a>
</span><span id="Lattice.are_cells_identical-1243"><a href="#Lattice.are_cells_identical-1243"><span class="linenos">1243</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_pt_local_key</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="Lattice.are_cells_identical-1244"><a href="#Lattice.are_cells_identical-1244"><span class="linenos">1244</span></a>            <span class="k">return</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nd</span><span class="p">),</span>
</span><span id="Lattice.are_cells_identical-1245"><a href="#Lattice.are_cells_identical-1245"><span class="linenos">1245</span></a>                    <span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nd</span><span class="p">),</span>
</span><span id="Lattice.are_cells_identical-1246"><a href="#Lattice.are_cells_identical-1246"><span class="linenos">1246</span></a>                    <span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nd</span><span class="p">))</span>
</span><span id="Lattice.are_cells_identical-1247"><a href="#Lattice.are_cells_identical-1247"><span class="linenos">1247</span></a>
</span><span id="Lattice.are_cells_identical-1248"><a href="#Lattice.are_cells_identical-1248"><span class="linenos">1248</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_beam_key</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ndp</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ndr</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="Lattice.are_cells_identical-1249"><a href="#Lattice.are_cells_identical-1249"><span class="linenos">1249</span></a>            <span class="n">e1</span> <span class="o">=</span> <span class="n">_pt_local_key</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="n">ndp</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1250"><a href="#Lattice.are_cells_identical-1250"><span class="linenos">1250</span></a>            <span class="n">e2</span> <span class="o">=</span> <span class="n">_pt_local_key</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="n">ndp</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1251"><a href="#Lattice.are_cells_identical-1251"><span class="linenos">1251</span></a>            <span class="n">ends</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)))</span>  <span class="c1"># order-independent</span>
</span><span id="Lattice.are_cells_identical-1252"><a href="#Lattice.are_cells_identical-1252"><span class="linenos">1252</span></a>            <span class="k">return</span> <span class="n">ends</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">radius</span><span class="p">),</span> <span class="n">ndr</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">material</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">type_beam</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1253"><a href="#Lattice.are_cells_identical-1253"><span class="linenos">1253</span></a>
</span><span id="Lattice.are_cells_identical-1254"><a href="#Lattice.are_cells_identical-1254"><span class="linenos">1254</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_beam_multiset</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
</span><span id="Lattice.are_cells_identical-1255"><a href="#Lattice.are_cells_identical-1255"><span class="linenos">1255</span></a>            <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span><span class="n">_beam_key</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1256"><a href="#Lattice.are_cells_identical-1256"><span class="linenos">1256</span></a>
</span><span id="Lattice.are_cells_identical-1257"><a href="#Lattice.are_cells_identical-1257"><span class="linenos">1257</span></a>        <span class="n">ref_ms</span> <span class="o">=</span> <span class="n">_beam_multiset</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1258"><a href="#Lattice.are_cells_identical-1258"><span class="linenos">1258</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Lattice.are_cells_identical-1259"><a href="#Lattice.are_cells_identical-1259"><span class="linenos">1259</span></a>            <span class="k">if</span> <span class="n">ref_ms</span> <span class="o">!=</span> <span class="n">_beam_multiset</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span id="Lattice.are_cells_identical-1260"><a href="#Lattice.are_cells_identical-1260"><span class="linenos">1260</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Beam topology/parameters differ between cell 0 and cell </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1261"><a href="#Lattice.are_cells_identical-1261"><span class="linenos">1261</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice.are_cells_identical-1262"><a href="#Lattice.are_cells_identical-1262"><span class="linenos">1262</span></a>
</span><span id="Lattice.are_cells_identical-1263"><a href="#Lattice.are_cells_identical-1263"><span class="linenos">1263</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.are_cells_identical-1264"><a href="#Lattice.are_cells_identical-1264"><span class="linenos">1264</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s2">&quot;All cells are identical.&quot;</span> <span class="o">+</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
</span><span id="Lattice.are_cells_identical-1265"><a href="#Lattice.are_cells_identical-1265"><span class="linenos">1265</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>Check if all cells in the lattice are identical.</p>
</div>


                            </div>
                            <div id="Lattice.change_beam_radius" class="classattr">
                                        <input id="Lattice.change_beam_radius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;optimization&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">change_beam_radius</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">radius_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.change_beam_radius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.change_beam_radius"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.change_beam_radius-1271"><a href="#Lattice.change_beam_radius-1271"><span class="linenos">1271</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Lattice.change_beam_radius-1272"><a href="#Lattice.change_beam_radius-1272"><span class="linenos">1272</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.change_beam_radius-1273"><a href="#Lattice.change_beam_radius-1273"><span class="linenos">1273</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">change_beam_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.change_beam_radius-1274"><a href="#Lattice.change_beam_radius-1274"><span class="linenos">1274</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.change_beam_radius-1275"><a href="#Lattice.change_beam_radius-1275"><span class="linenos">1275</span></a><span class="sd">        Change beam radius for all beams in the lattice</span>
</span><span id="Lattice.change_beam_radius-1276"><a href="#Lattice.change_beam_radius-1276"><span class="linenos">1276</span></a><span class="sd">        radius_list must have the same length as the number of different beam types in cells</span>
</span><span id="Lattice.change_beam_radius-1277"><a href="#Lattice.change_beam_radius-1277"><span class="linenos">1277</span></a>
</span><span id="Lattice.change_beam_radius-1278"><a href="#Lattice.change_beam_radius-1278"><span class="linenos">1278</span></a><span class="sd">        Take care if penalization is activated, the radius of penalized beams will be modified with the</span>
</span><span id="Lattice.change_beam_radius-1279"><a href="#Lattice.change_beam_radius-1279"><span class="linenos">1279</span></a><span class="sd">        penalization coefficient but the length of the modified beam will not be changed</span>
</span><span id="Lattice.change_beam_radius-1280"><a href="#Lattice.change_beam_radius-1280"><span class="linenos">1280</span></a><span class="sd">        (Use reset_cell_with_new_radii instead if you want to have clean cells for simulation)</span>
</span><span id="Lattice.change_beam_radius-1281"><a href="#Lattice.change_beam_radius-1281"><span class="linenos">1281</span></a>
</span><span id="Lattice.change_beam_radius-1282"><a href="#Lattice.change_beam_radius-1282"><span class="linenos">1282</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.change_beam_radius-1283"><a href="#Lattice.change_beam_radius-1283"><span class="linenos">1283</span></a><span class="sd">        ------------</span>
</span><span id="Lattice.change_beam_radius-1284"><a href="#Lattice.change_beam_radius-1284"><span class="linenos">1284</span></a><span class="sd">        radius_list: list of float</span>
</span><span id="Lattice.change_beam_radius-1285"><a href="#Lattice.change_beam_radius-1285"><span class="linenos">1285</span></a><span class="sd">            List of new radii for each beam type</span>
</span><span id="Lattice.change_beam_radius-1286"><a href="#Lattice.change_beam_radius-1286"><span class="linenos">1286</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.change_beam_radius-1287"><a href="#Lattice.change_beam_radius-1287"><span class="linenos">1287</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">):</span>
</span><span id="Lattice.change_beam_radius-1288"><a href="#Lattice.change_beam_radius-1288"><span class="linenos">1288</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid hybrid radii data.&quot;</span><span class="p">)</span>
</span><span id="Lattice.change_beam_radius-1289"><a href="#Lattice.change_beam_radius-1289"><span class="linenos">1289</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice.change_beam_radius-1290"><a href="#Lattice.change_beam_radius-1290"><span class="linenos">1290</span></a>            <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam_mod</span><span class="p">:</span>
</span><span id="Lattice.change_beam_radius-1291"><a href="#Lattice.change_beam_radius-1291"><span class="linenos">1291</span></a>                <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius_list</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">]</span> <span class="o">*</span> <span class="n">beam</span><span class="o">.</span><span class="n">penalization_coefficient</span>
</span><span id="Lattice.change_beam_radius-1292"><a href="#Lattice.change_beam_radius-1292"><span class="linenos">1292</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.change_beam_radius-1293"><a href="#Lattice.change_beam_radius-1293"><span class="linenos">1293</span></a>                <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius_list</span><span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Change beam radius for all beams in the lattice
radius_list must have the same length as the number of different beam types in cells</p>

<p>Take care if penalization is activated, the radius of penalized beams will be modified with the
penalization coefficient but the length of the modified beam will not be changed
(Use reset_cell_with_new_radii instead if you want to have clean cells for simulation)</p>

<h2 id="parameters">Parameters:</h2>

<p>radius_list: list of float
    List of new radii for each beam type</p>
</div>


                            </div>
                            <div id="Lattice.change_beam_radius_depending_type" class="classattr">
                                        <input id="Lattice.change_beam_radius_depending_type-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;optimization&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">change_beam_radius_depending_type</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">typeToChange</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">newRadius</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.change_beam_radius_depending_type-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.change_beam_radius_depending_type"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.change_beam_radius_depending_type-1295"><a href="#Lattice.change_beam_radius_depending_type-1295"><span class="linenos">1295</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">)</span>
</span><span id="Lattice.change_beam_radius_depending_type-1296"><a href="#Lattice.change_beam_radius_depending_type-1296"><span class="linenos">1296</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.change_beam_radius_depending_type-1297"><a href="#Lattice.change_beam_radius_depending_type-1297"><span class="linenos">1297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">change_beam_radius_depending_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typeToChange</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">newRadius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.change_beam_radius_depending_type-1298"><a href="#Lattice.change_beam_radius_depending_type-1298"><span class="linenos">1298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.change_beam_radius_depending_type-1299"><a href="#Lattice.change_beam_radius_depending_type-1299"><span class="linenos">1299</span></a><span class="sd">        Change radii of beam for specific type_beam</span>
</span><span id="Lattice.change_beam_radius_depending_type-1300"><a href="#Lattice.change_beam_radius_depending_type-1300"><span class="linenos">1300</span></a>
</span><span id="Lattice.change_beam_radius_depending_type-1301"><a href="#Lattice.change_beam_radius_depending_type-1301"><span class="linenos">1301</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.change_beam_radius_depending_type-1302"><a href="#Lattice.change_beam_radius_depending_type-1302"><span class="linenos">1302</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.change_beam_radius_depending_type-1303"><a href="#Lattice.change_beam_radius_depending_type-1303"><span class="linenos">1303</span></a><span class="sd">        typeToChange: int</span>
</span><span id="Lattice.change_beam_radius_depending_type-1304"><a href="#Lattice.change_beam_radius_depending_type-1304"><span class="linenos">1304</span></a><span class="sd">            Type of beam to change</span>
</span><span id="Lattice.change_beam_radius_depending_type-1305"><a href="#Lattice.change_beam_radius_depending_type-1305"><span class="linenos">1305</span></a><span class="sd">        newRadius: float</span>
</span><span id="Lattice.change_beam_radius_depending_type-1306"><a href="#Lattice.change_beam_radius_depending_type-1306"><span class="linenos">1306</span></a><span class="sd">            New radii of beam</span>
</span><span id="Lattice.change_beam_radius_depending_type-1307"><a href="#Lattice.change_beam_radius_depending_type-1307"><span class="linenos">1307</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.change_beam_radius_depending_type-1308"><a href="#Lattice.change_beam_radius_depending_type-1308"><span class="linenos">1308</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.change_beam_radius_depending_type-1309"><a href="#Lattice.change_beam_radius_depending_type-1309"><span class="linenos">1309</span></a>            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">beams_cell</span><span class="p">:</span>
</span><span id="Lattice.change_beam_radius_depending_type-1310"><a href="#Lattice.change_beam_radius_depending_type-1310"><span class="linenos">1310</span></a>                <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="n">typeToChange</span><span class="p">:</span>
</span><span id="Lattice.change_beam_radius_depending_type-1311"><a href="#Lattice.change_beam_radius_depending_type-1311"><span class="linenos">1311</span></a>                    <span class="n">beam</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">newRadius</span>
</span></pre></div>


            <div class="docstring"><p>Change radii of beam for specific type_beam</p>

<h2 id="parameters">Parameters:</h2>

<p>typeToChange: int
    Type of beam to change
newRadius: float
    New radii of beam</p>
</div>


                            </div>
                            <div id="Lattice.find_point_on_lattice_surface" class="classattr">
                                        <input id="Lattice.find_point_on_lattice_surface-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">find_point_on_lattice_surface</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">surfaceNames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>,</span><span class="param">	<span class="n">surface_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">set</span><span class="p">[</span><span class="n"><a href="point.html#Point">pyLattice.point.Point</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Lattice.find_point_on_lattice_surface-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.find_point_on_lattice_surface"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.find_point_on_lattice_surface-1317"><a href="#Lattice.find_point_on_lattice_surface-1317"><span class="linenos">1317</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.find_point_on_lattice_surface-1318"><a href="#Lattice.find_point_on_lattice_surface-1318"><span class="linenos">1318</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.find_point_on_lattice_surface-1319"><a href="#Lattice.find_point_on_lattice_surface-1319"><span class="linenos">1319</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_point_on_lattice_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfaceNames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">surface_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="s2">&quot;Point&quot;</span><span class="p">]:</span>
</span><span id="Lattice.find_point_on_lattice_surface-1320"><a href="#Lattice.find_point_on_lattice_surface-1320"><span class="linenos">1320</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.find_point_on_lattice_surface-1321"><a href="#Lattice.find_point_on_lattice_surface-1321"><span class="linenos">1321</span></a><span class="sd">        Find points on the surface of the lattice</span>
</span><span id="Lattice.find_point_on_lattice_surface-1322"><a href="#Lattice.find_point_on_lattice_surface-1322"><span class="linenos">1322</span></a>
</span><span id="Lattice.find_point_on_lattice_surface-1323"><a href="#Lattice.find_point_on_lattice_surface-1323"><span class="linenos">1323</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.find_point_on_lattice_surface-1324"><a href="#Lattice.find_point_on_lattice_surface-1324"><span class="linenos">1324</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.find_point_on_lattice_surface-1325"><a href="#Lattice.find_point_on_lattice_surface-1325"><span class="linenos">1325</span></a><span class="sd">        surfaceNames: list[str]</span>
</span><span id="Lattice.find_point_on_lattice_surface-1326"><a href="#Lattice.find_point_on_lattice_surface-1326"><span class="linenos">1326</span></a><span class="sd">            List of surfaces to find points on (e.g., [&quot;Xmin&quot;, &quot;Xmax&quot;, &quot;Ymin&quot;])</span>
</span><span id="Lattice.find_point_on_lattice_surface-1327"><a href="#Lattice.find_point_on_lattice_surface-1327"><span class="linenos">1327</span></a>
</span><span id="Lattice.find_point_on_lattice_surface-1328"><a href="#Lattice.find_point_on_lattice_surface-1328"><span class="linenos">1328</span></a><span class="sd">        surface_cells: list[str], optional</span>
</span><span id="Lattice.find_point_on_lattice_surface-1329"><a href="#Lattice.find_point_on_lattice_surface-1329"><span class="linenos">1329</span></a><span class="sd">            List of surfaces to find points on cells (e.g., [&quot;Xmin&quot;, &quot;Xmax&quot;, &quot;Ymin&quot;]). If None, use surfaceNames.</span>
</span><span id="Lattice.find_point_on_lattice_surface-1330"><a href="#Lattice.find_point_on_lattice_surface-1330"><span class="linenos">1330</span></a>
</span><span id="Lattice.find_point_on_lattice_surface-1331"><a href="#Lattice.find_point_on_lattice_surface-1331"><span class="linenos">1331</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice.find_point_on_lattice_surface-1332"><a href="#Lattice.find_point_on_lattice_surface-1332"><span class="linenos">1332</span></a><span class="sd">        --------</span>
</span><span id="Lattice.find_point_on_lattice_surface-1333"><a href="#Lattice.find_point_on_lattice_surface-1333"><span class="linenos">1333</span></a><span class="sd">        pointSet: set of point objects</span>
</span><span id="Lattice.find_point_on_lattice_surface-1334"><a href="#Lattice.find_point_on_lattice_surface-1334"><span class="linenos">1334</span></a><span class="sd">            Set of points found on the specified surfaces</span>
</span><span id="Lattice.find_point_on_lattice_surface-1335"><a href="#Lattice.find_point_on_lattice_surface-1335"><span class="linenos">1335</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.find_point_on_lattice_surface-1336"><a href="#Lattice.find_point_on_lattice_surface-1336"><span class="linenos">1336</span></a>        <span class="n">valid_surfaces</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmin&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Xmid&quot;</span><span class="p">,</span> <span class="s2">&quot;Ymid&quot;</span><span class="p">,</span> <span class="s2">&quot;Zmid&quot;</span><span class="p">}</span>
</span><span id="Lattice.find_point_on_lattice_surface-1337"><a href="#Lattice.find_point_on_lattice_surface-1337"><span class="linenos">1337</span></a>
</span><span id="Lattice.find_point_on_lattice_surface-1338"><a href="#Lattice.find_point_on_lattice_surface-1338"><span class="linenos">1338</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">surface</span> <span class="ow">in</span> <span class="n">valid_surfaces</span> <span class="k">for</span> <span class="n">surface</span> <span class="ow">in</span> <span class="n">surfaceNames</span><span class="p">):</span>
</span><span id="Lattice.find_point_on_lattice_surface-1339"><a href="#Lattice.find_point_on_lattice_surface-1339"><span class="linenos">1339</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid surface name_lattice(s).&quot;</span><span class="p">)</span>
</span><span id="Lattice.find_point_on_lattice_surface-1340"><a href="#Lattice.find_point_on_lattice_surface-1340"><span class="linenos">1340</span></a>
</span><span id="Lattice.find_point_on_lattice_surface-1341"><a href="#Lattice.find_point_on_lattice_surface-1341"><span class="linenos">1341</span></a>        <span class="n">cell_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cells_on_surfaces</span><span class="p">(</span><span class="n">surfaceNames</span><span class="p">)</span>
</span><span id="Lattice.find_point_on_lattice_surface-1342"><a href="#Lattice.find_point_on_lattice_surface-1342"><span class="linenos">1342</span></a>        <span class="n">cell_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cell_list</span><span class="p">}</span>
</span><span id="Lattice.find_point_on_lattice_surface-1343"><a href="#Lattice.find_point_on_lattice_surface-1343"><span class="linenos">1343</span></a>
</span><span id="Lattice.find_point_on_lattice_surface-1344"><a href="#Lattice.find_point_on_lattice_surface-1344"><span class="linenos">1344</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">cell_indices</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Lattice.find_point_on_lattice_surface-1345"><a href="#Lattice.find_point_on_lattice_surface-1345"><span class="linenos">1345</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid cell index, some cells do not exist.&quot;</span><span class="p">)</span>
</span><span id="Lattice.find_point_on_lattice_surface-1346"><a href="#Lattice.find_point_on_lattice_surface-1346"><span class="linenos">1346</span></a>
</span><span id="Lattice.find_point_on_lattice_surface-1347"><a href="#Lattice.find_point_on_lattice_surface-1347"><span class="linenos">1347</span></a>        <span class="n">surface_on_cells</span> <span class="o">=</span> <span class="n">surface_cells</span> <span class="k">if</span> <span class="n">surface_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">surfaceNames</span>
</span><span id="Lattice.find_point_on_lattice_surface-1348"><a href="#Lattice.find_point_on_lattice_surface-1348"><span class="linenos">1348</span></a>        <span class="n">pointSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.find_point_on_lattice_surface-1349"><a href="#Lattice.find_point_on_lattice_surface-1349"><span class="linenos">1349</span></a>        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.find_point_on_lattice_surface-1350"><a href="#Lattice.find_point_on_lattice_surface-1350"><span class="linenos">1350</span></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">cell_indices</span><span class="p">:</span>
</span><span id="Lattice.find_point_on_lattice_surface-1351"><a href="#Lattice.find_point_on_lattice_surface-1351"><span class="linenos">1351</span></a>                <span class="n">cellPointSets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get_point_on_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">))</span> <span class="k">for</span> <span class="n">surface</span> <span class="ow">in</span> <span class="n">surface_on_cells</span><span class="p">]</span>
</span><span id="Lattice.find_point_on_lattice_surface-1352"><a href="#Lattice.find_point_on_lattice_surface-1352"><span class="linenos">1352</span></a>                <span class="k">if</span> <span class="n">cellPointSets</span><span class="p">:</span>
</span><span id="Lattice.find_point_on_lattice_surface-1353"><a href="#Lattice.find_point_on_lattice_surface-1353"><span class="linenos">1353</span></a>                    <span class="n">pointSet</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">cellPointSets</span><span class="p">))</span>
</span><span id="Lattice.find_point_on_lattice_surface-1354"><a href="#Lattice.find_point_on_lattice_surface-1354"><span class="linenos">1354</span></a>
</span><span id="Lattice.find_point_on_lattice_surface-1355"><a href="#Lattice.find_point_on_lattice_surface-1355"><span class="linenos">1355</span></a>        <span class="k">if</span> <span class="n">pointSet</span> <span class="o">==</span> <span class="nb">set</span><span class="p">():</span>
</span><span id="Lattice.find_point_on_lattice_surface-1356"><a href="#Lattice.find_point_on_lattice_surface-1356"><span class="linenos">1356</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No points found on the specified surfaces.&quot;</span><span class="p">)</span>
</span><span id="Lattice.find_point_on_lattice_surface-1357"><a href="#Lattice.find_point_on_lattice_surface-1357"><span class="linenos">1357</span></a>
</span><span id="Lattice.find_point_on_lattice_surface-1358"><a href="#Lattice.find_point_on_lattice_surface-1358"><span class="linenos">1358</span></a>        <span class="k">return</span> <span class="n">pointSet</span>
</span></pre></div>


            <div class="docstring"><p>Find points on the surface of the lattice</p>

<h2 id="parameters">Parameters:</h2>

<p>surfaceNames: list[str]
    List of surfaces to find points on (e.g., ["Xmin", "Xmax", "Ymin"])</p>

<p>surface_cells: list[str], optional
    List of surfaces to find points on cells (e.g., ["Xmin", "Xmax", "Ymin"]). If None, use surfaceNames.</p>

<h2 id="returns">Returns:</h2>

<p>pointSet: set of point objects
    Set of points found on the specified surfaces</p>
</div>


                            </div>
                            <div id="Lattice.get_cells_on_surfaces" class="classattr">
                                        <input id="Lattice.get_cells_on_surfaces-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_cells_on_surfaces</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">surfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_cells_on_surfaces-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_cells_on_surfaces"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_cells_on_surfaces-1360"><a href="#Lattice.get_cells_on_surfaces-1360"><span class="linenos">1360</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_cells_on_surfaces-1361"><a href="#Lattice.get_cells_on_surfaces-1361"><span class="linenos">1361</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_cells_on_surfaces-1362"><a href="#Lattice.get_cells_on_surfaces-1362"><span class="linenos">1362</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cells_on_surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfaces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1363"><a href="#Lattice.get_cells_on_surfaces-1363"><span class="linenos">1363</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_cells_on_surfaces-1364"><a href="#Lattice.get_cells_on_surfaces-1364"><span class="linenos">1364</span></a><span class="sd">        Return the list of Cell objects matching ordered extrema constraints like [&quot;Xmin&quot;], [&quot;Xmin&quot;,&quot;Zmax&quot;], etc.</span>
</span><span id="Lattice.get_cells_on_surfaces-1365"><a href="#Lattice.get_cells_on_surfaces-1365"><span class="linenos">1365</span></a><span class="sd">        Filtering is iterative: e.g., first keep all cells at X minimum, then among those keep Z maximum.</span>
</span><span id="Lattice.get_cells_on_surfaces-1366"><a href="#Lattice.get_cells_on_surfaces-1366"><span class="linenos">1366</span></a>
</span><span id="Lattice.get_cells_on_surfaces-1367"><a href="#Lattice.get_cells_on_surfaces-1367"><span class="linenos">1367</span></a><span class="sd">        Parameters</span>
</span><span id="Lattice.get_cells_on_surfaces-1368"><a href="#Lattice.get_cells_on_surfaces-1368"><span class="linenos">1368</span></a><span class="sd">        ----------</span>
</span><span id="Lattice.get_cells_on_surfaces-1369"><a href="#Lattice.get_cells_on_surfaces-1369"><span class="linenos">1369</span></a><span class="sd">        surfaces : list[str]</span>
</span><span id="Lattice.get_cells_on_surfaces-1370"><a href="#Lattice.get_cells_on_surfaces-1370"><span class="linenos">1370</span></a><span class="sd">            Each item is one of {&quot;Xmin&quot;,&quot;Xmax&quot;,&quot;Ymin&quot;,&quot;Ymax&quot;,&quot;Zmin&quot;,&quot;Zmax&quot;} (case-insensitive).</span>
</span><span id="Lattice.get_cells_on_surfaces-1371"><a href="#Lattice.get_cells_on_surfaces-1371"><span class="linenos">1371</span></a>
</span><span id="Lattice.get_cells_on_surfaces-1372"><a href="#Lattice.get_cells_on_surfaces-1372"><span class="linenos">1372</span></a><span class="sd">        Returns</span>
</span><span id="Lattice.get_cells_on_surfaces-1373"><a href="#Lattice.get_cells_on_surfaces-1373"><span class="linenos">1373</span></a><span class="sd">        -------</span>
</span><span id="Lattice.get_cells_on_surfaces-1374"><a href="#Lattice.get_cells_on_surfaces-1374"><span class="linenos">1374</span></a><span class="sd">        list</span>
</span><span id="Lattice.get_cells_on_surfaces-1375"><a href="#Lattice.get_cells_on_surfaces-1375"><span class="linenos">1375</span></a><span class="sd">            List of Cell objects (possibly multiple if several share the same extreme index).</span>
</span><span id="Lattice.get_cells_on_surfaces-1376"><a href="#Lattice.get_cells_on_surfaces-1376"><span class="linenos">1376</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_cells_on_surfaces-1377"><a href="#Lattice.get_cells_on_surfaces-1377"><span class="linenos">1377</span></a>        <span class="c1"># Ensure occupancy matrix is available</span>
</span><span id="Lattice.get_cells_on_surfaces-1378"><a href="#Lattice.get_cells_on_surfaces-1378"><span class="linenos">1378</span></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;occupancy_matrix&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1379"><a href="#Lattice.get_cells_on_surfaces-1379"><span class="linenos">1379</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_occupancy_matrix</span><span class="p">()</span>
</span><span id="Lattice.get_cells_on_surfaces-1380"><a href="#Lattice.get_cells_on_surfaces-1380"><span class="linenos">1380</span></a>
</span><span id="Lattice.get_cells_on_surfaces-1381"><a href="#Lattice.get_cells_on_surfaces-1381"><span class="linenos">1381</span></a>        <span class="c1"># Start from all occupied positions (use existing cells to avoid None handling)</span>
</span><span id="Lattice.get_cells_on_surfaces-1382"><a href="#Lattice.get_cells_on_surfaces-1382"><span class="linenos">1382</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">]</span>
</span><span id="Lattice.get_cells_on_surfaces-1383"><a href="#Lattice.get_cells_on_surfaces-1383"><span class="linenos">1383</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1384"><a href="#Lattice.get_cells_on_surfaces-1384"><span class="linenos">1384</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="Lattice.get_cells_on_surfaces-1385"><a href="#Lattice.get_cells_on_surfaces-1385"><span class="linenos">1385</span></a>
</span><span id="Lattice.get_cells_on_surfaces-1386"><a href="#Lattice.get_cells_on_surfaces-1386"><span class="linenos">1386</span></a>        <span class="n">axis_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span id="Lattice.get_cells_on_surfaces-1387"><a href="#Lattice.get_cells_on_surfaces-1387"><span class="linenos">1387</span></a>
</span><span id="Lattice.get_cells_on_surfaces-1388"><a href="#Lattice.get_cells_on_surfaces-1388"><span class="linenos">1388</span></a>        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1389"><a href="#Lattice.get_cells_on_surfaces-1389"><span class="linenos">1389</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Lattice.get_cells_on_surfaces-1390"><a href="#Lattice.get_cells_on_surfaces-1390"><span class="linenos">1390</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1391"><a href="#Lattice.get_cells_on_surfaces-1391"><span class="linenos">1391</span></a>                <span class="k">continue</span>
</span><span id="Lattice.get_cells_on_surfaces-1392"><a href="#Lattice.get_cells_on_surfaces-1392"><span class="linenos">1392</span></a>            <span class="n">ax_char</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="Lattice.get_cells_on_surfaces-1393"><a href="#Lattice.get_cells_on_surfaces-1393"><span class="linenos">1393</span></a>            <span class="k">if</span> <span class="n">ax_char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis_map</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1394"><a href="#Lattice.get_cells_on_surfaces-1394"><span class="linenos">1394</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid axis in constraint &#39;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&#39;, expected X/Y/Z with min/max.&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_cells_on_surfaces-1395"><a href="#Lattice.get_cells_on_surfaces-1395"><span class="linenos">1395</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis_map</span><span class="p">[</span><span class="n">ax_char</span><span class="p">]</span>
</span><span id="Lattice.get_cells_on_surfaces-1396"><a href="#Lattice.get_cells_on_surfaces-1396"><span class="linenos">1396</span></a>
</span><span id="Lattice.get_cells_on_surfaces-1397"><a href="#Lattice.get_cells_on_surfaces-1397"><span class="linenos">1397</span></a>            <span class="k">if</span> <span class="s2">&quot;min&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1398"><a href="#Lattice.get_cells_on_surfaces-1398"><span class="linenos">1398</span></a>                <span class="n">extreme</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">)</span>
</span><span id="Lattice.get_cells_on_surfaces-1399"><a href="#Lattice.get_cells_on_surfaces-1399"><span class="linenos">1399</span></a>            <span class="k">elif</span> <span class="s2">&quot;max&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1400"><a href="#Lattice.get_cells_on_surfaces-1400"><span class="linenos">1400</span></a>                <span class="n">extreme</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">)</span>
</span><span id="Lattice.get_cells_on_surfaces-1401"><a href="#Lattice.get_cells_on_surfaces-1401"><span class="linenos">1401</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1402"><a href="#Lattice.get_cells_on_surfaces-1402"><span class="linenos">1402</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid extrema in constraint &#39;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&#39;, expected &#39;min&#39; or &#39;max&#39;.&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_cells_on_surfaces-1403"><a href="#Lattice.get_cells_on_surfaces-1403"><span class="linenos">1403</span></a>
</span><span id="Lattice.get_cells_on_surfaces-1404"><a href="#Lattice.get_cells_on_surfaces-1404"><span class="linenos">1404</span></a>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="o">==</span> <span class="n">extreme</span><span class="p">]</span>
</span><span id="Lattice.get_cells_on_surfaces-1405"><a href="#Lattice.get_cells_on_surfaces-1405"><span class="linenos">1405</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="Lattice.get_cells_on_surfaces-1406"><a href="#Lattice.get_cells_on_surfaces-1406"><span class="linenos">1406</span></a>                <span class="k">return</span> <span class="p">[]</span>
</span><span id="Lattice.get_cells_on_surfaces-1407"><a href="#Lattice.get_cells_on_surfaces-1407"><span class="linenos">1407</span></a>
</span><span id="Lattice.get_cells_on_surfaces-1408"><a href="#Lattice.get_cells_on_surfaces-1408"><span class="linenos">1408</span></a>        <span class="c1"># Map positions back to Cell objects via the occupancy matrix (ignore any None just in case)</span>
</span><span id="Lattice.get_cells_on_surfaces-1409"><a href="#Lattice.get_cells_on_surfaces-1409"><span class="linenos">1409</span></a>        <span class="n">occ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupancy_matrix</span>
</span><span id="Lattice.get_cells_on_surfaces-1410"><a href="#Lattice.get_cells_on_surfaces-1410"><span class="linenos">1410</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">occ</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="n">occ</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Return the list of Cell objects matching ordered extrema constraints like ["Xmin"], ["Xmin","Zmax"], etc.
Filtering is iterative: e.g., first keep all cells at X minimum, then among those keep Z maximum.</p>

<h2 id="parameters">Parameters</h2>

<p>surfaces : list[str]
    Each item is one of {"Xmin","Xmax","Ymin","Ymax","Zmin","Zmax"} (case-insensitive).</p>

<h2 id="returns">Returns</h2>

<p>list
    List of Cell objects (possibly multiple if several share the same extreme index).</p>
</div>


                            </div>
                            <div id="Lattice.print_statistics_lattice" class="classattr">
                                        <input id="Lattice.print_statistics_lattice-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_statistics_lattice</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Lattice.print_statistics_lattice-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.print_statistics_lattice"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.print_statistics_lattice-1412"><a href="#Lattice.print_statistics_lattice-1412"><span class="linenos">1412</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_statistics_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice.print_statistics_lattice-1413"><a href="#Lattice.print_statistics_lattice-1413"><span class="linenos">1413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.print_statistics_lattice-1414"><a href="#Lattice.print_statistics_lattice-1414"><span class="linenos">1414</span></a><span class="sd">        Print statistics about the lattice</span>
</span><span id="Lattice.print_statistics_lattice-1415"><a href="#Lattice.print_statistics_lattice-1415"><span class="linenos">1415</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.print_statistics_lattice-1416"><a href="#Lattice.print_statistics_lattice-1416"><span class="linenos">1416</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lattice name: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_name_lattice</span><span class="p">())</span>
</span><span id="Lattice.print_statistics_lattice-1417"><a href="#Lattice.print_statistics_lattice-1417"><span class="linenos">1417</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of cells: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">))</span>
</span><span id="Lattice.print_statistics_lattice-1418"><a href="#Lattice.print_statistics_lattice-1418"><span class="linenos">1418</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of beams: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_beams</span><span class="p">())</span>
</span><span id="Lattice.print_statistics_lattice-1419"><a href="#Lattice.print_statistics_lattice-1419"><span class="linenos">1419</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of nodes: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_nodes</span><span class="p">())</span>
</span><span id="Lattice.print_statistics_lattice-1420"><a href="#Lattice.print_statistics_lattice-1420"><span class="linenos">1420</span></a>        <span class="n">radMax</span><span class="p">,</span> <span class="n">radMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_beam_radius_min_max</span><span class="p">()</span>
</span><span id="Lattice.print_statistics_lattice-1421"><a href="#Lattice.print_statistics_lattice-1421"><span class="linenos">1421</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radii max: &quot;</span><span class="p">,</span> <span class="n">radMax</span><span class="p">)</span>
</span><span id="Lattice.print_statistics_lattice-1422"><a href="#Lattice.print_statistics_lattice-1422"><span class="linenos">1422</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radii min: &quot;</span><span class="p">,</span> <span class="n">radMin</span><span class="p">)</span>
</span><span id="Lattice.print_statistics_lattice-1423"><a href="#Lattice.print_statistics_lattice-1423"><span class="linenos">1423</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lattice dimensions: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_z</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Print statistics about the lattice</p>
</div>


                            </div>
                            <div id="Lattice.delete_orphan_points" class="classattr">
                                        <input id="Lattice.delete_orphan_points-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">delete_orphan_points</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Lattice.delete_orphan_points-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.delete_orphan_points"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.delete_orphan_points-1425"><a href="#Lattice.delete_orphan_points-1425"><span class="linenos">1425</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.delete_orphan_points-1426"><a href="#Lattice.delete_orphan_points-1426"><span class="linenos">1426</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.delete_orphan_points-1427"><a href="#Lattice.delete_orphan_points-1427"><span class="linenos">1427</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_orphan_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Lattice.delete_orphan_points-1428"><a href="#Lattice.delete_orphan_points-1428"><span class="linenos">1428</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.delete_orphan_points-1429"><a href="#Lattice.delete_orphan_points-1429"><span class="linenos">1429</span></a><span class="sd">        Delete points that are not connected to any beam in the lattice.</span>
</span><span id="Lattice.delete_orphan_points-1430"><a href="#Lattice.delete_orphan_points-1430"><span class="linenos">1430</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.delete_orphan_points-1431"><a href="#Lattice.delete_orphan_points-1431"><span class="linenos">1431</span></a>        <span class="n">live_points</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.delete_orphan_points-1432"><a href="#Lattice.delete_orphan_points-1432"><span class="linenos">1432</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice.delete_orphan_points-1433"><a href="#Lattice.delete_orphan_points-1433"><span class="linenos">1433</span></a>            <span class="n">live_points</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="p">)</span>
</span><span id="Lattice.delete_orphan_points-1434"><a href="#Lattice.delete_orphan_points-1434"><span class="linenos">1434</span></a>            <span class="n">live_points</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="p">)</span>
</span><span id="Lattice.delete_orphan_points-1435"><a href="#Lattice.delete_orphan_points-1435"><span class="linenos">1435</span></a>
</span><span id="Lattice.delete_orphan_points-1436"><a href="#Lattice.delete_orphan_points-1436"><span class="linenos">1436</span></a>        <span class="n">all_points</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.delete_orphan_points-1437"><a href="#Lattice.delete_orphan_points-1437"><span class="linenos">1437</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
</span><span id="Lattice.delete_orphan_points-1438"><a href="#Lattice.delete_orphan_points-1438"><span class="linenos">1438</span></a>            <span class="n">all_points</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">points_cell</span><span class="p">)</span>
</span><span id="Lattice.delete_orphan_points-1439"><a href="#Lattice.delete_orphan_points-1439"><span class="linenos">1439</span></a>
</span><span id="Lattice.delete_orphan_points-1440"><a href="#Lattice.delete_orphan_points-1440"><span class="linenos">1440</span></a>        <span class="n">orphan_points</span> <span class="o">=</span> <span class="n">all_points</span> <span class="o">-</span> <span class="n">live_points</span>
</span><span id="Lattice.delete_orphan_points-1441"><a href="#Lattice.delete_orphan_points-1441"><span class="linenos">1441</span></a>
</span><span id="Lattice.delete_orphan_points-1442"><a href="#Lattice.delete_orphan_points-1442"><span class="linenos">1442</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">orphan_points</span><span class="p">:</span>
</span><span id="Lattice.delete_orphan_points-1443"><a href="#Lattice.delete_orphan_points-1443"><span class="linenos">1443</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Lattice.delete_orphan_points-1444"><a href="#Lattice.delete_orphan_points-1444"><span class="linenos">1444</span></a>
</span><span id="Lattice.delete_orphan_points-1445"><a href="#Lattice.delete_orphan_points-1445"><span class="linenos">1445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice.delete_orphan_points-1446"><a href="#Lattice.delete_orphan_points-1446"><span class="linenos">1446</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Delete points that are not connected to any beam in the lattice.</p>
</div>


                            </div>
                            <div id="Lattice.merge_degree2_nodes" class="classattr">
                                        <input id="Lattice.merge_degree2_nodes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">merge_degree2_nodes</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">colinear_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">radius_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inherit&#39;</span>,</span><span class="param">	<span class="n">type_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inherit&#39;</span>,</span><span class="param">	<span class="n">material_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inherit&#39;</span>,</span><span class="param">	<span class="n">iterative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">max_passes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="Lattice.merge_degree2_nodes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.merge_degree2_nodes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.merge_degree2_nodes-1448"><a href="#Lattice.merge_degree2_nodes-1448"><span class="linenos">1448</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1449"><a href="#Lattice.merge_degree2_nodes-1449"><span class="linenos">1449</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.merge_degree2_nodes-1450"><a href="#Lattice.merge_degree2_nodes-1450"><span class="linenos">1450</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge_degree2_nodes</span><span class="p">(</span>
</span><span id="Lattice.merge_degree2_nodes-1451"><a href="#Lattice.merge_degree2_nodes-1451"><span class="linenos">1451</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Lattice.merge_degree2_nodes-1452"><a href="#Lattice.merge_degree2_nodes-1452"><span class="linenos">1452</span></a>            <span class="n">colinear_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice.merge_degree2_nodes-1453"><a href="#Lattice.merge_degree2_nodes-1453"><span class="linenos">1453</span></a>            <span class="n">radius_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">,</span>  <span class="c1"># &quot;inherit&quot; | &quot;max&quot; | &quot;min&quot; | &quot;avg&quot;</span>
</span><span id="Lattice.merge_degree2_nodes-1454"><a href="#Lattice.merge_degree2_nodes-1454"><span class="linenos">1454</span></a>            <span class="n">type_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">,</span>  <span class="c1"># &quot;inherit&quot; -&gt; si diff√©rents, on prend b1</span>
</span><span id="Lattice.merge_degree2_nodes-1455"><a href="#Lattice.merge_degree2_nodes-1455"><span class="linenos">1455</span></a>            <span class="n">material_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inherit&quot;</span><span class="p">,</span>  <span class="c1"># idem</span>
</span><span id="Lattice.merge_degree2_nodes-1456"><a href="#Lattice.merge_degree2_nodes-1456"><span class="linenos">1456</span></a>            <span class="n">iterative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice.merge_degree2_nodes-1457"><a href="#Lattice.merge_degree2_nodes-1457"><span class="linenos">1457</span></a>            <span class="n">max_passes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Lattice.merge_degree2_nodes-1458"><a href="#Lattice.merge_degree2_nodes-1458"><span class="linenos">1458</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1459"><a href="#Lattice.merge_degree2_nodes-1459"><span class="linenos">1459</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.merge_degree2_nodes-1460"><a href="#Lattice.merge_degree2_nodes-1460"><span class="linenos">1460</span></a><span class="sd">        Fusion of nodes with exactly 2 connected beams.</span>
</span><span id="Lattice.merge_degree2_nodes-1461"><a href="#Lattice.merge_degree2_nodes-1461"><span class="linenos">1461</span></a><span class="sd">        The two beams must be colinear (if colinear_only=True) and the node must be between the two beam endpoints.</span>
</span><span id="Lattice.merge_degree2_nodes-1462"><a href="#Lattice.merge_degree2_nodes-1462"><span class="linenos">1462</span></a><span class="sd">        The two beams are replaced by a single beam connecting the two distant endpoints.</span>
</span><span id="Lattice.merge_degree2_nodes-1463"><a href="#Lattice.merge_degree2_nodes-1463"><span class="linenos">1463</span></a>
</span><span id="Lattice.merge_degree2_nodes-1464"><a href="#Lattice.merge_degree2_nodes-1464"><span class="linenos">1464</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.merge_degree2_nodes-1465"><a href="#Lattice.merge_degree2_nodes-1465"><span class="linenos">1465</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.merge_degree2_nodes-1466"><a href="#Lattice.merge_degree2_nodes-1466"><span class="linenos">1466</span></a><span class="sd">        colinear_only : bool</span>
</span><span id="Lattice.merge_degree2_nodes-1467"><a href="#Lattice.merge_degree2_nodes-1467"><span class="linenos">1467</span></a><span class="sd">            If True, only merge if the two beams are colinear.</span>
</span><span id="Lattice.merge_degree2_nodes-1468"><a href="#Lattice.merge_degree2_nodes-1468"><span class="linenos">1468</span></a>
</span><span id="Lattice.merge_degree2_nodes-1469"><a href="#Lattice.merge_degree2_nodes-1469"><span class="linenos">1469</span></a><span class="sd">        radius_strategy : str</span>
</span><span id="Lattice.merge_degree2_nodes-1470"><a href="#Lattice.merge_degree2_nodes-1470"><span class="linenos">1470</span></a><span class="sd">            Strategy for determining the radius of the new beam:</span>
</span><span id="Lattice.merge_degree2_nodes-1471"><a href="#Lattice.merge_degree2_nodes-1471"><span class="linenos">1471</span></a><span class="sd">            &quot;inherit&quot; (default) - if both beams have the same radius, use it; otherwise use b1&#39;s radius.</span>
</span><span id="Lattice.merge_degree2_nodes-1472"><a href="#Lattice.merge_degree2_nodes-1472"><span class="linenos">1472</span></a><span class="sd">            &quot;max&quot; - use the maximum radius of the two beams.</span>
</span><span id="Lattice.merge_degree2_nodes-1473"><a href="#Lattice.merge_degree2_nodes-1473"><span class="linenos">1473</span></a><span class="sd">            &quot;min&quot; - use the minimum radius of the two beams.</span>
</span><span id="Lattice.merge_degree2_nodes-1474"><a href="#Lattice.merge_degree2_nodes-1474"><span class="linenos">1474</span></a><span class="sd">            &quot;avg&quot; - use the average radius of the two beams.</span>
</span><span id="Lattice.merge_degree2_nodes-1475"><a href="#Lattice.merge_degree2_nodes-1475"><span class="linenos">1475</span></a>
</span><span id="Lattice.merge_degree2_nodes-1476"><a href="#Lattice.merge_degree2_nodes-1476"><span class="linenos">1476</span></a><span class="sd">        type_strategy : str</span>
</span><span id="Lattice.merge_degree2_nodes-1477"><a href="#Lattice.merge_degree2_nodes-1477"><span class="linenos">1477</span></a><span class="sd">            Strategy for determining the type of the new beam:</span>
</span><span id="Lattice.merge_degree2_nodes-1478"><a href="#Lattice.merge_degree2_nodes-1478"><span class="linenos">1478</span></a><span class="sd">            &quot;inherit&quot; (default) - if both beams have the same type, use it; otherwise use b1&#39;s type.</span>
</span><span id="Lattice.merge_degree2_nodes-1479"><a href="#Lattice.merge_degree2_nodes-1479"><span class="linenos">1479</span></a><span class="sd">            &quot;max&quot; - use the maximum type of the two beams.</span>
</span><span id="Lattice.merge_degree2_nodes-1480"><a href="#Lattice.merge_degree2_nodes-1480"><span class="linenos">1480</span></a><span class="sd">            &quot;min&quot; - use the minimum type of the two beams.</span>
</span><span id="Lattice.merge_degree2_nodes-1481"><a href="#Lattice.merge_degree2_nodes-1481"><span class="linenos">1481</span></a><span class="sd">            &quot;avg&quot; - use the average type of the two beams (rounded).</span>
</span><span id="Lattice.merge_degree2_nodes-1482"><a href="#Lattice.merge_degree2_nodes-1482"><span class="linenos">1482</span></a>
</span><span id="Lattice.merge_degree2_nodes-1483"><a href="#Lattice.merge_degree2_nodes-1483"><span class="linenos">1483</span></a><span class="sd">        material_strategy : str</span>
</span><span id="Lattice.merge_degree2_nodes-1484"><a href="#Lattice.merge_degree2_nodes-1484"><span class="linenos">1484</span></a><span class="sd">            Strategy for determining the material of the new beam:</span>
</span><span id="Lattice.merge_degree2_nodes-1485"><a href="#Lattice.merge_degree2_nodes-1485"><span class="linenos">1485</span></a><span class="sd">            &quot;inherit&quot; (default) - if both beams have the same material, use it; otherwise use b1&#39;s material.</span>
</span><span id="Lattice.merge_degree2_nodes-1486"><a href="#Lattice.merge_degree2_nodes-1486"><span class="linenos">1486</span></a><span class="sd">            &quot;max&quot; - use the maximum material of the two beams.</span>
</span><span id="Lattice.merge_degree2_nodes-1487"><a href="#Lattice.merge_degree2_nodes-1487"><span class="linenos">1487</span></a><span class="sd">            &quot;min&quot; - use the minimum material of the two beams.</span>
</span><span id="Lattice.merge_degree2_nodes-1488"><a href="#Lattice.merge_degree2_nodes-1488"><span class="linenos">1488</span></a><span class="sd">            &quot;avg&quot; - use the average material of the two beams (rounded).</span>
</span><span id="Lattice.merge_degree2_nodes-1489"><a href="#Lattice.merge_degree2_nodes-1489"><span class="linenos">1489</span></a>
</span><span id="Lattice.merge_degree2_nodes-1490"><a href="#Lattice.merge_degree2_nodes-1490"><span class="linenos">1490</span></a><span class="sd">        iterative : bool</span>
</span><span id="Lattice.merge_degree2_nodes-1491"><a href="#Lattice.merge_degree2_nodes-1491"><span class="linenos">1491</span></a><span class="sd">            If True, repeat the merging process until no more merges are possible or max_passes is reached.</span>
</span><span id="Lattice.merge_degree2_nodes-1492"><a href="#Lattice.merge_degree2_nodes-1492"><span class="linenos">1492</span></a>
</span><span id="Lattice.merge_degree2_nodes-1493"><a href="#Lattice.merge_degree2_nodes-1493"><span class="linenos">1493</span></a><span class="sd">        max_passes : int</span>
</span><span id="Lattice.merge_degree2_nodes-1494"><a href="#Lattice.merge_degree2_nodes-1494"><span class="linenos">1494</span></a><span class="sd">            Maximum number of passes if iterative is True.</span>
</span><span id="Lattice.merge_degree2_nodes-1495"><a href="#Lattice.merge_degree2_nodes-1495"><span class="linenos">1495</span></a>
</span><span id="Lattice.merge_degree2_nodes-1496"><a href="#Lattice.merge_degree2_nodes-1496"><span class="linenos">1496</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice.merge_degree2_nodes-1497"><a href="#Lattice.merge_degree2_nodes-1497"><span class="linenos">1497</span></a><span class="sd">        --------</span>
</span><span id="Lattice.merge_degree2_nodes-1498"><a href="#Lattice.merge_degree2_nodes-1498"><span class="linenos">1498</span></a><span class="sd">        total_merged : int</span>
</span><span id="Lattice.merge_degree2_nodes-1499"><a href="#Lattice.merge_degree2_nodes-1499"><span class="linenos">1499</span></a><span class="sd">            Total number of nodes merged.</span>
</span><span id="Lattice.merge_degree2_nodes-1500"><a href="#Lattice.merge_degree2_nodes-1500"><span class="linenos">1500</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.merge_degree2_nodes-1501"><a href="#Lattice.merge_degree2_nodes-1501"><span class="linenos">1501</span></a>
</span><span id="Lattice.merge_degree2_nodes-1502"><a href="#Lattice.merge_degree2_nodes-1502"><span class="linenos">1502</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_has_beam_between</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="Lattice.merge_degree2_nodes-1503"><a href="#Lattice.merge_degree2_nodes-1503"><span class="linenos">1503</span></a>            <span class="c1"># Check if a beam already exists between points a and c</span>
</span><span id="Lattice.merge_degree2_nodes-1504"><a href="#Lattice.merge_degree2_nodes-1504"><span class="linenos">1504</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1505"><a href="#Lattice.merge_degree2_nodes-1505"><span class="linenos">1505</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span> <span class="ow">is</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span> <span class="ow">is</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">a</span><span class="p">):</span>
</span><span id="Lattice.merge_degree2_nodes-1506"><a href="#Lattice.merge_degree2_nodes-1506"><span class="linenos">1506</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="Lattice.merge_degree2_nodes-1507"><a href="#Lattice.merge_degree2_nodes-1507"><span class="linenos">1507</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Lattice.merge_degree2_nodes-1508"><a href="#Lattice.merge_degree2_nodes-1508"><span class="linenos">1508</span></a>
</span><span id="Lattice.merge_degree2_nodes-1509"><a href="#Lattice.merge_degree2_nodes-1509"><span class="linenos">1509</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_choose</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">avg_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Lattice.merge_degree2_nodes-1510"><a href="#Lattice.merge_degree2_nodes-1510"><span class="linenos">1510</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1511"><a href="#Lattice.merge_degree2_nodes-1511"><span class="linenos">1511</span></a>                <span class="k">return</span> <span class="n">val1</span> <span class="k">if</span> <span class="n">val1</span> <span class="o">==</span> <span class="n">val2</span> <span class="ow">or</span> <span class="n">val2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val1</span>
</span><span id="Lattice.merge_degree2_nodes-1512"><a href="#Lattice.merge_degree2_nodes-1512"><span class="linenos">1512</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1513"><a href="#Lattice.merge_degree2_nodes-1513"><span class="linenos">1513</span></a>                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1514"><a href="#Lattice.merge_degree2_nodes-1514"><span class="linenos">1514</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1515"><a href="#Lattice.merge_degree2_nodes-1515"><span class="linenos">1515</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1516"><a href="#Lattice.merge_degree2_nodes-1516"><span class="linenos">1516</span></a>            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1517"><a href="#Lattice.merge_degree2_nodes-1517"><span class="linenos">1517</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">val1</span> <span class="o">+</span> <span class="n">val2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">avg_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">avg_fn</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1518"><a href="#Lattice.merge_degree2_nodes-1518"><span class="linenos">1518</span></a>            <span class="k">return</span> <span class="n">val1</span>
</span><span id="Lattice.merge_degree2_nodes-1519"><a href="#Lattice.merge_degree2_nodes-1519"><span class="linenos">1519</span></a>
</span><span id="Lattice.merge_degree2_nodes-1520"><a href="#Lattice.merge_degree2_nodes-1520"><span class="linenos">1520</span></a>        <span class="n">total_merged</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice.merge_degree2_nodes-1521"><a href="#Lattice.merge_degree2_nodes-1521"><span class="linenos">1521</span></a>        <span class="n">passes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice.merge_degree2_nodes-1522"><a href="#Lattice.merge_degree2_nodes-1522"><span class="linenos">1522</span></a>
</span><span id="Lattice.merge_degree2_nodes-1523"><a href="#Lattice.merge_degree2_nodes-1523"><span class="linenos">1523</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1524"><a href="#Lattice.merge_degree2_nodes-1524"><span class="linenos">1524</span></a>            <span class="n">passes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Lattice.merge_degree2_nodes-1525"><a href="#Lattice.merge_degree2_nodes-1525"><span class="linenos">1525</span></a>            <span class="c1"># Redefine connectivity</span>
</span><span id="Lattice.merge_degree2_nodes-1526"><a href="#Lattice.merge_degree2_nodes-1526"><span class="linenos">1526</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1527"><a href="#Lattice.merge_degree2_nodes-1527"><span class="linenos">1527</span></a>
</span><span id="Lattice.merge_degree2_nodes-1528"><a href="#Lattice.merge_degree2_nodes-1528"><span class="linenos">1528</span></a>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;connected_beams&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="Lattice.merge_degree2_nodes-1529"><a href="#Lattice.merge_degree2_nodes-1529"><span class="linenos">1529</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1530"><a href="#Lattice.merge_degree2_nodes-1530"><span class="linenos">1530</span></a>                <span class="k">break</span>
</span><span id="Lattice.merge_degree2_nodes-1531"><a href="#Lattice.merge_degree2_nodes-1531"><span class="linenos">1531</span></a>
</span><span id="Lattice.merge_degree2_nodes-1532"><a href="#Lattice.merge_degree2_nodes-1532"><span class="linenos">1532</span></a>            <span class="n">used_beams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1533"><a href="#Lattice.merge_degree2_nodes-1533"><span class="linenos">1533</span></a>            <span class="n">merges</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.merge_degree2_nodes-1534"><a href="#Lattice.merge_degree2_nodes-1534"><span class="linenos">1534</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1535"><a href="#Lattice.merge_degree2_nodes-1535"><span class="linenos">1535</span></a>                <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">connected_beams</span>
</span><span id="Lattice.merge_degree2_nodes-1536"><a href="#Lattice.merge_degree2_nodes-1536"><span class="linenos">1536</span></a>                <span class="k">if</span> <span class="n">b1</span> <span class="ow">in</span> <span class="n">used_beams</span> <span class="ow">or</span> <span class="n">b2</span> <span class="ow">in</span> <span class="n">used_beams</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1537"><a href="#Lattice.merge_degree2_nodes-1537"><span class="linenos">1537</span></a>                    <span class="k">continue</span>
</span><span id="Lattice.merge_degree2_nodes-1538"><a href="#Lattice.merge_degree2_nodes-1538"><span class="linenos">1538</span></a>
</span><span id="Lattice.merge_degree2_nodes-1539"><a href="#Lattice.merge_degree2_nodes-1539"><span class="linenos">1539</span></a>                <span class="n">a</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">point1</span> <span class="k">if</span> <span class="n">b1</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">p</span> <span class="k">else</span> <span class="n">b1</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice.merge_degree2_nodes-1540"><a href="#Lattice.merge_degree2_nodes-1540"><span class="linenos">1540</span></a>                <span class="n">c</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">point1</span> <span class="k">if</span> <span class="n">b2</span><span class="o">.</span><span class="n">point2</span> <span class="ow">is</span> <span class="n">p</span> <span class="k">else</span> <span class="n">b2</span><span class="o">.</span><span class="n">point2</span>
</span><span id="Lattice.merge_degree2_nodes-1541"><a href="#Lattice.merge_degree2_nodes-1541"><span class="linenos">1541</span></a>                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">c</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1542"><a href="#Lattice.merge_degree2_nodes-1542"><span class="linenos">1542</span></a>                    <span class="k">continue</span>
</span><span id="Lattice.merge_degree2_nodes-1543"><a href="#Lattice.merge_degree2_nodes-1543"><span class="linenos">1543</span></a>
</span><span id="Lattice.merge_degree2_nodes-1544"><a href="#Lattice.merge_degree2_nodes-1544"><span class="linenos">1544</span></a>                <span class="k">if</span> <span class="n">colinear_only</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1545"><a href="#Lattice.merge_degree2_nodes-1545"><span class="linenos">1545</span></a>                    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1546"><a href="#Lattice.merge_degree2_nodes-1546"><span class="linenos">1546</span></a>                    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1547"><a href="#Lattice.merge_degree2_nodes-1547"><span class="linenos">1547</span></a>                    <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1548"><a href="#Lattice.merge_degree2_nodes-1548"><span class="linenos">1548</span></a>                    <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1549"><a href="#Lattice.merge_degree2_nodes-1549"><span class="linenos">1549</span></a>                    <span class="k">if</span> <span class="n">n1</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">n2</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1550"><a href="#Lattice.merge_degree2_nodes-1550"><span class="linenos">1550</span></a>                        <span class="k">continue</span>
</span><span id="Lattice.merge_degree2_nodes-1551"><a href="#Lattice.merge_degree2_nodes-1551"><span class="linenos">1551</span></a>
</span><span id="Lattice.merge_degree2_nodes-1552"><a href="#Lattice.merge_degree2_nodes-1552"><span class="linenos">1552</span></a>                    <span class="n">cross_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>
</span><span id="Lattice.merge_degree2_nodes-1553"><a href="#Lattice.merge_degree2_nodes-1553"><span class="linenos">1553</span></a>                    <span class="k">if</span> <span class="n">cross_norm</span> <span class="o">&gt;</span> <span class="n">angle_tol</span> <span class="o">*</span> <span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="p">):</span>
</span><span id="Lattice.merge_degree2_nodes-1554"><a href="#Lattice.merge_degree2_nodes-1554"><span class="linenos">1554</span></a>                        <span class="k">continue</span>
</span><span id="Lattice.merge_degree2_nodes-1555"><a href="#Lattice.merge_degree2_nodes-1555"><span class="linenos">1555</span></a>                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1556"><a href="#Lattice.merge_degree2_nodes-1556"><span class="linenos">1556</span></a>                        <span class="k">continue</span>
</span><span id="Lattice.merge_degree2_nodes-1557"><a href="#Lattice.merge_degree2_nodes-1557"><span class="linenos">1557</span></a>
</span><span id="Lattice.merge_degree2_nodes-1558"><a href="#Lattice.merge_degree2_nodes-1558"><span class="linenos">1558</span></a>                <span class="k">if</span> <span class="n">_has_beam_between</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="Lattice.merge_degree2_nodes-1559"><a href="#Lattice.merge_degree2_nodes-1559"><span class="linenos">1559</span></a>                    <span class="k">continue</span>
</span><span id="Lattice.merge_degree2_nodes-1560"><a href="#Lattice.merge_degree2_nodes-1560"><span class="linenos">1560</span></a>
</span><span id="Lattice.merge_degree2_nodes-1561"><a href="#Lattice.merge_degree2_nodes-1561"><span class="linenos">1561</span></a>                <span class="n">merges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
</span><span id="Lattice.merge_degree2_nodes-1562"><a href="#Lattice.merge_degree2_nodes-1562"><span class="linenos">1562</span></a>                <span class="n">used_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1563"><a href="#Lattice.merge_degree2_nodes-1563"><span class="linenos">1563</span></a>                <span class="n">used_beams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1564"><a href="#Lattice.merge_degree2_nodes-1564"><span class="linenos">1564</span></a>
</span><span id="Lattice.merge_degree2_nodes-1565"><a href="#Lattice.merge_degree2_nodes-1565"><span class="linenos">1565</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">merges</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1566"><a href="#Lattice.merge_degree2_nodes-1566"><span class="linenos">1566</span></a>                <span class="k">break</span>
</span><span id="Lattice.merge_degree2_nodes-1567"><a href="#Lattice.merge_degree2_nodes-1567"><span class="linenos">1567</span></a>
</span><span id="Lattice.merge_degree2_nodes-1568"><a href="#Lattice.merge_degree2_nodes-1568"><span class="linenos">1568</span></a>            <span class="n">beams_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1569"><a href="#Lattice.merge_degree2_nodes-1569"><span class="linenos">1569</span></a>            <span class="n">beams_to_add</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1570"><a href="#Lattice.merge_degree2_nodes-1570"><span class="linenos">1570</span></a>            <span class="n">points_to_destroy</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1571"><a href="#Lattice.merge_degree2_nodes-1571"><span class="linenos">1571</span></a>
</span><span id="Lattice.merge_degree2_nodes-1572"><a href="#Lattice.merge_degree2_nodes-1572"><span class="linenos">1572</span></a>            <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1573"><a href="#Lattice.merge_degree2_nodes-1573"><span class="linenos">1573</span></a>                <span class="n">radius</span> <span class="o">=</span> <span class="n">_choose</span><span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius_strategy</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1574"><a href="#Lattice.merge_degree2_nodes-1574"><span class="linenos">1574</span></a>                <span class="n">typ</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">type_beam</span> <span class="k">if</span> <span class="p">(</span><span class="n">type_strategy</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span> <span class="ow">or</span> <span class="n">b1</span><span class="o">.</span><span class="n">type_beam</span> <span class="o">==</span> <span class="n">b2</span><span class="o">.</span><span class="n">type_beam</span><span class="p">)</span> <span class="k">else</span> <span class="n">b1</span><span class="o">.</span><span class="n">type_beam</span>
</span><span id="Lattice.merge_degree2_nodes-1575"><a href="#Lattice.merge_degree2_nodes-1575"><span class="linenos">1575</span></a>                <span class="n">mat</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">material</span> <span class="k">if</span> <span class="p">(</span><span class="n">material_strategy</span> <span class="o">==</span> <span class="s2">&quot;inherit&quot;</span> <span class="ow">or</span> <span class="n">b1</span><span class="o">.</span><span class="n">material</span> <span class="o">==</span> <span class="n">b2</span><span class="o">.</span><span class="n">material</span><span class="p">)</span> <span class="k">else</span> <span class="n">b1</span><span class="o">.</span><span class="n">material</span>
</span><span id="Lattice.merge_degree2_nodes-1576"><a href="#Lattice.merge_degree2_nodes-1576"><span class="linenos">1576</span></a>
</span><span id="Lattice.merge_degree2_nodes-1577"><a href="#Lattice.merge_degree2_nodes-1577"><span class="linenos">1577</span></a>                <span class="n">cells_union</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1578"><a href="#Lattice.merge_degree2_nodes-1578"><span class="linenos">1578</span></a>                <span class="k">for</span> <span class="n">bm</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">):</span>
</span><span id="Lattice.merge_degree2_nodes-1579"><a href="#Lattice.merge_degree2_nodes-1579"><span class="linenos">1579</span></a>                    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bm</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Lattice.merge_degree2_nodes-1580"><a href="#Lattice.merge_degree2_nodes-1580"><span class="linenos">1580</span></a>                        <span class="n">cells_union</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1581"><a href="#Lattice.merge_degree2_nodes-1581"><span class="linenos">1581</span></a>
</span><span id="Lattice.merge_degree2_nodes-1582"><a href="#Lattice.merge_degree2_nodes-1582"><span class="linenos">1582</span></a>                <span class="n">new_beam</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">cells_union</span><span class="p">))</span>
</span><span id="Lattice.merge_degree2_nodes-1583"><a href="#Lattice.merge_degree2_nodes-1583"><span class="linenos">1583</span></a>
</span><span id="Lattice.merge_degree2_nodes-1584"><a href="#Lattice.merge_degree2_nodes-1584"><span class="linenos">1584</span></a>                <span class="k">for</span> <span class="n">bm</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">):</span>
</span><span id="Lattice.merge_degree2_nodes-1585"><a href="#Lattice.merge_degree2_nodes-1585"><span class="linenos">1585</span></a>                    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">bm</span><span class="p">,</span> <span class="s2">&quot;cell_belongings&quot;</span><span class="p">,</span> <span class="p">[]))):</span>
</span><span id="Lattice.merge_degree2_nodes-1586"><a href="#Lattice.merge_degree2_nodes-1586"><span class="linenos">1586</span></a>                        <span class="n">cell</span><span class="o">.</span><span class="n">remove_beam</span><span class="p">(</span><span class="n">bm</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1587"><a href="#Lattice.merge_degree2_nodes-1587"><span class="linenos">1587</span></a>
</span><span id="Lattice.merge_degree2_nodes-1588"><a href="#Lattice.merge_degree2_nodes-1588"><span class="linenos">1588</span></a>                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells_union</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1589"><a href="#Lattice.merge_degree2_nodes-1589"><span class="linenos">1589</span></a>                    <span class="n">cell</span><span class="o">.</span><span class="n">add_beam</span><span class="p">([</span><span class="n">new_beam</span><span class="p">])</span>
</span><span id="Lattice.merge_degree2_nodes-1590"><a href="#Lattice.merge_degree2_nodes-1590"><span class="linenos">1590</span></a>
</span><span id="Lattice.merge_degree2_nodes-1591"><a href="#Lattice.merge_degree2_nodes-1591"><span class="linenos">1591</span></a>                <span class="n">beams_to_remove</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">])</span>
</span><span id="Lattice.merge_degree2_nodes-1592"><a href="#Lattice.merge_degree2_nodes-1592"><span class="linenos">1592</span></a>                <span class="n">beams_to_add</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_beam</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1593"><a href="#Lattice.merge_degree2_nodes-1593"><span class="linenos">1593</span></a>                <span class="n">points_to_destroy</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1594"><a href="#Lattice.merge_degree2_nodes-1594"><span class="linenos">1594</span></a>
</span><span id="Lattice.merge_degree2_nodes-1595"><a href="#Lattice.merge_degree2_nodes-1595"><span class="linenos">1595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">beams_to_remove</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1596"><a href="#Lattice.merge_degree2_nodes-1596"><span class="linenos">1596</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beams_to_add</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1597"><a href="#Lattice.merge_degree2_nodes-1597"><span class="linenos">1597</span></a>
</span><span id="Lattice.merge_degree2_nodes-1598"><a href="#Lattice.merge_degree2_nodes-1598"><span class="linenos">1598</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points_to_destroy</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1599"><a href="#Lattice.merge_degree2_nodes-1599"><span class="linenos">1599</span></a>                <span class="n">p</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1600"><a href="#Lattice.merge_degree2_nodes-1600"><span class="linenos">1600</span></a>
</span><span id="Lattice.merge_degree2_nodes-1601"><a href="#Lattice.merge_degree2_nodes-1601"><span class="linenos">1601</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1602"><a href="#Lattice.merge_degree2_nodes-1602"><span class="linenos">1602</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1603"><a href="#Lattice.merge_degree2_nodes-1603"><span class="linenos">1603</span></a>
</span><span id="Lattice.merge_degree2_nodes-1604"><a href="#Lattice.merge_degree2_nodes-1604"><span class="linenos">1604</span></a>            <span class="n">merged_this_pass</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merges</span><span class="p">)</span>
</span><span id="Lattice.merge_degree2_nodes-1605"><a href="#Lattice.merge_degree2_nodes-1605"><span class="linenos">1605</span></a>            <span class="n">total_merged</span> <span class="o">+=</span> <span class="n">merged_this_pass</span>
</span><span id="Lattice.merge_degree2_nodes-1606"><a href="#Lattice.merge_degree2_nodes-1606"><span class="linenos">1606</span></a>
</span><span id="Lattice.merge_degree2_nodes-1607"><a href="#Lattice.merge_degree2_nodes-1607"><span class="linenos">1607</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">iterative</span> <span class="ow">or</span> <span class="n">passes</span> <span class="o">&gt;=</span> <span class="n">max_passes</span><span class="p">:</span>
</span><span id="Lattice.merge_degree2_nodes-1608"><a href="#Lattice.merge_degree2_nodes-1608"><span class="linenos">1608</span></a>                <span class="k">break</span>
</span><span id="Lattice.merge_degree2_nodes-1609"><a href="#Lattice.merge_degree2_nodes-1609"><span class="linenos">1609</span></a>
</span><span id="Lattice.merge_degree2_nodes-1610"><a href="#Lattice.merge_degree2_nodes-1610"><span class="linenos">1610</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delete_orphan_points</span><span class="p">()</span>
</span><span id="Lattice.merge_degree2_nodes-1611"><a href="#Lattice.merge_degree2_nodes-1611"><span class="linenos">1611</span></a>
</span><span id="Lattice.merge_degree2_nodes-1612"><a href="#Lattice.merge_degree2_nodes-1612"><span class="linenos">1612</span></a>        <span class="k">return</span> <span class="n">total_merged</span>
</span></pre></div>


            <div class="docstring"><p>Fusion of nodes with exactly 2 connected beams.
The two beams must be colinear (if colinear_only=True) and the node must be between the two beam endpoints.
The two beams are replaced by a single beam connecting the two distant endpoints.</p>

<h2 id="parameters">Parameters:</h2>

<p>colinear_only : bool
    If True, only merge if the two beams are colinear.</p>

<p>radius_strategy : str
    Strategy for determining the radius of the new beam:
    "inherit" (default) - if both beams have the same radius, use it; otherwise use b1's radius.
    "max" - use the maximum radius of the two beams.
    "min" - use the minimum radius of the two beams.
    "avg" - use the average radius of the two beams.</p>

<p>type_strategy : str
    Strategy for determining the type of the new beam:
    "inherit" (default) - if both beams have the same type, use it; otherwise use b1's type.
    "max" - use the maximum type of the two beams.
    "min" - use the minimum type of the two beams.
    "avg" - use the average type of the two beams (rounded).</p>

<p>material_strategy : str
    Strategy for determining the material of the new beam:
    "inherit" (default) - if both beams have the same material, use it; otherwise use b1's material.
    "max" - use the maximum material of the two beams.
    "min" - use the minimum material of the two beams.
    "avg" - use the average material of the two beams (rounded).</p>

<p>iterative : bool
    If True, repeat the merging process until no more merges are possible or max_passes is reached.</p>

<p>max_passes : int
    Maximum number of passes if iterative is True.</p>

<h2 id="returns">Returns:</h2>

<p>total_merged : int
    Total number of nodes merged.</p>
</div>


                            </div>
                            <div id="Lattice.delete_unconnected_beams" class="classattr">
                                        <input id="Lattice.delete_unconnected_beams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;utils&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">delete_unconnected_beams</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">protect_fixed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">protect_loaded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">also_delete_orphan_nodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Lattice.delete_unconnected_beams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.delete_unconnected_beams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.delete_unconnected_beams-1614"><a href="#Lattice.delete_unconnected_beams-1614"><span class="linenos">1614</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;utils&quot;</span><span class="p">)</span>
</span><span id="Lattice.delete_unconnected_beams-1615"><a href="#Lattice.delete_unconnected_beams-1615"><span class="linenos">1615</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.delete_unconnected_beams-1616"><a href="#Lattice.delete_unconnected_beams-1616"><span class="linenos">1616</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_unconnected_beams</span><span class="p">(</span>
</span><span id="Lattice.delete_unconnected_beams-1617"><a href="#Lattice.delete_unconnected_beams-1617"><span class="linenos">1617</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Lattice.delete_unconnected_beams-1618"><a href="#Lattice.delete_unconnected_beams-1618"><span class="linenos">1618</span></a>            <span class="n">protect_fixed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice.delete_unconnected_beams-1619"><a href="#Lattice.delete_unconnected_beams-1619"><span class="linenos">1619</span></a>            <span class="n">protect_loaded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice.delete_unconnected_beams-1620"><a href="#Lattice.delete_unconnected_beams-1620"><span class="linenos">1620</span></a>            <span class="n">also_delete_orphan_nodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Lattice.delete_unconnected_beams-1621"><a href="#Lattice.delete_unconnected_beams-1621"><span class="linenos">1621</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="Lattice.delete_unconnected_beams-1622"><a href="#Lattice.delete_unconnected_beams-1622"><span class="linenos">1622</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.delete_unconnected_beams-1623"><a href="#Lattice.delete_unconnected_beams-1623"><span class="linenos">1623</span></a><span class="sd">        Delete beams that are &quot;leaf&quot; beams, i.e. connected to at least one node of degree 1 or 0.</span>
</span><span id="Lattice.delete_unconnected_beams-1624"><a href="#Lattice.delete_unconnected_beams-1624"><span class="linenos">1624</span></a>
</span><span id="Lattice.delete_unconnected_beams-1625"><a href="#Lattice.delete_unconnected_beams-1625"><span class="linenos">1625</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.delete_unconnected_beams-1626"><a href="#Lattice.delete_unconnected_beams-1626"><span class="linenos">1626</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.delete_unconnected_beams-1627"><a href="#Lattice.delete_unconnected_beams-1627"><span class="linenos">1627</span></a><span class="sd">        protect_fixed: bool</span>
</span><span id="Lattice.delete_unconnected_beams-1628"><a href="#Lattice.delete_unconnected_beams-1628"><span class="linenos">1628</span></a><span class="sd">            If True, do not delete beams connected to fixed nodes.</span>
</span><span id="Lattice.delete_unconnected_beams-1629"><a href="#Lattice.delete_unconnected_beams-1629"><span class="linenos">1629</span></a>
</span><span id="Lattice.delete_unconnected_beams-1630"><a href="#Lattice.delete_unconnected_beams-1630"><span class="linenos">1630</span></a><span class="sd">        protect_loaded: bool</span>
</span><span id="Lattice.delete_unconnected_beams-1631"><a href="#Lattice.delete_unconnected_beams-1631"><span class="linenos">1631</span></a><span class="sd">            If True, do not delete beams connected to loaded nodes.</span>
</span><span id="Lattice.delete_unconnected_beams-1632"><a href="#Lattice.delete_unconnected_beams-1632"><span class="linenos">1632</span></a>
</span><span id="Lattice.delete_unconnected_beams-1633"><a href="#Lattice.delete_unconnected_beams-1633"><span class="linenos">1633</span></a><span class="sd">        also_delete_orphan_nodes: bool</span>
</span><span id="Lattice.delete_unconnected_beams-1634"><a href="#Lattice.delete_unconnected_beams-1634"><span class="linenos">1634</span></a><span class="sd">            If True, delete nodes that become orphaned after beam removal.</span>
</span><span id="Lattice.delete_unconnected_beams-1635"><a href="#Lattice.delete_unconnected_beams-1635"><span class="linenos">1635</span></a>
</span><span id="Lattice.delete_unconnected_beams-1636"><a href="#Lattice.delete_unconnected_beams-1636"><span class="linenos">1636</span></a><span class="sd">        Returns:</span>
</span><span id="Lattice.delete_unconnected_beams-1637"><a href="#Lattice.delete_unconnected_beams-1637"><span class="linenos">1637</span></a><span class="sd">        --------</span>
</span><span id="Lattice.delete_unconnected_beams-1638"><a href="#Lattice.delete_unconnected_beams-1638"><span class="linenos">1638</span></a><span class="sd">        tuple[int, int]</span>
</span><span id="Lattice.delete_unconnected_beams-1639"><a href="#Lattice.delete_unconnected_beams-1639"><span class="linenos">1639</span></a><span class="sd">            Number of beams removed and number of nodes removed.</span>
</span><span id="Lattice.delete_unconnected_beams-1640"><a href="#Lattice.delete_unconnected_beams-1640"><span class="linenos">1640</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.delete_unconnected_beams-1641"><a href="#Lattice.delete_unconnected_beams-1641"><span class="linenos">1641</span></a>        <span class="c1"># Deactivate periodicity to ensure correct connectivity checks</span>
</span><span id="Lattice.delete_unconnected_beams-1642"><a href="#Lattice.delete_unconnected_beams-1642"><span class="linenos">1642</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_periodicity</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Lattice.delete_unconnected_beams-1643"><a href="#Lattice.delete_unconnected_beams-1643"><span class="linenos">1643</span></a>        <span class="c1"># Identify beams to remove</span>
</span><span id="Lattice.delete_unconnected_beams-1644"><a href="#Lattice.delete_unconnected_beams-1644"><span class="linenos">1644</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_connected_beams_for_all_nodes</span><span class="p">()</span>
</span><span id="Lattice.delete_unconnected_beams-1645"><a href="#Lattice.delete_unconnected_beams-1645"><span class="linenos">1645</span></a>
</span><span id="Lattice.delete_unconnected_beams-1646"><a href="#Lattice.delete_unconnected_beams-1646"><span class="linenos">1646</span></a>        <span class="n">to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Lattice.delete_unconnected_beams-1647"><a href="#Lattice.delete_unconnected_beams-1647"><span class="linenos">1647</span></a>
</span><span id="Lattice.delete_unconnected_beams-1648"><a href="#Lattice.delete_unconnected_beams-1648"><span class="linenos">1648</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beams</span><span class="p">):</span>
</span><span id="Lattice.delete_unconnected_beams-1649"><a href="#Lattice.delete_unconnected_beams-1649"><span class="linenos">1649</span></a>            <span class="n">deg1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="Lattice.delete_unconnected_beams-1650"><a href="#Lattice.delete_unconnected_beams-1650"><span class="linenos">1650</span></a>            <span class="n">deg2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">connected_beams</span><span class="p">)</span>
</span><span id="Lattice.delete_unconnected_beams-1651"><a href="#Lattice.delete_unconnected_beams-1651"><span class="linenos">1651</span></a>            <span class="n">is_leaf_bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">deg1</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">deg2</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice.delete_unconnected_beams-1652"><a href="#Lattice.delete_unconnected_beams-1652"><span class="linenos">1652</span></a>
</span><span id="Lattice.delete_unconnected_beams-1653"><a href="#Lattice.delete_unconnected_beams-1653"><span class="linenos">1653</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_leaf_bar</span><span class="p">:</span>
</span><span id="Lattice.delete_unconnected_beams-1654"><a href="#Lattice.delete_unconnected_beams-1654"><span class="linenos">1654</span></a>                <span class="k">continue</span>
</span><span id="Lattice.delete_unconnected_beams-1655"><a href="#Lattice.delete_unconnected_beams-1655"><span class="linenos">1655</span></a>
</span><span id="Lattice.delete_unconnected_beams-1656"><a href="#Lattice.delete_unconnected_beams-1656"><span class="linenos">1656</span></a>
</span><span id="Lattice.delete_unconnected_beams-1657"><a href="#Lattice.delete_unconnected_beams-1657"><span class="linenos">1657</span></a>            <span class="n">p1_fixed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">fixed_DOF</span><span class="p">)</span>
</span><span id="Lattice.delete_unconnected_beams-1658"><a href="#Lattice.delete_unconnected_beams-1658"><span class="linenos">1658</span></a>            <span class="n">p2_fixed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">fixed_DOF</span><span class="p">)</span>
</span><span id="Lattice.delete_unconnected_beams-1659"><a href="#Lattice.delete_unconnected_beams-1659"><span class="linenos">1659</span></a>            <span class="n">p1_load</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">applied_force</span><span class="p">)</span>
</span><span id="Lattice.delete_unconnected_beams-1660"><a href="#Lattice.delete_unconnected_beams-1660"><span class="linenos">1660</span></a>            <span class="n">p2_load</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">applied_force</span><span class="p">)</span>
</span><span id="Lattice.delete_unconnected_beams-1661"><a href="#Lattice.delete_unconnected_beams-1661"><span class="linenos">1661</span></a>
</span><span id="Lattice.delete_unconnected_beams-1662"><a href="#Lattice.delete_unconnected_beams-1662"><span class="linenos">1662</span></a>            <span class="c1"># Protect beams connected to fixed or loaded nodes if specified</span>
</span><span id="Lattice.delete_unconnected_beams-1663"><a href="#Lattice.delete_unconnected_beams-1663"><span class="linenos">1663</span></a>            <span class="k">if</span> <span class="n">protect_fixed</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p1_fixed</span> <span class="ow">or</span> <span class="n">p2_fixed</span><span class="p">):</span>
</span><span id="Lattice.delete_unconnected_beams-1664"><a href="#Lattice.delete_unconnected_beams-1664"><span class="linenos">1664</span></a>                <span class="k">continue</span>
</span><span id="Lattice.delete_unconnected_beams-1665"><a href="#Lattice.delete_unconnected_beams-1665"><span class="linenos">1665</span></a>            <span class="k">if</span> <span class="n">protect_loaded</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p1_load</span> <span class="ow">or</span> <span class="n">p2_load</span><span class="p">):</span>
</span><span id="Lattice.delete_unconnected_beams-1666"><a href="#Lattice.delete_unconnected_beams-1666"><span class="linenos">1666</span></a>                <span class="k">continue</span>
</span><span id="Lattice.delete_unconnected_beams-1667"><a href="#Lattice.delete_unconnected_beams-1667"><span class="linenos">1667</span></a>
</span><span id="Lattice.delete_unconnected_beams-1668"><a href="#Lattice.delete_unconnected_beams-1668"><span class="linenos">1668</span></a>            <span class="n">to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="Lattice.delete_unconnected_beams-1669"><a href="#Lattice.delete_unconnected_beams-1669"><span class="linenos">1669</span></a>
</span><span id="Lattice.delete_unconnected_beams-1670"><a href="#Lattice.delete_unconnected_beams-1670"><span class="linenos">1670</span></a>
</span><span id="Lattice.delete_unconnected_beams-1671"><a href="#Lattice.delete_unconnected_beams-1671"><span class="linenos">1671</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_remove</span><span class="p">:</span>
</span><span id="Lattice.delete_unconnected_beams-1672"><a href="#Lattice.delete_unconnected_beams-1672"><span class="linenos">1672</span></a>            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Lattice.delete_unconnected_beams-1673"><a href="#Lattice.delete_unconnected_beams-1673"><span class="linenos">1673</span></a>
</span><span id="Lattice.delete_unconnected_beams-1674"><a href="#Lattice.delete_unconnected_beams-1674"><span class="linenos">1674</span></a>        <span class="c1"># Remove identified beams from cells</span>
</span><span id="Lattice.delete_unconnected_beams-1675"><a href="#Lattice.delete_unconnected_beams-1675"><span class="linenos">1675</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
</span><span id="Lattice.delete_unconnected_beams-1676"><a href="#Lattice.delete_unconnected_beams-1676"><span class="linenos">1676</span></a>            <span class="n">b</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Lattice.delete_unconnected_beams-1677"><a href="#Lattice.delete_unconnected_beams-1677"><span class="linenos">1677</span></a>
</span><span id="Lattice.delete_unconnected_beams-1678"><a href="#Lattice.delete_unconnected_beams-1678"><span class="linenos">1678</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_nodes_and_beams</span><span class="p">()</span>
</span><span id="Lattice.delete_unconnected_beams-1679"><a href="#Lattice.delete_unconnected_beams-1679"><span class="linenos">1679</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">define_beam_node_index</span><span class="p">()</span>
</span><span id="Lattice.delete_unconnected_beams-1680"><a href="#Lattice.delete_unconnected_beams-1680"><span class="linenos">1680</span></a>
</span><span id="Lattice.delete_unconnected_beams-1681"><a href="#Lattice.delete_unconnected_beams-1681"><span class="linenos">1681</span></a>        <span class="c1"># Delete orphan nodes if specified</span>
</span><span id="Lattice.delete_unconnected_beams-1682"><a href="#Lattice.delete_unconnected_beams-1682"><span class="linenos">1682</span></a>        <span class="n">removed_pts</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Lattice.delete_unconnected_beams-1683"><a href="#Lattice.delete_unconnected_beams-1683"><span class="linenos">1683</span></a>        <span class="k">if</span> <span class="n">also_delete_orphan_nodes</span><span class="p">:</span>
</span><span id="Lattice.delete_unconnected_beams-1684"><a href="#Lattice.delete_unconnected_beams-1684"><span class="linenos">1684</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delete_orphan_points</span><span class="p">()</span>
</span><span id="Lattice.delete_unconnected_beams-1685"><a href="#Lattice.delete_unconnected_beams-1685"><span class="linenos">1685</span></a>
</span><span id="Lattice.delete_unconnected_beams-1686"><a href="#Lattice.delete_unconnected_beams-1686"><span class="linenos">1686</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_remove</span><span class="p">),</span> <span class="n">removed_pts</span>
</span></pre></div>


            <div class="docstring"><p>Delete beams that are "leaf" beams, i.e. connected to at least one node of degree 1 or 0.</p>

<h2 id="parameters">Parameters:</h2>

<p>protect_fixed: bool
    If True, do not delete beams connected to fixed nodes.</p>

<p>protect_loaded: bool
    If True, do not delete beams connected to loaded nodes.</p>

<p>also_delete_orphan_nodes: bool
    If True, delete nodes that become orphaned after beam removal.</p>

<h2 id="returns">Returns:</h2>

<p>tuple[int, int]
    Number of beams removed and number of nodes removed.</p>
</div>


                            </div>
                            <div id="Lattice.generate_mesh_lattice_Gmsh" class="classattr">
                                        <input id="Lattice.generate_mesh_lattice_Gmsh-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;meshing&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">generate_mesh_lattice_Gmsh</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">cut_mesh_at_boundary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">mesh_refinement</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">name_mesh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Lattice&#39;</span>,</span><span class="param">	<span class="n">save_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">save_STL</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">volume_computation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">only_volume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">only_relative_density</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">cell_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Lattice.generate_mesh_lattice_Gmsh-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.generate_mesh_lattice_Gmsh"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.generate_mesh_lattice_Gmsh-1692"><a href="#Lattice.generate_mesh_lattice_Gmsh-1692"><span class="linenos">1692</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;meshing&quot;</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1693"><a href="#Lattice.generate_mesh_lattice_Gmsh-1693"><span class="linenos">1693</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1694"><a href="#Lattice.generate_mesh_lattice_Gmsh-1694"><span class="linenos">1694</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_mesh_lattice_Gmsh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut_mesh_at_boundary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mesh_refinement</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1695"><a href="#Lattice.generate_mesh_lattice_Gmsh-1695"><span class="linenos">1695</span></a>                                   <span class="n">name_mesh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Lattice&quot;</span><span class="p">,</span><span class="n">save_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save_STL</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1696"><a href="#Lattice.generate_mesh_lattice_Gmsh-1696"><span class="linenos">1696</span></a>                                   <span class="n">volume_computation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">only_volume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1697"><a href="#Lattice.generate_mesh_lattice_Gmsh-1697"><span class="linenos">1697</span></a>                                   <span class="n">only_relative_density</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cell_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1698"><a href="#Lattice.generate_mesh_lattice_Gmsh-1698"><span class="linenos">1698</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1699"><a href="#Lattice.generate_mesh_lattice_Gmsh-1699"><span class="linenos">1699</span></a><span class="sd">        Generate a 2D mesh representation of the lattice structure using GMSH.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1700"><a href="#Lattice.generate_mesh_lattice_Gmsh-1700"><span class="linenos">1700</span></a><span class="sd">        Generating 3D mesh for simulation is not currently supported, but will be in the future.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1701"><a href="#Lattice.generate_mesh_lattice_Gmsh-1701"><span class="linenos">1701</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1702"><a href="#Lattice.generate_mesh_lattice_Gmsh-1702"><span class="linenos">1702</span></a><span class="sd">        Parameters:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1703"><a href="#Lattice.generate_mesh_lattice_Gmsh-1703"><span class="linenos">1703</span></a><span class="sd">        -----------</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1704"><a href="#Lattice.generate_mesh_lattice_Gmsh-1704"><span class="linenos">1704</span></a><span class="sd">        cut_mesh_at_boundary: bool</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1705"><a href="#Lattice.generate_mesh_lattice_Gmsh-1705"><span class="linenos">1705</span></a><span class="sd">            If True, the mesh will be cut at the boundary of the lattice.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1706"><a href="#Lattice.generate_mesh_lattice_Gmsh-1706"><span class="linenos">1706</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1707"><a href="#Lattice.generate_mesh_lattice_Gmsh-1707"><span class="linenos">1707</span></a><span class="sd">        mesh_refinement: float</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1708"><a href="#Lattice.generate_mesh_lattice_Gmsh-1708"><span class="linenos">1708</span></a><span class="sd">            Refinement factor for the mesh (higher values lead to finer meshes).</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1709"><a href="#Lattice.generate_mesh_lattice_Gmsh-1709"><span class="linenos">1709</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1710"><a href="#Lattice.generate_mesh_lattice_Gmsh-1710"><span class="linenos">1710</span></a><span class="sd">        name_mesh: str</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1711"><a href="#Lattice.generate_mesh_lattice_Gmsh-1711"><span class="linenos">1711</span></a><span class="sd">            Name of the mesh to be generated.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1712"><a href="#Lattice.generate_mesh_lattice_Gmsh-1712"><span class="linenos">1712</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1713"><a href="#Lattice.generate_mesh_lattice_Gmsh-1713"><span class="linenos">1713</span></a><span class="sd">        save_mesh: bool</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1714"><a href="#Lattice.generate_mesh_lattice_Gmsh-1714"><span class="linenos">1714</span></a><span class="sd">            If True, the mesh will be saved to a file.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1715"><a href="#Lattice.generate_mesh_lattice_Gmsh-1715"><span class="linenos">1715</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1716"><a href="#Lattice.generate_mesh_lattice_Gmsh-1716"><span class="linenos">1716</span></a><span class="sd">        save_STL: bool</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1717"><a href="#Lattice.generate_mesh_lattice_Gmsh-1717"><span class="linenos">1717</span></a><span class="sd">            If True, the mesh will be saved in STL format.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1718"><a href="#Lattice.generate_mesh_lattice_Gmsh-1718"><span class="linenos">1718</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1719"><a href="#Lattice.generate_mesh_lattice_Gmsh-1719"><span class="linenos">1719</span></a><span class="sd">        volume_computation: bool</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1720"><a href="#Lattice.generate_mesh_lattice_Gmsh-1720"><span class="linenos">1720</span></a><span class="sd">            If True, the volume of the mesh will be computed and printed.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1721"><a href="#Lattice.generate_mesh_lattice_Gmsh-1721"><span class="linenos">1721</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1722"><a href="#Lattice.generate_mesh_lattice_Gmsh-1722"><span class="linenos">1722</span></a><span class="sd">        only_volume: bool</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1723"><a href="#Lattice.generate_mesh_lattice_Gmsh-1723"><span class="linenos">1723</span></a><span class="sd">            If True, only the volume of the mesh will be computed and returned.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1724"><a href="#Lattice.generate_mesh_lattice_Gmsh-1724"><span class="linenos">1724</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1725"><a href="#Lattice.generate_mesh_lattice_Gmsh-1725"><span class="linenos">1725</span></a><span class="sd">        only_relative_density: bool</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1726"><a href="#Lattice.generate_mesh_lattice_Gmsh-1726"><span class="linenos">1726</span></a><span class="sd">            If True, only the relative density of the mesh will be computed and returned.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1727"><a href="#Lattice.generate_mesh_lattice_Gmsh-1727"><span class="linenos">1727</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1728"><a href="#Lattice.generate_mesh_lattice_Gmsh-1728"><span class="linenos">1728</span></a><span class="sd">        cell_index: int | None</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1729"><a href="#Lattice.generate_mesh_lattice_Gmsh-1729"><span class="linenos">1729</span></a><span class="sd">            If provided, only the specified cell will be meshed.</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1730"><a href="#Lattice.generate_mesh_lattice_Gmsh-1730"><span class="linenos">1730</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1731"><a href="#Lattice.generate_mesh_lattice_Gmsh-1731"><span class="linenos">1731</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1732"><a href="#Lattice.generate_mesh_lattice_Gmsh-1732"><span class="linenos">1732</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;General.Verbosity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1733"><a href="#Lattice.generate_mesh_lattice_Gmsh-1733"><span class="linenos">1733</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name_mesh</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1734"><a href="#Lattice.generate_mesh_lattice_Gmsh-1734"><span class="linenos">1734</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Geometry.OCCFixDegenerated&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1735"><a href="#Lattice.generate_mesh_lattice_Gmsh-1735"><span class="linenos">1735</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Geometry.OCCFixSmallEdges&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1736"><a href="#Lattice.generate_mesh_lattice_Gmsh-1736"><span class="linenos">1736</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Geometry.OCCFixSmallFaces&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1737"><a href="#Lattice.generate_mesh_lattice_Gmsh-1737"><span class="linenos">1737</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.CharacteristicLengthFromCurvature&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1738"><a href="#Lattice.generate_mesh_lattice_Gmsh-1738"><span class="linenos">1738</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MinimumCircleNodes&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>  <span class="c1"># help meshing thin cylinders</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1739"><a href="#Lattice.generate_mesh_lattice_Gmsh-1739"><span class="linenos">1739</span></a>        <span class="n">N_CIRC_TARGET</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">mesh_refinement</span>  <span class="c1"># ~elements around the circumference (same for all radii)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1740"><a href="#Lattice.generate_mesh_lattice_Gmsh-1740"><span class="linenos">1740</span></a>        <span class="n">N_AXIAL_TARGET</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">mesh_refinement</span>  <span class="c1"># ~elements along each beam axis (same for all beam lengths)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1741"><a href="#Lattice.generate_mesh_lattice_Gmsh-1741"><span class="linenos">1741</span></a>        <span class="n">mesh_size_max</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1742"><a href="#Lattice.generate_mesh_lattice_Gmsh-1742"><span class="linenos">1742</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MinimumCircleNodes&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">N_CIRC_TARGET</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1743"><a href="#Lattice.generate_mesh_lattice_Gmsh-1743"><span class="linenos">1743</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1744"><a href="#Lattice.generate_mesh_lattice_Gmsh-1744"><span class="linenos">1744</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Dimension of the mesh</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1745"><a href="#Lattice.generate_mesh_lattice_Gmsh-1745"><span class="linenos">1745</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1746"><a href="#Lattice.generate_mesh_lattice_Gmsh-1746"><span class="linenos">1746</span></a>        <span class="c1"># Find beams to mesh</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1747"><a href="#Lattice.generate_mesh_lattice_Gmsh-1747"><span class="linenos">1747</span></a>        <span class="k">if</span> <span class="n">cell_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1748"><a href="#Lattice.generate_mesh_lattice_Gmsh-1748"><span class="linenos">1748</span></a>            <span class="k">if</span> <span class="n">cell_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cell_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">):</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1749"><a href="#Lattice.generate_mesh_lattice_Gmsh-1749"><span class="linenos">1749</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid cell index.&quot;</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1750"><a href="#Lattice.generate_mesh_lattice_Gmsh-1750"><span class="linenos">1750</span></a>            <span class="n">beams_to_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span><span class="o">.</span><span class="n">beams_cell</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1751"><a href="#Lattice.generate_mesh_lattice_Gmsh-1751"><span class="linenos">1751</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1752"><a href="#Lattice.generate_mesh_lattice_Gmsh-1752"><span class="linenos">1752</span></a>            <span class="n">beams_to_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beams</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1753"><a href="#Lattice.generate_mesh_lattice_Gmsh-1753"><span class="linenos">1753</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1754"><a href="#Lattice.generate_mesh_lattice_Gmsh-1754"><span class="linenos">1754</span></a>        <span class="n">all_tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1755"><a href="#Lattice.generate_mesh_lattice_Gmsh-1755"><span class="linenos">1755</span></a>        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1756"><a href="#Lattice.generate_mesh_lattice_Gmsh-1756"><span class="linenos">1756</span></a>        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1757"><a href="#Lattice.generate_mesh_lattice_Gmsh-1757"><span class="linenos">1757</span></a>        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams_to_mesh</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1758"><a href="#Lattice.generate_mesh_lattice_Gmsh-1758"><span class="linenos">1758</span></a>            <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">point1</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1759"><a href="#Lattice.generate_mesh_lattice_Gmsh-1759"><span class="linenos">1759</span></a>            <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">point2</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1760"><a href="#Lattice.generate_mesh_lattice_Gmsh-1760"><span class="linenos">1760</span></a>            <span class="n">direction</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1761"><a href="#Lattice.generate_mesh_lattice_Gmsh-1761"><span class="linenos">1761</span></a>            <span class="c1"># Use initial radius if defined</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1762"><a href="#Lattice.generate_mesh_lattice_Gmsh-1762"><span class="linenos">1762</span></a>            <span class="n">radius</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">initial_radius</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="s2">&quot;initial_radius&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beam</span><span class="o">.</span><span class="n">radius</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1763"><a href="#Lattice.generate_mesh_lattice_Gmsh-1763"><span class="linenos">1763</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1764"><a href="#Lattice.generate_mesh_lattice_Gmsh-1764"><span class="linenos">1764</span></a>            <span class="n">min_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">mesh_size_max</span><span class="p">)</span>  <span class="c1"># avoid too-short beams wrt mesh size</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1765"><a href="#Lattice.generate_mesh_lattice_Gmsh-1765"><span class="linenos">1765</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_len</span> <span class="ow">or</span> <span class="n">radius</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1766"><a href="#Lattice.generate_mesh_lattice_Gmsh-1766"><span class="linenos">1766</span></a>                <span class="k">continue</span>  <span class="c1"># skip near-zero length or non-positive radius</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1767"><a href="#Lattice.generate_mesh_lattice_Gmsh-1767"><span class="linenos">1767</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1768"><a href="#Lattice.generate_mesh_lattice_Gmsh-1768"><span class="linenos">1768</span></a>            <span class="n">tag</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCylinder</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1769"><a href="#Lattice.generate_mesh_lattice_Gmsh-1769"><span class="linenos">1769</span></a>            <span class="n">all_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1770"><a href="#Lattice.generate_mesh_lattice_Gmsh-1770"><span class="linenos">1770</span></a>            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1771"><a href="#Lattice.generate_mesh_lattice_Gmsh-1771"><span class="linenos">1771</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1772"><a href="#Lattice.generate_mesh_lattice_Gmsh-1772"><span class="linenos">1772</span></a>            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">p2</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span> <span class="n">L</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1773"><a href="#Lattice.generate_mesh_lattice_Gmsh-1773"><span class="linenos">1773</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1774"><a href="#Lattice.generate_mesh_lattice_Gmsh-1774"><span class="linenos">1774</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1775"><a href="#Lattice.generate_mesh_lattice_Gmsh-1775"><span class="linenos">1775</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1776"><a href="#Lattice.generate_mesh_lattice_Gmsh-1776"><span class="linenos">1776</span></a>        <span class="c1"># Merge all beams into a single entity</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1777"><a href="#Lattice.generate_mesh_lattice_Gmsh-1777"><span class="linenos">1777</span></a>        <span class="n">beam_entities</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">]</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1778"><a href="#Lattice.generate_mesh_lattice_Gmsh-1778"><span class="linenos">1778</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1779"><a href="#Lattice.generate_mesh_lattice_Gmsh-1779"><span class="linenos">1779</span></a>            <span class="n">lattice</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">fragment</span><span class="p">(</span><span class="n">beam_entities</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1780"><a href="#Lattice.generate_mesh_lattice_Gmsh-1780"><span class="linenos">1780</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1781"><a href="#Lattice.generate_mesh_lattice_Gmsh-1781"><span class="linenos">1781</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fragmentation failed:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1782"><a href="#Lattice.generate_mesh_lattice_Gmsh-1782"><span class="linenos">1782</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1783"><a href="#Lattice.generate_mesh_lattice_Gmsh-1783"><span class="linenos">1783</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1784"><a href="#Lattice.generate_mesh_lattice_Gmsh-1784"><span class="linenos">1784</span></a>        <span class="k">if</span> <span class="n">cut_mesh_at_boundary</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1785"><a href="#Lattice.generate_mesh_lattice_Gmsh-1785"><span class="linenos">1785</span></a>            <span class="c1"># Bounding box definition</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1786"><a href="#Lattice.generate_mesh_lattice_Gmsh-1786"><span class="linenos">1786</span></a>            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1787"><a href="#Lattice.generate_mesh_lattice_Gmsh-1787"><span class="linenos">1787</span></a>            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">-</span> <span class="n">z0</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1788"><a href="#Lattice.generate_mesh_lattice_Gmsh-1788"><span class="linenos">1788</span></a>            <span class="n">box</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addBox</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1789"><a href="#Lattice.generate_mesh_lattice_Gmsh-1789"><span class="linenos">1789</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1790"><a href="#Lattice.generate_mesh_lattice_Gmsh-1790"><span class="linenos">1790</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">lattice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[(</span><span class="n">dim</span><span class="p">,</span> <span class="n">box</span><span class="p">)],</span> <span class="n">removeObject</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">removeTool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1791"><a href="#Lattice.generate_mesh_lattice_Gmsh-1791"><span class="linenos">1791</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1792"><a href="#Lattice.generate_mesh_lattice_Gmsh-1792"><span class="linenos">1792</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intersection failed:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1793"><a href="#Lattice.generate_mesh_lattice_Gmsh-1793"><span class="linenos">1793</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1794"><a href="#Lattice.generate_mesh_lattice_Gmsh-1794"><span class="linenos">1794</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1795"><a href="#Lattice.generate_mesh_lattice_Gmsh-1795"><span class="linenos">1795</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1796"><a href="#Lattice.generate_mesh_lattice_Gmsh-1796"><span class="linenos">1796</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1797"><a href="#Lattice.generate_mesh_lattice_Gmsh-1797"><span class="linenos">1797</span></a>        <span class="k">if</span> <span class="n">only_relative_density</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1798"><a href="#Lattice.generate_mesh_lattice_Gmsh-1798"><span class="linenos">1798</span></a>            <span class="n">relative_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relative_density_mesh</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1799"><a href="#Lattice.generate_mesh_lattice_Gmsh-1799"><span class="linenos">1799</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1800"><a href="#Lattice.generate_mesh_lattice_Gmsh-1800"><span class="linenos">1800</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1801"><a href="#Lattice.generate_mesh_lattice_Gmsh-1801"><span class="linenos">1801</span></a>            <span class="k">return</span> <span class="n">relative_density</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1802"><a href="#Lattice.generate_mesh_lattice_Gmsh-1802"><span class="linenos">1802</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1803"><a href="#Lattice.generate_mesh_lattice_Gmsh-1803"><span class="linenos">1803</span></a>        <span class="n">total_volume</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1804"><a href="#Lattice.generate_mesh_lattice_Gmsh-1804"><span class="linenos">1804</span></a>        <span class="k">if</span> <span class="n">volume_computation</span> <span class="ow">or</span> <span class="n">only_volume</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1805"><a href="#Lattice.generate_mesh_lattice_Gmsh-1805"><span class="linenos">1805</span></a>            <span class="n">total_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume_mesh</span><span class="p">(</span><span class="n">synchronize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1806"><a href="#Lattice.generate_mesh_lattice_Gmsh-1806"><span class="linenos">1806</span></a>            <span class="k">if</span> <span class="n">only_volume</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1807"><a href="#Lattice.generate_mesh_lattice_Gmsh-1807"><span class="linenos">1807</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1808"><a href="#Lattice.generate_mesh_lattice_Gmsh-1808"><span class="linenos">1808</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1809"><a href="#Lattice.generate_mesh_lattice_Gmsh-1809"><span class="linenos">1809</span></a>                <span class="k">return</span> <span class="n">total_volume</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1810"><a href="#Lattice.generate_mesh_lattice_Gmsh-1810"><span class="linenos">1810</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1811"><a href="#Lattice.generate_mesh_lattice_Gmsh-1811"><span class="linenos">1811</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1812"><a href="#Lattice.generate_mesh_lattice_Gmsh-1812"><span class="linenos">1812</span></a>        <span class="c1"># Define mesh size</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1813"><a href="#Lattice.generate_mesh_lattice_Gmsh-1813"><span class="linenos">1813</span></a>        <span class="n">pts</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1814"><a href="#Lattice.generate_mesh_lattice_Gmsh-1814"><span class="linenos">1814</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1815"><a href="#Lattice.generate_mesh_lattice_Gmsh-1815"><span class="linenos">1815</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_proj_param_and_dist</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1816"><a href="#Lattice.generate_mesh_lattice_Gmsh-1816"><span class="linenos">1816</span></a>            <span class="n">AB</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">A</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1817"><a href="#Lattice.generate_mesh_lattice_Gmsh-1817"><span class="linenos">1817</span></a>            <span class="n">denom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">AB</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1818"><a href="#Lattice.generate_mesh_lattice_Gmsh-1818"><span class="linenos">1818</span></a>            <span class="k">if</span> <span class="n">denom</span> <span class="o">&lt;=</span> <span class="mf">1e-30</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1819"><a href="#Lattice.generate_mesh_lattice_Gmsh-1819"><span class="linenos">1819</span></a>                <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">A</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1820"><a href="#Lattice.generate_mesh_lattice_Gmsh-1820"><span class="linenos">1820</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">A</span><span class="p">,</span> <span class="n">AB</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1821"><a href="#Lattice.generate_mesh_lattice_Gmsh-1821"><span class="linenos">1821</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">t</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1822"><a href="#Lattice.generate_mesh_lattice_Gmsh-1822"><span class="linenos">1822</span></a>            <span class="n">Q</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">AB</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1823"><a href="#Lattice.generate_mesh_lattice_Gmsh-1823"><span class="linenos">1823</span></a>            <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">Q</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1824"><a href="#Lattice.generate_mesh_lattice_Gmsh-1824"><span class="linenos">1824</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1825"><a href="#Lattice.generate_mesh_lattice_Gmsh-1825"><span class="linenos">1825</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1826"><a href="#Lattice.generate_mesh_lattice_Gmsh-1826"><span class="linenos">1826</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getCenterOfMass</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1827"><a href="#Lattice.generate_mesh_lattice_Gmsh-1827"><span class="linenos">1827</span></a>            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1828"><a href="#Lattice.generate_mesh_lattice_Gmsh-1828"><span class="linenos">1828</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1829"><a href="#Lattice.generate_mesh_lattice_Gmsh-1829"><span class="linenos">1829</span></a>            <span class="c1"># find nearest beam (by radial distance to axis)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1830"><a href="#Lattice.generate_mesh_lattice_Gmsh-1830"><span class="linenos">1830</span></a>            <span class="n">dmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1831"><a href="#Lattice.generate_mesh_lattice_Gmsh-1831"><span class="linenos">1831</span></a>            <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (r, L)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1832"><a href="#Lattice.generate_mesh_lattice_Gmsh-1832"><span class="linenos">1832</span></a>            <span class="k">for</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1833"><a href="#Lattice.generate_mesh_lattice_Gmsh-1833"><span class="linenos">1833</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">_proj_param_and_dist</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1834"><a href="#Lattice.generate_mesh_lattice_Gmsh-1834"><span class="linenos">1834</span></a>                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">dmin</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1835"><a href="#Lattice.generate_mesh_lattice_Gmsh-1835"><span class="linenos">1835</span></a>                    <span class="n">dmin</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1836"><a href="#Lattice.generate_mesh_lattice_Gmsh-1836"><span class="linenos">1836</span></a>                    <span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1837"><a href="#Lattice.generate_mesh_lattice_Gmsh-1837"><span class="linenos">1837</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1838"><a href="#Lattice.generate_mesh_lattice_Gmsh-1838"><span class="linenos">1838</span></a>            <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1839"><a href="#Lattice.generate_mesh_lattice_Gmsh-1839"><span class="linenos">1839</span></a>                <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt</span><span class="p">)],</span> <span class="nb">float</span><span class="p">(</span><span class="n">mesh_size_max</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1840"><a href="#Lattice.generate_mesh_lattice_Gmsh-1840"><span class="linenos">1840</span></a>                <span class="k">continue</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1841"><a href="#Lattice.generate_mesh_lattice_Gmsh-1841"><span class="linenos">1841</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1842"><a href="#Lattice.generate_mesh_lattice_Gmsh-1842"><span class="linenos">1842</span></a>            <span class="n">rnear</span><span class="p">,</span> <span class="n">Lbeam</span> <span class="o">=</span> <span class="n">best</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1843"><a href="#Lattice.generate_mesh_lattice_Gmsh-1843"><span class="linenos">1843</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1844"><a href="#Lattice.generate_mesh_lattice_Gmsh-1844"><span class="linenos">1844</span></a>            <span class="c1"># target sizes for constant element counts:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1845"><a href="#Lattice.generate_mesh_lattice_Gmsh-1845"><span class="linenos">1845</span></a>            <span class="c1"># - around circumference: h_circ ‚âà 2œÄr / N_CIRC_TARGET</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1846"><a href="#Lattice.generate_mesh_lattice_Gmsh-1846"><span class="linenos">1846</span></a>            <span class="c1"># - along axis:          h_ax   ‚âà L / N_AXIAL_TARGET</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1847"><a href="#Lattice.generate_mesh_lattice_Gmsh-1847"><span class="linenos">1847</span></a>            <span class="n">h_circ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rnear</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_CIRC_TARGET</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1848"><a href="#Lattice.generate_mesh_lattice_Gmsh-1848"><span class="linenos">1848</span></a>            <span class="n">h_ax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Lbeam</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_AXIAL_TARGET</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1849"><a href="#Lattice.generate_mesh_lattice_Gmsh-1849"><span class="linenos">1849</span></a>            <span class="n">h_base</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">h_circ</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">))</span>  <span class="c1"># respect both targets, avoid zero</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1850"><a href="#Lattice.generate_mesh_lattice_Gmsh-1850"><span class="linenos">1850</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1851"><a href="#Lattice.generate_mesh_lattice_Gmsh-1851"><span class="linenos">1851</span></a>            <span class="c1"># allow growth away from the beam (outside ~3r ‚Üí up to mesh_size)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1852"><a href="#Lattice.generate_mesh_lattice_Gmsh-1852"><span class="linenos">1852</span></a>            <span class="k">if</span> <span class="n">dmin</span> <span class="o">&lt;=</span> <span class="n">rnear</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1853"><a href="#Lattice.generate_mesh_lattice_Gmsh-1853"><span class="linenos">1853</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="n">h_base</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1854"><a href="#Lattice.generate_mesh_lattice_Gmsh-1854"><span class="linenos">1854</span></a>            <span class="k">elif</span> <span class="n">dmin</span> <span class="o">&gt;=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">rnear</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1855"><a href="#Lattice.generate_mesh_lattice_Gmsh-1855"><span class="linenos">1855</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mesh_size_max</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1856"><a href="#Lattice.generate_mesh_lattice_Gmsh-1856"><span class="linenos">1856</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1857"><a href="#Lattice.generate_mesh_lattice_Gmsh-1857"><span class="linenos">1857</span></a>                <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmin</span> <span class="o">-</span> <span class="n">rnear</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">rnear</span><span class="p">)</span>  <span class="c1"># linear ramp between r and 3r</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1858"><a href="#Lattice.generate_mesh_lattice_Gmsh-1858"><span class="linenos">1858</span></a>                <span class="n">h</span> <span class="o">=</span> <span class="n">h_base</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mesh_size_max</span><span class="p">)</span> <span class="o">-</span> <span class="n">h_base</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1859"><a href="#Lattice.generate_mesh_lattice_Gmsh-1859"><span class="linenos">1859</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1860"><a href="#Lattice.generate_mesh_lattice_Gmsh-1860"><span class="linenos">1860</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pt</span><span class="p">)],</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1861"><a href="#Lattice.generate_mesh_lattice_Gmsh-1861"><span class="linenos">1861</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1862"><a href="#Lattice.generate_mesh_lattice_Gmsh-1862"><span class="linenos">1862</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1863"><a href="#Lattice.generate_mesh_lattice_Gmsh-1863"><span class="linenos">1863</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1864"><a href="#Lattice.generate_mesh_lattice_Gmsh-1864"><span class="linenos">1864</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1865"><a href="#Lattice.generate_mesh_lattice_Gmsh-1865"><span class="linenos">1865</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1866"><a href="#Lattice.generate_mesh_lattice_Gmsh-1866"><span class="linenos">1866</span></a>        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;outputs&quot;</span> <span class="o">/</span> <span class="s2">&quot;mesh_file&quot;</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1867"><a href="#Lattice.generate_mesh_lattice_Gmsh-1867"><span class="linenos">1867</span></a>        <span class="k">if</span> <span class="n">save_mesh</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1868"><a href="#Lattice.generate_mesh_lattice_Gmsh-1868"><span class="linenos">1868</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_mesh</span><span class="si">}</span><span class="s2">.msh&quot;</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1869"><a href="#Lattice.generate_mesh_lattice_Gmsh-1869"><span class="linenos">1869</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1870"><a href="#Lattice.generate_mesh_lattice_Gmsh-1870"><span class="linenos">1870</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mesh_file saved at &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1871"><a href="#Lattice.generate_mesh_lattice_Gmsh-1871"><span class="linenos">1871</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1872"><a href="#Lattice.generate_mesh_lattice_Gmsh-1872"><span class="linenos">1872</span></a>        <span class="k">if</span> <span class="n">save_STL</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1873"><a href="#Lattice.generate_mesh_lattice_Gmsh-1873"><span class="linenos">1873</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">project_root</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_mesh</span><span class="si">}</span><span class="s2">.stl&quot;</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1874"><a href="#Lattice.generate_mesh_lattice_Gmsh-1874"><span class="linenos">1874</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1875"><a href="#Lattice.generate_mesh_lattice_Gmsh-1875"><span class="linenos">1875</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mesh_file saved at &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1876"><a href="#Lattice.generate_mesh_lattice_Gmsh-1876"><span class="linenos">1876</span></a>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1877"><a href="#Lattice.generate_mesh_lattice_Gmsh-1877"><span class="linenos">1877</span></a>        <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1878"><a href="#Lattice.generate_mesh_lattice_Gmsh-1878"><span class="linenos">1878</span></a>        <span class="k">if</span> <span class="n">volume_computation</span><span class="p">:</span>
</span><span id="Lattice.generate_mesh_lattice_Gmsh-1879"><a href="#Lattice.generate_mesh_lattice_Gmsh-1879"><span class="linenos">1879</span></a>            <span class="k">return</span> <span class="n">total_volume</span>
</span></pre></div>


            <div class="docstring"><p>Generate a 2D mesh representation of the lattice structure using GMSH.
Generating 3D mesh for simulation is not currently supported, but will be in the future.</p>

<h2 id="parameters">Parameters:</h2>

<p>cut_mesh_at_boundary: bool
    If True, the mesh will be cut at the boundary of the lattice.</p>

<p>mesh_refinement: float
    Refinement factor for the mesh (higher values lead to finer meshes).</p>

<p>name_mesh: str
    Name of the mesh to be generated.</p>

<p>save_mesh: bool
    If True, the mesh will be saved to a file.</p>

<p>save_STL: bool
    If True, the mesh will be saved in STL format.</p>

<p>volume_computation: bool
    If True, the volume of the mesh will be computed and printed.</p>

<p>only_volume: bool
    If True, only the volume of the mesh will be computed and returned.</p>

<p>only_relative_density: bool
    If True, only the relative density of the mesh will be computed and returned.</p>

<p>cell_index: int | None
    If provided, only the specified cell will be meshed.</p>
</div>


                            </div>
                            <div id="Lattice.get_volume_mesh" class="classattr">
                                        <input id="Lattice.get_volume_mesh-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;meshing&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_volume_mesh</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">entities_3d</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">synchronize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">return_details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_volume_mesh-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_volume_mesh"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_volume_mesh-1881"><a href="#Lattice.get_volume_mesh-1881"><span class="linenos">1881</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;meshing&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_volume_mesh-1882"><a href="#Lattice.get_volume_mesh-1882"><span class="linenos">1882</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_volume_mesh-1883"><a href="#Lattice.get_volume_mesh-1883"><span class="linenos">1883</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_volume_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entities_3d</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">synchronize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Lattice.get_volume_mesh-1884"><a href="#Lattice.get_volume_mesh-1884"><span class="linenos">1884</span></a>                        <span class="n">return_details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1885"><a href="#Lattice.get_volume_mesh-1885"><span class="linenos">1885</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_volume_mesh-1886"><a href="#Lattice.get_volume_mesh-1886"><span class="linenos">1886</span></a><span class="sd">        Compute the exact CAD volume (OCC &#39;mass&#39; with unit density) of the current model</span>
</span><span id="Lattice.get_volume_mesh-1887"><a href="#Lattice.get_volume_mesh-1887"><span class="linenos">1887</span></a><span class="sd">        without requiring any meshing.</span>
</span><span id="Lattice.get_volume_mesh-1888"><a href="#Lattice.get_volume_mesh-1888"><span class="linenos">1888</span></a>
</span><span id="Lattice.get_volume_mesh-1889"><a href="#Lattice.get_volume_mesh-1889"><span class="linenos">1889</span></a><span class="sd">        Parameters</span>
</span><span id="Lattice.get_volume_mesh-1890"><a href="#Lattice.get_volume_mesh-1890"><span class="linenos">1890</span></a><span class="sd">        ----------</span>
</span><span id="Lattice.get_volume_mesh-1891"><a href="#Lattice.get_volume_mesh-1891"><span class="linenos">1891</span></a><span class="sd">        entities_3d : list[(int,int)] | None</span>
</span><span id="Lattice.get_volume_mesh-1892"><a href="#Lattice.get_volume_mesh-1892"><span class="linenos">1892</span></a><span class="sd">            Optional list of 3D OCC entities (pairs (dim=3, tag)). If None, all 3D</span>
</span><span id="Lattice.get_volume_mesh-1893"><a href="#Lattice.get_volume_mesh-1893"><span class="linenos">1893</span></a><span class="sd">            entities in the current model are used.</span>
</span><span id="Lattice.get_volume_mesh-1894"><a href="#Lattice.get_volume_mesh-1894"><span class="linenos">1894</span></a>
</span><span id="Lattice.get_volume_mesh-1895"><a href="#Lattice.get_volume_mesh-1895"><span class="linenos">1895</span></a><span class="sd">        synchronize : bool</span>
</span><span id="Lattice.get_volume_mesh-1896"><a href="#Lattice.get_volume_mesh-1896"><span class="linenos">1896</span></a><span class="sd">            If True, call gmsh.model.occ.synchronize() before querying mass properties.</span>
</span><span id="Lattice.get_volume_mesh-1897"><a href="#Lattice.get_volume_mesh-1897"><span class="linenos">1897</span></a><span class="sd">            Set to False only if you&#39;ve already synchronized after your boolean ops.</span>
</span><span id="Lattice.get_volume_mesh-1898"><a href="#Lattice.get_volume_mesh-1898"><span class="linenos">1898</span></a>
</span><span id="Lattice.get_volume_mesh-1899"><a href="#Lattice.get_volume_mesh-1899"><span class="linenos">1899</span></a><span class="sd">        return_details : bool</span>
</span><span id="Lattice.get_volume_mesh-1900"><a href="#Lattice.get_volume_mesh-1900"><span class="linenos">1900</span></a><span class="sd">            If True, return a dict with &#39;total&#39; and &#39;per_entity&#39; (list of (tag, volume)).</span>
</span><span id="Lattice.get_volume_mesh-1901"><a href="#Lattice.get_volume_mesh-1901"><span class="linenos">1901</span></a>
</span><span id="Lattice.get_volume_mesh-1902"><a href="#Lattice.get_volume_mesh-1902"><span class="linenos">1902</span></a><span class="sd">        Returns</span>
</span><span id="Lattice.get_volume_mesh-1903"><a href="#Lattice.get_volume_mesh-1903"><span class="linenos">1903</span></a><span class="sd">        -------</span>
</span><span id="Lattice.get_volume_mesh-1904"><a href="#Lattice.get_volume_mesh-1904"><span class="linenos">1904</span></a><span class="sd">        float | dict</span>
</span><span id="Lattice.get_volume_mesh-1905"><a href="#Lattice.get_volume_mesh-1905"><span class="linenos">1905</span></a><span class="sd">            Total volume if return_details is False, else a dict:</span>
</span><span id="Lattice.get_volume_mesh-1906"><a href="#Lattice.get_volume_mesh-1906"><span class="linenos">1906</span></a><span class="sd">            {&#39;total&#39;: float, &#39;per_entity&#39;: [(tag:int, volume:float), ...]}</span>
</span><span id="Lattice.get_volume_mesh-1907"><a href="#Lattice.get_volume_mesh-1907"><span class="linenos">1907</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_volume_mesh-1908"><a href="#Lattice.get_volume_mesh-1908"><span class="linenos">1908</span></a>        <span class="k">if</span> <span class="n">synchronize</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1909"><a href="#Lattice.get_volume_mesh-1909"><span class="linenos">1909</span></a>            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
</span><span id="Lattice.get_volume_mesh-1910"><a href="#Lattice.get_volume_mesh-1910"><span class="linenos">1910</span></a>
</span><span id="Lattice.get_volume_mesh-1911"><a href="#Lattice.get_volume_mesh-1911"><span class="linenos">1911</span></a>        <span class="c1"># Default: all 3D solids present in the model</span>
</span><span id="Lattice.get_volume_mesh-1912"><a href="#Lattice.get_volume_mesh-1912"><span class="linenos">1912</span></a>        <span class="k">if</span> <span class="n">entities_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1913"><a href="#Lattice.get_volume_mesh-1913"><span class="linenos">1913</span></a>            <span class="n">entities_3d</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Lattice.get_volume_mesh-1914"><a href="#Lattice.get_volume_mesh-1914"><span class="linenos">1914</span></a>
</span><span id="Lattice.get_volume_mesh-1915"><a href="#Lattice.get_volume_mesh-1915"><span class="linenos">1915</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Lattice.get_volume_mesh-1916"><a href="#Lattice.get_volume_mesh-1916"><span class="linenos">1916</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Lattice.get_volume_mesh-1917"><a href="#Lattice.get_volume_mesh-1917"><span class="linenos">1917</span></a>
</span><span id="Lattice.get_volume_mesh-1918"><a href="#Lattice.get_volume_mesh-1918"><span class="linenos">1918</span></a>        <span class="c1"># Guard against empty list</span>
</span><span id="Lattice.get_volume_mesh-1919"><a href="#Lattice.get_volume_mesh-1919"><span class="linenos">1919</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">entities_3d</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1920"><a href="#Lattice.get_volume_mesh-1920"><span class="linenos">1920</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1921"><a href="#Lattice.get_volume_mesh-1921"><span class="linenos">1921</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_volume_mesh: no 3D entities found; volume = 0.0&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_volume_mesh-1922"><a href="#Lattice.get_volume_mesh-1922"><span class="linenos">1922</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;per_entity&#39;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">if</span> <span class="n">return_details</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="Lattice.get_volume_mesh-1923"><a href="#Lattice.get_volume_mesh-1923"><span class="linenos">1923</span></a>
</span><span id="Lattice.get_volume_mesh-1924"><a href="#Lattice.get_volume_mesh-1924"><span class="linenos">1924</span></a>        <span class="c1"># Sum exact OCC &#39;mass&#39; (density=1 =&gt; mass == volume)</span>
</span><span id="Lattice.get_volume_mesh-1925"><a href="#Lattice.get_volume_mesh-1925"><span class="linenos">1925</span></a>        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">entities_3d</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1926"><a href="#Lattice.get_volume_mesh-1926"><span class="linenos">1926</span></a>            <span class="c1"># Defensive: ensure correct dimension</span>
</span><span id="Lattice.get_volume_mesh-1927"><a href="#Lattice.get_volume_mesh-1927"><span class="linenos">1927</span></a>            <span class="k">if</span> <span class="n">dim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1928"><a href="#Lattice.get_volume_mesh-1928"><span class="linenos">1928</span></a>                <span class="k">continue</span>
</span><span id="Lattice.get_volume_mesh-1929"><a href="#Lattice.get_volume_mesh-1929"><span class="linenos">1929</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getMass</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
</span><span id="Lattice.get_volume_mesh-1930"><a href="#Lattice.get_volume_mesh-1930"><span class="linenos">1930</span></a>            <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
</span><span id="Lattice.get_volume_mesh-1931"><a href="#Lattice.get_volume_mesh-1931"><span class="linenos">1931</span></a>            <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1932"><a href="#Lattice.get_volume_mesh-1932"><span class="linenos">1932</span></a>                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tag</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</span><span id="Lattice.get_volume_mesh-1933"><a href="#Lattice.get_volume_mesh-1933"><span class="linenos">1933</span></a>
</span><span id="Lattice.get_volume_mesh-1934"><a href="#Lattice.get_volume_mesh-1934"><span class="linenos">1934</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1935"><a href="#Lattice.get_volume_mesh-1935"><span class="linenos">1935</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total volume: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_volume_mesh-1936"><a href="#Lattice.get_volume_mesh-1936"><span class="linenos">1936</span></a>
</span><span id="Lattice.get_volume_mesh-1937"><a href="#Lattice.get_volume_mesh-1937"><span class="linenos">1937</span></a>        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
</span><span id="Lattice.get_volume_mesh-1938"><a href="#Lattice.get_volume_mesh-1938"><span class="linenos">1938</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span> <span class="s1">&#39;per_entity&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">}</span>
</span><span id="Lattice.get_volume_mesh-1939"><a href="#Lattice.get_volume_mesh-1939"><span class="linenos">1939</span></a>        <span class="k">return</span> <span class="n">total</span>
</span></pre></div>


            <div class="docstring"><p>Compute the exact CAD volume (OCC 'mass' with unit density) of the current model
without requiring any meshing.</p>

<h2 id="parameters">Parameters</h2>

<p>entities_3d : list[(int,int)] | None
    Optional list of 3D OCC entities (pairs (dim=3, tag)). If None, all 3D
    entities in the current model are used.</p>

<p>synchronize : bool
    If True, call gmsh.model.occ.synchronize() before querying mass properties.
    Set to False only if you've already synchronized after your boolean ops.</p>

<p>return_details : bool
    If True, return a dict with 'total' and 'per_entity' (list of (tag, volume)).</p>

<h2 id="returns">Returns</h2>

<p>float | dict
    Total volume if return_details is False, else a dict:
    {'total': float, 'per_entity': [(tag:int, volume:float), ...]}</p>
</div>


                            </div>
                            <div id="Lattice.get_relative_density_mesh" class="classattr">
                                        <input id="Lattice.get_relative_density_mesh-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-timing.category">@timing.category(&#39;meshing&#39;)</div>
        <div class="decorator decorator-timing.timeit">@timing.timeit</div>

        <span class="def">def</span>
        <span class="name">get_relative_density_mesh</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">solids_3d</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">domain_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Lattice.get_relative_density_mesh-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Lattice.get_relative_density_mesh"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Lattice.get_relative_density_mesh-1941"><a href="#Lattice.get_relative_density_mesh-1941"><span class="linenos">1941</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="s2">&quot;meshing&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_relative_density_mesh-1942"><a href="#Lattice.get_relative_density_mesh-1942"><span class="linenos">1942</span></a>    <span class="nd">@timing</span><span class="o">.</span><span class="n">timeit</span>
</span><span id="Lattice.get_relative_density_mesh-1943"><a href="#Lattice.get_relative_density_mesh-1943"><span class="linenos">1943</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_density_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solids_3d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">domain_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Lattice.get_relative_density_mesh-1944"><a href="#Lattice.get_relative_density_mesh-1944"><span class="linenos">1944</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Lattice.get_relative_density_mesh-1945"><a href="#Lattice.get_relative_density_mesh-1945"><span class="linenos">1945</span></a><span class="sd">        Compute relative density = V_solid / V_domain using exact CAD volumes.</span>
</span><span id="Lattice.get_relative_density_mesh-1946"><a href="#Lattice.get_relative_density_mesh-1946"><span class="linenos">1946</span></a>
</span><span id="Lattice.get_relative_density_mesh-1947"><a href="#Lattice.get_relative_density_mesh-1947"><span class="linenos">1947</span></a><span class="sd">        If domain_volume is None, the domain is taken as the axis-aligned box</span>
</span><span id="Lattice.get_relative_density_mesh-1948"><a href="#Lattice.get_relative_density_mesh-1948"><span class="linenos">1948</span></a><span class="sd">        defined by (x_min..x_max) √ó (y_min..y_max) √ó (z_min..z_max).</span>
</span><span id="Lattice.get_relative_density_mesh-1949"><a href="#Lattice.get_relative_density_mesh-1949"><span class="linenos">1949</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Lattice.get_relative_density_mesh-1950"><a href="#Lattice.get_relative_density_mesh-1950"><span class="linenos">1950</span></a>        <span class="n">V_solid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume_mesh</span><span class="p">(</span><span class="n">entities_3d</span><span class="o">=</span><span class="n">solids_3d</span><span class="p">,</span> <span class="n">synchronize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Lattice.get_relative_density_mesh-1951"><a href="#Lattice.get_relative_density_mesh-1951"><span class="linenos">1951</span></a>
</span><span id="Lattice.get_relative_density_mesh-1952"><a href="#Lattice.get_relative_density_mesh-1952"><span class="linenos">1952</span></a>        <span class="k">if</span> <span class="n">domain_volume</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Lattice.get_relative_density_mesh-1953"><a href="#Lattice.get_relative_density_mesh-1953"><span class="linenos">1953</span></a>            <span class="n">Lx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span>
</span><span id="Lattice.get_relative_density_mesh-1954"><a href="#Lattice.get_relative_density_mesh-1954"><span class="linenos">1954</span></a>            <span class="n">Ly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span>
</span><span id="Lattice.get_relative_density_mesh-1955"><a href="#Lattice.get_relative_density_mesh-1955"><span class="linenos">1955</span></a>            <span class="n">Lz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span>
</span><span id="Lattice.get_relative_density_mesh-1956"><a href="#Lattice.get_relative_density_mesh-1956"><span class="linenos">1956</span></a>            <span class="n">V_domain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Lx</span> <span class="o">*</span> <span class="n">Ly</span> <span class="o">*</span> <span class="n">Lz</span><span class="p">)</span>
</span><span id="Lattice.get_relative_density_mesh-1957"><a href="#Lattice.get_relative_density_mesh-1957"><span class="linenos">1957</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Lattice.get_relative_density_mesh-1958"><a href="#Lattice.get_relative_density_mesh-1958"><span class="linenos">1958</span></a>            <span class="n">V_domain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">domain_volume</span><span class="p">)</span>
</span><span id="Lattice.get_relative_density_mesh-1959"><a href="#Lattice.get_relative_density_mesh-1959"><span class="linenos">1959</span></a>
</span><span id="Lattice.get_relative_density_mesh-1960"><a href="#Lattice.get_relative_density_mesh-1960"><span class="linenos">1960</span></a>        <span class="k">if</span> <span class="n">V_domain</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="Lattice.get_relative_density_mesh-1961"><a href="#Lattice.get_relative_density_mesh-1961"><span class="linenos">1961</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;get_relative_density: domain volume must be positive.&quot;</span><span class="p">)</span>
</span><span id="Lattice.get_relative_density_mesh-1962"><a href="#Lattice.get_relative_density_mesh-1962"><span class="linenos">1962</span></a>        <span class="k">return</span> <span class="n">V_solid</span> <span class="o">/</span> <span class="n">V_domain</span>
</span></pre></div>


            <div class="docstring"><p>Compute relative density = V_solid / V_domain using exact CAD volumes.</p>

<p>If domain_volume is None, the domain is taken as the axis-aligned box
defined by (x_min..x_max) √ó (y_min..y_max) √ó (z_min..z_max).</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>